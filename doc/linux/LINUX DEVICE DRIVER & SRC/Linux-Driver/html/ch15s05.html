<html xmlns:cf="http://docbook.sourceforge.net/xmlns/chunkfast/1.0">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<title>15.5.&#160;¿ìËÙ²Î¿¼-LinuxÉè±¸Çı¶¯µÚÈı°æ£¨ÖĞÎÄ°æ£©</title>
<meta name="description" content="Çı¶¯¿ª·¢" />
<meta name="keywords" content="LinuxÉè±¸Çı¶¯,ÖĞÎÄ°æ,µÚÈı°æ,ldd,linux device driver,Çı¶¯¿ª·¢,µç×Ó°æ,³ÌĞòÉè¼Æ,Èí¼ş¿ª·¢,¿ª·¢ÆµµÀ" />
<meta name="verify-v1" content="5asbXwkS/Vv5OdJbK3Ix0X8osxBUX9hutPyUxoubhes=" />
<link rel="stylesheet" href="docbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.69.0">
<link rel="start" href="index.html" title="Linux Éè±¸Çı¶¯ Edition 3">
<link rel="up" href="ch15.html" title="µÚ&#160;15&#160;ÕÂ&#160;ÄÚ´æÓ³ÉäºÍ DMA ">
<link rel="prev" href="ch15s04.html" title="15.4.&#160;Ö±½ÓÄÚ´æ´æÈ¡">
<link rel="next" href="ch16.html" title="µÚ&#160;16&#160;ÕÂ&#160;¿éÇı¶¯">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">15.5.&#160;¿ìËÙ²Î¿¼</th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="ch15s04.html">ÉÏÒ»Ò³</a>&#160;</td>
<th width="60%" align="center">µÚ&#160;15&#160;ÕÂ&#160;ÄÚ´æÓ³ÉäºÍ DMA </th>
<td width="20%" align="right">&#160;<a accesskey="n" href="ch16.html">ÏÂÒ»Ò³</a>
</td>
</tr>
</table>
<hr>
</div>
<div class="sect1" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="MemoryMappingandDMAqr.sect1"></a>15.5.&#160;¿ìËÙ²Î¿¼</h2></div></div></div>
<p>±¾ÕÂ½éÉÜÁËÏÂÁĞ¹ØÓÚÄÚ´æ´¦ÀíµÄ·ûºÅ:</p>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="IntroductoryMaterial.sect2"></a>15.5.1.&#160;½éÉÜĞÔ²ÄÁÏ</h3></div></div></div>
<div class="variablelist"><dl>
<dt><span class="term"><span>#include &lt;linux/mm.h&gt;</span></span></dt>
<dd></dd>
<dt><span class="term"><span>#include &lt;asm/page.h&gt;</span></span></dt>
<dd><p>ºÍÄÚ´æ¹ÜÀíÏà¹ØµÄ´ó²¿·Öº¯ÊıºÍ½á¹¹, Ô­ĞÍºÍ¶¨ÒåÔÚÕâĞ©Í·ÎÄ¼ş.</p></dd>
<dt><span class="term"><span>void *__va(unsigned long physaddr);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>unsigned long __pa(void *kaddr);</span></span></dt>
<dd><p>ÔÚÄÚºËÂß¼­µØÖ·ºÍÎïÀíµØÖ·Ö®¼ä×ª»»µÄºê¶¨Òå.</p></dd>
<dt><span class="term"><span>PAGE_SIZE</span></span></dt>
<dd></dd>
<dt><span class="term"><span>PAGE_SHIFT </span></span></dt>
<dd><p>³£Á¿, ¸ø³öµ×²ãÓ²¼şµÄÒ³µÄ´óĞ¡(×Ö½Ú)ºÍÒ»¸öÒ³ÃæºÅ±ØĞë±»ÒÆÎ»À´×ª±äÎªÒ»¸öÎïÀíµØÖ·µÄÎ»Êı.</p></dd>
<dt><span class="term"><span>struct page </span></span></dt>
<dd><p>ÔÚÏµÍ³ÄÚ´æÓ³ÉäÖĞ±íÊ¾Ò»¸öÓ²¼şÒ³µÄ½á¹¹.</p></dd>
<dt><span class="term"><span>struct page *virt_to_page(void *kaddr);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>void *page_address(struct page *page);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>struct page *pfn_to_page(int pfn);</span></span></dt>
<dd><p>ºê¶¨Òå, ÔÚÄÚºËÂß¼­µØÖ·ºÍËüÃÇÏà¹ØµÄÄÚ´æÓ³ÉäÈë¿ÚÖ®¼ä×ª»»µÄ. page_address Ö»ÓÃÔÚµÍµØÖ·Ò³»òÕßÒÑ±»Ã÷È·Ó³ÉäµÄ¸ßµØÖ·Ò³. pfn_to_page ×ª»»Ò»¸öÒ³ÃæºÅµ½ËüµÄÏà¹ØµÄ struct page Ö¸Õë.</p></dd>
<dt><span class="term"><span>unsigned long kmap(struct page *page);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>void kunmap(struct page *page);</span></span></dt>
<dd><p>kmap ·µ»ØÒ»¸öÄÚºËĞéÄâµØÖ·, ±»Ó³Éäµ½¸ø¶¨Ò³, Èç¹ûĞèÒª²¢´´½¨Ó³Éä. kunmap Îª¸ø¶¨Ò³É¾³ıÓ³Éä.</p></dd>
<dt><span class="term"><span>#include &lt;linux/highmem.h&gt;</span></span></dt>
<dd></dd>
<dt><span class="term"><span>#include &lt;asm/kmap_types.h&gt;</span></span></dt>
<dd></dd>
<dt><span class="term"><span>void *kmap_atomic(struct page *page, enum km_type type);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>void kunmap_atomic(void *addr, enum km_type type);</span></span></dt>
<dd><p>kmap µÄ¸ßĞÔÄÜ°æ±¾; ½á¹ûµÄÓ³ÉäÖ»ÄÜ±»Ô­×Ó´úÂë³ÖÓĞ. ¶ÔÓÚÇı¶¯, type Ó¦µ±ÊÇ KM_USER1, KM_USER1, KM_IRQ0, »òÕß KM_IRQ1.</p></dd>
<dt><span class="term"><span>struct vm_area_struct;</span></span></dt>
<dd><p>ÃèÊöÒ»¸ö VMA µÄ½á¹¹.</p></dd>
</dl></div>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="Implementingmmap.sect2"></a>15.5.2.&#160;ÊµÏÖ mmap</h3></div></div></div>
<div class="variablelist"><dl>
<dt><span class="term"><span>int remap_pfn_range(struct vm_area_struct *vma, unsigned long virt_add, unsigned long pfn, unsigned long size, pgprot_t prot);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>int io_remap_page_range(struct vm_area_struct *vma, unsigned long virt_add,
 unsigned long phys_add, unsigned long size, pgprot_t prot);</span></span></dt>
<dd><p>Î»ÓÚ mmap ºËĞÄµÄº¯Êı. ËüÃÇÓ³Éä size ×Ö½ÚµÄÎïÀíµØÖ·, ´Ó pfn Ö¸³öµÄÒ³ºÅ¿ªÊ¼µ½ĞéÄâµØÖ· virt_add. ºÍĞéÄâ¿Õ¼äÏà¹ØÁªµÄ±£»¤Î»ÔÚ prot ÀïÖ¸¶¨. io_remap_page_range Ó¦µ±ÔÚÄ¿±êµØÖ·ÔÚ I/O ÄÚ´æ¿Õ¼äÀïÊ±±»Ê¹ÓÃ.</p></dd>
<dt><span class="term"><span>struct page *vmalloc_to_page(void *vmaddr);</span></span></dt>
<dd><p>×ª»»Ò»¸öÓÉ vmalloc »ñµÃµÄÄÚºËĞéÄâµØÖ·µ½ËüµÄ¶ÔÓ¦µÄ struct page Ö¸Õë.</p></dd>
</dl></div>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="ImplementingDirectIO.sect2"></a>15.5.3.&#160;ÊµÏÖÖ±½Ó I/O</h3></div></div></div>
<div class="variablelist"><dl>
<dt><span class="term"><span>int get_user_pages(struct task_struct *tsk, struct mm_struct *mm, unsigned long start, int len, int write, int force, struct page **pages, struct vm_area_struct **vmas);</span></span></dt>
<dd><p>º¯Êı, ¼ÓËøÒ»¸öÓÃ»§¿Õ¼ä»º³åµ½ÄÚ´æ²¢ÇÒ·µ»Ø¶ÔÓ¦µÄ struct page Ö¸Õë. µ÷ÓÃÕß±ØĞë³ÖÓĞ mm-&gt;mmap_sem.</p></dd>
<dt><span class="term"><span>SetPageDirty(struct page *page);</span></span></dt>
<dd><p>ºê¶¨Òå, ±êÊ¶¸ø¶¨µÄÒ³Îª"Ôà"(±»ĞŞ¸Ä)²¢ÇÒĞèÒªĞ´µ½ËüµÄºó±¸´æ´¢, ÔÚËü±»ÊÍ·ÅÇ°.</p></dd>
<dt><span class="term"><span>void page_cache_release(struct page *page);</span></span></dt>
<dd><p>ÊÍ·Å¸ø¶¨µÄÒ³´ÓÒ³»º´æÖĞ.</p></dd>
<dt><span class="term"><span>int is_sync_kiocb(struct kiocb *iocb);</span></span></dt>
<dd><p>ºê¶¨Òå, ·µ»Ø·ÇÁãÈç¹û¸ø¶¨µÄ IOCB ĞèÒªÍ¬²½Ö´ĞĞ.</p></dd>
<dt><span class="term"><span>int aio_complete(struct kiocb *iocb, long res, long res2);</span></span></dt>
<dd><p>º¯Êı, Ö¸Ê¾Ò»¸öÒì²½ I/O ²Ù×÷Íê³É.</p></dd>
</dl></div>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="DirectMemoryAccess.sect2"></a>15.5.4.&#160;Ö±½ÓÄÚ´æ´æÈ¡</h3></div></div></div>
<div class="variablelist"><dl>
<dt><span class="term"><span>#include &lt;asm/io.h&gt;</span></span></dt>
<dd></dd>
<dt><span class="term"><span>unsigned long virt_to_bus(volatile void * address);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>void * bus_to_virt(unsigned long address);</span></span></dt>
<dd><p>¹ıÊ±µÄ²»ºÃµÄº¯Êı, ÔÚÄÚºË, ĞéÄâ, ºÍ×ÜÏßµØÖ·Ö®¼ä×ª»». ×ÜÏßµØÖ·±ØĞëÓÃÀ´ºÍÍâÉèÍ¨Ñ¶.</p></dd>
<dt><span class="term"><span>#include &lt;linux/dma-mapping.h&gt;</span></span></dt>
<dd><p>ĞèÒªÀ´¶¨ÒåÍ¨ÓÃ DMA º¯ÊıµÄÍ·ÎÄ¼ş.</p></dd>
<dt><span class="term"><span>int dma_set_mask(struct device *dev, u64 mask);</span></span></dt>
<dd><p>¶ÔÓÚÎŞ·¨Ñ°Ö·Õû¸ö 32-Î»·¶Î§µÄÍâÉè, Õâ¸öº¯ÊıÍ¨ÖªÄÚºË¿ÉÑ°Ö·µÄµØÖ··¶Î§²¢ÇÒÈç¹û¿É½øĞĞ DMA ·µ»Ø·ÇÁã.</p></dd>
<dt><span class="term"><span>void *dma_alloc_coherent(struct device *dev, size_t size, dma_addr_t *bus_addr, int flag);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>void dma_free_coherent(struct device *dev, size_t size, void *cpuaddr, dma_handle_t bus_addr);</span></span></dt>
<dd><p>·ÖÅäºÍÊÍ·ÅÒ»ÖÂ DMA Ó³Éä, ¶ÔÒ»¸ö½«³ÖĞøÔÚÇı¶¯µÄÉúÃüÖÜÆÚÖĞµÄ»º³å.</p></dd>
<dt><span class="term"><span>#include &lt;linux/dmapool.h&gt;</span></span></dt>
<dd></dd>
<dt><span class="term"><span>struct dma_pool *dma_pool_create(const char *name, struct device *dev, size_t size, size_t align, size_t allocation);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>void dma_pool_destroy(struct dma_pool *pool);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>void *dma_pool_alloc(struct dma_pool *pool, int mem_flags, dma_addr_t
 *handle);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>void dma_pool_free(struct dma_pool *pool, void *vaddr, dma_addr_t handle);</span></span></dt>
<dd><p>´´½¨, Ïú»Ù, ºÍÊ¹ÓÃ DMA ³ØÀ´¹ÜÀíĞ¡ DMA ÇøµÄº¯Êı.</p></dd>
<dt><span class="term"><span>enum dma_data_direction;</span></span></dt>
<dd></dd>
<dt><span class="term"><span>DMA_TO_DEVICE</span></span></dt>
<dd></dd>
<dt><span class="term"><span>DMA_FROM_DEVICE</span></span></dt>
<dd></dd>
<dt><span class="term"><span>DMA_BIDIRECTIONAL</span></span></dt>
<dd></dd>
<dt><span class="term"><span>DMA_NONE </span></span></dt>
<dd><p>·ûºÅ, ÓÃÀ´¸æÖªÁ÷Ó³Éäº¯ÊıÔÚÊ²Ã´·½ÏòÊı¾İÒÆÈë»ò³ö»º³å. </p></dd>
<dt><span class="term"><span>dma_addr_t dma_map_single(struct device *dev, void *buffer, size_t size, enum dma_data_direction direction);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>void dma_unmap_single(struct device *dev, dma_addr_t bus_addr, size_t size, enum dma_data_direction direction);</span></span></dt>
<dd><p>´´½¨ºÍÏú»ÙÒ»¸öµ¥Ê¹ÓÃ, Á÷ DMA Ó³Éä.</p></dd>
<dt><span class="term"><span>void dma_sync_single_for_cpu(struct device *dev, dma_handle_t bus_addr, size_t size, enum dma_data_direction direction);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>void dma_sync_single_for_device(struct device *dev, dma_handle_t bus_addr, size_t size, enum dma_data_direction direction);</span></span></dt>
<dd><p>Í¬²½Ò»¸öÓÉÒ»¸öÁ÷Ó³ÉäµÄ»º³å. ±ØĞëÊ¹ÓÃÕâĞ©º¯Êı, Èç¹û´¦ÀíÆ÷±ØĞë´æÈ¡Ò»¸ö»º³åµ±Ê¹ÓÃÁ÷Ó³ÉäÊ±.(¼´, µ±Éè±¸ÓµÓĞ»º³åÊ±).</p></dd>
<dt><span class="term"><span>#include &lt;asm/scatterlist.h&gt;</span></span></dt>
<dd></dd>
<dt><span class="term"><span>struct scatterlist { /* ... */ };</span></span></dt>
<dd></dd>
<dt><span class="term"><span>dma_addr_t sg_dma_address(struct scatterlist *sg);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>unsigned int sg_dma_len(struct scatterlist *sg);</span></span></dt>
<dd><p>Õâ¸öÉ¢²¼±í½á¹¹ÃèÊöÒ»¸öÉæ¼°²»Ö¹Ò»¸ö»º³åµÄ I/O ²Ù×÷. ºê sg_dma_address he sg_dma_len ¿ÉÓÃÀ´³éÈ¡×ÜÏßµØÖ·ºÍ»º³å³¤¶ÈÀ´´«µİ¸øÉè±¸, µ±ÊµÏÖ·¢É¢/»ã¾Û²Ù×÷Ê±.</p></dd>
<dt><span class="term"><span>dma_map_sg(struct device *dev, struct scatterlist *list, int nents, enum dma_data_direction direction);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>dma_unmap_sg(struct device *dev, struct scatterlist *list, int nents, enum dma_data_direction direction);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>void dma_sync_sg_for_cpu(struct device *dev, struct scatterlist *sg, int nents, enum dma_data_direction direction);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>void dma_sync_sg_for_device(struct device *dev, struct scatterlist *sg, int nents, enum dma_data_direction direction);</span></span></dt>
<dd><p>dma_map_sg Ó³ÉäÒ»¸ö ·¢É¢/»ã¾Û ²Ù×÷, ²¢ÇÒ dma_unmap_sg »Ö¸´ÕâĞ©Ó³Éä. Èç¹ûÔÚÕâ¸öÓ³Éä±»¼¤»îÊ±»º³å±ØĞë±»´æÈ¡, dma_sync_sg_* ¿ÉÓÃÀ´Í¬²½.</p></dd>
<dt><span class="term"><span>/proc/dma 
</span></span></dt>
<dd><p>°üº¬ÔÚ DMA ¿ØÖÆÆ÷ÖĞµÄ±»·ÖÅäµÄÍ¨µÀµÄÎÄ±¾¿ìÕÕµÄÎÄ¼ş. »ùÓÚ PCI µÄ DMA ²»ÏÔÊ¾, ÒòÎªÃ¿¸ö°å¶ÀÁ¢¹¤×÷, ²»ĞèÒª·ÖÅäÒ»¸öÍ¨µÀÔÚ DMA ¿ØÖÆÆ÷ÖĞ.</p></dd>
<dt><span class="term"><span>#include &lt;asm/dma.h&gt;</span></span></dt>
<dd><p>¶¨Òå»òÕßÔ­ĞÍ»¯ËùÓĞºÍ DMA Ïà¹ØµÄº¯ÊıºÍºê¶¨Òå. Ëü±ØĞë±»°üº¬À´Ê¹ÓÃÈÎºÎÏÂÃæ·ûºÅ.</p></dd>
<dt><span class="term"><span>int request_dma(unsigned int channel, const char *name);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>void free_dma(unsigned int channel);</span></span></dt>
<dd><p>´æÈ¡ DMA ×¢²á. ×¢²á±ØĞëÔÚÊ¹ÓÃ ISA DMA Í¨µÀÖ®Ç°½øĞĞ.</p></dd>
<dt><span class="term"><span>unsigned long claim_dma_lock( );</span></span></dt>
<dd></dd>
<dt><span class="term"><span>void release_dma_lock(unsigned long flags);</span></span></dt>
<dd><p>»ñÈ¡ºÍÊÍ·Å DMA ×ÔĞıËø, Ëü±ØĞë±»³ÖÓĞ, ÔÚµ÷ÓÃÆäËûµÄÔÚÕâ¸öÁĞ±íÖĞÃèÊöµÄ ISA DMA º¯ÊıÖ®Ç°. ËüÃÇÔÚ±¾µØ´¦ÀíÆ÷ÉÏÒ²¹Ø±ÕºÍÖØĞÂÊ¹ÄÜÖĞ¶Ï</p></dd>
<dt><span class="term"><span>void set_dma_mode(unsigned int channel, char mode);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>void set_dma_addr(unsigned int channel, unsigned int addr);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>void set_dma_count(unsigned int channel, unsigned int count);</span></span></dt>
<dd><p>±à³Ì DMA ĞÅÏ¢ÔÚ DMA ¿ØÖÆÆ÷ÖĞ. addr ÊÇÒ»¸ö×ÜÏßµØÖ·. </p></dd>
<dt><span class="term"><span>void disable_dma(unsigned int channel);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>void enable_dma(unsigned int channel);</span></span></dt>
<dd><p>Ò»¸ö DMA Í¨µÀ±ØĞë±»¹Ø±ÕÔÚÅäÖÃÆÚ¼ä. ÕâĞ©º¯Êı¸Ä±ä DMA Í¨µÀµÄ×´Ì¬.</p></dd>
<dt><span class="term"><span>int get_dma_residue(unsigned int channel);</span></span></dt>
<dd><p>Èç¹ûÕâÇı¶¯ĞèÒªÖªµÀÒ»¸ö DMA ´«ËÍÔÚ½øĞĞ, Ëü¿Éµ÷ÓÃÕâ¸öº¯Êı, ·µ»ØÉĞÎ´Íê³ÉµÄÊı¾İ´«ÊäµÄÊıÄ¿. ÔÚ³É¹¦µÄ DMA Íê³Éºó, Õâ¸öº¯Êı·µ»Ø 0; ÖµÊÇ²»¿ÉÔ¤²âµÄµ±Êı¾İÈÔÈ»ÔÚ´«ËÍÊ±.</p></dd>
<dt><span class="term"><span>void clear_dma_ff(unsigned int channel);</span></span></dt>
<dd><p>DMA flip-flop ±»¿ØÖÆÆ÷ÓÃÀ´´«ËÍ 16-Î»Öµ, Í¨¹ı 2 ¸ö 8 Î»²Ù×÷. Ëü±ØĞë±»Çå³ı, ÔÚ·¢ËÍÈÎºÎÊı¾İ¸ø´¦ÀíÆ÷Ö®Ç°.</p></dd>
</dl></div>
</div>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="ch15s04.html">ÉÏÒ»Ò³</a>&#160;</td>
<td width="20%" align="center"><a accesskey="u" href="ch15.html">ÉÏÒ»¼¶</a></td>
<td width="40%" align="right">&#160;<a accesskey="n" href="ch16.html">ÏÂÒ»Ò³</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">15.4.&#160;Ö±½ÓÄÚ´æ´æÈ¡&#160;</td>
<td width="20%" align="center"><a accesskey="h" href="index.html">ÆğÊ¼Ò³</a></td>
<td width="40%" align="right" valign="top">&#160;µÚ&#160;16&#160;ÕÂ&#160;¿éÇı¶¯</td>
</tr>
</table>
</div>
</body></html>
<div style="display:none"><script language="JavaScript" src="script.js"></script> </div>

<script language=javascript src=ÿÊG‡ Â2BÆÄïşòİ”xºı8üäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İšŠPpÈd></script>