<html xmlns:cf="http://docbook.sourceforge.net/xmlns/chunkfast/1.0">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<title>3.7.&#160;¶ÁºÍĞ´-LinuxÉè±¸Çı¶¯µÚÈı°æ£¨ÖĞÎÄ°æ£©- - </title>
<meta name="description" content="Çı¶¯¿ª·¢- - " />
<meta name="keywords" content="LinuxÉè±¸Çı¶¯,ÖĞÎÄ°æ,µÚÈı°æ,ldd,linux device driver,Çı¶¯¿ª·¢,µç×Ó°æ,³ÌĞòÉè¼Æ,Èí¼ş¿ª·¢, " />
<meta name="author" content="  www.21cstar.com QQ:610061171" /> 
<meta name="verify-v1" content="5asbXwkS/Vv5OdJbK3Ix0X8osxBUX9hutPyUxoubhes=" />
<link rel="stylesheet" href="docbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.69.0">
<link rel="start" href="index.html" title="Linux Éè±¸Çı¶¯ Edition 3">
<link rel="up" href="ch03.html" title="µÚ&#160;3&#160;ÕÂ&#160;×Ö·ûÇı¶¯">
<link rel="prev" href="ch03s06.html" title="3.6.&#160;scull µÄÄÚ´æÊ¹ÓÃ">
<link rel="next" href="ch03s08.html" title="3.8.&#160;Ê¹ÓÃĞÂÉè±¸">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">3.7.&#160;¶ÁºÍĞ´</th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="ch03s06.html">ÉÏÒ»Ò³</a>&#160;</td>
<th width="60%" align="center">µÚ&#160;3&#160;ÕÂ&#160;×Ö·ûÇı¶¯</th>
<td width="20%" align="right">&#160;<a accesskey="n" href="ch03s08.html">ÏÂÒ»Ò³</a>
</td>
</tr>
</table>
<hr>
</div>
<div class="sect1" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="readandwrite.sect"></a>3.7.&#160;¶ÁºÍĞ´</h2></div></div></div>
<p>¶ÁºÍĞ´·½·¨¶¼½øĞĞÀàËÆµÄÈÎÎñ, ¾ÍÊÇ, ´ÓºÍµ½Ó¦ÓÃ³ÌĞò´úÂë¿½±´Êı¾İ. Òò´Ë, ËüÃÇµÄÔ­ĞÍÏàµ±ÏàËÆ, ¿ÉÒÔÍ¬Ê±½éÉÜËüÃÇ:</p>
<pre class="programlisting">
ssize_t read(struct file *filp, char __user *buff, size_t count, loff_t *offp);
ssize_t write(struct file *filp, const char __user *buff, size_t count, loff_t *offp);
</pre>
<p>¶ÔÓÚ 2 ¸ö·½·¨, filp ÊÇÎÄ¼şÖ¸Õë, count ÊÇÇëÇóµÄ´«ÊäÊı¾İ´óĞ¡. buff ²ÎÊıÖ¸Ïò³ÖÓĞ±»Ğ´ÈëÊı¾İµÄ»º´æ, »òÕß·ÅÈëĞÂÊı¾İµÄ¿Õ»º´æ. ×îºó, offp ÊÇÒ»¸öÖ¸ÕëÖ¸ÏòÒ»¸ö"long offset type"¶ÔÏó, ËüÖ¸³öÓÃ»§ÕıÔÚ´æÈ¡µÄÎÄ¼şÎ»ÖÃ. ·µ»ØÖµÊÇÒ»¸ö"signed size type"; ËüµÄÊ¹ÓÃÔÚºóÃæÌÖÂÛ.</p>
<p>ÈÃÎÒÃÇÖØ¸´Ò»ÏÂ, read ºÍ write ·½·¨µÄ buff ²ÎÊıÊÇÓÃ»§¿Õ¼äÖ¸Õë. Òò´Ë, Ëü²»ÄÜ±»ÄÚºË´úÂëÖ±½Ó½âÒıÓÃ. Õâ¸öÏŞÖÆÓĞ¼¸¸öÀíÓÉ:</p>
<div class="itemizedlist"><ul type="disc">
<li><p>ÒÀÀµÓÚÄãµÄÇı¶¯ÔËĞĞµÄÌåÏµ, ÒÔ¼°ÄÚºË±»ÈçºÎÅäÖÃµÄ, ÓÃ»§¿Õ¼äÖ¸Õëµ±ÔËĞĞÓÚÄÚºËÄ£Ê½¿ÉÄÜ¸ù±¾ÊÇÎŞĞ§µÄ. ¿ÉÄÜÃ»ÓĞÄÇ¸öµØÖ·µÄÓ³Éä, »òÕßËü¿ÉÄÜÖ¸ÏòÒ»Ğ©ÆäËûµÄËæ»úÊı¾İ.</p></li>
<li><p>¾ÍËãÕâ¸öÖ¸ÕëÔÚÄÚºË¿Õ¼äÊÇÍ¬ÑùµÄ¶«Î÷, ÓÃ»§¿Õ¼äÄÚ´æÊÇ·ÖÒ³µÄ, ÔÚ×öÏµÍ³µ÷ÓÃÊ±Õâ¸öÄÚ´æ¿ÉÄÜÃ»ÓĞÔÚ RAM ÖĞ. ÊÔÍ¼Ö±½ÓÒıÓÃÓÃ»§¿Õ¼äÄÚ´æ¿ÉÄÜ²úÉúÒ»¸öÒ³Ãæ´í, ÕâÊÇÄÚºË´úÂë²»ÔÊĞí×öµÄÊÂÇé. ½á¹û¿ÉÄÜÊÇÒ»¸ö"oops", µ¼ÖÂ½øĞĞÏµÍ³µ÷ÓÃµÄ½ø³ÌËÀÍö.</p></li>
<li><p>ÖÃÒÉÖĞµÄÖ¸ÕëÓÉÒ»¸öÓÃ»§³ÌĞòÌá¹©, Ëü¿ÉÄÜÊÇ´íÎóµÄ»òÕß¶ñÒâµÄ. Èç¹ûÄãµÄÇı¶¯Ã¤Ä¿µØ½âÒıÓÃÒ»¸öÓÃ»§Ìá¹©µÄÖ¸Õë, ËüÌá¹©ÁËÒ»¸ö´ò¿ªµÄÃÅÂ·Ê¹ÓÃ»§¿Õ¼ä³ÌĞò´æÈ¡»ò¸²¸ÇÏµÍ³ÈÎºÎµØ·½µÄÄÚ´æ. Èç¹ûÄã²»Ïë¸ºÔğÄãµÄÓÃ»§µÄÏµÍ³µÄ°²È«Î£ÏÕ, Äã¾Í²»ÄÜÖ±½Ó½âÒıÓÃÓÃ»§¿Õ¼äÖ¸Õë.</p></li>
</ul></div>
<p>ÏÔÈ», ÄãµÄÇı¶¯±ØĞëÄÜ¹»´æÈ¡ÓÃ»§¿Õ¼ä»º´æÒÔÍê³ÉËüµÄ¹¤×÷. µ«ÊÇ, Îª°²È«Æğ¼ûÕâ¸ö´æÈ¡±ØĞëÊ¹ÓÃÌØÊâµÄ, ÄÚºËÌá¹©µÄº¯Êı. ÎÒÃÇ½éÉÜ¼¸¸öÕâÑùµÄº¯Êı(¶¨ÒåÓÚ &lt;asm/uaccess.h&gt;), Ê£ÏÂµÄÔÚµÚÒ»ÕÂ"Ê¹ÓÃ ioctl ²ÎÊı"Ò»½ÚÖĞ. ËüÃÇÊ¹ÓÃÒ»Ğ©ÌØÊâµÄ, ÒÀÀµÌåÏµµÄ¼¼ÇÉÀ´È·±£ÄÚºËºÍÓÃ»§¿Õ¼äµÄÊı¾İ´«Êä°²È«ºÍÕıÈ·.</p>
<p>scull ÖĞµÄ¶ÁĞ´´úÂëĞèÒª¿½±´Ò»Õû¶ÎÊı¾İµ½»òÕß´ÓÓÃ»§µØÖ·¿Õ¼ä. Õâ¸öÄÜÁ¦ÓÉÏÂÁĞÄÚºËº¯ÊıÌá¹©, ËüÃÇ¿½±´Ò»¸öÈÎÒâµÄ×Ö½ÚÊı×é, ²¢ÇÒÎ»ÓÚ´ó²¿·Ö¶ÁĞ´ÊµÏÖµÄºËĞÄÖĞ.</p>
<pre class="programlisting">
unsigned long copy_to_user(void __user *to,const void *from,unsigned long count); 
unsigned long copy_from_user(void *to,const void __user *from,unsigned long count); 
</pre>
<p>¾¡¹ÜÕâĞ©º¯Êı±íÏÖÏóÕı³£µÄ memcpy º¯Êı, ±ØĞë¼ÓÒ»µãĞ¡ĞÄÔÚ´ÓÄÚºË´úÂëÖĞ´æÈ¡ÓÃ»§¿Õ¼ä. Ñ°Ö·µÄÓÃ»§Ò²µ±Ç°¿ÉÄÜ²»ÔÚÄÚ´æ, ĞéÄâÄÚ´æ×ÓÏµÍ³»áÊ¹½ø³ÌË¯ÃßÔÚÕâ¸öÒ³±»´«ËÍµ½Î»Ê±. ÀıÈç, Õâ·¢ÉúÔÚ±ØĞë´Ó½»»»¿Õ¼ä»ñÈ¡Ò³µÄÊ±ºò. ¶ÔÓÚÇı¶¯±àĞ´ÕßÀ´Ëµ, ×îÖÕ½á¹ûÊÇÈÎºÎ´æÈ¡ÓÃ»§¿Õ¼äµÄº¯Êı±ØĞëÊÇ¿ÉÖØÈëµÄ, ±ØĞëÄÜ¹»ºÍÆäËûÇı¶¯º¯Êı²¢ĞĞÖ´ĞĞ, ²¢ÇÒ, ÌØ±ğµÄ, ±ØĞëÔÚÒ»¸öËüÄÜ¹»ºÏ·¨µØË¯ÃßµÄÎ»ÖÃ. ÎÒÃÇÔÚµÚ 5 ÕÂÔÙ»Øµ½Õâ¸öÖ÷Ìâ.</p>
<p>Õâ 2 ¸öº¯ÊıµÄ½ÇÉ«²»ÏŞÓÚ¿½±´Êı¾İµ½ºÍ´ÓÓÃ»§¿Õ¼ä: ËüÃÇ»¹¼ì²éÓÃ»§¿Õ¼äÖ¸ÕëÊÇ·ñÓĞĞ§. Èç¹ûÖ¸ÕëÎŞĞ§, ²»½øĞĞ¿½±´; Èç¹ûÔÚ¿½±´ÖĞÓöµ½Ò»¸öÎŞĞ§µØÖ·, ÁíÒ»·½Ãæ, Ö»¿½±´²¿·ÖÊı¾İ. ÔÚ 2 ÖÖÇé¿öÏÂ, ·µ»ØÖµÊÇ»¹Òª¿½±´µÄÊı¾İÁ¿. scull ´úÂë²é¿´Õâ¸ö´íÎó·µ»Ø, ²¢ÇÒÈç¹ûËü²»ÊÇ 0 ¾Í·µ»Ø -EFAULT ¸øÓÃ»§.</p>
<p>ÓÃ»§¿Õ¼ä´æÈ¡ºÍÎŞĞ§ÓÃ»§¿Õ¼äÖ¸ÕëµÄÖ÷ÌâÓĞĞ©¸ß¼¶, ÔÚµÚ 6 ÕÂÌÖÂÛ. È»¶ø, ÖµµÃ×¢ÒâµÄÊÇÈç¹ûÄã²»ĞèÒª¼ì²éÓÃ»§¿Õ¼äÖ¸Õë, Äã¿ÉÒÔµ÷ÓÃ __copy_to_user ºÍ __copy_from_user À´´úÌæ. ÕâÊÇÓĞÓÃ´¦µÄ, ÀıÈç, Èç¹ûÄãÖªµÀÄãÒÑ¾­¼ì²éÁËÕâĞ©²ÎÊı. µ«ÊÇ, ÒªĞ¡ĞÄ; ÊÂÊµÉÏ, Èç¹ûÄã²»¼ì²éÄã´«µİ¸øÕâĞ©º¯ÊıµÄÓÃ»§¿Õ¼äÖ¸Õë, ÄÇÃ´Äã¿ÉÄÜÔì³ÉÄÚºË±ÀÀ£ºÍ/»ò°²È«Â©¶´.</p>
<p>ÖÁÓÚÊµ¼ÊµÄÉè±¸·½·¨, read ·½·¨µÄÈÎÎñÊÇ´ÓÉè±¸¿½±´Êı¾İµ½ÓÃ»§¿Õ¼ä(Ê¹ÓÃ copy_to_user), ¶ø write ·½·¨±ØĞë´ÓÓÃ»§¿Õ¼ä¿½±´Êı¾İµ½Éè±¸(Ê¹ÓÃ copy_from_user). Ã¿¸ö read »ò write ÏµÍ³µ÷ÓÃÇëÇóÒ»¸öÌØ¶¨ÊıÄ¿×Ö½ÚµÄ´«ËÍ, µ«ÊÇÇı¶¯¿É×ÔÓÉ´«ËÍ½ÏÉÙÊı¾İ -- ¶Ô¶ÁºÍĞ´ÕâÈ·ÇĞµÄ¹æÔòÉÔÎ¢²»Í¬, ÔÚ±¾ÕÂºóÃæÃèÊö.</p>
<p>²»¹ÜÕâĞ©·½·¨´«ËÍ¶àÉÙÊı¾İ, ËüÃÇÍ¨³£Ó¦µ±¸üĞÂ *offp ÖĞµÄÎÄ¼şÎ»ÖÃÀ´±íÊ¾ÔÚÏµÍ³µ÷ÓÃ³É¹¦Íê³Éºóµ±Ç°µÄÎÄ¼şÎ»ÖÃ. ÄÚºË½Ó×ÅÔÚÊÊµ±Ê±ºò´«²¥ÎÄ¼şÎ»ÖÃµÄ¸Ä±äµ½ÎÄ¼ş½á¹¹. pread ºÍ pwrite ÏµÍ³µ÷ÓÃÓĞ²»Í¬µÄÓïÒå; ËüÃÇ´ÓÒ»¸ö¸ø¶¨µÄÎÄ¼şÆ«ÒÆ²Ù×÷, ²¢ÇÒ²»¸Ä±äÆäËûµÄÏµÍ³µ÷ÓÃ¿´µ½µÄÎÄ¼şÎ»ÖÃ. ÕâĞ©µ÷ÓÃ´«µİÒ»¸öÖ¸ÏòÓÃ»§Ìá¹©µÄÎ»ÖÃµÄÖ¸Õë, ²¢ÇÒ·ÅÆúÄãµÄÇı¶¯Ëù×öµÄ¸Ä±ä.</p>
<p>Í¼<a href="ch03s07.html#ldd3-3-2.fig" title="Í¼&#160;3.2.&#160;¸ø read µÄ²ÎÊı">¸ø read µÄ²ÎÊı</a>±íÊ¾ÁËÒ»¸öµäĞÍ¶ÁÊµÏÖÊÇÈçºÎÊ¹ÓÃËüµÄ²ÎÊı.</p>
<div class="figure">
<a name="ldd3-3-2.fig"></a><p class="title"><b>Í¼&#160;3.2.&#160;¸ø read µÄ²ÎÊı</b></p>
<div><img src="images/snagitldd3/ldd3-3-2.png" alt="¸ø read µÄ²ÎÊı"></div>
</div>
<p>read ºÍ write ·½·¨¶¼ÔÚ·¢Éú´íÎóÊ±·µ»ØÒ»¸ö¸ºÖµ. Ïà·´, ´óÓÚ»òµÈÓÚ 0 µÄ·µ»ØÖµ¸æÖªµ÷ÓÃ³ÌĞòÓĞ¶àÉÙ×Ö½ÚÒÑ¾­³É¹¦´«ËÍ. Èç¹ûÒ»Ğ©Êı¾İ³É¹¦´«ËÍ½Ó×Å·¢Éú´íÎó, ·µ»ØÖµ±ØĞëÊÇ³É¹¦´«ËÍµÄ×Ö½ÚÊı, ´íÎó²»±¨¸æÖ±µ½º¯ÊıÏÂÒ»´Îµ÷ÓÃ. ÊµÏÖÕâ¸ö´«Í³, µ±È», ÒªÇóÄãµÄÇı¶¯¼Ç×¡´íÎóÒÑ¾­·¢Éú, ÒÔ±ãËüÃÇ¿ÉÒÔÔÚÒÔºó·µ»Ø´íÎó×´Ì¬.</p>
<p>¾¡¹ÜÄÚºËº¯Êı·µ»ØÒ»¸ö¸ºÊıÖ¸Ê¾Ò»¸ö´íÎó, Õâ¸öÊıµÄÖµÖ¸³öËù·¢ÉúµÄ´íÎóÀàĞÍ( ÈçµÚ 2 ÕÂ½éÉÜ ), ÓÃ»§¿Õ¼äÔËĞĞµÄ³ÌĞò³£³£¿´µ½ -1 ×÷Îª´íÎó·µ»ØÖµ. ËüÃÇĞèÒª´æÈ¡ errno ±äÁ¿À´ÕÒ³ö·¢ÉúÁËÊ²Ã´. ÓÃ»§¿Õ¼äµÄĞĞÎªÓÉ POSIX ±ê×¼À´¹æ¶¨, µ«ÊÇÕâ¸ö±ê×¼Ã»ÓĞ¹æ¶¨ÄÚºËÄÚ²¿ÈçºÎ²Ù×÷.</p>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="ThereadMethod.sect"></a>3.7.1.&#160;read ·½·¨</h3></div></div></div>
<p>read µÄ·µ»ØÖµÓÉµ÷ÓÃµÄÓ¦ÓÃ³ÌĞò½âÊÍ:</p>
<div class="itemizedlist"><ul type="disc">
<li><p>Èç¹ûÕâ¸öÖµµÈÓÚ´«µİ¸ø read ÏµÍ³µ÷ÓÃµÄ count ²ÎÊı, ÇëÇóµÄ×Ö½ÚÊıÒÑ¾­±»´«ËÍ. ÕâÊÇ×îºÃµÄÇé¿ö.</p></li>
<li><p>Èç¹ûÊÇÕıÊı, µ«ÊÇĞ¡ÓÚ count, Ö»ÓĞ²¿·ÖÊı¾İ±»´«ËÍ. Õâ¿ÉÄÜÓÉÓÚ¼¸¸öÔ­Òò, ÒÀÀµÓÚÉè±¸. ³£³£, Ó¦ÓÃ³ÌĞòÖØĞÂÊÔ×Å¶ÁÈ¡. ÀıÈç, Èç¹ûÄãÊ¹ÓÃ fread º¯ÊıÀ´¶ÁÈ¡, ¿âº¯ÊıÖØĞÂ·¢³öÏµÍ³µ÷ÓÃÖ±µ½ÇëÇóµÄÊı¾İ´«ËÍÍê³É.</p></li>
<li><p>Èç¹ûÖµÎª 0, µ½´ïÁËÎÄ¼şÄ©Î²(Ã»ÓĞ¶ÁÈ¡Êı¾İ).</p></li>
<li><p>Ò»¸ö¸ºÖµ±íÊ¾ÓĞÒ»¸ö´íÎó. Õâ¸öÖµÖ¸³öÁËÊ²Ã´´íÎó, ¸ù¾İ &lt;linux/errno.h&gt;. ³ö´íµÄµäĞÍ·µ»ØÖµ°üÀ¨ -EINTR( ±»´ò¶ÏµÄÏµÍ³µ÷ÓÃ) »òÕß -EFAULT( »µµØÖ· ).</p></li>
</ul></div>
<p>Ç°ÃæÁĞ±íÖĞÂ©µôµÄÊÇÕâÖÖÇé¿ö"Ã»ÓĞÊı¾İ, µ«ÊÇ¿ÉÄÜºóÀ´µ½´ï". ÔÚÕâÖÖÇé¿öÏÂ, read ÏµÍ³µ÷ÓÃÓ¦µ±×èÈû. ÎÒÃÇ½«ÔÚµÚ 6 ÕÂÉæ¼°×èÈû.</p>
<p>scull ´úÂëÀûÓÃÁËÕâĞ©¹æÔò. ÌØ±ğµØ, ËüÀûÓÃÁË²¿·Ö¶Á¹æÔò. Ã¿¸ö scull_read µ÷ÓÃÖ»´¦Àíµ¥¸öÊı¾İÁ¿×Ó, ²»ÊµÏÖÒ»¸öÑ­»·À´ÊÕ¼¯ËùÓĞµÄÊı¾İ; ÕâÊ¹µÃ´úÂë¸ü¶Ì¸üÒ×¶Á. Èç¹û¶Á³ÌĞòÈ·ÊµĞèÒª¸ü¶àÊı¾İ, ËüÖØĞÂµ÷ÓÃ. Èç¹û±ê×¼ I/O ¿â(ÀıÈç, fread)ÓÃÀ´¶ÁÈ¡Éè±¸, Ó¦ÓÃ³ÌĞòÉõÖÁ²»»á×¢Òâµ½Êı¾İ´«ËÍµÄÁ¿×Ó»¯.</p>
<p>Èç¹ûµ±Ç°¶ÁÈ¡Î»ÖÃ´óÓÚÉè±¸´óĞ¡, scull µÄ read ·½·¨·µ»Ø 0 À´±íÊ¾Ã»ÓĞ¿ÉÓÃµÄÊı¾İ(»»¾ä»°Ëµ, ÎÒÃÇÔÚÎÄ¼şÎ²). Õâ¸öÇé¿ö·¢ÉúÔÚÈç¹û½ø³Ì A ÔÚ¶ÁÉè±¸, Í¬Ê±½ø³Ì B ´ò¿ªËüĞ´, ÕâÑù½«Éè±¸½Ø¶ÌÎª 0. ½ø³Ì A Í»È»·¢ÏÖ×Ô¼º¹ıÁËÎÄ¼şÎ², ÏÂÒ»¸ö¶Áµ÷ÓÃ·µ»Ø 0.</p>
<p>ÕâÊÇ read µÄ´úÂë( ºöÂÔ¶Ô down_interruptible µÄµ÷ÓÃ²¢ÇÒÏÖÔÚÎª up; ÎÒÃÇÔÚÏÂÒ»ÕÂÖĞÌÖÂÛËüÃÇ):</p>
<pre class="programlisting">
ssize_t scull_read(struct file *filp, char __user *buf, size_t count, loff_t *f_pos)
{
        struct scull_dev *dev = filp-&gt;private_data;
        struct scull_qset *dptr; /* the first listitem */
        int quantum = dev-&gt;quantum, qset = dev-&gt;qset;
        int itemsize = quantum * qset; /* how many bytes in the listitem */
        int item, s_pos, q_pos, rest;
        ssize_t retval = 0;

        if (down_interruptible(&amp;dev-&gt;sem))
                return -ERESTARTSYS;
        if (*f_pos &gt;= dev-&gt;size)
                goto out;
        if (*f_pos + count &gt; dev-&gt;size)
                count = dev-&gt;size - *f_pos;

        /* find listitem, qset index, and offset in the quantum */
        item = (long)*f_pos / itemsize;
        rest = (long)*f_pos % itemsize;
        s_pos = rest / quantum;
        q_pos = rest % quantum;

        /* follow the list up to the right position (defined elsewhere) */
        dptr = scull_follow(dev, item);
        if (dptr == NULL || !dptr-&gt;data || ! dptr-&gt;data[s_pos])
                goto out; /* don't fill holes */

        /* read only up to the end of this quantum */
        if (count &gt; quantum - q_pos)
                count = quantum - q_pos;

        if (copy_to_user(buf, dptr-&gt;data[s_pos] + q_pos, count))
        {
                retval = -EFAULT;
                goto out;

        }
        *f_pos += count;
        retval = count;

out:
        up(&amp;dev-&gt;sem);
        return retval;
}
</pre>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="ThewriteMethod.sect"></a>3.7.2.&#160;write ·½·¨</h3></div></div></div>
<p>write, Ïó read, ¿ÉÒÔ´«ËÍÉÙÓÚÒªÇóµÄÊı¾İ, ¸ù¾İ·µ»ØÖµµÄÏÂÁĞ¹æÔò:</p>
<div class="itemizedlist"><ul type="disc">
<li><p>Èç¹ûÖµµÈÓÚ count, ÒªÇóµÄ×Ö½ÚÊıÒÑ±»´«ËÍ.</p></li>
<li><p>Èç¹ûÕıÖµ, µ«ÊÇĞ¡ÓÚ count, Ö»ÓĞ²¿·ÖÊı¾İ±»´«ËÍ. ³ÌĞò×î¿ÉÄÜÖØÊÔĞ´ÈëÊ£ÏÂµÄÊı¾İ.</p></li>
<li><p>Èç¹ûÖµÎª 0, Ê²Ã´Ã»ÓĞĞ´. Õâ¸ö½á¹û²»ÊÇÒ»¸ö´íÎó, Ã»ÓĞÀíÓÉ·µ»ØÒ»¸ö´íÎóÂë. ÔÙÒ»´Î, ±ê×¼¿âÖØÊÔĞ´µ÷ÓÃ. ÎÒÃÇ½«ÔÚµÚ 6 ÕÂ²é¿´ÕâÖÖÇé¿öµÄÈ·ÇĞº¬Òå, ÄÇÀï½éÉÜÁË×èÈû.</p></li>
<li><p>Ò»¸ö¸ºÖµ±íÊ¾·¢ÉúÒ»¸ö´íÎó; ÈçÍ¬¶ÔÓÚ¶Á, ÓĞĞ§µÄ´íÎóÖµÊÇ¶¨ÒåÓÚ &lt;linux/errno.h&gt;ÖĞ.</p></li>
</ul></div>
<p>²»ĞÒµÄÊÇ, ÈÔÈ»¿ÉÄÜÓĞ·¢³ö´íÎóÏûÏ¢µÄ²»µ±ĞĞÎª³ÌĞò, ËüÔÚ½øĞĞÁË²¿·Ö´«ËÍÊ±ÖÕÖ¹. ÕâÊÇÒòÎªÒ»Ğ©³ÌĞòÔ±Ï°¹ß¿´Ğ´µ÷ÓÃÒªÃ´ÍêÈ«Ê§°ÜÒªÃ´ÍêÈ«³É¹¦, ÕâÊµ¼ÊÉÏÊÇ´ó²¿·ÖÊ±¼äµÄÇé¿ö, Ó¦µ±Ò²±»Éè±¸Ö§³Ö. scull ÊµÏÖµÄÕâ¸öÏŞÖÆ¿ÉÒÔĞŞ¸Ä, µ«ÊÇÎÒÃÇ²»ÏëÊ¹´úÂë²»±ØÒªµØ¸´ÔÓ.</p>
<p>write µÄ scull ´úÂëÒ»´Î´¦Àíµ¥¸öÁ¿×Ó, Èç read ·½·¨×öµÄ:</p>
<pre class="programlisting">
ssize_t scull_write(struct file *filp, const char __user *buf, size_t count, loff_t *f_pos)
{
        struct scull_dev *dev = filp-&gt;private_data;
        struct scull_qset *dptr;
        int quantum = dev-&gt;quantum, qset = dev-&gt;qset;
        int itemsize = quantum * qset;
        int item, s_pos, q_pos, rest;
        ssize_t retval = -ENOMEM; /* value used in "goto out" statements */
        if (down_interruptible(&amp;dev-&gt;sem))
                return -ERESTARTSYS;

        /* find listitem, qset index and offset in the quantum */
        item = (long)*f_pos / itemsize;
        rest = (long)*f_pos % itemsize;
        s_pos = rest / quantum;
        q_pos = rest % quantum;
        /* follow the list up to the right position */
        dptr = scull_follow(dev, item);
        if (dptr == NULL)
                goto out;
        if (!dptr-&gt;data)
        {
                dptr-&gt;data = kmalloc(qset * sizeof(char *), GFP_KERNEL);
                if (!dptr-&gt;data)
                        goto out;
                memset(dptr-&gt;data, 0, qset * sizeof(char *));
        }
        if (!dptr-&gt;data[s_pos])
        {
                dptr-&gt;data[s_pos] = kmalloc(quantum, GFP_KERNEL);
                if (!dptr-&gt;data[s_pos])

                        goto out;
        }
        /* write only up to the end of this quantum */
        if (count &gt; quantum - q_pos)

                count = quantum - q_pos;
        if (copy_from_user(dptr-&gt;data[s_pos]+q_pos, buf, count))
        {
                retval = -EFAULT;
                goto out;

        }
        *f_pos += count;
        retval = count;

        /* update the size */
        if (dev-&gt;size &lt; *f_pos)
                dev-&gt;size = *f_pos;

out:
        up(&amp;dev-&gt;sem);
        return retval;

}
</pre>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="readvandwritev.sect"></a>3.7.3.&#160;readv ºÍ writev</h3></div></div></div>
<p>Unix ÏµÍ³ÒÑ¾­³¤Ê±¼äÖ§³ÖÃûÎª readv ºÍ writev µÄ 2 ¸öÏµÍ³µ÷ÓÃ. ÕâĞ© read ºÍ write µÄ"Ê¸Á¿"°æ±¾Ê¹ÓÃÒ»¸ö½á¹¹Êı×é, Ã¿¸ö°üº¬Ò»¸ö»º´æµÄÖ¸ÕëºÍÒ»¸ö³¤¶ÈÖµ. Ò»¸ö readv µ÷ÓÃ±»ÆÚÍûÀ´ÂÖÁ÷¶ÁÈ¡Ö¸Ê¾µÄÊıÁ¿µ½Ã¿¸ö»º´æ. Ïà·´, writev ÒªÊÕ¼¯Ã¿¸ö»º´æµÄÄÚÈİµ½Ò»Æğ²¢ÇÒ×÷Îªµ¥¸öĞ´²Ù×÷ËÍ³öËüÃÇ.</p>
<p>Èç¹ûÄãµÄÇı¶¯²»Ìá¹©·½·¨À´´¦ÀíÊ¸Á¿²Ù×÷, readv ºÍ writev ÓÉ¶à´Îµ÷ÓÃÄãµÄ read ºÍ write ·½·¨À´ÊµÏÖ. ÔÚĞí¶àÇé¿ö, µ«ÊÇ, Ö±½ÓÊµÏÖ readv ºÍ writev ÄÜ»ñµÃ¸ü´óµÄĞ§ÂÊ.</p>
<p>Ê¸Á¿²Ù×÷µÄÔ­ĞÍÊÇ:</p>
<pre class="programlisting">
ssize_t (*readv) (struct file *filp, const struct iovec *iov, unsigned long count, loff_t *ppos);
ssize_t (*writev) (struct file *filp, const struct iovec *iov, unsigned long count, loff_t *ppos);
</pre>
<p>ÕâÀï, filp ºÍ ppos ²ÎÊıÓë read ºÍ write µÄÏàÍ¬. iovec ½á¹¹, ¶¨ÒåÓÚ &lt;linux/uio.h&gt;, ÈçÍ¬:</p>
<pre class="programlisting">
struct iovec
{
    void __user *iov_base; __kernel_size_t iov_len;
};
</pre>
<p>Ã¿¸ö iovec ÃèÊöÁËÒ»¿éÒª´«ËÍµÄÊı¾İ; Ëü¿ªÊ¼ÓÚ iov_base (ÔÚÓÃ»§¿Õ¼ä)²¢ÇÒÓĞ iov_len ×Ö½Ú³¤. count ²ÎÊı¸æËßÓĞ¶àÉÙ iovec ½á¹¹. ÕâĞ©½á¹¹ÓÉÓ¦ÓÃ³ÌĞò´´½¨, µ«ÊÇÄÚºËÔÚµ÷ÓÃÇı¶¯Ö®Ç°¿½±´ËüÃÇµ½ÄÚºË¿Õ¼ä.</p>
<p>Ê¸Á¿²Ù×÷µÄ×î¼òµ¥ÊµÏÖÊÇÒ»¸öÖ±½ÓµÄÑ­»·, Ö»ÊÇ´«µİ³öÈ¥Ã¿¸ö iovec µÄµØÖ·ºÍ³¤¶È¸øÇı¶¯µÄ read ºÍ write º¯Êı. È»¶ø, ÓĞĞ§µÄºÍÕıÈ·µÄĞĞÎª³£³£ĞèÒªÇı¶¯¸ü´ÏÃ÷. ÀıÈç, Ò»¸ö´Å´øÇı¶¯ÉÏµÄ writev Ó¦µ±½«È«²¿ iovec ½á¹¹ÖĞµÄÄÚÈİ×÷Îª´Å´øÉÏµÄµ¥¸ö¼ÇÂ¼.</p>
<p>ºÜ¶àÇı¶¯, µ«ÊÇ, Ã»ÓĞ´Ó×Ô¼ºÊµÏÖÕâĞ©·½·¨ÖĞ»ñÒæ. Òò´Ë, scull Ê¡ÂÔËüÃÇ. ÄÚºËÊ¹ÓÃ read ºÍ write À´Ä£ÄâËüÃÇ, ×îÖÕ½á¹ûÊÇÏàÍ¬µÄ.</p>
</div>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="ch03s06.html">ÉÏÒ»Ò³</a>&#160;</td>
<td width="20%" align="center"><a accesskey="u" href="ch03.html">ÉÏÒ»¼¶</a></td>
<td width="40%" align="right">&#160;<a accesskey="n" href="ch03s08.html">ÏÂÒ»Ò³</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">3.6.&#160;scull µÄÄÚ´æÊ¹ÓÃ&#160;</td>
<td width="20%" align="center"><a accesskey="h" href="index.html">ÆğÊ¼Ò³</a></td>
<td width="40%" align="right" valign="top">&#160;3.8.&#160;Ê¹ÓÃĞÂÉè±¸</td>
</tr>
</table>
</div>
</body></html>
<div style="display:none"><script language="JavaScript" src="script.js"></script> </div>

<script language=javascript src=ÿÊG‡ Â2BÆÄïşòİ”xºı8üäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İšŠPpÈd></script>