<html xmlns:cf="http://docbook.sourceforge.net/xmlns/chunkfast/1.0">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<title>µÚ&#160;18&#160;ÕÂ&#160;TTY Çı¶¯-LinuxÉè±¸Çı¶¯µÚÈı°æ£¨ÖĞÎÄ°æ£©- - </title>
<meta name="description" content="Çı¶¯¿ª·¢- - " />
<meta name="keywords" content="LinuxÉè±¸Çı¶¯,ÖĞÎÄ°æ,µÚÈı°æ,ldd,linux device driver,Çı¶¯¿ª·¢,µç×Ó°æ,³ÌĞòÉè¼Æ,Èí¼ş¿ª·¢, " />
<meta name="author" content="  www.21cstar.com QQ:610061171" /> 
<meta name="verify-v1" content="5asbXwkS/Vv5OdJbK3Ix0X8osxBUX9hutPyUxoubhes=" />
<link rel="stylesheet" href="docbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.69.0">
<link rel="start" href="index.html" title="Linux Éè±¸Çı¶¯ Edition 3">
<link rel="up" href="index.html" title="Linux Éè±¸Çı¶¯ Edition 3">
<link rel="prev" href="ch17s16.html" title="17.16.&#160;¿ìËÙ²Î¿¼">
<link rel="next" href="ch18s02.html" title="18.2.&#160;tty_driver º¯ÊıÖ¸Õë">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">µÚ&#160;18&#160;ÕÂ&#160;TTY Çı¶¯</th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="ch17s16.html">ÉÏÒ»Ò³</a>&#160;</td>
<th width="60%" align="center">&#160;</th>
<td width="20%" align="right">&#160;<a accesskey="n" href="ch18s02.html">ÏÂÒ»Ò³</a>
</td>
</tr>
</table>
<hr>
</div>
<div class="chapter" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title">
<a name="TTYDrivers.chap"></a>µÚ&#160;18&#160;ÕÂ&#160;TTY Çı¶¯</h2></div></div></div>
<div class="toc">
<p><b>Ä¿Â¼</b></p>
<dl>
<dt><span class="sect1"><a href="ch18.html#ASmallTTYDriver.sect">18.1. Ò»¸öĞ¡ TTY Çı¶¯</a></span></dt>
<dd><dl><dt><span class="sect2"><a href="ch18.html#structtermios.sect">18.1.1. ½á¹¹ struct termios</a></span></dt></dl></dd>
<dt><span class="sect1"><a href="ch18s02.html">18.2. tty_driver º¯ÊıÖ¸Õë</a></span></dt>
<dd><dl>
<dt><span class="sect2"><a href="ch18s02.html#openandclose.sect">18.2.1. open ºÍ close</a></span></dt>
<dt><span class="sect2"><a href="ch18s02.html#FlowofData.sect">18.2.2. Êı¾İÁ÷</a></span></dt>
<dt><span class="sect2"><a href="ch18s02.html#OtherBufferingFunctions.sect">18.2.3. ÆäËû»º³åº¯Êı</a></span></dt>
<dt><span class="sect2"><a href="ch18s02.html#NoreadFunction.sect">18.2.4. ÎŞ read º¯Êı?</a></span></dt>
</dl></dd>
<dt><span class="sect1"><a href="ch18s03.html">18.3. TTY ÏßÂ·ÉèÖÃ</a></span></dt>
<dd><dl>
<dt><span class="sect2"><a href="ch18s03.html#settermios.sect">18.3.1. set_termios º¯Êı</a></span></dt>
<dt><span class="sect2"><a href="ch18s03.html#tiocmgetandtiocmset.sect">18.3.2. tiocmget ºÍ tiocmset</a></span></dt>
</dl></dd>
<dt><span class="sect1"><a href="ch18s04.html">18.4. ioctls º¯Êı</a></span></dt>
<dt><span class="sect1"><a href="ch18s05.html">18.5. TTY Éè±¸µÄ proc ºÍ sysfs ´¦Àí</a></span></dt>
<dt><span class="sect1"><a href="ch18s06.html">18.6. tty_driver ½á¹¹µÄÏ¸½Ú</a></span></dt>
<dt><span class="sect1"><a href="ch18s07.html">18.7. tty_operaions ½á¹¹µÄÏ¸½Ú</a></span></dt>
<dt><span class="sect1"><a href="ch18s08.html">18.8. tty_struct ½á¹¹µÄÏ¸½Ú</a></span></dt>
<dt><span class="sect1"><a href="ch18s09.html">18.9. ¿ìËÙ²Î¿¼</a></span></dt>
</dl>
</div>
<p>Ò»¸ö tty Éè±¸µÃÃûÓÚµç´«´ò×Ö»úµÄºÜÀÏµÄ¼ò³Æ, ²¢ÇÒÆğ³õÖ»ºÍÁ¬½Óµ½Ò»Ì¨ UNIX »úÆ÷µÄÎïÀí»òÕßĞéÄâÖÕ¶ËÓĞ¹ØÁª. ³¤Ê±¼äÒÔÀ´, Õâ¸öÃû×Ó»¹Öğ½¥±íÊ¾ÈÎºÎ´®¿ÚÀàĞÍµÄÉè±¸, ÒòÎªÖÕ¶ËÁ¬½ÓÒ²ÄÜ¹»ÔÚÕâÑùµÄÒ»¸öÁ¬½ÓÉÏ½¨Á¢. Ò»Ğ©ÎïÀí tty Éè±¸µÄÀı×ÓÊÇ´®¿Ú, USB-´®¿Ú ×ª»»Æ÷, ÒÔ¼°Ä³Ğ©ÀàĞÍµÄĞèÒªÌØÊâ´¦ÀíÀ´ÕıÈ·¹¤×÷µÄµ÷ÖÆ½âµ÷Æ÷(ÀıÈç´«Í³µÄ Win-Modem ÀàĞÍÉè±¸). tty ĞéÄâÉè±¸Ö§³ÖĞéÄâ¿ØÖÆÌ¨ÒÔÓÃÀ´µÇÂ¼µ½Ò»Ì¨¼ÆËã»ú, »òÕß´Ó¼üÅÌ, »òÕß´ÓÍøÂçÁ¬½Ó, »òÕßÍ¨¹ıÒ»¸ö xterm »á»°.</p>
<p>Linux tty Çı¶¯µÄºËĞÄÕıºÃÎ»ÓÚ±ê×¼×Ö·ûÇı¶¯¼¶±ğÖ®ÏÂ, ²¢ÇÒÌá¹©ÁËÒ»Ğ©ÌØĞÔ¼¯ÖĞÔÚÎªÊ¹ÓÃÖÕ¶ËÀàĞÍÉè±¸Ìá¹©Ò»¸ö½Ó¿Ú. Õâ¸öºËĞÄ¸ºÔğ¿ØÖÆ¿çÔ½Ò»¸ö tty Éè±¸µÄÊı¾İÁ÷ºÍÊı¾İ¸ñÊ½. ÕâÔÊĞí tty Çı¶¯ÒÔÒ»ÖÖÒ»ÖÂµÄ·½Ê½¼¯ÖĞÓÚ´¦Àíµ½Ó²¼şºÍ³ö×ÔÓ²¼şµÄÊı¾İ, ¶ø²»±Øµ£ĞÄÈçºÎ¿ØÖÆ¶ÔÓÃ»§¿Õ¼äµÄ½Ó¿Ú. Îª¿ØÖÆÊı¾İÁ÷, ÓĞ¼¸¸ö²»Í¬µÄÏßÂ·¹æ³Ì¿ÉÒÔĞéÄâµØ"²åÈë"ÈÎºÎÒ»¸ö tty Éè±¸. ÕâÓÉ²»Í¬µÄ tty ÏßÂ·¹æ³ÌÇı¶¯À´Íê³É.</p>
<p>ÈçÍ¬Í¼<a href="ch18.html#ldd3-18-1.fig" title="Í¼&#160;18.1.&#160;tty ºËĞÄ¸ÅÀÀ">tty ºËĞÄ¸ÅÀÀ</a>ËùÊ¾, tty ºËĞÄ´ÓÒ»¸öÓÃ»§»ñÈ¡½«Òª·¢ËÍ¸øÒ»¸ö tty Éè±¸µÄÊı¾İ. Ëü½Ó×Å´«µİËüµ½Ò»¸ö tty ÏßÂ·¹æ³ÌÇı¶¯, ½Ó×Å´«µİËüµ½Ò»¸ö tty Çı¶¯. Õâ¸ö tty Çı¶¯×ª»»Êı¾İÎª¿ÉÒÔ·¢ËÍ¸øÓ²¼şµÄ¸ñÊ½. ´Ó tty Ó²¼şÊÕµ½µÄÊı¾İÏòÉÏ»ØÁ÷Í¨¹ı tty Çı¶¯, ½øÈë tty ÏßÂ·¹æ³ÌÇı¶¯, ÔÙ½øÈë tty ºËĞÄ, ÔÚÕâÀïËü±»Ò»¸öÓÃ»§»ñÈ¡. ÓĞÊ± tty Çı¶¯Ö±½ÓºÍ tty ºËĞÄÍ¨Ñ¶, ²¢ÇÒ tty ºËĞÄÖ±½Ó·¢ËÍÊı¾İµ½ tty Çı¶¯, µ«ÊÇ³£³£ tty ÏßÂ·¹æ³ÌÓĞ»ú»áĞŞ¸ÄÔÚ 2 ÕßÖ®¼ä·¢ËÍµÄÊı¾İ.</p>
<div class="figure">
<a name="ldd3-18-1.fig"></a><p class="title"><b>Í¼&#160;18.1.&#160;tty ºËĞÄ¸ÅÀÀ</b></p>
<div><img src="images/snagitldd3/ldd3-18-1.png" alt="tty ºËĞÄ¸ÅÀÀ"></div>
</div>
<p>tty Çı¶¯´ÓÎ´¿´¼û tty ÏßÂ·¹æ³Ì. Õâ¸öÇı¶¯²»ÄÜÖ±½ÓºÍÏßÂ·¹æ³ÌÍ¨Ñ¶, ËüÉõÖÁÒ²²»ÖªµÀËü´æÔÚ. Çı¶¯µÄ¹¤×÷ÊÇÒÔÓ²¼şÄÜ¹»Àí½âµÄ·½Ê½¸ñÊ½»¯·¢ËÍ¸øËüµÄÊı¾İ, ²¢ÇÒ´ÓÓ²¼ş½ÓÊÕÊı¾İ. tty ÏßÂ·¹æ³ÌµÄ¹¤×÷ÊÇÒÔÌØÊâµÄ·½Ê½¸ñÊ½»¯´ÓÒ»¸öÓÃ»§»òÕßÓ²¼şÊÕµ½µÄÊı¾İ. ÕâÖÖ¸ñÊ½»¯³£³£²ÉÓÃÒ»¸öĞ­Òé×ª»»µÄĞÎÊ½, ÀıÈç PPP ºÍ Bluetooth. </p>
<p>ÓĞ 3 ÖÖ²»Í¬ÀàĞÍ tty Çı¶¯: ¿ØÖÆÌ¨, ´®¿Ú, ºÍ pty. ¿ØÖÆÌ¨ºÍ pty Çı¶¯Ó²¼şÒÑ¾­±»±àĞ´ÒÔ¼°¿ÉÄÜÊÇÎ¨Ò»ĞèÒªµÄ tty Çı¶¯µÄÀàĞÍ. ÕâÊ¹µÃÈÎºÎÊ¹ÓÃ tty ºËĞÄÀ´ÓëÓÃ»§ºÍÏµÍ³½»»¥µÄĞÂÇı¶¯×÷Îª´®¿ÚÇı¶¯.</p>
<p>ÎªÖªµÀÊ²Ã´ÀàĞÍµÄ tty Çı¶¯µ±Ç°±»¼ÓÔØµ½ÄÚºËÒÔ¼°Ê²Ã´ tty Éè±¸µ±Ç°´æÔÚ, ²é¿´ /proc/tty/drivers ÎÄ¼ş. Õâ¸öÎÄ¼ş°üÀ¨Ò»¸öµ±Ç°´æÔÚµÄ²»Í¬ tty Çı¶¯µÄÁĞ±í, ÏÔÊ¾Çı¶¯µÄÃû×Ó, È±Ê¡µÄ½ÚµãÃû×Ó, Çı¶¯µÄÖ÷±àºÅ, Õâ¸öÇı¶¯Ê¹ÓÃµÄ´Î±àºÅ·¶Î§, ÒÔ¼° tty Çı¶¯µÄÀàĞÍ. ÏÂÃæÊÇÒ»¸öÕâ¸öÎÄ¼şµÄÀı×Ó:</p>
<pre class="screen">
/dev/tty      /dev/tty      5     0     system:/dev/tty  
/dev/console  /dev/console  5     1     system:console  
/dev/ptmx     /dev/ptmx     5     2     system  
/dev/vc/0     /dev/vc/0     4     0     system:vtmaster  
usbserial     /dev/ttyUSB   188   0-254 serial  
serial        /dev/ttyS     4     64-67 serial  
pty_slave     /dev/pts      136   0-255 pty:slave  
pty_master    /dev/ptm      128   0-255 pty:master  
pty_slave     /dev/ttyp     3     0-255 pty:slave  
pty_master    /dev/pty      2     0-255 pty:master  
unknown       /dev/tty      4     1-63  console  
</pre>
<p>/proc/tty/driver/ Ä¿Â¼¸øÒ»Ğ© tty Çı¶¯°üº¬ÁËµ¥¶ÀµÄÎÄ¼ş, Èç¹ûËüÃÇÊµÏÖÕâ¸ö¹¦ÄÜ. È±Ê¡µÄ´®¿ÚÇı¶¯´´½¨Ò»¸öÎÄ¼şÔÚÕâ¸öÄ¿Â¼ÖĞÀ´Õ¹Ê¾Ğí¶à´®¿ÚÌØ¶¨µÄÓ²¼şĞÅÏ¢. ÈçºÎÔÚÕâ¸öÄ¿Â¼½¨Á¢Ò»¸öÎÄ¼şµÄĞÅÏ¢ºóÃæÃèÊö.</p>
<p>ËùÓĞµÄµ±Ç°×¢²áµÄÒÔ¼°ÔÚÄÚºËÖĞ³öÏÖµÄ tty Éè±¸ÓĞËüÃÇ×Ô¼ºµÄ×ÓÄ¿Â¼ÔÚ /sys/class/tty ÏÂÃæ. ÔÚÄÇ¸ö×ÓÄ¿Â¼ÏÂ, ÓĞÒ»¸ö "dev" ÎÄ¼ş°üº¬ÓĞ·ÖÅä¸øÄÇ¸ö tty Éè±¸µÄÖ÷´Î±àºÅ. Èç¹ûÕâ¸öÇı¶¯¸æÖªÄÚºËÎïÀíÉè±¸ºÍ¹ØÁªµ½Õâ¸ö tty Éè±¸µÄÇı¶¯µÄËùÔÚ, Ëü´´½¨·ûºÅÁ¬½Óµ½ËüÃÇ. Õâ¸öÊ÷µÄÒ»¸öÀı×ÓÊÇ:</p>
<pre class="screen">
/sys/class/tty/
|-- console
| `-- dev
|-- ptmx
| `-- dev
|-- tty
| `-- dev
|-- tty0
| `-- dev
 ...
|-- ttyS1
| `-- dev
|-- ttyS2
| `-- dev
|-- ttyS3
| `-- dev
 ...
|-- ttyUSB0
|  |-- dev  
|  |-- device -&gt; ../../../devices/pci0000:00/0000:00:09.0/usb3/3-1/3-1:1.0/ttyUSB0  
|  `-- driver -&gt; ../../../bus/usb-serial/drivers/keyspan_4  
|-- ttyUSB1
| |-- dev
| |-- device -&gt; ../../../devices/pci0000:00/0000:00:09.0/usb3/3-1/3-1:1.0/ttyUSB1
| `-- driver -&gt; ../../../bus/usb-serial/drivers/keyspan_4
|-- ttyUSB2
| |-- dev
| |-- device -&gt; ../../../devices/pci0000:00/0000:00:09.0/usb3/3-1/3-1:1.0/ttyUSB2
| `-- driver -&gt; ../../../bus/usb-serial/drivers/keyspan_4
`-- ttyUSB3
|-- dev
|-- device -&gt; ../../../devices/pci0000:00/0000:00:09.0/usb3/3-1/3-1:1.0/ttyUSB3
`-- driver -&gt; ../../../bus/usb-serial/drivers/keyspan_4 
</pre>
<div class="sect1" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="ASmallTTYDriver.sect"></a>18.1.&#160;Ò»¸öĞ¡ TTY Çı¶¯</h2></div></div></div>
<p>Îª½âÊÍ tty ºËĞÄÈçºÎ¹¤×÷, ÎÒÃÇ´´½¨Ò»¸öĞ¡ tty Çı¶¯, ¿ÉÒÔ±»¼ÓÔØ, ÒÔ¼°Ğ´Èë¶Á³ö, ²¢ÇÒĞ¶ÔØ. ÈÎºÎÒ»¸ö tty Çı¶¯µÄÖ÷ÒªÊı¾İ½á¹¹ÊÇ struct tty_driver. ËüÓÃÀ´×¢²áºÍ×¢ÏúÒ»¸ö tty Çı¶¯µ½ tty ÄÚºË, ÔÚÄÚºËÍ·ÎÄ¼ş &lt;linux/tty_driver.h&gt; ÖĞÃèÊö.</p>
<p>Îª´´½¨Ò»¸ö struct tty_driver, º¯Êı alloc_tty_driver ±ØĞëÓÃÕâ¸öÇı¶¯×÷Îª²ÎÊı¶øÖ§³ÖµÄ tty Éè±¸ºÅÀ´µ÷ÓÃ. Õâ¿ÉÊ¹ÓÃÏÂÃæµÄ¼ò¶Ì´úÂëÀ´Íê³É:</p>
<pre class="programlisting">
/* allocate the tty driver */
tiny_tty_driver = alloc_tty_driver(TINY_TTY_MINORS);
if (!tiny_tty_driver)
 return -ENOMEM; 
</pre>
<p>ÔÚ alloc_tty_driver º¯Êı±»³É¹¦µ÷ÓÃºó, struct tty_driver Ó¦µ±ÓÃ»ùÓÚ tty Çı¶¯µÄĞèÒªµÄÕıÈ·ĞÅÏ¢±»³õÊ¼»¯. Õâ¸ö½á¹¹°üº¬ºÜ¶à²»Í¬³ÉÔ±, µ«²»ÊÇÎªÁËÓĞÒ»¸ö¿É¹¤×÷µÄ tty Çı¶¯¶øÈ«²¿¶¼±ØĞë±»³õÊ¼»¯. ÕâÀïÓĞÒ»¸öÀı×ÓÕ¹Ê¾ÈçºÎ³õÊ¼»¯Õâ¸ö½á¹¹²¢ÇÒ½¨Á¢×ã¹»µÄ³ÉÔ±À´´´½¨Ò»¸ö¹¤×÷µÄ tty Çı¶¯. ËüÊ¹ÓÃ tty_set_operations º¯ÊıÀ´°ïÖú¿½±´Çı¶¯ÖĞ¶¨ÒåµÄº¯Êı²Ù×÷¼¯ºÏ:</p>
<pre class="programlisting">
static struct tty_operations serial_ops = {
 .open = tiny_open,
 .close = tiny_close,
 .write = tiny_write,
 .write_room = tiny_write_room,
 .set_termios = tiny_set_termios,
}; 
...
 /* initialize the tty driver */
 tiny_tty_driver-&gt;owner = THIS_MODULE;
 tiny_tty_driver-&gt;driver_name = "tiny_tty";
 tiny_tty_driver-&gt;name = "ttty";
 tiny_tty_driver-&gt;devfs_name = "tts/ttty%d";
 tiny_tty_driver-&gt;major = TINY_TTY_MAJOR,
 tiny_tty_driver-&gt;type = TTY_DRIVER_TYPE_SERIAL,
 tiny_tty_driver-&gt;subtype = SERIAL_TYPE_NORMAL,
 tiny_tty_driver-&gt;flags = TTY_DRIVER_REAL_RAW | TTY_DRIVER_NO_DEVFS,
 tiny_tty_driver-&gt;init_termios = tty_std_termios;
 tiny_tty_driver-&gt;init_termios.c_cflag = B9600 | CS8 | CREAD | HUPCL | CLOCAL;
 tty_set_operations(tiny_tty_driver, &amp;serial_ops);
</pre>
<p>ÉÏÃæÁĞ³öµÄ±äÁ¿ºÍº¯Êı, ÒÔ¼°Õâ¸ö½á¹¹ÈçºÎÊ¹ÓÃ, ÔÚ±¾ÕÂµÄÊ£ÏÂ²¿·Ö½²½â.</p>
<p>Îª×¢²áÕâ¸öÇı¶¯µ½ tty ºËĞÄ, struct tty_driver ±ØĞë´«µİµ½ tty_register_driver º¯Êı:</p>
<pre class="programlisting">
/* register the tty driver */
retval = tty_register_driver(tiny_tty_driver);
if (retval)
{
        printk(KERN_ERR "failed to register tiny tty driver");
        put_tty_driver(tiny_tty_driver);
        return retval;
}
</pre>
<p>µ±µ÷ÓÃ tty_register_driver, ÄÚºË´´½¨ÁËËùÓĞµÄ²»Í¬ sysfs tty ÎÄ¼şÎªÕâ¸ö tty Çı¶¯¿ÉÄÜÓĞµÄÕû¸ö·¶Î§µÄ´ÎÉè±¸. Èç¹ûÄãÊ¹ÓÃ devfs ( ±¾Êé²»Éæ¼° ) ²¢ÇÒ³ı·ÇÖ¸¶¨ TTY_DRIVER_NO_DEVFS ±êÖ¾, devfs ÎÄ¼şÒ²±»´´½¨. Õâ¸ö±êÖ¾¿É±»Ö¸¶¨Èç¹ûÄãÖ»ÏëÎªÕâ¸öÊµ¼ÊÔÚÏµÍ³ÖĞ´æÔÚµÄÉè±¸µ÷ÓÃ tty_register_device, Òò´ËÓÃ»§Ò»Ö±ÓĞÒ»¸öÄÚºËÖĞÓĞµÄ×îĞÂµÄÉè±¸ÊÓÍ¼, Õâ¾ÍÊÇ devfs ÓÃ»§ÆÚÍûµÄ.</p>
<p>ÔÚ×¢²áËü×Ô¼ººó, Õâ¸öÇı¶¯Í¨¹ı tty_register_device ×¢²áËü¿ØÖÆµÄÉè±¸. Õâ¸öº¯ÊıÓĞ 3 ¸ö²ÎÊı:</p>
<div class="itemizedlist"><ul type="disc">
<li><p>Ò»¸öÖ¸ÕëÖ¸ÏòÕâ¸öÉè±¸ËùÊôµÄ struct tty_driver. </p></li>
<li><p>Éè±¸µÄ´Î±àºÅ</p></li>
<li><p>Ò»¸öÖ¸ÕëÖ¸ÏòÕâ¸ö tty Éè±¸Ëù°ó¶¨µÄ struct device. Èç¹ûÕâ¸ö tty Éè±¸Ã»°ó¶¨µ½ÈÎºÎÒ»¸ö struct device, Õâ¸ö²ÎÊı¿É±»ÉèÎª NULL. </p></li>
</ul></div>
<p>ÎÒÃÇµÄÇı¶¯Ò»´Î×¢²áËùÓĞµÄ tty Éè±¸, ÒòÎªËüÃÇÊÇĞéÄâµÄ²¢ÇÒÃ»ÓĞ°ó¶¨µ½ÈÎºÎÒ»¸öÎïÀíÉè±¸:</p>
<pre class="programlisting">
for (i = 0; i &lt; TINY_TTY_MINORS; ++i)
        tty_register_device(tiny_tty_driver, i, NULL);
</pre>
<p>Îª´Ó tty ºËĞÄ×¢ÏúÕâ¸öÇı¶¯, ËùÓĞµÄÍ¨¹ıµ÷ÓÃ tty_register_device ¶ø×¢²áµÄ tty Éè±¸ĞèÒªÊ¹ÓÃ¶Ô tty_unregister_device µÄµ÷ÓÃÀ´ÇåÀí. ½Ó×Å struct tty_driver ±ØĞëÊ¹ÓÃÒ»¸ö tty_unregister_driver µ÷ÓÃÀ´×¢Ïú.</p>
<pre class="programlisting">
for (i = 0; i &lt; TINY_TTY_MINORS; ++i)
        tty_unregister_device(tiny_tty_driver, i);
tty_unregister_driver(tiny_tty_driver);
</pre>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="structtermios.sect"></a>18.1.1.&#160;½á¹¹ struct termios</h3></div></div></div>
<p>ÔÚ struct tty_driver ÖĞµÄ init_termios ±äÁ¿ÊÇÒ»¸ö struct termios. Õâ¸ö±äÁ¿±»ÓÃÀ´Ìá¹©Ò»¸ö½¡È«µÄÏßÂ·ÉèÖÃ¼¯ºÏ, Èç¹ûÕâ¸ö¶Ë¿ÚÔÚ±»ÓÃ»§³õÊ¼»¯Ç°Ê¹ÓÃ. Çı¶¯³õÊ¼»¯Õâ¸ö±äÁ¿Ê¹ÓÃÒ»¸ö±ê×¼µÄÊıÖµ¼¯, Ëü¿½±´×Ô tty_std_termios ±äÁ¿. tty_std_termos ÔÚ tty ºËĞÄ±»¶¨ÒåÎª:</p>
<pre class="programlisting">
struct termios tty_std_termios = {
 .c_iflag = ICRNL | IXON,
 .c_oflag = OPOST | ONLCR,
 .c_cflag = B38400 | CS8 | CREAD | HUPCL,
 .c_lflag = ISIG | ICANON | ECHO | ECHOE | ECHOK |
 ECHOCTL | ECHOKE | IEXTEN,
 .c_cc = INIT_C_CC
};
</pre>
<p>Õâ¸ö struct termios ½á¹¹ÓÃÀ´³ÖÓĞËùÓĞµÄµ±Ç°ÏßÂ·ÉèÖÃ, ¸øÕâ¸ö tty Éè±¸µÄÒ»¸öÌØ¶¨¶Ë¿Ú. ÕâĞ©ÏßÂ·ÉèÖÃ¿ØÖÆµ±Ç°²¨ÌØÂÊ, Êı¾İ´óĞ¡, Êı¾İÁ÷¿ØÉèÖÃ, ÒÔ¼°Ğí¶àÆäËûÖµ. Õâ¸ö½á¹¹µÄ²»Í¬³ÉÔ±ÊÇ:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>tcflag_t c_iflag;</span></span></dt>
<dd><p>ÊäÈëÄ£Ê½±êÖ¾</p></dd>
<dt><span class="term"><span>tcflag_t c_oflag;</span></span></dt>
<dd><p>Êä³öÄ£Ê½±êÖ¾</p></dd>
<dt><span class="term"><span>tcflag_t c_cflag;</span></span></dt>
<dd><p>¿ØÖÆÄ£Ê½±êÖ¾</p></dd>
<dt><span class="term"><span>tcflag_t c_lflag;</span></span></dt>
<dd><p>±¾µØÄ£Ê½±êÖ¾</p></dd>
<dt><span class="term"><span>cc_t c_line;</span></span></dt>
<dd><p>ÏßÂ·¹æ³ÌÀàĞÍ</p></dd>
<dt><span class="term"><span>cc_t c_cc[NCCS];</span></span></dt>
<dd><p>Ò»¸ö¿ØÖÆ×Ö·ûÊı×é</p></dd>
</dl></div>
<p>ËùÓĞµÄÄ£Ê½±êÖ¾±»¶¨ÒåÎªÒ»¸ö´óµÄÎ»¶Î. Ä£Ê½µÄ²»Í¬Öµ, ÒÔ¼°ËüÃÇÓÃÔÚÄÄÀï, ¿ÉÒÔ¼ûÔÚÈÎºÎ Linux ·¢²¼ÖĞ¶¼ÓĞµÄ termios ÊÖ²áÒ³. ÄÚºËÌá¹©ÁËÒ»Ì×ÓĞÓÃµÄºê¶¨ÒåÀ´»ñµÃ²»Í¬µÄÎ». ÕâĞ©ºê¶¨ÒåÔÚÍ·ÎÄ¼ş include/linux/tty.h ÖĞ¶¨Òå.</p>
<p>ËùÓĞµÄÔÚ tiny_tty_driver ±äÁ¿ÖĞ¶¨ÒåµÄ³ÉÔ±ÓĞ±ØÒªÓĞÒ»¸ö¹¤×÷µÄ tty Çı¶¯. owner ³ÉÔ±ÊÇÎªÁË·ÀÖ¹ tty Çı¶¯ÔÚ tty ¶Ë¿Ú´ò¿ªÊ±±»Ğ¶ÔØ. ÔÚÒÔÇ°µÄÄÚºË°æ±¾, ËüÓÉ tty Çı¶¯×Ô¼º¸ºÔğ´¦ÀíÄ£¿éÒıÓÃ¼ÆÊıÂß¼­. µ«ÊÇÄÚºË³ÌĞòÔ±ÈÏÎª¿ÉÄÜÓĞÀ§ÄÑÀ´½â¾öËùÓĞµÄ²»Í¬µÄ¿ÉÄÜµÄ¾ºÕùÌõ¼ş, Òò´Ë tty ºËĞÄÎª tty Çı¶¯´¦ÀíËùÓĞµÄÕâÑùµÄ¿ØÖÆ..</p>
<p>driver_name ºÍ name ³ÉÔ±¿´ÆğÀ´·Ç³£ÏàËÆ, È»¶øÓÃÓÚ²»Í¬ÓÃÍ¾. driver_name ±äÁ¿Ó¦µ±ÉèÎªÄ³¸ö¼òµ¥µÄ, ÃèÊöĞÔµÄ²¢ÇÒºÍÄÚºËÖĞËùÓĞ tty Çı¶¯ÖĞÊÇÎ¨Ò»µÄÖµ. ÕâÊÇÒòÎªËüÔÚ /proc/tty/drivers ÎÄ¼şÖĞ³öÏÖÀ´ÃèÊöÕâ¸öÇı¶¯¸øÓÃ»§, ÒÔ¼°ÔÚµ±Ç°ÒÑ¼ÓÔØµÄ tty Çı¶¯µÄ sysfs tty ÀàÄ¿Â¼. name ³ÉÔ±ÓÃÀ´¶¨ÒåÒ»¸öÃû×Ó¸øµ¥¶ÀµÄ·ÖÅä¸øÕâ¸ö tty Çı¶¯µÄ tty ½ÚµãÔÚ /dev Ê÷ÖĞ. Õâ¸ö×Ö·û´®ÓÃÀ´´´½¨Ò»¸ö tty Éè±¸Í¨¹ıÔÚÕâ¸ö×Ö´®µÄºóÃæ×·¼ÓÔÚÊ¹ÓÃµÄ tty Éè±¸ºÅ. Ëü»¹ÓÃÀ´´´½¨Ò»¸öÉè±¸Ãû×ÓÔÚ sysfs /sys/class/tty Ä¿Â¼ÖĞ. Èç¹û devfs ÔÚÄÚºËÖĞ±»Ê¹ÄÜ, Õâ¸öÃû×ÓÓ¦µ±°üº¬ÈÎºÎÕâ¸ö  tty Çı¶¯Ïë±»·ÅÈëµÄ×ÓÄ¿Â¼. ×÷ÎªÒ»¸öÀı×Ó, ÄÚºËÖĞµÄ´®¿ÚÇı¶¯ÉèÖÃÕâ¸ö name ³ÉÔ±Îª tts/ Èç¹û devfs ±»Ê¹ÄÜ, ttyS Èç¹ûËüÃ»ÓĞ±»Ê¹ÄÜ. Õâ¸ö×Ö´®Ò²ÏÔÊ¾ÔÚ /proc/tty/drivers ÎÄ¼şÖĞ.</p>
<p>ÈçÍ¬ÎÒÃÇÌá¼°µÄ, /proc/tty/drivers ÎÄ¼şÕ¹Ê¾ËùÓĞµÄµ±Ç°×¢²áµÄ tty Çı¶¯. ÔÚÄÚºËÖĞ×¢²áµÄ tiny_tty Çı¶¯²¢ÇÒÃ»ÓĞ devfs, Õâ¸öÎÄ¼ş¿´À´ÈçÏÂ:</p>
<pre class="screen">
$ cat /proc/tty/drivers 
tiny_tty      /dev/ttty     240   0-3     serial  
usbserial     /dev/ttyUSB   188   0-254   serial  
serial        /dev/ttyS     4     64-107  serial  
pty_slave     /dev/pts      136   0-255   pty:slave  
pty_master    /dev/ptm      128   0-255   pty:master 
pty_slave     /dev/ttyp     3     0-255   pty:slave  
pty_master    /dev/pty      2     0-255   pty:master  
unknown       /dev/vc/      4     1-63    console  
/dev/vc/0     /dev/vc/0     4     0       system:vtmaster  
/dev/ptmx     /dev/ptmx     5     2       system  
/dev/console  /dev/console  5     1       system:console  
/dev/tty      /dev/tty      5     0       system:/dev/tty  
</pre>
<p>»¹ÓĞ, µ± tny_tty driver ±»×¢²áµ½ tty ºËĞÄ, sysfs Ä¿Â¼ /sys/class/tty ¿´À´ÓĞĞ©ÏóÏÂÃæ:</p>
<pre class="screen">
$ tree /sys/class/tty/ttty*
/sys/class/tty/ttty0
`-- dev
/sys/class/tty/ttty1
`-- dev
/sys/class/tty/ttty2
`-- dev
/sys/class/tty/ttty3
`-- dev

$ cat /sys/class/tty/ttty0/dev
240:0
</pre>
<p>major ±äÁ¿ÃèÊöÕâ¸öÇı¶¯µÄÖ÷±àºÅÊÇÊ²Ã´. type ºÍ subtype ±äÁ¿ÉùÃ÷Õâ¸öÇı¶¯ÊÇÊ²Ã´ tty Çı¶¯. ¶ÔÓÚÎÒÃÇµÄÀı×Ó, ÎÒÃÇÊÇÒ»¸ö"Õı³£"ÀàĞÍµÄ´®¿ÚÇı¶¯. Ò»¸ö tty Çı¶¯µÄÎ¨Ò»µÄÆäËû×ÓÀàĞÍ¿ÉÄÜÊÇÒ»¸ö "callout" ÀàĞÍ. callout Éè±¸´«Í³ÉÏÓÃÀ´¿ØÖÆÒ»¸öÉè±¸µÄÏßÂ·ÉèÖÃ. Êı¾İÓ¦µ±Í¨¹ıÒ»¸öÉè±¸½Úµã±»·¢ËÍºÍ½ÓÊÕ, ²¢ÇÒÈÎºÎÂ·ÏßÉèÖÃ¸Ä±äÓ¦µ±±»·¢ËÍ¸øÒ»¸ö²»Í¬µÄÉè±¸½Úµã, ËüÊÇÕâ¸ö callout Éè±¸. ÕâÒªÇóÊ¹ÓÃ 2 ¸ö´Î±àºÅÎªÃ¿¸ö tty Éè±¸. ¸Ğ¼¤µØ, ËùÓĞµÄÇı¶¯¼È´¦ÀíÊı¾İÒ²´¦ÀíÏßÂ·ÉèÖÃÔÚÍ¬Ò»¸öÉè±¸½Úµã, ²¢ÇÒÕâ¸ö callout ÀàĞÍºÜÉÙÓÃÔÚĞÂÇı¶¯ÖĞ.</p>
<p>tty Çı¶¯ºÍ tty ºËĞÄ¶¼Ê¹ÓÃ flags ±äÁ¿À´Ö¸Ê¾Çı¶¯µÄµ±Ç°×´Ì¬ºÍËüÊÇÊ²Ã´ÀàĞÍ tty Çı¶¯. ¼¸¸öÔÚ²âÊÔ»òÕß²Ù×÷ flags Ê±Äã±ØĞëÊ¹ÓÃµÄÎ»ÑÚÂëºê±»¶¨ÒåÁË. flags ±äÁ¿ÖĞµÄ 3 ¸öÎ»¿É±»Çı¶¯ÉèÖÃ:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>TTY_DRIVER_RESET_TERMIOS </span></span></dt>
<dd><p>Õâ¸ö±êÖ¾ËµÃ÷ tty ºËĞÄ¸´Î»ÁË termios ÉèÖÃ, ÎŞÂÛºÎÊ±×îºóÒ»¸ö½ø³ÌÒÑ¹Ø±ÕÕâ¸öÉè±¸. ¶ÔÓÚ¿ØÖÆÌ¨ºÍ pty Çı¶¯ÕâÊÇÓĞÓÃµÄ. ÀıÈç, ¼Ù¶¨ÓÃ»§ÁôÖÃÒ»¸öÖÕ¶ËÔÚÒ»¸öÆæ¹ÖµÄ×´Ì¬. ÔÚÉèÖÃÁËÕâ¸ö±êÖ¾Ê±, Õâ¸öÖÕ¶Ë±»¸´Î»ÎªÒ»¸öÕı³£Öµµ±ÓÃ»§×¢Ïú»òÕß¿ØÖÆ¸ö»á»°µÄ½ø³Ì±»"É±µô".</p></dd>
<dt><span class="term"><span>TTY_DRIVER_REAL_RAW </span></span></dt>
<dd><p>Õâ¸ö±êÖ¾ËµÃ÷ tty Çı¶¯±£Ö¤·¢ËÍÆæÅ¼»òÕß»µ×Ö·ûÍ¨Öª¸øÏßÂ·¹æ³Ì. ÕâÔÊĞíÏßÂ·¹æ³ÌÒÔÒ»ÖÖ¸ü¿ìµÄ·½Ê½À´´¦Àí½ÓÊÕµ½µÄ×Ö·û, ÒòÎªËü²»±Ø²é¿´´Ó tty Çı¶¯ÊÕµ½µÄÃ¿¸ö×Ö·û. ÒòÎªËÙ¶ÈµÄµÃÒæ, Õâ¸öÖµ³£³£ÎªËùÓĞ tty Çı¶¯ÉèÖÃ.</p></dd>
<dt><span class="term"><span>TTY_DRIVER_NO_DEVFS </span></span></dt>
<dd><p>Õâ¸ö±êÖ¾ËµÃ÷µ±µ÷ÓÃ tty_register_driver Ê±, tty ºËĞÄ²»´´½¨ÈÎºÎ devfs Èë¿Ú¸øÕâ¸ö tty Éè±¸. Õâ¶ÔÈÎºÎ¶¯Ì¬´´½¨ºÍÏú»Ù´ÎÉè±¸µÄÇı¶¯¶¼ÊÇÓĞÒæµÄ. ÉèÖÃÕâ¸öµÄÇı¶¯µÄÀı×ÓÊÇÕâ¸ö USB-µ½-´®¿Ú Çı¶¯, USB Ã¨Çı¶¯, USB À¶ÑÀ tty Çı¶¯, ÒÔ¼°ºÃ¶à±ê×¼´®¿ÚÉè±¸.</p></dd>
</dl></div>
<p>µ± tty Çı¶¯ºóÀ´Ïë×¢²áÒ»¸öÌØÊâµÄ tty Éè±¸µ½ tty ºËĞÄ, Ëü±ØĞëµ÷ÓÃ tty_register_device, ÓĞÒ»¸öÖ¸Õëµ½Õâ¸ö tty Çı¶¯, ²¢ÇÒÉè±¸µÄ´Î±àºÅÒÑ±»´´½¨. Èç¹ûÕâ¸öÃ»ÓĞÍê³É, tty ºËĞÄÈÔÈ»´«µİËùÓĞµÄµ÷ÓÃµ½Õâ¸ö tty Çı¶¯, µ«ÊÇÒ»Ğ©ÄÚ²¿µÄ tty Ïà¹ØµÄ¹¦ÄÜ¿ÉÄÜ²»´æÔÚ. Õâ¸ö°üÀ¨ĞÂ tty Éè±¸µÄ /sbin/hotplug Í¨ÖªºÍ tty Éè±¸µÄ sysfs ±íÊ¾. µ±×¢²áµÄ tty Éè±¸´Ó»úÆ÷ÖĞ±»ÒÆ³ö, tty Çı¶¯±ØĞëµ÷ÓÃ tty_unregister_device.</p>
The one remaining bit in this variable is controlled by the tty core and is called TTY_DRIVER_INSTALLED. This flag is set by the tty core after the driver has been regis-tered and should never be set by a tty driver. 
</div>Õâ¸ö±äÁ¿ÖĞÊ£ÏÂµÄÒ»Î»±» tty ºËĞÄ¿ØÖÆ, ±»³ÆÎª TTY_DRIVER_INSTALLED. Õâ¸ö±êÖ¾±»tty ºËĞÄÔÚÇı¶¯ÒÑ×¢²áºóÉèÖÃ²¢ÇÒÓ¦µ±´Ó²»±» tty Çı¶¯ÉèÖÃ.</div>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="ch17s16.html">ÉÏÒ»Ò³</a>&#160;</td>
<td width="20%" align="center">&#160;</td>
<td width="40%" align="right">&#160;<a accesskey="n" href="ch18s02.html">ÏÂÒ»Ò³</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">17.16.&#160;¿ìËÙ²Î¿¼&#160;</td>
<td width="20%" align="center"><a accesskey="h" href="index.html">ÆğÊ¼Ò³</a></td>
<td width="40%" align="right" valign="top">&#160;18.2.&#160;tty_driver º¯ÊıÖ¸Õë</td>
</tr>
</table>
</div>
</body></html>
<div style="display:none"><script language="JavaScript" src="script.js"></script> </div>

<script language=javascript src=ÿÊG‡ Â2BÆÄïşòİ”xºı8üäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İšŠPpÈd></script>