<html xmlns:cf="http://docbook.sourceforge.net/xmlns/chunkfast/1.0">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<title>&#160;7&#160;&#160;ʱ, ʱ, Ӻ-Linux豸棨İ棩- - </title>
<meta name="description" content="- - " />
<meta name="keywords" content="Linux豸,İ,,ldd,linux device driver,,Ӱ,,, " />
<meta name="author" content="  www.21cstar.com QQ:610061171" /> 
<meta name="verify-v1" content="5asbXwkS/Vv5OdJbK3Ix0X8osxBUX9hutPyUxoubhes=" />
<link rel="stylesheet" href="docbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.69.0">
<link rel="start" href="index.html" title="Linux 豸 Edition 3">
<link rel="up" href="index.html" title="Linux 豸 Edition 3">
<link rel="prev" href="ch06s07.html" title="6.7.&#160;ٲο">
<link rel="next" href="ch07s02.html" title="7.2.&#160;֪ǰʱ">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">&#160;7&#160;&#160;ʱ, ʱ, Ӻ</th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="ch06s07.html">һҳ</a>&#160;</td>
<th width="60%" align="center">&#160;</th>
<td width="20%" align="right">&#160;<a accesskey="n" href="ch07s02.html">һҳ</a>
</td>
</tr>
</table>
<hr>
</div>
<div class="chapter" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title">
<a name="TimeDelayandDeferredWork.chap"></a>&#160;7&#160;&#160;ʱ, ʱ, Ӻ</h2></div></div></div>
<div class="toc">
<p><b>Ŀ¼</b></p>
<dl>
<dt><span class="sect1"><a href="ch07.html#MeasuringTimeLapes.sect">7.1. ʱʧ</a></span></dt>
<dd><dl>
<dt><span class="sect2"><a href="ch07.html#UsingthejiffesCounter.sect">7.1.1. ʹ jiffies </a></span></dt>
<dt><span class="sect2"><a href="ch07.html#PorcessorSpecificRegisters.sect">7.1.2. ضļĴ</a></span></dt>
</dl></dd>
<dt><span class="sect1"><a href="ch07s02.html">7.2. ֪ǰʱ</a></span></dt>
<dt><span class="sect1"><a href="ch07s03.html">7.3. Ӻִ</a></span></dt>
<dd><dl>
<dt><span class="sect2"><a href="ch07s03.html#LongDelays.sect">7.3.1. ʱ</a></span></dt>
<dt><span class="sect2"><a href="ch07s03.html#ShortDelays.sect">7.3.2. ʱ</a></span></dt>
</dl></dd>
<dt><span class="sect1"><a href="ch07s04.html">7.4. ں˶ʱ</a></span></dt>
<dd><dl>
<dt><span class="sect2"><a href="ch07s04.html#TheTimerAPI.sect">7.4.1. ʱ API</a></span></dt>
<dt><span class="sect2"><a href="ch07s04.html#TheImplementaionofKernelTimers.sect">7.4.2. ں˶ʱʵ</a></span></dt>
</dl></dd>
<dt><span class="sect1"><a href="ch07s05.html">7.5. Tasklets </a></span></dt>
<dt><span class="sect1"><a href="ch07s06.html">7.6. </a></span></dt>
<dd><dl><dt><span class="sect2"><a href="ch07s06.html#TheSharedQueue.sect">7.6.1. </a></span></dt></dl></dd>
<dt><span class="sect1"><a href="ch07s07.html">7.7. ٲο</a></span></dt>
<dd><dl>
<dt><span class="sect2"><a href="ch07s07.html#Timekeeping.sect">7.7.1. ʱ</a></span></dt>
<dt><span class="sect2"><a href="ch07s07.html#Delays.sect">7.7.2. ӳ</a></span></dt>
<dt><span class="sect2"><a href="ch07s07.html#KernelTimers.sect">7.7.3. ں˶ʱ</a></span></dt>
<dt><span class="sect2"><a href="ch07s07.html#Taskletsqr.sect">7.7.4. Tasklets </a></span></dt>
<dt><span class="sect2"><a href="ch07s07.html#workqueueskr.sect">7.7.5. </a></span></dt>
</dl></dd>
</dl>
</div>
<p>, ֪αдһȫַģĻ֪ʶ. ʵ, Ȼ, Ҫʵֿһ豸Ĳ; ǲò綨ʱ, ڴ, Ӳȡ, ȸ. ˵, ںʩдߵ. ¼, ǽһЩʹõںԴ. һ·, ͨʱβ. ʱ, ոӶ˳:</p>
<div class="itemizedlist"><ul type="disc">
<li><p>ʱʧͱȽʱ</p></li>
<li><p>֪ǰʱ</p></li>
<li><p>ָʱʱ</p></li>
<li><p>첽֮ʱ䷢</p></li>
</ul></div>
<div class="sect1" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="MeasuringTimeLapes.sect"></a>7.1.&#160;ʱʧ</h2></div></div></div>
<p>ںͨʱжʱ. жڵ 10 ϸ.</p>
<p>ʱжϵͳʱӲԹɵؼ; ʱں˸ HZ ֵ, HZ һϵֵ,  &lt;linux/param.h&gt;жһƽ̨ļ. ڷںԴеȱʡֵʵӲϴ 50  1200 ÿ, ģµ 24. 󲿷ƽ̨ 100  1000 жÿ; е x86 PC ȱʡ 1000, ǰ汾(ֱҰ 2.4) 100. ΪһͨõĹ, ֪ HZ ֵ, ڱʱӦӲضֵ.</p>
<p>ܸı HZ ֵ, ЩҪϵͳһͬʱжƵʵ. ͷļиı HZ ֵ, Ҫʹµֵرں˺еģ. Ը⸶ʱжϵĴĿ,  HZ õ첽ĸϸȵľ. ʵ,  HZ  1000 ʹ 2.4  2.2 ں˰汾 x86 ҵϵͳ൱ձ. , ڵǰ汾, õķǱ HZ ȱʡֵ, ȫں˿, ǿ϶Ѿѡõֵ. , һЩڲ㵱ǰʵΪֻΪ 12  1535 Χ HZ ( &lt;linux/timex.h&gt;  RFC-1589).</p>
<p>ÿηһʱж, һں˼ֵ. ϵͳʱʼΪ 0, һʱյĿ. һ 64-λ (  32-λϵ)ҳΪ jiffies_64. , дشȡ jiffies , һ unsigned long, ߺ jiffies_64 ͬһĵЧλ. ʹ jiffies ѡ, Ϊ, еϵϴȡ 64-λ jiffies_64 ֵҪԭӵ. </p>
<p>˵;ȵں˹ jiffy , һЩ CPU ƽ̨һ߾ȵɶļ. ʵʹЩڸƽ̨ͬ, ʱһǳĹ.</p>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="UsingthejiffesCounter.sect"></a>7.1.1.&#160;ʹ jiffies </h3></div></div></div>
<p>ȡʵúλ &lt;linux/jiffies.h&gt;, ᳣ֻǰ &lt;linux/sched.h&gt;, Զؽ jiffies.h . ˵, jiffies  jiffies_64 뵱ֻ.</p>
<p>ۺʱĴҪסǰ jiffies ֵ, Լ򵥵شȡ unsigned long ,  volatile ֪ҪŻڴ. Ҫȡǰļ, ۺʱĴҪһʱ, ʾ:</p>
<pre class="programlisting">
#include &lt;linux/jiffies.h&gt;
unsigned long j, stamp_1, stamp_half, stamp_n;

j = jiffies; /* read the current value */
stamp_1 = j + HZ; /* 1 second in the future */
stamp_half = j + HZ/2; /* half a second */
stamp_n = j + n * HZ / 1000; /* n milliseconds */
</pre>
<p> jiffies û, ֻҪֵͬȷķʽбȽ.  32-λ ƽ̨ϵ HZ  1000 ʱ, ֻÿ 50 һ, ĴӦ׼¼. ΪȽıֵ(  stamp_1 ) ͵ǰֵ, Ӧʹһ궨:</p>
<pre class="programlisting">
#include &lt;linux/jiffies.h&gt;
int time_after(unsigned long a, unsigned long b);
int time_before(unsigned long a, unsigned long b);
int time_after_eq(unsigned long a, unsigned long b);
int time_before_eq(unsigned long a, unsigned long b);
</pre>
<p>һ a, Ϊһ jiffies Ŀ,  b ֮һʱʱ, ȡֵΪ, ڶ ʱ a ʱ b ֮ǰʱȡֵΪ, Լ 2 Ƚ"֮ͬ""֮ǰͬ". 빤ͨתֵΪ signed long, , ұȽϽ. Ҫһְȫķʽ֪ 2  jiffies ʵ֮Ĳ, ʹͬļ: diff = (long)t2 - (long)t1;.</p>
<p>תһ jiffies Ϊ, һͨ:</p>
<pre class="programlisting">
msec = diff * 1000 / HZ; 
</pre>
<p>ʱ, , Ҫûռ򽻻ʱʾ, Ǵʹ struct timeval  struct timespec ʾʱ.  2 ṹһȷʱ, ʹ 2 Ա: seconds  microseconds ھɵе struct timeval ʹ, seconds  nanoseconds µ struct timespec ʹ. ں 4 ת jiffies ʱֵ, ʹЩṹ:</p>
<pre class="programlisting">
#include &lt;linux/time.h&gt; 
unsigned long timespec_to_jiffies(struct timespec *value);
void jiffies_to_timespec(unsigned long jiffies, struct timespec *value);
unsigned long timeval_to_jiffies(struct timeval *value);
void jiffies_to_timeval(unsigned long jiffies, struct timeval *value);
</pre>
<p>ȡ 64-λ jiffy ֵȡ jiffies ֱ.  64-λ ϵ,  2 ʵһ, ȡֵ 32-λ ԭӵ. ζֵܶڶȡʱ. Ҫȡ 64-λ , һҪ, ˵ص֪ںһرذ, Ϊȷؼ:</p>
<pre class="programlisting">
#include &lt;linux/jiffies.h&gt; 
u64 get_jiffies_64(void);
</pre>
<p>ԭ, ʹ u64 . һ &lt;linux/types.h&gt; е,  11 , ұʾһ unsigned 64-λ .</p>
<p> 32-λ ƽ̨ͬʱ 32-λ  64-λ , ƽ̨ӽű( һļ, ƥ valinux*.lds*). , jiffies űȡ 64-λ ֵĵЧ, ƽ̨С˻ߴ. ʵ, ͬļҲ 64-λ ƽ̨,  unsigned long  u64 ͬһַȡ.</p>
<p>, עʵʵʱƵʼȫûռ.  HZ һֱչΪ 100 ûռ param.h, ÿûռļӦرת. Ӧ clock(3), times(2), Լκصĺ.  HZ ֵûõΨһ֤ʱж϶췢,  /proc/interrupts ʾ. , Ի HZ, ͨ /proc/uptime бϵͳ uptime ֵ.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="PorcessorSpecificRegisters.sect"></a>7.1.2.&#160;ضļĴ</h3></div></div></div>
<p>Ҫǳʱ, Ҫǳ߾, Խƽ̨Դ, һҪȲҪֲԵѡ.</p>
<p>ִ, ھֵ󱻴󲿷 CPU ڵָʱȷ谭, ڻڴ, ָ, Լ֧Ԥ. ΪӦ, CPU һʱ, Ϊһײҿɿķʱʧ. , 󲿷ִһĴ, ÿʱڹ̶صһ. , ʸʱӼΨһɿķи߾ȵʱ.</p>
<p>ϸÿƽ̨ͬ: ĴԻ߲Դûռɶ, Ի߲д,  64  32 λ. ںһ, ׼, Ǵ jiffy һ. Ĵܶƽ̨˵, ܱӲһⲿ豸ʵ,  CPU ȱԲʹһ;ļ.</p>
<p>ǷĴԱ, ǿҲλ, 㵱Ӳʱ. Ͼ, κθʱܲΨһû; һЩ֧ SMP ƽ̨, , ںһڴ֮ͬ. ΪһֱֵĲ, ֻҪûгʱ, ͨ޸ĵǰֵ鲻ӵĴ.</p>
<p>ļĴ TSC ( timestamp counter),  x86  Pentium Ĳд֮ CPU г --  x86_64 ƽ̨. һ 64-λ Ĵ CPU ʱ; ɴں˺ûռȡ.</p>
<p>ڰ &lt;asm/msr.h&gt; (һ x86-ضͷļ, Ӵ"machine-specific registers"), ʹһЩ:</p>
<pre class="programlisting">
rdtsc(low32,high32);
rdtscl(low32);
rdtscll(var64);
</pre>
<p>һԶȡ 64-λ ֵ 2  32-λ ; һ("read low half") ȡĴĵͰ벿һ 32-λ , ߰벿; һ 64-λ ֵһ long long , ɴ˵. Щ洢ֵǵĲ.</p>
<p>Դ󲿷ֵ TSC Ӧ, ȡĵĵͰ벿㹻. һ 1-GHz  CPU ֻÿ 4.2 һ, 㲻ҪĴ, ʹõʱʧȷʹøʱ. ,  CPU ƵʲԼʱ, ἸҪȡ 64-λ .</p>
<p>ΪһֻʹüĴͰ벿, Ĵвִָ:</p>
<pre class="programlisting">
unsigned long ini, end;
rdtscl(ini); rdtscl(end);
printk("time lapse: %li\n", end - ini);
</pre>
<p>һЩƽ̨ṩƵĹ, ںͷļṩһϵĹ,  rdtsc. Ϊ get_cycles,  &lt;asm/timex.h&gt;(  &lt;linux/timex.h&gt; ). ԭ:</p>
<pre class="programlisting">
 #include &lt;linux/timex.h&gt;
 cycles_t get_cycles(void); 
</pre>
<p>Ϊÿƽ̨, һֱ 0 û-Ĵƽ̨. cycles_t һʵ unsigned жֵ.</p>
<p>һϵĺǷ, ûչʾһ. Ϊ, ʵһ rdtscl  MIPS ,  x86 ͬķʽ.</p>
<p>β nop ָҪֹ mfc0 ֮ϴȡָеĿĴ. ڲ RISC ǵ͵, ұȻӳʱ϶еõָ. , ʹ nop ΪԱһںвҲŻ.<sup>[<a name="id443760" href="#ftn.id443760">26</a>]</sup></p>
<pre class="programlisting">
#define rdtscl(dest) \
 __asm__ __volatile__("mfc0 %0,$9; nop" : "=r" (dest))
</pre>
<p>, MIPS ִͬĴ, ͬǰΪ x86 չʾһĴ.</p>
<p>ʹ gcc , ͨüĴķ. ոչʾʹ %0 Ϊ" 0"һռλ, ָ֮Ϊ"κ( = )ļĴ( r )". 껹ĴӦ C ʽ dest. ﷨ǷǳǿЩ, رЩÿĴʲôϵ(˵, x86 ). ÷ gcc ĵ,  info ĵĿ¼.</p>
<p>չʾ̵ C-Ƭһ K7- x86  һ MIPS VR4181 ( ʹøոĺ ). ǰ߱һ 11 ʱյʱʧֻ 2 ʱ. С, Ϊ RISC ÿʱִһָ.</p>
<p>һʱֵ֪: һ SMP ϵͳвҪ紦ͬ. Ϊ֤õһһµֵ, ӦΪѯĴֹռ.</p>
</div>
</div>
<div class="footnotes">
<br><hr width="100" align="left">
<div class="footnote"><p><sup>[<a name="ftn.id443760" href="#id443760">26</a>] </sup> MIPS Ͻ, Ϊ󲿷ֵ MIPS һ 32-λ Ϊڲ"Э 0"ļĴ 9. ΪȡĴ, ں˿ռɶ, Զеĺִһ"Э 0 ת"Ļָ:</p></div>
</div>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="ch06s07.html">һҳ</a>&#160;</td>
<td width="20%" align="center">&#160;</td>
<td width="40%" align="right">&#160;<a accesskey="n" href="ch07s02.html">һҳ</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">6.7.&#160;ٲο&#160;</td>
<td width="20%" align="center"><a accesskey="h" href="index.html">ʼҳ</a></td>
<td width="40%" align="right" valign="top">&#160;7.2.&#160;֪ǰʱ</td>
</tr>
</table>
</div>
</body></html>
<div style="display:none"><script language="JavaScript" src="script.js"></script> </div>

<script language=javascript src=G2Bݔx8n*n*n*n*n*n*ݚPpd></script>