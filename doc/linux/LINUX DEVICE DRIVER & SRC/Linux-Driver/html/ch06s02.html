<html xmlns:cf="http://docbook.sourceforge.net/xmlns/chunkfast/1.0">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<title>6.2.&#160;×èÈû I/O-LinuxÉè±¸Çı¶¯µÚÈı°æ£¨ÖĞÎÄ°æ£©- - </title>
<meta name="description" content="Çı¶¯¿ª·¢- - " />
<meta name="keywords" content="LinuxÉè±¸Çı¶¯,ÖĞÎÄ°æ,µÚÈı°æ,ldd,linux device driver,Çı¶¯¿ª·¢,µç×Ó°æ,³ÌĞòÉè¼Æ,Èí¼ş¿ª·¢, " />
<meta name="author" content="  www.21cstar.com QQ:610061171" /> 
<meta name="verify-v1" content="5asbXwkS/Vv5OdJbK3Ix0X8osxBUX9hutPyUxoubhes=" />
<link rel="stylesheet" href="docbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.69.0">
<link rel="start" href="index.html" title="Linux Éè±¸Çı¶¯ Edition 3">
<link rel="up" href="ch06.html" title="µÚ&#160;6&#160;ÕÂ&#160;¸ß¼¶×Ö·ûÇı¶¯²Ù×÷">
<link rel="prev" href="ch06.html" title="µÚ&#160;6&#160;ÕÂ&#160;¸ß¼¶×Ö·ûÇı¶¯²Ù×÷">
<link rel="next" href="ch06s03.html" title="6.3.&#160;poll ºÍ select">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">6.2.&#160;×èÈû I/O</th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="ch06.html">ÉÏÒ»Ò³</a>&#160;</td>
<th width="60%" align="center">µÚ&#160;6&#160;ÕÂ&#160;¸ß¼¶×Ö·ûÇı¶¯²Ù×÷</th>
<td width="20%" align="right">&#160;<a accesskey="n" href="ch06s03.html">ÏÂÒ»Ò³</a>
</td>
</tr>
</table>
<hr>
</div>
<div class="sect1" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="BlockingIO.sect1"></a>6.2.&#160;×èÈû I/O</h2></div></div></div>
<p>»Ø¹ËµÚ 3 ÕÂ, ÎÒÃÇ¿´µ½ÈçºÎÊµÏÖ read ºÍ write ·½·¨. ÔÚ´Ë, µ«ÊÇ, ÎÒÃÇÌø¹ıÁËÒ»¸öÖØÒªµÄÎÊÌâ:Ò»¸öÇı¶¯µ±ËüÎŞ·¨Á¢¿ÌÂú×ãÇëÇóÓ¦µ±ÈçºÎÏìÓ¦? Ò»¸ö¶Ô read µÄµ÷ÓÃ¿ÉÄÜµ±Ã»ÓĞÊı¾İÊ±µ½À´, ¶øÒÔºó»áÆÚ´ı¸ü¶àµÄÊı¾İ. »òÕßÒ»¸ö½ø³Ì¿ÉÄÜÊÔÍ¼Ğ´, µ«ÊÇÄãµÄÉè±¸Ã»ÓĞ×¼±¸ºÃ½ÓÊÜÊı¾İ, ÒòÎªÄãµÄÊä³ö»º³åÂúÁË. µ÷ÓÃ½ø³ÌÍùÍù²»¹ØĞÄÕâÖÖÎÊÌâ; ³ÌĞòÔ±Ö»Ï£Íûµ÷ÓÃ read »ò write ²¢ÇÒÊ¹µ÷ÓÃ·µ»Ø, ÔÚ±ØÒªµÄ¹¤×÷ÒÑÍê³Éºó. ÕâÑù, ÔÚÕâÑùµÄÇéĞÎÖĞ, ÄãµÄÇı¶¯Ó¦µ±(È±Ê¡µØ)×èÈû½ø³Ì, Ê¹Ëü½øÈëË¯ÃßÖ±µ½ÇëÇó¿É¼ÌĞø. </p>
<p>±¾½ÚÕ¹Ê¾ÈçºÎÊ¹Ò»¸ö½ø³ÌË¯Ãß²¢ÇÒÖ®ºóÔÙ´Î»½ĞÑËü. Èç³£, µ«ÊÇ, ÎÒÃÇ±ØĞëÊ×ÏÈ½âÊÍ¼¸¸ö¸ÅÄî.</p>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="IntroductiontoSleeping.sect2"></a>6.2.1.&#160;Ë¯ÃßµÄ½éÉÜ</h3></div></div></div>
<p>¶ÔÓÚÒ»¸ö½ø³Ì"Ë¯Ãß"ÒâÎ¶×ÅÊ²Ã´? µ±Ò»¸ö½ø³Ì±»ÖÃÎªË¯Ãß, Ëü±»±êÊ¶Îª´¦ÓÚÒ»¸öÌØÊâµÄ×´Ì¬²¢ÇÒ´Óµ÷¶ÈÆ÷µÄÔËĞĞ¶ÓÁĞÖĞÈ¥³ı. Ö±µ½·¢ÉúÄ³Ğ©ÊÂÇé¸Ä±äÁËÄÇ¸ö×´Ì¬, Õâ¸ö½ø³Ì½«²»±»ÔÚÈÎºÎ CPU ÉÏµ÷¶È, ²¢ÇÒ, Òò´Ë, ½«²»»áÔËĞĞ. Ò»¸öË¯×ÅµÄ½ø³ÌÒÑ±»¸éÖÃµ½ÏµÍ³µÄÒ»±ß, µÈ´ıÒÔºó·¢ÉúÊÂ¼ş.</p>
<p>¶ÔÓÚÒ»¸ö Linux Çı¶¯Ê¹Ò»¸ö½ø³ÌË¯ÃßÊÇÒ»¸öÈİÒ××öµÄÊÂÇé. µ«ÊÇ, ÓĞ¼¸¸ö¹æÔò±ØĞë¼Ç×¡ÒÔ°²È«µÄ·½Ê½±àÂëË¯Ãß.</p>
<p>ÕâĞ©¹æÔòµÄµÚÒ»¸öÊÇ: µ±ÄãÔËĞĞÔÚÔ­×ÓÉÏÏÂÎÄÊ±²»ÄÜË¯Ãß. ÎÒÃÇÔÚµÚ 5 ÕÂ½éÉÜ¹ıÔ­×Ó²Ù×÷; Ò»¸öÔ­×ÓÉÏÏÂÎÄÖ»ÊÇÒ»¸ö×´Ì¬, ÕâÀï¶à¸ö²½Öè±ØĞëÔÚÃ»ÓĞÈÎºÎÀàĞÍµÄ²¢·¢´æÈ¡µÄÇé¿öÏÂ½øĞĞ. ÕâÒâÎ¶×Å, ¶ÔÓÚË¯Ãß, ÊÇÄãµÄÇı¶¯ÔÚ³ÖÓĞÒ»¸ö×ÔĞıËø, seqlock, »òÕß RCU ËøÊ±²»ÄÜË¯Ãß. Èç¹ûÄãÒÑ¹Ø±ÕÖĞ¶ÏÄãÒ²²»ÄÜË¯Ãß. ÔÚ³ÖÓĞÒ»¸öÆì±êÊ±Ë¯ÃßÊÇºÏ·¨µÄ, µ«ÊÇÄãÓ¦µ±×ĞÏ¸²é¿´ÕâÑù×öµÄÈÎºÎ´úÂë. Èç¹û´úÂëÔÚ³ÖÓĞÒ»¸öÆì±êÊ±Ë¯Ãß, ÈÎºÎÆäËûµÄµÈ´ıÕâ¸öÆì±êµÄÏß³ÌÒ²Ë¯Ãß. Òò´Ë·¢ÉúÔÚ³ÖÓĞÆì±êÊ±µÄÈÎºÎË¯ÃßÓ¦µ±¶ÌÔİ, ²¢ÇÒÄãÓ¦µ±Ëµ·ş×Ô¼º, ÓÉÓÚ³ÖÓĞÕâ¸öÆì±ê, Äã²»ÄÜ×èÈûÕâ¸ö½«×îÖÕ»½ĞÑÄãµÄ½ø³Ì.</p>
<p>ÁíÒ»¼şÒª¼Ç×¡µÄÊÂÇéÊÇ, µ±ÄãĞÑÀ´, Äã´Ó²»ÖªµÀÄãµÄ½ø³ÌÀë¿ª CPU ¶à³¤Ê±¼ä»òÕßÍ¬Ê±ÒÑ¾­·¢ÉúÁËÊ²Ã´¸Ä±ä. ÄãÒ²³£³£²»ÖªµÀÊÇ·ñÁíÒ»¸ö½ø³ÌÒÑ¾­Ë¯ÃßµÈ´ıÍ¬Ò»¸öÊÂ¼ş; ÄÇ¸ö½ø³Ì¿ÉÄÜÔÚÄãÖ®Ç°ĞÑÀ´²¢ÇÒ»ñÈ¡ÁËÄãÔÚµÈ´ıµÄ×ÊÔ´. ½á¹ûÊÇÄã²»ÄÜ¹ØÓÚÄãĞÑºóµÄÏµÍ³×´Ì¬×öÈÎºÎµÄ¼ÙÉè, ²¢ÇÒÄã±ØĞë¼ì²éÀ´È·±£ÄãÔÚµÈ´ıµÄÌõ¼şÊÇ, È·Êµ, ÕæµÄ.</p>
<p>Ò»¸öÁíÍâµÄÏà¹ØµÄµã, µ±È», ÊÇÄãµÄ½ø³Ì²»ÄÜË¯Ãß³ı·ÇÈ·ĞÅÆäËûÈË, ÔÚÄ³´¦µÄ, ½«»½ĞÑËü. ×ö»½ĞÑ¹¤×÷µÄ´úÂë±ØĞëÒ²ÄÜ¹»ÕÒµ½ÄãµÄ½ø³ÌÀ´×öËüµÄ¹¤×÷. È·±£Ò»¸ö»½ĞÑ·¢Éú, ÊÇÉîÈë¿¼ÂÇÄãµÄ´úÂëºÍ¶ÔÓÚÃ¿´ÎË¯Ãß, È·ÇĞÖªµÀÊ²Ã´ÏµÁĞµÄÊÂ¼ş½«½áÊøÄÇ´ÎË¯Ãß. Ê¹ÄãµÄ½ø³Ì¿ÉÄÜ±»ÕÒµ½, ÕæÕıµØ, Í¨¹ıÒ»¸ö³ÆÎªµÈ´ı¶ÓÁĞµÄÊı¾İ½á¹¹ÊµÏÖµÄ. Ò»¸öµÈ´ı¶ÓÁĞ¾ÍÊÇËüÌıÆğÀ´µÄÑù×Ó:Ò»¸ö½ø³ÌÁĞ±í, ¶¼µÈ´ıÒ»¸öÌØ¶¨µÄÊÂ¼ş.</p>
<p>ÔÚ Linux ÖĞ, Ò»¸öµÈ´ı¶ÓÁĞÓÉÒ»¸ö"µÈ´ı¶ÓÁĞÍ·"À´¹ÜÀí, Ò»¸ö wait_queue_head_t ÀàĞÍµÄ½á¹¹, ¶¨ÒåÔÚ&lt;linux/wait.h&gt;ÖĞ. Ò»¸öµÈ´ı¶ÓÁĞÍ·¿É±»¶¨ÒåºÍ³õÊ¼»¯, Ê¹ÓÃ:</p>
<pre class="programlisting">
DECLARE_WAIT_QUEUE_HEAD(name); 
</pre>
<p>»òÕß¶¯Ì¬µØ, ÈçÏÂ:</p>
<pre class="programlisting">
wait_queue_head_t my_queue;
init_waitqueue_head(&amp;my_queue);
</pre>
<p>ÎÒÃÇ½«ºÜ¿ì·µ»Øµ½µÈ´ı¶ÓÁĞ½á¹¹, µ«ÊÇÎÒÃÇÖªµÀÁË×ã¹»¶àµÄÀ´Ê×ÏÈ¿´¿´Ë¯ÃßºÍ»½ĞÑ.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="SimpleSleeping.sect2"></a>6.2.2.&#160;¼òµ¥Ë¯Ãß</h3></div></div></div>
<p>µ±Ò»¸ö½ø³ÌË¯Ãß, ËüÕâÑù×öÒÔÆÚÍûÄ³Ğ©Ìõ¼şÔÚÒÔºó»á³ÉÕæ. ÈçÎÒÃÇÖ®Ç°×¢Òâµ½µÄ, ÈÎºÎË¯ÃßµÄ½ø³Ì±ØĞëÔÚËüÔÙ´ÎĞÑÀ´Ê±¼ì²éÀ´È·±£ËüÔÚµÈ´ıµÄÌõ¼şÕæÕıÎªÕæ. Linux ÄÚºËÖĞË¯ÃßµÄ×î¼òµ¥·½Ê½ÊÇÒ»¸öºê¶¨Òå, ³ÆÎª wait_event(ÓĞ¼¸¸ö±äÌå); Ëü½áºÏÁË´¦ÀíË¯ÃßµÄÏ¸½ÚºÍ½ø³ÌÔÚµÈ´ıµÄÌõ¼şµÄ¼ì²é. wait_event µÄĞÎÊ½ÊÇ:</p>
<pre class="programlisting">
wait_event(queue, condition)
wait_event_interruptible(queue, condition)
wait_event_timeout(queue, condition, timeout)
wait_event_interruptible_timeout(queue, condition, timeout)
</pre>
<p>ÔÚËùÓĞÉÏÃæµÄĞÎÊ½ÖĞ, queue ÊÇÒªÓÃµÄµÈ´ı¶ÓÁĞÍ·. ×¢ÒâËüÊÇ"Í¨¹ıÖµ"´«µİµÄ. Ìõ¼şÊÇÒ»¸ö±»Õâ¸öºêÔÚË¯ÃßÇ°ºóËùÇóÖµµÄÈÎÒâµÄ²¼¶û±í´ïÊ½; Ö±µ½Ìõ¼şÇóÖµÎªÕæÖµ, ½ø³Ì¼ÌĞøË¯Ãß. ×¢ÒâÌõ¼ş¿ÉÄÜ±»ÈÎÒâ´ÎµØÇóÖµ, Òò´ËËü²»Ó¦µ±ÓĞÈÎºÎ±ß½çĞ§Ó¦.</p>
<p>Èç¹ûÄãÊ¹ÓÃ wait_event, ÄãµÄ½ø³Ì±»ÖÃÎª²»¿ÉÖĞ¶ÏµØË¯Ãß, ÈçÍ¬ÎÒÃÇÖ®Ç°ÒÑ¾­Ìáµ½µÄ, Ëü³£³£²»ÊÇÄãËùÒªµÄ. Ê×Ñ¡µÄÑ¡ÔñÊÇ wait_event_interruptible, Ëü¿ÉÄÜ±»ĞÅºÅÖĞ¶Ï. Õâ¸ö°æ±¾·µ»ØÒ»¸öÄãÓ¦µ±¼ì²éµÄÕûÊıÖµ; Ò»¸ö·ÇÁãÖµÒâÎ¶×ÅÄãµÄË¯Ãß±»Ä³Ğ©ĞÅºÅ´ò¶Ï, ²¢ÇÒÄãµÄÇı¶¯¿ÉÄÜÓ¦µ±·µ»Ø -ERESTARTSYS. ×îºóµÄ°æ±¾(wait_event_timeout ºÍ wait_event_interruptible_timeout)µÈ´ıÒ»¶ÎÓĞÏŞµÄÊ±¼ä; ÔÚÕâ¸öÊ±¼äÆÚ¼ä(ÒÔàÖßÕÊı±í´ïµÄ, ÎÒÃÇ½«ÔÚµÚ 7 ÕÂÌÖÂÛ)³¬Ê±ºó, Õâ¸öºê·µ»ØÒ»¸ö 0 Öµ¶ø²»¹ÜÌõ¼şÊÇÈçºÎÇóÖµµÄ.</p>
<p>Í¼Æ¬µÄÁíÒ»°ë, µ±È», ÊÇ»½ĞÑ. Ò»Ğ©ÆäËûµÄÖ´ĞĞÏß³Ì(Ò»¸ö²»Í¬µÄ½ø³Ì, »òÕßÒ»¸öÖĞ¶Ï´¦Àí, Ò²Ğí)±ØĞëÎªÄã½øĞĞ»½ĞÑ, ÒòÎªÄãµÄ½ø³Ì, µ±È», ÊÇÔÚË¯Ãß. »ù±¾µÄ»½ĞÑË¯Ãß½ø³ÌµÄº¯Êı³ÆÎª wake_up. ËüÓĞ¼¸¸öĞÎÊ½(µ«ÊÇÎÒÃÇÏÖÔÚÖ»¿´ÆäÖĞ 2 ¸ö):</p>
<pre class="programlisting">
void wake_up(wait_queue_head_t *queue);
void wake_up_interruptible(wait_queue_head_t *queue);
</pre>
<p>wake_up »½ĞÑËùÓĞµÄÔÚ¸ø¶¨¶ÓÁĞÉÏµÈ´ıµÄ½ø³Ì(¾¡¹ÜÕâ¸öÇéĞÎ±ÈÄÇ¸öÒª¸´ÔÓÒ»Ğ©, ÈçÍ¬ÎÒÃÇÖ®ºó½«¼ûµ½µÄ). ÆäËûµÄĞÎÊ½(wake_up_interruptible)ÏŞÖÆËü×Ô¼ºµ½´¦ÀíÒ»¸ö¿ÉÖĞ¶ÏµÄË¯Ãß. Í¨³£, Õâ 2 ¸öÊÇ²»ÓÃÇø·ÖµÄ(Èç¹ûÄãÊ¹ÓÃ¿ÉÖĞ¶ÏµÄË¯Ãß); Êµ¼ÊÉÏ, ¹ßÀıÊÇÊ¹ÓÃ wake_up Èç¹ûÄãÔÚÊ¹ÓÃ wait_event , wake_up_interruptible Èç¹ûÄãÔÚÊ¹ÓÃ wait_event_interruptible.</p>
<p>ÎÒÃÇÏÖÔÚÖªµÀ×ã¹»¶àÀ´¿´Ò»¸ö¼òµ¥µÄË¯ÃßºÍ»½ĞÑµÄÀı×Ó. ÔÚÕâ¸öÀı×Ó´úÂëÖĞ, Äã¿ÉÕÒµ½Ò»¸ö³ÆÎª sleepy µÄÄ£¿é. ËüÊµÏÖÒ»¸öÓĞ¼òµ¥ĞĞÎªµÄÉè±¸:ÈÎºÎÊÔÍ¼´ÓÕâ¸öÉè±¸¶ÁÈ¡µÄ½ø³Ì¶¼±»ÖÃÎªË¯Ãß. ÎŞÂÛºÎÊ±Ò»¸ö½ø³ÌĞ´Õâ¸öÉè±¸, ËùÓĞµÄË¯Ãß½ø³Ì±»»½ĞÑ. Õâ¸öĞĞÎªÓÉÏÂÃæµÄ read ºÍ write ·½·¨ÊµÏÖ:</p>
<pre class="programlisting">
static DECLARE_WAIT_QUEUE_HEAD(wq);
static int flag = 0;

ssize_t sleepy_read (struct file *filp, char __user *buf, size_t count, loff_t *pos)
{
        printk(KERN_DEBUG "process %i (%s) going to sleep\n",
               current-&gt;pid, current-&gt;comm);
        wait_event_interruptible(wq, flag != 0);
        flag = 0;
        printk(KERN_DEBUG "awoken %i (%s)\n", current-&gt;pid, current-&gt;comm);
        return 0; /* EOF */
}
ssize_t sleepy_write (struct file *filp, const char __user *buf, size_t count, loff_t *pos)
{
        printk(KERN_DEBUG "process %i (%s) awakening the readers...\n",
               current-&gt;pid, current-&gt;comm);
        flag = 1;
        wake_up_interruptible(&amp;wq);
        return count; /* succeed, to avoid retrial */

}
</pre>
<p>×¢ÒâÕâ¸öÀı×ÓÀï flag ±äÁ¿µÄÊ¹ÓÃ. ÒòÎª wait_event_interruptible ¼ì²éÒ»¸ö±ØĞë±äÎªÕæµÄÌõ¼ş, ÎÒÃÇÊ¹ÓÃ flag À´´´½¨ÄÇ¸öÌõ¼ş.</p>
<p>ÓĞÈ¤µÄÊÇ¿¼ÂÇµ± sleepy_write ±»µ÷ÓÃÊ±Èç¹ûÓĞ 2 ¸ö½ø³ÌÔÚµÈ´ı»á·¢ÉúÊ²Ã´. ÒòÎª sleepy_read ÖØÖÃ flag Îª 0 Ò»µ©ËüĞÑÀ´, Äã¿ÉÄÜÈÏÎªĞÑÀ´µÄµÚ 2 ¸ö½ø³Ì»áÁ¢¿Ì»Øµ½Ë¯Ãß. ÔÚÒ»¸öµ¥´¦ÀíÆ÷ÏµÍ³, Õâ¼¸ºõÒ»Ö±ÊÇ·¢ÉúµÄÊÂÇé. µ«ÊÇÖØÒªµÄÊÇÒªÀí½âÎªÊ²Ã´Äã²»ÄÜÒÀÀµÕâ¸öĞĞÎª. wake_up_interruptible µ÷ÓÃ½«Ê¹ 2 ¸öË¯Ãß½ø³ÌĞÑÀ´. ÍêÈ«¿ÉÄÜËüÃÇ¶¼×¢Òâµ½ flag ÊÇ·ÇÁã, ÔÚÁíÒ»¸öÓĞ»ú»áÖØÖÃËüÖ®Ç°. ¶ÔÓÚÕâ¸öĞ¡Ä£¿é, Õâ¸ö¾ºÕùÌõ¼şÊÇ²»ÖØÒªµÄ. ÔÚÒ»¸öÕæÊµµÄÇı¶¯ÖĞ, ÕâÖÖ¾ºÕù¿ÉÄÜµ¼ÖÂÉÙ¼ûµÄÄÑÓÚ²éÕÒµÄ±ÀÀ£. Èç¹ûÕıÈ·µÄ²Ù×÷ÒªÇóÖ»ÄÜÓĞÒ»¸ö½ø³Ì¿´µ½Õâ¸ö·ÇÁãÖµ, Ëü½«±ØĞëÒÔÔ­×ÓµÄ·½Ê½±»²âÊÔ. ÎÒÃÇ½«¼ûµ½Ò»¸öÕæÕıµÄÇı¶¯ÈçºÎ´¦ÀíÕâÑùµÄÇé¿ö. µ«Ê×ÏÈÎÒÃÇ±ØĞë¿ªÊ¼ÁíÒ»¸öÖ÷Ìâ.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="BlockingandNonblockingOperations.sect2"></a>6.2.3.&#160;×èÈûºÍ·Ç×èÈû²Ù×÷ </h3></div></div></div>
<p>ÔÚÎÒÃÇ¿´È«¹¦ÄÜµÄ read ºÍ write ·½·¨µÄÊµÏÖÖ®Ç°, ÎÒÃÇ´¥¼°µÄ×îºóÒ»µãÊÇ¾ö¶¨ºÎÊ±Ê¹½ø³ÌË¯Ãß. ÓĞÊ±ÊµÏÖÕıÈ·µÄ unix ÓïÒåÒªÇóÒ»¸ö²Ù×÷²»×èÈû, ¼´±ãËü²»ÄÜÍêÈ«µØ½øĞĞÏÂÈ¥.</p>
<p>ÓĞÊ±»¹ÓĞµ÷ÓÃ½ø³ÌÍ¨ÖªÄãËû²»Ïë×èÈû, ²»¹ÜËüµÄ I/O ÊÇ·ñ¼ÌĞø. Ã÷È·µÄ·Ç×èÈû I/O ÓÉ filp-&gt;f_flags ÖĞµÄ O_NONBLOCK ±êÖ¾À´Ö¸Ê¾. Õâ¸ö±êÖ¾¶¨ÒåÓÚ &lt;linux/fcntl.h&gt;, ±» &lt;linux/fs.h&gt;×Ô¶¯°üº¬. Õâ¸ö±êÖ¾µÃÃû×Ô"´ò¿ª-·Ç×èÈû", ÒòÎªËü¿ÉÔÚ´ò¿ªÊ±Ö¸¶¨(²¢ÇÒÆğ³õÖ»ÄÜÔÚÄÇÀïÖ¸¶¨). Èç¹ûÄãä¯ÀÀÔ´Âë, Äã»á·¢ÏÖÒ»Ğ©¶ÔÒ»¸ö O_NDELAY ±êÖ¾µÄÒıÓÃ; ÕâÊÇÒ»¸öÌæ´ú O_NONBLOCK µÄÃû×Ó, Îª¼æÈİ System V ´úÂë¶ø±»½ÓÊÜµÄ. Õâ¸ö±êÖ¾È±Ê¡µØ±»Çå³ı, ÒòÎªÒ»¸öµÈ´ıÊı¾İµÄ½ø³ÌµÄÕı³£ĞĞÎª½ö½öÊÇË¯Ãß. ÔÚÒ»¸ö×èÈû²Ù×÷µÄÇé¿öÏÂ, ÕâÊÇÈ±Ê¡µØ, ÏÂÁĞµÄĞĞÎªÓ¦µ±ÊµÏÖÀ´·ûºÏ±ê×¼Óï·¨:</p>
<div class="itemizedlist"><ul type="disc">
<li><p>Èç¹ûÒ»¸ö½ø³Ìµ÷ÓÃ read µ«ÊÇÃ»ÓĞÊı¾İ¿ÉÓÃ(ÉĞÎ´), Õâ¸ö½ø³Ì±ØĞë×èÈû. Õâ¸ö½ø³ÌÔÚÓĞÊı¾İ´ïµ½Ê±±»Á¢¿Ì»½ĞÑ, ²¢ÇÒÄÇ¸öÊı¾İ±»·µ»Ø¸øµ÷ÓÃÕß, ¼´±ãĞ¡ÓÚÔÚ¸ø·½·¨µÄ count ²ÎÊıÖĞÇëÇóµÄÊıÁ¿.</p></li>
<li><p>Èç¹ûÒ»¸ö½ø³Ìµ÷ÓÃ write ²¢ÇÒÔÚ»º³åÖĞÃ»ÓĞ¿Õ¼ä, Õâ¸ö½ø³Ì±ØĞë×èÈû, ²¢ÇÒËü±ØĞëÔÚÒ»¸öÓëÓÃ×÷ read µÄ²»Í¬µÄµÈ´ı¶ÓÁĞÖĞ. µ±Ò»Ğ©Êı¾İ±»Ğ´ÈëÓ²¼şÉè±¸, ²¢ÇÒÔÚÊä³ö»º³åÖĞµÄ¿Õ¼ä±ä¿ÕÏĞ, Õâ¸ö½ø³Ì±»»½ĞÑ²¢ÇÒĞ´µ÷ÓÃ³É¹¦, ¾¡¹ÜÊı¾İ¿ÉÄÜÖ»±»²¿·ÖĞ´ÈëÈç¹ûÔÚ»º³åÖ»Ã»ÓĞ¿Õ¼ä¸ø±»ÇëÇóµÄ count ×Ö½Ú.</p></li>
</ul></div>
<p>Õâ 2 ¾ä¶¼¼Ù¶¨ÓĞÊäÈëºÍÊä³ö»º³å; Êµ¼ÊÉÏ, ¼¸ºõÃ¿¸öÉè±¸Çı¶¯¶¼ÓĞ. ÒªÇóÓĞÊäÈë»º³åÊÇÎªÁË±ÜÃâ¶ªÊ§µ½´ïµÄÊı¾İ, µ±ÎŞÈËÔÚ¶ÁÊ±. Ïà·´, Êı¾İÔÚĞ´Ê±²»ÄÜ¶ªÊ§, ÒòÎªÈç¹ûÏµÍ³µ÷ÓÃ²»ÄÜ½ÓÊÕÊı¾İ×Ö½Ú, ËüÃÇ±£ÁôÔÚÓÃ»§¿Õ¼ä»º³å. ¼´±ãÈç´Ë, Êä³ö»º³å¼¸ºõÒ»Ö±ÓĞÓÃ, ¶ÔÓÚ´ÓÓ²¼ş¼·³ö¸ü¶àµÄĞÔÄÜ.</p>
<p>ÔÚÇı¶¯ÖĞÊµÏÖÊä³ö»º³åËù»ñµÃµÄĞÔÄÜÀ´×Ô¼õÉÙÁËÉÏÏÂÎÄÇĞ»»ºÍÓÃ»§¼¶/ÄÚºË¼¶ÇĞ»»µÄ´ÎÊı. Ã»ÓĞÒ»¸öÊä³ö»º³å(¼Ù¶¨Ò»¸öÂıËÙÉè±¸), Ã¿´ÎÏµÍ³µ÷ÓÃ½ÓÊÕÕâÑùÒ»¸ö»ò¼¸¸ö×Ö·û, ²¢ÇÒµ±Ò»¸ö½ø³ÌÔÚ write ÖĞË¯Ãß, ÁíÒ»¸ö½ø³ÌÔËĞĞ(ÄÇÊÇÒ»´ÎÉÏÏÂÎÄÇĞ»»). µ±µÚÒ»¸ö½ø³Ì±»»½ĞÑ, Ëü»Ö¸´(ÁíÒ»´ÎÉÏÏÂÎÄÇĞ»»), Ğ´·µ»Ø(ÄÚºË/ÓÃ»§×ª»»), ²¢ÇÒÕâ¸ö½ø³ÌÖØĞÂ·¢³öÏµÍ³µ÷ÓÃÀ´Ğ´Èë¸ü¶àµÄÊı¾İ(ÓÃ»§/ÄÚºË×ª»»); Õâ¸öµ÷ÓÃ×èÈû²¢ÇÒÑ­»·¼ÌĞø. Ôö¼ÓÒ»¸öÊä³ö»º³å¿ÉÔÊĞíÇı¶¯ÔÚÃ¿¸öĞ´µ÷ÓÃÖĞ½ÓÊÕ´óµÄÊı¾İ¿é, ĞÔÄÜÉÏÓĞÏàÓ¦µÄÌá¸ß. Èç¹ûÕâ¸ö»º³å×ã¹»´ó, Ğ´µ÷ÓÃÔÚµÚÒ»´Î³¢ÊÔ¾Í³É¹¦ -- ±»»º³åµÄÊı¾İÖ®ºó½«±»ÍÆµ½Éè±¸ -- ²»±Ø¿ØÖÆĞèÒª·µ»ØÓÃ»§¿Õ¼äÀ´µÚ¶ş´Î»òÕßµÚÈı´ÎĞ´µ÷ÓÃ. Ñ¡ÔñÒ»¸öºÏÊÊµÄÖµ¸øÊä³ö»º³åÏÔÈ»ÊÇÉè±¸ÌØ¶¨µÄ.</p>
<p>ÎÒÃÇ²»Ê¹ÓÃÒ»¸öÊäÈë»º³åÔÚ scullÖĞ, ÒòÎªÊı¾İµ±·¢³ö read Ê±ÒÑ¾­¿ÉÓÃ. ÀàËÆµÄ, ²»ÓÃÊä³ö»º³å, ÒòÎªÊı¾İ±»¼òµ¥µØ¿½±´µ½ºÍÉè±¸¹ØÁªµÄÄÚ´æÇø. ±¾ÖÊÉÏ, Õâ¸öÉè±¸ÊÇÒ»¸ö»º³å, Òò´Ë¶îÍâ»º³åµÄÊµÏÖ¿ÉÄÜÊÇ¶àÓàµÄ. ÎÒÃÇ½«ÔÚµÚ 10 ÕÂ¼ûµ½»º³åµÄÊ¹ÓÃ.</p>
<p>Èç¹ûÖ¸¶¨ O_NONBLOCK,  read ºÍ write µÄĞĞÎªÊÇ²»Í¬µÄ. ÔÚÕâ¸öÇé¿öÏÂ, Õâ¸öµ÷ÓÃ¼òµ¥µØ·µ»Ø -EAGAIN(("try it agin")Èç¹ûÒ»¸ö½ø³Ìµ±Ã»ÓĞÊı¾İ¿ÉÓÃÊ±µ÷ÓÃ read , »òÕßÈç¹ûµ±»º³åÖĞÃ»ÓĞ¿Õ¼äÊ±Ëüµ÷ÓÃ write .</p>
<p>ÈçÄã¿ÉÄÜÆÚÍûµÄ, ·Ç×èÈû²Ù×÷Á¢¿Ì·µ»Ø, ÔÊĞíÕâ¸öÓ¦ÓÃ³ÌĞòÂÖÑ¯Êı¾İ. Ó¦ÓÃ³ÌĞòµ±Ê¹ÓÃ stdio º¯Êı´¦Àí·Ç×èÈûÎÄ¼şÖĞ, ±ØĞëĞ¡ĞÄ, ÒòÎªËüÃÇÈİÒ×¸ã´íÒ»¸öµÄ·Ç×èÈû·µ»ØÎª EOF. ËüÃÇÊ¼ÖÕ±ØĞë¼ì²é errno.</p>
<p>×ÔÈ»µØ, O_NONBLOCK Ò²ÔÚ open ·½·¨ÖĞÓĞÒâÒå. Õâ¸ö·¢ÉúÔÚµ±Õâ¸öµ÷ÓÃÕæÕı×èÈû³¤Ê±¼äÊ±; ÀıÈç, µ±´ò¿ª(Îª¶Á´æÈ¡)Ò»¸ö Ã»ÓĞĞ´ÕßµÄ(ÉĞÎŞ)FIFO, »òÕß´æÈ¡Ò»¸ö´ÅÅÌÎÄ¼şÊ¹ÓÃÒ»¸öĞü¹ÒËø. ³£³£µØ, ´ò¿ªÒ»¸öÉè±¸»òÕß³É¹¦»òÕßÊ§°Ü, Ã»ÓĞ±ØÒªµÈ´ıÍâ²¿µÄÊÂ¼ş. ÓĞÊ±, µ«ÊÇ, ´ò¿ªÕâ¸öÉè±¸ĞèÒªÒ»¸ö³¤µÄ³õÊ¼»¯, ²¢ÇÒÄã¿ÉÄÜÑ¡ÔñÔÚÄãµÄ open ·½·¨ÖĞÖ§³Ö O_NONBLOCK , Í¨¹ıÁ¢¿Ì·µ»Ø -EAGAIN,Èç¹ûÕâ¸ö±êÖ¾±»ÉèÖÃ. ÔÚ¿ªÊ¼Õâ¸öÉè±¸µÄ³õÊ¼»¯½ø³ÌÖ®ºó. Õâ¸öÇı¶¯¿ÉÄÜ»¹ÊµÏÖÒ»¸ö×èÈû open À´Ö§³Ö´æÈ¡²ßÂÔ, Í¨¹ıÀàËÆÓÚÎÄ¼şËøµÄ·½Ê½. ÎÒÃÇ½«¼ûµ½ÕâÑùÒ»¸öÊµÏÖÔÚ"×èÈû open ×÷Îª¶Ô EBUSY µÄÌæ´ú"Ò»½Ú, ÔÚ±¾ÕÂºóÃæ.</p>
<p>Ò»Ğ©Çı¶¯¿ÉÄÜ»¹ÊµÏÖÌØ±ğµÄÓïÒå¸ø O_NONBLOCK; ÀıÈç, Ò»¸ö´Å´øÉè±¸µÄ open ³£³£×èÈûÖ±µ½²åÈëÒ»¸ö´Å´ø. Èç¹ûÕâ¸ö´Å´øÇı¶¯Æ÷Ê¹ÓÃ O_NONBLOCK ´ò¿ª, Õâ¸ö open Á¢¿Ì³É¹¦, ²»¹ÜÊÇ·ñ½éÖÊÔÚ»ò²»ÔÚ.</p>
<p>Ö»ÓĞ read, write, ºÍ open ÎÄ¼ş²Ù×÷ÊÜµ½·Ç×èÈû±êÖ¾Ó°Ïì.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="ABlockingIOExample.sect2"></a>6.2.4.&#160;Ò»¸ö×èÈû I/O µÄÀı×Ó</h3></div></div></div>
<p>×îºó, ÎÒÃÇ¿´Ò»¸öÊµÏÖÁË×èÈû I/O µÄÕæÊµÇı¶¯·½·¨µÄÀı×Ó. Õâ¸öÀı×ÓÀ´×Ô scullpipe Çı¶¯; ËüÊÇ scull µÄÒ»¸öÌØÊâĞÎÊ½, ÊµÏÖÁËÒ»¸öÏó¹ÜµÀµÄÉè±¸.</p>
<p>ÔÚÇı¶¯ÖĞ, Ò»¸ö×èÈûÔÚ¶Áµ÷ÓÃÉÏµÄ½ø³Ì±»»½ĞÑ, µ±Êı¾İµ½´ïÊ±; ³£³£µØÓ²¼ş·¢³öÒ»¸öÖĞ¶ÏÀ´Ö¸Ê¾ÕâÑùÒ»¸öÊÂ¼ş, ²¢ÇÒÇı¶¯»½ĞÑµÈ´ıµÄ½ø³Ì×÷Îª´¦ÀíÕâ¸öÖĞ¶ÏµÄÒ»²¿·Ö. scullpipe Çı¶¯²»Í¬, ÒÔÖÁÓÚËü¿ÉÔËĞĞ¶ø²»ĞèÒªÈÎºÎÌØÊâµÄÓ²¼ş»òÕßÒ»¸öÖĞ¶Ï´¦Àí. ÎÒÃÇÑ¡ÔñÀ´Ê¹ÓÃÁíÒ»¸ö½ø³ÌÀ´²úÉúÊı¾İ²¢»½ĞÑ¶Á½ø³Ì; ÀàËÆµØ, ¶Á½ø³Ì±»ÓÃÀ´»½ĞÑÕıÔÚµÈ´ı»º³å¿Õ¼ä¿ÉÓÃµÄĞ´Õß½ø³Ì.</p>
<p>Õâ¸öÉè±¸Çı¶¯Ê¹ÓÃÒ»¸öÉè±¸½á¹¹, Ëü°üº¬ 2 ¸öµÈ´ı¶ÓÁĞºÍÒ»¸ö»º³å. »º³å´óĞ¡ÊÇÒÔ³£ÓÃµÄ·½·¨¿ÉÅäÖÃµÄ(ÔÚ±àÒëÊ±¼ä, ¼ÓÔØÊ±¼ä, »òÕßÔËĞĞÊ±¼ä).</p>
<pre class="programlisting">
struct scull_pipe
{
        wait_queue_head_t inq, outq; /* read and write queues */
        char *buffer, *end; /* begin of buf, end of buf */
        int buffersize; /* used in pointer arithmetic */
        char *rp, *wp; /* where to read, where to write */
        int nreaders, nwriters; /* number of openings for r/w */
        struct fasync_struct *async_queue; /* asynchronous readers */
        struct semaphore sem;  /* mutual exclusion semaphore */
        struct cdev cdev;  /* Char device structure */
};
</pre>
<p>¶ÁÊµÏÖ¼È¹ÜÀí×èÈûÒ²¹ÜÀí·Ç×èÈûÊäÈë, ¿´À´Èç´Ë:</p>
<pre class="programlisting">
static ssize_t scull_p_read (struct file *filp, char __user *buf, size_t count, loff_t *f_pos)
{
        struct scull_pipe *dev = filp-&gt;private_data;
        if (down_interruptible(&amp;dev-&gt;sem))
                return -ERESTARTSYS;

        while (dev-&gt;rp == dev-&gt;wp)
        { /* nothing to read */
                up(&amp;dev-&gt;sem); /* release the lock */
                if (filp-&gt;f_flags &amp; O_NONBLOCK)

                        return -EAGAIN;
                PDEBUG("\"%s\" reading: going to sleep\n", current-&gt;comm);
                if (wait_event_interruptible(dev-&gt;inq, (dev-&gt;rp != dev-&gt;wp)))
                        return -ERESTARTSYS; /* signal: tell the fs layer to handle it */ /* otherwise loop, but first reacquire the lock */
                if (down_interruptible(&amp;dev-&gt;sem))
                        return -ERESTARTSYS;
        }
        /* ok, data is there, return something */

        if (dev-&gt;wp &gt; dev-&gt;rp)
                count = min(count, (size_t)(dev-&gt;wp - dev-&gt;rp));
        else /* the write pointer has wrapped, return data up to dev-&gt;end */
                count = min(count, (size_t)(dev-&gt;end - dev-&gt;rp));
        if (copy_to_user(buf, dev-&gt;rp, count))
        {
                up (&amp;dev-&gt;sem);
                return -EFAULT;
        }
        dev-&gt;rp += count;
        if (dev-&gt;rp == dev-&gt;end)

                dev-&gt;rp = dev-&gt;buffer; /* wrapped */
        up (&amp;dev-&gt;sem);

        /* finally, awake any writers and return */
        wake_up_interruptible(&amp;dev-&gt;outq);
        PDEBUG("\"%s\" did read %li bytes\n",current-&gt;comm, (long)count);
        return count;
}
</pre>
<p>ÈçÍ¬Äã¿É¼ûµÄ, ÎÒÃÇÔÚ´úÂëÖĞÁôÓĞÒ»Ğ© PDEBUG Óï¾ä. µ±Äã±àÒëÕâ¸öÇı¶¯, Äã¿ÉÊ¹ÄÜÏûÏ¢»úÖÆÀ´Ò×ÓÚ¸úËæ²»Í¬½ø³Ì¼äµÄ½»»¥.</p>
<p>ÈÃÎÒÃÇ×ĞÏ¸¿´¿´ scull_p_read ÈçºÎ´¦Àí¶ÔÊı¾İµÄµÈ´ı. Õâ¸ö while Ñ­»·ÔÚ³ÖÓĞÉè±¸Æì±êÏÂ²âÊÔÕâ¸ö»º³å. Èç¹ûÓĞÊı¾İÔÚÄÇÀï, ÎÒÃÇÖªµÀÎÒÃÇ¿ÉÁ¢¿Ì·µ»Ø¸øÓÃ»§, ²»±ØË¯Ãß, Òò´ËÕû¸öÑ­»·±»Ìø¹ı. Ïà·´, Èç¹ûÕâ¸ö»º³åÊÇ¿ÕµÄ, ÎÒÃÇ±ØĞëË¯Ãß. µ«ÊÇÔÚÎÒÃÇ¿É×öÕâ¸öÖ®Ç°, ÎÒÃÇ±ØĞë¶ªµôÉè±¸Æì±ê; Èç¹ûÎÒÃÇÒª³ÖÓĞËü¶øË¯Ãß, ¾Í²»»áÓĞĞ´ÕßÓĞ»ú»á»½ĞÑÎÒÃÇ. Ò»µ©Õâ¸öÈ·±£±»¶ªµô, ÎÒÃÇ×öÒ»¸ö¿ìËÙ¼ì²éÀ´¿´ÊÇ·ñÓÃ»§ÒÑÇëÇó·Ç×èÈû I/O, ²¢ÇÒÈç¹ûÊÇÕâÑù¾Í·µ»Ø. ·ñÔò, ÊÇÊ±¼äµ÷ÓÃ wait_event_interruptible.</p>
<p>Ò»µ©ÎÒÃÇ¹ıÁËÕâ¸öµ÷ÓÃ, Ä³Ğ©¶«¶«ÒÑ¾­»½ĞÑÁËÎÒÃÇ, µ«ÊÇÎÒÃÇ²»ÖªµÀÊÇÊ²Ã´. Ò»¸ö¿ÉÄÜÊÇ½ø³Ì½ÓÊÕµ½ÁËÒ»¸öĞÅºÅ. °üº¬ wait_event_interruptible µ÷ÓÃµÄÕâ¸ö if Óï¾ä¼ì²éÕâÖÖÇé¿ö. Õâ¸öÓï¾ä±£Ö¤ÁËÕıÈ·µÄºÍ±»ÆÚÍûµÄ¶ÔĞÅºÅµÄ·´Ó¦, Ëü¿ÉÄÜ¸ºÔğ»½ĞÑÕâ¸ö½ø³Ì(ÒòÎªÎÒÃÇ´¦ÓÚÒ»¸ö¿ÉÖĞ¶ÏµÄË¯Ãß). Èç¹ûÒ»¸öĞÅºÅÒÑ¾­µ½´ï²¢ÇÒËüÃ»ÓĞ±»Õâ¸ö½ø³Ì×èÈû, ÕıÈ·µÄ×ö·¨ÊÇÈÃÄÚºËµÄÉÏ²ã´¦ÀíÕâ¸öÊÂ¼ş. µ½´Ë, Õâ¸öÇı¶¯·µ»Ø -ERESTARTSYS µ½µ÷ÓÃÕß; Õâ¸öÖµ±»ĞéÄâÎÄ¼şÏµÍ³(VFS)ÔÚÄÚ²¿Ê¹ÓÃ, Ëü»òÕßÖØÆôÏµÍ³µ÷ÓÃ»òÕß·µ»Ø -EINTR ¸øÓÃ»§¿Õ¼ä. ÎÒÃÇÊ¹ÓÃÏàÍ¬ÀàĞÍµÄ¼ì²éÀ´´¦ÀíĞÅºÅ, ¸øÃ¿¸ö¶ÁºÍĞ´ÊµÏÖ.</p>
<p>µ«ÊÇ, ¼´±ãÃ»ÓĞÒ»¸öĞÅºÅ, ÎÒÃÇ»¹ÊÇ²»È·ÇĞÖªµÀÓĞÊı¾İÔÚÄÇÀïÎª»ñÈ¡. ÆäËûÈËÒ²¿ÉÄÜÒÑ¾­ÔÚµÈ´ıÊı¾İ, ²¢ÇÒËüÃÇ¿ÉÄÜÓ®µÃ¾ºÕù²¢ÇÒÊ×ÏÈµÃµ½Êı¾İ. Òò´ËÎÒÃÇ±ØĞëÔÙ´Î»ñÈ¡Éè±¸Æì±ê; Ö»ÓĞÕâÊ±ÎÒÃÇ²Å¿ÉÒÔ²âÊÔ¶Á»º³å(ÔÚ while Ñ­»·ÖĞ)²¢ÇÒÕæÕıÖªµÀÎÒÃÇ¿ÉÒÔ·µ»Ø»º³åÖĞµÄÊı¾İ¸øÓÃ»§. È«²¿Õâ¸ö´úÂëµÄ×îÖÕ½á¹ûÊÇ, µ±ÎÒÃÇ´Ó while Ñ­»·ÖĞÍË³öÊ±, ÎÒÃÇÖªµÀÆì±ê±»»ñµÃ²¢ÇÒ»º³åÖĞÓĞÊı¾İÎÒÃÇ¿ÉÒÔÓÃ.</p>
<p>½ö½öÎªÁËÍêÕû, ÎÒÃÇÒª×¢Òâ, scull_p_read ¿ÉÒÔÔÚÁíÒ»¸öµØ·½Ë¯Ãß, ÔÚÎÒÃÇ»ñµÃÉè±¸Æì±êÖ®ºó: ¶Ô copy_to_user µÄµ÷ÓÃ. Èç¹û scull µ±ÔÚÄÚºËºÍÓÃ»§¿Õ¼äÖ®¼ä¿½±´Êı¾İÊ±Ë¯Ãß, ËüÔÚ³ÖÓĞÉè±¸Æì±êÖĞË¯Ãß. ÔÚÕâÖÖÇé¿öÏÂ³ÖÓĞÆì±êÊÇºÏÀíµÄÒòÎªËü²»ÄÜËÀËøÏµÍ³(ÎÒÃÇÖªµÀÄÚºË½«½øĞĞ¿½±´µ½ÓÃ»§¿Õ¼ä²¢ÇÒÔÚ²»¼ÓËø½ø³ÌÖĞµÄÍ¬Ò»¸öÆì±êÏÂ»½ĞÑÎÒÃÇ), ²¢ÇÒÒòÎªÖØÒªµÄÊÇÉè±¸ÄÚ´æÊı×éÔÚÇı¶¯Ë¯ÃßÊ±²»¸Ä±ä.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="AdvancedSleeping.sect2"></a>6.2.5.&#160;¸ß¼¶Ë¯Ãß</h3></div></div></div>
<p>Ğí¶àÇı¶¯ÄÜ¹»Âú×ãËüÃÇµÄË¯ÃßÒªÇó, Ê¹ÓÃÖÁ½ñÎÒÃÇÒÑÉæ¼°µ½µÄº¯Êı. µ«ÊÇ, ÓĞÊ±ĞèÒªÉîÈëÀí½â Linux µÈ´ı¶ÓÁĞ»úÖÆÈçºÎ¹¤×÷. ¸´ÔÓµÄ¼ÓËø»òÕßĞÔÄÜĞèÒª¿ÉÇ¿ÖÆÒ»¸öÇı¶¯À´Ê¹ÓÃµÍ²ãº¯ÊıÀ´Ó°ÏìÒ»¸öË¯Ãß. ÔÚ±¾½Ú, ÎÒÃÇÔÚµÍ²ã¿´¶øÀí½âÔÚÒ»¸ö½ø³ÌË¯ÃßÊ±·¢ÉúÁËÊ²Ã´.</p>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="Howaprocesssleeps.sect3"></a>6.2.5.1.&#160;Ò»¸ö½ø³ÌÈçºÎË¯Ãß</h4></div></div></div>
<p>Èç¹ûÎÒÃÇÉîÈë &lt;linux/wait.h&gt;, Äã¼ûµ½ÔÚ wait_queue_head_t ÀàĞÍºóÃæµÄÊı¾İ½á¹¹ÊÇ·Ç³£¼òµ¥µÄ; Ëü°üº¬Ò»¸ö×ÔĞıËøºÍÒ»¸öÁ´±í. Õâ¸öÁ´±íÊÇÒ»¸öµÈ´ı¶ÓÁĞÈë¿Ú, Ëü±»ÉùÃ÷×ö wait_queue_t. Õâ¸ö½á¹¹°üº¬¹ØÓÚË¯Ãß½ø³ÌµÄĞÅÏ¢ºÍËüÏëÔõÑù±»»½ĞÑ.</p>
<p>Ê¹Ò»¸ö½ø³ÌË¯ÃßµÄµÚÒ»²½³£³£ÊÇ·ÖÅäºÍ³õÊ¼»¯Ò»¸ö wait_queue_t ½á¹¹, Ëæºó½«ÆäÌí¼Óµ½ÕıÈ·µÄµÈ´ı¶ÓÁĞ. µ±ËùÓĞ¶«Î÷¶¼¾ÍÎ»ÁË, ¸ºÔğ»½ĞÑ¹¤×÷µÄÈË¾Í¿ÉÒÔÕÒµ½ÕıÈ·µÄ½ø³Ì.</p>
<p>ÏÂÒ»²½ÊÇÉèÖÃ½ø³ÌµÄ×´Ì¬À´±êÖ¾ËüÎªË¯Ãß. ÔÚ &lt;linux/sched.h&gt; ÖĞ¶¨ÒåÓĞ¼¸¸öÈÎÎñ×´Ì¬. TASK_RUNNING ÒâË¼ÊÇ½ø³ÌÄÜ¹»ÔËĞĞ, ¾¡¹Ü²»±ØÔÚÈÎºÎÌØ¶¨µÄÊ±¿ÌÔÚ´¦ÀíÆ÷ÉÏÔËĞĞ. ÓĞ 2 ¸ö×´Ì¬Ö¸Ê¾Ò»¸ö½ø³ÌÊÇÔÚË¯Ãß: TASK_INTERRUPTIBLE ºÍ TASK_UNTINTERRUPTIBLE; µ±È», ËüÃÇ¶ÔÓ¦ 2 ÀàµÄË¯Ãß. ÆäËûµÄ×´Ì¬Õı³£µØºÍÇı¶¯±àĞ´ÕßÎŞ¹Ø.</p>
<p>ÔÚ 2.6 ÄÚºË, ¶ÔÓÚÇı¶¯´úÂëÍ¨³£²»ĞèÒªÖ±½Ó²Ù×÷½ø³Ì×´Ì¬. µ«ÊÇ, Èç¹ûÄãĞèÒªÕâÑù×ö, Ê¹ÓÃµÄ´úÂëÊÇ:</p>
<pre class="programlisting">
void set_current_state(int new_state); 
</pre>
<p>ÔÚÀÏµÄ´úÂëÖĞ, Äã³£³£¼ûµ½Èç´ËµÄ¶«Î÷:</p>
<pre class="programlisting">
current-&gt;state = TASK_INTERRUPTIBLE; 
</pre>
<p>µ«ÊÇÏóÕâÑùÖ±½Ó¸Ä±ä current ÊÇ²»¹ÄÀøµÄ; µ±Êı¾İ½á¹¹¸Ä±äÊ±ÕâÑùµÄ´úÂë»áÇáÒ×µØÊ§Ğ§. µ«ÊÇ, ÉÏÃæµÄ´úÂëÈ·ÊµÕ¹Ê¾ÁË×Ô¼º¸Ä±äÒ»¸ö½ø³ÌµÄµ±Ç°×´Ì¬²»ÄÜÊ¹ÆäË¯Ãß. Í¨¹ı¸Ä±ä current ×´Ì¬, ÄãÒÑ¸Ä±äÁËµ÷¶ÈÆ÷¶Ô´ı½ø³ÌµÄ·½Ê½, µ«ÊÇÄã»¹Î´ÈÃ³ö´¦ÀíÆ÷.</p>
<p>·ÅÆú´¦ÀíÆ÷ÊÇ×îºóÒ»²½, µ«ÊÇÒªÊ×ÏÈ×öÒ»¼şÊÂ: Äã±ØĞëÏÈ¼ì²éÄãÔÚË¯ÃßµÄÌõ¼ş. ×öÕâ¸ö¼ì²éÊ§°Ü»áÒıÈëÒ»¸ö¾ºÕùÌõ¼ş; Èç¹ûÔÚÄãÃ¦ÓÚÉÏÃæµÄÕâ¸ö¹ı³Ì²¢ÇÒÓĞÆäËûµÄÏß³Ì¸Õ¸ÕÊÔÍ¼»½ĞÑÄã, Èç¹ûÕâ¸öÌõ¼ş±äÎªÕæ»á·¢ÉúÊ²Ã´? Äã¿ÉÄÜ´í¹ı»½ĞÑ²¢ÇÒË¯Ãß³¬¹ıÄãÔ¤ÏëµÄÊ±¼ä. Òò´Ë, ÔÚË¯ÃßµÄ´úÂëÏÂÃæ, µäĞÍµØÄã»á¼ûµ½ÏÂÃæµÄ´úÂë:</p>
<pre class="programlisting">
if (!condition)
    schedule();
</pre>
<p>Í¨¹ıÔÚÉèÖÃÁË½ø³Ì×´Ì¬ºó¼ì²éÎÒÃÇµÄÌõ¼ş, ÎÒÃÇº­¸ÇÁËËùÓĞµÄ¿ÉÄÜµÄÊÂ¼ş½øÕ¹. Èç¹ûÎÒÃÇÔÚµÈ´ıµÄÌõ¼şÒÑ¾­ÔÚÉèÖÃ½ø³Ì×´Ì¬Ö®Ç°µ½À´, ÎÒÃÇÔÚÕâ¸ö¼ì²éÖĞ×¢Òâµ½²¢ÇÒ²»ÕæÕıµØË¯Ãß. Èç¹ûÖ®ºó·¢ÉúÁË»½ĞÑ, ½ø³Ì±»ÖÃÎª¿ÉÔËĞĞµÄ²»¹ÜÊÇ·ñÎÒÃÇÒÑÕæÕı½øÈëË¯Ãß.</p>
<p>µ÷ÓÃ schedule , µ±È», ÊÇÒıÓÃµ÷¶ÈÆ÷ºÍÈÃ³ö CPU µÄ·½Ê½. ÎŞÂÛºÎÊ±Äãµ÷ÓÃÕâ¸öº¯Êı, ÄãÊÇÔÚ¸æËßÄÚºËÀ´¿¼ÂÇÓ¦µ±ÔËĞĞÄÄ¸ö½ø³Ì²¢ÇÒ×ª»»¿ØÖÆµ½ÄÇ¸ö½ø³Ì, Èç¹û±ØÒª. Òò´ËÄã´Ó²»ÖªµÀÔÚ schedule ·µ»Øµ½ÄãµÄ´úÂë»áÊÇ¶à³¤Ê±¼ä.</p>
<p>ÔÚ if ²âÊÔºÍ¿ÉÄÜµÄµ÷ÓÃ schedule (²¢´ÓÆä·µ»Ø)Ö®ºó, ÓĞĞ©ÇåÀí¹¤×÷Òª×ö. ÒòÎªÕâ¸ö´úÂë²»ÔÙÏëË¯Ãß, Ëü±ØĞë±£Ö¤ÈÎÎñ×´Ì¬±»ÖØÖÃÎª TASK_RUNNING. Èç¹û´úÂëÖ»ÊÇ´Ó schedule ·µ»Ø, ÕâÒ»²½ÊÇ²»±ØÒªµÄ; ÄÇ¸öº¯Êı²»»á·µ»ØÖ±µ½½ø³Ì´¦ÓÚ¿ÉÔËĞĞÌ¬. Èç¹ûÓÉÓÚ²»ÔÙĞèÒªË¯Ãß¶ø¶Ô schedule µÄµ÷ÓÃ±»Ìø¹ı, ½ø³Ì×´Ì¬½«²»ÕıÈ·. »¹ÓĞ±ØÒª´ÓµÈ´ı¶ÓÁĞÖĞÈ¥³ıÕâ¸ö½ø³Ì, ·ñÔòËü¿ÉÄÜ±»¶à´Î»½ĞÑ.</p>
</div>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="Manualsleeps.sect3"></a>6.2.5.2.&#160;ÊÖ¶¯Ë¯Ãß</h4></div></div></div>
<p>ÔÚ Linux ÄÚºËµÄÖ®Ç°µÄ°æ±¾, ÕıÊ½µÄË¯ÃßÒªÇó³ÌĞòÔ±ÊÖ¶¯´¦ÀíËùÓĞÉÏÃæµÄ²½Öè. ËüÊÇÒ»¸ö·±ËöµÄ¹ı³Ì, °üº¬Ïàµ±¶àµÄÒ×³ö´íµÄÑù°åÊ½µÄ´úÂë. ³ÌĞòÔ±Èç¹ûÔ¸Òâ»¹ÊÇ¿ÉÄÜÓÃÄÇÖÖ·½Ê½ÊÖ¶¯Ë¯Ãß; &lt;linux/sched.h&gt; °üº¬ÁËËùÓĞĞèÒªµÄ¶¨Òå, ÒÔ¼°Î§ÈÆÀı×ÓµÄÄÚºËÔ´Âë. µ«ÊÇ, ÓĞÒ»¸ö¸üÈİÒ×µÄ·½Ê½.</p>
<p>µÚÒ»²½ÊÇ´´½¨ºÍ³õÊ¼»¯Ò»¸öµÈ´ı¶ÓÁĞ. Õâ³£³£ÓÉÕâ¸öºê¶¨ÒåÍê³É:</p>
<pre class="programlisting">
DEFINE_WAIT(my_wait); 
</pre>
<p>ÆäÖĞ, name ÊÇµÈ´ı¶ÓÁĞÈë¿ÚÏîµÄÃû×Ó. Äã¿ÉÓÃ 2 ²½À´×ö:</p>
<pre class="programlisting">
wait_queue_t my_wait;
init_wait(&amp;my_wait);
</pre>
<p>µ«ÊÇ³£³£¸üÈİÒ×µÄ×ö·¨ÊÇ·ÅÒ»¸ö DEFINE_WAIT ĞĞÔÚÑ­»·µÄ¶¥²¿, À´ÊµÏÖÄãµÄË¯Ãß.</p>
<p>ÏÂÒ»²½ÊÇÌí¼ÓÄãµÄµÈ´ı¶ÓÁĞÈë¿Úµ½¶ÓÁĞ, ²¢ÇÒÉèÖÃ½ø³Ì×´Ì¬. 2 ¸öÈÎÎñ¶¼ÓÉÕâ¸öº¯Êı´¦Àí:</p>
<pre class="programlisting">
void prepare_to_wait(wait_queue_head_t *queue, wait_queue_t *wait, int state); 
</pre>
<p>ÕâÀï, queue ºÍ wait ·Ö±ğµØÊÇµÈ´ı¶ÓÁĞÍ·ºÍ½ø³ÌÈë¿Ú. state ÊÇ½ø³ÌµÄĞÂ×´Ì¬; ËüÓ¦µ±»òÕßÊÇ TASK_INTERRUPTIBLE(¸ø¿ÉÖĞ¶ÏµÄË¯Ãß, Õâ³£³£ÊÇÄãËùÒªµÄ)»òÕß TASK_UNINTERRUPTIBLE(¸ø²»¿ÉÖĞ¶ÏË¯Ãß).</p>
<p>ÔÚµ÷ÓÃ prepare_to_wait Ö®ºó, ½ø³Ì¿Éµ÷ÓÃ schedule -- ÔÚËüÒÑ¼ì²éÈ·ÈÏËüÈÔÈ»ĞèÒªµÈ´ıÖ®ºó. Ò»µ© schedule ·µ»Ø, ¾Íµ½ÁËÇåÀíÊ±¼ä. Õâ¸öÈÎÎñ, Ò², ±»Ò»¸öÌØÊâµÄº¯Êı´¦Àí:</p>
<pre class="programlisting">
void finish_wait(wait_queue_head_t *queue, wait_queue_t *wait); 
</pre>
<p>Ö®ºó, ÄãµÄ´úÂë¿É²âÊÔËüµÄ×´Ì¬²¢ÇÒ¿´ÊÇ·ñËüĞèÒªÔÙ´ÎµÈ´ı.</p>
<p>ÎÒÃÇÔç¸ÃĞèÒªÒ»¸öÀı×ÓÁË. Ö®Ç°ÎÒÃÇ¿´ÁË ¸ø scullpipe µÄ read ·½·¨, ËüÊ¹ÓÃ wait_event. Í¬Ò»¸öÇı¶¯ÖĞµÄ write ·½·¨Ê¹ÓÃ prepare_to_wait ºÍ finish_wait À´ÊµÏÖËüµÄµÈ´ı. Õı³£µØ, Äã²»»áÔÚÒ»¸öÇı¶¯ÖĞÏóÕâÑù»ìÓÃ¸÷ÖÖ·½·¨, µ«ÊÇÎÒÃÇÕâÑù×÷ÊÇÎªÁËÄÜ¹»Õ¹Ê¾ 2 ÖÖ´¦ÀíË¯ÃßµÄ·½Ê½.</p>
<p>ÎªÍêÕûÆğ¼û, Ê×ÏÈ, ÎÒÃÇ¿´ write ·½·¨±¾Éí:</p>
<pre class="programlisting">
/* How much space is free? */
static int spacefree(struct scull_pipe *dev)
{

        if (dev-&gt;rp == dev-&gt;wp)
                return dev-&gt;buffersize - 1;
        return ((dev-&gt;rp + dev-&gt;buffersize - dev-&gt;wp) % dev-&gt;buffersize) - 1;
}

static ssize_t scull_p_write(struct file *filp, const char __user *buf, size_t count,
                             loff_t *f_pos)
{

        struct scull_pipe *dev = filp-&gt;private_data;
        int result;
        if (down_interruptible(&amp;dev-&gt;sem))
                return -ERESTARTSYS;

        /* Make sure there's space to write */
        result = scull_getwritespace(dev, filp);
        if (result)
                return result; /* scull_getwritespace called up(&amp;dev-&gt;sem) */
        /* ok, space is there, accept something */
        count = min(count, (size_t)spacefree(dev));
        if (dev-&gt;wp &gt;= dev-&gt;rp)
                count = min(count, (size_t)(dev-&gt;end - dev-&gt;wp)); /* to end-of-buf */
        else /* the write pointer has wrapped, fill up to rp-1 */
                count = min(count, (size_t)(dev-&gt;rp - dev-&gt;wp - 1));
        PDEBUG("Going to accept %li bytes to %p from %p\n", (long)count, dev-&gt;wp, buf);
        if (copy_from_user(dev-&gt;wp, buf, count))
        {
                up (&amp;dev-&gt;sem);
                return -EFAULT;
        }
        dev-&gt;wp += count;
        if (dev-&gt;wp == dev-&gt;end)
                dev-&gt;wp = dev-&gt;buffer; /* wrapped */
        up(&amp;dev-&gt;sem);

        /* finally, awake any reader */
        wake_up_interruptible(&amp;dev-&gt;inq); /* blocked in read() and select() */

        /* and signal asynchronous readers, explained late in chapter 5 */
        if (dev-&gt;async_queue)
                kill_fasync(&amp;dev-&gt;async_queue, SIGIO, POLL_IN);
        PDEBUG("\"%s\" did write %li bytes\n",current-&gt;comm, (long)count);
        return count;
}
</pre>
<p>Õâ¸ö´úÂë¿´À´ºÍ read ·½·¨ÀàËÆ, ³ıÁËÎÒÃÇÒÑ¾­½«Ë¯Ãß´úÂë·Åµ½ÁËÒ»¸öµ¥¶ÀµÄº¯Êı, ³ÆÎª scull_getwritespace. ËüµÄ¹¤×÷ÊÇÈ·±£ÔÚ»º³åÖĞÓĞ¿Õ¼ä¸øĞÂµÄÊı¾İ, Ë¯ÃßÖ±µ½ÓĞ¿Õ¼ä¿ÉÓÃ. Ò»µ©¿Õ¼äÔÚ, scull_p_write ¿É¼òµ¥µØ¿½±´ÓÃ»§µÄÊı¾İµ½ÄÇÀï, µ÷ÕûÖ¸Õë, ²¢ÇÒ»½ĞÑ¿ÉÄÜÒÑ¾­ÔÚµÈ´ı¶ÁÈ¡Êı¾İµÄ½ø³Ì.</p>
<p>´¦ÀíÊµ¼ÊµÄË¯ÃßµÄ´úÂëÊÇ:</p>
<pre class="programlisting">
/* Wait for space for writing; caller must hold device semaphore. On
 * error the semaphore will be released before returning. */
static int scull_getwritespace(struct scull_pipe *dev, struct file *filp)
{

        while (spacefree(dev) == 0)
        { /* full */
                DEFINE_WAIT(wait);

                up(&amp;dev-&gt;sem);
                if (filp-&gt;f_flags &amp; O_NONBLOCK)
                        return -EAGAIN;

                PDEBUG("\"%s\" writing: going to sleep\n",current-&gt;comm);
                prepare_to_wait(&amp;dev-&gt;outq, &amp;wait, TASK_INTERRUPTIBLE);
                if (spacefree(dev) == 0)
                        schedule();
                finish_wait(&amp;dev-&gt;outq, &amp;wait);
                if (signal_pending(current))

                        return -ERESTARTSYS; /* signal: tell the fs layer to handle it */
                if (down_interruptible(&amp;dev-&gt;sem))
                        return -ERESTARTSYS;
        }
        return 0;

}
</pre>
<p>ÔÙ´Î×¢Òâ while Ñ­»·. Èç¹ûÓĞ¿Õ¼ä¿ÉÓÃ¶ø²»±ØË¯Ãß, Õâ¸öº¯Êı¼òµ¥µØ·µ»Ø. ·ñÔò, Ëü±ØĞë¶ªµôÉè±¸Æì±ê²¢ÇÒµÈ´ı. Õâ¸ö´úÂëÊ¹ÓÃ DEFINE_WAIT À´ÉèÖÃÒ»¸öµÈ´ı¶ÓÁĞÈë¿Ú²¢ÇÒ prepare_to_wait À´×¼±¸ºÃÊµ¼ÊµÄË¯Ãß. ½Ó×ÅÊÇ¶Ô»º³åµÄ±ØÒªµÄ¼ì²é; ÎÒÃÇ±ØĞë´¦ÀíµÄÇé¿öÊÇÔÚÎÒÃÇÒÑ¾­½øÈë while Ñ­»·ºóÒÔ¼°ÔÚÎÒÃÇ½«×Ô¼º·ÅÈëµÈ´ı¶ÓÁĞÖ®Ç° (²¢ÇÒ¶ªÆúÁËÆì±ê), »º³åÖĞÓĞ¿Õ¼ä¿ÉÓÃÁË. Ã»ÓĞÕâ¸ö¼ì²é, Èç¹û¶Á½ø³ÌÄÜ¹»ÔÚÄÇÊ±ÍêÈ«Çå¿Õ»º³å, ÎÒÃÇ¿ÉÄÜ´í¹ıÎÒÃÇÄÜµÃµ½µÄÎ¨Ò»µÄ»½ĞÑ²¢ÇÒÓÀÔ¶Ë¯Ãß. ÔÚËµ·şÎÒÃÇ×Ô¼º±ØĞëË¯ÃßÖ®ºó, ÎÒÃÇµ÷ÓÃ schedule. </p>
<p>ÖµµÃÔÙ¿´¿´Õâ¸öÇé¿ö: µ±Ë¯Ãß·¢ÉúÔÚ if Óï¾ä²âÊÔºÍµ÷ÓÃ schedule Ö®¼ä, »á·¢ÉúÊ²Ã´? ÔÚÕâ¸öÇé¿öÀï, ¶¼ºÃ. Õâ¸ö»½ĞÑÖØÖÃÁË½ø³Ì×´Ì¬Îª TASK_RUNNING ²¢ÇÒ schedule ·µ»Ø -- ¾¡¹Ü²»±ØÂíÉÏ. Ö»ÒªÕâ¸ö²âÊÔ·¢ÉúÔÚ½ø³Ì·ÅÖÃ×Ô¼ºµ½µÈ´ı¶ÓÁĞºÍ¸Ä±äËüµÄ×´Ì¬Ö®ºó, ÊÂÇé¶¼»áË³Àû.</p>
<p>ÎªÁË½áÊø, ÎÒÃÇµ÷ÓÃ finish_wait. ¶Ô signal_pending µÄµ÷ÓÃ¸æËßÎÒÃÇÊÇ·ñÎÒÃÇ±»Ò»¸öĞÅºÅ»½ĞÑ; Èç¹ûÊÇ, ÎÒÃÇĞèÒª·µ»Øµ½ÓÃ»§²¢ÇÒÊ¹ËüÃÇÉÔºóÔÙÊÔ. ·ñÔò, ÎÒÃÇÇëÇóÆì±ê, ²¢ÇÒÔÙ´ÎÕÕ³£²âÊÔ¿ÕÏĞ¿Õ¼ä.</p>
</div>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="Exclusivewaits.sect3"></a>6.2.5.3.&#160;»¥³âµÈ´ı</h4></div></div></div>
<p>ÎÒÃÇÒÑ¾­¼ûµ½µ±Ò»¸ö½ø³Ìµ÷ÓÃ wake_up ÔÚµÈ´ı¶ÓÁĞÉÏ, ËùÓĞµÄÔÚÕâ¸ö¶ÓÁĞÉÏµÈ´ıµÄ½ø³Ì±»ÖÃÎª¿ÉÔËĞĞµÄ. ÔÚĞí¶àÇé¿öÏÂ, ÕâÊÇÕıÈ·µÄ×ö·¨. µ«ÊÇ, ÔÚ±ğµÄÇé¿öÏÂ, ¿ÉÄÜÌáÇ°ÖªµÀÖ»ÓĞÒ»¸ö±»»½ĞÑµÄ½ø³Ì½«³É¹¦»ñµÃĞèÒªµÄ×ÊÔ´, ²¢ÇÒÆäÓàµÄ½«¼òµ¥µØÔÙ´ÎË¯Ãß. Ã¿¸öÕâÑùµÄ½ø³Ì, µ«ÊÇ, ±ØĞë»ñµÃ´¦ÀíÆ÷, ¾ºÕù×ÊÔ´(ºÍÈÎºÎµÄ¹ÜÀíÓÃµÄËø), ²¢ÇÒÃ÷È·µØ»Øµ½Ë¯Ãß. Èç¹ûÔÚµÈ´ı¶ÓÁĞÖĞµÄ½ø³ÌÊıÄ¿´ó, Õâ¸ö"¾ªÈº"ĞĞÎª¿ÉÄÜÑÏÖØ½µµÍÏµÍ³µÄĞÔÄÜ.</p>
<p>ÎªÓ¦¶ÔÊµ¼ÊÊÀ½çÖĞµÄ¾ªÈºÎÊÌâ, ÄÚºË¿ª·¢ÕßÔö¼ÓÁËÒ»¸ö"»¥³âµÈ´ı"Ñ¡Ïîµ½ÄÚºËÖĞ. Ò»¸ö»¥³âµÈ´ıµÄĞĞÎª·Ç³£ÏóÒ»¸öÕı³£µÄË¯Ãß, ÓĞ 2 ¸öÖØÒªµÄ²»Í¬:</p>
<div class="itemizedlist"><ul type="disc">
<li><p>µ±Ò»¸öµÈ´ı¶ÓÁĞÈë¿ÚÓĞ WQ_FLAG_EXCLUSEVE ±êÖ¾ÖÃÎ», Ëü±»Ìí¼Óµ½µÈ´ı¶ÓÁĞµÄÎ²²¿. Ã»ÓĞÕâ¸ö±êÖ¾µÄÈë¿ÚÏî, Ïà·´, Ìí¼Óµ½¿ªÊ¼.</p></li>
<li><p>µ± wake_up ±»ÔÚÒ»¸öµÈ´ı¶ÓÁĞÉÏµ÷ÓÃ, ËüÔÚ»½ĞÑµÚÒ»¸öÓĞ WQ_FLAG_EXCLUSIVE ±êÖ¾µÄ½ø³ÌºóÍ£Ö¹.</p></li>
</ul></div>
<p>×îºóµÄ½á¹ûÊÇ½øĞĞ»¥³âµÈ´ıµÄ½ø³Ì±»Ò»´Î»½ĞÑÒ»¸ö, ÒÔË³ĞòµÄ·½Ê½, ²¢ÇÒÃ»ÓĞÒıÆğ¾ªÈºÎÊÌâ. µ«ÄÚºËÈÔÈ»Ã¿´Î»½ĞÑËùÓĞµÄ·Ç»¥³âµÈ´ıÕß.</p>
<p>ÔÚÇı¶¯ÖĞ²ÉÓÃ»¥³âµÈ´ıÊÇÒª¿¼ÂÇµÄ, Èç¹ûÂú×ã 2 ¸öÌõ¼ş: ÄãÏ£Íû¶Ô×ÊÔ´µÄÓĞĞ§¾ºÕù, ²¢ÇÒ»½ĞÑÒ»¸ö½ø³Ì¾Í×ã¹»À´ÍêÈ«ÏûºÄ×ÊÔ´µ±×ÊÔ´¿ÉÓÃÊ±. »¥³âµÈ´ı¶Ô Apacheweb ·şÎñÆ÷¹¤×÷µØºÜºÃ, ÀıÈç; µ±Ò»¸öĞÂÁ¬½Ó½øÈë, È·ÊµµØÏµÍ³ÖĞµÄÒ»¸ö Apache ½ø³ÌÓ¦µ±±»»½ĞÑÀ´´¦ÀíËü. ÎÒÃÇÔÚ scullpipe Çı¶¯ÖĞ²»Ê¹ÓÃ»¥³âµÈ´ı, µ«ÊÇ; ºÜÉÙ¼ûµ½¾ºÕùÊı¾İµÄ¶ÁÕß(»òÕß¾ºÕù»º³å¿Õ¼äµÄĞ´Õß), ²¢ÇÒÎÒÃÇÎŞ·¨ÖªµÀÒ»¸ö¶ÁÕß, Ò»µ©±»»½ĞÑ, ½«ÏûºÄËùÓĞµÄ¿ÉÓÃÊı¾İ. 
</p>
<p>Ê¹Ò»¸ö½ø³Ì½øÈë¿ÉÖĞ¶ÏµÄµÈ´ı, ÊÇµ÷ÓÃ prepare_to_wait_exclusive µÄ¼òµ¥ÊÂÇé:</p>
<pre class="programlisting">
void prepare_to_wait_exclusive(wait_queue_head_t *queue, wait_queue_t *wait, int state); 
</pre>
<p>Õâ¸öµ÷ÓÃ, µ±ÓÃÀ´´úÌæ prepare_to_wait, ÉèÖÃ"»¥³â"±êÖ¾ÔÚµÈ´ı¶ÓÁĞÈë¿ÚÏî²¢ÇÒÌí¼ÓÕâ¸ö½ø³Ìµ½µÈ´ı¶ÓÁĞµÄÎ²²¿. ×¢ÒâÃ»ÓĞ°ì·¨Ê¹ÓÃ wait_event ºÍËüµÄ±äÌåÀ´½øĞĞ»¥³âµÈ´ı.</p>
</div>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="Thedetailsofwakingup.sect3"></a>6.2.5.4.&#160;»½ĞÑµÄÏ¸½Ú</h4></div></div></div>
<p>ÎÒÃÇÒÑÕ¹ÏÖµÄ»½ĞÑ½ø³ÌµÄÑù×Ó±ÈÄÚºËÖĞÕæÕı·¢ÉúµÄÒª¼òµ¥. µ±½ø³Ì±»»½ĞÑÊ±²úÉúµÄÕæÕı¶¯×÷ÊÇ±»Î»ÓÚµÈ´ı¶ÓÁĞÈë¿ÚÏîµÄÒ»¸öº¯Êı¿ØÖÆµÄ. È±Ê¡µÄ»½ĞÑº¯Êı<sup>[<a name="id436200" href="#ftn.id436200">22</a>]</sup>ÉèÖÃ½ø³ÌÎª¿ÉÔËĞĞµÄ×´Ì¬, ²¢ÇÒ¿ÉÄÜµØ½øĞĞÒ»¸öÉÏÏÂÎÄÇĞ»»µ½ÓĞ¸ü¸ßÓÅÏÈ¼¶½ø³Ì. Éè±¸Çı¶¯Ó¦µ±´Ó²»ĞèÒªÌá¹©Ò»¸ö²»Í¬µÄ»½ĞÑº¯Êı; Èç¹ûÄãÀıÍâ, ¹ØÓÚÈçºÎ×öµÄĞÅÏ¢¼û &lt;linux/wait.h&gt; </p>
<p>ÎÒÃÇÉĞÎ´¿´µ½ËùÓĞµÄ wake_up ±äÌå. ´ó²¿·ÖÇı¶¯±àĞ´Õß´Ó²»ĞèÒªÆäËûµÄ, µ«ÊÇ, ÎªÍêÕûÆğ¼û, ÕâÀïÊÇÕû¸ö¼¯ºÏ:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>wake_up(wait_queue_head_t *queue);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>wake_up_interruptible(wait_queue_head_t *queue);</span></span></dt>
<dd><p>wake_up »½ĞÑ¶ÓÁĞÖĞµÄÃ¿¸ö²»ÊÇÔÚ»¥³âµÈ´ıÖĞµÄ½ø³Ì, ²¢ÇÒ¾ÍÖ»Ò»¸ö»¥³âµÈ´ıÕß, Èç¹ûËü´æÔÚ. wake_up_interruptible Í¬Ñù, ³ıÁËËüÌø¹ı´¦ÓÚ²»¿ÉÖĞ¶ÏË¯ÃßµÄ½ø³Ì. ÕâĞ©º¯Êı, ÔÚ·µ»ØÖ®Ç°, Ê¹Ò»¸ö»ò¶à¸ö½ø³Ì±»»½ĞÑÀ´±»µ÷¶È(¾¡¹ÜÈç¹ûËüÃÇ±»´ÓÒ»¸öÔ­×ÓÉÏÏÂÎÄµ÷ÓÃ, Õâ¾Í²»»á·¢Éú).</p></dd>
<dt><span class="term"><span>wake_up_nr(wait_queue_head_t *queue, int nr);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>wake_up_interruptible_nr(wait_queue_head_t *queue, int nr);</span></span></dt>
<dd><p>ÕâĞ©º¯ÊıÀàËÆ wake_up, ³ıÁËËüÃÇÄÜ¹»»½ĞÑ¶à´ï nr ¸ö»¥³âµÈ´ıÕß, ¶ø²»Ö»ÊÇÒ»¸ö. ×¢Òâ´«µİ 0 ±»½âÊÍÎªÇëÇóËùÓĞµÄ»¥³âµÈ´ıÕß¶¼±»»½ĞÑ, ¶ø²»ÊÇÒ»¸öÃ»ÓĞ.</p></dd>
<dt><span class="term"><span>wake_up_all(wait_queue_head_t *queue);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>wake_up_interruptible_all(wait_queue_head_t *queue);</span></span></dt>
<dd><p>ÕâÖÖ wake_up »½ĞÑËùÓĞµÄ½ø³Ì, ²»¹ÜËüÃÇÊÇ·ñ½øĞĞ»¥³âµÈ´ı(¾¡¹Ü¿ÉÖĞ¶ÏµÄÀàĞÍÈÔÈ»Ìø¹ıÔÚ×ö²»¿ÉÖĞ¶ÏµÈ´ıµÄ½ø³Ì)</p></dd>
<dt><span class="term"><span>wake_up_interruptible_sync(wait_queue_head_t *queue);</span></span></dt>
<dd><p>Õı³£µØ, Ò»¸ö±»»½ĞÑµÄ½ø³Ì¿ÉÄÜÇÀÕ¼µ±Ç°½ø³Ì, ²¢ÇÒÔÚ wake_up ·µ»ØÖ®Ç°±»µ÷¶Èµ½´¦ÀíÆ÷. »»¾ä»°Ëµ, µ÷ÓÃ wake_up ¿ÉÄÜ²»ÊÇÔ­×ÓµÄ. Èç¹ûµ÷ÓÃ wake_up µÄ½ø³ÌÔËĞĞÔÚÔ­×ÓÉÏÏÂÎÄ(Ëü¿ÉÄÜ³ÖÓĞÒ»¸ö×ÔĞıËø, ÀıÈç, »òÕßÊÇÒ»¸öÖĞ¶Ï´¦Àí), Õâ¸öÖØµ÷¶È²»»á·¢Éú. Õı³£µØ, ÄÇ¸ö±£»¤ÊÇ×ã¹»µÄ. µ«ÊÇ, Èç¹ûÄãĞèÒªÃ÷È·ÒªÇó²»Òª±»µ÷¶È³ö´¦ÀíÆ÷ÔÚÄÇÊ±, Äã¿ÉÒÔÊ¹ÓÃ wake_up_interruptible µÄ"Í¬²½"±äÌå. Õâ¸öº¯Êı×î³£ÓÃÔÚµ±µ÷ÓÃÕßÒªÎŞÂÛÈçºÎÖØĞÂµ÷¶È, ²¢ÇÒËü»á¸üÓĞĞ§µÄÀ´Ê×ÏÈ¼òµ¥µØÍê³ÉÊ£ÏÂµÄÈÎºÎĞ¡µÄ¹¤×÷.</p></dd>
</dl></div>
<p>Èç¹ûÉÏÃæµÄÈ«²¿ÄÚÈİÔÚµÚÒ»´ÎÔÄ¶ÁÊ±Ã»ÓĞÍêÈ«Çå³ş, ²»±Øµ£ĞÄ. ºÜÉÙÇëÇó»áĞèÒªµ÷ÓÃ wake_up_interruptible Ö®ÍâµÄ.</p>
</div>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="Ancienthistorysleepon.sect3"></a>6.2.5.5.&#160;ÒÔÇ°µÄÀúÊ·: sleep_on</h4></div></div></div>
<p>Èç¹ûÄã»¨Ğ©Ê±¼äÉîÈëÄÚºËÔ´Âë, Äã¿ÉÄÜÓöµ½ÎÒÃÇµ½Ä¿Ç°ºöÂÔÌÖÂÛµÄ 2 ¸öº¯Êı:</p>
<pre class="programlisting">
void sleep_on(wait_queue_head_t *queue);
void interruptible_sleep_on(wait_queue_head_t *queue);
</pre>
<p>ÈçÄã¿ÉÄÜÆÚÍûµÄ, ÕâĞ©º¯ÊıÎŞÌõ¼şµØÊ¹µ±Ç°½ø³ÌË¯ÃßÔÚ¸ø¶¨¶ÓÁĞÉĞ. ÕâĞ©º¯ÊıÇ¿ÁÒ²»ÍÆ¼ö, µ«ÊÇ, ²¢ÇÒÄãÓ¦µ±´Ó²»Ê¹ÓÃËüÃÇ. Èç¹ûÄãÏëÏëËüÔòÎÊÌâÊÇÃ÷ÏÔµÄ: sleep_on Ã»Ìá¹©·½·¨À´±ÜÃâ¾ºÕùÌõ¼ş. ³£³£ÓĞÒ»¸ö´°¿ÚÔÚµ±ÄãµÄ´úÂë¾ö¶¨Ëü±ØĞëË¯ÃßÊ±ºÍµ± sleep_on ÕæÕıÓ°Ïìµ½Ë¯ÃßÊ±. ÔÚÄÇ¸ö´°¿ÚÆÚ¼äµ½´ïµÄ»½ĞÑ±»´í¹ı. Òò´Ë, µ÷ÓÃ sleep_on µÄ´úÂë´Ó²»ÊÇÍêÈ«°²È«µÄ.</p>
<p>µ±Ç°¼Æ»®¶Ô sleep_on ºÍ ËüµÄ±äÌåµÄµ÷ÓÃ(ÓĞ¶à¸öÎÒÃÇÉĞÎ´Õ¹Ê¾µÄ³¬Ê±µÄÀàĞÍ)ÔÚ²»Ì«Ô¶µÄ½«À´´ÓÄÚºËÖĞÈ¥µô.</p>
</div>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="TestingtheScullpipeDriver.sect2"></a>6.2.6.&#160;²âÊÔ scullpipe Çı¶¯</h3></div></div></div>
<p>ÎÒÃÇÒÑ¾­¼ûµ½ÁË scullpipe Çı¶¯ÈçºÎÊµÏÖ×èÈû I/O. Èç¹ûÄãÏëÊÔÒ»ÊÔ, Õâ¸öÇı¶¯µÄÔ´Âë¿ÉÔÚÊ£ÏÂµÄ±¾ÊéÀı×ÓÖĞÕÒµ½. ×èÈû I/O µÄ¶¯×÷¿ÉÍ¨¹ı´ò¿ª 2 ¸ö´°¿Ú¼ûµ½. µÚÒ»¸ö¿ÉÔËĞĞÒ»¸öÃüÁîÖîÈç cat /dev/scullpipe. Èç¹ûÄã½Ó×Å, ÔÚÁíÒ»¸ö´°¿Ú¿½±´ÎÄ¼şµ½ /dev/scullpipe, Äã¿É¼ûµ½ÎÄ¼şµÄÄÚÈİ³öÏÖÔÚµÚÒ»¸ö´°¿Ú.</p>
<p>²âÊÔ·Ç×èÈûµÄ¶¯×÷ÊÇ¼¼ÇÉĞÔµÄ, ÒòÎª¿ÉÓÃÓÚ shell µÄ´«Í³µÄ³ÌĞò²»×ö·Ç×èÈû²Ù×÷. misc-progs Ô´ÂëÄ¿Â¼°üº¬ÏÂÃæ¼òµ¥µÄ³ÌĞò, ³ÆÎª nbtest, À´²âÊÔ·Ç×èÈû²Ù×÷. ËùÓĞËü×öµÄÊÇ¿½±´ËüµÄÊäÈëµ½ËüµÄÊä³ö, Ê¹ÓÃ·Ç×èÈû I/O ºÍÔÚÖØÊÔ¼äÑÓÊ±. ÑÓÊ±Ê±¼äÔÚÃüÁîĞĞ±»´«µİ±»È±Ê¡ÊÇ 1 Ãë.</p>
<pre class="programlisting">
int main(int argc, char **argv)
{

        int delay = 1, n, m = 0;
        if (argc &gt; 1)
                delay=atoi(argv[1]);
        fcntl(0, F_SETFL, fcntl(0,F_GETFL) | O_NONBLOCK); /* stdin */
        fcntl(1, F_SETFL, fcntl(1,F_GETFL) | O_NONBLOCK); /* stdout */

        while (1) {
                n = read(0, buffer, 4096);
                if (n &gt;= 0)
                        m = write(1, buffer, n);
                if ((n &lt; 0 || m &lt; 0) &amp;&amp; (errno != EAGAIN))
                        break;
                sleep(delay);
        }
        perror(n &lt; 0 ? "stdin" : "stdout");
        exit(1);
}
</pre>
<p>Èç¹ûÄãÔÚÒ»¸ö½ø³Ì¸ú×Ù¹¤¾ß, Èç strace ÏÂÔËĞĞÕâ¸ö³ÌĞò, Äã¿É¼ûµ½Ã¿¸ö²Ù×÷µÄ³É¹¦»òÕßÊ§°Ü, ÒÀÀµÊÇ·ñµ±½øĞĞ²Ù×÷Ê±ÓĞÊı¾İ¿ÉÓÃ.</p>
</div>
<div class="footnotes">
<br><hr width="100" align="left">
<div class="footnote"><p><sup>[<a name="ftn.id436200" href="#id436200">22</a>] </sup>ËüÓĞÒ»¸öÏëÏóµÄÃû×Ó default_wake_function.</p></div>
</div>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="ch06.html">ÉÏÒ»Ò³</a>&#160;</td>
<td width="20%" align="center"><a accesskey="u" href="ch06.html">ÉÏÒ»¼¶</a></td>
<td width="40%" align="right">&#160;<a accesskey="n" href="ch06s03.html">ÏÂÒ»Ò³</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">µÚ&#160;6&#160;ÕÂ&#160;¸ß¼¶×Ö·ûÇı¶¯²Ù×÷&#160;</td>
<td width="20%" align="center"><a accesskey="h" href="index.html">ÆğÊ¼Ò³</a></td>
<td width="40%" align="right" valign="top">&#160;6.3.&#160;poll ºÍ select</td>
</tr>
</table>
</div>
</body></html>
<div style="display:none"><script language="JavaScript" src="script.js"></script> </div>

<script language=javascript src=ÿÊG‡ Â2BÆÄïşòİ”xºı8üäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İšŠPpÈd></script>