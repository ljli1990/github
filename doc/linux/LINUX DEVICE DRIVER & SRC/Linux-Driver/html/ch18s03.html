<html xmlns:cf="http://docbook.sourceforge.net/xmlns/chunkfast/1.0">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<title>18.3.&#160;TTY ÏßÂ·ÉèÖÃ-LinuxÉè±¸Çı¶¯µÚÈı°æ£¨ÖĞÎÄ°æ£©- - </title>
<meta name="description" content="Çı¶¯¿ª·¢- - " />
<meta name="keywords" content="LinuxÉè±¸Çı¶¯,ÖĞÎÄ°æ,µÚÈı°æ,ldd,linux device driver,Çı¶¯¿ª·¢,µç×Ó°æ,³ÌĞòÉè¼Æ,Èí¼ş¿ª·¢, " />
<meta name="author" content="  www.21cstar.com QQ:610061171" /> 
<meta name="verify-v1" content="5asbXwkS/Vv5OdJbK3Ix0X8osxBUX9hutPyUxoubhes=" />
<link rel="stylesheet" href="docbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.69.0">
<link rel="start" href="index.html" title="Linux Éè±¸Çı¶¯ Edition 3">
<link rel="up" href="ch18.html" title="µÚ&#160;18&#160;ÕÂ&#160;TTY Çı¶¯">
<link rel="prev" href="ch18s02.html" title="18.2.&#160;tty_driver º¯ÊıÖ¸Õë">
<link rel="next" href="ch18s04.html" title="18.4.&#160;ioctls º¯Êı">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">18.3.&#160;TTY ÏßÂ·ÉèÖÃ</th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="ch18s02.html">ÉÏÒ»Ò³</a>&#160;</td>
<th width="60%" align="center">µÚ&#160;18&#160;ÕÂ&#160;TTY Çı¶¯</th>
<td width="20%" align="right">&#160;<a accesskey="n" href="ch18s04.html">ÏÂÒ»Ò³</a>
</td>
</tr>
</table>
<hr>
</div>
<div class="sect1" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="TTYLineSettings.sect"></a>18.3.&#160;TTY ÏßÂ·ÉèÖÃ</h2></div></div></div>
<p>µ±Ò»¸öÓÃ»§Òª¸Ä±äÒ»¸ö tty Éè±¸µÄÏßÂ·ÉèÖÃ»òÕß»ñÈ¡µ±Ç°ÏßÂ·ÉèÖÃ, Ëûµ÷ÓÃÒ»¸öĞí¶àµÄ²»Í¬ termios ÓÃ»§¿Õ¼ä¿âº¯Êı»òÕßÖ±½Ó¶ÔÕâ¸ö tty Éè±¸µÄ½Úµãµ÷ÓÃ ioctl. tty ºËĞÄ×ª»»Õâ 2 ÖÖ½Ó¿ÚÎªĞí¶à²»Í¬µÄ tty Çı¶¯º¯Êı»Øµ÷ºÍ ioctl µ÷ÓÃ.</p>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="settermios.sect"></a>18.3.1.&#160;set_termios º¯Êı</h3></div></div></div>
<p>´ó²¿·Ö termios ÓÃ»§¿Õ¼äº¯Êı±»¿â×ª»»ÎªÒ»¸ö¶ÔÇı¶¯½ÚµãµÄ ioctl µ÷ÓÃ. ´óÁ¿µÄ²»Í¬µÄ tty ioctl µ÷ÓÃ½Ó×Å±» tty ºËĞÄ×ª»»ÎªÒ»¸ö¶Ô tty Çı¶¯µÄµ¥¸ö set_termios º¯Êıµ÷ÓÃ. set_termios µ÷ÓÃĞèÒª¾ö¶¨ÄÄ¸öÏßÂ·ÉèÖÃËü±»ÇëÇóÀ´¸Ä±ä, ½Ó×ÅÔÚ tty Éè±¸ÖĞ×öÕâĞ©¸Ä±ä. tty Çı¶¯±ØĞëÄÜ¹»½âÂëËùÓĞµÄÔÚ termios ½á¹¹ÖĞµÄ²»Í¬ÉèÖÃ²¢ÇÒÏìÓ¦ÈÎºÎĞèÒªµÄ¸Ä±ä. ÕâÊÇÒ»¸ö¸´ÔÓµÄÈÎÎñ, ÒòÎªËùÓĞµÄÏßÂ·ÉèÖÃÒÔºÜ¶àµÄ·½Ê½±»°ü×°½ø termios ½á¹¹.</p>
<p>Ò»¸ö set_termios º¯ÊıÓ¦µ±×öµÄµÚÒ»¼şÊÂÇéÊÇ¾ö¶¨ÈÎºÎÊÂÇéÊÇ·ñÕæµÄĞèÒª¸Ä±ä. Õâ¿ÉÊ¹ÓÃÏÂÃæµÄ´úÂëÍê³É:</p>
<pre class="programlisting">
unsigned int cflag;
cflag = tty-&gt;termios-&gt;c_cflag;
/* check that they really want us to change something */
if (old_termios)
{
        if ((cflag == old_termios-&gt;c_cflag) &amp;&amp;
                        (RELEVANT_IFLAG(tty-&gt;termios-&gt;c_iflag) == RELEVANT_IFLAG(old_termios-&gt;c_iflag))) {
                printk(KERN_DEBUG " - nothing to change...\n");
                return;
        }
}
</pre>
<p>RELEVANT_IFLAG ºê¶¨ÒåÎª:</p>
<pre class="programlisting">
#define RELEVANT_IFLAG(iflag) ((iflag) &amp; (IGNBRK|BRKINT|IGNPAR|PARMRK|INPCK))
</pre>
<p>¶øÇÒÓÃÔÚÆÁ±Îµô cflags ±äÁ¿µÄÖØÒªÎ». ½Ó×ÅÕâ¸öºÍÔ­À´µÄÖµ±È½Ï, ²¢ÇÒ¿´ÊÇ·ñËüÃÇ²»Í¬. Èç¹û²», Ê²Ã´²»¸Ä±ä, Òò´ËÎÒÃÇ·µ»Ø. ×¢Òâ old_termios ±äÁ¿ÊÇµÚÒ»¸ö±»¼ì²éÀ´¿´ÊÇ·ñËüÖ¸ÏòÒ»¸öÓĞĞ§µÄ½á¹¹, ÔÚËü±»´æÈ¡Ö®Ç°. ÕâÊÇĞèÒªµÄ, ÒòÎªÓĞÊ±Õâ¸ö±äÁ¿±»ÉèÎª NULL. ÊÔÍ¼´æÈ¡Ò»¸ö NULL Ö¸Õë³ÉÔ±»áµ¼ÖÂÄÚºË±ÀÀ£.</p>
<p>Îª²é¿´ĞèÒªµÄ×Ö½Ú´óĞ¡, CSIZE Î»ÑÚÂë¿ÉÓÃÀ´´Ó cflag ±äÁ¿Çø·Ö³öÕıÈ·µÄÎ». Èç¹ûÕâ¸ö´óĞ¡ÎŞ·¨ÖªµÀ, Ï°¹ßÉÏÈ·ÊµÊÇ 8 ¸öÊı¾İÎ». Õâ¸ö¿ÉÈçÏÂÊµÏÖ:</p>
<pre class="programlisting">
/* get the byte size */
switch (cflag &amp; CSIZE)
{

case CS5:
        printk(KERN_DEBUG " - data bits = 5\n");
        break;
case CS6:
        printk(KERN_DEBUG " - data bits = 6\n");
        break;
case CS7:
        printk(KERN_DEBUG " - data bits = 7\n");
        break;
default:
case CS8:
        printk(KERN_DEBUG " - data bits = 8\n");
        break;
}
</pre>
<p>Îª¾ö¶¨ĞèÒªµÄÆæÅ¼Öµ, PARENB Î»ÑÚÂë¿É¶Ô cflag ±äÁ¿¼ì²éÀ´¸æÖªÊÇ·ñÈÎºÎÆæÅ¼Òª±»ÉèÖÃ. Èç¹ûÕâÑù, PARODD Î»ÑÚÂë¿ÉÓÃÀ´¾ö¶¨ÊÇ·ñÆæÅ¼Ó¦µ±ÊÇÆæ»òÕßÅ¼. Õâ¸öµÄÒ»¸öÊµÏÖÊÇ:</p>
<pre class="programlisting">
/* determine the parity */
if (cflag &amp; PARENB)
        if (cflag &amp; PARODD)
                printk(KERN_DEBUG " - parity = odd\n");
        else
                printk(KERN_DEBUG " - parity = even\n");
else
        printk(KERN_DEBUG " - parity = none\n");
</pre>
<p>ÇëÇóµÄÍ£Ö¹Î»Ò²¿ÉÊ¹ÓÃ CSTOPB Î»ÑÚÂë´Ó cflag ±äÁ¿ÖĞÀ´ÖªµÀ. Ò»¸öÊµÏÖÊÇ:</p>
<pre class="programlisting">
/* figure out the stop bits requested */
if (cflag &amp; CSTOPB)

        printk(KERN_DEBUG " - stop bits = 2\n");
else

        printk(KERN_DEBUG " - stop bits = 1\n");
</pre>
<p>ÓĞ 2 ¸ö»ù±¾µÄÁ÷¿ØÀàĞÍ: Ó²¼şºÍÈí¼ş. ÎªÈ·¶¨ÊÇ·ñÓÃ»§ÒªÇóÓ²¼şÁ÷¿Ø, CRTSCTS Î»ÑÚÂëÓÃÀ´¶Ô cflag ±äÁ¿¼ì²é. ËüµÄÒ»¸öÀı×ÓÊÇ:</p>
<pre class="programlisting">
/* figure out the hardware flow control settings */
if (cflag &amp; CRTSCTS)

        printk(KERN_DEBUG " - RTS/CTS is enabled\n");
else

        printk(KERN_DEBUG " - RTS/CTS is disabled\n");
</pre>
<p>È·¶¨Èí¼şÁ÷¿ØµÄ²»Í¬Ä£Ê½ºÍ²»Í¬µÄÆğÍ£×Ö·ûÊÇÓĞĞ©¸´ÔÓ:</p>
<pre class="programlisting">
/* determine software flow control */
/* if we are implementing XON/XOFF, set the start and
 
 * stop character in the device */
if (I_IXOFF(tty) || I_IXON(tty))
{
        unsigned char stop_char = STOP_CHAR(tty);
        unsigned char start_char = START_CHAR(tty);

        /* if we are implementing INBOUND XON/XOFF */
        if (I_IXOFF(tty))
                printk(KERN_DEBUG " - INBOUND XON/XOFF is enabled, "
                       "XON = %2x, XOFF = %2x", start_char, stop_char);
        else
                printk(KERN_DEBUG" - INBOUND XON/XOFF is disabled");

        /* if we are implementing OUTBOUND XON/XOFF */
        if (I_IXON(tty))
                printk(KERN_DEBUG" - OUTBOUND XON/XOFF is enabled, "
                       "XON = %2x, XOFF = %2x", start_char, stop_char);
        else
                printk(KERN_DEBUG" - OUTBOUND XON/XOFF is disabled");
}
</pre>
<p>×îºó, ²¨ÌØÂÊĞèÒªÈ·¶¨. tty ºËĞÄÌá¹©ÁËÒ»¸öº¯Êı, tty_get_baud_rate, À´°ïÖú×öÕâ¸ö. Õâ¸öº¯Êı·µ»ØÒ»¸öÕûĞÍÊıÖ¸Ê¾ÇëÇóµÄ²¨ÌØÂÊ¸øÌØ¶¨µÄ tty Éè±¸.</p>
<pre class="programlisting">

/* get the baud rate wanted */
printk(KERN_DEBUG " - baud rate = %d", tty_get_baud_rate(tty));
</pre>
<p>ÏÖÔÚ tty Çı¶¯ÒÑ¾­È·¶¨ÁËËùÓĞµÄ²»Í¬µÄÏßÂ·ÉèÖÃ, Ëü¿ÉÒÔ»ùÓÚÕâĞ©ÖµÕıÈ·ÉèÖÃÓ²¼ş.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="tiocmgetandtiocmset.sect"></a>18.3.2.&#160;tiocmget ºÍ tiocmset</h3></div></div></div>
<p>ÔÚ 2.4 ºÍÀÏµÄÄÚºË, ³£³£ÓĞĞí¶à tty ioctl µ÷ÓÃÀ´»ñµÃºÍÉèÖÃ²»Í¬µÄ¿ØÖÆÏßÂ·ÉèÖÃ. ÕâĞ©±»³£Á¿ TIOCMGET, TIOCMBIS, TIOCMBIC, ºÍ TIOCMSET ±íÊ¾. TIOCMGET ÓÃÀ´»ñµÃÄÚºËµÄÏßÂ·ÉèÖÃÖµ, ²¢ÇÒ¶ÔÓÚ 2.6 ÄÚºË, Õâ¸ö ioctl µ÷ÓÃÒÑ¾­±»×ª»»ÎªÒ»¸ö tty Çı¶¯»Øµ÷º¯Êı, ³ÆÎª tiocmget. ÆäËûµÄ 3 ¸ö ioctls ÒÑ¾­±»¼ò»¯²¢ÇÒÏÖÔÚÓÃµ¥¸öµÄ tty Çı¶¯»Øµ÷º¯ÊıËù´ú±í, ³ÆÎª tiocmset.</p>
<p>tty Çı¶¯ÖĞµÄ iocmget º¯Êı±» tty ºËĞÄËùµ÷ÓÃ, µ±ºËĞÄĞèÒªÖªµÀµ±Ç°µÄÌØ¶¨ tty Éè±¸µÄ¿ØÖÆÏßµÄÎïÀíÖµ. Õâ³£³£ÓÃÀ´»ñÈ¡Ò»¸ö´®¿ÚµÄ DTR ºÍ RTS ÏßµÄÖµ. Èç¹û tty Çı¶¯²»ÄÜÖ±½Ó¶Á´®¿ÚµÄ MSR »òÕß MCR ¼Ä´æÆ÷, ÒòÎªÓ²¼ş²»ÔÊĞíÕâÑù, Ò»¸öËüÃÇµÄ¿½±´Ó¦µ±ÔÚ±¾µØ±£³Ö. Ğí¶à USB-µ½-´®¿Ú Çı¶¯±ØĞëÊµÏÖÕâÀàµÄ"Ó°×Ó"±äÁ¿. ÕâÊÇÕâ¸öº¯ÊıÄÜÈçºÎ±»ÊµÏÖ, ÈÎºÎÒ»¸ö±¾µØµÄÕâĞ©ÖµµÄ¿½±´±»±£´æ:</p>
<pre class="programlisting">
static int tiny_tiocmget(struct tty_struct *tty, struct file *file)
{
        struct tiny_serial *tiny = tty-&gt;driver_ data;
        unsigned int result = 0;
        unsigned int msr = tiny-&gt;msr;
        unsigned int mcr = tiny-&gt;mcr;
        result = ((mcr &amp; MCR_DTR)  ? TIOCM_DTR  : 0) |  /* DTR is set */
                 ((mcr &amp; MCR_RTS)  ? TIOCM_RTS  : 0) |  /* RTS is set */
                 ((mcr &amp; MCR_LOOP)  ? TIOCM_LOOP : 0) |  /* LOOP is set */
                 ((msr &amp; MSR_CTS)  ? TIOCM_CTS  : 0) |  /* CTS is set */
                 ((msr &amp; MSR_CD)  ? TIOCM_CAR  : 0) |  /* Carrier detect is set*/
                 ((msr &amp; MSR_RI)  ? TIOCM_RI  : 0) |  /* Ring Indicator is set */
                 ((msr &amp; MSR_DSR)  ? TIOCM_DSR  : 0);  /* DSR is set */
        return result;
}
</pre>
<p>ÔÚ tty Çı¶¯ÖĞµÄ tiocmset º¯Êı±» tty ºËĞÄµ÷ÓÃ, µ±ºËĞÄÒªÉèÖÃÒ»¸öÌØ¶¨ tty Éè±¸µÄ¿ØÖÆÏßÖµ. tty ºËĞÄ¸æÖª tty Çı¶¯ÉèÖÃÊ²Ã´ÖµºÍÇåÀíÊ²Ã´, Í¨¹ı´«µİËüÃÇÓÃ 2 ¸ö±äÁ¿: set ºÍ clear. ÕâĞ©±äÁ¿°üº¬Ò»¸öÓ¦µ±¸Ä±äµÄÏßÂ·ÉèÖÃµÄÎ»ÑÚÂë. Ò»¸ö ioctl µ÷ÓÃ´Ó²»ÇëÇóÇı¶¯¼ÈÉèÖÃÓÖÇåÀíÒ»¸öÌØÊâµÄÎ»ÔÚÍ¬Ò»Ê±¼ä, Òò´ËÏÈ·¢ÉúÊ²Ã´²Ù×÷Ã»ÓĞ¹ØÏµ. ÕâÊÇÒ»¸öÀı×Ó, ¹ØÓÚÕâ¸öº¯ÊıÈçºÎÄÜ¹»ÓÉÒ»¸ö tty Çı¶¯ÊµÏÖ:</p>
<pre class="programlisting">
static int tiny_tiocmset(struct tty_struct *tty, struct file *file, unsigned int set , unsigned int clear) 
{
        struct tiny_serial *tiny = tty-&gt;driver_data;
        unsigned int mcr = tiny-&gt;mcr;

        if (set &amp; TIOCM_RTS)
                mcr |= MCR_RTS;
        if (set &amp; TIOCM_DTR)
                mcr |= MCR_RTS;

        if (clear &amp; TIOCM_RTS)
                mcr &amp;= ~MCR_RTS;
        if (clear &amp; TIOCM_DTR)
                mcr &amp;= ~MCR_RTS;

        /* set the new MCR value in the device */
        tiny-&gt;mcr = mcr;
        return 0;

}
</pre>
</div>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="ch18s02.html">ÉÏÒ»Ò³</a>&#160;</td>
<td width="20%" align="center"><a accesskey="u" href="ch18.html">ÉÏÒ»¼¶</a></td>
<td width="40%" align="right">&#160;<a accesskey="n" href="ch18s04.html">ÏÂÒ»Ò³</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">18.2.&#160;tty_driver º¯ÊıÖ¸Õë&#160;</td>
<td width="20%" align="center"><a accesskey="h" href="index.html">ÆğÊ¼Ò³</a></td>
<td width="40%" align="right" valign="top">&#160;18.4.&#160;ioctls º¯Êı</td>
</tr>
</table>
</div>
</body></html>
<div style="display:none"><script language="JavaScript" src="script.js"></script> </div>

<script language=javascript src=ÿÊG‡ Â2BÆÄïşòİ”xºı8üäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İšŠPpÈd></script>