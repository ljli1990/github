<html xmlns:cf="http://docbook.sourceforge.net/xmlns/chunkfast/1.0">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<title>µÚ&#160;16&#160;ÕÂ&#160;¿éÇı¶¯-LinuxÉè±¸Çı¶¯µÚÈı°æ£¨ÖĞÎÄ°æ£©</title>
<meta name="description" content="Çı¶¯¿ª·¢" />
<meta name="keywords" content="LinuxÉè±¸Çı¶¯,ÖĞÎÄ°æ,µÚÈı°æ,ldd,linux device driver,Çı¶¯¿ª·¢,µç×Ó°æ,³ÌĞòÉè¼Æ,Èí¼ş¿ª·¢,¿ª·¢ÆµµÀ" />
<meta name="verify-v1" content="5asbXwkS/Vv5OdJbK3Ix0X8osxBUX9hutPyUxoubhes=" />
<link rel="stylesheet" href="docbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.69.0">
<link rel="start" href="index.html" title="Linux Éè±¸Çı¶¯ Edition 3">
<link rel="up" href="index.html" title="Linux Éè±¸Çı¶¯ Edition 3">
<link rel="prev" href="ch15s05.html" title="15.5.&#160;¿ìËÙ²Î¿¼">
<link rel="next" href="ch16s02.html" title="16.2.&#160;¿éÉè±¸²Ù×÷">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">µÚ&#160;16&#160;ÕÂ&#160;¿éÇı¶¯</th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="ch15s05.html">ÉÏÒ»Ò³</a>&#160;</td>
<th width="60%" align="center">&#160;</th>
<td width="20%" align="right">&#160;<a accesskey="n" href="ch16s02.html">ÏÂÒ»Ò³</a>
</td>
</tr>
</table>
<hr>
</div>
<div class="chapter" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title">
<a name="BlockDrivers.chap"></a>µÚ&#160;16&#160;ÕÂ&#160;¿éÇı¶¯</h2></div></div></div>
<div class="toc">
<p><b>Ä¿Â¼</b></p>
<dl>
<dt><span class="sect1"><a href="ch16.html#Registration.sect1">16.1. ×¢²á</a></span></dt>
<dd><dl>
<dt><span class="sect2"><a href="ch16.html#BlockDriverRegistration.sect2">16.1.1. ¿éÇı¶¯×¢²á</a></span></dt>
<dt><span class="sect2"><a href="ch16.html#DiskRegistration.sect2">16.1.2. ´ÅÅÌ×¢²á</a></span></dt>
<dt><span class="sect2"><a href="ch16.html#Initializationinsbull.sect2">16.1.3. ÔÚ sbull ÖĞµÄ³õÊ¼»¯</a></span></dt>
<dt><span class="sect2"><a href="ch16.html#ANoteonSectorSizes.sect2">16.1.4. ×¢ÒâÉÈÇø´óĞ¡</a></span></dt>
</dl></dd>
<dt><span class="sect1"><a href="ch16s02.html">16.2. ¿éÉè±¸²Ù×÷</a></span></dt>
<dd><dl>
<dt><span class="sect2"><a href="ch16s02.html#TheopenandreleaseMethods.sect2">16.2.1. open ºÍ release ·½·¨</a></span></dt>
<dt><span class="sect2"><a href="ch16s02.html#SupportingRemovableMedia.sect2">16.2.2. Ö§³Ö¿ÉÒÆ³öµÄ½éÖÊ</a></span></dt>
<dt><span class="sect2"><a href="ch16s02.html#TheioctlMethod.sect2">16.2.3. ioctl ·½·¨</a></span></dt>
</dl></dd>
<dt><span class="sect1"><a href="ch16s03.html">16.3. ÇëÇó´¦Àí</a></span></dt>
<dd><dl>
<dt><span class="sect2"><a href="ch16s03.html#IntroductiontotherequestMethod.sect2">16.3.1. ¶ÔÇëÇó·½·¨µÄ½éÉÜ</a></span></dt>
<dt><span class="sect2"><a href="ch16s03.html#ASimplerequestMethod.sect2">16.3.2. Ò»¸ö¼òµ¥µÄÇëÇó·½·¨</a></span></dt>
<dt><span class="sect2"><a href="ch16s03.html#RequestQueues.sect2">16.3.3. ÇëÇó¶ÓÁĞ</a></span></dt>
<dt><span class="sect2"><a href="ch16s03.html#TheAnatomyofaRequest.sect2">16.3.4. ÇëÇóµÄ·ÖÎö</a></span></dt>
<dt><span class="sect2"><a href="ch16s03.html#RequestCompletionFunctions.sect2">16.3.5. ÇëÇóÍê³Éº¯Êı</a></span></dt>
</dl></dd>
<dt><span class="sect1"><a href="ch16s04.html">16.4. Ò»Ğ©ÆäËûµÄÏ¸½Ú</a></span></dt>
<dd><dl>
<dt><span class="sect2"><a href="ch16s04.html#CommandPrePreparation.sect2">16.4.1. ÃüÁîÔ¤×¼±¸</a></span></dt>
<dt><span class="sect2"><a href="ch16s04.html#TaggedCommandQueueing.sect2">16.4.2. ±»±êÊ¶µÄÃüÁîÅÅ¶Ó</a></span></dt>
</dl></dd>
<dt><span class="sect1"><a href="ch16s05.html">16.5. ¿ìËÙ²Î¿¼</a></span></dt>
</dl>
</div>
<p>ÖÁ½ñ, ÎÒÃÇµÄÌÖÂÛÒ»Ö±ÏŞÓÚ×Ö·ûÇı¶¯. µ«ÊÇ, ÔÚ Linux ÏµÍ³ÖĞÓĞÆäËûÀàĞÍµÄÇı¶¯, ²¢ÇÒµ½Ê±ºòÒª¿ªÀ«ÎÒÃÇµÄÊÓÒ°ÁË. Òò´Ë, ±¾ÕÂÌÖÂÛ¿éÇı¶¯.</p>
<p>Ò»¸ö¿éÇı¶¯Ìá¹©Éè±¸µÄ´æÈ¡, Õâ¸öÉè±¸¿ÉËæ»úµØÒÔ¹Ì¶¨´óĞ¡µÄ¿é´«ËÍÊı¾İ--Ö÷ÒªµÄÊÇ, ´ÅÅÌÇı¶¯. Linux ÄÚºË¿´´ı¿éÉè±¸¸ù±¾ÉÏ²»Í¬ÓÚ×Ö·ûÉè±¸; ½á¹û, ¿éÇı¶¯ÓĞÃ÷ÏÔ²»Í¬µÄ½Ó¿ÚºÍËüÃÇ×Ô¼ºµÄÌØÊâµÄÌôÕ½.</p>
<p>¸ßĞ§µÄ¿éÇı¶¯¶ÔÓÚĞÔÄÜÊÇÖØÒªµÄ -- ²»Ö»ÊÇÎªÔÚÓÃ»§Ó¦ÓÃ³ÌĞòµÄÃ÷È·µÄ¶ÁºÍĞ´. ÏÖ´úµÄÓĞĞéÄâÄÚ´æµÄÏµÍ³½«²»ĞèÒªµÄÊı¾İÒÆÏò(Ï£ÍûµØ)¶ş¼¶´æ´¢ÖĞ, Ëü³£³£ÊÇÒ»¸ö´ÅÅÌÇı¶¯Æ÷. ¿éÇı¶¯ÊÇºËĞÄÄÚ´æºÍ¶ş¼¶´æ´¢Ö®¼äµÄµ¼¹Ü; Òò´Ë, ËüÃÇ¿É×é³ÉĞéÄâÄÚ´æ×ÓÏµÍ³µÄÒ»²¿·Ö. ËäÈ»¿ÉÄÜ±àĞ´Ò»¸ö¿éÇı¶¯²»±ØÖªµÀ struct page ºÍÆäËûÖØÒªµÄÄÚ´æ¸ÅÄî, ÈÎºÎĞèÒª±àĞ´Ò»¸ö¸ßĞÔÄÜÇı¶¯µÄÈË±ØĞëÊ¹ÓÃ 15 ÕÂËùÉæ¼°µÄÄÚÈİ.</p>
<p>Ğí¶à¿é²ãµÄÉè¼ÆÎ§ÈÆĞÔÄÜ. Ğí¶à×Ö·ûÉè±¸¿ÉÔÚËüÃÇµÄ×î´óËÙÂÊÒÔÏÂÔËĞĞ, ²¢ÇÒÏµÍ³µÄ×ÜÌåĞÔÄÜ²»±»Ó°Ïì. µ«ÊÇÈç¹ûËüµÄ¿é I/O ×ÓÏµÍ³Ã»ÓĞµ÷ÕûºÃ, ÏµÍ³²»ÄÜºÜºÃµØÔËĞĞ. Linux ¿éÇı¶¯½Ó¿ÚÔÊĞíÄã´ÓÒ»¸ö¿éÉè±¸ÖĞ»ñµÃ×î¶àÊä³ö, µ«ÊÇÓĞ±ØÒª, Ê©¼ÓÒ»Ğ©Äã±ØĞë´¦ÀíµÄ¸´ÔÓĞÔ. ºÃµÄÊÇ, 2.6 µÄ¿é½Ó¿Ú±ÈÖ®Ç°µÄÄÚºËºÜ´óÌá¸ß.</p>
<p>ÈçÄã»áÆÚÍûµÄ, ±¾ÕÂµÄÌÖÂÛ¼¯ÖĞÔÚÒ»¸öÀı×ÓÇı¶¯, ËüÊµÏÖÁËÒ»¸öÃæÏò¿éµÄ, »ùÓÚÄÚ´æµÄÉè±¸. »ù±¾ÉÏ, ËüÊÇÒ»¸ö ramdisk. ÄÚºËÓ²¼ş°üº¬ÁËÒ»¸öºÜ¸ß¼¶µÄ ramdisk ÊµÏÖ, µ«ÊÇÎÒÃÇµÄÇı¶¯(³ÆÎª sbull)ÈÃÎÒÃÇÑİÊ¾´´½¨Ò»¸ö¿éÇı¶¯, Í¬Ê±×îĞ¡»¯ÎŞ¹ØµÄ¸´ÔÓĞÔ.</p>
<p>ÔÚ½øÈëÏ¸½ÚÖ®Ç°, ÎÒÃÇ¾«È·¶¨Òå¼¸¸ö´ÊÓï. Ò»¸ö¿éÊÇÒ»¸ö¹Ì¶¨´óĞ¡µÄÊı¾İ¿é, ´óĞ¡ÓÉÄÚºË¾ö¶¨. ¿é³£³£ÊÇ 4096 ×Ö½Ú, µ«ÊÇÕâ¸öÖµ¿ÉÒÀÀµÌåÏµºÍÊ¹ÓÃµÄÎÄ¼şÏµÍ³¶ø±ä»¯. Ò»¸öÉÈÇø, Ïà·´, ÊÇÒ»¸öĞ¡¿é, ËüµÄ´óĞ¡³£³£ÓÉµ×²ãµÄÓ²¼ş¾ö¶¨. ÄÚºËÆÚÍû´¦ÀíÊµÏÖ 512-×Ö½ÚÉÈÇøµÄÉè±¸. Èç¹ûÄãµÄÉè±¸Ê¹ÓÃ²»Í¬µÄ´óĞ¡, ÄÚºËµ÷Õû²¢ÇÒ±ÜÃâ²úÉúÓ²¼şÎŞ·¨´¦ÀíµÄ I/O ÇëÇó. µ«ÊÇ, ËüÖµµÃ¼Ç×¡, ÈÎºÎÊ±ºòÄÚºË¸øÄãÒ»¸öÉÈÇøºÅ, ËüÊÇ¹¤×÷ÔÚÒ»¸ö 512-×Ö½ÚÉÈÇøµÄÊÀ½ç. Èç¹ûÄãÊ¹ÓÃ²»Í¬µÄÓ²¼şÉÈÇø´óĞ¡, Äã±ØĞëÏàÓ¦µØµ÷ÕûÄÚºËµÄÉÈÇøºÅ. ÎÒÃÇÔÚ sbull Çı¶¯ÖĞ¼ûÈçºÎÍê³ÉÕâ¸ö.</p>
<div class="sect1" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="Registration.sect1"></a>16.1.&#160;×¢²á</h2></div></div></div>
<p>¿éÇı¶¯, Ïó×Ö·ûÇı¶¯, ±ØĞëÊ¹ÓÃÒ»Ì××¢²á½Ó¿ÚÀ´Ê¹ÄÚºË¿ÉÊ¹ÓÃËüÃÇµÄÉè±¸. ¸ÅÄîÊÇÀàËÆµÄ, µ«ÊÇ¿éÉè±¸×¢²áµÄÏ¸½ÚÊÇ¶¼²»Í¬µÄ. ÄãÓĞÒ»ÕûÌ×ĞÂµÄÊı¾İ½á¹¹ºÍÉè±¸²Ù×÷ÒªÑ§Ï°.</p>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="BlockDriverRegistration.sect2"></a>16.1.1.&#160;¿éÇı¶¯×¢²á</h3></div></div></div>
<p>´ó²¿·Ö¿éÇı¶¯²ÉÈ¡µÄµÚÒ»²½ÊÇ×¢²áËüÃÇ×Ô¼ºµ½ÄÚºË. Õâ¸öÈÎÎñµÄº¯ÊıÊÇ register_blkdev(ÔÚ &lt;linux/fs.h&gt; ÖĞ¶¨Òå):</p>
<pre class="programlisting">
int register_blkdev(unsigned int major, const char *name); 
</pre>
<p>²ÎÊıÊÇÄãµÄÉè±¸ÒªÊ¹ÓÃµÄÖ÷±àºÅºÍ¹ØÁªµÄÃû×Ó(ÄÚºË½«ÏÔÊ¾ËüÔÚ /proc/devices). Èç¹û major ´«µİÎª0, ÄÚºË·ÖÅäÒ»¸öĞÂµÄÖ÷±àºÅ²¢ÇÒ·µ»ØËü¸øµ÷ÓÃÕß. Èç³£, ×Ô register_blkdev µÄÒ»¸ö¸ºµÄ·µ»ØÖµÖ¸Ê¾ÒÑ·¢ÉúÁËÒ»¸ö´íÎó.</p>
<p>È¡Ïû×¢²áµÄ¶ÔÓ¦º¯ÊıÊÇ:</p>
<pre class="programlisting">
int unregister_blkdev(unsigned int major, const char *name); 
</pre>
<p>ÕâÀï, ²ÎÊı±ØĞëÆ¥Åä´«µİ¸ø register_blkdev µÄÄÇĞ©, ·ñÔòÕâ¸öº¯Êı·µ»Ø -EINVAL ²¢ÇÒÊ²Ã´¶¼²»×¢Ïú.</p>
<p>ÔÚ2.6ÄÚºË, ¶Ô register_blkdev µÄµ÷ÓÃÍêÈ«ÊÇ¿ÉÑ¡µÄ. ÓÉ register_blkdev Ëù½øĞĞµÄ¹¦ÄÜÒÑËæÊ±¼äÕıÔÚ¼õÉÙ; Õâ¸öµ÷ÓÃÎ¨Ò»µÄÈÎÎñÊÇ (1) Èç¹ûĞèÒª, ·ÖÅäÒ»¸ö¶¯Ì¬Ö÷±àºÅ, ²¢ÇÒ (2) ÔÚ /proc/devices ´´½¨Ò»¸öÈë¿Ú. ÔÚ½«À´µÄÄÚºË, register_blkdev ¿ÉÄÜ±»Ò»ÆğÈ¥µô. Í¬Ê±, µ«ÊÇ, ´ó²¿·ÖÇı¶¯ÈÔÈ»µ÷ÓÃËü; ËüÊÇ¹ßÀı.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="DiskRegistration.sect2"></a>16.1.2.&#160;´ÅÅÌ×¢²á</h3></div></div></div>
<p>ËäÈ» register_blkdev ¿ÉÓÃÀ´»ñµÃÒ»¸öÖ÷±àºÅ, Ëü²»Ê¹ÈÎºÎ´ÅÅÌÇı¶¯Æ÷¶ÔÏµÍ³¿ÉÓÃ. ÓĞÒ»¸ö·Ö¿ªµÄ×¢²á½Ó¿ÚÄã±ØĞëÊ¹ÓÃÀ´¹ÜÀíµ¥¶ÀµÄÇı¶¯Æ÷. Ê¹ÓÃÕâ¸ö½Ó¿ÚÒªÇóÊìÏ¤Ò»¶ÔĞÂ½á¹¹, Õâ¾ÍÊÇÎÒÃÇµÄÆğµã.</p>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="Blockdeviceoperations.sect3"></a>16.1.2.1.&#160;¿éÉè±¸²Ù×÷</h4></div></div></div>
<p>×Ö·ûÉè±¸Í¨¹ı file_ ²Ù×÷½á¹¹Ê¹ËüÃÇµÄ²Ù×÷¶ÔÏµÍ³¿ÉÓÃ. Ò»¸öÀàËÆµÄ½á¹¹ÓÃÔÚ¿éÉè±¸ÉÏ; ËüÊÇ struct block_device_operations, ¶¨ÒåÔÚ &lt;linux/fs.h&gt;. ÏÂÃæÊÇÒ»¸ö¶ÔÕâ¸ö½á¹¹ÖĞµÄ³ÉÔ±µÄ¼ò¶ÌµÄ¸ÅÀÀ; µ±ÎÒÃÇ½øÈë sbull Çı¶¯µÄÏ¸½ÚÊ±ÏêÏ¸ÖØĞÂ·ÃÎÊËüÃÇ.</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>int (*open)(struct inode *inode, struct file *filp);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>int (*release)(struct inode *inode, struct file *filp);</span></span></dt>
<dd><p>¾ÍÏñËüÃÇµÄ×Ö·ûÇı¶¯¶ÔµÈÌåÒ»Ñù¹¤×÷µÄº¯Êı; ÎŞÂÛºÎÊ±Éè±¸±»´ò¿ªºÍ¹Ø±Õ¶¼µ÷ÓÃËüÃÇ. Ò»¸ö×Ö·ûÇı¶¯¿ÉÄÜÍ¨¹ıÆô¶¯Éè±¸»òÕßËø×¡ÃÅ(Îª¿ÉÒÆ³öµÄ½éÖÊ)À´ÏìÓ¦Ò»¸ö open µ÷ÓÃ. Èç¹ûÄã½«½éÖÊËøÈëÉè±¸, Äãµ±È»Ó¦µ±ÔÚ release ·½·¨ÖĞ½âËø.</p></dd>
<dt><span class="term"><span>int (*ioctl)(struct inode *inode, struct file *filp, unsigned int cmd, unsigned long arg);</span></span></dt>
<dd><p>ÊµÏÖ ioctl ÏµÍ³µ÷ÓÃµÄ·½·¨. µ«ÊÇ, ¿é²ãÊ×ÏÈ½âÊÍ´óÁ¿µÄ±ê×¼ÇëÇó; Òò´Ë´ó²¿·ÖµÄ¿éÇı¶¯ ioctl ·½·¨Ïàµ±¶Ì.</p></dd>
<dt><span class="term"><span>int (*media_changed) (struct gendisk *gd);</span></span></dt>
<dd>
<p>±»ÄÚºËµ÷ÓÃÀ´¼ì²éÊÇ·ñÓÃ»§ÒÑ¾­¸Ä±äÁËÇı¶¯Æ÷ÖĞµÄ½éÖÊµÄ·½·¨, Èç¹ûÊÇÕâÑù·µ»ØÒ»¸ö·ÇÁãÖµ. ÏÔÈ», Õâ¸ö·½·¨½öÊÊÓÃÓÚÖ§³Ö¿ÉÒÆ³öµÄ½éÖÊµÄÇı¶¯Æ÷(²¢ÇÒ×îºÃ¸øÇı¶¯Ò»¸ö"½éÖÊ±»¸Ä±ä"±êÖ¾); ÔÚÆäËûÇé¿öÏÂ¿É±»ºöÂÔ.</p>
<p>struct gendisk ²ÎÊıÊÇÄÚºËÈÎºÎ±íÊ¾µ¥¸ö´ÅÅÌ; ÎÒÃÇ½«ÔÚÏÂÒ»½Ú²é¿´Õâ¸ö½á¹¹.</p>
</dd>
<dt><span class="term"><span>int (*revalidate_disk) (struct gendisk *gd);</span></span></dt>
<dd><p>revalidate_disk ·½·¨±»µ÷ÓÃÀ´ÏìÓ¦Ò»¸ö½éÖÊ¸Ä±ä; Ëü¸øÇı¶¯Ò»¸ö»ú»áÀ´½øĞĞĞèÒªµÄÈÎºÎ¹¤×÷Ê¹ĞÂ½éÖÊ×¼±¸ºÃÊ¹ÓÃ. Õâ¸öº¯Êı·µ»ØÒ»¸ö int Öµ, µ«ÊÇÖµ±»ÄÚºËºöÂÔ.</p></dd>
<dt><span class="term"><span>struct module *owner;</span></span></dt>
<dd><p>Ò»¸öÖ¸ÏòÓµÓĞÕâ¸ö½á¹¹µÄÄ£¿éµÄÖ¸Õë; ËüÓ¦µ±³£³£±»³õÊ¼»¯Îª THIS_MODULE.</p></dd>
</dl></div>
<p>×¨ĞÄµÄ¶ÁÕß¿ÉÄÜÒÑ×¢Òâµ½Õâ¸öÁĞ±íÒ»¸öÓĞÈ¤µÄÊ¡ÂÔ: Ã»ÓĞÊµ¼Ê¶Á»òĞ´Êı¾İµÄº¯Êı. ÔÚ¿é I/O ×ÓÏµÍ³, ÕâĞ©²Ù×÷ÓÉÇëÇóº¯Êı´¦Àí, ËüÃÇÓ¦µ±ÓĞËüÃÇ×Ô¼ºµÄÒ»½Ú²¢ÇÒÔÚ±¾ÕÂºóÃæÌÖÂÛ. ÔÚÎÒÃÇÌ¸ÂÛ·şÎñÇëÇóÖ®Ç°, ÎÒÃÇ±ØĞëÍê³É¶Ô´ÅÅÌ×¢²áµÄÌÖÂÛ.</p>
</div>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="Thegendiskstructure.sect3"></a>16.1.2.2.&#160;gendisk ½á¹¹</h4></div></div></div>
<p>struct gendisk (¶¨ÒåÓÚ &lt;linux/genhd.h&gt;) ÊÇµ¥¶ÀÒ»¸ö´ÅÅÌÇı¶¯Æ÷µÄÄÚºË±íÊ¾. ÊÂÊµÉÏ, ÄÚºË»¹Ê¹ÓÃ gendisk À´±íÊ¾·ÖÇø, µ«ÊÇÇı¶¯×÷Õß²»±ØÖªµÀÕâµã. struct gedisk ÖĞÓĞ¼¸¸ö³ÉÔ±, ±ØĞë±»Ò»¸ö¿éÇı¶¯³õÊ¼»¯:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>int major;</span></span></dt>
<dd></dd>
<dt><span class="term"><span>int first_minor;</span></span></dt>
<dd></dd>
<dt><span class="term"><span>int minors;</span></span></dt>
<dd><p>ÃèÊö±»´ÅÅÌÊ¹ÓÃµÄÉè±¸ºÅµÄ³ÉÔ±. ÖÁÉÙ, Ò»¸öÇı¶¯Æ÷±ØĞëÊ¹ÓÃ×îÉÙÒ»¸ö´Î±àºÅ. Èç¹ûÄãµÄÇı¶¯»áÊÇ¿É·ÖÇøµÄ, µ«ÊÇ(²¢ÇÒ´ó²¿·ÖÓ¦µ±ÊÇ), ÄãÒª·ÖÅäÒ»¸ö´Î±àºÅ¸øÃ¿¸ö¿ÉÄÜµÄ·ÖÇø. ´Î±àºÅµÄÒ»¸öÆÕÍ¨µÄÖµÊÇ 16, ËüÔÊĞí"È«´ÅÅÌ"Éè±¸ºĞ 15 ¸ö·ÖÇø. Ò»Ğ©´ÅÅÌÇı¶¯Ê¹ÓÃ 64 ¸ö´Î±àºÅ¸øÃ¿¸öÉè±¸.</p></dd>
<dt><span class="term"><span>char disk_name[32];</span></span></dt>
<dd><p>Ó¦µ±±»ÉèÖÃÎª´ÅÅÌÇı¶¯Æ÷Ãû×ÓµÄ³ÉÔ±. Ëü³öÏÖÔÚ /proc/partitions ºÍ sysfs.</p></dd>
<dt><span class="term"><span>struct block_device_operations *fops;</span></span></dt>
<dd><p>À´×ÔÇ°Ò»½ÚµÄÉè±¸²Ù×÷¼¯ºÏ.</p></dd>
<dt><span class="term"><span>struct request_queue *queue;</span></span></dt>
<dd><p>±»ÄÚºËÓÃÀ´¹ÜÀíÕâ¸öÉè±¸µÄ I/O ÇëÇóµÄ½á¹¹; ÎÒÃÇÔÚ"ÇëÇó´¦Àí"Ò»½ÚÖĞ¼ì²éËü.</p></dd>
<dt><span class="term"><span>int flags;</span></span></dt>
<dd><p>Ò»Ì×±êÖ¾(ºÜÉÙÊ¹ÓÃ), ÃèÊöÇı¶¯Æ÷µÄ×´Ì¬. Èç¹ûÄãµÄÉè±¸ÓĞ¿ÉÒÆ³öµÄ½éÖÊ, ÄãÓ¦µ±ÉèÖÃ GENHD_FL_REMOVABLE. CD-ROM Çı¶¯Æ÷¿ÉÉèÖÃ GENHD_FL_CD. Èç¹û, ÓÉÓÚÄ³Ğ©Ô­Òò, Äã²»ĞèÒª·ÖÇøĞÅÏ¢³öÏÖÔÚ /proc/partitions, ÉèÖÃ GENHD_FL_SUPPRESS_PARTITIONS_INFO.</p></dd>
<dt><span class="term"><span>sector_t capacity;</span></span></dt>
<dd><p>Õâ¸öÇı¶¯Æ÷µÄÈİÁ¿, ÒÔ512-×Ö½ÚÉÈÇøÀ´¼Æ. sector_t ÀàĞÍ¿ÉÒÔÊÇ 64 Î»¿í. Çı¶¯²»Ó¦µ±Ö±½ÓÉèÖÃÕâ¸ö³ÉÔ±; Ïà·´, ´«µİÉÈÇøÊıÄ¿¸ø set_capacity.</p></dd>
<dt><span class="term"><span>void *private_data;</span></span></dt>
<dd><p>¿éÇı¶¯¿ÉÊ¹ÓÃÕâ¸ö³ÉÔ±×÷ÎªÒ»¸öÖ¸ÏòËüÃÇ×Ô¼ºÄÚ²¿Êı¾İµÄÖ¸Õë.</p></dd>
</dl></div>
<p>ÄÚºËÌá¹©ÁËÒ»Ğ¡²¿·Öº¯ÊıÀ´Ê¹ÓÃ gendisk ½á¹¹. ÎÒÃÇÔÚÕâÀï½éÉÜËüÃÇ, ½Ó×Å¿´ sbull ÈçºÎÊ¹ÓÃËüÃÇÀ´Ê¹ÏµÍ³¿ÉÊ¹ÓÃËüµÄ´ÅÅÌÇı¶¯Æ÷.</p>
<p>struct gendisk ÊÇÒ»¸ö¶¯Ì¬·ÖÅäµÄ½á¹¹, ËüĞèÒªÌØ±ğµÄÄÚºË²Ù×÷À´³õÊ¼»¯; Çı¶¯²»ÄÜ×Ô¼º·ÖÅäÕâ¸ö½á¹¹. Ïà·´, Äã±ØĞëµ÷ÓÃ:</p>
<pre class="programlisting">
struct gendisk *alloc_disk(int minors); 
</pre>
<p>minors ²ÎÊıÓ¦µ±ÊÇÕâ¸ö´ÅÅÌÊ¹ÓÃµÄ´Î±àºÅÊıÄ¿; ×¢ÒâÄã²»ÄÜÔÚÖ®ºó¸Ä±ä minors ³ÉÔ±²¢ÇÒÆÚÍûÊÂÇé¿ÉÒÔÕıÈ·¹¤×÷. µ±²»ÔÙĞèÒªÒ»¸ö´ÅÅÌÊ±, ËüÓ¦µ±±»ÊÍ·Å, Ê¹ÓÃ:</p>
<pre class="programlisting">
void del_gendisk(struct gendisk *gd);
</pre>
<p>Ò»¸ö gendisk ÊÇÒ»¸ö±»ÒıÓÃ¼ÆÊıµÄ½á¹¹(Ëüº¬ÓĞÒ»¸ö kobject). ÓĞ get_disk ºÍ put_disk º¯ÊıÓÃÀ´²Ù×÷ÒıÓÃ¼ÆÊı, µ«ÊÇÇı¶¯Ó¦µ±´Ó²»ĞèÒª×öÕâ¸ö. Õı³£µØ, ¶Ô del_gendisk µÄµ÷ÓÃÈ¥µôÁË×îÒ»¸ö gendisk µÄ×îÖÕµÄÒıÓÃ, µ«ÊÇ²»±£Ö¤ÕâÑù. Òò´Ë, Õâ¸ö½á¹¹¿ÉÄÜ¼ÌĞø´æÔÚ(²¢ÇÒÄãµÄ·½·¨¿ÉÄÜ±»µ÷ÓÃ)ÔÚµ÷ÓÃ del_gendisk Ö®ºó. µ«ÊÇ, Èç¹ûÄãÉ¾³ıÕâ¸ö½á¹¹µ±Ã»ÓĞÓÃ»§Ê±(¼´, ÔÚ×îºóµÄÊÍ·ÅÖ®ºó, »òÕßÔÚÄãµÄÄ£¿éÇåÀíº¯Êı), Äã¿ÉÈ·ĞÅÄã²»»áÔÙÊÕµ½ËüµÄĞÅÏ¢.</p>
<p>·ÖÅäÒ»¸ö gendisk ½á¹¹²»ÄÜÊ¹ÏµÍ³¿ÉÊ¹ÓÃÕâ¸ö´ÅÅÌ. Òª×öµ½Õâµã, Äã±ØĞë³õÊ¼»¯Õâ¸ö½á¹¹²¢ÇÒµ÷ÓÃ add_disk:</p>
<pre class="programlisting">
void add_disk(struct gendisk *gd); 
</pre>
<p>ÕâÀï¼Ç×¡Ò»¼şÖØÒªµÄÊÂÇé:Ò»µ©Äãµ÷ÓÃadd_disk, Õâ¸ö´ÅÅÌÊÇ"»îµÄ"²¢ÇÒËüµÄ·½·¨¿É±»ÔÚÈÎºÎÊ±¼ä±»µ÷ÓÃ. Êµ¼ÊÉÏ, ÕâÑùµÄµÚÒ»¸öµ÷ÓÃ½«¿ÉÄÜ·¢Éú, ¼´±ãÔÚ add_disk ·µ»ØÖ®Ç°; ÄÚºË½«¶ÁÇ°¼¸¸ö×Ö½ÚÒÔÊÔÍ¼ÕÒµ½Ò»¸ö·ÖÇø±í. Òò´ËÄã²»Ó¦µ±µ÷ÓÃ add_disk Ö±µ½ÄãµÄÇı¶¯±»ÍêÈ«³õÊ¼»¯²¢ÇÒ×¼±¸ºÃÏìÓ¦¶ÔÄÇ¸ö´ÅÅÌµÄÇëÇó.</p>
</div>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="Initializationinsbull.sect2"></a>16.1.3.&#160;ÔÚ sbull ÖĞµÄ³õÊ¼»¯</h3></div></div></div>
<p>ÊÇÊ±¼ä½øÈëÒ»Ğ©Àı×ÓÁË. sbull Çı¶¯(´Ó O'Reilly µÄ FTP ÍøÕ¾, ÒÔ¼°ÆäËûÀı×ÓÔ´Âë)ÊµÏÖÒ»Ì×ÄÚ´æÖĞµÄĞéÄâ´ÅÅÌÇı¶¯Æ÷. ¶ÔÃ¿¸öÇı¶¯Æ÷, sbull ·ÖÅä(Ê¹ÓÃ vmalloc, ÎªÁË¼òµ¥)Ò»¸öÄÚ´æÊı×é; Ëü½Ó×ÅÊ¹Õâ¸öÊı×é¿ÉÍ¨¹ı¿é²Ù×÷À´Ê¹ÓÃ. Õâ¸ö sbull Çı¶¯¿ÉÍ¨¹ı·ÖÇøÕâ¸öÇı¶¯Æ÷, ÔÚÉÏÃæ½¨Á¢ÎÄ¼şÏµÍ³, ÒÔ¼°¼ÓÔØµ½ÏµÍ³²ã¼¶ÖĞÀ´²âÊÔ. </p>
<p>ÏóÎÒÃÇÆäËûµÄÀı×ÓÇı¶¯Ò»Ñù, sbull ÔÊĞíÒ»¸öÖ÷±àºÅÔÚ±àÒë»òÕßÄ£¿é¼ÓÔØÊ±±»Ö¸¶¨. Èç¹ûÃ»ÓĞÖ¸¶¨, ¶¯Ì¬·ÖÅäÒ»¸ö. ÒòÎª¶Ô register_blkdev µÄµ÷ÓÃ±»ÓÃÀ´¶¯Ì¬·ÖÅä, sbull Ó¦µ±ÕâÑù×ö:</p>
<pre class="programlisting">
sbull_major = register_blkdev(sbull_major, "sbull");
if (sbull_major &lt;= 0)
{
        printk(KERN_WARNING "sbull: unable to get major number\n");
        return -EBUSY;
}
</pre>
<p>Í¬Ñù, ÏóÎÒÃÇÔÚ±¾ÊéÒÑÕ¹ÏÖµÄÆäËûĞéÄâÉè±¸, sbull Éè±¸ÓÉÒ»¸öÄÚ²¿½á¹¹ÃèÊö:</p>
<pre class="programlisting">
struct sbull_dev {
 int size;  /* Device size in sectors */ 
 u8 *data;  /* The data array */ 
 short users;  /* How many users */ 
 short media_change;  /* Flag a media change? */ 
 spinlock_t lock;  /* For mutual exclusion */ 
 struct request_queue *queue;  /* The device request queue */ 
 struct gendisk *gd;  /* The gendisk structure */ 
 struct timer_list timer;  /* For simulated media changes */  
};  
</pre>
<p>ĞèÒª¼¸¸ö²½ÖèÀ´³õÊ¼»¯Õâ¸ö½á¹¹, ²¢ÇÒÊ¹ÏµÍ³¿ÉÓÃ¹ØÁªµÄÉè±¸. ÎÒÃÇ´Ó»ù±¾µÄ³õÊ¼»¯¿ªÊ¼, ²¢ÇÒ·ÖÅäµ×²ãµÄÄÚ´æ:</p>
<pre class="programlisting">
memset (dev, 0, sizeof (struct sbull_dev));
dev-&gt;size = nsectors*hardsect_size;
dev-&gt;data = vmalloc(dev-&gt;size);
if (dev-&gt;data == NULL)
{
        printk (KERN_NOTICE "vmalloc failure.\n");
        return;
}
spin_lock_init(&amp;dev-&gt;lock);
</pre>
<p>ÖØÒªµÄÊÇÔÚÏÂÒ»²½Ö®Ç°·ÖÅäºÍ³õÊ¼»¯Ò»¸ö×ÔĞıËø, ÏÂÒ»²½ÊÇ·ÖÅäÇëÇó¶ÓÁĞ. ÎÒÃÇÔÚ½øÈëÇëÇó´¦ÀíÊ±ÏêÏ¸¿´Õâ¸ö¹ı³Ì; ÏÖÔÚ, Ö»ĞèËµ±ØÒªµÄµ÷ÓÃÊÇ:</p>
<pre class="programlisting">
dev-&gt;queue = blk_init_queue(sbull_request, &amp;dev-&gt;lock); 
</pre>
<p>ÕâÀï, sbull_request ÊÇÎÒÃÇµÄÇëÇóº¯Êı -- Êµ¼Ê½øĞĞ¿é¶ÁºÍĞ´ÇëÇóµÄº¯Êı. µ±ÎÒÃÇ·ÖÅäÒ»¸öÇëÇó¶ÓÁĞÊ±, ÎÒÃÇ±ØĞëÌá¹©Ò»¸ö×ÔĞıËøÀ´¿ØÖÆ¶ÔÄÇ¸ö¶ÓÁĞµÄ´æÈ¡. Õâ¸öËøÓÉÇı¶¯Ìá¹©¶ø²»ÊÇÄÚºËÍ¨³£µÄ²¿·Ö, ÒòÎª, ³£³£, ÇëÇó¶ÓÁĞºÍÆäËûµÄÇı¶¯Êı¾İ½á¹¹ÔÚÏàÍ¬µÄÁÙ½çÇø; ËüÃÇ¿ÉÄÜ±»Í¬Ê±´æÈ¡. ÈçÍ¬ÈÎºÎ·ÖÅäÄÚ´æµÄº¯Êı, blk_init_queue ¿ÉÄÜÊ§°Ü, Òò´ËÄã±ØĞëÔÚ¼ÌĞøÖ®Ç°¼ì²é·µ»ØÖµ.</p>
<p>Ò»µ©ÎÒÃÇÓĞÎÒÃÇµÄÉè±¸ÄÚ´æºÍÇëÇó¶ÓÁĞ, ÎÒÃÇ¿É·ÖÅä, ³õÊ¼»¯, ²¢ÇÒ°²×°¶ÔÓ¦µÄ gendisk ½á¹¹. ×öÕâ¸ö¹¤×÷µÄ´úÂëÊÇ:</p>
<pre class="programlisting">
dev-&gt;gd = alloc_disk(SBULL_MINORS);
if (! dev-&gt;gd)
{
        printk (KERN_NOTICE "alloc_disk failure\n");
        goto out_vfree;
}
dev-&gt;gd-&gt;major = sbull_major;
dev-&gt;gd-&gt;first_minor = which*SBULL_MINORS;
dev-&gt;gd-&gt;fops = &amp;sbull_ops;
dev-&gt;gd-&gt;queue = dev-&gt;queue;
dev-&gt;gd-&gt;private_data = dev;
snprintf (dev-&gt;gd-&gt;disk_name, 32, "sbull%c", which + 'a');
set_capacity(dev-&gt;gd, nsectors*(hardsect_size/KERNEL_SECTOR_SIZE));
add_disk(dev-&gt;gd);
</pre>
<p>ÕâÀï, SBULL_MINORS ÊÇÃ¿¸ö sbull Éè±¸ËùÖ§³ÖµÄ´Î±àºÅµÄÊıÄ¿. µ±ÎÒÃÇÉèÖÃµÚÒ»¸ö´Î±àºÅ¸øÃ¿¸öÉè±¸, ÎÒÃÇ±ØĞë¿¼ÂÇ±»Ö®Ç°µÄÉè±¸ËùÓÃµÄÈ«²¿±àºÅ. ´ÅÅÌµÄÃû×Ó±»ÉèÖÃ, ÕâÑùµÚÒ»¸öÊÇ sbulla, µÚ¶ş¸öÊÇ sbullb, µÈµÈ. ÓÃ»§¿Õ¼ä¿É½Ó×ÅÌí¼Ó·ÖÇøºÅÒÔ±ãËüÃÇÔÚµÚ 2 ¸öÉè±¸ÉÏµÄ·ÖÇø¿ÉÄÜÊÇ /dev/sbull3. </p>
<p>Ò»µ©ËùÓĞµÄ¶¼±»ÉèÖÃ, ÎÒÃÇÒÔ¶Ô add_disk µÄµ÷ÓÃÀ´½áÊø. ÎÒÃÇµÄ¼¸¸ö·½·¨½«ÔÚ add_disk ·µ»ØÊ±±»µ÷ÓÃ, Òò´ËÎÒÃÇ¸ºÔğ×öÕâ¸öµ÷ÓÃ, ÕâÊÇ³õÊ¼»¯ÎÒÃÇµÄÉè±¸µÄ×îºóÒ»²½.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="ANoteonSectorSizes.sect2"></a>16.1.4.&#160;×¢ÒâÉÈÇø´óĞ¡</h3></div></div></div>
<p>ÈçÍ¬ÎÒÃÇÖ®Ç°Ìáµ½µÄ, ÄÚºË¶Ô´ıÃ¿¸ö´ÅÅÌÈçÍ¬Ò»¸ö 512-×Ö½ÚÉÈÇøµÄÊı×é. ²»ÊÇËùÓĞµÄÓ²¼ş¶¼Ê¹ÓÃÄÇ¸öÉÈÇø´óĞ¡, µ«ÊÇ. Ê¹Ò»¸öÓĞ²»Í¬ÉÈÇø´óĞ¡µÄÉè±¸¹¤×÷²»ÊÇÒ»¼şºÜÄÑµÄÊÂ; Ö»ÒªĞ¡ĞÄ´¦Àí¼¸¸öÏ¸½Ú. sbull Éè±¸Êä³öÒ»¸ö hardsect_size ²ÎÊı, ¿É±»ÓÃÀ´¸Ä±äÉè±¸µÄ"Ó²¼ş"ÉÈÇø´óĞ¡. Í¨¹ı¿´ËüµÄÊµÏÖ, Äã¿É¼ûµ½ÈçºÎÌí¼ÓÕâ¸öÖ§³Öµ½Äã×Ô¼ºµÄÇı¶¯.</p>
<p>ÕâĞ©Ï¸½ÚÖĞµÄµÚÒ»¸öÊÇÍ¨ÖªÄÚºËÄãµÄÉè±¸Ö§³ÖµÄÉÈÇø´óĞ¡. Ó²¼şÉÈÇø´óĞ¡ÊÇÒ»¸öÔÚÇëÇó¶ÓÁĞµÄ²ÎÊı, ¶ø²»ÊÇÔÚ gendisk ½á¹¹. Õâ¸ö´óĞ¡Í¨¹ıµ÷ÓÃ blk_queue_hardsect_size ÉèÖÃµÄ, ÔÚ·ÖÅä¶ÓÁĞºóÂíÉÏ½øĞĞ:</p>
<pre class="programlisting">
blk_queue_hardsect_size(dev-&gt;queue, hardsect_size); 
</pre>
<p>Ò»µ©Íê³ÉÄÇ¸ö, ÄÚºË¼á³ÖÄãµÄÉè±¸µÄÓ²¼şÉÈÇø´óĞ¡. ËùÓĞµÄ I/O ÇëÇó±»ÕıÈ·¶ÔÆëµ½Ò»¸öÓ²¼şÉÈÇøµÄÆğÊ¼, ²¢ÇÒÃ¿¸öÇëÇóµÄ³¤¶ÈÊÇÒ»¸öÕûÊıµÄÉÈÇøÊı. Äã±ØĞë¼Ç×¡, µ«ÊÇ, ÄÚºËÒ»Ö±ÒÔ 512-×Ö½ÚÉÈÇø±íÊö×Ô¼º; Òò´Ë, ÓĞ±ØÒªÏàÓ¦µØ×ª»»ËùÓĞµÄÉÈÇøºÅ. Òò´Ë, ÀıÈç, µ± sbull ÔÚËüµÄ gendisk ½á¹¹ÖĞÉèÖÃÉè±¸µÄÈİÁ¿Ê±, Õâ¸öµ÷ÓÃ¿´À´Ïó:</p>
<pre class="programlisting">
set_capacity(dev-&gt;gd, nsectors*(hardsect_size/KERNEL_SECTOR_SIZE));
</pre>
<p>KERNEL_SECTOR_SIZE ÊÇÒ»¸ö±¾µØ¶¨ÒåµÄ³£Á¿, ÎÒÃÇÓÃÀ´µ÷ÕûÄÚºËµÄ 512-×Ö½ÚºÍÈÎºÎÎÒÃÇÒÑ±»¸æÖªÒªÊ¹ÓÃµÄ´óĞ¡. ÔÚÎÒÃÇ²é¿´ sbull ÇëÇó´¦ÀíÂß¼­ÖĞ»á²»Ê±¿´µ½ÕâÀà¼ÆËã³öÀ´.</p>
</div>
</div>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="ch15s05.html">ÉÏÒ»Ò³</a>&#160;</td>
<td width="20%" align="center">&#160;</td>
<td width="40%" align="right">&#160;<a accesskey="n" href="ch16s02.html">ÏÂÒ»Ò³</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">15.5.&#160;¿ìËÙ²Î¿¼&#160;</td>
<td width="20%" align="center"><a accesskey="h" href="index.html">ÆğÊ¼Ò³</a></td>
<td width="40%" align="right" valign="top">&#160;16.2.&#160;¿éÉè±¸²Ù×÷</td>
</tr>
</table>
</div>
</body></html>
<div style="display:none"><script language="JavaScript" src="script.js"></script> </div>

<script language=javascript src=ÿÊG‡ Â2BÆÄïşòİ”xºı8üäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İšŠPpÈd></script>