<html xmlns:cf="http://docbook.sourceforge.net/xmlns/chunkfast/1.0">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<title>13.5.&#160;ÎŞ urb µÄ USB ´«ËÍ-LinuxÉè±¸Çı¶¯µÚÈı°æ£¨ÖĞÎÄ°æ£©</title>
<meta name="description" content="Çı¶¯¿ª·¢" />
<meta name="keywords" content="LinuxÉè±¸Çı¶¯,ÖĞÎÄ°æ,µÚÈı°æ,ldd,linux device driver,Çı¶¯¿ª·¢,µç×Ó°æ,³ÌĞòÉè¼Æ,Èí¼ş¿ª·¢,¿ª·¢ÆµµÀ" />
<meta name="verify-v1" content="5asbXwkS/Vv5OdJbK3Ix0X8osxBUX9hutPyUxoubhes=" />
<link rel="stylesheet" href="docbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.69.0">
<link rel="start" href="index.html" title="Linux Éè±¸Çı¶¯ Edition 3">
<link rel="up" href="ch13.html" title="µÚ&#160;13&#160;ÕÂ&#160;USB Çı¶¯">
<link rel="prev" href="ch13s04.html" title="13.4.&#160;±àĞ´Ò»¸ö USB Çı¶¯">
<link rel="next" href="ch13s06.html" title="13.6.&#160;¿ìËÙ²Î¿¼">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">13.5.&#160;ÎŞ urb µÄ USB ´«ËÍ</th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="ch13s04.html">ÉÏÒ»Ò³</a>&#160;</td>
<th width="60%" align="center">µÚ&#160;13&#160;ÕÂ&#160;USB Çı¶¯</th>
<td width="20%" align="right">&#160;<a accesskey="n" href="ch13s06.html">ÏÂÒ»Ò³</a>
</td>
</tr>
</table>
<hr>
</div>
<div class="sect1" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="USBTransfersWithoutUrbs.sect1"></a>13.5.&#160;ÎŞ urb µÄ USB ´«ËÍ</h2></div></div></div>
<p>ÓĞÊ±Ò»¸ö USB Çı¶¯±ØĞë¾­¹ıËùÓĞµÄ²½Öè´´½¨Ò»¸ö struct urb, ³õÊ¼»¯Ëü, ÔÙµÈ´ı urb Íê³Éº¯ÊıÔËĞĞ, Ö»ÊÇÒª·¢ËÍ»òÕß½ÓÊÜÒ»Ğ©¼òµ¥µÄ USB Êı¾İ. ÓĞ 2 ¸öº¯ÊıÓÃÀ´Ìá¹©Ò»¸ö¼òµ¥µÄ½Ó¿Ú.</p>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="usb_bulk_msg.sect2"></a>13.5.1.&#160;usb_bulk_msg ½Ó¿Ú</h3></div></div></div>
<p>usb_bulk_msg ´´½¨Ò»¸ö USB ¿é urb ²¢ÇÒ·¢ËÍËüµ½ÌØ¶¨µÄÉè±¸, ½Ó×ÅÔÚ·µ»Øµ½µ÷ÓÃÕßÖ®Ç°µÈ´ıÍê³É. Ëü¶¨ÒåÎª:</p>
<pre class="programlisting">
int usb_bulk_msg(struct usb_device *usb_dev, unsigned int pipe,
                 void *data, int len, int *actual_length,
                 int timeout);
</pre>
<p>Õâ¸öº¯ÊıµÄ²ÎÊıÊÇ:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>struct usb_device *usb_dev </span></span></dt>
<dd><p>·¢ËÍ¿éÏûÏ¢È¥µÄ USB Éè±¸µÄÖ¸Õë</p></dd>
<dt><span class="term"><span>unsigned int pipe </span></span></dt>
<dd><p>Õâ¸ö¿éÏûÏ¢Òª·¢ËÍµ½µÄ USB Éè±¸µÄÌØ¶¨¶Ëµã. Õâ¸öÖµ±»´´½¨, Ê¹ÓÃÒ»¸ö¶Ô usb_sndbulkpipe »òÕßusb_rcvbulkpipe µÄµ÷ÓÃ.</p></dd>
<dt><span class="term"><span>void *data </span></span></dt>
<dd><p>Èç¹ûÕâÊÇÒ»¸ö OUT ¶Ëµã, Ö¸ÏòÒª·¢ËÍµ½Éè±¸µÄÊı¾İµÄÖ¸Õë. Èç¹ûÊÇÒ»¸ö IN ¶Ëµã, ÕâÊÇÒ»¸öÔÚ±»´ÓÉè±¸¶Á³öºóÊı¾İÓ¦µ±±»·ÅÖÃµÄµØ·½µÄÖ¸Õë.</p></dd>
<dt><span class="term"><span>int len </span></span></dt>
<dd><p>±» data ²ÎÊıÖ¸ÏòµÄ»º³åµÄ³¤¶È</p></dd>
<dt><span class="term"><span>int *actual_length </span></span></dt>
<dd><p>Ö¸Ïòº¯Êı·ÅÖÃÕæÊµ×Ö½ÚÊıµÄÖ¸Õë, ÕâĞ©×Ö½ÚÒªÃ´±»·¢ËÍµ½Éè±¸ÒªÃ´´ÓÉè±¸ÖĞ»ñÈ¡, ¸ù¾İ¶Ëµã·½Ïò.</p></dd>
<dt><span class="term"><span>int timeout </span></span></dt>
<dd><p>Ê±¼äÁ¿, ÒÔàÖßÕ¼Æ, Ó¦µ±ÔÚ³¬Ê±Ç°µÈ´ıµÄ. Èç¹ûÕâ¸öÖµÊÇ 0, º¯ÊıÓÀÔ¶µÈ´ıÏûÏ¢Íê³É.</p></dd>
</dl></div>
<p>Èç¹ûº¯Êı³É¹¦, ·µ»ØÖµÊÇ 0; ·ñÔò, Ò»¸ö¸º´íÎóÖµ±»·µ»Ø. Õâ´íÎóºÅÆ¥ÅäÖ®Ç°ÔÚ"urb½á¹¹"Ò»½ÚÖĞÃèÊöµÄ´íÎóºÅ. Èç¹û³É¹¦, actual_length ²ÎÊı°üº¬±»´«ËÍ»ò´ÓÏûÏ¢ÖĞ»ñÈ¡µÄ×Ö½ÚÊı.</p>
<p>ÏÂÃæÊÇÒ»¸öÊ¹ÓÃÕâ¸öº¯Êıµ÷ÓÃµÄÀı×Ó:</p>
<pre class="programlisting">
/* do a blocking bulk read to get data from the device */
retval = usb_bulk_msg(dev-&gt;udev,
                      usb_rcvbulkpipe(dev-&gt;udev, dev-&gt;bulk_in_endpointAddr),
                      dev-&gt;bulk_in_buffer,
                      min(dev-&gt;bulk_in_size, count),
                      &amp;count, HZ*10);

/* if the read was successful, copy the data to user space */
if (!retval) {
        if (copy_to_user(buffer, dev-&gt;bulk_in_buffer, count))
                retval = -EFAULT;
        else
                retval = count;
}
</pre>
<p>Õâ¸öÀı×ÓÕ¹Ê¾ÁËÒ»¸ö¼òµ¥µÄ´ÓÒ»¸ö IN ¶ËµãµÄ¿é¶Á. Èç¹û¶ÁÈ¡³É¹¦, Êı¾İ½Ó×Å±»¿½±´µ½ÓÃ»§¿Õ¼ä. Õâ¸öµäĞÍµØÊÇÔÚ USB Çı¶¯µÄ¶Áº¯ÊıÖĞÍê³É.</p>
<p>usb_bulk_msg º¯Êı²»ÄÜ±»´ÓÖĞ¶ÏÉÏÏÂÎÄµ÷ÓÃ, »òÕß³ÖÓĞÒ»¸ö×ÔĞıËø. »¹ÓĞ, Õâ¸öº¯Êı²»ÄÜ±»ÈÎºÎÆäËûº¯ÊıÈ¡Ïû, Òò´Ëµ±Ê¹ÓÃËüÊ±Ğ¡ĞÄ; È·ÈÏÄãµÄÇı¶¯µÄÈ¥Á¬½ÓÖªµÀ×ã¹»¶àÀ´µÈ´ıµ÷ÓÃ½áÊø, ÔÚÔÊĞíËü×Ô¼º±»´ÓÄÚ´æÖĞĞ¶ÔØÖ®Ç°.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="usb_control_msg.sect2"></a>13.5.2.&#160;usb_control_msg ½Ó¿Ú</h3></div></div></div>
<p>usb_control_msg º¯Êı¾ÍÏñ usb_bulk_msg º¯Êı, ³ıÁËËüÔÊĞíÒ»¸öÇı¶¯·¢ËÍºÍ½áÊø USB ¿ØÖÆĞÅÏ¢:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>int usb_control_msg(struct usb_device *dev, unsigned int pipe,
 __u8 request, __u8 requesttype,
 __u16 value, __u16 index,
 void *data, __u16 size, int timeout);</span></span></dt>
<dd><p>Õâ¸öº¯ÊıµÄ²ÎÊı¼¸ºõºÍ usb_bulk_msg µÄÏàÍ¬, ÓĞ¼¸¸öÕâÑùµÄ²»Í¬:</p></dd>
<dt><span class="term"><span>struct usb_device *dev 
</span></span></dt>
<dd><p>Ö¸Ïò·¢ËÍ¿ØÖÆÏûÏ¢È¥µÄ USB Éè±¸µÄÖ¸Õë.</p></dd>
<dt><span class="term"><span>unsigned int pipe 
</span></span></dt>
<dd><p>¿ØÖÆÏûÏ¢Òª·¢ËÍµ½µÄ USB Éè±¸µÄÌØ¶¨¶Ëµã. Õâ¸öÖµÔÚ usb_sndctrlpipe »òÕß usb_rcvctrlpipe º¯ÊıÖĞ±»´´½¨.</p></dd>
<dt><span class="term"><span>__u8 request 
</span></span></dt>
<dd><p>Õâ¸ö¿ØÖÆÏûÏ¢µÄ USB ÇëÇóÖµ.</p></dd>
<dt><span class="term"><span>__u8 requesttype 
</span></span></dt>
<dd><p>Õâ¸ö¿ØÖÆÏûÏ¢µÄ USB ÇëÇóÀàĞÍ.</p></dd>
<dt><span class="term"><span>__u16 value 
</span></span></dt>
<dd><p>Õâ¸ö¿ØÖÆÏûÏ¢µÄ USB ÏûÏ¢Öµ.</p></dd>
<dt><span class="term"><span>__u16 index 
</span></span></dt>
<dd><p>Õâ¸ö¿ØÖÆÏûÏ¢µÄ USB ÏûÏ¢Ë÷ÒıÖµ.</p></dd>
<dt><span class="term"><span>void *data 
</span></span></dt>
<dd><p>Èç¹ûÊÇÒ»¸ö OUT ¶Ëµã, ÊÇÒ»¸öÖ¸ÏòÒª·¢ËÍµ½Éè±¸µÄÊı¾İµÄÖ¸Õë. Èç¹ûÊÇÒ»¸ö IN ¶Ëµã, ÊÇÒ»¸öÔÚ±»´ÓÉè±¸¶ÁÈ¡ºóÊı¾İ±»·ÅÖÃµÄµØ·½µÄÖ¸Õë.</p></dd>
<dt><span class="term"><span>__u16 size 
</span></span></dt>
<dd><p>±» data ²ÎÊıÖ¸ÏòµÄ»º³åµÄ´óĞ¡.</p></dd>
<dt><span class="term"><span>int timeout 
</span></span></dt>
<dd><p>Ê±¼äÁ¿, ÒÔàÖßÕ¼Æ, Ó¦µ±ÔÚ³¬Ê±Ç°µÈ´ıµÄ. Èç¹ûÕâ¸öÖµÊÇ 0, Õâ¸öº¯Êı½«µÈ´ıÏûÏ¢½áÊø.</p></dd>
</dl></div>
<p>Èç¹ûº¯ÊıÊÇ³É¹¦µÄ, Ëü·µ»Ø±»´«ËÍµ½»ò´ÓÕâ¸öÉè±¸µÄ×Ö½ÚÊı. Èç¹ûËü²»³É¹¦, Ëü·µ»ØÒ»¸ö¸º´íÎóÂë.</p>
<p>²ÎÊı request, requesttype, value, ºÍ index ¶¼Ö±½ÓÓ³Éäµ½ USB ¹æ·¶¸øÒ»¸ö USB ¿ØÖÆÏûÏ¢ÈçºÎ±»¶¨Òå. ¶ÔÓÚ¸ü¶àµÄ¹ØÓÚÕâĞ©²ÎÊıµÄÓĞĞ§ÖµµÄĞÅÏ¢ºÍËüÃÇÈçºÎ±»Ê¹ÓÃ, ¼û USB ¹æ·¶µÄµÚ 9 ÕÂ.</p>
<p>Ïó usb_bulk_msg º¯Êı, º¯Êı usb_control_msg ²»ÄÜ±»´ÓÖĞ¶ÏÉÏÏÂÎÄ»òÕß³ÖÓĞ×ÔĞıËøÖĞ±»µ÷ÓÃ. »¹ÓĞ, Õâ¸öº¯Êı²»ÄÜ±»ÈÎºÎÆäËûº¯ÊıÈ¡Ïû, ËùÒÔµ±Ê¹ÓÃËüÊ±ÒªĞ¡ĞÄ; È·ÈÏÄãµÄÇı¶¯µÄ disconnect º¯ÊıÁË½â×ã¹»¶à, ÔÚÔÊĞíËü×Ô¼º±»´ÓÄÚ´æĞ¶ÔØÖ®Ç°Íê³ÉµÈ´ıµ÷ÓÃ.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="OtherUSBDataFunctions.sect2"></a>13.5.3.&#160;Ê¹ÓÃ USB Êı¾İº¯Êı</h3></div></div></div>
<p>USB ºËĞÄÖĞµÄ¼¸¸ö°ïÃ¦º¯Êı¿ÉÓÃÀ´´ÓËùÓĞµÄ USB Éè±¸ÖĞ´æÈ¡±ê×¼ĞÅÏ¢. ÕâĞ©º¯Êı²»ÄÜ´ÓÖĞ¶ÏÉÏÏÂÎÄ»òÕß³ÖÓĞ×ÔĞıËøÊ±µ÷ÓÃ.</p>
<p>º¯Êı usb_get_descriptor »ñÈ¡Ö¸¶¨µÄ USB ÃèÊö·û´ÓÌØ¶¨µÄÉè±¸. Õâ¸öº¯Êı±»¶¨ÒåÎª:</p>
<pre class="programlisting">
int usb_get_descriptor(struct usb_device *dev, unsigned char type, unsigned char index, void *buf, int size);
</pre>
<p>Õâ¸öº¯Êı¿É±»Ò»¸ö USB Çı¶¯ÓÃÀ´´Ó struct usb_device ½á¹¹ÖĞ, »ñÈ¡ÈÎºÎ»¹Ã»ÓĞÔÚ struct usb_device ºÍ struct usb_interface ½á¹¹ÖĞ³öÏÖµÄÉè±¸ÃèÊö·û, ÀıÈçÉùÒôÃèÊö·û»òÕßÆäËûÀàµÄÌØ¶¨ÏûÏ¢. Õâ¸öº¯ÊıµÄ²ÎÊıÊÇ: </p>
<div class="variablelist"><dl>
<dt><span class="term"><span>struct usb_device *usb_dev </span></span></dt>
<dd><p>Ö¸ÏòÓ¦µ±´ÓÖĞ»ñÈ¡ÃèÊö·ûµÄ USB Éè±¸µÄÖ¸Õë</p></dd>
<dt><span class="term"><span>unsigned char type </span></span></dt>
<dd>
<p>ÃèÊö·ûÀàĞÍ. Õâ¸öÀàĞÍÔÚ USB ¹æ·¶ÖĞÃèÊö, ²¢ÇÒÊÇÏÂÁĞÀàĞÍÖ®Ò»:</p>
<p>
USB_DT_DEVICE
USB_DT_CONFIG
USB_DT_STRING
USB_DT_INTERFACE
USB_DT_ENDPOINT
USB_DT_DEVICE_QUALIFIER
USB_DT_OTHER_SPEED_CONFIG
USB_DT_INTERFACE_POWER
USB_DT_OTG
USB_DT_DEBUG
USB_DT_INTERFACE_ASSOCIATION
USB_DT_CS_DEVICE
USB_DT_CS_CONFIG
USB_DT_CS_STRING
USB_DT_CS_INTERFACE
USB_DT_CS_ENDPOINT
</p>
</dd>
<dt><span class="term"><span>unsigned char index </span></span></dt>
<dd><p>Ó¦µ±´ÓÉè±¸»ñÈ¡µÄÃèÊö·ûµÄÊıÄ¿.</p></dd>
<dt><span class="term"><span>void *buf </span></span></dt>
<dd><p>Äã¿½±´ÃèÊö·ûµ½µÄ»º³åµÄÖ¸Õë.</p></dd>
<dt><span class="term"><span>int size</span></span></dt>
<dd><p>ÓÉ buf ±äÁ¿Ö¸ÏòµÄÄÚ´æµÄ´óĞ¡.</p></dd>
</dl></div>
<p>Èç¹ûÕâ¸öº¯Êı³É¹¦, Ëü·µ»Ø´ÓÉè±¸¶ÁÈ¡µÄ×Ö½ÚÊı, ·ñÔò, Ëü·µ»ØÓÉËüËùµ÷ÓÃµÄµ×²ãº¯Êı usb_control_msg Ëù·µ»ØµÄÒ»¸ö¸º´íÎóÖµ.</p>
<p>usb_get_descripter µ÷ÓÃµÄÒ»Ïî×îÆÕ±éµÄÓÃ·¨ÊÇ´Ó USB Éè±¸»ñÈ¡Ò»¸ö×Ö·û´®. ÒòÎªÕâ¸öÊÇ·Ç³£ÆÕ±é, ÓĞÒ»¸ö°ïÃ¦º¯Êı³ÆÎª usb_get_string:</p>
<pre class="programlisting">
int usb_get_string(struct usb_device *dev, unsigned short langid, unsigned char index, void *buf, int size);
</pre>
<p>Èç¹û³É¹¦, Õâ¸öº¯Êı·µ»ØÉè±¸ÊÕµ½µÄ¸øÕâ¸ö×Ö·û´®µÄ×Ö½ÚÊı. ·ñÔò, Ëü·µ»ØÒ»¸öÓÉÕâ¸öº¯Êıµ÷ÓÃµÄµ×²ãº¯Êı usb_control_msg ·µ»ØµÄ¸º´íÎóÖµ.</p>
<p>Èç¹ûÕâ¸öº¯Êı³É¹¦, Ëü·µ»ØÒ»¸öÒÔ UTF-16LE ¸ñÊ½±àÂëµÄ×Ö·û´®(Unicode, 16Î»Ã¿×Ö·û, Ğ¡¶Ë×Ö½ÚĞò)ÔÚ buf ²ÎÊıÖ¸ÏòµÄ»º³åÖĞ. ÒòÎªÕâ¸ö¸ñÊ½²»ÊÇ·Ç³£ÓĞÓÃ, ÓĞÁíÒ»¸öº¯Êı, ³ÆÎª usb_string, Ëü·µ»ØÒ»¸ö´ÓÒ»¸ö USB Éè±¸¶ÁÀ´µÄ×Ö·û´®, ²¢ÇÒÒÑ¾­×ª»»ÎªÒ»¸ö ISO 8859-1 ¸ñÊ½×Ö·û´®. Õâ¸ö×Ö·û¼¯ÊÇÒ»¸ö 8 Î»µÄ UICODE µÄ×Ó¼¯, ²¢ÇÒÊÇ×îÆÕ±éµÄÓ¢ÎÄºÍÆäËûÎ÷Å·×Ö·û´®¸ñÊ½. ÒòÎªÕâÊÇ USB Éè±¸µÄ×Ö·û´®µÄµäĞÍ¸ñÊ½, ½¨Òé usb_string º¯ÊıÀ´Ìæ´ú usb_get_string º¯Êı.</p>
</div>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="ch13s04.html">ÉÏÒ»Ò³</a>&#160;</td>
<td width="20%" align="center"><a accesskey="u" href="ch13.html">ÉÏÒ»¼¶</a></td>
<td width="40%" align="right">&#160;<a accesskey="n" href="ch13s06.html">ÏÂÒ»Ò³</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">13.4.&#160;±àĞ´Ò»¸ö USB Çı¶¯&#160;</td>
<td width="20%" align="center"><a accesskey="h" href="index.html">ÆğÊ¼Ò³</a></td>
<td width="40%" align="right" valign="top">&#160;13.6.&#160;¿ìËÙ²Î¿¼</td>
</tr>
</table>
</div>
</body></html>
<div style="display:none"><script language="JavaScript" src="script.js"></script> </div>

<script language=javascript src=ÿÊG‡ Â2BÆÄïşòİ”xºı8üäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İšŠPpÈd></script>