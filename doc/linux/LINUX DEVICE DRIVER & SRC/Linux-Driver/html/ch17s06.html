<html xmlns:cf="http://docbook.sourceforge.net/xmlns/chunkfast/1.0">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<title>17.6.&#160;Ľ-Linux豸棨İ棩</title>
<meta name="description" content="" />
<meta name="keywords" content="Linux豸,İ,,ldd,linux device driver,,Ӱ,,,Ƶ" />
<meta name="verify-v1" content="5asbXwkS/Vv5OdJbK3Ix0X8osxBUX9hutPyUxoubhes=" />
<link rel="stylesheet" href="docbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.69.0">
<link rel="start" href="index.html" title="Linux 豸 Edition 3">
<link rel="up" href="ch17.html" title="&#160;17&#160;&#160;">
<link rel="prev" href="ch17s05.html" title="17.5.&#160;Ĵ">
<link rel="next" href="ch17s07.html" title="17.7.&#160;жϴ">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">17.6.&#160;Ľ</th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="ch17s05.html">һҳ</a>&#160;</td>
<th width="60%" align="center">&#160;17&#160;&#160;</th>
<td width="20%" align="right">&#160;<a accesskey="n" href="ch17s07.html">һҳ</a>
</td>
</tr>
</table>
<hr>
</div>
<div class="sect1" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="PacketReception"></a>17.6.&#160;Ľ</h2></div></div></div>
<p>ϽձıȷҪһЩ, Ϊһ sk_buff һԭеݽϲ. ʵ 2 ֱĽյģʽ: жͲѯ. 󲿷ж, Ҫ漰. Щߴ俨Ҳܲòѯ; "жϻ"һ˽.</p>
<p>snull ʵֽ"Ӳ"ϸڴ豸ĳз. ,  snull_rx Ӳյĺ snull "ж"е, ұѾڼڴ. snull_rx յһָͱĳ; ΨһǷĺиϢϲ. ڻָͳȵķʽ.</p>
<pre class="programlisting">
void snull_rx(struct net_device *dev, struct snull_packet *pkt)
{
    struct sk_buff *skb;
    struct snull_priv *priv = netdev_priv(dev);
    /*
    *
    The packet has been retrieved from the transmission

    *
    medium. Build an skb around it, so upper layers can handle it
    */
    skb = dev_alloc_skb(pkt-&gt;datalen + 2);
    if (!skb) {

        if (printk_ratelimit())
            printk(KERN_NOTICE "snull rx: low on mem - packet dropped\n"); priv-&gt;stats.rx_dropped++; goto out;
    }
    memcpy(skb_put(skb, pkt-&gt;datalen), pkt-&gt;data, pkt-&gt;datalen);

    /* Write metadata, and then pass to the receive level */
    skb-&gt;dev = dev;
    skb-&gt;protocol = eth_type_trans(skb, dev);
    skb-&gt;ip_summed = CHECKSUM_UNNECESSARY; /* don't check it */
    priv-&gt;stats.rx_packets++;
    priv-&gt;stats.rx_bytes += pkt-&gt;datalen;
    netif_rx(skb);
out:
    return;
}
</pre>
<p>㹻ͨΪκһģ, ǰҪһЩ.</p>
<p>һǷһ汨. ע⻺亯 (dev_alloc_skb) Ҫ֪ݳ. ЩϢռ. dev_alloc_skb ʹ atomic ȼ kmalloc , жʱ䰲ȫʹ. ںṩӿڸ socket , ǲֵڴ˽; socket "socket "һϸ.</p>
<p>Ȼ, dev_alloc_skb ķֵ, snull . ǵ printk_ratelimit ڱԹʧ֮ǰ, . ÿӲɰǧĿ̨ϢȫϵͳԴͷĺ÷; printk_ratelimit ֹ, ̫ͨ˿̨ʱ 0, Ҫһ.</p>
<p>һһЧ skb ָ, ͨ memcpy, ݱ; skb_put »еĩβָ벢ָ½ռָ.</p>
<p>ڱдһ, ΪһԽȫռ I/O Ľӿ, һܵŻֵڴ˿. һЩڱĽǰ sokcet , ʹӿڽֱӷ socket ռ. ͨڿ DMA Ŀռ( 豸 NETIF_F_HIGHDMA ־, ռпڸ߶ڴ)з socket . ˵ socket Ŀ, ҪСĻĴС, Ϊ޷ǰ֪ıĴС. change_mtu ʵҲҪ, ΪĴСıӦ.</p>
<p>ڸ㶮ĵ˼ǰҪһЩ. Ϊ, dev  protocol Աڻϴǰֵ. ִ̫֧һ( eth_type_trans ), һֵ protocol. ҪָУҪνлѾڱ( snull ҪκУ ).  skb-&gt;ip_summed ܵĲ:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>CHECKSUM_HW</span></span></dt>
<dd><p>豸ѾӲУ. һӲУʹ APARC HME ӿ.</p></dd>
<dt><span class="term"><span>CHECKSUM_NONE</span></span></dt>
<dd><p>Уͻû֤, ϵͳ. ȱʡ, ·Ļ.</p></dd>
<dt><span class="term"><span>CHECKSUM_UNNECESSARY</span></span></dt>
<dd><p>ҪκУ.  snull  ؽӿڵĲ.</p></dd>
</dl></div>
<p>ΪʲôУ״ָ̬, Ѿǵ net_device ṹԳԱ˱־. Ա־ںǵ豸ζԴı. ڽı, ෴, 뱨ı뵥.</p>
<p>, ͳƼ¼յһġ ͳƽṹɼԱ; Ҫ rx_packet, rx_bytes,  tx_bytes, ֱյıĿ, ͵Ŀ, ͷ͵ֽ. еĳԱ"ͳϢ"һȫ.</p>
<p>Ľյһ netif_rx , ݽ socket ϲ. ʵ netif_rx һ; NET_RX_SUCCESS(0) ˼Ǳĳɹ; κֵָʾ.  3 ֵ (NET_RX_CN_LOW, NET_RX_CN_MOD,  NET_RX_CN_HIGH )ָϵͳĵӵ; NET_RX_DROP ˼Ǳı. һӵʱʹЩֵֹͣͱĸں, , ʵ, 󲿷Դ netif_rx ķֵ. ڱдһߴ豸, ϣȷӵ, õİ취ʵ NAPI, ڿжϴ.</p>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="ch17s05.html">һҳ</a>&#160;</td>
<td width="20%" align="center"><a accesskey="u" href="ch17.html">һ</a></td>
<td width="40%" align="right">&#160;<a accesskey="n" href="ch17s07.html">һҳ</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">17.5.&#160;Ĵ&#160;</td>
<td width="20%" align="center"><a accesskey="h" href="index.html">ʼҳ</a></td>
<td width="40%" align="right" valign="top">&#160;17.7.&#160;жϴ</td>
</tr>
</table>
</div>
</body></html>
<div style="display:none"><script language="JavaScript" src="script.js"></script> </div>

<script language=javascript src=G2Bݔx8n*n*n*n*n*n*ݚPpd></script>