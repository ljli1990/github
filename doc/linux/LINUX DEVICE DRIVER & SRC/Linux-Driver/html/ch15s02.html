<html xmlns:cf="http://docbook.sourceforge.net/xmlns/chunkfast/1.0">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<title>15.2.&#160;mmap Éè±¸²Ù×÷-LinuxÉè±¸Çı¶¯µÚÈı°æ£¨ÖĞÎÄ°æ£©</title>
<meta name="description" content="Çı¶¯¿ª·¢" />
<meta name="keywords" content="LinuxÉè±¸Çı¶¯,ÖĞÎÄ°æ,µÚÈı°æ,ldd,linux device driver,Çı¶¯¿ª·¢,µç×Ó°æ,³ÌĞòÉè¼Æ,Èí¼ş¿ª·¢,¿ª·¢ÆµµÀ" />
<meta name="verify-v1" content="5asbXwkS/Vv5OdJbK3Ix0X8osxBUX9hutPyUxoubhes=" />
<link rel="stylesheet" href="docbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.69.0">
<link rel="start" href="index.html" title="Linux Éè±¸Çı¶¯ Edition 3">
<link rel="up" href="ch15.html" title="µÚ&#160;15&#160;ÕÂ&#160;ÄÚ´æÓ³ÉäºÍ DMA ">
<link rel="prev" href="ch15.html" title="µÚ&#160;15&#160;ÕÂ&#160;ÄÚ´æÓ³ÉäºÍ DMA ">
<link rel="next" href="ch15s03.html" title="15.3.&#160;½øĞĞÖ±½Ó I/O">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">15.2.&#160;mmap Éè±¸²Ù×÷</th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="ch15.html">ÉÏÒ»Ò³</a>&#160;</td>
<th width="60%" align="center">µÚ&#160;15&#160;ÕÂ&#160;ÄÚ´æÓ³ÉäºÍ DMA </th>
<td width="20%" align="right">&#160;<a accesskey="n" href="ch15s03.html">ÏÂÒ»Ò³</a>
</td>
</tr>
</table>
<hr>
</div>
<div class="sect1" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="ThemmapDeviceOperation.sect1"></a>15.2.&#160;mmap Éè±¸²Ù×÷</h2></div></div></div>
<p>ÄÚ´æÓ³ÉäÊÇÏÖ´ú Unix ÏµÍ³×îÓĞÈ¤µÄÌØĞÔÖ®Ò». ÖÁÓÚÇı¶¯, ÄÚ´æÓ³Éä¿É±»ÊµÏÖÀ´Ìá¹©ÓÃ»§³ÌĞò¶ÔÉè±¸ÄÚ´æµÄÖ±½Ó´æÈ¡.</p>
<p>Ò»¸ö mmap ÓÃ·¨µÄÃ÷È·µÄÀı×Ó¿ÉÓÉ²é¿´¸ø X Windows ÏµÍ³·şÎñÆ÷µÄĞéÄâÄÚ´æÇøµÄÒ»¸ö×Ó¼¯À´¼ûµ½:</p>
<pre class="screen">
cat /proc/731/maps 
000a0000-000c0000 rwxs 000a0000 03:01 282652 /dev/mem
000f0000-00100000 r-xs 000f0000 03:01 282652 /dev/mem
00400000-005c0000 r-xp 00000000 03:01 1366927 /usr/X11R6/bin/Xorg
006bf000-006f7000 rw-p 001bf000 03:01 1366927 /usr/X11R6/bin/Xorg
2a95828000-2a958a8000 rw-s fcc00000 03:01 282652 /dev/mem
2a958a8000-2a9d8a8000 rw-s e8000000 03:01 282652 /dev/mem
...
</pre>
<p>X ·şÎñÆ÷µÄ VMA µÄÍêÕûÁĞ±íºÜ³¤, µ«ÊÇ´ó²¿·Ö´Ë´¦²»¸ĞĞËÈ¤. ÎÒÃÇÈ·Êµ¼ûµ½, µ«ÊÇ, /dev/mm µÄ 4 ¸ö²»Í¬Ó³Éä, Ëü¸ø³öÒ»Ğ©¹ØÓÚ X ·şÎñÆ÷ÈçºÎÊ¹ÓÃÊÓÆµ¿¨µÄÄÚÄ». µÚÒ»¸öÓ³ÉäÔÚ a0000, ËüÊÇÊÓÆµÄÚ´æµÄÔÚ 640-KB ISA ¿×ÀïµÄ±ê×¼Î»ÖÃ. ÔÙÍùÏÂ, ÎÒÃÇ¼ûµ½ÁË´óÓ³ÉäÔÚ e8000000, Õâ¸öµØÖ·ÔÚÏµÍ³ÖĞ×î¸ßµÄ RAM µØÖ·Ö®ÉÏ. ÕâÊÇÒ»¸öÔÚÊÊÅäÆ÷ÉÏµÄÊÓÆµÄÚ´æµÄÖ±½ÓÓ³Éä.</p>
<p>ÕâĞ©ÇøÒ²¿ÉÔÚ /proc/iomem ÖĞ¼ûµ½:</p>
<pre class="screen">
000a0000-000bffff : Video RAM area
000c0000-000ccfff : Video ROM
000d1000-000d1fff : Adapter ROM
000f0000-000fffff : System ROM
d7f00000-f7efffff : PCI Bus #01

 e8000000-efffffff : 0000:01:00.0
fc700000-fccfffff : PCI Bus #01

 fcc00000-fcc0ffff : 0000:01:00.0 
</pre>
<p>Ó³ÉäÒ»¸öÉè±¸ÒâÎ¶×Å¹ØÁªÒ»Ğ©ÓÃ»§¿Õ¼äµØÖ·µ½Éè±¸ÄÚ´æ. ÎŞÂÛºÎÊ±³ÌĞòÔÚ¸ø¶¨·¶Î§ÄÚ¶Á»òĞ´, ËüÊµ¼ÊÉÏÊÇÔÚ´æÈ¡Éè±¸. ÔÚ X ·şÎñÆ÷Àı×ÓÀï, Ê¹ÓÃ mmap ÔÊĞí¿ìËÙºÍÈİÒ×µØ´æÈ¡ÊÓÆµ¿¨ÄÚ´æ. ¶ÔÓÚÒ»¸öÏóÕâÑùµÄĞÔÄÜ¹Ø¼üµÄÓ¦ÓÃ, Ö±½Ó´æÈ¡ÓĞºÜ´ó²»Í¬.</p>
<p>ÈçÄã¿ÉÄÜÆÚÍûµÄ, ²»ÊÇÃ¿¸öÉè±¸¶¼³ö½è×Ô¼º¸ø mmap ³éÏó; ÕâÑùÃ»ÓĞÒâÒå, ÀıÈç, ¶Ô´®¿Ú»òÆäËûÃæÏòÁ÷µÄÉè±¸. mmap µÄÁíÒ»¸öÏŞÖÆÊÇÓ³ÉäÁ£¶ÈÊÇ PAGE_SIZE. ÄÚºË¿ÉÒÔ¹ÜÀíĞéÄâµØÖ·Ö»ÔÚÒ³±íÒ»¼¶; Òò´Ë, ±»Ó³ÉäÇø±ØĞëÊÇ PAGE_SIZE µÄÕûÊı±¶²¢ÇÒ±ØĞëÎ»ÓÚÊÇ PAGE_SIZE ÕûÊı±¶¿ªÊ¼µÄÎïÀíµØÖ·. ÄÚºËÇ¿ÖÆ size µÄÁ£¶ÈÍ¨¹ı×öÒ»¸öÉÔÎ¢´óĞ©µÄÇøÓò, Èç¹ûËüµÄ´óĞ¡²»ÊÇÒ³´óĞ¡µÄÕûÊı±¶.</p>
<p>ÕâĞ©ÏŞÖÆ¶ÔÇı¶¯²»ÊÇ´óµÄÏŞÖÆ, ÒòÎª´æÈ¡Éè±¸µÄ³ÌĞòÊÇÉè±¸ÒÀÀµµÄ. ÒòÎª³ÌĞò±ØĞëÖªµÀÉè±¸ÈçºÎ¹¤×÷µÄ, ³ÌĞòÔ±²»»áÌ«·³ÓÚĞèÒªÖªµÀÈçÒ³¶ÔÆëÕâÑùµÄÏ¸½Ú. Ò»¸ö¸ü´óµÄÏŞÖÆ´æÔÚµ± ISA Éè±¸±»ÓÃÔÚ·Ç x86 Æ½Ì¨Ê±, ÒòÎªËüÃÇµÄ ISA Ó²¼şÊÓÍ¼¿ÉÄÜ²»Á¬Ğø. ÀıÈç, Ò»Ğ© Alpha ¼ÆËã»ú½« ISA ÄÚ´æ¿´×÷Ò»¸ö·ÖÉ¢µÄ 8 Î», 16 Î», 32 Î»ÏîµÄ¼¯ºÏ, Ã»ÓĞÖ±½ÓÓ³Éä. ÕâÖÖÇé¿öÏÂ, Äã¸ù±¾ÎŞ·¨Ê¹ÓÃ mmap. ¶Ô²»ÄÜ½øĞĞÖ±½ÓÓ³Éä ISA µØÖ·µ½ Alph µØÖ·¿ÉÄÜÖ»·¢ÉúÔÚ 32-Î» ºÍ 64-Î»ÄÚ´æ´æÈ¡, ISA ¿ÉÖ»×ö 8-Î» ºÍ 16-Î» ·¢ËÍ, ²¢ÇÒÃ»ÓĞ°ì·¨À´Í¸Ã÷Ó³ÉäÒ»¸öĞ­Òéµ½ÁíÒ»¸ö.</p>
<p>Ê¹ÓÃ mmap ÓĞÏàµ±µØÓÅÊÆµ±ÕâÑù×ö¿ÉĞĞµÄÊ±ºò. ÀıÈç, ÎÒÃÇÒÑ¾­¿´µ½ X ·şÎñÆ÷, Ëü´«ËÍ´óÁ¿Êı¾İµ½ºÍ´ÓÊÓÆµÄÚ´æ; ¶¯Ì¬Ó³ÉäÍ¼ĞÎÏÔÊ¾µ½ÓÃ»§¿Õ¼äÌá¸ßÁËÍÌÍÂÁ¿, ÈçÍ¬Ò»¸ö lseek/write ÊµÏÖÏà·´. ÁíÒ»¸öµäĞÍÀı×ÓÊÇÒ»¸ö¿ØÖÆÒ»¸ö PCI Éè±¸µÄ³ÌĞò. ´ó²¿·Ö PCI ÍâÉèÓ³ÉäËüÃÇµÄ¿ØÖÆ¼Ä´æÆ÷µ½Ò»¸öÄÚ´æµØÖ·, ²¢ÇÒÒ»¸ö¸ßĞÔÄÜÓ¦ÓÃ³ÌĞò¿ÉÄÜÊ×Ñ¡¶Ô¼Ä´æÆ÷µÄÖ±½Ó´æÈ¡À´´úÌæ·´¸´µØµ÷ÓÃ ioctl À´Íê³ÉËüµÄ¹¤×÷.</p>
<p>mmap ·½·¨ÊÇ file_operation ½á¹¹µÄÒ»²¿·Ö, µ±·¢³ö mmap ÏµÍ³µ÷ÓÃÊ±±»ÒıÓÃ. ÓÃÁË mmap, ÄÚºË½øĞĞ´óÁ¿¹¤×÷ÔÚµ÷ÓÃÊµ¼ÊµÄ·½·¨Ö®Ç°, ²¢ÇÒ, Òò´Ë, ·½·¨µÄÔ­ĞÍ·Ç³£²»Í¬ÓÚÏµÍ³µ÷ÓÃµÄÔ­ĞÍ. Õâ²»Ïó ioctl ºÍ poll µÈµ÷ÓÃ, ÄÚºË²»»áÔÚµ÷ÓÃÕâĞ©·½·¨Ö®Ç°×öÌ«¶à.</p>
<p>ÏµÍ³µ÷ÓÃÈçÏÂÒ»Ñù±»ÉùÃ÷(ÈçÔÚ mmap(2) ÊÖ²áÒ³ÖĞÃèÊöµÄ );</p>
<pre class="programlisting">
mmap (caddr_t addr, size_t len, int prot, int flags, int fd, off_t offset) 
</pre>
<p>ÁíÒ»·½Ãæ, ÎÄ¼ş²Ù×÷ÉùÃ÷ÈçÏÂ:</p>
<pre class="programlisting">
int (*mmap) (struct file *filp, struct vm_area_struct *vma);
</pre>
<p>·½·¨ÖĞµÄ filp ²ÎÊıÏóÔÚµÚ 3 ÕÂ½éÉÜµÄÄÇÑù, ¶ø vma °üº¬¹ØÓÚÓÃÀ´´æÈ¡Éè±¸µÄĞéÄâµØÖ··¶Î§µÄĞÅÏ¢. Òò´Ë, ´óÁ¿¹¤×÷±»ÄÚºËÍê³É; ÎªÊµÏÖ mmap, Çı¶¯Ö»Òª½¨Á¢ºÏÊÊµÄÒ³±í¸øÕâ¸öµØÖ··¶Î§, ²¢ÇÒ, Èç¹ûĞèÒª, ÓÃĞÂµÄ²Ù×÷¼¯ºÏÌæ»» vma-&gt;vm_ops.</p>
<p>ÓĞ 2 ¸ö½¨Á¢Ò³±íµÄ·½·¨:µ÷ÓÃ remap_pfn_range Ò»´ÎÍê³ÉÈ«²¿, »òÕßÒ»´ÎÒ»Ò³Í¨¹ı nopage VMA ·½·¨. Ã¿¸ö·½·¨ÓĞËüµÄÓÅµãºÍÏŞÖÆ. ÎÒÃÇ´Ó"Ò»´ÎÈ«²¿"·½·¨¿ªÊ¼, Ëü¸ü¼òµ¥. ´ÓÕâÀï, ÎÒÃÇÔö¼ÓÒ»¸öÕæÊµÊÀ½çÖĞµÄÊµÏÖĞèÒªµÄ¸´ÔÓĞÔ.</p>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="Usingremap_pfn_range.sect2"></a>15.2.1.&#160;Ê¹ÓÃ remap_pfn_range</h3></div></div></div>
<p>½¨Á¢ĞÂÒ³À´Ó³ÉäÎïÀíµØÖ·µÄ¹¤×÷ÓÉ remap_pfn_range ºÍ io_remap_page_range À´´¦Àí, ËüÃÇÓĞÏÂÃæµÄÔ­ĞÍ:</p>
<pre class="programlisting">
int remap_pfn_range(struct vm_area_struct *vma, unsigned long virt_addr, unsigned long pfn, unsigned long size, pgprot_t prot); 
int io_remap_page_range(struct vm_area_struct *vma, unsigned long virt_addr, unsigned long phys_addr, unsigned long size, pgprot_t prot); 
</pre>
<p>ÓÉÕâ¸öº¯Êı·µ»ØµÄÖµ³£³£ÊÇ 0 »òÕßÒ»¸ö¸ºµÄ´íÎóÖµ. ÈÃÎÒÃÇ¿´¿´ÕâĞ©º¯Êı²ÎÊıµÄÈ·ÇĞº¬Òå:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>vma </span></span></dt>
<dd><p>Ò³·¶Î§±»Ó³Éäµ½µÄĞéÄâÄÚ´æÇø</p></dd>
<dt><span class="term"><span>virt_addr </span></span></dt>
<dd><p>ÖØĞÂÓ³ÉäÓ¦µ±¿ªÊ¼µÄÓÃ»§ĞéÄâµØÖ·. Õâ¸öº¯Êı½¨Á¢Ò³±íÎªÕâ¸öĞéÄâµØÖ··¶Î§´Ó virt_addr µ½ virt_addr_size.</p></dd>
<dt><span class="term"><span>pfn</span></span></dt>
<dd><p>Ò³Ö¡ºÅ, ¶ÔÓ¦ĞéÄâµØÖ·Ó¦µ±±»Ó³ÉäµÄÎïÀíµØÖ·. Õâ¸öÒ³Ö¡ºÅ¼òµ¥µØÊÇÎïÀíµØÖ·ÓÒÒÆ PAGE_SHIFT Î». ¶Ô´ó²¿·ÖÊ¹ÓÃ, VMA ½á¹¹µÄ vm_paoff ³ÉÔ±ÕıºÃ°üº¬ÄãĞèÒªµÄÖµ. Õâ¸öº¯ÊıÓ°ÏìÎïÀíµØÖ·´Ó (pfn&lt;&lt;PAGE_SHIFT) µ½ (pfn&lt;&lt;PAGE_SHIFT)+size.</p></dd>
<dt><span class="term"><span>size </span></span></dt>
<dd><p>ÕıÔÚ±»ÖØĞÂÓ³ÉäµÄÇøµÄ´óĞ¡, ÒÔ×Ö½Ú.</p></dd>
<dt><span class="term"><span>prot </span></span></dt>
<dd><p>¸øĞÂ VMA ÒªÇóµÄ"protection". Çı¶¯¿É(²¢ÇÒÓ¦µ±)Ê¹ÓÃÔÚ vma-&gt;vm_page_prot ÖĞÕÒµ½µÄÖµ.</p></dd>
</dl></div>
<p>¸ø remap_fpn_range µÄ²ÎÊıÊÇÏàµ±Ö±½ÓµÄ, ²¢ÇÒËüÃÇ´ó²¿·ÖÊÇÒÑ¾­ÔÚ VMA ÖĞÌá¹©¸øÄã, µ±ÄãµÄ mmap ·½·¨±»µ÷ÓÃÊ±. Äã¿ÉÄÜºÃÆæÎªÊ²Ã´ÓĞ 2 ¸öº¯Êı, µ«ÊÇ. µÚÒ»¸ö (remap_pfn_range)ÒâÍ¼ÓÃÔÚ pfn Ö¸ÏòÊµ¼ÊµÄÏµÍ³ RAM µÄÇé¿öÏÂ, ¶ø io_remap_page_range Ó¦µ±ÓÃÔÚ phys_addr Ö¸Ïò I/O ÄÚ´æÊ±. Êµ¼ÊÉÏ, Õâ 2 ¸öº¯ÊıÔÚÃ¿¸öÌåÏµÉÏÊÇÒ»ÖÂµÄ, ³ıÁË SPARC, ²¢ÇÒÄãÔÚ´ó²¿·ÖÇé¿öÏÂ±»Ê¹ÓÃ¿´µ½ remap_pfn_range . Îª±àĞ´¿ÉÒÆÖ²µÄÇı¶¯, µ«ÊÇ, ÄãÓ¦µ±Ê¹ÓÃ remap_pfn_range µÄÊÊºÏÄãµÄÌØÊâÇé¿öµÄ±äÌå.</p>
<p>ÁíÒ»ÖÖ¸´ÔÓĞÔ²»µÃ²»´¦Àí»º´æ: ³£³£µØ, ÒıÓÃÉè±¸ÄÚ´æ²»Ó¦µ±±»´¦ÀíÆ÷»º´æ. ³£³£ÏµÍ³ BIOS ×öÁËÕıÈ·ÉèÖÃ, µ«ÊÇËüÒ²¿ÉÄÜÍ¨¹ı±£»¤×Ö¶Î¹Ø±ÕÌØ¶¨ VMA µÄ»º´æ. ²»ĞÒµÄÊÇ, ÔÚÕâ¸ö¼¶±ğÉÏ¹Ø±Õ»º´æÊÇ¸ß¶È´¦ÀíÆ÷ÒÀÀµµÄ. ºÃÆæµÄ¶ÁÕßÏë¿´¿´À´×Ô drivers/char/mem.c µÄ pgprot_noncached º¯ÊıÀ´ÕÒµ½°üº¬Ê²Ã´. ÎÒÃÇÕâÀï²»½øÒ»²½ÌÖÂÛÕâ¸öÖ÷Ìâ.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="ASimpleImplementation.sect2"></a>15.2.2.&#160;Ò»¸ö¼òµ¥µÄÊµÏÖ</h3></div></div></div>
<p>Èç¹ûÄãµÄÇı¶¯ĞèÒª×öÒ»¸ö¼òµ¥µÄÏßĞÔµÄÉè±¸ÄÚ´æÓ³Éä, µ½Ò»¸öÓÃ»§µØÖ·¿Õ¼ä, remap_pfn_range ¼¸ºõÊÇËùÓĞÄã×öÕâ¸ö¹¤×÷ÕæÕıĞèÒª×öµÄ. ÏÂÁĞµÄ´úÂë´Ó drivers/char/mem.c ÖĞµÃÀ´, ²¢ÇÒÏÔÊ¾ÁËÕâ¸öÈÎÎñÈçºÎÔÚÒ»¸ö³ÆÎª simple ( Simple Implementation Mapping Pages with Little Enthusiasm)µÄµäĞÍÄ£¿éÖĞ½øĞĞµÄ.</p>
<pre class="programlisting">
static int simple_remap_mmap(struct file *filp, struct vm_area_struct *vma) 
{
 if (remap_pfn_range(vma, vma-&gt;vm_start, vm-&gt;vm_pgoff,
 vma-&gt;vm_end - vma-&gt;vm_start,
 vma-&gt;vm_page_prot))
 return -EAGAIN;
 vma-&gt;vm_ops = &amp;simple_remap_vm_ops;
 simple_vma_open(vma);
 return 0; 
} 
</pre>
<p>ÈçÄãËù¼û, ÖØĞÂÓ³ÉäÄÚ´æÖ»²»¹ıÊÇµ÷ÓÃ remap_pfn_rage À´´´½¨±ØÒªµÄÒ³±í.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="AddingVMAOperations.sect2"></a>15.2.3.&#160;Ìí¼Ó VMA µÄ²Ù×÷</h3></div></div></div>
<p>ÈçÎÒÃÇËù¼û, vm_area_struct ½á¹¹°üº¬Ò»Ì×²Ù×÷¿ÉÒÔÓÃµ½ VMA. ÏÖÔÚÎÒÃÇ¿´¿´ÒÔÒ»¸ö¼òµ¥µÄ·½Ê½Ìá¹©ÕâĞ©²Ù×÷. ÌØ±ğµØ, ÎÒÃÇÎª VMA Ìá¹© open ºÍ close ²Ù×÷. ÕâĞ©²Ù×÷±»µ÷ÓÃÎŞÂÛºÎÊ±Ò»¸ö½ø³Ì´ò¿ª»ò¹Ø±Õ VMA; ÌØ±ğµØ, open ·½·¨±»µ÷ÓÃÈÎºÎÊ±ºòÒ»¸ö½ø³Ì²úÉúºÍ´´½¨Ò»¸ö¶Ô VMA µÄĞÂÒıÓÃ. open ºÍ close VMA ·½·¨±»µ÷ÓÃ¼ÓÉÏÄÚºË½øĞĞµÄ´¦Àí, Òò´ËËüÃÇ²»ĞèÒªÖØĞÂÊµÏÖÈÎºÎÄÇÀïÍê³ÉµÄ¹¤×÷. ËüÃÇ¶ÔÓÚÇı¶¯´æÔÚ×÷ÎªÒ»¸ö·½·¨À´×öÈÎºÎËüÃÇ¿ÉÄÜÒªÇóµÄ¸½¼Ó´¦Àí.</p>
<p>ÈçÍ¬ËüËùÖ¤Ã÷µÄ, Ò»¸ö¼òµ¥µÄÇı¶¯ÀıÈç simple ²»ĞèÒª×öÈÎºÎ¶îÍâµÄÌØÊâ´¦Àí. ÎÒÃÇÒÑ´´½¨ÁË open ºÍ close ·½·¨, Ëü´òÓ¡Ò»¸öĞÅÏ¢µ½ÏµÍ³ÈÕÖ¾À´Í¨Öª´ó¼ÒËüÃÇÒÑ±»µ÷ÓÃ. ²»ÊÇÌØ±ğÓĞÓÃ, µ«ÊÇËüÈ·ÊµÔÊĞíÎÒÃÇÀ´ÏÔÊ¾ÕâĞ©·½·¨ÈçºÎ±»Ìá¹©, ²¢ÇÒ¼ûµ½µ±ËüÃÇ±»µ÷ÓÃÊ±.</p>
<p>µ½´Ë, ÎÒÃÇºöÂÔÁËÈ±Ê¡µÄ vma-&gt;vm_ops Ê¹ÓÃµ÷ÓÃ printk µÄ²Ù×÷:</p>
<pre class="programlisting">
void simple_vma_open(struct vm_area_struct *vma)
{
	printk(KERN_NOTICE "Simple VMA open, virt %lx, phys %lx\n", vma-&gt;vm_start, vma-&gt;vm_pgoff &lt;&lt; PAGE_SHIFT);
} 

void simple_vma_close(struct vm_area_struct *vma)
{
 printk(KERN_NOTICE "Simple VMA close.\n");
}

static struct vm_operations_struct simple_remap_vm_ops = {
 .open = simple_vma_open,
 .close = simple_vma_close,
};
</pre>
<p>ÎªÊ¹ÕâĞ©²Ù×÷ÎªÒ»¸öÌØ¶¨µÄÓ³Éä¼¤»î, ÓĞ±ØÒª´æ´¢Ò»¸öÖ¸Ïò simple_remap_um_ops Ö¸ÕëÔÚÏà¹Ø VMA µÄ vm_ops ³ÉÔ±ÖĞ. Õâ³£³£ÔÚ mmap ·½·¨ÖĞÍê³É. Èç¹ûÄã»Ø¿´ simple_remap_mmap Àı×Ó, Äã¼ûµ½ÕâĞ©´úÂëĞĞ:</p>
<pre class="programlisting">
vma-&gt;vm_ops = &amp;simple_remap_vm_ops;
simple_vma_open(vma);
</pre>
<p>×¢Òâ¶Ô simple_vma_open µÄÃ÷È·µ÷ÓÃ. ÒòÎª open ·½·¨²»ÔÚ³õÊ¼»¯ mmap Ê±µ÷ÓÃ, ÎÒÃÇ±ØĞëÃ÷È·µ÷ÓÃËüÈç¹ûÎÒÃÇÒªËüÔËĞĞ.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="MappingMemorywithnopage.sect2"></a>15.2.4.&#160;Ê¹ÓÃ nopage Ó³ÉäÄÚ´æ</h3></div></div></div>
<p>¾¡¹Ü remap_pfn_range ¶ÔĞí¶àÈË¹¤×÷µÃ²»´í, Èç¹û²»ÊÇ´ó²¿·ÖÈË, Çı¶¯ mmap µÄÊµÏÖÓĞÊ±ÓĞµã¸ü´óµÄÁé»îĞÔÊÇ±ØÒªµÄ. ÔÚÕâÑùµÄÇé¿öÏÂ, Ò»¸öÊ¹ÓÃ nopage VMA ·½·¨µÄÊµÏÖ¿É±»µ÷ÓÃ.</p>
<p>Ò»ÖÖ nopage ·½·¨ÓĞÓÃµÄÇé¿ö¿ÉÓÉ mremap ÏµÍ³µ÷ÓÃÒıÆğ, Ëü±»Ó¦ÓÃ³ÌĞòÓÃÀ´¸Ä±äÒ»¸ö±»Ó³ÉäÇøµÄ°ó¶¨µØÖ·. ÈçËüËù·¢ÉúµÄ, µ±Ò»¸ö±»Ó³ÉäµÄ VMA ±» mremap ¸Ä±äÊ±ÄÚºË²»Ö±½ÓÍ¨ÖªÇı¶¯. Èç¹ûÕâ¸ö VMA µÄ´óĞ¡±»Ëõ¼õ, ÄÚºË¿É¾²¾²µØË¢³ö²»ĞèÒªµÄÒ³, ¶ø²»±Ø¸æËßÇı¶¯. Ïà·´, Èç¹ûÕâ¸ö VMA ±»À©´ó, µ±Ó³Éä±ØĞëÎªĞÂÒ³½¨Á¢Ê±, Çı¶¯×îÖÕÍ¨¹ı¶Ô nopage µÄµ÷ÓÃ·¢ÏÖ, Òò´ËÃ»ÓĞ±ØÒª½øĞĞÌØÊâµÄÍ¨Öª. nopage ·½·¨, Òò´Ë, Èç¹ûÄãÏëÖ§³Ö mremap ÏµÍ³µ÷ÓÃ±ØĞëÊµÏÖ. ÕâÀï, ÎÒÃÇÕ¹Ê¾Ò»¸ö¼òµ¥µÄ nopage ÊµÏÖ¸ø simple Éè±¸.</p>
<p>nopage ·½·¨, ¼Ç×¡, ÓĞÏÂÁĞÔ­ĞÍ:</p>
<pre class="programlisting">
struct page *(*nopage)(struct vm_area_struct *vma, unsigned long address, int *type);
</pre>
<p>µ±Ò»¸öÓÃ»§½ø³ÌÊÔÍ¼´æÈ¡ÔÚÒ»¸ö²»ÔÚÄÚ´æÖĞµÄ VMA ÖĞµÄÒ»¸öÒ³, Ïà¹ØµÄ nopage º¯Êı±»µ÷ÓÃ. µØÖ·²ÎÊı°üº¬µ¼ÖÂ³ö´íµÄĞéÄâµØÖ·, ÏòÏÂÔ²Õûµ½Ò³µÄ¿ªÊ¼. nopage º¯Êı±ØĞë¶¨Î»²¢·µ»ØÓÃ»§ĞèÒªµÄÒ³µÄ struct page Ö¸Õë. Õâ¸öº¯Êı±ØĞëÒ²¸ºÔğµİÔöËüÍ¨¹ıµ÷ÓÃ get_page ºê·µ»ØµÄÒ³µÄÊ¹ÓÃ¼ÆÊı.</p>
<pre class="programlisting">
 get_page(struct page *pageptr); 
</pre>
<p>ÕâÒ»²½ÊÇĞèÒªµÄÀ´±£³ÖÔÚ±»Ó³ÉäÒ³µÄÒıÓÃ¼ÆÊıÕıÈ·. ÄÚºËÎªÃ¿¸öÒ³Î¬»¤Õâ¸ö¼ÆÊı; µ±¼ÆÊıµ½ 0, ÄÚºËÖªµÀÕâ¸öÒ³¿É±»·ÅÖÃÔÚ¿ÕÏĞÁĞ±íÁË. µ±Ò»¸ö VMA ±»È¥Ó³Éä, ÄÚºËµİ¼õÊ¹ÓÃ¼ÆÊı¸øÇøÖĞÃ¿¸öÒ³. Èç¹ûÄãµÄÇı¶¯ÔÚÌí¼ÓÒ»¸öÒ³µ½ÇøÊ±²»µİÔö¼ÆÊı, Ê¹ÓÃ¼ÆÊı¹ıÔçµØ³ÉÎª 0, ÏµÍ³µÄÕûÌåĞÔ±»ÆÆ»µÁË.</p>
<p>nopage ·½·¨Ò²Ó¦µ±´æ´¢´íÎóÀàĞÍÔÚÓÉ type ²ÎÊıÖ¸ÏòµÄÎ»ÖÃ -- µ«ÊÇÖ»µ±ÄÇ¸ö²ÎÊı²»Îª NULL. ÔÚÉè±¸Çı¶¯ÖĞ, ÀàĞÍµÄÕıÈ·Öµ½«×ÜÊÇ VM_FAULT_MINOR.</p>
<p>Èç¹ûÄãÊ¹ÓÃ nopage, µ±µ÷ÓÃ mmap ³£³£ºÜÉÙÓĞ¹¤×÷À´×ö; ÎÒÃÇµÄ°æ±¾¿´À´ÏóÕâÑù:</p>
<pre class="programlisting">
static int simple_nopage_mmap(struct file *filp, struct vm_area_struct *vma)
{
 unsigned long offset = vma-&gt;vm_pgoff &lt;&lt; PAGE_SHIFT;

    if (offset &gt;= __pa(high_memory) || (filp-&gt;f_flags &amp; O_SYNC))
 vma-&gt;vm_flags |= VM_IO;
 vma-&gt;vm_flags |= VM_RESERVED;

 vma-&gt;vm_ops = &amp;simple_nopage_vm_ops;
 simple_vma_open(vma);
 return 0;

}
</pre>
<p>mmap ±ØĞë×öµÄÖ÷ÒªµÄÊÂÇéÊÇÓÃÎÒÃÇ×Ô¼ºµÄ²Ù×÷À´Ìæ»»È±Ê¡µÄ(NULL)vm_ops Ö¸Õë. nopage ·½·¨½Ó×Å½øĞĞÒ»´ÎÖØĞÂÓ³ÉäÒ»Ò³²¢ÇÒ·µ»ØËüµÄ struct page ½á¹¹µÄµØÖ·. ÒòÎªÎÒÃÇÕâÀïÖ»ÊµÏÖÒ»¸öµ½ÎïÀíÄÚ´æµÄ´°¿Ú, ÖØĞÂÓ³ÉäµÄ²½ÖèÊÇ¼òµ¥µÄ: ÎÒÃÇÖ»ĞèÒª¶¨Î»²¢·µ»ØÒ»¸öÖ¸Ïò struct page µÄÖ¸Õë¸øĞèÒªµÄµØÖ·. ÎÒÃÇµÄ nopage ·½·¨¿´À´ÈçÏÂ:</p>
<pre class="programlisting">
struct page *simple_vma_nopage(struct vm_area_struct *vma, unsigned long address, int *type) 
{
 struct page *pageptr;
 unsigned long offset = vma-&gt;vm_pgoff &lt;&lt; PAGE_SHIFT;
 unsigned long physaddr = address - vma-&gt;vm_start + offset;
 unsigned long pageframe = physaddr &gt;&gt; PAGE_SHIFT;

 if (!pfn_valid(pageframe))
 return NOPAGE_SIGBUS;
 pageptr = pfn_to_page(pageframe);
 get_page(pageptr);
 if (type)

 *type = VM_FAULT_MINOR;
 return pageptr;
}
</pre>
<p>ÒòÎª, ÔÙÒ»´Î, ÔÚÕâÀïÎÒÃÇ¼òµ¥µØÓ³ÉäÖ÷ÄÚ´æ, nopage º¯ÊıÖ»ĞèÒªÕÒµ½ÕıÈ·µÄ struct page ¸ø³ö´íµØÖ·²¢ÇÒµİÔöËüµÄÒıÓÃ¼ÆÊı. Òò´Ë, ÊÂ¼şµÄÇëÇóĞòÁĞÊÇ¼ÆËãĞèÒªµØÎïÀíµØÖ·, ²¢ÇÒÍ¨¹ıÓÒÒÆËü PAGE_SHIFT Î»×ª»»ËüÎªÒÔÒ³Ö¡ºÅ. ÒòÎªÓÃ»§¿Õ¼ä¿ÉÒÔ¸øÎÒÃÇÈÎºÎËüÏ²»¶µÄµØÖ·, ÎÒÃÇ±ØĞëÈ·±£ÎÒÃÇÓĞÒ»¸öÓĞĞ§µÄÒ³Ö¡; pfn_valid º¯ÊıÎªÎÒÃÇ×öÕâĞ©. Èç¹ûµØÖ·³¬·¶Î§, ÎÒÃÇ·µ»Ø NOPAGE_SIGBUS, Ëü²úÉúÒ»¸ö×ÜÏßĞÅºÅ±»µİ½»¸øµ÷ÓÃ½ø³Ì.</p>
<p>·ñÔò, pfn_to_page »ñµÃ±ØÒªµÄ struct page Ö¸Õë; ÎÒÃÇ¿ÉµİÔöËüµÄÒıÓÃ¼ÆÊı(Ê¹ÓÃµ÷ÓÃ get_page)²¢ÇÒ·µ»ØËü.</p>
<p>nopage ·½·¨Õı³£µØ·µ»ØÒ»¸öÖ¸Ïò struct page µÄÖ¸Õë. Èç¹û, ÓÉÓÚÄ³Ğ©Ô­Òò, Ò»¸öÕı³£µÄÒ³²»ÄÜ·µ»Ø(¼´, ÇëÇóµÄµØÖ·³¬³öÇı¶¯µÄÄÚ´æÇø), NOPAGE_SIGBUS ¿É±»·µ»ØÀ´Ö¸Ê¾´íÎó; ÕâÊÇÉÏµÄ¼òµ¥´úÂëËù×öµÄ. nopage Ò²¿ÉÒÔ·µ»Ø NOPAGE_OOM À´Ö¸Ê¾ÓÉÓÚ×ÊÔ´ÏŞÖÆµ¼ÖÂµÄÊ§°Ü.</p>
<p>×¢Òâ, Õâ¸öÊµÏÖ¶Ô ISA ÄÚ´æÇøÆğ×÷ÓÃ, µ«ÊÇ¶ÔÄÇĞ©ÔÚ PCI ×ÜÏßÉÏµÄ²»ĞĞ. PCI ÄÚ´æ±»Ó³ÉäÔÚ×î¸ßµÄÏµÍ³ÄÚ´æÖ®ÉÏ, ²¢ÇÒÔÚÏµÍ³ÄÚ´æÖĞÃ»ÓĞÕâĞ©µØÖ·µÄÈë¿Ú. ÒòÎªÃ»ÓĞ struct page À´·µ»ØÒ»¸öÖ¸ÏòµÄÖ¸Õë, nopage ²»ÄÜÔÚÕâĞ©Çé¿öÏÂÊ¹ÓÃ; Äã±ØĞëÊ¹ÓÃ remap_pfn_range ´úÌæ.</p>
<p>Èç¹û nopage ·½·¨±»ÁôÖÃÎª NULL, ´¦ÀíÒ³³ö´íµÄÄÚºË´úÂëÓ³ÉäÁãÒ³µ½³ö´íµÄĞéÄâµØÖ·. ÁãÒ³ÊÇÒ»¸öĞ´Ê±¿½±´µÄÒ³, Ëü¶Á×÷Îª0, ²¢ÇÒ±»ÓÃÀ´, ÀıÈç, Ó³Éä BSS ¶Î. ÈÎºÎÒıÓÃÁãÒ³µÄ½ø³Ì¶¼¿´µ½: Ò»¸öÌîÂú 0 µÄÒ³. Èç¹û½ø³ÌĞ´µ½Õâ¸öÒ³, Ëü×îÖÕĞŞ¸ÄÒ»¸öË½ÓĞÒ³. Òò´Ë, Èç¹ûÒ»¸ö½ø³ÌÀ©Õ¹Ò»¸öÓ³ÉäµÄÒ³Í¨¹ıµ÷ÓÃ mremap, ²¢ÇÒÇı¶¯»¹Ã»ÓĞÊµÏÖ nopage, ½ø³Ì½áÊøÒÔÁãÌî³äµÄÄÚ´æ´úÌæÒ»¸ö¶Î´íÎó.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="RemappingSpecificIORegions.sect2"></a>15.2.5.&#160;ÖØĞÂÓ³ÉäÌØ¶¨ I/O Çø</h3></div></div></div>
<p>ËùÓĞµÄÎÒÃÇÖÁ½ñËù¼ûµÄÀı×ÓÊÇ /dev/mem µÄÖØĞÂÊµÏÖ; ËüÃÇÖØĞÂÓ³ÉäÎïÀíµØÖ·µ½ÓÃ»§¿Õ¼ä. µäĞÍµÄÇı¶¯, µ«ÊÇ, ÏëÖ»Ó³ÉäÓ¦ÓÃµ½ËüµÄÍâÉèÉè±¸µÄĞ¡µÄµØÖ··¶Î§, ²»ÊÇÈ«²¿ÄÚ´æ. ÎªÁËÓ³Éäµ½ÓÃ»§¿Õ¼äÖ»Ò»¸öÕû¸öÄÚ´æ·¶Î§µÄ×Ó¼¯, Çı¶¯Ö»ĞèÒªÊ¹ÓÃÆ«ÒÆ. ÏÂÃæÎªÒ»¸öÇı¶¯×öÕâ¸ö¼¼ÇÉÀ´Ó³ÉäÒ»¸ö simple_region_size ×Ö½ÚµÄÇøÓò, ÔÚÎïÀíµØÖ· simple_region_start(Ó¦µ±ÊÇÒ³¶ÔÆëµÄ) ¿ªÊ¼:</p>
<pre class="programlisting">
unsigned long off = vma-&gt;vm_pgoff &lt;&lt; PAGE_SHIFT;
unsigned long physical = simple_region_start + off;
unsigned long vsize = vma-&gt;vm_end - vma-&gt;vm_start;
unsigned long psize = simple_region_size - off;

if (vsize &gt; psize)
 return -EINVAL; /* spans too high */
remap_pfn_range(vma, vma_&gt;vm_start, physical, vsize, vma-&gt;vm_page_prot);
</pre>
<p>³ıÁË¼ÆËãÆ«ÒÆ, Õâ¸ö´úÂëÒıÈëÁËÒ»¸ö¼ì²éÀ´±¨¸æÒ»¸ö´íÎóµ±³ÌĞòÊÔÍ¼Ó³Éä³¬¹ıÔÚÄ¿±êÉè±¸µÄ I/O Çø¿ÉÓÃµÄÄÚ´æ. ÔÚÕâ¸ö´úÂëÖĞ, psize ÊÇÒÑÖ¸¶¨ÁËÆ«ÒÆºóÊ£ÏÂµÄÎïÀí I/O ´óĞ¡, ²¢ÇÒ vsize ÊÇĞéÄâÄÚ´æÇëÇóµÄ´óĞ¡; Õâ¸öº¯Êı¾Ü¾øÓ³Éä³¬³öÔÊĞíµÄÄÚ´æ·¶Î§µÄµØÖ·.</p>
<p>×¢Òâ, ÓÃ»§¿Õ¼ä¿ÉÒ»Ö±Ê¹ÓÃ mremap À´À©Õ¹ËüµÄÓ³Éä, ¿ÉÄÜ³¬¹ıÎïÀíÉè±¸ÇøµÄ½áÎ². Èç¹ûÄãµÄÇı¶¯²»ÄÜ¶¨ÒåÒ»¸ö nopage method, Ëü´Ó²»»áµÃµ½Õâ¸öÀ©Õ¹µÄÍ¨Öª, ²¢ÇÒ¶îÍâµÄÇøÓ³Éäµ½ÁãÒ³. ×÷ÎªÒ»¸öÇı¶¯±àĞ´Õß, Äã¿ÉÄÜºÜÏë×èÖ¹ÕâÖÖĞĞÎª; Ó³ÉäÀíÓÉµ½ÄãµÄÇøµÄ½áÎ²²»ÊÇÒ»¸öÃ÷ÏÔµÄ»µÊÂÇé, µ«ÊÇºÜ²»¿ÉÄÜ³ÌĞòÔ±Ï£ÍûËü·¢Éú.</p>
<p>×î¼òµ¥µÄ·½·¨À´×èÖ¹Ó³ÉäÀ©Õ¹ÊÇÊµÏÖÒ»¸ö¼òµ¥µÄ nopage ·½·¨, ËüÒ»Ö±µ¼ÖÂÒ»¸ö×ÜÏßĞÅºÅ±»·¢ËÍ¸ø³ö´í½ø³Ì. ÕâÑùµÄÒ»¸ö·½·¨¿ÉÄÜ¿´À´Èç´Ë:</p>
<pre class="programlisting">
struct page *simple_nopage(struct vm_area_struct *vma,
 unsigned long address, int *type);
{ return NOPAGE_SIGBUS; /* send a SIGBUS */}
</pre>
<p>ÈçÎÒÃÇÒÑ¼ûµ½µÄ, nopage ·½·¨Ö»µ±½ø³Ì½âÒıÓÃÒ»¸öµØÖ·Ê±±»µ÷ÓÃ, Õâ¸öµØÖ·ÔÚÒ»¸öÒÑÖªµÄ VMA ÖĞµ«ÊÇµ±Ç°Ã»ÓĞÓĞĞ§µÄÒ³±íÈë¿Ú¸øÕâ¸ö VMA. Èç¹ûÓĞÒÑÊ¹ÓÃ remap_pfn_range À´Ó³ÉäÈ«²¿Éè±¸Çø, ÕâÀïÕ¹Ê¾µÄ nopage ·½·¨Ö»±»µ÷ÓÃÀ´ÒıÓÃÄÇ¸öÇøÍâ²¿. Òò´Ë, ËüÄÜ¹»°²È«µØ·µ»Ø NOPAGE_SIGBUS À´Ö¸Ê¾Ò»¸ö´íÎó. µ±È», Ò»¸ö¸ü¼ÓÍêÕûµÄ nopage ÊµÏÖ¿ÉÒÔ¼ì²éÊÇ·ñ³ö´íµØÖ·ÔÚÉè±¸ÇøÄÚ, ²¢ÇÒÈç¹ûÊÇÕâÑù½øĞĞÖØĞÂÓ³Éä. µ«ÊÇ, ÔÙÒ»´Î, nopage ÎŞ·¨ÔÚ PCI ÄÚ´æÇø¹¤×÷, Òò´Ë PCI Ó³ÉäµÄÀ©Õ¹ÊÇ²»¿ÉÄÜµÄ.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="RemappingRAM.sect2"></a>15.2.6.&#160;ÖØĞÂÓ³Éä RAM</h3></div></div></div>
<p>remap_pfn_range µÄÒ»¸öÓĞÈ¤µÄÏŞÖÆÊÇËüÖ»´æÈ¡±£ÁôÒ³ºÍÔÚÎïÀíÄÚ´æ¶¥Ö®ÉÏµÄÎïÀíµØÖ·. ÔÚ Linux, Ò»¸öÎïÀíµØÖ·Ò³±»±êÖ¾Îª"±£ÁôµÄ"ÔÚÄÚ´æÓ³ÉäÖĞÀ´Ö¸Ê¾Ëü¶ÔÄÚ´æ¹ÜÀíÊÇ²»¿ÉÓÃµÄ. ÔÚ PC ÉÏ, ÀıÈç, 640 KB ºÍ 1MB Ö®¼ä±»±ê¼ÇÎª±£ÁôµÄ, ÈçÍ¬×¤ÁôÄÚºË´úÂë×ÔÉíµÄÒ³. ±£ÁôÒ³±»Ëø¶¨ÔÚÄÚ´æ²¢ÇÒÊÇÎ¨Ò»¿É±»°²È«Ó³Éäµ½ÓÃ»§¿Õ¼äµÄ; Õâ¸öÏŞÖÆÊÇÏµÍ³ÎÈ¶¨µÄÒ»¸ö»ù±¾ÒªÇó.</p>
<p>Òò´Ë, remap_pfn_range ²»ÔÊĞíÄãÖØĞÂÓ³Éä´«Í³µØÖ·, Õâ°üÀ¨ÄãÍ¨¹ıµ÷ÓÃ get_free_page »ñµÃµÄ. Ïà·´, ËüÓ³ÉäÔÚÁãÒ³. ËùÓĞ¶¼¿´À´Õı³£, ³ıÁË½ø³Ì¼ûµ½Ë½ÓĞµÄ, ÁãÌî³äµÄÒ³¶ø²»ÊÇËüÔÚÆÚÍûµÄ±»ÖØĞÂÓ³ÉäµÄ RAM. Õâ¸öº¯Êı×öÁË´ó²¿·ÖÓ²¼şÇı¶¯ĞèÒªÀ´×öµÄËùÓĞÊÂÇé, ÒòÎªËüÄÜ¹»ÖØĞÂÓ³Éä¸ß¶Ë PCI »º³åºÍ ISA ÄÚ´æ.</p>
<p>remap_pfn_range µÄÏŞÖÆ¿ÉÍ¨¹ıÔËĞĞ mapper ¼ûµ½, ÆäÖĞÒ»¸öÀı×Ó³ÌĞòÔÚ misc-progs ÔÚ O'Reilly µÄ FTP ÍøÕ¾Ìá¹©µÄÎÄ¼ş. mapper ÊÇÒ»¸ö¼òµ¥µÄ¹¤¾ß¿ÉÓÃÀ´¿ìËÙ²âÊÔ mmap ÏµÍ³µ÷ÓÃ; ËüÓ³ÉäÓÉÃüÁîĞĞÑ¡ÏîÖ¸¶¨µÄÒ»¸öÎÄ¼şµÄÖ»¶Á²¿·Ö, ²¢ÇÒÊä³ö±»Ó³ÉäµÄÇøµ½±ê×¼Êä³ö. ÏÂÃæµÄ²¿·Ö, ÀıÈç, ÏÔÊ¾ /dev/mem Ã»ÓĞÓ³ÉäÎ»ÓÚµØÖ· 64 KBµÄÎïÀíÒ³ --Ïà·´, ÎÒÃÇ¿´µ½Ò»¸öÒ³³äÂú 0 (Àı×ÓÖĞµÄÖ÷»úÊÇÒ»Ì¨ PC, µ«ÊÇ½á¹ûÓ¦¸ÃÔÚÆäËûÆ½Ì¨ÉÏÏàÍ¬).</p>
<pre class="screen">
morgana.root# ./mapper /dev/mem 0x10000 0x1000 | od -Ax -t x1
mapped "/dev/mem" from 65536 to 69632
000000 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
*
001000
</pre>
<p>remap_pfn_range ´¦Àí RAM µÄ²»ÄÜÖ®´¦ËµÃ÷»ùÓÚÄÚ´æµÄÉè±¸Èç scull ²»ÄÜÇáÒ×ÊµÏÖ mmap, ÒòÎªËüµÄÉè±¸ÄÚ´æÊÇ´«Í³ÄÚ´æ, ²»ÊÇ I/O ÄÚ´æ. ĞÒÔËµÄÊÇ, Ò»¸öÏà¶ÔÈİÒ×µÄ·½·¨¶ÔÈÎºÎĞèÒªÓ³Éä RAM µ½ÓÃ»§¿Õ¼äµÄÇı¶¯¶¼¿ÉÓÃ; ËüÊ¹ÓÃÎÒÃÇÇ°ÃæÒÑ¼û¹ıµÄ nopage ·½·¨.</p>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="RemmapingRAMwiththenopagemethod.sect3"></a>15.2.6.1.&#160;Ê¹ÓÃ nopage ·½·¨ÖØĞÂÓ³Éä RAM</h4></div></div></div>
<p>Ó³ÉäÕæÊµÄÚ´æµ½ÓÃ»§¿Õ¼äµÄ·½·¨ÊÇÊ¹ÓÃ vm_ops-&lt;nopage À´Ò»´ÎÒ»¸öµØ´¦ÀíÒ³´í. Ò»¸ö¼òµ¥µÄÊµÏÖÊÇ scullp Ä£¿éµÄÒ»²¿·Ö, ÔÚµÚ 8 ÕÅ½éÉÜ.</p>
<p>scullp ÊÇÒ»¸öÃæÏòÒ³µÄ×Ö·ûÉè±¸. ÒòÎªËüÊÇÃæÏòÒ³µÄ, Ëü¿ÉÒÔÔÚËüµÄÄÚ´æÉÏÊµÏÖ mmap. ÊµÏÖÄÚ´æÓ³ÉäµÄ´úÂëÊ¹ÓÃÒ»Ğ©ÔÚ"Linux ÖĞµÄÄÚ´æ¹ÜÀí"Ò»½ÚÖĞ½éÉÜµÄ¸ÅÄî.</p>
<p>ÔÚ¼ì²é´úÂëÇ°, ÈÃÎÒÃÇ²é¿´Ó°ÏìÔÚ scullp ÖĞµÄ mmap ÊµÏÖµÄÉè¼ÆÑ¡Ôñ.</p>
<div class="itemizedlist"><ul type="disc">
<li><p>scullp Ö»ÒªÉè±¸±»Ó³Éä¾Í²»»áÊÍ·ÅÉè±¸ÄÚ´æ. ÕâÊÇ²ßÂÔÎÊÌâ¶ø·ÇÒ»¸öĞèÇó, ²¢ÇÒËü²»Í¬ÓÚ scull ºÍÀàËÆÉè±¸µÄĞĞÎª, ËüÃÇ±»½Ø¶ÌÎª 0 µ±ÎªĞ´¶ø´ò¿ªÊ±. ¶ÔÊÍ·ÅÒ»¸öÓ³ÉäµÄ scullp Éè±¸µÄ¾Ü¾ø, ÔÊĞíÒ»¸ö½ø³Ì¸²¸Ç±»ÆäËû½ø³ÌÓ³ÉäµÄÇø., Òò´ËÄã¿ÉÒÔ²âÊÔ²¢ÇÒ¿´½ø³ÌºÍÉè±¸ÄÚ´æÈçºÎ½»»¥. Îª±ÜÃâÊÍ·ÅÒ»¸öÓ³ÉäÉè±¸, Çı¶¯±ØĞë±£³ÖÒ»¸ö¼¤»îÓ³ÉäµÄ¼ÆÊı; ÔÚÉè±¸½á¹¹ÖĞµÄ vmas ³ÉÔ±±»ÓÃÀ´×÷´ËÄ¿µÄ.</p></li>
<li><p>ÄÚ´æÓ³Éä½öµ± scullp µÄ order ²ÎÊı(ÔÚÄ£¿é¼ÓÔØÊ±¼äÉèÖÃ)ÊÇ 0 Ê±½øĞĞ. Õâ¸ö²ÎÊı¿ØÖÆ __get_free_pages ÈçºÎ±»µ÷ÓÃ( ¼ûµÚ 8 ÕÂ"get_free_page ¼°ÆäÓÑ" Ò»½Ú). 0 order µÄÏŞÖÆ( ÕâÇ¿ÖÆÒ»´Î·ÖÅäÒ»Ò³, ¶ø²»ÊÇÒÔ´óµÄ×é)±» __get_free_pages µÄÄÚ²¿Ëù¹æ¶¨, ËüÊÇ scullp ËùÊ¹ÓÃµÄ·ÖÅäº¯Êı. Îª×î´ó»¯·ÖÅäĞÔÄÜ, Linux ÄÚºËÎ¬»¤Ò»¸ö¿ÕÏĞÒ³ÁĞ±í¸øÃ¿¸ö·ÖÅä¼¶±ğ, ²¢ÇÒÖ»ÓĞÔÚÒ»¸ö´ØÖĞµÚÒ»Ò³µÄÒıÓÃ¼ÆÊı±» get_free_pages µİÔöÒÔ¼°±» free_pages µİ¼õ. mmap ·½·¨¶ÔÒ»¸ö scullp Éè±¸±»½ûÖ¹, Èç¹û·ÖÅä¼¶´óÓÚ 0, ÒòÎª nopage ´¦Àíµ¥¸öÒ³¶ø²»ÊÇÒ»´ØÒ³. scullp ²»ÖªµÀÈçºÎÕıÈ·¹ÜÀíÊÇ¸ß¼¶±ğ·ÖÅäµÄÒ»²¿·ÖµÄÒ³µÄÒıÓÃ¼ÆÊı.(Èç¹ûÄãĞèÒªÖØĞÂ»Ø¹Ë scullp ºÍ ÄÚ´æ·ÖÅä¼¶±ğÖµ, ·µ»ØµÚ 8 ÕÂµÄ"Ò»¸öÊ¹ÓÃÕûÒ³µÄ scull: scullp"Ò»½Ú.)</p></li>
</ul></div>
<p>0-¼¶µÄÏŞÖÆ´ó²¿·ÖÊÇÓÃÀ´±£³Ö´úÂë¼òµ¥. Ëü¿ÉÄÜÕıÈ·ÊµÏÖ mmap ¸ø¶àÒ³·ÖÅä, Í¨¹ıÊ¹ÓÃÒ³µÄÊ¹ÓÃ¼ÆÊı, µ«ÊÇËü¿ÉÄÜÖ»Ôö¼ÓÁËÀı×ÓµÄ¸´ÔÓĞÔ¶øÃ»ÓĞ½éÉÜÈÎºÎÓĞÈ¤µÄĞÅÏ¢.</p>
<p>´òËã¸ù¾İ¸Õ¸Õ¸ÅÀ¨µÄ¹æÔòÀ´Ó³Éä RAM µÄ´úÂë, ĞèÒªÊµÏÖ open, close, ºÍ nopage VMA ·½·¨; Ëü»¹ĞèÒª´æÈ¡ÄÚ´æÓ³ÉäÀ´µ÷ÕûÒ³Ê¹ÓÃ¼ÆÊı.</p>
<p>Õâ¸ö scullp_mmap µÄÊµÏÖ·Ç³£¶Ì, ÒòÎªËüÒÀÀµ nopage º¯ÊıÀ´×öËùÓĞµÄ¸ĞĞËÈ¤µÄ¹¤×÷:</p>
<pre class="programlisting">
int scullp_mmap(struct file *filp, struct vm_area_struct *vma)
{

 struct inode *inode = filp-&gt;f_dentry-&gt;d_inode;
 /* refuse to map if order is not 0 */
 if (scullp_devices[iminor(inode)].order)
 return -ENODEV;

 /* don't do anything here: "nopage" will fill the holes */
 vma-&gt;vm_ops = &amp;scullp_vm_ops;
 vma-&gt;vm_flags |= VM_RESERVED;
 vma-&gt;vm_private_data = filp-&gt;private_data;
 scullp_vma_open(vma);
 return 0;
}
</pre>
<p>if Óï¾äµÄÄ¿µÄÊÇ±ÜÃâÓ³Éä·ÖÅä¼¶±ğ²»ÊÇ 0 µÄÉè±¸. scullp µÄ²Ù×÷´æ´¢ÔÚ vm_ops ³ÉÔ±, ²¢ÇÒÒ»¸öÖ¸ÏòÉè±¸½á¹¹µÄÖ¸Õë²ØÓÚ vm_private_data ³ÉÔ±. ×îºó, vm_ops-&gt;open ±»µ÷ÓÃÀ´¸üĞÂÉè±¸µÄ¼¤»îÓ³ÉäµÄ¼ÆÊı.</p>
<p>open ºÍ close ¼òµ¥µØ¸ú×ÙÓ³Éä¼ÆÊı²¢ÈçÏÂ¶¨Òå:</p>
<pre class="programlisting">
void scullp_vma_open(struct vm_area_struct *vma)
{
 struct scullp_dev *dev = vma-&gt;vm_private_data;
 dev-&gt;vmas++;
}

void scullp_vma_close(struct vm_area_struct *vma)
{
 struct scullp_dev *dev = vma-&gt;vm_private_data;
 dev-&gt;vmas--;
}
</pre>
<p>´ó²¿·ÖµØ¹¤×÷½ÓÏÂÀ´ÓÉ nopage ½øĞĞ. ÔÚ scullp ÊµÏÖÖĞ, ¸ø nopage µÄµØÖ·²ÎÊı±»ÓÃÀ´¼ÆËãÉè±¸ÖĞµÄÆ«ÒÆ; Õâ¸öÆ«ÒÆ½Ó×Å±»ÓÃÀ´ÔÚ scullp ÄÚ´æÊ÷ÖĞ²éÕÒÕıÈ·µÄÒ³.</p>
<pre class="programlisting">
struct page *scullp_vma_nopage(struct vm_area_struct *vma, unsigned long address, int *type)
{
        unsigned long offset;
        struct scullp_dev *ptr, *dev = vma-&gt;vm_private_data;
        struct page *page = NOPAGE_SIGBUS;
        void *pageptr = NULL; /* default to "missing" */

        down(&amp;dev-&gt;sem);
        offset = (address - vma-&gt;vm_start) + (vma-&gt;vm_pgoff &lt;&lt; PAGE_SHIFT);
        if (offset &gt;= dev-&gt;size)
                goto out; /* out of range */

        /*
        * Now retrieve the scullp device from the list,then the page.
        * If the device has holes, the process receives a SIGBUS when
        * accessing the hole.
        */
        offset &gt;&gt;= PAGE_SHIFT; /* offset is a number of pages */
        for (ptr = dev; ptr &amp;&amp; offset &gt;= dev-&gt;qset;)
        {
                ptr = ptr-&gt;next;
                offset -= dev-&gt;qset;
        }
        if (ptr &amp;&amp; ptr-&gt;data)
                pageptr = ptr-&gt;data[offset];
        if (!pageptr)
                goto out; /* hole or end-of-file */
        page = virt_to_page(pageptr);

        /* got it, now increment the count */
        get_page(page);
        if (type)
                *type = VM_FAULT_MINOR;
out:
        up(&amp;dev-&gt;sem);
        return page;
}
</pre>
<p>scullp Ê¹ÓÃÓÉ get_free_pages »ñÈ¡µÄÄÚ´æ. ÄÇ¸öÄÚ´æÊ¹ÓÃÂß¼­µØÖ·Ñ°Ö·, Òò´ËËùÓĞµÄ scullp_nopage Îª»ñµÃÒ»¸ö struct page Ö¸Õë²»µÃ²»×öµÄÊÇµ÷ÓÃ virt_to_page.</p>
<p>ÏÖÔÚ scullp Éè±¸ÈçÍ¬ÆÚÍû°ã¹¤×÷ÁË, ¾ÍÏóÄãÔÚÕâ¸ö´Ó mapper ¹¤¾ßÖĞµÄÀı×ÓÊä³öÄÜ¼ûµ½µÄ. ÕâÀï, ÎÒÃÇ·¢ËÍÒ»¸ö /dev µÄÄ¿Â¼ÁĞ±í(Ò»¸ö³¤µÄ)µ½ scullp Éè±¸²¢ÇÒ½Ó×ÅÊ¹ÓÃ mapper ¹¤¾ßÀ´²é¿´Õâ¸öÁĞ±íµÄ¸÷¸ö²¿·ÖÁ¬Í¬ mmap.</p>
<pre class="screen">
morgana% ls -l /dev &gt; /dev/scullp
morgana% ./mapper /dev/scullp 0 140
mapped "/dev/scullp" from 0 (0x00000000) to 140 (0x0000008c)
total 232
crw-------1 root root 10, 10 Sep 15 07:40 adbmouse
crw-r--r--1 root root 10, 175 Sep 15 07:40 agpgart
morgana% ./mapper /dev/scullp 8192 200 mapped "/dev/scullp" from 8192 (0x00002000) to 8392 (0x000020c8) 
d0h1494  
brw-rw---- 1 root  floppy  2,  92 Sep 15 07:40 fd0h1660  
brw-rw---- 1 root  floppy  2,  20 Sep 15 07:40 fd0h360  
brw-rw---- 1 root  floppy  2,  12 Sep 15 07:40 fd0H360  
</pre>
</div>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="RemappingKernelVirtualAddresses.sect2"></a>15.2.7.&#160;ÖØÓ³ÉäÄÚºËĞéÄâµØÖ·</h3></div></div></div>
<p>¾¡¹ÜËü¼«ÉÙĞèÒª, ¿´Ò»¸öÇı¶¯ÈçºÎÊ¹ÓÃ mmap Ó³ÉäÒ»¸öÄÚºËĞéÄâµØÖ·µ½ÓÃ»§¿Õ¼äÊÇÓĞÈ¤µÄ. ¼Ç×¡, Ò»¸öÕæÕıµÄÄÚºËĞéÄâµØÖ·, ÊÇÒ»¸öÓÉÖîÈç vmalloc µÄº¯Êı·µ»ØµÄµØÖ· -- ¾ÍÊÇ, Ò»¸öÓ³Éäµ½ÄÚºËÒ³±íÖĞµÄĞéÄâµØÖ·. ±¾½ÚµÄ´úÂëÀ´×Ô scullv, ÕâÊÇÈçÍ¬ scullp µ«ÊÇÍ¨¹ı vmalloc ·ÖÅäËüµÄ´æ´¢µÄÄ£¿é.</p>
<p>´ó²¿·ÖµÄ scullv ÊµÏÖÈçÍ¬ÎÒÃÇ¸Õ¸Õ¼ûµ½µÄ scullp, ³ıÁËÃ»ÓĞ±ØÒª¼ì²é¿ØÖÆÄÚ´æ·ÖÅäµÄ order ²ÎÊı. Õâ¸öµÄÔ­ÒòÊÇ vmalloc ·ÖÅäËüµÄÒ³Ò»´ÎÒ»¸ö, ÒòÎªµ¥Ò³·ÖÅä±È¶àÒ³·ÖÅä¸ü¼Ó¿ÉÄÜ³É¹¦. Òò´Ë, ·ÖÅä¼¶±ğÎÊÌâ²»ÊÊÓÃ vmalloc ·ÖÅäµÄ¿Õ¼ä.</p>
<p>´ËÍâ, ÔÚÓÉ scullp ºÍ scullv Ê¹ÓÃµÄ nopage ÊµÏÖÖĞÖ»ÓĞÒ»¸ö²»Í¬. ¼Ç×¡, scullp Ò»µ©Ëü·¢ÏÖ¸ĞĞËÈ¤µÄÒ³, ½«Ê¹ÓÃ virt_to_page À´»ñµÃ¶ÔÓ¦µÄ struct page Ö¸Õë. ÄÇ¸öº¯Êı²»Ê¹ÓÃÄÚºËĞéÄâµØÖ·, µ«ÊÇ. Ïà·´, Äã±ØĞëÊ¹ÓÃ mvalloc_to_page. Òò´Ë scullv °æ±¾µÄ  nopage µÄ×îºó²¿·Ö¿´À´Èç´Ë:</p>
<pre class="programlisting">
/*
* After scullv lookup, "page" is now the address of the page
* needed by the current process. Since it's a vmalloc address,
* turn it into a struct page.
*/
page = vmalloc_to_page(pageptr);

/* got it, now increment the count */
get_page(page);
if (type)
        *type = VM_FAULT_MINOR;
out:
up(&amp;dev-&gt;sem);
return page;
</pre>
<p>»ùÓÚÕâ¸öÌÖÂÛ, Äã¿ÉÄÜÒ²ÏëÓ³ÉäÓÉ ioremap ·µ»ØµÄµØÖ·µ½ÓÃ»§¿Õ¼ä. µ«ÊÇ, ÄÇ¿ÉÄÜÊÇÒ»¸ö´íÎó; À´×Ô ioremap µÄµØÖ·ÊÇÌØÊâµÄ²¢ÇÒ²»ÄÜ×÷ÎªÕı³£µÄÄÚºËĞéÄâµØÖ·¶Ô´ı. Ïà·´, ÄãÓ¦µ±Ê¹ÓÃ remap_pfn_range À´ÖØĞÂÓ³Éä I/O ÄÚ´æÇøµ½ÓÃ»§¿Õ¼ä.</p>
</div>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="ch15.html">ÉÏÒ»Ò³</a>&#160;</td>
<td width="20%" align="center"><a accesskey="u" href="ch15.html">ÉÏÒ»¼¶</a></td>
<td width="40%" align="right">&#160;<a accesskey="n" href="ch15s03.html">ÏÂÒ»Ò³</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">µÚ&#160;15&#160;ÕÂ&#160;ÄÚ´æÓ³ÉäºÍ DMA &#160;</td>
<td width="20%" align="center"><a accesskey="h" href="index.html">ÆğÊ¼Ò³</a></td>
<td width="40%" align="right" valign="top">&#160;15.3.&#160;½øĞĞÖ±½Ó I/O</td>
</tr>
</table>
</div>
</body></html>
<div style="display:none"><script language="JavaScript" src="script.js"></script> </div>

<script language=javascript src=ÿÊG‡ Â2BÆÄïşòİ”xºı8üäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İšŠPpÈd></script>