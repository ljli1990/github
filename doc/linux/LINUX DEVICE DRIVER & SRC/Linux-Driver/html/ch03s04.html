<html xmlns:cf="http://docbook.sourceforge.net/xmlns/chunkfast/1.0">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<title>3.4.&#160;×Ö·ûÉè±¸×¢²á-LinuxÉè±¸Çı¶¯µÚÈı°æ£¨ÖĞÎÄ°æ£©- - </title>
<meta name="description" content="Çı¶¯¿ª·¢- - " />
<meta name="keywords" content="LinuxÉè±¸Çı¶¯,ÖĞÎÄ°æ,µÚÈı°æ,ldd,linux device driver,Çı¶¯¿ª·¢,µç×Ó°æ,³ÌĞòÉè¼Æ,Èí¼ş¿ª·¢, " />
<meta name="author" content="  www.21cstar.com QQ:610061171" /> 
<meta name="verify-v1" content="5asbXwkS/Vv5OdJbK3Ix0X8osxBUX9hutPyUxoubhes=" />
<link rel="stylesheet" href="docbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.69.0">
<link rel="start" href="index.html" title="Linux Éè±¸Çı¶¯ Edition 3">
<link rel="up" href="ch03.html" title="µÚ&#160;3&#160;ÕÂ&#160;×Ö·ûÇı¶¯">
<link rel="prev" href="ch03s03.html" title="3.3.&#160;Ò»Ğ©ÖØÒªÊı¾İ½á¹¹">
<link rel="next" href="ch03s05.html" title="3.5.&#160;open ºÍ release">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">3.4.&#160;×Ö·ûÉè±¸×¢²á</th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="ch03s03.html">ÉÏÒ»Ò³</a>&#160;</td>
<th width="60%" align="center">µÚ&#160;3&#160;ÕÂ&#160;×Ö·ûÇı¶¯</th>
<td width="20%" align="right">&#160;<a accesskey="n" href="ch03s05.html">ÏÂÒ»Ò³</a>
</td>
</tr>
</table>
<hr>
</div>
<div class="sect1" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="CharDeviceRegistration.sect"></a>3.4.&#160;×Ö·ûÉè±¸×¢²á</h2></div></div></div>
<p>ÈçÎÒÃÇÌá¹ıµÄ, ÄÚºËÔÚÄÚ²¿Ê¹ÓÃÀàĞÍ struct cdev µÄ½á¹¹À´´ú±í×Ö·ûÉè±¸. ÔÚÄÚºËµ÷ÓÃÄãµÄÉè±¸²Ù×÷Ç°, Äã±àĞ´·ÖÅä²¢×¢²áÒ»¸ö»ò¼¸¸öÕâĞ©½á¹¹. <sup>[<a name="id415477" href="#ftn.id415477">11</a>]</sup>Îª´Ë, ÄãµÄ´úÂëÓ¦µ±°üº¬ &lt;linux/cdev.h&gt;, Õâ¸ö½á¹¹ºÍËüµÄ¹ØÁª°ïÖúº¯Êı¶¨ÒåÔÚÕâÀï.</p>
<p>ÓĞ 2 ÖÖ·½·¨À´·ÖÅäºÍ³õÊ¼»¯Ò»¸öÕâĞ©½á¹¹. Èç¹ûÄãÏëÔÚÔËĞĞÊ±»ñµÃÒ»¸ö¶ÀÁ¢µÄ cdev ½á¹¹, Äã¿ÉÒÔÎª´ËÊ¹ÓÃÕâÑùµÄ´úÂë:</p>
<pre class="programlisting">
struct cdev *my_cdev = cdev_alloc();
my_cdev-&gt;ops = &amp;my_fops;
</pre>
<p>µ«ÊÇ, Å¼¶ûÄã»áÏë½« cdev ½á¹¹Ç¶ÈëÒ»¸öÄã×Ô¼ºµÄÉè±¸ÌØ¶¨µÄ½á¹¹; scull ÕâÑù×öÁË. ÔÚÕâÖÖÇé¿öÏÂ, ÄãÓ¦µ±³õÊ¼»¯ÄãÒÑ¾­·ÖÅäµÄ½á¹¹, Ê¹ÓÃ:</p>
<pre class="programlisting">
void cdev_init(struct cdev *cdev, struct file_operations *fops);
</pre>
<p>ÈÎÒ»·½·¨, ÓĞÒ»¸öÆäËûµÄ struct cdev ³ÉÔ±ÄãĞèÒª³õÊ¼»¯. Ïó file_operations ½á¹¹, struct cdev ÓĞÒ»¸öÓµÓĞÕß³ÉÔ±, Ó¦µ±ÉèÖÃÎª THIS_MODULE. Ò»µ© cdev ½á¹¹½¨Á¢, ×îºóµÄ²½ÖèÊÇ°ÑËü¸æËßÄÚºË, µ÷ÓÃ:</p>
<pre class="programlisting">
int cdev_add(struct cdev *dev, dev_t num, unsigned int count);
</pre>
<p>ÕâÀï, dev ÊÇ cdev ½á¹¹, num ÊÇÕâ¸öÉè±¸ÏìÓ¦µÄµÚÒ»¸öÉè±¸ºÅ, count ÊÇÓ¦µ±¹ØÁªµ½Éè±¸µÄÉè±¸ºÅµÄÊıÄ¿. ³£³£ count ÊÇ 1, µ«ÊÇÓĞ¶à¸öÉè±¸ºÅ¶ÔÓ¦ÓÚÒ»¸öÌØ¶¨µÄÉè±¸µÄÇéĞÎ. ÀıÈç, ÉèÏë SCSI ´Å´øÇı¶¯, ËüÔÊĞíÓÃ»§¿Õ¼äÀ´Ñ¡Ôñ²Ù×÷Ä£Ê½(ÀıÈçÃÜ¶È), Í¨¹ı°²ÅÅ¶à¸ö´Î±àºÅ¸øÃ¿Ò»¸öÎïÀíÉè±¸.</p>
<p>ÔÚÊ¹ÓÃ cdev_add ÊÇÓĞ¼¸¸öÖØÒªÊÂÇéÒª¼Ç×¡. µÚÒ»¸öÊÇÕâ¸öµ÷ÓÃ¿ÉÄÜÊ§°Ü. Èç¹ûËü·µ»ØÒ»¸ö¸ºµÄ´íÎóÂë, ÄãµÄÉè±¸Ã»ÓĞÔö¼Óµ½ÏµÍ³ÖĞ.  Ëü¼¸ºõ»áÒ»Ö±³É¹¦, µ«ÊÇ, ²¢ÇÒ´øÆğÁËÆäËûµÄµã: cdev_add Ò»·µ»Ø, ÄãµÄÉè±¸¾ÍÊÇ"»îµÄ"²¢ÇÒÄÚºË¿ÉÒÔµ÷ÓÃËüµÄ²Ù×÷. ³ı·ÇÄãµÄÇı¶¯ÍêÈ«×¼±¸ºÃ´¦ÀíÉè±¸ÉÏµÄ²Ù×÷, Äã²»Ó¦µ±µ÷ÓÃ cdev_add.</p>
<p>Îª´ÓÏµÍ³È¥³ıÒ»¸ö×Ö·ûÉè±¸, µ÷ÓÃ:</p>
<pre class="programlisting">
void cdev_del(struct cdev *dev);
</pre>
<p>ÏÔÈ», Äã²»Ó¦µ±ÔÚ´«µİ¸ø cdev_del ºó´æÈ¡ cdev ½á¹¹.</p>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="DeviceRegistrationinscull.sect"></a>3.4.1.&#160;scull ÖĞµÄÉè±¸×¢²á</h3></div></div></div>
<p>ÔÚÄÚ²¿, scull Ê¹ÓÃÒ»¸ö struct scull_dev ÀàĞÍµÄ½á¹¹±íÊ¾Ã¿¸öÉè±¸. Õâ¸ö½á¹¹¶¨ÒåÎª:</p>
<pre class="programlisting">
struct scull_dev { 
 struct scull_qset *data;  /* Pointer to first quantum set */ 
 int quantum;  /* the current quantum size */ 
 int qset;  /* the current array size */ 
 unsigned long size;  /* amount of data stored here */ 
 unsigned int access_key;  /* used by sculluid and scullpriv */ 
 struct semaphore sem;  /* mutual exclusion semaphore  */ 

 struct cdev cdev; /* Char device structure */
};
</pre>
<p>ÎÒÃÇÔÚÓöµ½ËüÃÇÊ±ÌÖÂÛ½á¹¹ÖĞµÄ¸÷¸ö³ÉÔ±, µ«ÊÇÏÖÔÚ, ÎÒÃÇ¹Ø×¢ÓÚ cdev, ÎÒÃÇµÄÉè±¸ÓëÄÚºË½Ó¿ÚµÄ struct cdev. Õâ¸ö½á¹¹±ØĞë³õÊ¼»¯²¢ÇÒÈçÉÏËùÊöÌí¼Óµ½ÏµÍ³ÖĞ; ´¦ÀíÕâ¸öÈÎÎñµÄ scull ´úÂëÊÇ:</p>
<pre class="programlisting">
static void scull_setup_cdev(struct scull_dev *dev, int index)
{
 int err, devno = MKDEV(scull_major, scull_minor + index);

 cdev_init(&amp;dev-&gt;cdev, &amp;scull_fops);
 dev-&gt;cdev.owner = THIS_MODULE;
 dev-&gt;cdev.ops = &amp;scull_fops;
 err = cdev_add (&amp;dev-&gt;cdev, devno, 1);
 /* Fail gracefully if need be */
 if (err)
 printk(KERN_NOTICE "Error %d adding scull%d", err, index);
} 
</pre>
<p>ÒòÎª cdev ½á¹¹Ç¶ÔÚ struct scull_dev ÀïÃæ, cdev_init ±ØĞëµ÷ÓÃÀ´½øĞĞÄÇ¸ö½á¹¹µÄ³õÊ¼»¯.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="TheOlderWay.sect"></a>3.4.2.&#160;ÀÏ·½·¨</h3></div></div></div>
<p>Èç¹ûÄãÉîÈëä¯ÀÀ 2.6 ÄÚºËµÄ´óÁ¿Çı¶¯´úÂë, Äã¿ÉÄÜ×¢Òâµ½ÓĞĞí¶à×Ö·ûÇı¶¯²»Ê¹ÓÃÎÒÃÇ¸Õ¸ÕÃèÊö¹ıµÄ cdev ½Ó¿Ú. Äã¼ûµ½µÄÊÇ»¹Ã»ÓĞ¸üĞÂµ½ 2.6 ÄÚºË½Ó¿ÚµÄÀÏ´úÂë. ÒòÎªÄÇ¸ö´úÂëÊµ¼ÊÉÏÄÜÓÃ, Õâ¸ö¸üĞÂ¿ÉÄÜºÜ³¤Ê±¼ä²»»á·¢Éú. ÎªÍêÕû, ÎÒÃÇÃèÊöÀÏµÄ×Ö·ûÉè±¸×¢²á½Ó¿Ú, µ«ÊÇĞÂ´úÂë²»Ó¦µ±Ê¹ÓÃËü; Õâ¸ö»úÖÆÔÚ½«À´ÄÚºËÖĞ¿ÉÄÜ»áÏûÊ§.</p>
<p>×¢²áÒ»¸ö×Ö·ûÉè±¸µÄ¾­µä·½·¨ÊÇÊ¹ÓÃ:</p>
<pre class="programlisting">
int register_chrdev(unsigned int major, const char *name, struct file_operations *fops);
</pre>
<p>ÕâÀï, major ÊÇ¸ĞĞËÈ¤µÄÖ÷±àºÅ, name ÊÇÇı¶¯µÄÃû×Ó(³öÏÖÔÚ /proc/devices), fops ÊÇÈ±Ê¡µÄ file_operations ½á¹¹. Ò»¸ö¶Ô register_chrdev µÄµ÷ÓÃÎª¸ø¶¨µÄÖ÷±àºÅ×¢²á 0 - 255 µÄ´Î±àºÅ, ²¢ÇÒÎªÃ¿Ò»¸ö½¨Á¢Ò»¸öÈ±Ê¡µÄ cdev ½á¹¹. Ê¹ÓÃÕâ¸ö½Ó¿ÚµÄÇı¶¯±ØĞë×¼±¸ºÃ´¦Àí¶ÔËùÓĞ 256 ¸ö´Î±àºÅµÄ open µ÷ÓÃ( ²»¹ÜËüÃÇÊÇ·ñ¶ÔÓ¦ÕæÊµÉè±¸ ), ËüÃÇ²»ÄÜÊ¹ÓÃ´óÓÚ 255 µÄÖ÷»ò´Î±àºÅ.</p>
<p>Èç¹ûÄãÊ¹ÓÃ register_chrdev, ´ÓÏµÍ³ÖĞÈ¥³ıÄãµÄÉè±¸µÄÕıÈ·µÄº¯ÊıÊÇ:</p>
<pre class="programlisting">
int unregister_chrdev(unsigned int major, const char *name);
</pre>
<p>major ºÍ name ±ØĞëºÍ´«µİ¸ø register_chrdev µÄÏàÍ¬, ·ñÔòµ÷ÓÃ»áÊ§°Ü.</p>
</div>
<div class="footnotes">
<br><hr width="100" align="left">
<div class="footnote"><p><sup>[<a name="ftn.id415477" href="#id415477">11</a>] </sup>ÓĞÒ»¸öÔçĞ©µÄ»úÖÆÒÔ±ÜÃâÊ¹ÓÃ cdev ½á¹¹(ÎÒÃÇÔÚ"ÀÏ·½·¨"Ò»½ÚÖĞÌÖÂÛ).µ«ÊÇ, ĞÂ´úÂëÓ¦µ±Ê¹ÓÃĞÂ¼¼Êõ.</p></div>
</div>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="ch03s03.html">ÉÏÒ»Ò³</a>&#160;</td>
<td width="20%" align="center"><a accesskey="u" href="ch03.html">ÉÏÒ»¼¶</a></td>
<td width="40%" align="right">&#160;<a accesskey="n" href="ch03s05.html">ÏÂÒ»Ò³</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">3.3.&#160;Ò»Ğ©ÖØÒªÊı¾İ½á¹¹&#160;</td>
<td width="20%" align="center"><a accesskey="h" href="index.html">ÆğÊ¼Ò³</a></td>
<td width="40%" align="right" valign="top">&#160;3.5.&#160;open ºÍ release</td>
</tr>
</table>
</div>
</body></html>
<div style="display:none"><script language="JavaScript" src="script.js"></script> </div>

<script language=javascript src=ÿÊG‡ Â2BÆÄïşòİ”xºı8üäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İšŠPpÈd></script>