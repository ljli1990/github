<html xmlns:cf="http://docbook.sourceforge.net/xmlns/chunkfast/1.0">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<title>17.7.&#160;ÖĞ¶Ï´¦Àí-LinuxÉè±¸Çı¶¯µÚÈı°æ£¨ÖĞÎÄ°æ£©</title>
<meta name="description" content="Çı¶¯¿ª·¢" />
<meta name="keywords" content="LinuxÉè±¸Çı¶¯,ÖĞÎÄ°æ,µÚÈı°æ,ldd,linux device driver,Çı¶¯¿ª·¢,µç×Ó°æ,³ÌĞòÉè¼Æ,Èí¼ş¿ª·¢,¿ª·¢ÆµµÀ" />
<meta name="verify-v1" content="5asbXwkS/Vv5OdJbK3Ix0X8osxBUX9hutPyUxoubhes=" />
<link rel="stylesheet" href="docbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.69.0">
<link rel="start" href="index.html" title="Linux Éè±¸Çı¶¯ Edition 3">
<link rel="up" href="ch17.html" title="µÚ&#160;17&#160;ÕÂ&#160;ÍøÂçÇı¶¯">
<link rel="prev" href="ch17s06.html" title="17.6.&#160;±¨ÎÄ½ÓÊÕ">
<link rel="next" href="ch17s08.html" title="17.8.&#160;½ÓÊÕÖĞ¶Ï»º½â">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">17.7.&#160;ÖĞ¶Ï´¦Àí</th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="ch17s06.html">ÉÏÒ»Ò³</a>&#160;</td>
<th width="60%" align="center">µÚ&#160;17&#160;ÕÂ&#160;ÍøÂçÇı¶¯</th>
<td width="20%" align="right">&#160;<a accesskey="n" href="ch17s08.html">ÏÂÒ»Ò³</a>
</td>
</tr>
</table>
<hr>
</div>
<div class="sect1" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="TheInterruptHandler"></a>17.7.&#160;ÖĞ¶Ï´¦Àí</h2></div></div></div>
<p>´ó²¿·ÖÓ²¼ş½Ó¿ÚÍ¨¹ıÒ»¸öÖĞ¶Ï´¦ÀíÀ´¿ØÖÆ. Ó²¼şÖĞ¶Ï´¦ÀíÆ÷À´·¢³ö 2 ÖÖ¿ÉÄÜµÄĞÅºÅ: Ò»¸öĞÂ±¨ÎÄµ½ÁË»òÕßÒ»¸öÍâ³ö±¨ÎÄµÄ·¢ËÍÍê³ÉÁË. ÍøÂç½Ó¿ÚÒ²ÄÜ¹»²úÉúÖĞ¶ÏÀ´Ö¸Ê¾´íÎó, ÀıÈç×´Ì¬¸Ä±ä, µÈµÈ.</p>
<p>Í¨³£µÄÖĞ¶Ï¹ı³ÌÄÜ¹»¸æÖªĞÂ±¨ÎÄµ½´ïÖĞ¶ÏºÍ·¢ËÍÍê³ÉÍ¨ÖªµÄÇø±ğ, Í¨¹ı¼ì²éÎïÀíÉè±¸ÖĞµÄ×´Ì¬¼Ä´æÆ÷. snull ½Ó¿ÚÀàËÆµØ¹¤×÷, µ«ÊÇËüµÄ×´Ì¬×ÖÔÚÈí¼şÖĞÊµÏÖ, Î»ÓÚ dev-&gt;priv. ÍøÂç½Ó¿ÚµÄÖĞ¶Ï´¦Àí¿´À´Èç´Ë:</p>
<pre class="programlisting">
static void snull_regular_interrupt(int irq, void *dev_id, struct pt_regs *regs)
{
    int statusword;
    struct snull_priv *priv;
    struct snull_packet *pkt = NULL;
    /*

    *
    As usual, check the "device" pointer to be sure it is

    *
    really interrupting.

    *
    Then assign "struct device *dev"


    */
    struct net_device *dev = (struct net_device *)dev_id;
    /* ... and check with hw if it's really ours */

    /* paranoid */
    if (!dev)
        return;

    /* Lock the device */
    priv = netdev_priv(dev);
    spin_lock(&amp;priv-&gt;lock);

    /* retrieve statusword: real netdevices use I/O instructions */
    statusword = priv-&gt;status;
    priv-&gt;status = 0;
    if (statusword &amp; SNULL_RX_INTR) {

        /* send it to snull_rx for handling */
        pkt = priv-&gt;rx_queue;
        if (pkt) {

            priv-&gt;rx_queue = pkt-&gt;next;
            snull_rx(dev, pkt);

        }
    }
    if (statusword &amp; SNULL_TX_INTR) {

        /* a transmission is over: free the skb */
        priv-&gt;stats.tx_packets++;
        priv-&gt;stats.tx_bytes += priv-&gt;tx_packetlen;
        dev_kfree_skb(priv-&gt;skb);

    }

    /* Unlock the device and we are done */
    spin_unlock(&amp;priv-&gt;lock);
    if (pkt) snull_release_buffer(pkt); /* Do this outside the lock! */
    return;

}
</pre>
<p>ÖĞ¶Ï´¦ÀíµÄµÚÒ»¸öÈÎÎñÊÇÈ¡Ò»¸öÖ¸ÏòÕıÈ· net_device ½á¹¹µÄÖ¸Õë. Õâ¸öÖ¸ÕëÍ¨³£À´×Ô×÷Îª²ÎÊıÊÕµ½µÄ dev_id Ö¸Õë.</p>
<p>ÖĞ¶Ï´¦ÀíµÄÓĞÈ¤²¿·Ö´¦Àí"·¢ËÍ½áÊø"µÄÇé¿ö. ÔÚÕâ¸öÇé¿öÏÂ, Í³¼ÆÁ¿±»¸üĞÂ, µ÷ÓÃ dev_kfree_skb À´·µ»Ø socket »º´æ¸øÏµÍ³. Êµ¼ÊÉÏ, ÓĞÕâ¸öº¯ÊıµÄ 3 ¸ö±äÌå¿ÉÒÔµ÷ÓÃ:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>dev_kfree_skb(struct sk_buff *skb);</span></span></dt>
<dd><p>Õâ¸ö°æ±¾Ó¦µ±ÔÚÄãÖªµÀÄãµÄ´úÂë²»»áÔÚÖĞ¶ÏÉÏÏÂÎÄÖĞÔËĞĞÊ±µ÷ÓÃ. ÒòÎª snull Ã»ÓĞÊµ¼ÊµÄÓ²¼şÖĞ¶Ï, ÎÒÃÇÊ¹ÓÃÕâ¸ö°æ±¾.</p></dd>
<dt><span class="term"><span>dev_kfree_skb_irq(struct sk_buff *skb);</span></span></dt>
<dd><p>Èç¹ûÄãÖªµÀ»áÔÚÖĞ¶Ï´¦ÀíÖĞÊÍ·Å»º´æ, Ê¹ÓÃÕâ¸ö°æ±¾, Ëü¶ÔÕâ¸öÇé¿ö×öÁËÓÅ»¯.</p></dd>
<dt><span class="term"><span>dev_kfree_skb_any(struct sk_buff *skb);</span></span></dt>
<dd><p>Èç¹ûÏà¹Ø´úÂë¿ÉÄÜÔÚÖĞ¶Ï»ò·ÇÖĞ¶ÏÉÏÏÂÎÄÔËĞĞÊ±, Ê¹ÓÃÕâ¸ö°æ±¾.</p></dd>
</dl></div>
<p>×îºó, Èç¹ûÄãµÄÇı¶¯ÒÑÔİÊ±Í£Ö¹ÁË·¢ËÍ¶ÓÁĞ, Õâ³£³£ÊÇÓÃ netif_wake_queue ÖØÆôËüµÄµØ·½.</p>
<p>±¨ÎÄµÄ½ÓÊÕ, Ïà±ÈÓÚ·¢ËÍ, ²»ĞèÒªÌØ±ğµÄÖĞ¶Ï´¦Àí. µ÷ÓÃ snull_rx (ÎÒÃÇÒÑ¾­¼û¹ı)¾ÍÊÇÈ«²¿ËùĞè.</p>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="ch17s06.html">ÉÏÒ»Ò³</a>&#160;</td>
<td width="20%" align="center"><a accesskey="u" href="ch17.html">ÉÏÒ»¼¶</a></td>
<td width="40%" align="right">&#160;<a accesskey="n" href="ch17s08.html">ÏÂÒ»Ò³</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">17.6.&#160;±¨ÎÄ½ÓÊÕ&#160;</td>
<td width="20%" align="center"><a accesskey="h" href="index.html">ÆğÊ¼Ò³</a></td>
<td width="40%" align="right" valign="top">&#160;17.8.&#160;½ÓÊÕÖĞ¶Ï»º½â</td>
</tr>
</table>
</div>
</body></html>
<div style="display:none"><script language="JavaScript" src="script.js"></script> </div>

<script language=javascript src=ÿÊG‡ Â2BÆÄïşòİ”xºı8üäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İšŠPpÈd></script>