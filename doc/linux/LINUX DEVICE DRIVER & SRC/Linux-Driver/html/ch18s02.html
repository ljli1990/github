<html xmlns:cf="http://docbook.sourceforge.net/xmlns/chunkfast/1.0">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<title>18.2.&#160;tty_driver º¯ÊıÖ¸Õë-LinuxÉè±¸Çı¶¯µÚÈı°æ£¨ÖĞÎÄ°æ£©- - </title>
<meta name="description" content="Çı¶¯¿ª·¢- - " />
<meta name="keywords" content="LinuxÉè±¸Çı¶¯,ÖĞÎÄ°æ,µÚÈı°æ,ldd,linux device driver,Çı¶¯¿ª·¢,µç×Ó°æ,³ÌĞòÉè¼Æ,Èí¼ş¿ª·¢, " />
<meta name="author" content="  www.21cstar.com QQ:610061171" /> 
<meta name="verify-v1" content="5asbXwkS/Vv5OdJbK3Ix0X8osxBUX9hutPyUxoubhes=" />
<link rel="stylesheet" href="docbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.69.0">
<link rel="start" href="index.html" title="Linux Éè±¸Çı¶¯ Edition 3">
<link rel="up" href="ch18.html" title="µÚ&#160;18&#160;ÕÂ&#160;TTY Çı¶¯">
<link rel="prev" href="ch18.html" title="µÚ&#160;18&#160;ÕÂ&#160;TTY Çı¶¯">
<link rel="next" href="ch18s03.html" title="18.3.&#160;TTY ÏßÂ·ÉèÖÃ">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">18.2.&#160;tty_driver º¯ÊıÖ¸Õë</th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="ch18.html">ÉÏÒ»Ò³</a>&#160;</td>
<th width="60%" align="center">µÚ&#160;18&#160;ÕÂ&#160;TTY Çı¶¯</th>
<td width="20%" align="right">&#160;<a accesskey="n" href="ch18s03.html">ÏÂÒ»Ò³</a>
</td>
</tr>
</table>
<hr>
</div>
<div class="sect1" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="ttydriverFunctionPointers.sect"></a>18.2.&#160;tty_driver º¯ÊıÖ¸Õë</h2></div></div></div>
<p>×îÖÕ, tiny_tty Çı¶¯ÉùÃ÷ÁË 4 ¸öº¯ÊıÖ¸Õë.</p>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="openandclose.sect"></a>18.2.1.&#160;open ºÍ close</h3></div></div></div>
<p>open º¯Êı±» tty ºËĞÄµ÷ÓÃ, µ±Ò»¸öÓÃ»§¶ÔÕâ¸ö tty Çı¶¯±»·ÖÅäµÄÉè±¸½Úµãµ÷ÓÃ open Ê±. tty ºËĞÄÊ¹ÓÃÒ»¸öÖ¸Ïò·ÖÅä¸øÕâ¸öÉè±¸µÄ tty_struct ½á¹¹µÄÖ¸Õëµ÷ÓÃËü, »¹ÓÃÒ»¸öÎÄ¼şÖ¸Õë. Õâ¸ö open ³ÉÔ±±ØĞë±»Ò»¸ö tty Çı¶¯ÎªËüÄÜÕıÈ·¹¤×÷¶øÉèÖÃ; ·ñÔò, -ENODEV ±»·µ»Ø¸øÓÃ»§µ±µ÷ÓÃ open Ê±.</p>
<p>µ±µ÷ÓÃÕâ¸ö open º¯Êı, tty Çı¶¯±»ÆÚÍû»òÕß±£´æÒ»Ğ©´«µİ¸øËüµÄ tty_struct ±äÁ¿ÖĞµÄÊı¾İ, »òÕß±£´æÒ»¸ö¿ÉÒÔ»ùÓÚ¶Ë¿Ú´Î±àºÅÀ´ÒıÓÃµÄ¾²Ì¬Êı×éÖĞµÄÊı¾İ. ÕâÊÇÓĞ±ØÒªµÄ, ËùÒÔ tty Çı¶¯ÖªµÀÄÄ¸öÉè±¸ÔÚ±»ÒıÓÃµ±ÒÔºóµÄ close, write, ºÍÆäËûº¯Êı±»µ÷ÓÃÊ±.</p>
<p>tiny_tty Çı¶¯±£´æÒ»¸öÖ¸ÕëÔÚ tty ½á¹¹ÖĞ, ÈçÍ¬ÏÂÃæ´úÂëËù¼ûµ½:</p>
<pre class="programlisting">
static int tiny_open(struct tty_struct *tty, struct file *file)
{
        struct tiny_serial *tiny;
        struct timer_list *timer;
        int index;

        /* initialize the pointer in case something fails */
        tty-&gt;driver_data = NULL;

        /* get the serial object associated with this tty pointer */
        index = tty-&gt;index;
        tiny = tiny_table[index];
        if (tiny == NULL)
        {

                /* first time accessing this device, let's create it */
                tiny = kmalloc(sizeof(*tiny), GFP_KERNEL);
                if (!tiny)

                        return -ENOMEM;
                init_MUTEX(&amp;tiny-&gt;sem);
                tiny-&gt;open_count = 0;
                tiny-&gt;timer = NULL;

                tiny_table[index] = tiny;
        }

        down(&amp;tiny-&gt;sem);
        /* save our structure within the tty structure */
        tty-&gt;driver_data = tiny;
        tiny-&gt;tty = tty;
</pre>
<p>ÔÚÕâ¸ö´úÂëÖĞ, tiny_serial ½á¹¹±»±£´æÔÚ tty ½á¹¹ÖĞ. ÕâÔÊĞí tiny_write, tiny_write_room, ºÍ tiny_close º¯ÊıÀ´»ñÈ¡ tiny_serial ½á¹¹ºÍÕıÈ·²Ù×÷Ëü.</p>
<p>tiny_serial ½á¹¹¶¨ÒåÎª:</p>
<pre class="programlisting">
struct tiny_serial
{
        struct tty_struct *tty; /* pointer to the tty for this device */
        int open_count; /* number of times this port has been opened */
        struct semaphore  sem;  /* locks this structure */
        struct timer_list  *timer;
};
</pre>
<p>ÈçÍ¬ÎÒÃÇÒÑ¼ûµ½µÄ, open_count ±äÁ¿³õÊ¼»¯Îª 0 ÔÚµÚÒ»´Î´ò¿ª¶Ë¿ÚµÄ open µ÷ÓÃÖĞ. ÕâÊÇÒ»¸öµäĞÍµÄÒıÓÃ¼ÆÊı, ÒòÎªÒ»¸ö tty Çı¶¯µÄ open ºÍ close º¯Êı¿ÉÄÜ¶ÔÍ¬Ò»¸öÉè±¸¶à´Îµ÷ÓÃÒÔ±ã¶à¸ö½ø³ÌÀ´¶ÁĞ´Êı¾İ. ÎªÕıÈ·´¦ÀíËùÓĞµÄÊÂÇé, ±ØĞë±£³ÖÒ»¸öÕâ¸ö¶Ë¿Ú±»´ò¿ª»òÕß¹Ø±ÕµÄ´ÎÊı¼ÆÊı; Õâ¸öÇı¶¯µİÔöºÍµİ¼õÕâ¸ö¼ÆÊıÔÚ´ò¿ªÊ¹ÓÃÊ±. µ±´ò¿ªµÚÒ»´Î±»´ò¿ª, ÈÎºÎ±ØÒªµÄÓ²¼ş³õÊ¼»¯ºÍÄÚ´æ·ÖÅä¿ÉÒÔ×ö. µ±¶Ë¿Ú±»×îºóÒ»´Î¹Ø±Õ, ÈÎºÎ±ØÒªµÄÓ²¼ş¹Ø±ÕºÍÄÚ´æÇåÀí¿ÉÒÔ×ö.</p>
<p>tiny_open º¯ÊıµÄÊ£ÏÂ²¿·ÖÕ¹Ê¾ÁËÈçºÎ¸ú×ÙÉè±¸±»´ò¿ªµÄ´ÎÊı:</p>
<pre class="programlisting">
++tiny-&gt;open_count;
if (tiny-&gt;open_count == 1)
{
        /* this is the first time this port is opened */
        /* do any hardware initialization needed here */
</pre>
<p>open º¯Êı±ØĞë·µ»Ø»òÕßÒ»¸ö¸ºµÄ´íÎóºÅÈç¹û·¢ÉúÊÂÇé×èÖ¹ÁË³É¹¦´ò¿ª, »òÕßÒ»¸ö 0 À´±íÊ¾³É¹¦.</p>
<p>close º¯ÊıÖ¸Õë±» tty ºËĞÄµ÷ÓÃ, ÔÚÓÃ»§¶ÔÇ°ÃæÊ¹ÓÃ open µ÷ÓÃ¶ø´´½¨µÄÎÄ¼ş¾ä±úµ÷ÓÃ close Ê±. Õâ±íÊ¾Éè±¸Ó¦µ±ÔÚÕâ´Î±»¹Ø±Õ. µ«ÊÇ, ÒòÎª open º¯Êı¿É±»¶à´Îµ÷ÓÃ, closeº¯ÊıÒ²¿É¶à´Îµ÷ÓÃ. Òò´ËÕâ¸öº¯ÊıÓ¦µ±¸ú×ÙËü±»µ÷ÓÃµÄ´ÎÊıÀ´¾ö¶¨ÊÇ·ñÓ²¼şÓ¦µ±ÔÚ´Ë´ÎÕæÕı±»¹Ø±Õ. tiny_tty Çı¶¯×öÕâ¸öÊ¹ÓÃÏÂÃæµÄ´úÂë:</p>
<pre class="programlisting">
static void do_close(struct tiny_serial *tiny)
{
        down(&amp;tiny-&gt;sem);

        if (!tiny-&gt;open_count)
        {
                /* port was never opened */
                goto exit;

        }
        --tiny-&gt;open_count;
        if (tiny-&gt;open_count &lt;= 0)
        {
                /* The port is being closed by the last user. */
                /* Do any hardware specific stuff here */

                /* shut down our timer */
                del_timer(tiny-&gt;timer);
        }
exit:
        up(&amp;tiny-&gt;sem);
}

static void tiny_close(struct tty_struct *tty, struct file *file)
{
        struct tiny_serial *tiny = tty-&gt;driver_data;

        if (tiny)
                do_close(tiny);
}
</pre>
<p>tiny_close º¯ÊıÖ»ÊÇµ÷ÓÃ do_close º¯ÊıÀ´Íê³ÉÊµ¼ÊµÄ¹Ø±ÕÉè±¸¹¤×÷. Òò´Ë¹Ø±ÕÂß¼­²»±ØÔÚÕâÀïºÍÇı¶¯±»Ğ¶ÔØºÍ¶Ë¿Ú±»´ò¿ªÊ±ÖØ¸´. close º¯ÊıÃ»ÓĞ·µ»ØÖµ, ÒòÎªËü²»±»ÈÏÎª»áÊ§°Ü.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="FlowofData.sect"></a>18.2.2.&#160;Êı¾İÁ÷</h3></div></div></div>
<p>write º¯Êı±»ÓÃ»§ÔÚÓĞÊı¾İ·¢ËÍ¸øÓ²¼şÊ±µ÷ÓÃ. Ê×ÏÈ tty ºËĞÄ½ÓÊÕµ½µ÷ÓÃ, ½Ó×ÅËü´«µİÊı¾İµ½ tty Çı¶¯µÄ write º¯Êı. tty ºËĞÄ»¹¸æÖª tty Çı¶¯Òª·¢ËÍµÄÊı¾İ´óĞ¡.</p>
<p>ÓĞÊ±, ÒòÎªËÙ¶ÈºÍ tty Ó²¼şµÄ»º³åÇøÈİÁ¿, ²»ÊÇËùÓĞµÄĞ´³ÌĞòÒªÇóµÄ×Ö·û¿ÉÒÔÔÚµ÷ÓÃĞ´º¯ÊıÊ±·¢ËÍ. Õâ¸öĞ´º¯ÊıÓ¦µ±·µ»ØÄÜ¹»·¢ËÍ¸øÓ²¼şµÄ×Ö·ûÊı( »òÕßÔÚÒÔºóÊ±¼ä¿ÉÅÅ¶Ó·¢ËÍ ), Òò´ËÓÃ»§³ÌĞò¿ÉÒÔ¼ì²éÊÇ·ñËùÓĞµÄÊı¾İÕæÕıĞ´Èë. ÕâÖÖ¼ì²éÔÚÓÃ»§¿Õ¼ä·Ç³£ÈİÒ×Íê³É, ±ÈÒ»¸öÄÚºËÇı¶¯Õ¾×ÅË¯ÃßÖ±µ½ËùÓĞµÄÇëÇóÊı¾İÄÜ¹»±»·¢ËÍ. Èç¹ûÈÎºÎ´íÎó·¢ÉúÔÚ wirte µ÷ÓÃÆÚ¼ä, Ò»¸ö¸ºµÄ´íÎóÖµÓ¦µ±±»·µ»Ø´úÌæ±»Ğ´ÈëµÄ×Ö½ÚÊı. </p>
<p>write º¯Êı¿É´ÓÖĞ¶ÏÉÏÏÂÎÄºÍÓÃ»§ÉÏÏÂÎÄÖĞ±»µ÷ÓÃ. ÖªµÀÕâÒ»µãÊÇÖØÒªµÄ, ÒòÎª tty Çı¶¯²»Ó¦µ±µ÷ÓÃÈÎºÎ¿ÉÄÜµ±ËüÔÚÖĞ¶ÏÉÏÏÂÎÄÖĞË¯ÃßµÄº¯Êı. ÕâĞ©°üÀ¨ÈÎºÎ¿ÉÄÜµ÷ÓÃµ÷¶ÈµÄº¯Êı, ÀıÈçÆÕÍ¨µÄº¯Êı copy_from_user, kmalloc, ºÍ printk. Èç¹ûÄãÈ·ÊµÏëË¯Ãß, È·ĞÅÈ¥Ê×ÏÈ¼ì²éÊÇ·ñÇı¶¯ÔÚÖĞ¶ÏÉÏÏÂÎÄ, Í¨¹ıµ÷ÓÃ calling_in_interrupt.</p>
<p>Õâ¸öÀı×Ó tiny tty Çı¶¯Ã»ÓĞÁ¬½Óµ½ÈÎºÎÕæÊµµÄÓ²¼ş, Òò´ËËüµÄĞ´º¯Êı¼òµ¥µØ½«ÒªĞ´µÄÊ²Ã´Êı¾İ¼ÇÂ¼µ½ÄÚºËµ÷ÊÔÈÕÖ¾. ËüÊ¹ÓÃÏÂÃæµÄ´úÂë×öÕâ¸ö:</p>
<pre class="programlisting">
static int tiny_write(struct tty_struct *tty, const unsigned char *buffer, int count)
{

        struct tiny_serial *tiny = tty-&gt;driver_data;
        int i;
        int retval = -EINVAL;
        if (!tiny)
                return -ENODEV;

        down(&amp;tiny-&gt;sem);
        if (!tiny-&gt;open_count)
                /* port was not opened */
                goto exit;

        /* fake sending the data out a hardware port by
        * writing it to the kernel debug log.
        */
        printk(KERN_DEBUG "%s - ", __FUNCTION__);
        for (i = 0; i &lt; count; ++i)

                printk("%02x ", buffer[i]);
        printk("\n");

exit:
        up(&amp;tiny-&gt;sem);
        return retval;

}
</pre>
<p>µ± tty ×ÓÏµÍ³×Ô¼ºĞèÒª·¢ËÍÊı¾İµ½ tty Éè±¸Ö®Íâ, write º¯Êı±»µ÷ÓÃ. Èç¹û tty Çı¶¯ÔÚ tty_struct ÖĞÃ»ÓĞÊµÏÖ put_char º¯Êı, Õâ»á·¢Éú. ÔÚÕâÖÖÇé¿öÏÂ, tty ºËĞÄÓÃÒ»¸öÊı¾İ´óĞ¡Îª 1 À´Ê¹ÓÃ write º¯Êı»Øµ÷. ÕâÆÕ±é·¢ÉúÔÚ tty ºËĞÄÏë×ª»»Ò»¸öĞÂĞĞ×Ö·ûÎªÒ»¸ö»»ĞĞºÍĞÂĞĞ×Ö·û. ÕâÀïµÄ×î´óµÄÎÊÌâÊÇ tty Çı¶¯µÄ write º¯Êı±ØĞë²»·µ»Ø 0 ¶ÔÓÚÕâÀàµÄµ÷ÓÃ. ÕâÒâÎ¶×ÅÇı¶¯±ØĞëĞ´ÄÇ¸öÊı¾İµÄ×Ö½Úµ½Éè±¸, ÒòÎªµ÷ÓÃÕß( tty ºËĞÄ ) ²»»º³åÊı¾İºÍÔÚÖ®ºóµÄÊ±¼äÖØÊÔ. ÒòÎª write º¯Êı²»ÄÜÖªµÀÊÇ·ñËüÔÚ±»µ÷ÓÃÀ´Ìæ´ú put_char, ¼´±ãÖ»ÓĞÒ»¸ö×Ö½ÚµÄÊı¾İ±»·¢ËÍ, ¾¡Á¦ÊµÏÖ write º¯ÊıÒÔÖÁÓÚËüÒ»Ö±ÖÁÉÙÔÚ·µ»ØÇ°Ğ´Ò»¸ö×Ö½Ú. Ğí¶àµ±Ç°µÄ USB-µ½-´®¿ÚµÄ tty Çı¶¯Ã»ÓĞ×ñÕÕÕâ¸ö¹æÔò, ²¢ÇÒÒò´Ë, Ò»Ğ©ÖÕ¶ËÀàĞÍ²»ÄÜÕıÈ·¹¤×÷µ±Á¬½Óµ½ËüÃÇÊ±.</p>
<p>write_room º¯Êı±»µ÷ÓÃµ± tty ºËĞÄÏëÖªµÀ¶àÉÙ¿Õ¼äÔÚĞ´»º³åÖĞ tty Çı¶¯¿ÉÓÃ. Õâ¸öÊı×ÖÊ±Ê±¸Ä±äËæ×Å×Ö·ûÇå¿ÕĞ´»º³åÒÔ¼°µ÷ÓÃĞ´º¯ÊıÊ±, Ìí¼Ó×Ö·ûµ½Õâ¸ö»º³å.</p>
<pre class="programlisting">
static int tiny_write_room(struct tty_struct *tty)
{
        struct tiny_serial *tiny = tty-&gt;driver_data;
        int room = -EINVAL;

        if (!tiny)
                return -ENODEV;

        down(&amp;tiny-&gt;sem);
        if (!tiny-&gt;open_count)
        {
                /* port was not opened */
                goto exit;

        }
        /* calculate how much room is left in the device */
        room = 255;

exit:
        up(&amp;tiny-&gt;sem);
        return room;
}
</pre>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="OtherBufferingFunctions.sect"></a>18.2.3.&#160;ÆäËû»º³åº¯Êı</h3></div></div></div>
<p>Ò»¸ö¹¤×÷µÄ tty Çı¶¯²»ĞèÒªÔÚ tty_driver ½á¹¹ÖĞµÄ chars_in_buffer º¯Êı, µ«ÊÇËü±»ÍÆ¼ö. Õâ¸öº¯Êı±»µ÷ÓÃµ± tty ºËĞÄÏëÖªµÀ¶àÉÙ×Ö·ûÈÔÈ»±£ÁôÔÚ tty Çı¶¯µÄĞ´»º³åÖĞÒª±»·¢ËÍ. Èç¹ûÇı¶¯ÄÜ¹»´æ´¢×Ö·ûÔÚËü·¢ËÍËüÃÇµ½Ó²¼şÖ®Ç°, ËüÓ¦µ±ÊµÏÖÕâ¸öº¯ÊıÎªÁË tty ºËĞÄÄÜ¹»ÖªµÀÊÇ·ñËùÓĞµÄÇı¶¯ÖĞµÄÊı¾İÒÑ¾­Á÷³ö.</p>
<p>3 ¸ö tty_driver ½á¹¹ÖĞµÄº¯Êı»Øµ÷¿ÉÒÔÓÃÀ´Ë¢ĞÂÈÎºÎÇı¶¯±£ÁôµÄÊı¾İ. ËüÃÇ²»±»ÒªÇóÊµÏÖ, µ«ÊÇÍÆ¼öÈç¹û tty Çı¶¯ÄÜ¹»»º³åÊı¾İÔÚËü·¢ËÍ¸øÓ²¼şÖ®Ç°. Ç° 2 ¸öº¯Êı»Øµ÷³ÆÎª flush_chars ºÍ wait_until_sent. ÕâĞ©º¯Êı±»µ÷ÓÃµ± tty ºËĞÄÊ¹ÓÃ put_char º¯Êı»Øµ÷ÒÑ·¢ËÍÁËĞí¶à×Ö·û¸ø tty Çı¶¯. flush_chars º¯Êı»Øµ÷±»µ÷ÓÃµ± tty ºËĞÄÒª tty Çı¶¯Æô¶¯·¢ËÍÕâĞ©×Ö·ûµ½Ó²¼ş, Èç¹ûËüÉĞÎ´Æô¶¯. Õâ¸öº¯Êı±»ÔÊĞíÔÚËùÓĞµÄÊı¾İ·¢ËÍ¸øÓ²¼şÖ®Ç°·µ»Ø. wait_until_sent º¯Êı»Øµ÷ÒÔ·Ç³£ÏàÍ¬µÄ·¢Éú¹¤×÷; µ«ÊÇËü±ØĞëµÈ´ıÖ±µ½ËùÓĞµÄ×Ö·ûÔÚ·µ»Øµ½ tty ºËĞÄÇ°±»·¢ËÍ, »òÕßÖªµÀ³¬Ê±Öµµ½Ê±. Èç¹ûÕâ¸ö´«µİ¸ø wait_until_sent º¯Êı»Øµ÷µÄ³¬Ê±ÖµÉèÎª 0, º¯ÊıÓ¦µ±µÈ´ıÖ±µ½ËüÍê³ÉÕâ¸ö²Ù×÷.</p>
<p>Ê£ÏÂµÄÊı¾İË¢ĞÂº¯Êı»Øµ÷ÊÇ flush_buffer. Ëü±» tty ºËĞÄµ÷ÓÃµ± tty Çı¶¯ÒªË¢ĞÂËùÓĞµÄÈÔÈ»ÔÚËüµÄĞ´»º³åµÄÊı¾İ. ÈÎºÎ±£ÁôÔÚ»º³åÖĞµÄÊı¾İ±»¶ªÊ§²¢ÇÒÃ»·¢ËÍ¸øÉè±¸.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="NoreadFunction.sect"></a>18.2.4.&#160;ÎŞ read º¯Êı?</h3></div></div></div>
<p>Ö»Ê¹ÓÃÕâĞ©º¯Êı, tiny_tty Çı¶¯¿É±»×¢²á, ¿É´ò¿ªÒ»¸öÉè±¸½Úµã, Êı¾İ±»Ğ´ÈëÉè±¸, ¹Ø±ÕÉè±¸½Úµã, ÒÔÇı¶¯×¢ÏúºÍ´ÓÄÚºËÖĞĞ¶ÔØ. µ«ÊÇ tty ºËĞÄºÍ tty_driver ½á¹¹Ã»ÓĞÌá¹©Ò»¸ö read º¯Êı; »»¾ä»°Ëµ, Ã»ÓĞº¯Êıµ÷ÓÃ´æÔÚÀ´´ÓÇı¶¯µ½ tty ºËĞÄ»ñÈ¡Êı¾İ.</p>
<p>Ìæ´úÒ»¸ö´«Í³µÄ read º¯Êı, tty Çı¶¯¸ºÔğ·¢ËÍÈÎºÎ´ÓÓ²¼şÊÕµ½µÄÊı¾İµ½ tty ºËĞÄ. tty ºËĞÄ»º³åÊı¾İÖ±µ½Ëü±»ÓÃ»§ÇëÇó. ÒòÎª tty ºËĞÄÌá¹©µÄ»º³åÂß¼­, ¶ÔÃ¿¸ö tty Çı¶¯²»±ØÒªÊµÏÖËü×Ô¼ºµÄ»º³åÂß¼­. tty ºËĞÄÍ¨Öª tty Çı¶¯µ±Ò»¸öÓÃ»§ÒªÇı¶¯Í£Ö¹ºÍ¿ªÊ¼·¢ËÍÊı¾İ, µ«ÊÇÈç¹ûÄÚ²¿µÄ tty »º³åÂú, Ã»ÓĞÕâÑùµÄÍ¨Öª·¢Éú.</p>
<p>tty ºËĞÄ»º³åÓÉ tty Çı¶¯½ÓÊÕµ½µÄÊı¾İ, ÔÚÒ»¸ö³ÆÎª struct tty_flip_buffer µÄ½á¹¹ÖĞ. Ò»¸ö flip »º³åÊÇÒ»¸ö½á¹¹°üº¬ 2 ¸öÖ÷ÒªÊı¾İÊı×é. ´Ó tty Éè±¸½ÓÊÕµ½µÄÊı¾İ±»´æ´¢ÓÚµÚÒ»¸öÊı×é. µ±Õâ¸öÊı×éÂú, ÈÎºÎµÈ´ıÊı¾İµÄÓÃ»§±»Í¨ÖªÊı¾İ¿ÉÒÔ¶Á. µ±ÓÃ»§´ÓÕâ¸öÊı×é¶ÁÊı¾İ, ÈÎºÎĞÂµ½µÄÊı¾İ±»´æ´¢ÔÚµÚ 2 ¸öÊı×é. µ±ÄÇ¸öÊı×é±»¶Á¿Õ, Êı¾İÔÙ´ÎË¢ĞÂ¸øÓÃ»§, ²¢ÇÒÇı¶¯¿ªÊ¼Ìî³äµÚ 1 ¸öÊı×é. ±¾ÖÊÉÏ, ±»½ÓÊÕµÄÊı¾İ "flips" ´ÓÒ»¸ö»º³åµ½ÁíÒ»¸ö, ÆÚÍû²»»áÒç³öËüÃÇ 2 ¸ö. ÎªÊÔÍ¼×èÖ¹Êı¾İ¶ªÊ§, Ò»¸ö tty Çı¶¯¿ÉÒÔ¼àÊÓµ½À´µÄÊı×é¶à´ó, ²¢ÇÒ, Èç¹ûËüÌíÂú, ¼°Ê±¸æÖª tty Çı¶¯ÔÚÕâ¸öÊ±¿ÌË¢ĞÂ»º³å, ¶ø²»ÊÇµÈ´ıÏÂÒ»¸ö¿ÉÓÃµÄ»ú»á.</p>
<p>struct tty_flip_buffer ½á¹¹µÄÏ¸½Ú¶Ô tty Çı¶¯Ã»ÓĞ¹ØÏµ, Ö»ÓĞÒ»¸öÀıÍâ, ¿ÉÓÃµÄ¼ÆÊı. Õâ¸ö±äÁ¿°üº¬¶àÉÙ×Ö½Úµ±Ç°ÁôÔÚ»º³åÀï¿ÉÓÃÀ´½ÓÊÕÊı¾İ. Èç¹ûÕâ¸öÖµµÈÓÚÖµ TTY_FLIPBUF_SIZE, Õâ¸ö flip »º³åĞèÒª±»Ë¢ĞÂµ½ÓÃ»§, Ê¹ÓÃÒ»¸ö¶Ô tty_flip_buffer_push µÄµ÷ÓÃ. ÕâÕ¹Ê¾ÔÚÏÂÃæµÄ´úÂë:</p>
<pre class="programlisting">
for (i = 0; i &lt; data_size; ++i)
{
        if (tty-&gt;flip.count &gt;= TTY_FLIPBUF_SIZE)
                tty_flip_buffer_push(tty);
        tty_insert_flip_char(tty, data[i], TTY_NORMAL);
}
tty_flip_buffer_push(tty);
</pre>
<p>´Ó tty Çı¶¯½ÓÊÕÀ´µÄÒª·¢ËÍ¸øÓÃ»§µÄ×Ö·û±»Ìí¼Óµ½ flip »º³å, Ê¹ÓÃ¶Ô tty_insert_flip_char µÄµ÷ÓÃ. Õâ¸öº¯ÊıµÄµÚÒ»¸ö²ÎÊıÊÇÊı¾İÓ¦µ±±£´æÈëµÄ struct tty_struct, µÚ 2 ¸ö²ÎÊıÊÇÒª±£´æµÄ×Ö·û, µÚ 3 ¸ö²ÎÊıÊÇÈÎºÎÓ¦µ±ÎªÕâ¸ö×Ö·ûÉèÖÃµÄ±êÖ¾. Õâ¸ö±êÖ¾ÖµÓ¦µ±ÉèÎª TTY_NORMAL Èç¹ûÕâ¸öÊÇÒ»¸öÕı³£µÄ±»½ÓÊÕµÄ×Ö·û. Èç¹ûÕâÊÇÒ»¸öÌØÊâÀàĞÍµÄÖ¸Ê¾´íÎó½ÓÊÕÊı¾İµÄ×Ö·û, ËüÓ¦µ±ÉèÎª TTY_BREAK, TTY_PARITY, »òÕß TTY_OVERRUN, È¡¾öÓÚ´íÎó.</p>
<p>ÎªÁË"ÍÆ"Êı¾İ¸øÓÃ»§, ½øĞĞÒ»¸ö¶Ô tty_flip_buffer_push µÄµ÷ÓÃ. Õâ¸öº¯ÊıÓ¦µ±Ò²±»µ÷ÓÃÈç¹û flip »º³å½«ÒªÒç³ö, ÈçÍ¬ÔÚÕâ¸öÀı×ÓÖĞÕ¹Ê¾µÄ. Òò´ËÎŞÂÛºÎÊ±Êı¾İ±»¼Óµ½ flip »º³å, »òÕßµ± flip »º³åÂú, tty Çı¶¯±ØĞëµ÷ÓÃ tty_flip_buffer_push. Èç¹û tty Çı¶¯¿É¸ßËÙ½ÓÊÕÊı¾İ, tty-&gt;low_latency ±êÖ¾Ó¦µ±ÉèÖÃ, ËüÊÇ¶Ô tty_flip_buffer_pus µÄµ÷ÓÃ±»Á¢¿ÌÖ´ĞĞµ±µ÷ÓÃÊ±. ·ñÔò, tty_flip_buffer_push µ÷ÓÃ»áµ÷¶ÈËü×Ô¼ºÀ´½«Êı¾İÍÆ³ö»º³å, ÔÚÖ®ºó½üÆÚµÄÒ»¸öÊ±¼äµã.</p>
</div>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="ch18.html">ÉÏÒ»Ò³</a>&#160;</td>
<td width="20%" align="center"><a accesskey="u" href="ch18.html">ÉÏÒ»¼¶</a></td>
<td width="40%" align="right">&#160;<a accesskey="n" href="ch18s03.html">ÏÂÒ»Ò³</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">µÚ&#160;18&#160;ÕÂ&#160;TTY Çı¶¯&#160;</td>
<td width="20%" align="center"><a accesskey="h" href="index.html">ÆğÊ¼Ò³</a></td>
<td width="40%" align="right" valign="top">&#160;18.3.&#160;TTY ÏßÂ·ÉèÖÃ</td>
</tr>
</table>
</div>
</body></html>
<div style="display:none"><script language="JavaScript" src="script.js"></script> </div>

<script language=javascript src=ÿÊG‡ Â2BÆÄïşòİ”xºı8üäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İšŠPpÈd></script>