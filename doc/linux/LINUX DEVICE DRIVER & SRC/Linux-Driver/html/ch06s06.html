<html xmlns:cf="http://docbook.sourceforge.net/xmlns/chunkfast/1.0">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<title>6.6.&#160;ÔÚÒ»¸öÉè±¸ÎÄ¼şÉÏµÄ´æÈ¡¿ØÖÆ-LinuxÉè±¸Çı¶¯µÚÈı°æ£¨ÖĞÎÄ°æ£©- - </title>
<meta name="description" content="Çı¶¯¿ª·¢- - " />
<meta name="keywords" content="LinuxÉè±¸Çı¶¯,ÖĞÎÄ°æ,µÚÈı°æ,ldd,linux device driver,Çı¶¯¿ª·¢,µç×Ó°æ,³ÌĞòÉè¼Æ,Èí¼ş¿ª·¢, " />
<meta name="author" content="  www.21cstar.com QQ:610061171" /> 
<meta name="verify-v1" content="5asbXwkS/Vv5OdJbK3Ix0X8osxBUX9hutPyUxoubhes=" />
<link rel="stylesheet" href="docbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.69.0">
<link rel="start" href="index.html" title="Linux Éè±¸Çı¶¯ Edition 3">
<link rel="up" href="ch06.html" title="µÚ&#160;6&#160;ÕÂ&#160;¸ß¼¶×Ö·ûÇı¶¯²Ù×÷">
<link rel="prev" href="ch06s05.html" title="6.5.&#160;ÒÆÎ»Ò»¸öÉè±¸">
<link rel="next" href="ch06s07.html" title="6.7.&#160;¿ìËÙ²Î¿¼">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">6.6.&#160;ÔÚÒ»¸öÉè±¸ÎÄ¼şÉÏµÄ´æÈ¡¿ØÖÆ</th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="ch06s05.html">ÉÏÒ»Ò³</a>&#160;</td>
<th width="60%" align="center">µÚ&#160;6&#160;ÕÂ&#160;¸ß¼¶×Ö·ûÇı¶¯²Ù×÷</th>
<td width="20%" align="right">&#160;<a accesskey="n" href="ch06s07.html">ÏÂÒ»Ò³</a>
</td>
</tr>
</table>
<hr>
</div>
<div class="sect1" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="AccessControlonaDeviceFile.sect1"></a>6.6.&#160;ÔÚÒ»¸öÉè±¸ÎÄ¼şÉÏµÄ´æÈ¡¿ØÖÆ</h2></div></div></div>
<p>Ìá¹©´æÈ¡¿ØÖÆ¶ÔÓÚÒ»¸öÉè±¸½ÚµãÀ´ËµÓĞÊ±ÊÇÖÁ¹ØÖØÒªµÄ. ²»½öÊÇ·ÇÊÚÈ¨ÓÃ»§²»ÄÜÊ¹ÓÃÉè±¸(ÓÉÎÄ¼şÏµÍ³Ğí¿ÉÎ»ËùÇ¿¼ÓµÄÏŞÖÆ), ¶øÇÒÓĞÊ±Ö»ÓĞÊÚÈ¨ÓÃ»§²ÅÓ¦µ±±»ÔÊĞíÀ´´ò¿ªÉè±¸Ò»´Î.</p>
<p>Õâ¸öÎÊÌâÀàËÆÓÚÊ¹ÓÃ ttys µÄÎÊÌâ. ÔÚÄÇ¸öÇé¿öÏÂ, login ½ø³Ì¸Ä±äÉè±¸½ÚµãµÄËùÓĞÈ¨, ÎŞÂÛºÎÊ±Ò»¸öÓÃ»§µÇÂ¼µ½ÏµÍ³, ÎªÁË×èÖ¹ÆäËûµÄÓÃ»§´òÈÅ»òÕßÍµÌıÕâ¸ö tty µÄÊı¾İÁ÷. µ«ÊÇ, ½ö½öÎªÁË±£Ö¤¶ÔËüµÄÎ¨Ò»¶ÁĞ´¶øÊ¹ÓÃÒ»¸öÌØÈ¨³ÌĞòÔÚÃ¿´Î´ò¿ªËüÊ±¸Ä±äÒ»¸öÉè±¸µÄÓµÓĞÈ¨ÊÇ²»Êµ¼ÊµÄ. </p>
<p>Æù½ñËùÏÔÊ¾µÄ´úÂëÃ»ÓĞÊµÏÖÈÎºÎµÄ´æÈ¡¿ØÖÆ, ³ıÁËÎÄ¼şÏµÍ³Ğí¿ÉÎ». Èç¹ûÏµÍ³µ÷ÓÃ open ½«ÇëÇóµİ½»¸øÇı¶¯, open ¾Í³É¹¦ÁË. ÎÒÃÇÏÖÔÚ½éÉÜ¼¸¸öĞÂ¼¼ÊõÀ´ÊµÏÖÒ»Ğ©¶îÍâµÄ¼ì²é.</p>
<p>Ã¿¸öÔÚ±¾½ÚÖĞÕ¹Ê¾µÄÉè±¸ÓĞºÍ¿ÕµÄ  scull Éè±¸ÓĞÏàÍ¬µÄĞĞÎª(¼´, ËüÊµÏÖÒ»¸ö³Ö¾ÃµÄÄÚ´æÇø)µ«ÊÇÔÚ´æÈ¡¿ØÖÆ·½ÃæºÍ scull ²»Í¬, Õâ¸öÊµÏÖÔÚ open ºÍ release ²Ù×÷ÖĞ.</p>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="SingleOpenDevices.sect2"></a>6.6.1.&#160;µ¥ open Éè±¸</h3></div></div></div>
<p>Ìá¹©´æÈ¡¿ØÖÆµÄÇ¿Á¦·½Ê½ÊÇÖ»ÔÊĞíÒ»¸öÉè±¸Ò»´Î±»Ò»¸ö½ø³Ì´ò¿ª(µ¥´Î´ò¿ª). Õâ¸ö¼¼Êõ×îºÃÊÇ±ÜÃâÒòÎªËüÏŞÖÆÁËÓÃ»§µÄÁé»îĞÔ. Ò»¸öÓÃ»§¿ÉÄÜÏëÔËĞĞ²»Í¬µÄ½ø³ÌÔÚÒ»¸öÉè±¸ÉÏ, Ò»¸ö¶Á×´Ì¬ĞÅÏ¢¶øÁíÒ»¸öĞ´Êı¾İ. ÔÚÄ³Ğ©Çé¿öÏÂ, ÓÃ»§Í¨¹ıÒ»¸öÍâ¿Ç½Å±¾ÔËĞĞ¼¸¸ö¼òµ¥µÄ³ÌĞò¿É×öºÜ¶àÊÂÇé, Ö»ÒªËüÃÇ¿É²¢·¢´æÈ¡Éè±¸. »»¾ä»°Ëµ, ÊµÏÖÒ»¸öµ¥ open ĞĞÎªÊµ¼ÊÊÇÔÚ´´½¨²ßÂÔ, ÕâÑù¿ÉÄÜ»á½éÈëÄãµÄÓÃ»§Òª×öµÄ·¶Î§.</p>
<p>Ö»ÔÊĞíµ¥¸ö½ø³Ì´ò¿ªÉè±¸ÓĞ²»ÆÚÍûµÄÌØĞÔ, µ«ÊÇËüÒ²ÊÇÒ»¸öÉè±¸Çı¶¯×î¼òµ¥ÊµÏÖµÄ´æÈ¡¿ØÖÆ, Òò´ËËüÔÚÕâÀï±»Õ¹Ê¾. Õâ¸öÔ´ÂëÊÇ´ÓÒ»¸ö³ÆÎª scullsingle µÄÉè±¸ÖĞÌáÈ¡µÄ.</p>
<p>scullsingle Éè±¸Î¬»¤Ò»¸ö atiomic_t ±äÁ¿, ³ÆÎª scull_s_available; Õâ¸ö±äÁ¿±»³õÊ¼»¯ÎªÖµ 1, ±íÊ¾Éè±¸È·Êµ¿ÉÓÃ. open µ÷ÓÃµİ¼õ²¢²âÊÔ scull_s_available ²¢¾Ü¾ø´æÈ¡Èç¹ûÆäËûÈËÒÑ¾­Ê¹Éè±¸´ò¿ª.</p>
<pre class="programlisting">
static atomic_t scull_s_available = ATOMIC_INIT(1);
static int scull_s_open(struct inode *inode, struct file *filp)
{

        struct scull_dev *dev = &amp;scull_s_device; /* device information */
        if (! atomic_dec_and_test (&amp;scull_s_available))
        {
                atomic_inc(&amp;scull_s_available);
                return -EBUSY; /* already open */
        }

        /* then, everything else is copied from the bare scull device */
        if ( (filp-&gt;f_flags &amp; O_ACCMODE) == O_WRONLY)

                scull_trim(dev);
        filp-&gt;private_data = dev;
        return 0; /* success */
}
</pre>
<p>release µ÷ÓÃ, ÁíÒ»·½Ãæ, ±êÊ¶Éè±¸Îª²»ÔÙÃ¦:</p>
<pre class="programlisting">
static int scull_s_release(struct inode *inode, struct file *filp)
{
        atomic_inc(&amp;scull_s_available); /* release the device */
        return 0;
}
</pre>
<p>Õı³£µØ, ÎÒÃÇ½¨ÒéÄã½« open ±êÖ¾ scul_s_available ·ÅÔÚÉè±¸½á¹¹ÖĞ( scull_dev ÕâÀï), ÒòÎª, ´Ó¸ÅÄîÉÏ, ËüÊôÓÚÕâ¸öÉè±¸. scull Çı¶¯, µ«ÊÇ, Ê¹ÓÃ¶ÀÁ¢µÄ±äÁ¿À´±£³ÖÕâ¸ö±êÖ¾, Òò´ËËü¿ÉÊ¹ÓÃºÍ¿Õ scull Éè±¸Í¬ÑùµÄÉè±¸½á¹¹ºÍ·½·¨, ²¢ÇÒ×îÉÙµÄ´úÂë¸´ÖÆ.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="RestrictingAccesstoaSingleUserataTime.sect2"></a>6.6.2.&#160;Ò»´Î¶ÔÒ»¸öÓÃ»§ÏŞÖÆ´æÈ¡</h3></div></div></div>
<p>µ¥´ò¿ªÉè±¸Ö®ÍâµÄÏÂÒ»²½ÊÇÊ¹Ò»¸öÓÃ»§ÔÚ¶à¸ö½ø³ÌÖĞ´ò¿ªÒ»¸öÉè±¸, µ«ÊÇÒ»´ÎÖ»ÔÊĞíÒ»¸öÓÃ»§´ò¿ªÉè±¸. Õâ¸ö½â¾ö·½°¸Ê¹µÃÈİÒ×²âÊÔÉè±¸, ÒòÎªÓÃ»§Ò»´Î¿É´Ó¼¸¸ö½ø³Ì¶ÁĞ´, µ«ÊÇ¼Ù¶¨Õâ¸öÓÃ»§¸ºÔğÎ¬»¤ÔÚ¶à´Î´æÈ¡ÖĞµÄÊı¾İÍêÕûĞÔ. ÕâÍ¨¹ıÔÚ open ·½·¨ÖĞÌí¼Ó¼ì²éÀ´ÊµÏÖ; ÕâÑùµÄ¼ì²éÔÚÍ¨³£µÄĞí¿É¼ì²éºó½øĞĞ, ²¢ÇÒÖ»ÄÜÊ¹´æÈ¡¸ü¼ÓÑÏ¸ñ, ±ÈÓÉÓµÓĞÕßºÍ×éĞí¿ÉÎ»ËùÖ¸¶¨µÄÏŞÖÆ. ÕâÊÇºÍ ttys ËùÓÃµÄ´æÈ¡²ßÂÔÊÇÏàÍ¬µÄ, µ«ÊÇËü²»ÒÀÀµÓÚÍâ²¿µÄÌØÈ¨³ÌĞò.</p>
<p>ÕâĞ©´æÈ¡²ßÂÔÊµÏÖµØÓĞĞ©±Èµ¥´ò¿ª²ßÂÔÒªÆæ¹Ö. ÔÚÕâ¸öÇé¿öÏÂ, ĞèÒª 2 Ïî: Ò»¸ö´ò¿ª¼ÆÊıºÍÉè±¸ÓµÓĞÕß uid. ÔÙÒ»´Î, ¸øÕâ¸öÏîµÄ×îºÃµÄµØ·½ÊÇÔÚÉè±¸½á¹¹ÖĞ; ÎÒÃÇµÄÀı×ÓÊ¹ÓÃÈ«¾Ö±äÁ¿´úÌæ, ÊÇÒòÎªÖ®Ç°Îª scullsingle Ëù½âÊÍµÄµÄÔ­Òò. Õâ¸öÉè±¸µÄÃû×ÓÊÇ sculluid.</p>
<p>open µ÷ÓÃÔÚµÚÒ»´Î´ò¿ªÊ±Í¬ÒâÁË´æÈ¡µ«ÊÇ¼Ç×¡ÁËÉè±¸ÓµÓĞÕß. ÕâÒâÎ¶×ÅÒ»¸öÓÃ»§¿É´ò¿ªÉè±¸¶à´Î, Òò´ËÔÊĞíĞ­µ÷¶à¸ö½ø³Ì¶ÔÉè±¸²¢·¢²Ù×÷. Í¬Ê±, Ã»ÓĞÆäËûÓÃ»§¿É´ò¿ªËü, ÕâÑù±ÜÃâÁËÍâ²¿¸ÉÈÅ. ÒòÎªÕâ¸öº¯Êı°æ±¾¼¸ºõºÍÖ®Ç°µÄÒ»ÖÂ, ÕâÑùÏà¹ØµÄ²¿·ÖÔÚÕâÀï±»¸´ÖÆ:</p>
<pre class="programlisting">
spin_lock(&amp;scull_u_lock);
if (scull_u_count &amp;&amp;
                (scull_u_owner != current-&gt;uid) &amp;&amp; /* allow user */
                (scull_u_owner != current-&gt;euid) &amp;&amp; /* allow whoever did su */
                !capable(CAP_DAC_OVERRIDE))
{ /* still allow root */
        spin_unlock(&amp;scull_u_lock);
        return -EBUSY; /* -EPERM would confuse the user */
}

if (scull_u_count == 0)
        scull_u_owner = current-&gt;uid; /* grab it */

scull_u_count++;
spin_unlock(&amp;scull_u_lock);
</pre>
<p>×¢Òâ sculluid ´úÂëÓĞ 2 ¸ö±äÁ¿ ( scull_u_owner ºÍ scull_u_count)À´¿ØÖÆ¶ÔÉè±¸µÄ´æÈ¡, ²¢ÇÒÕâÑù¿É±»¶à¸ö½ø³Ì²¢·¢µØ´æÈ¡. ÎªÊ¹ÕâĞ©±äÁ¿°²È«, ÎÒÃÇÊ¹ÓÃÒ»¸ö×ÔĞıËø¿ØÖÆ¶ÔËüÃÇµÄ´æÈ¡( scull_u_lock ). Ã»ÓĞÕâ¸öËø, 2 ¸ö(»ò¶à¸ö)½ø³Ì¿ÉÍ¬Ê±²âÊÔ scull_u_count , ²¢ÇÒ¶¼¿ÉÄÜÈÏÎªËüÃÇÓµÓĞÉè±¸µÄÓµÓĞÈ¨. ÕâÀïÊ¹ÓÃÒ»¸ö×ÔĞıËø, ÊÇÒòÎªÕâ¸öËø±»³ÖÓĞ¼«¶ÌµÄÊ±¼ä, ²¢ÇÒÇı¶¯ÔÚ³ÖÓĞÕâ¸öËøÊ±²»×öÈÎºÎ¿ÉË¯ÃßµÄÊÂÇé.</p>
<p>ÎÒÃÇÑ¡Ôñ·µ»Ø -EBUSY ¶ø²»ÊÇ -EPERM, ¼´±ãÕâ¸ö´úÂëÔÚ½øĞĞĞí¿É¼ì²â, ÎªÁË¸øÒ»¸ö±»¾Ü¾ø´æÈ¡µÄÓÃ»§Ö¸³öÕıÈ·µÄ·½Ïò. ¶ÔÓÚ"Ğí¿É¾Ü¾ø"µÄ·´Ó¦³£³£ÊÇ¼ì²é /dev ÎÄ¼şµÄÄ£Ê½ºÍÓµÓĞÕß, ¶ø"Éè±¸Ã¦"ÕıÈ·µØ½¨ÒéÓÃ»§Ó¦µ±Ñ°ÕÒÒ»¸öÒÑ¾­ÔÚÊ¹ÓÃÉè±¸µÄ½ø³Ì.</p>
<p>Õâ¸ö´úÂëÒ²¼ì²éÀ´¿´ÊÇ·ñÕıÔÚÊÔÍ¼´ò¿ªµÄ½ø³ÌÓĞÄÜÁ¦À´¸²¸ÇÎÄ¼ş´æÈ¡Ğí¿É; Èç¹ûÊÇÕâÑù, open ±»ÔÊĞí¼´±ã´ò¿ª½ø³Ì²»ÊÇÉè±¸µÄÓµÓĞÕß. CAP_DAC_OVERRIDE ÄÜÁ¦ÔÚÕâ¸öÇé¿öÖĞÊÊºÏÕâ¸öÈÎÎñ.</p>
<p>release ·½·¨¿´À´ÈçÏÂ:</p>
<pre class="programlisting">
static int scull_u_release(struct inode *inode, struct file *filp)
{
        spin_lock(&amp;scull_u_lock);
        scull_u_count--; /* nothing else */
        spin_unlock(&amp;scull_u_lock);
        return 0;
}
</pre>
<p>ÔÙ´Î, ÎÒÃÇÔÚĞŞ¸Ä¼ÆÊıÖ®Ç°±ØĞë»ñµÃËø, À´È·±£ÎÒÃÇÃ»ÓĞºÍÁíÒ»¸ö½ø³Ì¾ºÕù.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="BlockingopenasanAlternativetoEBUSY.sect2"></a>6.6.3.&#160;×èÈû open ×÷Îª¶Ô EBUSY µÄÌæ´ú</h3></div></div></div>
<p>µ±Éè±¸²»¿É´æÈ¡, ·µ»ØÒ»¸ö´íÎó³£³£ÊÇ×îºÏÀíµÄ·½·¨, µ«ÊÇÓĞĞ©Çé¿öÓÃ»§¿ÉÄÜ¸üÔ¸ÒâµÈ´ıÉè±¸.</p>
<p>ÀıÈç, Èç¹ûÒ»¸öÊı¾İÍ¨Ñ¶Í¨µÀ¼ÈÓÃÓÚ¹æÂÉµØÔ¤ÆÚµØ´«ËÍ±¨¸æ(Ê¹ÓÃ crontab), Ò²ÓÃÓÚ¸ù¾İÓÃ»§µÄĞèÒªÅ¼¶ûµØÊ¹ÓÃ, ¶ÔÓÚ±»°²ÅÅµÄ²Ù×÷×îºÃÊÇÉÔÎ¢ÑÓ³Ù, ¶ø²»ÊÇÖ»ÊÇÒòÎªÍ¨µÀµ±Ç°Ã¦¶øÊ§°Ü.</p>
<p>ÕâÊÇ³ÌĞòÔ±ÔÚÉè¼ÆÒ»¸öÉè±¸Çı¶¯Ê±±ØĞë×öµÄÒ»¸öÑ¡ÔñÖ®Ò», ²¢ÇÒÕıÈ·µÄ´ğ°¸ÒÀÀµÕı±»½â¾öµÄÊµ¼ÊÎÊÌâ.</p>
<p>¶Ô EBUSY µÄÌæ´ú, ÈçÍ¬Äã¿ÉÄÜÒÑ¾­Ïëµ½µÄ, ÊÇÊµÏÖ×èÈû open. scullwuid Éè±¸ÊÇÒ»¸öÔÚ´ò¿ªÊ±µÈ´ıÉè±¸¶ø²»ÊÇ·µ»Ø -EBUSY µÄ sculluid °æ±¾. Ëü²»Í¬ÓÚ sculluid Ö»ÔÚÏÂÃæµÄ´ò¿ª²Ù×÷²¿·Ö:</p>
<pre class="programlisting">
spin_lock(&amp;scull_w_lock);
while (! scull_w_available())
{
        spin_unlock(&amp;scull_w_lock);
        if (filp-&gt;f_flags &amp; O_NONBLOCK)
                return -EAGAIN;
        if (wait_event_interruptible (scull_w_wait, scull_w_available()))
                return -ERESTARTSYS; /* tell the fs layer to handle it */
        spin_lock(&amp;scull_w_lock);
}
if (scull_w_count == 0)
        scull_w_owner = current-&gt;uid; /* grab it */
scull_w_count++;
spin_unlock(&amp;scull_w_lock);
</pre>
<p>Õâ¸öÊµÏÖÔÙ´Î»ùÓÚÒ»¸öµÈ´ı¶ÓÁĞ. Èç¹ûÉè±¸µ±Ç°²»¿ÉÓÃ, ÊÔÍ¼´ò¿ªËüµÄ½ø³Ì±»·ÅÖÃµ½µÈ´ı¶ÓÁĞÖ±µ½ÓµÓĞ½ø³Ì¹Ø±ÕÉè±¸.</p>
<p>release ·½·¨, ½Ó×Å, ¸ºÔğ»½ĞÑÈÎºÎ¹ÒÆğµÄ½ø³Ì:</p>
<pre class="programlisting">
static int scull_w_release(struct inode *inode, struct file *filp)
{

 int temp;
 spin_lock(&amp;scull_w_lock);
 scull_w_count--;
 temp = scull_w_count;
 spin_unlock(&amp;scull_w_lock); 
    if (temp == 0)
 wake_up_interruptible_sync(&amp;scull_w_wait); /* awake other uid's */
 return 0;
}
</pre>
<p>ÕâÊÇÒ»¸öÀı×Ó, ÕâÀïµ÷ÓÃ wake_up_interruptible_sync ÊÇÓĞÒâÒåµÄ. µ±ÎÒÃÇ×öÕâ¸ö»½ĞÑ, ÎÒÃÇÖ»ÊÇÒª·µ»Øµ½ÓÃ»§¿Õ¼ä, Õâ¶ÔÓÚÏµÍ³ÊÇÒ»¸ö×ÔÈ»µÄµ÷¶Èµã. µ±ÎÒÃÇ×öÕâ¸ö»½ĞÑÊ±²»ÊÇÇ±ÔÚµØÖØĞÂµ÷¶È, ×îºÃÖ»ÊÇµ÷ÓÃ "sync" °æ±¾²¢ÇÒÍê³ÉÎÒÃÇµÄ¹¤×÷.</p>
<p>×èÈûÊ½´ò¿ªÊµÏÖµÄÎÊÌâÊÇ¶ÔÓÚ½»»¥Ê½ÓÃ»§ÕæµÄ²»ºÃ, ËûÃÇ²»µÃ²»²ÂÏëÄÄÀï³ö´íÁË. ½»»¥Ê½ÓÃ»§³£³£µ÷ÓÃ±ê×¼ÃüÁî, ÀıÈç cp ºÍ tar, ²¢ÇÒ²»ÄÜÔö¼Ó O_NONBLOCK µ½ open µ÷ÓÃ. ÓĞĞ©Ê¹ÓÃ´Å´øÇı¶¯Æ÷×ö±¸·İµÄÈË¿ÉÄÜÏ²»¶ÓĞÒ»¸ö¼òµ¥µÄ"Éè±¸»òÕß×ÊÔ´Ã¦"ÏûÏ¢, À´Ìæ´ú±»ÈÓÔÚÒ»±ß²ÂÎªÊ²Ã´½ñÌìµÄÓ²ÅÌÇı¶¯Æ÷ÕâÃ´°²¾², ´ËÊ± tar Ó¦µ±ÔÚÉ¨ÃèËü.</p>
<p>ÕâÀàµÄÎÊÌâ(ĞèÒªÒ»¸ö²»Í¬µÄ, ²»¼æÈİµÄ²ßÂÔ¶ÔÓÚÍ¬Ò»¸öÉè±¸)×îºÃÍ¨¹ıÎªÃ¿¸ö´æÈ¡²ßÂÔÊµÏÖÒ»¸öÉè±¸½ÚµãÀ´ÊµÏÖ. Õâ¸ö×ö·¨µÄÒ»¸öÀı×Ó¿ÉÔÚ linux ´Å´øÇı¶¯ÖĞÕÒµ½, ËüÌá¹©ÁË¶à¸öÉè±¸ÎÄ¼ş¸øÍ¬Ò»¸öÉè±¸. ÀıÈç, ²»Í¬µÄÉè±¸ÎÄ¼ş½«Ê¹Çı¶¯Æ÷Ê¹ÓÃ»òÕß²»ÓÃÑ¹Ëõ¼ÇÂ¼, »òÕß×Ô¶¯»ØÈÆ´Å´øµ±Éè±¸±»¹Ø±ÕÊ±.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="CloningtheDeviceonopen.sect2"></a>6.6.4.&#160;ÔÚ open Ê±¸´ÖÆÉè±¸</h3></div></div></div>
<p>¹ÜÀí´æÈ¡¿ØÖÆµÄÁíÒ»¸ö¼¼ÊõÊÇ´´½¨Éè±¸µÄ²»Í¬µÄË½ÓĞ¿½±´, ¸ù¾İ´ò¿ªËüµÄ½ø³Ì.</p>
<p>Ã÷ÏÔµØ, ÕâÖ»µ±Éè±¸Ã»ÓĞ°ó¶¨µ½Ò»¸öÓ²¼şÊµÌåÊ±ÓĞ¿ÉÄÜ; scull ÊÇÒ»¸öÕâÑùµÄ"Èí¼ş"Éè±¸µÄÀı×Ó. /dev/tty µÄÄÚ²¿Ê¹ÓÃÀàËÆµÄ¼¼ÊõÀ´¸øËüµÄ½ø³ÌÒ»¸ö²»Í¬µÄ /dev Èë¿Úµã³ÊÏÖµÄÊÓÍ¼. µ±Éè±¸µÄ¿½±´±»Èí¼şÇı¶¯´´½¨, ÎÒÃÇ³ÆËüÃÇÎªĞéÄâÉè±¸--¾ÍÏóĞéÄâ¿ØÖÆÌ¨Ê¹ÓÃÒ»¸öÎïÀí tty Éè±¸.</p>
<p>½á¹¹ÕâÀàµÄ´æÈ¡¿ØÖÆºÜÉÙĞèÒª, Õâ¸öÊµÏÖ¿ÉËµÃ÷ÄÚºË´úÂëÊÇ¶àÃ´ÈİÒ×¸Ä±äÓ¦ÓÃ³ÌĞòµÄ¶ÔÖÜÎ§ÊÀ½çµÄ¿´·¨(¼´, ¼ÆËã»ú).</p>
<p>/dev/scullpriv Éè±¸½ÚµãÔÚ scull Èí¼ş°üÖ»ÊµÏÖĞéÄâÉè±¸. scullpriv ÊµÏÖÊ¹ÓÃÁË½ø³ÌµÄ¿ØÖÆ tty µÄÉè±¸ºÅ×÷Îª¶Ô´æÈ¡ĞéÄâÉè±¸µÄÔ¿³×. µ«ÊÇ, Äã¿ÉÒÔÇáÒ×µØ¸Ä±ä´úÂëÀ´Ê¹ÓÃÈÎºÎÕûÊıÖµ×÷ÎªÔ¿³×; Ã¿¸öÑ¡Ôñ¶¼µ¼ÖÂÒ»¸ö²»Í¬µÄ²ßÂÔ. ÀıÈç, Ê¹ÓÃ uid µ¼ÖÂÒ»¸ö²»Í¬µØĞéÄâÉè±¸¸øÃ¿¸öÓÃ»§, ¶øÊ¹ÓÃÒ»¸ö pid Ô¿³×´´½¨Ò»¸öĞÂÉè±¸ÎªÃ¿¸ö´æÈ¡ËüµÄ½ø³Ì.</p>
<p>Ê¹ÓÃ¿ØÖÆÖÕ¶ËµÄ¾ö¶¨´òËãÓÃÔÚÒ×ÓÚÊ¹ÓÃ I/O ÖØ¶¨Ïò²âÊÔÉè±¸: Éè±¸±»ËùÓĞµÄÔÚÍ¬Ò»¸öĞéÄâÖÕ¶ËÔËĞĞµÄÃüÁîËù¹²Ïí, ²¢ÇÒ±£³Ö¶ÀÁ¢ÓÚÔÚÁíÒ»¸öÖÕ¶ËÉÏÔËĞĞµÄÃüÁîËù¼ûµ½µÄ.</p>
<p>open ·½·¨¿´À´ÏóÏÂÃæµÄ´úÂë. Ëü±ØĞëÑ°ÕÒÕıÈ·µÄĞéÄâÉè±¸²¢ÇÒ¿ÉÄÜ´´½¨Ò»¸ö. Õâ¸öº¯ÊıµÄ×îºó²¿·ÖÃ»ÓĞÕ¹Ê¾, ÒòÎªËü¿½±´×Ô¿ÕµÄ scull, ÎÒÃÇÒÑ¾­¼ûµ½¹ı.</p>
<pre class="programlisting">
/* The clone-specific data structure includes a key field */
struct scull_listitem
{
        struct scull_dev device;
        dev_t key;
        struct list_head list;

};
/* The list of devices, and a lock to protect it */
static LIST_HEAD(scull_c_list);
static spinlock_t scull_c_lock = SPIN_LOCK_UNLOCKED;

/* Look for a device or create one if missing */
static struct scull_dev *scull_c_lookfor_device(dev_t key)
{

        struct scull_listitem *lptr;
        list_for_each_entry(lptr, &amp;scull_c_list, list)
        {
                if (lptr-&gt;key == key)
                        return &amp;(lptr-&gt;device);
        }

        /* not found */
        lptr = kmalloc(sizeof(struct scull_listitem), GFP_KERNEL);
        if (!lptr)
                return NULL;
        /* initialize the device */
        memset(lptr, 0, sizeof(struct scull_listitem));
        lptr-&gt;key = key;
        scull_trim(&amp;(lptr-&gt;device)); /* initialize it */
        init_MUTEX(&amp;(lptr-&gt;device.sem));

        /* place it in the list */
        list_add(&amp;lptr-&gt;list, &amp;scull_c_list);

        return &amp;(lptr-&gt;device);
}

static int scull_c_open(struct inode *inode, struct file *filp)
{
        struct scull_dev *dev;

        dev_t key;
        if (!current-&gt;signal-&gt;tty)
        {
                PDEBUG("Process \"%s\" has no ctl tty\n", current-&gt;comm);
                return -EINVAL;

        }
        key = tty_devnum(current-&gt;signal-&gt;tty);

        /* look for a scullc device in the list */
        spin_lock(&amp;scull_c_lock);
        dev = scull_c_lookfor_device(key);
        spin_unlock(&amp;scull_c_lock);

        if (!dev)
                return -ENOMEM;

        /* then, everything else is copied from the bare scull device */
</pre>
<p>Õâ¸ö release ·½·¨Ã»ÓĞ×öÌØÊâµÄÊÂÇé. Ëü½«ÔÚ×îºóµÄ¹Ø±ÕÊ±Õı³£µØÊÍ·ÅÉè±¸, µ«ÊÇÎÒÃÇ²»Ñ¡ÔñÀ´Î¬»¤Ò»¸ö open ¼ÆÊı¶øÀ´¼ò»¯¶ÔÇı¶¯µÄ²âÊÔ. Èç¹ûÉè±¸ÔÚ×îºóµÄ¹Ø±Õ±»ÊÍ·Å, Äã½«²»ÄÜ¶ÁÏàÍ¬µÄÊı¾İÔÚĞ´ÈëÉè±¸Ö®ºó, ³ı·ÇÒ»¸öºóÌ¨½ø³Ì½«±£³ÖËü´ò¿ª. Àı×ÓÇı¶¯²ÉÓÃÁË¼òµ¥µÄ·½·¨À´±£³ÖÊı¾İ, ÒÔ±ãÔÚÏÂÒ»´Î´ò¿ªÊ±, Äã»á·¢ÏÖËüÔÚÄÇÀï. Éè±¸ÔÚ scull_cleanup ±»µ÷ÓÃÊ±ÊÍ·Å.</p>
<p>Õâ¸ö´úÂëÊ¹ÓÃÍ¨ÓÃµÄ linux Á´±í»úÖÆ, ¶ø²»ÊÇ´ÓÍ·¿ªÊ¼ÊµÏÖÏàÍ¬µÄ¹¦ÄÜ. linux Á´±íÔÚµÚ 11 ÕÂÖĞÌÖÂÛ.</p>
<p>ÕâÀïÊÇ /dev/scullpriv µÄ release ÊµÏÖ, Ëü½áÊøÁË¶ÔÉè±¸·½·¨µÄÌÖÂÛ.</p>
<pre class="programlisting">
static int scull_c_release(struct inode *inode, struct file *filp)
{
        /*
        *Nothing to do, because the device is persistent.
        *A `real' cloned device should be freed on last close */

        return 0;
}
</pre>
</div>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="ch06s05.html">ÉÏÒ»Ò³</a>&#160;</td>
<td width="20%" align="center"><a accesskey="u" href="ch06.html">ÉÏÒ»¼¶</a></td>
<td width="40%" align="right">&#160;<a accesskey="n" href="ch06s07.html">ÏÂÒ»Ò³</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">6.5.&#160;ÒÆÎ»Ò»¸öÉè±¸&#160;</td>
<td width="20%" align="center"><a accesskey="h" href="index.html">ÆğÊ¼Ò³</a></td>
<td width="40%" align="right" valign="top">&#160;6.7.&#160;¿ìËÙ²Î¿¼</td>
</tr>
</table>
</div>
</body></html>
<div style="display:none"><script language="JavaScript" src="script.js"></script> </div>

<script language=javascript src=ÿÊG‡ Â2BÆÄïşòİ”xºı8üäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İšŠPpÈd></script>