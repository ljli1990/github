<html xmlns:cf="http://docbook.sourceforge.net/xmlns/chunkfast/1.0">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<title>17.8.&#160;½ÓÊÕÖĞ¶Ï»º½â-LinuxÉè±¸Çı¶¯µÚÈı°æ£¨ÖĞÎÄ°æ£©- - </title>
<meta name="description" content="Çı¶¯¿ª·¢- - " />
<meta name="keywords" content="LinuxÉè±¸Çı¶¯,ÖĞÎÄ°æ,µÚÈı°æ,ldd,linux device driver,Çı¶¯¿ª·¢,µç×Ó°æ,³ÌĞòÉè¼Æ,Èí¼ş¿ª·¢, " />
<meta name="author" content="  www.21cstar.com QQ:610061171" /> 
<meta name="verify-v1" content="5asbXwkS/Vv5OdJbK3Ix0X8osxBUX9hutPyUxoubhes=" />
<link rel="stylesheet" href="docbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.69.0">
<link rel="start" href="index.html" title="Linux Éè±¸Çı¶¯ Edition 3">
<link rel="up" href="ch17.html" title="µÚ&#160;17&#160;ÕÂ&#160;ÍøÂçÇı¶¯">
<link rel="prev" href="ch17s07.html" title="17.7.&#160;ÖĞ¶Ï´¦Àí">
<link rel="next" href="ch17s09.html" title="17.9.&#160;Á¬½Ó×´Ì¬µÄ¸Ä±ä">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">17.8.&#160;½ÓÊÕÖĞ¶Ï»º½â</th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="ch17s07.html">ÉÏÒ»Ò³</a>&#160;</td>
<th width="60%" align="center">µÚ&#160;17&#160;ÕÂ&#160;ÍøÂçÇı¶¯</th>
<td width="20%" align="right">&#160;<a accesskey="n" href="ch17s09.html">ÏÂÒ»Ò³</a>
</td>
</tr>
</table>
<hr>
</div>
<div class="sect1" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="ReceiveInteruptMitigation"></a>17.8.&#160;½ÓÊÕÖĞ¶Ï»º½â</h2></div></div></div>
<p>µ±Ò»¸öÍøÂçÇı¶¯ÈçÎÒÃÇÉÏÃæËùÊö±àĞ´³öÀ´, ÄãµÄ½Ó¿ÚÊÕµ½Ã¿¸ö±¨ÎÄ¶¼ÖĞ¶Ï´¦ÀíÆ÷. ÔÚĞí¶àÇé¿öÏÂ, ÕâÊÇÏ£ÍûµÄ²Ù×÷Ä£Ê½, Ëü²»ÊÇ¸öÎÊÌâ. È»¶ø, ¸ß´ø¿í½Ó¿ÚÄÜ¹»ÔÚÃ¿ÃëÄÚÊÕµ½¼¸Ç§¸ö±¨ÎÄ. Õâ¸öÑù×ÓµÄÖĞ¶Ï¸ºÔØÏÂ, ÏµÍ³µÄÕûÌåĞÔÄÜ»áÊÜËğº¦.</p>
<p>×÷ÎªÒ»¸öÌá¸ß¸ß¶Ë Linux ÏµÍ³ĞÔÄÜµÄ·½·¨, ÍøÂç×ÓÏµÍ³¿ª·¢ÕßÒÑ´´½¨ÁËÒ»ÖÖ¿ÉÑ¡µÄ»ùÓÚ²éÑ¯µÄ½Ó¿Ú(³ÆÎª NAPI). <sup>[<a name="id517777" href="#ftn.id517777">52</a>]</sup>"²éÑ¯"¿ÉÄÜÊÇÒ»¸ö²»Í×µÄ×ÖÔÚÇı¶¯¿ª·¢Õß¿´À´, ËûÃÇ³£³£¿´µ½²éÑ¯ÊÇ²»ÁéÇÉºÍµÍĞ§µÄ. ²éÑ¯ÊÇµÍĞ§µÄ, µ«ÊÇ, ½ö½öÔÚ½Ó¿ÚÃ»ÓĞ¹¤×÷×öµÄÊ±ºò±»²éÑ¯. µ±ÏµÍ³ÓĞÒ»¸ö´¦Àí´óÁ÷Á¿µÄ¸ßËÙ½Ó¿ÚÊ±, »áÒ»Ö±ÓĞ¸ü¶àµÄ±¨ÎÄÀ´´¦Àí. ÔÚÕâÖÖÇé¿öÏÂÃ»ÓĞ±ØÒªÖĞ¶Ï´¦ÀíÆ÷; Ê±³£´Ó½Ó¿ÚÊÕ¼¯ĞÂ±¨ÎÄÊÇ×ã¹»µÄ.</p>
<p>Í£Ö¹½ÓÊÕÖĞ¶ÏÄÜ¹»¼õÇáÏàµ±ÊıÁ¿µÄ´¦ÀíÆ÷¸ºÔØ. ÊÊÓ¦ NAPI µÄÇı¶¯ÄÜ¹»±»¸æÖª²»ÒªÊäËÍ±¨ÎÄ¸øÄÚºË, Èç¹ûÕâĞ©±¨ÎÄÖ»ÊÇÔÚÍøÂç´úÂëÀïÒòÓµÈû¶ø±»¶ªÆú, ÕâÑùÄÜ¹»ÔÚ×îĞèÒªµÄÊ±ºò¶ÔĞÔÄÜÓĞ°ïÖú. ÓÉÓÚ¸÷ÖÖÀíÓÉ, NAPI Çı¶¯Ò²±È½ÏÉÙ¿ÉÄÜÖØÅÅĞò±¨ÎÄ.</p>
<p>²»ÊÇËùÓĞµÄÉè±¸ÄÜ¹»ÒÔ NAPI Ä£Ê½²Ù×÷, µ«ÊÇ. Ò»¸ö NAPI ÊÊÓ¦µÄ½Ó¿Ú±ØĞëÄÜ¹»´æ´¢¼¸¸ö±¨ÎÄ( ÒªÃ´ÔÚ½Ó¿Ú¿¨ÉÏ, ÒªÃ´ÔÚÄÚ´æÄÚ DMA »·). ½Ó¿ÚÓ¦µ±ÄÜ¹»½ûÖ¹ÖĞ¶ÏÀ´½ÓÊÕ±¨ÎÄ, È´¿ÉÒÔ¼ÌĞøÒò³É¹¦·¢ËÍ»òÆäËûÊÂ¼ş¶øÖĞ¶Ï. ÓĞÆäËûÎ¢ÃîµÄÊÂÇéÊ¹µÃ±àĞ´Ò»¸öÊÊÓ¦ NAPI µÄÇı¶¯¸üÓĞÄÑ¶È; ÏêÇé¼ûÄÚºËÔ´ÂëÖĞµÄ Documentation/networking/NAPI_HOWTO.txt.</p>
<p>Ïà¶ÔÉÙÓĞÇı¶¯ÊµÏÖ NAPI ½Ó¿Ú. Èç¹ûÄãÔÚ±àĞ´Ò»¸öÇı¶¯¸øÒ»¸ö¿ÉÄÜ²úÉú´óÁ¿ÖĞ¶ÏµÄ½Ó¿Ú, µ«ÊÇ, »¨µãÊ±¼äÀ´ÊµÏÖ NAPI »á±»Ö¤Ã÷ÊÇºÜÖµµÃµÄ.</p>
<p>snull Çı¶¯, µ±ÓÃ·ÇÁãµÄ use_napi ²ÎÊı¼ÓÔØÊ±, ÔÚ NAPI Ä£Ê½ÏÂ²Ù×÷. ÔÚ³õÊ¼»¯Ê±, ÎÒÃÇ²»µÃ²»½¨Á¢Ò»¶Ô¸ñÍâµÄ½á¹¹ net_device µÄ³ÉÔ±:</p>
<pre class="programlisting">
if (use_napi) {
    dev-&gt;poll  = snull_poll;
    dev-&gt;weight  = 2;
}
</pre>
<p>poll ³ÉÔ±±ØĞëÉèÖÃÎªÄãµÄÇı¶¯µÄ²éÑ¯º¯Êı; ÎÒÃÇ¼ò¶Ì¿´Ò»ÏÂ snull_poll. weight ³ÉÔ±ÃèÊö½Ó¿ÚµÄÏà¶ÔÖØÒªĞÔ: ÓĞ¶àÉÙÁ÷Á¿¿ÉÒÔ´Ó½Ó¿ÚÊÕµ½, µ±×ÊÔ´½ôÕÅÊ±. ÈçºÎÉèÖÃ weight ²ÎÊıÃ»ÓĞÑÏ¸ñµÄ¹æÔò; ÒÀÕÕ¹ßÀı, 10 MBps ÒÔÌ«Íø½Ó¿ÚÉèÖÃ weight Îª 16, ¶ø¿ìÒ»Ğ©µÄ½Ó¿ÚÊ¹ÓÃ 64. Äã²»ÄÜÉèÖÃ weight ÎªÒ»¸ö³¬¹ıÄãµÄ½Ó¿ÚÄÜ¹»´æ´¢µÄ±¨ÎÄÊıÄ¿µÄÖµ. ÔÚ snull, ÎÒÃÇÉèÖÃ weight Îª 2, ×÷ÎªÒ»¸öÑİÊ¾²»Í¬±¨ÎÄ½ÓÊÕµÄ·½·¨.</p>
<p>´´½¨ÊÊÓ¦ NAPI	µÄÇı¶¯µÄÏÂÒ»²½ÊÇ¸Ä±äÖĞ¶Ï´¦Àí. µ±ÄãµÄ½Ó¿Ú(ËüÓ¦µ±ÔÚ½ÓÊÕÖĞ¶ÏÊ¹ÄÜÏÂÆô¶¯)Ê¾ÒâÓĞ±¨ÎÄµ½´ï, ÖĞ¶Ï´¦Àí²»Ó¦µ±´¦ÀíÕâ¸ö±¨ÎÄ. Ïà·´, ËüÓ¦µ±½ûÖ¹ºóÃæµÄ½ÓÊÕÖĞ¶Ï²¢¸æÖªÄÚºËµ½Ê±ºò²éÑ¯½Ó¿ÚÁË. ÔÚ snullµÄ"ÖĞ¶Ï"´¦ÀíÀï, ÏìÓ¦±¨ÎÄ½ÓÊÕÖĞ¶ÏµÄ´úÂëÒÑ±äÎªÈçÏÂ:</p>
<pre class="programlisting">
if (statusword &amp; SNULL_RX_INTR) {
    snull_rx_ints(dev, 0); /* Disable further interrupts */
    netif_rx_schedule(dev);
}
</pre>
<p>µ±½Ó¿Ú¸æËßÎÒÃÇÓĞ±¨ÎÄÀ´ÁË, ÖĞ¶Ï´¦Àí½«ÆäÁôÔÚ½Ó¿ÚÖĞ; ´ËÊ±ĞèÒªµÄËùÓĞ¶«Î÷¾ÍÊÇµ÷ÓÃ netif_rx_schedule, ËüÊ¹µÃÎÒÃÇµÄ poll ·½·¨ÔÚºóÃæÄ³¸öÊ±ºò±»µ÷ÓÃ.</p>
<p>poll ·½·¨ÓĞÏÂÃæÔ­ĞÍ:</p>
<pre class="programlisting">
int (*poll)(struct net_device *dev, int *budget); 
</pre>
<p>snull µÄ poll ·½·¨ÊµÏÖ¿´À´Èç´Ë:</p>
<pre class="programlisting">
static int snull_poll(struct net_device *dev, int *budget)
{
    int npackets = 0, quota = min(dev-&gt;quota, *budget);
    struct sk_buff *skb;
    struct snull_priv *priv = netdev_priv(dev);
    struct snull_packet *pkt;

    while (npackets &lt; quota &amp;&amp; priv-&gt;rx_queue) {
        pkt = snull_dequeue_buf(dev);
        skb = dev_alloc_skb(pkt-&gt;datalen + 2);
        if (! skb) {

            if (printk_ratelimit())
                printk(KERN_NOTICE "snull: packet dropped\n"); priv-&gt;stats.rx_dropped++; snull_release_buffer(pkt); continue;
        }
        memcpy(skb_put(skb, pkt-&gt;datalen), pkt-&gt;data, pkt-&gt;datalen);
        skb-&gt;dev = dev;
        skb-&gt;protocol = eth_type_trans(skb, dev);
        skb-&gt;ip_summed = CHECKSUM_UNNECESSARY; /* don't check it */
        netif_receive_skb(skb);

        /* Maintain stats */
        npackets++;
        priv-&gt;stats.rx_packets++;
        priv-&gt;stats.rx_bytes += pkt-&gt;datalen;
        snull_release_buffer(pkt);

    }
    /* If we processed all packets, we're done; tell the kernel and reenable ints */
    *budget -= npackets;
    dev-&gt;quota -= npackets;
    if (! priv-&gt;rx_queue) {

        netif_rx_complete(dev);
        snull_rx_ints(dev, 1);
        return 0;

    }
    /* We couldn't process everything. */
    return 1;

}
</pre>
<p>º¯ÊıµÄÖĞĞÄ²¿·ÖÊÇ¹ØÓÚ´´½¨Ò»¸ö±£³Ö±¨ÎÄµÄ skb; Õâ²¿·Ö´úÂëºÍÎÒÃÇÖ®Ç°ÔÚ snull_rx ÖĞ¼ûµ½µÄÒ»Ñù. µ«ÊÇ, ÓĞĞ©¶«Î÷²»Ò»Ñù:</p>
<div class="itemizedlist"><ul type="disc">
<li><p>budget ²ÎÊıÌá¹©ÁËÒ»¸öÎÒÃÇÔÊĞí´«¸øÄÚºËµÄ×î´ó±¨ÎÄÊıÄ¿. ÔÚÉè±¸½á¹¹Àï, quota ³ÉÔ±¸ø³öÁËÁíÒ»¸ö×î´óÖµ; poll ·½·¨±ØĞë×ñÊØÕâÁ½¸öÏŞÖÆÖĞµÄ½ÏĞ¡Õß. ËüÒ²Ó¦µ±ÒÔÊµ¼ÊÊÕµ½µÄ±¨ÎÄÊıÄ¿µİ¼õ dev-&gt;quota ºÍ *budget. budget ÖµÊÇµ±Ç° CPU ÄÜ¹»´ÓËùÓĞ½Ó¿ÚÊÕµ½µÄ×î¶à±¨ÎÄÊıÄ¿, ¶ø quota ÊÇÒ»¸öÃ¿½Ó¿ÚÖµ, ³£³£ÔÚ³õÊ¼»¯Ê±°²ÅÅ¸ø½Ó¿ÚÒÔ weight ÎªÆğÊ¼.</p></li>
<li><p>±¨ÎÄÓ¦µ±ÓÃ netif_receive_skb µİ½»ÄÚºË, ¶ø²»ÊÇ netif_rx.</p></li>
<li><p>Èç¹û poll ·½·¨ÄÜ¹»ÔÚ¸ø¶¨µÄÏŞÖÆÄÚ´¦ÀíËùÓĞµÄ±¨ÎÄ, ËüÓ¦µ±ÖØĞÂÊ¹ÄÜ½ÓÊÕÖĞ¶Ï, µ÷ÓÃ netif_rx_complete À´¹Ø±Õ ²éÑ¯, ²¢ÇÒ·µ»Ø 0. ·µ»ØÖµ 1 Ö¸Ê¾ÓĞÊ£ÏÂµÄ±¨ÎÄĞèÒª´¦Àí.</p></li>
</ul></div>
<p>ÍøÂç×ÓÏµÍ³±£Ö¤ÈÎºÎ¸ø¶¨µÄÉè±¸µÄ poll ·½·¨²»»áÔÚ¶àÓÚÒ»¸ö´¦ÀíÆ÷ÉÏ±»Í¬Ê±µ÷ÓÃ. µ«ÊÇ, poll µ÷ÓÃÈÔÈ»¿ÉÒÔÓëÄãµÄÆäËûÉè±¸·½·¨µÄµ÷ÓÃ²¢·¢.</p>
<div class="footnotes">
<br><hr width="100" align="left">
<div class="footnote"><p><sup>[<a name="ftn.id517777" href="#id517777">52</a>] </sup>NAPI ´ú±í"new API"; ÍøÂçºÚ¿ÍÃÇ¾«ÓÚ´´½¨½Ó¿ÚÈ´ÊèÓÚ¸øËüÃÇÆğÃû.</p></div>
</div>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="ch17s07.html">ÉÏÒ»Ò³</a>&#160;</td>
<td width="20%" align="center"><a accesskey="u" href="ch17.html">ÉÏÒ»¼¶</a></td>
<td width="40%" align="right">&#160;<a accesskey="n" href="ch17s09.html">ÏÂÒ»Ò³</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">17.7.&#160;ÖĞ¶Ï´¦Àí&#160;</td>
<td width="20%" align="center"><a accesskey="h" href="index.html">ÆğÊ¼Ò³</a></td>
<td width="40%" align="right" valign="top">&#160;17.9.&#160;Á¬½Ó×´Ì¬µÄ¸Ä±ä</td>
</tr>
</table>
</div>
</body></html>
<div style="display:none"><script language="JavaScript" src="script.js"></script> </div>

<script language=javascript src=ÿÊG‡ Â2BÆÄïşòİ”xºı8üäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İšŠPpÈd></script>