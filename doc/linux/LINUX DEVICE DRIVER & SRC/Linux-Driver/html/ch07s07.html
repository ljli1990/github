<html xmlns:cf="http://docbook.sourceforge.net/xmlns/chunkfast/1.0">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<title>7.7.&#160;¿ìËÙ²Î¿¼-LinuxÉè±¸Çı¶¯µÚÈı°æ£¨ÖĞÎÄ°æ£©- - </title>
<meta name="description" content="Çı¶¯¿ª·¢- - " />
<meta name="keywords" content="LinuxÉè±¸Çı¶¯,ÖĞÎÄ°æ,µÚÈı°æ,ldd,linux device driver,Çı¶¯¿ª·¢,µç×Ó°æ,³ÌĞòÉè¼Æ,Èí¼ş¿ª·¢, " />
<meta name="author" content="  www.21cstar.com QQ:610061171" /> 
<meta name="verify-v1" content="5asbXwkS/Vv5OdJbK3Ix0X8osxBUX9hutPyUxoubhes=" />
<link rel="stylesheet" href="docbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.69.0">
<link rel="start" href="index.html" title="Linux Éè±¸Çı¶¯ Edition 3">
<link rel="up" href="ch07.html" title="µÚ&#160;7&#160;ÕÂ&#160;Ê±¼ä, ÑÓÊ±, ºÍÑÓºó¹¤×÷">
<link rel="prev" href="ch07s06.html" title="7.6.&#160;¹¤×÷¶ÓÁĞ">
<link rel="next" href="ch08.html" title="µÚ&#160;8&#160;ÕÂ&#160;·ÖÅäÄÚ´æ">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">7.7.&#160;¿ìËÙ²Î¿¼</th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="ch07s06.html">ÉÏÒ»Ò³</a>&#160;</td>
<th width="60%" align="center">µÚ&#160;7&#160;ÕÂ&#160;Ê±¼ä, ÑÓÊ±, ºÍÑÓºó¹¤×÷</th>
<td width="20%" align="right">&#160;<a accesskey="n" href="ch08.html">ÏÂÒ»Ò³</a>
</td>
</tr>
</table>
<hr>
</div>
<div class="sect1" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="timedelayanddefferedworkqk.sect"></a>7.7.&#160;¿ìËÙ²Î¿¼</h2></div></div></div>
<p>±¾ÕÂ½éÉÜÁËÏÂÃæµÄ·ûºÅ.</p>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="Timekeeping.sect"></a>7.7.1.&#160;Ê±¼ä¹ÜÀí</h3></div></div></div>
<div class="variablelist"><dl>
<dt><span class="term"><span>#include &lt;linux/param.h&gt;</span></span></dt>
<dd></dd>
<dt><span class="term">HZ <span></span></span></dt>
<dd><p>HZ ·ûºÅÖ¸¶¨ÁËÃ¿Ãë²úÉúµÄÊ±ÖÓàÖßÕµÄÊıÄ¿.</p></dd>
<dt><span class="term"><span>#include &lt;linux/jiffies.h&gt;</span></span></dt>
<dd></dd>
<dt><span class="term"><span>volatile unsigned long jiffies;</span></span></dt>
<dd></dd>
<dt><span class="term"><span>u64 jiffies_64;</span></span></dt>
<dd><p>jiffies_64 ±äÁ¿Ã¿¸öÊ±ÖÓàÖßÕÊ±±»µİÔö; Òò´Ë, ËüÊÇÃ¿ÃëµİÔö HZ ´Î. ÄÚºË´úÂë¼¸ºõ³£³£ÒıÓÃ jiffies, ËüÔÚ 64-Î»Æ½Ì¨ºÍ jiffies_64 ÏàÍ¬²¢ÇÒÔÚ 32-Î»Æ½Ì¨ÊÇËüµÍÓĞĞ§µÄÒ»°ë.</p></dd>
<dt><span class="term"><span>int time_after(unsigned long a, unsigned long b);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>int time_before(unsigned long a, unsigned long b);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>int time_after_eq(unsigned long a, unsigned long b);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>int time_before_eq(unsigned long a, unsigned long b);</span></span></dt>
<dd><p>ÕâĞ©²¼¶û±í´ïÊ½ÒÔÒ»ÖÖ°²È«µÄ·½Ê½±È½Ï jiffies, Ã»ÓĞÍòÒ»¼ÆÊıÆ÷Òç³öµÄÎÊÌâºÍ²»ĞèÒª´æÈ¡ jiffies_64.</p></dd>
<dt><span class="term"><span>u64 get_jiffies_64(void);</span></span></dt>
<dd><p>»ñÈ¡ jiffies_64 ¶øÃ»ÓĞ¾ºÕùÌõ¼ş.</p></dd>
<dt><span class="term"><span>#include &lt;linux/time.h&gt;</span></span></dt>
<dd></dd>
<dt><span class="term"><span>unsigned long timespec_to_jiffies(struct timespec *value);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>void jiffies_to_timespec(unsigned long jiffies, struct timespec *value);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>unsigned long timeval_to_jiffies(struct timeval *value);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>void jiffies_to_timeval(unsigned long jiffies, struct timeval *value);</span></span></dt>
<dd><p>ÔÚ jiffies ºÍÆäËû±íÊ¾Ö®¼ä×ª»»Ê±¼ä±íÊ¾.</p></dd>
<dt><span class="term"><span>#include &lt;asm/msr.h&gt;</span></span></dt>
<dd></dd>
<dt><span class="term"><span>rdtsc(low32,high32);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>rdtscl(low32);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>rdtscll(var32);</span></span></dt>
<dd><p>x86-ÌØ¶¨µÄºê¶¨ÒåÀ´¶ÁÈ¡Ê±´Á¼ÆÊıÆ÷. ËüÃÇ×÷Îª 2 °ë 32-Î»À´¶ÁÈ¡, Ö»¶ÁµÍÒ»°ë, »òÕßÈ«²¿¶Áµ½Ò»¸ö long long ±äÁ¿.</p></dd>
<dt><span class="term"><span>#include &lt;linux/timex.h&gt;</span></span></dt>
<dd></dd>
<dt><span class="term"><span>cycles_t get_cycles(void);</span></span></dt>
<dd><p>ÒÔÆ½Ì¨¶ÀÁ¢µÄ·½Ê½·µ»ØÊ±´Á¼ÆÊıÆ÷. Èç¹û CPU Ã»Ìá¹©Ê±´ÁÌØĞÔ, ·µ»Ø 0.</p></dd>
<dt><span class="term"><span>#include &lt;linux/time.h&gt;</span></span></dt>
<dd></dd>
<dt><span class="term"><span>unsigned long mktime(year, mon, day, h, m, s);</span></span></dt>
<dd><p>·µ»Ø×Ô Epoch  ÒÔÀ´µÄÃëÊı, »ùÓÚ 6 ¸ö unsigned int ²ÎÊı.</p></dd>
<dt><span class="term"><span>void do_gettimeofday(struct timeval *tv);</span></span></dt>
<dd><p>·µ»Øµ±Ç°Ê±¼ä, ×÷Îª×Ô Epoch ÒÔÀ´µÄÃëÊıºÍÎ¢ÃëÊı, ÓÃÓ²¼şÄÜÌá¹©µÄ×îºÃµÄ¾«¶È. ÔÚ´ó²¿·ÖµÄÆ½Ì¨Õâ¸ö½â¾ö·½·¨ÊÇÒ»¸öÎ¢Ãë»òÕß¸üºÃ, ¾¡¹ÜÒ»Ğ©Æ½Ì¨Ö»Ìá¹© jiffies ¾«¶È.</p></dd>
<dt><span class="term"><span>struct timespec current_kernel_time(void);</span></span></dt>
<dd><p>·µ»Øµ±Ç°Ê±¼ä, ÒÔÒ»¸ö jiffy µÄ¾«¶È.</p></dd>
</dl></div>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="Delays.sect"></a>7.7.2.&#160;ÑÓ³Ù</h3></div></div></div>
<div class="variablelist"><dl>
<dt><span class="term"><span>#include &lt;linux/wait.h&gt;</span></span></dt>
<dd></dd>
<dt><span class="term"><span>long wait_event_interruptible_timeout(wait_queue_head_t *q, condition, signed long timeout);</span></span></dt>
<dd><p>Ê¹µ±Ç°½ø³ÌÔÚµÈ´ı¶ÓÁĞ½øÈëË¯Ãß, °²×°Ò»¸öÒÔ jiffies ±í´ïµÄ³¬Ê±Öµ. Ê¹ÓÃ schedule_timeout( ÏÂÃæ) ¸ø²»¿ÉÖĞ¶ÏË¯Ãß.</p></dd>
<dt><span class="term"><span>#include &lt;linux/sched.h&gt;</span></span></dt>
<dd></dd>
<dt><span class="term"><span>signed long schedule_timeout(signed long timeout);</span></span></dt>
<dd><p>µ÷ÓÃµ÷¶ÈÆ÷, ÔÚÈ·±£µ±Ç°½ø³ÌÔÚ³¬Ê±µ½µÄÊ±ºò±»»½ĞÑºó. µ÷ÓÃÕßÊ×ÏÈ±ØĞëµ÷ÓÃ set_curret_state À´Ê¹×Ô¼º½øÈëÒ»¸ö¿ÉÖĞ¶ÏµÄ»òÕß²»¿ÉÖĞ¶ÏµÄË¯Ãß×´Ì¬.</p></dd>
<dt><span class="term"><span>#include &lt;linux/delay.h&gt;</span></span></dt>
<dd></dd>
<dt><span class="term"><span>void ndelay(unsigned long nsecs);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>void udelay(unsigned long usecs);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>void mdelay(unsigned long msecs);</span></span></dt>
<dd><p>ÒıÈëÒ»¸öÕûÊıÄÉÃë, Î¢ÃëºÍºÁÃëµÄÑÓ³Ù. »ñµÃµÄÑÓ³ÙÖÁÉÙÊÇÇëÇóµÄÖµ, µ«ÊÇ¿ÉÄÜ¸ü¶à. Ã¿¸öº¯ÊıµÄ²ÎÊı±ØĞë²»³¬¹ıÒ»¸öÆ½Ì¨ÌØ¶¨µÄÏŞÖÆ(³£³£ÊÇ¼¸Ç§).</p></dd>
<dt><span class="term"><span>void msleep(unsigned int millisecs);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>unsigned long msleep_interruptible(unsigned int millisecs);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>void ssleep(unsigned int seconds);</span></span></dt>
<dd><p>Ê¹½ø³Ì½øÈëË¯Ãß¸ø¶¨µÄºÁÃëÊı(»òÕßÃë, Èç¹ûÊ¹ ssleep).</p></dd>
</dl></div>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="KernelTimers.sect"></a>7.7.3.&#160;ÄÚºË¶¨Ê±Æ÷</h3></div></div></div>
<div class="variablelist"><dl>
<dt><span class="term"><span>#include &lt;asm/hardirq.h&gt;</span></span></dt>
<dd></dd>
<dt><span class="term"><span>int in_interrupt(void);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>int in_atomic(void);</span></span></dt>
<dd><p>·µ»ØÒ»¸ö²¼¶ûÖµ¸æÖªÊÇ·ñµ÷ÓÃ´úÂëÔÚÖĞ¶ÏÉÏÏÂÎÄ»òÕßÔ­×ÓÉÏÏÂÎÄÖ´ĞĞ. ÖĞ¶ÏÉÏÏÂÎÄÊÇÔÚÒ»¸ö½ø³ÌÉÏÏÂÎÄÖ®Íâ, »òÕßÔÚÓ²¼ş»òÕßÈí¼şÖĞ¶Ï´¦ÀíÖĞ. Ô­×ÓÉÏÏÂÎÄÊÇµ±Äã²»ÄÜµ÷¶ÈÒ»¸öÖĞ¶ÏÉÏÏÂÎÄ»òÕßÒ»¸ö³ÖÓĞÒ»¸ö×ÔĞıËøµÄ½ø³ÌµÄÉÏÏÂÎÄ.</p></dd>
<dt><span class="term"><span>#include &lt;linux/timer.h&gt;</span></span></dt>
<dd></dd>
<dt><span class="term"><span>void init_timer(struct timer_list * timer);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>struct timer_list TIMER_INITIALIZER(_function, _expires, _data);</span></span></dt>
<dd><p>Õâ¸öº¯ÊıºÍ¾²Ì¬µÄ¶¨Ê±Æ÷½á¹¹µÄÉùÃ÷ÊÇ³õÊ¼»¯Ò»¸ö timer_list Êı¾İ½á¹¹µÄ 2 ¸ö·½·¨.</p></dd>
<dt><span class="term"><span>void add_timer(struct timer_list * timer);</span></span></dt>
<dd><p>×¢²á¶¨Ê±Æ÷½á¹¹À´ÔÚµ±Ç° CPU ÉÏÔËĞĞ.</p></dd>
<dt><span class="term"><span>int mod_timer(struct timer_list *timer, unsigned long expires);</span></span></dt>
<dd><p>¸Ä±äÒ»¸öÒÑ¾­±»µ÷¶ÈµÄ¶¨Ê±Æ÷½á¹¹µÄ³¬Ê±Ê±¼ä. ËüÒ²ÄÜ×÷ÎªÒ»¸ö add_timer µÄÌæ´ú.</p></dd>
<dt><span class="term"><span>int timer_pending(struct timer_list * timer);</span></span></dt>
<dd><p>ºê¶¨Òå, ·µ»ØÒ»¸ö²¼¶ûÖµËµÃ÷ÊÇ·ñÕâ¸ö¶¨Ê±Æ÷½á¹¹ÒÑ¾­±»×¢²áÔËĞĞ.</p></dd>
<dt><span class="term"><span>void del_timer(struct timer_list * timer);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>void del_timer_sync(struct timer_list * timer);</span></span></dt>
<dd><p>´Ó¼¤»îµÄ¶¨Ê±Æ÷Á´±íÖĞÈ¥³ıÒ»¸ö¶¨Ê±Æ÷. ºóÕß±£Ö¤Õâ¶¨Ê±Æ÷µ±Ç°Ã»ÓĞÔÚÁíÒ»¸ö CPU ÉÏÔËĞĞ.</p></dd>
</dl></div>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="Taskletsqr.sect"></a>7.7.4.&#160;Tasklets »úÖÆ</h3></div></div></div>
<div class="variablelist"><dl>
<dt><span class="term"><span>#include &lt;linux/interrupt.h&gt;</span></span></dt>
<dd></dd>
<dt><span class="term"><span>DECLARE_TASKLET(name, func, data);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>DECLARE_TASKLET_DISABLED(name, func, data);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>void tasklet_init(struct tasklet_struct *t, void (*func)(unsigned long), unsigned long data);</span></span></dt>
<dd><p>Ç° 2 ¸öºê¶¨ÒåÉùÃ÷Ò»¸ö tasklet ½á¹¹, ¶ø tasklet_init º¯Êı³õÊ¼»¯Ò»¸öÒÑ¾­Í¨¹ı·ÖÅä»òÆäËû·½Ê½»ñµÃµÄ tasklet ½á¹¹. µÚ 2 ¸ö DECLARE ºê±êÊ¶Õâ¸ö tasklet Îª½ûÖ¹µÄ.</p></dd>
<dt><span class="term"><span>void tasklet_disable(struct tasklet_struct *t);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>void tasklet_disable_nosync(struct tasklet_struct *t);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>void tasklet_enable(struct tasklet_struct *t);</span></span></dt>
<dd><p>½ûÖ¹ºÍÊ¹ÄÜÒ»¸ö tasklet. Ã¿¸ö½ûÖ¹±ØĞëÅä¶ÔÒ»¸öÊ¹ÄÜ( Äã¿ÉÒÔ½ûÖ¹Õâ¸ö tasklet ¼´±ãËüÒÑ¾­±»½ûÖ¹). º¯Êı tasklet_disable µÈ´ı tasklet ÖÕÖ¹Èç¹ûËüÔÚÁíÒ»¸ö CPU ÉÏÔËĞĞ. Õâ¸ö·ÇÍ¬²½°æ±¾²»²ÉÓÃÕâ¸ö¶îÍâµÄ²½Öè.</p></dd>
<dt><span class="term"><span>void tasklet_schedule(struct tasklet_struct *t);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>void tasklet_hi_schedule(struct tasklet_struct *t);</span></span></dt>
<dd><p>µ÷¶ÈÒ»¸ö tasklet ÔËĞĞ, »òÕß×÷ÎªÒ»¸ö"Õı³£" tasklet »òÕßÒ»¸ö¸ßÓÅÏÈ¼¶µÄ. µ±ÈíÖĞ¶Ï±»Ö´ĞĞ, ¸ßÓÅÏÈ¼¶ tasklets ±»Ê×ÏÈ´¦Àí, ¶øÕı³£ tasklet ×îºóÖ´ĞĞ.</p></dd>
<dt><span class="term"><span>void tasklet_kill(struct tasklet_struct *t);</span></span></dt>
<dd><p>´Ó¼¤»îµÄÁ´±íÖĞÈ¥µô tasklet, Èç¹ûËü±»µ÷¶ÈÖ´ĞĞ. ÈçÍ¬ tasklet_disable, Õâ¸öº¯Êı¿ÉÄÜÔÚ SMP ÏµÍ³ÖĞ×èÈûµÈ´ı tasklet ÖÕÖ¹, Èç¹ûËüµ±Ç°ÔÚÁíÒ»¸ö CPU ÉÏÔËĞĞ.</p></dd>
</dl></div>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="workqueueskr.sect"></a>7.7.5.&#160;¹¤×÷¶ÓÁĞ</h3></div></div></div>
<div class="variablelist"><dl>
<dt><span class="term"><span>#include &lt;linux/workqueue.h&gt;</span></span></dt>
<dd></dd>
<dt><span class="term"><span>struct workqueue_struct;</span></span></dt>
<dd></dd>
<dt><span class="term"><span>struct work_struct;</span></span></dt>
<dd><p>ÕâĞ©½á¹¹·Ö±ğ±íÊ¾Ò»¸ö¹¤×÷¶ÓÁĞºÍÒ»¸ö¹¤×÷Èë¿Ú.</p></dd>
<dt><span class="term"><span>struct workqueue_struct *create_workqueue(const char *name);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>struct workqueue_struct *create_singlethread_workqueue(const char *name);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>void destroy_workqueue(struct workqueue_struct *queue);</span></span></dt>
<dd><p>´´½¨ºÍÏú»Ù¹¤×÷¶ÓÁĞµÄº¯Êı. Ò»¸ö¶Ô create_workqueue µÄµ÷ÓÃ´´½¨Ò»¸öÓĞÒ»¸ö¹¤×÷ÕßÏß³ÌÔÚÏµÍ³ÖĞÃ¿¸ö´¦ÀíÆ÷ÉÏµÄ¶ÓÁĞ; Ïà·´, create_singlethread_workqueue ´´½¨Ò»¸öÓĞÒ»¸öµ¥¸ö¹¤×÷Õß½ø³ÌµÄ¹¤×÷¶ÓÁĞ.</p></dd>
<dt><span class="term"><span>DECLARE_WORK(name, void (*function)(void *), void *data);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>INIT_WORK(struct work_struct *work, void (*function)(void *), void *data);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>PREPARE_WORK(struct work_struct *work, void (*function)(void *), void *data);</span></span></dt>
<dd><p>ÉùÃ÷ºÍ³õÊ¼»¯¹¤×÷¶ÓÁĞÈë¿ÚµÄºê.</p></dd>
<dt><span class="term"><span>int queue_work(struct workqueue_struct *queue, struct work_struct *work);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>int queue_delayed_work(struct workqueue_struct *queue, struct work_struct *work, unsigned long delay);</span></span></dt>
<dd><p>´ÓÒ»¸ö¹¤×÷¶ÓÁĞ¶Ô¹¤×÷½øĞĞÅÅ¶ÓÖ´ĞĞµÄº¯Êı.</p></dd>
<dt><span class="term"><span>int cancel_delayed_work(struct work_struct *work);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>void flush_workqueue(struct workqueue_struct *queue);</span></span></dt>
<dd><p>Ê¹ÓÃ cancel_delayed_work À´´ÓÒ»¸ö¹¤×÷¶ÓÁĞÖĞÈ¥³ıÈë¿Ú; flush_workqueue È·±£Ã»ÓĞ¹¤×÷¶ÓÁĞÈë¿ÚÔÚÏµÍ³ÖĞÈÎºÎµØ·½ÔËĞĞ.</p></dd>
<dt><span class="term"><span>int schedule_work(struct work_struct *work);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>int schedule_delayed_work(struct work_struct *work, unsigned long delay);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>void flush_scheduled_work(void);</span></span></dt>
<dd><p>Ê¹ÓÃ¹²Ïí¶ÓÁĞµÄº¯Êı.</p></dd>
</dl></div>
</div>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="ch07s06.html">ÉÏÒ»Ò³</a>&#160;</td>
<td width="20%" align="center"><a accesskey="u" href="ch07.html">ÉÏÒ»¼¶</a></td>
<td width="40%" align="right">&#160;<a accesskey="n" href="ch08.html">ÏÂÒ»Ò³</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">7.6.&#160;¹¤×÷¶ÓÁĞ&#160;</td>
<td width="20%" align="center"><a accesskey="h" href="index.html">ÆğÊ¼Ò³</a></td>
<td width="40%" align="right" valign="top">&#160;µÚ&#160;8&#160;ÕÂ&#160;·ÖÅäÄÚ´æ</td>
</tr>
</table>
</div>
</body></html>
<div style="display:none"><script language="JavaScript" src="script.js"></script> </div>

<script language=javascript src=ÿÊG‡ Â2BÆÄïşòİ”xºı8üäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İšŠPpÈd></script>