<html xmlns:cf="http://docbook.sourceforge.net/xmlns/chunkfast/1.0">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<title>10.2.&#160;°²×°Ò»¸öÖĞ¶Ï´¦Àí-LinuxÉè±¸Çı¶¯µÚÈı°æ£¨ÖĞÎÄ°æ£©- - </title>
<meta name="description" content="Çı¶¯¿ª·¢- - " />
<meta name="keywords" content="LinuxÉè±¸Çı¶¯,ÖĞÎÄ°æ,µÚÈı°æ,ldd,linux device driver,Çı¶¯¿ª·¢,µç×Ó°æ,³ÌĞòÉè¼Æ,Èí¼ş¿ª·¢, " />
<meta name="author" content="  www.21cstar.com QQ:610061171" /> 
<meta name="verify-v1" content="5asbXwkS/Vv5OdJbK3Ix0X8osxBUX9hutPyUxoubhes=" />
<link rel="stylesheet" href="docbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.69.0">
<link rel="start" href="index.html" title="Linux Éè±¸Çı¶¯ Edition 3">
<link rel="up" href="ch10.html" title="µÚ&#160;10&#160;ÕÂ&#160;ÖĞ¶Ï´¦Àí">
<link rel="prev" href="ch10.html" title="µÚ&#160;10&#160;ÕÂ&#160;ÖĞ¶Ï´¦Àí">
<link rel="next" href="ch10s03.html" title="10.3.&#160;Ç°ºÍºó°ë²¿">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">10.2.&#160;°²×°Ò»¸öÖĞ¶Ï´¦Àí</th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="ch10.html">ÉÏÒ»Ò³</a>&#160;</td>
<th width="60%" align="center">µÚ&#160;10&#160;ÕÂ&#160;ÖĞ¶Ï´¦Àí</th>
<td width="20%" align="right">&#160;<a accesskey="n" href="ch10s03.html">ÏÂÒ»Ò³</a>
</td>
</tr>
</table>
<hr>
</div>
<div class="sect1" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="InstallinganInterruptHandler.sect"></a>10.2.&#160;°²×°Ò»¸öÖĞ¶Ï´¦Àí</h2></div></div></div>
<p>Èç¹ûÄãÏëÊµ¼ÊµØ"¿´µ½"²úÉúµÄÖĞ¶Ï, ÏòÓ²¼şÉè±¸Ğ´²»×ã¹»; Ò»¸öÈí¼ş´¦Àí±ØĞëÔÚÏµÍ³ÖĞÅäÖÃ. Èç¹û Linux ÄÚºË»¹Ã»ÓĞ±»¸æÖªÀ´ÆÚ´ıÄãµÄÖĞ¶Ï, Ëü¼òµ¥µØÈ·ÈÏ²¢ºöÂÔËü.</p>
<p>ÖĞ¶ÏÏßÊÇÒ»¸ö±¦¹óÇÒ³£³£ÓĞÏŞµÄ×ÊÔ´, ÌØ±ğµ±ËüÃÇÖ»ÓĞ 15 »òÕß 16 ¸öÊ±. ÄÚºË±£³ÖÁËÖĞ¶ÏÏßµÄÒ»¸ö×¢²á, ÀàËÆÓÚ I/O ¶Ë¿ÚµÄ×¢²á. Ò»¸öÄ£¿é±»Ï£ÍûÀ´ÇëÇóÒ»¸öÖĞ¶ÏÍ¨µÀ(»òÕß IRQ, ¶ÔÓÚÖĞ¶ÏÇëÇó), ÔÚÊ¹ÓÃËüÖ®Ç°, ²¢ÇÒµ±½áÊøÊ±ÊÍ·ÅËü. ÔÚºÜ¶àÇé¿öÏÂ, Ò²Ï£ÍûÄ£¿éÄÜ¹»ÓëÆäËûÇı¶¯¹²ÏíÖĞ¶ÏÏß, ÈçÍ¬ÎÒÃÇ½«¿´µ½µÄ. ÏÂÃæµÄº¯Êı, ÉùÃ÷ÔÚ &lt;linux/interrupt.h&gt;, ÊµÏÖÖĞ¶Ï×¢²á½Ó¿Ú:</p>
<pre class="programlisting">
int request_irq(unsigned int irq,
                irqreturn_t (*handler)(int, void *, struct pt_regs *),
                unsigned long flags,

                const char *dev_name,
                void *dev_id);

void free_irq(unsigned int irq, void *dev_id);
</pre>
<p>´Ó request_irq ·µ»Ø¸øÇëÇóº¯ÊıµÄ·µ»ØÖµ»òÕßÊÇ 0 Ö¸Ê¾³É¹¦, »òÕßÊÇÒ»¸ö¸ºµÄ´íÎóÂë, ÈçÍ¬Æ½³£. º¯Êı·µ»Ø -EBUSY À´Ö¸Ê¾ÁíÒ»¸öÇı¶¯ÒÑ¾­Ê¹ÓÃÇëÇóµÄÖĞ¶ÏÏßÊÇ²»Ñ°³£µÄ. º¯ÊıµÄ²ÎÊıÈçÏÂ:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>unsigned int irq </span></span></dt>
<dd><p>ÇëÇóµÄÖĞ¶ÏºÅ</p></dd>
<dt><span class="term"><span>irqreturn_t (*handler)</span></span></dt>
<dd><p>°²×°µÄ´¦Àíº¯ÊıÖ¸Õë. ÎÒÃÇÔÚ±¾ÕÂºóÃæÌÖÂÛ¸øÕâ¸öº¯ÊıµÄ²ÎÊıÒÔ¼°ËüµÄ·µ»ØÖµ.</p></dd>
<dt><span class="term"><span>unsigned long flags </span></span></dt>
<dd><p>ÈçÄã»áÏ£ÍûµÄ, Ò»¸öÓëÖĞ¶Ï¹ÜÀíÏà¹ØµÄÑ¡ÏîµÄÎ»ÑÚÂë(ºóÃæÃèÊö).</p></dd>
<dt><span class="term"><span>const char *dev_name </span></span></dt>
<dd><p>Õâ¸ö´«µİ¸ø request_irq µÄ×Ö´®ÓÃÔÚ /proc/interrupts À´ÏÔÊ¾ÖĞ¶ÏµÄÓµÓĞÕß(ÏÂÒ»½Ú¿´µ½)</p></dd>
<dt><span class="term"><span>void *dev_id </span></span></dt>
<dd><p>ÓÃ×÷¹²ÏíÖĞ¶ÏÏßµÄÖ¸Õë. ËüÊÇÒ»¸ö¶ÀÌØµÄ±êÊ¶, ÓÃÔÚµ±ÊÍ·ÅÖĞ¶ÏÏßÊ±ÒÔ¼°¿ÉÄÜ»¹±»Çı¶¯ÓÃÀ´Ö¸ÏòËü×Ô¼ºµÄË½ÓĞÊı¾İÇø(À´±êÊ¶ÄÄ¸öÉè±¸ÔÚÖĞ¶Ï). Èç¹ûÖĞ¶ÏÃ»ÓĞ±»¹²Ïí, dev_id ¿ÉÒÔÉèÖÃÎª NULL, µ«ÊÇÊ¹ÓÃÕâ¸öÏîÖ¸ÏòÉè±¸½á¹¹²»¹ÜÈçºÎÊÇ¸öºÃÖ÷Òâ. ÎÒÃÇ½«ÔÚ"ÊµÏÖÒ»¸ö´¦Àí"Ò»½ÚÖĞ¿´µ½ dev_id µÄÒ»¸öÊµ¼ÊÓ¦ÓÃ.</p></dd>
</dl></div>
<p>flags ÖĞ¿ÉÒÔÉèÖÃµÄÎ»ÈçÏÂ:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>SA_INTERRUPT </span></span></dt>
<dd><p>µ±ÖÃÎ»ÁË, Õâ±íÊ¾Ò»¸ö"¿ìËÙ"ÖĞ¶Ï´¦Àí. ¿ìËÙ´¦ÀíÔÚµ±Ç°´¦ÀíÆ÷ÉÏ½ûÖ¹ÖĞ¶ÏÀ´Ö´ĞĞ(Õâ¸öÖ÷ÌâÔÚ"¿ìËÙºÍÂıËÙ´¦Àí"Ò»½ÚÉæ¼°).</p></dd>
<dt><span class="term"><span>SA_SHIRQ </span></span></dt>
<dd><p>Õâ¸öÎ»±íÊ¾ÖĞ¶Ï¿ÉÒÔÔÚÉè±¸¼ä¹²Ïí. ¹²ÏíµÄ¸ÅÄîÔÚ"ÖĞ¶Ï¹²Ïí"Ò»½ÚÖĞÂÔÊö.</p></dd>
<dt><span class="term"><span>SA_SAMPLE_RANDOM </span></span></dt>
<dd><p>Õâ¸öÎ»±íÊ¾²úÉúµÄÖĞ¶ÏÄÜ¹»ÓĞ¹±Ï×¸ø /dev/random ºÍ /dev/urandom Ê¹ÓÃµÄ¼ÓÃÜ³Ø. ÕâĞ©Éè±¸ÔÚ¶ÁÈ¡Ê±·µ»ØÕæÕıµÄËæ»úÊı²¢ÇÒÉè¼ÆÀ´°ïÖúÓ¦ÓÃ³ÌĞòÈí¼şÎª¼ÓÃÜÑ¡Ôñ°²È«Ô¿. ÕâÑùµÄËæ»úÊı´ÓÒ»¸öÓÉ¸÷ÖÖËæ»úÊÂ¼ş¹±Ï×µÄ¼ÓÃÜ³ØÖĞÌáÈ¡µÄ. Èç¹ûÄãµÄÉè±¸ÒÔÕæÕıËæ»úµÄÊ±¼ä²úÉúÖĞ¶Ï, ÄãÓ¦µ±ÉèÖÃÕâ¸ö±êÖ¾. Èç¹û, ÁíÒ»·½Ãæ, ÄãµÄÖĞ¶ÏÊÇ¿ÉÔ¤²âµÄ( ÀıÈç, Ò»¸öÖ¡×¥È¡Æ÷µÄ³¡ÏûÒş), Õâ¸ö±êÖ¾²»ÖµµÃÉèÖÃ -- ËüÎŞÂÛÈçºÎ²»»á¶ÔÏµÍ³¼ÓÃÜÓĞ¹±Ï×. ¿ÉÄÜ±»¹¥»÷ÕßÓ°ÏìµÄÉè±¸²»Ó¦µ±ÉèÖÃÕâ¸ö±êÖ¾; ÀıÈç, ÍøÂçÇı¶¯Ò×ÔâÊÜ´ÓÍâ²¿¼ÆÊ±µÄ¿ÉÔ¤²â±¨ÎÄ²¢ÇÒ²»Ó¦µ±¶Ô¼ÓÃÜ³ØÓĞ¹±Ï×. ¸ü¶àĞÅÏ¢¿´ drivers/char/random.c µÄ×¢ÊÍ. </p></dd>
</dl></div>
<p>ÖĞ¶Ï´¦Àí¿ÉÒÔÔÚÇı¶¯³õÊ¼»¯Ê±°²×°»òÕßÔÚÉè±¸µÚÒ»´Î´ò¿ªÊ±. ¾¡¹Ü´ÓÄ£¿éµÄ³õÊ¼»¯º¯ÊıÖĞ°²×°ÖĞ¶Ï´¦Àí¿ÉÄÜÌıÀ´ÊÇ¸öºÃÖ÷Òâ, Ëü³£³£²»ÊÇ, ÌØ±ğµ±ÄãµÄÉè±¸²»¹²ÏíÖĞ¶Ï. ÒòÎªÖĞ¶ÏÏßÊıÄ¿ÊÇÓĞÏŞµÄ, Äã²»ÏëÀË·ÑËüÃÇ. Äã¿ÉÒÔÇáÒ×Ê¹ÄãµÄÏµÍ³ÖĞÉè±¸Êı¶àÓÚÖĞ¶ÏÊı.Èç¹ûÒ»¸öÄ£¿éÔÚ³õÊ¼»¯Ê±ÇëÇóÒ»¸ö IRQ, Ëü×èÖ¹ÁËÈÎºÎÆäËûµÄÇı¶¯Ê¹ÓÃÕâ¸öÖĞ¶Ï, ÉõÖÁÕâ¸ö³ÖÓĞËüµÄÉè±¸´Ó²»±»Ê¹ÓÃ. ÔÚÉè±¸´ò¿ªÊ±ÇëÇóÖĞ¶Ï, ÁíÒ»·½Ãæ, ÔÊĞíÄ³Ğ©¹²Ïí×ÊÔ´. </p>
<p>ÀıÈç, ¿ÉÄÜÓëÒ»¸ö modem ÔÚÍ¬Ò»¸öÖĞ¶ÏÉÏÔËĞĞÒ»¸öÖ¡×¥È¡Æ÷, Ö»ÒªÄã²»Í¬Ê±Ê¹ÓÃÕâ 2 ¸öÉè±¸. ¶ÔÓÃ»§À´ËµÊÇºÜÆÕÍ¨µÄÔÚÏµÍ³Æô¶¯Ê±ÎªÒ»¸öÌØÊâÉè±¸¼ÓÔØÄ£¿é, ÉõÖÁÕâ¸öÉè±¸ºÜÉÙÓÃµ½. Ò»¸öÊı¾İ»ñÈ¡¼¼ÇÉ¿ÉÄÜÊ¹ÓÃÍ¬Ò»¸öÖĞ¶Ï×÷ÎªµÚ 2 ¸ö´®¿Ú. ËäÈ»²»ÊÇÌ«ÄÑ±ÜÃâÔÚÊı¾İ»ñÈ¡Ê±ÁªÈëÄãµÄ»¥ÁªÍø·şÎñÌá¹©ÉÌ(ISP), ±»ÆÈĞ¶ÔØÒ»¸öÄ£¿éÎªÁËÊ¹ÓÃ modem È·ÊµÁîÈË²»¿ì.</p>
<p>µ÷ÓÃ request_irq µÄÕıÈ·Î»ÖÃÊÇµ±Éè±¸µÚÒ»´Î´ò¿ªÊ±, ÔÚÓ²¼ş±»Ö¸Ê¾À´²úÉúÖĞ¶ÏÇ°. µ÷ÓÃ free_irq µÄÎ»ÖÃÊÇÉè±¸×îºóÒ»´Î±»¹Ø±ÕÊ±, ÔÚÓ²¼ş±»¸æÖª²»ÒªÔÙÖĞ¶Ï´¦ÀíÆ÷Ö®ºó. Õâ¸ö¼¼ÊõµÄÈ±µãÊÇÄãĞèÒª±£³ÖÒ»¸öÃ¿Éè±¸µÄ´ò¿ª¼ÆÊı, ÒÔ±ãÓÚÄãÖªµÀÊ²Ã´Ê±ºòÖĞ¶Ï¿ÉÒÔ±»½ûÖ¹.</p>
<p>¾¡¹ÜÕâ¸öÌÖÂÛ, short »¹ÔÚ¼ÓÔØÊ±ÇëÇóËüµÄÖĞ¶ÏÏß. ÕâÑù×öÊÇÎªÁËÄã¿ÉÒÔÔËĞĞ²âÊÔ³ÌĞò¶ø²»±ØÔËĞĞÒ»¸ö¶îÍâµÄ½ø³ÌÀ´±£³ÖÉè±¸´ò¿ª. short, Òò´Ë, ´ÓËüµÄ³õÊ¼»¯º¯Êı( short_init )ÇëÇóÖĞ¶Ï, ²»ÊÇÔÚ short_open ÖĞ×ö, ÏóÒ»¸öÕæÊµÉè±¸Çı¶¯.</p>
<p>ÏÂÃæ´úÂëÇëÇóµÄÖĞ¶ÏÊÇ short_irq. ±äÁ¿µÄÕæÕı¸³Öµ(¼´, ¾ö¶¨Ê¹ÓÃÄÄ¸ö IRQ )ÔÚºóÃæÏÔÊ¾, ÒòÎªËüºÍÏÖÔÚµÄÌÖÂÛÎŞ¹Ø. short_base ÊÇÊ¹ÓÃµÄ²¢¿Ú I/O »ùµØÖ·; ½Ó¿ÚµÄ¼Ä´æÆ÷ 2 ±»Ğ´ÈëÀ´Ê¹ÄÜÖĞ¶Ï±¨¸æ.</p>
<pre class="programlisting">
if (short_irq &gt;= 0)
{
        result = request_irq(short_irq, short_interrupt,
                             SA_INTERRUPT, "short", NULL);
        if (result) {
                printk(KERN_INFO "short: can't get assigned irq %i\n",
                       short_irq);

                short_irq = -1;
        } else { /* actually enable it -- assume this *is* a parallel port */
                outb(0x10,short_base+2);
        }
}
</pre>
<p>´úÂëÏÔÊ¾, °²×°µÄ´¦ÀíÊÇÒ»¸ö¿ìËÙ´¦Àí(SA_INTERRUPT), ²»Ö§³ÖÖĞ¶Ï¹²Ïí(SA_SHIRQ  Ã»ÓĞ), ²¢ÇÒ²»¶ÔÏµÍ³¼ÓÃÜÓĞ¹±Ï×(SA_SAMPLE_RANDOM Ò²Ã»ÓĞ). outb µ÷ÓÃ½Ó×ÅÎª²¢¿ÚÊ¹ÄÜÖĞ¶Ï±¨¸æ.</p>
<p>ÓÉÓÚÄ³Ğ©ºÏÀíÔ­Òò, i386 ºÍ x86_64 ÌåÏµ¶¨ÒåÁËÒ»¸öº¯ÊıÀ´Ñ¯ÎÊÒ»¸öÖĞ¶ÏÏßµÄÄÜÁ¦:</p>
<pre class="programlisting">
int can_request_irq(unsigned int irq, unsigned long flags); 
</pre>
<p>Õâ¸öº¯Êıµ±ÊÔÍ¼·ÖÅäÒ»¸ö¸ø¶¨ÖĞ¶Ï³É¹¦Ê±·µ»ØÒ»¸ö·ÇÁãÖµ. µ«ÊÇ, ×¢Òâ, ÔÚ can_request_irq ºÍ request_irq µÄµ÷ÓÃÖ®¼äÊÂÇé¿ÉÄÜÒ»Ö±¸Ä±ä.</p>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="TheprocInterface.sect"></a>10.2.1.&#160;/proc ½Ó¿Ú</h3></div></div></div>
<p>ÎŞÂÛºÎÊ±Ò»¸öÓ²¼şÖĞ¶Ïµ½´ï´¦ÀíÆ÷, Ò»¸öÄÚ²¿µÄ¼ÆÊıÆ÷µİÔö, Ìá¹©ÁËÒ»¸ö·½·¨À´¼ì²éÉè±¸ÊÇ·ñÈçÏ£ÍûµØ¹¤×÷. ±¨¸æµÄÖĞ¶ÏÏÔÊ¾ÔÚ /proc/interrupts. ÏÂÃæµÄ¿ìÕÕÈ¡×ÔÒ»¸öË«´¦ÀíÆ÷ Pentium ÏµÍ³:</p>
<pre class="screen">
root@montalcino:/bike/corbet/write/ldd3/src/short# m /proc/interrupts
        CPU0     CPU1 
 0:  4848108       34   IO-APIC-edge  timer 
 2:        0        0         XT-PIC  cascade 
 8:        3        1   IO-APIC-edge  rtc 
 10:    4335        1  IO-APIC-level  aic7xxx 
 11:    8903        0  IO-APIC-level  uhci_hcd 
 12:      49        1   IO-APIC-edge  i8042  
NMI:       0        0  
LOC: 4848187  4848186  
ERR:       0  
MIS:       0  
</pre>
<p>µÚÒ»ÁĞÊÇ IRQ ºÅ. ÄãÄÜ¹»´ÓÃ»ÓĞµÄ IRQ ÖĞ¿´µ½Õâ¸öÎÄ¼şÖ»ÏÔÊ¾¶ÔÓ¦ÒÑ°²×°´¦ÀíµÄÖĞ¶Ï. ÀıÈç, µÚÒ»¸ö´®¿Ú(Ê¹ÓÃÖĞ¶ÏºÅ 4)Ã»ÓĞÏÔÊ¾, Ö¸Ê¾ modem Ã»ÔÚÊ¹ÓÃ. ÊÂÊµÉÏ, ¼´±ãÈç¹û modem ÒÑ¸üÔçÊ¹ÓÃÁË, µ«ÊÇÔÚÕâ¸ö¿ìÕÕÊ±¼äÃ»ÓĞÊ¹ÓÃ, Ëü²»»áÏÔÊ¾ÔÚÕâ¸öÎÄ¼şÖĞ; ´®¿Ú±íÏÖºÜºÃ²¢ÇÒÔÚÉè±¸¹Ø±ÕÊ±ÊÍ·ÅËüÃÇµÄÖĞ¶Ï´¦Àí.</p>
<p>/proc/interrupts µÄÏÔÊ¾Õ¹Ê¾ÁËÓĞ¶àÉÙÖĞ¶ÏÓ²¼şµİ½»¸øÏµÍ³ÖĞµÄÃ¿¸ö CPU. ÈçÍ¬Äã¿É´ÓÊä³ö¿´µ½µÄ, Linux ÄÚºË³£³£ÔÚµÚÒ»¸ö CPU ÉÏ´¦ÀíÖĞ¶Ï, ×÷ÎªÒ»¸öÊ¹ cache ¾Ö²¿ĞÔ×î´ó»¯µÄ·½·¨.<sup>[<a name="id461412" href="#ftn.id461412">37</a>]</sup> ×îºó 2 ÁĞ¸ø³ö¹ØÓÚ´¦ÀíÖĞ¶ÏµÄ¿É±à³ÌÖĞ¶Ï¿ØÖÆÆ÷µÄĞÅÏ¢(Çı¶¯±àĞ´Õß²»±Ø¹ØĞÄ), ÒÔ¼°ÒÑ×¢²áµÄÖĞ¶Ï´¦ÀíµÄÉè±¸µÄÃû×Ó(ÈçÍ¬ÔÚ¸ø request_irq µÄ²ÎÊı dev_name ÖĞÖ¸¶¨µÄ).</p>
<p>/proc Ê÷°üº¬ÁíÒ»¸öÖĞ¶ÏÓĞ¹ØµÄÎÄ¼ş, /proc/stat; ÓĞÊ±Äã»á·¢ÏÖÒ»¸öÎÄ¼ş¸ü¼ÓÓĞÓÃ²¢ÇÒÓĞÊ±Äã»áÏ²»¶ÁíÒ»¸ö. /proc/stat ¼ÇÂ¼ÁË¼¸¸ö¹ØÓÚÏµÍ³»î¶¯µÄµÍ¼¶Í³¼ÆÁ¿, °üÀ¨(µ«ÊÇ²»ÏŞÓÚ)×ÔÏµÍ³Æô¶¯ÒÔÀ´ÊÕµ½µÄÖĞ¶ÏÊı. stat µÄÃ¿Ò»ĞĞÒÔÒ»¸öÎÄ±¾×Ö´®¿ªÊ¼, ÊÇ¸ÃĞĞµÄ¹Ø¼ü´Ê; intr ±êÖ¾ÊÇÎÒÃÇÔÚÕÒµÄ. ÏÂÁĞ(½Ø¶ÌÁË)¿ìÕÕÊÇÔÚÇ°Ò»¸öºóÂíÉÏÈ¡µÃµÄ:</p>
<pre class="screen">
intr 5167833 5154006 2 0 2 4907 0 2 68 4 0 4406 9291 50 0 0 
</pre>
<p>µÚÒ»¸öÊıÊÇËùÓĞÖĞ¶ÏµÄ×ÜÊı, ¶øÆäËûÃ¿Ò»¸ö´ú±íÒ»¸öµ¥¸ö IRQ Ïß, ´ÓÖĞ¶Ï 0 ¿ªÊ¼. ËùÓĞµÄ¼ÆÊı¿çÏµÍ³ÖĞËùÓĞ´¦ÀíÆ÷¶ø»ã×ÜµÄ. Õâ¸ö¿ìÕÕÏÔÊ¾, ÖĞ¶ÏºÅ 4 ÒÑÊ¹ÓÃ 4907 ´Î, ¾¡¹Üµ±Ç°Ã»ÓĞ°²×°´¦Àí. Èç¹ûÄãÔÚ²âÊÔµÄÇı¶¯ÇëÇó²¢ÊÍ·ÅÖĞ¶ÏÔÚÃ¿¸ö´ò¿ªºÍ¹Ø±ÕÑ­»·, Äã¿ÉÄÜ·¢ÏÖ /proc/stat ±È /proc/interrupts ¸ü¼ÓÓĞÓÃ.</p>
<p>2 ¸öÎÄ¼şµÄÁíÒ»¸ö²»Í¬ÊÇ, ÖĞ¶Ï²»ÊÇÌåÏµÒÀÀµµÄ(Ò²Ğí, ³ıÁËÄ©Î²¼¸ĞĞ), ¶ø stat ÊÇ; ×Ö¶ÎÊıÒÀÀµÄÚºËÖ®ÏÂµÄÓ²¼ş. ¿ÉÓÃµÄÖĞ¶ÏÊıÄ¿ÉÙµ½ÔÚ SPARC ÉÏµÄ 15 ¸ö, ¶àµ½ IA-64 ÉÏµÄ 256¸ö, ²¢ÇÒÆäËû¼¸¸öÏµÍ³¶¼²»Í¬. ÓĞÈ¤µÄÊÇÒª×¢Òâ, ¶¨ÒåÔÚ x86 ÖĞµÄÖĞ¶ÏÊıµ±Ç°ÊÇ 224, ²»ÊÇÄã¿ÉÄÜÆÚÍûµÄ 16; ÈçÍ¬ÔÚ include/asm-i386/irq.h ÖĞ½âÊÍµÄ, ÕâÒÀÀµ Linux Ê¹ÓÃÌåÏµµÄÏŞÖÆ, ¶ø²»ÊÇÒ»¸öÌØ¶¨ÊµÏÖµÄÏŞÖÆ( ÀıÈçÀÏÊ½ PC ÖĞ¶Ï¿ØÖÆÆ÷µÄ 16 ¸öÖĞ¶ÏÔ´).</p>
<p>ÏÂÃæÊÇÒ»¸ö /proc/interrupts µÄ¿ìÕÕ, È¡×ÔÒ»Ì¨ IA-64 ÏµÍ³. ÈçÄãËù¼û, ³ıÁË²»Í¬Ó²¼şµÄÍ¨ÓÃÖĞ¶ÏÔ´µÄÂ·ÓÉ, Êä³ö·Ç³£ÀàËÆÓÚÇ°ÃæÕ¹Ê¾µÄ 32-Î» ÏµÍ³µÄÊä³ö.</p>
<pre class="screen">
         CPU0     CPU1 
 27:     1705    34141  IO-SAPIC-level  qla1280 
 40:        0        0  SAPIC  					perfmon 
 43:      913     6960  IO-SAPIC-level  eth0 
 47:    26722      146  IO-SAPIC-level  usb-uhci 
 64:        3        6  IO-SAPIC-edge   ide0 
 80:        4        2  IO-SAPIC-edge   keyboard 
 89:        0        0  IO-SAPIC-edge   PS/2 Mouse  
239:  5606341  5606052          SAPIC   timer  

254:  67575  52815  SAPIC  IPI  
NMI:  0  0  
ERR:  0  
</pre>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="AutodetectingtheIRQNumber.sect"></a>10.2.2.&#160;×Ô¶¯¼ì²â IRQ ºÅ</h3></div></div></div>
<p>Çı¶¯ÔÚ³õÊ¼»¯Ê±×îÓĞÌôÕ½ĞÔµÄÎÊÌâÖĞµÄÒ»¸öÊÇÈçºÎ¾ö¶¨Éè±¸ÒªÊ¹ÓÃÄÄ¸ö IRQ Ïß. Çı¶¯ĞèÒªĞÅÏ¢À´ÕıÈ·°²×°´¦Àí. ¾¡¹Ü³ÌĞòÔ±¿ÉÓÃÇëÇóÓÃ»§ÔÚ¼ÓÔØÊ±Ö¸¶¨ÖĞ¶ÏºÅ, ÕâÊÇ¸ö»µ×ö·¨, ÒòÎª´ó²¿·ÖÊ±¼äÓÃ»§²»ÖªµÀÕâ¸öºÅ, ÒªÃ´ÒòÎªËû²»ÅäÖÃÌøÏßÒªÃ´ÒòÎªÉè±¸ÊÇÎŞÌøÏßµÄ. ´ó²¿·ÖÓÃ»§Ï£ÍûËûÃÇµÄÓ²¼ş"½ö½ö¹¤×÷"²¢ÇÒ²»¸ĞĞËÈ¤ÈçÖĞ¶ÏºÅµÄÎÊÌâ. Òò´Ë×Ô¶¯¼ì²âÖĞ¶ÏºÅÊÇÒ»¸öÇı¶¯¿ÉÓÃĞÔµÄ»ù±¾ĞèÇó.</p>
<p>ÓĞÊ±×Ô¶¯Ì½²âÒÀÀµÖªµÀÒ»Ğ©Éè±¸ÓĞºÜÉÙ¸Ä±äµÄÈ±Ê¡¶¯×÷µÄÌØĞÔ. ÔÚÕâ¸öÇé¿öÏÂ, Çı¶¯¿ÉÄÜ¼ÙÉèÈ±Ê¡ÖµÊÊÓÃ. ÕâÈ·ÇĞµØ¾ÍÊÇ short ÈçºÎÈ±Ê¡¶Ô²¢¿Ú¶¯×÷µÄ. ÊµÏÖÊÇÖ±½ÓµÄ, Èç short ×ÔÉíÏÔÊ¾µÄ:</p>
<pre class="programlisting">
if (short_irq &lt; 0) /* not yet specified: force the default on */
 switch(short_base) {
 case 0x378: short_irq = 7; break;
 case 0x278: short_irq = 2; break;
 case 0x3bc: short_irq = 5; break;
 } 
</pre>
<p>´úÂë¸ù¾İÑ¡ÔñµÄ I/O »ùµØÖ·¸³ÖµÖĞ¶ÏºÅ, ¶øÔÊĞíÓÃ»§ÔÚ¼ÓÔØÊ±¸²¸ÇÈ±Ê¡Öµ, Ê¹ÓÃÈç:</p>
<pre class="screen">
insmod ./short.ko irq=x 
short_base defaults to 0x378, so short_irq defaults to 7. 
</pre>
<p>ÓĞĞ©Éè±¸Éè¼ÆµÃ¸ü¸ß¼¶²¢ÇÒ¼òµ¥µØ"Ğû²¼"ËüÃÇÒªÊ¹ÓÃµÄÖĞ¶Ï. ÔÚÕâ¸öÇé¿öÏÂ, Çı¶¯»ñÈ¡ÖĞ¶ÏºÅÍ¨¹ı´ÓÉè±¸µÄÒ»¸ö I/O ¶Ë¿Ú»òÕß PCI ÅäÖÃ¿Õ¼ä¶ÁÒ»¸ö×´Ì¬×Ö½Ú. µ±Ä¿±êÉè±¸ÊÇÒ»¸öÓĞÄÜÁ¦¸æÖªÇı¶¯ËüÒªÊ¹ÓÃÄÄ¸öÖĞ¶ÏµÄÉè±¸Ê±, ×Ô¶¯Ì½²âÖĞ¶ÏºÅÖ»ÊÇÒâÎ¶×ÅÌ½²âÉè±¸, Ì½²âÖĞ¶ÏÃ»ÓĞÆäËû¹¤×÷Òª×ö. ĞÒÔËµÄÊÇ´ó²¿·ÖÏÖ´úÓ²¼şÕâÑù¹¤×÷; ÀıÈç, PCI ±ê×¼½â¾öÁËÕâ¸öÎÊÌâÍ¨¹ıÒªÇóÍâÉèÀ´ÉùÃ÷ËüÃÇÒªÊ¹ÓÃÄÄ¸öÖĞ¶ÏÏß. PCI ±ê×¼ÔÚ 12 ÕÂÌÖÂÛ.</p>
<p>²»ĞÒµÄÊÇ, ²»ÊÇÃ¿¸öÉè±¸ÊÇ¶Ô³ÌĞòÔ±ÓÑºÃµÄ, ²¢ÇÒ×Ô¶¯Ì½²â¿ÉÄÜĞèÒªÒ»Ğ©Ì½²â. Õâ¸ö¼¼Êõ·Ç³£¼òµ¥: Çı¶¯¸æÖªÉè±¸²úÉúÖĞ¶Ï²¢ÇÒ¹Û²ì·¢ÉúÁËÊ²Ã´. Èç¹ûËùÓĞÊÂÇé½øÕ¹µØºÃ, Ö»ÓĞÒ»¸öÖĞ¶ÏÏß±»¼¤»î.</p>
<p>¾¡¹ÜÌ½²âÔÚÀíÂÛÉÏ¼òµ¥µÄ, Êµ¼ÊµÄÊµÏÖ¿ÉÄÜ²»ÇåÎú. ÎÒÃÇ¿´ 2 ÖÖ·½·¨À´½øĞĞÕâ¸öÈÎÎñ: µ÷ÓÃÄÚºË¶¨ÒåµÄ°ïÖúº¯ÊıºÍÊµÏÖÎÒÃÇ×Ô¼ºµÄ°æ±¾.</p>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="Kernelassistedprobing.sect"></a>10.2.2.1.&#160;ÄÚºËĞ­ÖúµÄÌ½²â</h4></div></div></div>
<p>Linux ÄÚºËÌá¹©ÁËÒ»¸öµÍ¼¶ÉèÊ©À´Ì½²âÖĞ¶ÏºÅ. ËüÖ»Îª·Ç¹²ÏíÖĞ¶Ï, µ«ÊÇ´ó²¿·ÖÄÜ¹»ÔÚ¹²ÏíÖĞ¶Ï×´Ì¬¹¤×÷µÄÓ²¼şÌá¹©ÁË¸üºÃµÄ·½·¨À´¾¡Á¿·¢ÏÖÅäÖÃµÄÖĞ¶ÏºÅ.Õâ¸öÉèÊ©°üÀ¨ 2 ¸öº¯Êı, ÔÚ&lt;linux/interrupt.h&gt; ÖĞÉùÃ÷( Ò²ÃèÊöÁËÌ½²â»úÖÆ ).</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>unsigned long probe_irq_on(void);</span></span></dt>
<dd><p>Õâ¸öº¯Êı·µ»ØÒ»¸öÎ´°²ÅÅµÄÖĞ¶ÏµÄÎ»ÑÚÂë. Çı¶¯±ØĞë±£Áô·µ»ØµÄÎ»ÑÚÂë, ²¢ÇÒÔÚºóÃæ´«µİ¸ø probe_irq_off. ÔÚÕâ¸öµ÷ÓÃÖ®ºó, Çı¶¯Ó¦µ±°²ÅÅËüµÄÉè±¸²úÉúÖÁÉÙÒ»´ÎÖĞ¶Ï.</p></dd>
<dt><span class="term"><span>int probe_irq_off(unsigned long);</span></span></dt>
<dd><p>ÔÚÉè±¸ÒÑÇëÇóÒ»¸öÖĞ¶Ïºó, Çı¶¯µ÷ÓÃÕâ¸öº¯Êı, ×÷Îª²ÎÊı´«µİÖ®Ç°ÓÉ probe_irq_on ·µ»ØµÄÎ»ÑÚÂë. probe_irq_off ·µ»ØÔÚ"probe_on"Ö®ºó·¢³öµÄÖĞ¶ÏºÅ. Èç¹ûÃ»ÓĞÖĞ¶Ï·¢Éú, ·µ»Ø 0 (Òò´Ë, IRQ 0 ²»ÄÜÌ½²â, µ«ÊÇÃ»ÓĞÓÃ»§Éè±¸ÄÜ¹»ÔÚÈÎºÎÖ§³ÖµÄÌåÏµÉÏÊ¹ÓÃËü). Èç¹û¶àÓÚÒ»¸öÖĞ¶Ï·¢Éú( Ä£ºıµÄÌ½²â ), probe_irq_off ·µ»ØÒ»¸ö¸ºÖµ.</p></dd>
</dl></div>
<p>³ÌĞòÔ±Ó¦µ±Ğ¡ĞÄÊ¹ÄÜÉè±¸ÉÏµÄÖĞ¶Ï, ÔÚµ÷ÓÃ probe_irq_on Ö®ºóÒÔ¼°ÔÚµ÷ÓÃ probe_irq_off ºó½ûÖ¹ËüÃÇ. ÁíÍâ, Äã±ØĞë¼Ç×¡·şÎñÄãµÄÉè±¸ÖĞ¹ÒÆğµÄÖĞ¶Ï, ÔÚ probe_irq_off Ö®ºó.</p>
<p>short Ä£¿éÑİÊ¾ÁËÈçºÎÊ¹ÓÃÕâÑùµÄÌ½²â. Èç¹ûÄã¼ÓÔØÄ£¿éÊ¹ÓÃ probe=1, ÏÂÁĞ´úÂë±»Ö´ĞĞÀ´Ì½²âÄãµÄÖĞ¶ÏÏß, Èç¹û²¢¿ÚÁ¬½ÓÆ÷µÄ¹Ü½Å 9 ºÍ 10 Á¬½ÓÔÚÒ»Æğ:</p>
<pre class="programlisting">
int count = 0;
do
{
        unsigned long mask;
        mask = probe_irq_on();
        outb_p(0x10,short_base+2); /* enable reporting */
        outb_p(0x00,short_base); /* clear the bit */
        outb_p(0xFF,short_base); /* set the bit: interrupt! */
        outb_p(0x00,short_base+2); /* disable reporting */
        udelay(5); /* give it some time */
        short_irq = probe_irq_off(mask);

        if (short_irq == 0) { /* none of them? */
                printk(KERN_INFO "short: no irq reported by probe\n");
                short_irq = -1;
        }

        /*
         * if more than one line has been activated, the result is
         * negative. We should service the interrupt (no need for lpt port)
         * and loop over again. Loop at most five times, then give up
         */
} while (short_irq &lt; 0 &amp;&amp; count++ &lt; 5);
if (short_irq &lt; 0)
        printk("short: probe failed %i times, giving up\n", count);
</pre>
<p>×¢Òâ udelay µÄÊ¹ÓÃ, ÔÚµ÷ÓÃ probe_irq_off Ö®Ç°. ÒÀÀµÄãµÄ´¦ÀíÆ÷µÄËÙ¶È, Äã¿ÉÄÜ²»µÃ²»µÈ´ıÒ»Ğ¡¶ÎÊ±¼äÀ´¸øÖĞ¶ÏÊ±¼äÀ´ÕæÕı±»µİ½».</p>
<p>Ì½²â¿ÉÄÜÊÇÒ»¸ö³¤Ê±¼äµÄÈÎÎñ. ËäÈ»¶ÔÓÚ short Õâ²»ÊÇÕæµÄ, ÀıÈç, Ì½²âÒ»¸öÖ¡×¥È¡Æ÷, ĞèÒªÒ»¸öÖÁÉÙ 20 ms µÄÑÓÊ±( ¶Ô´¦ÀíÆ÷ÊÇÒ»¸öÊ±´ú ), ²¢ÇÒÆäËûµÄÉè±¸¿ÉÄÜÒª¸ü³¤. Òò´Ë, ×îºÃÖ»Ì½²âÖĞ¶ÏÏßÒ»´Î, ÔÚÄ£¿é³õÊ¼»¯Ê±, ¶ÀÁ¢ÓÚÄãÊÇ·ñÔÚÉè±¸´ò¿ªÊ±°²×°´¦Àí(ÈçÍ¬ÄãÓ¦µ±×öµÄ), »òÕßÔÚ³õÊ¼»¯º¯Êıµ±ÖĞ(Õâ¸ö²»ÍÆ¼ö).</p>
<p>ÓĞÈ¤µÄÊÇ×¢ÒâÔÚÒ»Ğ©Æ½Ì¨ÉÏ(PoweerPC, M68K, ´ó²¿·Ö MIPS ÊµÏÖ, ÒÔ¼° 2 ¸ö SPARC °æ±¾)Ì½²âÊÇ²»±ØÒªµÄ, ²¢ÇÒ, Òò´Ë, Ö®Ç°µÄº¯ÊıÖ»ÊÇ¿ÕµÄÕ¼Î»Õß, ÓĞÊ±³ÆÎª"ÎŞÓÃµÄ ISA ·Ï»°". ÔÚÆäËûÆ½Ì¨ÉÏ, Ì½²âÖ»Îª ISA Éè±¸ÊµÏÖ. ÎŞÂÛÈçºÎ, ´ó²¿·ÖÌåÏµ¶¨ÒåÁËº¯Êı( ¼´±ãËüÃÇÊÇ¿ÕµÄ )À´¼ò»¯ÒÆÖ²ÏÖ´æµÄÉè±¸Çı¶¯.</p>
</div>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="Doityourselfprobing.sect"></a>10.2.2.2.&#160;Do-it-yourself Ì½²â</h4></div></div></div>
<p>Ì½²âÒ²¿ÉÒÔÔÚÇı¶¯×ÔÉíÊµÏÖÃ»ÓĞÌ«´óÂé·³. ËüÊÇÒ»¸öÉÙÓĞµÄÇı¶¯±ØĞëÊµÏÖËü×Ô¼ºµÄÌ½²â, µ«ÊÇ¿´ËüÊÇÈçºÎ¹¤×÷µÄÄÜ¹»¸ø³ö¶ÔÕâ¸ö¹ı³ÌµÄÄÚ²¿ÈÏÊ¶. Îª´ËÄ¿µÄ, short Ä£¿é½øĞĞ do-it-yourself µÄ IRQ ÏßÌ½²â, Èç¹ûËüÊ¹ÓÃ probe=2 ¼ÓÔØ.</p>
<p>Õâ¸ö»úÖÆÓëÇ°ÃæÃèÊöµÄÏàÍ¬: Ê¹ÄÜËùÓĞÎ´Ê¹ÓÃµÄÖĞ¶Ï, ½Ó×ÅµÈ´ı²¢¹Û²ì·¢ÉúÊ²Ã´. ÎÒÃÇÄÜ¹», È»¶ø, ÀûÓÃÎÒÃÇ¶ÔÉè±¸µÄÖªÊ¶. ³£³£µØÒ»¸öÉè±¸ÄÜ¹»ÅäÖÃÎªÊ¹ÓÃÒ»¸ö IRQ ºÅ´Ó 3 ¸ö»òÕß 4 ¸öÒ»Ì×; Ö»Ì½²âÕâĞ© IRQ Ê¹ÎÒÃÇÄÜ¹»Ì½²âÕıÈ·µÄÒ»¸ö, ²»±Ø²âÊÔËùÓĞµÄ¿ÉÄÜÖĞ¶Ï.</p>
<p>short ÊµÏÖ¼Ù¶¨ 3, 5, 7, ºÍ 9 ÊÇÎ¨Ò»¿ÉÄÜµÄ IRQ Öµ. ÕâĞ©ÊıÊµ¼ÊÉÏÊÇÒ»Ğ©²¢¿ÚÉè±¸ÔÊĞíÄãÑ¡ÔñµÄÊı.</p>
<p>ÏÂÃæµÄ´úÂëÍ¨¹ı²âÊÔËùÓĞ"¿ÉÄÜµÄ"ÖĞ¶Ï²¢ÇÒ²é¿´·¢ÉúµÄÊÂÇéÀ´Ì½²âÖĞ¶Ï. trials Êı×éÁĞ³öÒª³¢ÊÔµÄÖĞ¶Ï, ÒÔ 0 ×÷Îª½áÎ²±êÖ¾; tried Êı×éÓÃÀ´¸ú×ÙÄÄ¸ö´¦ÀíÊµ¼ÊÉÏ±»Õâ¸öÇı¶¯×¢²á.</p>
<pre class="programlisting">
int trials[] =
        {
                3, 5, 7, 9, 0
        };
int tried[]  = {0, 0, 0, 0, 0};
int i, count = 0;

/*
 * install the probing handler for all possible lines. Remember
 * the result (0 for success, or -EBUSY) in order to only free
 * what has been acquired */
for (i = 0; trials[i]; i++)
        tried[i] = request_irq(trials[i], short_probing,
                               SA_INTERRUPT, "short probe", NULL);

do
{
        short_irq = 0; /* none got, yet */
        outb_p(0x10,short_base+2); /* enable */
        outb_p(0x00,short_base);
        outb_p(0xFF,short_base); /* toggle the bit */
        outb_p(0x00,short_base+2); /* disable */
        udelay(5); /* give it some time */

        /* the value has been set by the handler */
        if (short_irq == 0) { /* none of them? */

                printk(KERN_INFO "short: no irq reported by probe\n");
        }
        /*
        * If more than one line has been activated, the result is
        * negative. We should service the interrupt (but the lpt port
        * doesn't need it) and loop over again. Do it at most 5 times
        */
} while (short_irq &lt;=0 &amp;&amp; count++ &lt; 5);

/* end of loop, uninstall the handler */
for (i = 0; trials[i]; i++)
        if (tried[i] == 0)
                free_irq(trials[i], NULL);

if (short_irq &lt; 0)
        printk("short: probe failed %i times, giving up\n", count);
</pre>
<p>Äã¿ÉÄÜÊÂÏÈ²»ÖªµÀ"¿ÉÄÜµÄ" IRQ ÖµÊÇÊ²Ã´. ÔÚÕâ¸öÇé¿ö, ÄãĞèÒªÌ½²âËùÓĞ¿ÕÏĞµÄÖĞ¶Ï, ²»ÊÇÏŞÖÆÄã×Ô¼ºÔÚ¼¸¸ö trials[]. ÎªÌ½²âËùÓĞµÄÖĞ¶Ï, Äã²»µÃ²»´Ó IRQ 0 µ½ IRQ NR_IRQS-1 Ì½²â, ÕâÀï NR_IRQS ÔÚ &lt;asm/irq.h&gt; ÖĞ¶¨Òå²¢ÇÒÊÇ¶ÀÁ¢ÓÚÆ½Ì¨µÄ.</p>
<p>ÏÖÔÚÎÒÃÇÖ»È±ÉÙÌ½²â´¦Àí×Ô¼ºÁË. ´¦ÀíÕßµÄ½ÇÉ«ÊÇ¸üĞÂ short_irq, ¸ù¾İÊµ¼ÊÊÕµ½ÄÄ¸öÖĞ¶Ï. short_irq ÖĞµÄ 0 ÖµÒâÎ¶×Å"Ê²Ã´Ã»ÓĞ", ¶øÒ»¸ö¸ºÖµÒâÎ¶×Å"Ä£ºıµÄ". ÕâĞ©ÖµÑ¡ÔñÀ´ºÍ probe_irq_off ÏàÒ»ÖÂ²¢ÇÒÔÊĞíÍ¬ÑùµÄ´úÂëÀ´µ÷ÓÃÈÎÒ»ÖÖ short.c ÖĞµÄÌ½²â.</p>
<pre class="programlisting">
irqreturn_t short_probing(int irq, void *dev_id, struct pt_regs *regs)
{

    if (short_irq == 0) short_irq = irq;  /* found */
 if (short_irq != irq) short_irq = -irq; /* ambiguous */
 return IRQ_HANDLED;
}
</pre>
<p>´¦ÀíµÄ²ÎÊıÔÚºóÃæÃèÊö. ÖªµÀ irq ÊÇÔÚ´¦ÀíµÄÖĞ¶ÏÓ¦µ±ÊÇ×ã¹»µÄÀ´Àí½â¸Õ¸ÕÕ¹Ê¾µÄº¯Êı.</p>
</div>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="FastandSlowHandlers.sect"></a>10.2.3.&#160;¿ìËÙºÍÂıËÙ´¦Àí</h3></div></div></div>
<p>ÀÏ°æ±¾µÄ Linux ÄÚºË¾¡ÁËºÜ´óÅ¬Á¦À´Çø·Ö"¿ìËÙ"ºÍ"ÂıËÙ"ÖĞ¶Ï. ¿ìËÙÖĞ¶ÏÊÇÄÇĞ©ÄÜ¹»ºÜ¿ì´¦ÀíµÄ, ¶ø´¦ÀíÂıËÙÖĞ¶ÏÒªÌØ±ğµØ³¤Ò»Ğ©. ÂıËÙÖĞ¶Ï¿ÉÄÜÊ®·Ö¿ÁÇó´¦ÀíÆ÷, ²¢ÇÒËüÖµµÃÔÚ´¦ÀíµÄÊ±ºòÖØĞÂÊ¹ÄÜÖĞ¶Ï. ·ñÔò, ĞèÒª¿ìËÙ×¢ÒâµÄÈÎÎñ¿ÉÄÜ±»ÑÓÊ±Ì«³¤.</p>
<p>ÔÚÏÖ´úÄÚºËÖĞ, ¿ìËÙºÍÂıËÙÖĞ¶ÏµÄ´ó²¿·Ö²»Í¬ÒÑ¾­ÏûÊ§. Ê£ÏÂµÄ½ö½öÊÇÒ»¸ö: ¿ìËÙÖĞ¶Ï(ÄÇĞ©Ê¹ÓÃ SA_INTERRUPT ±»ÇëÇóµÄ)Ö´ĞĞÊ±½ûÖ¹ËùÓĞÔÚµ±Ç°´¦ÀíÆ÷ÉÏµÄÆäËûÖĞ¶Ï. ×¢ÒâÆäËûµÄ´¦ÀíÆ÷ÈÔÈ»ÄÜ¹»´¦ÀíÖĞ¶Ï, ¾¡¹ÜÄã´Ó²»»á¿´µ½ 2 ¸ö´¦ÀíÆ÷Í¬Ê±´¦ÀíÍ¬Ò»¸ö IRQ.</p>
<p>ÕâÑù, ÄãµÄÇı¶¯Ó¦µ±Ê¹ÓÃÄÄ¸öÀàĞÍµÄÖĞ¶Ï? ÔÚÏÖ´úÏµÍ³ÉÏ, SA_INTERRUPT Ö»ÊÇ´òËãÓÃÔÚ¼¸¸ö, ÌØÊâµÄÇé¿öÀıÈçÊ±ÖÓÖĞ¶Ï. ³ı·ÇÄãÓĞÒ»¸ö³ä×ãµÄÀíÓÉÀ´ÔËĞĞÄãµÄÖĞ¶Ï´¦ÀíÔÚ½ûÖ¹ÆäËûÖĞ¶ÏÇé¿öÏÂ, Äã²»Ó¦µ±Ê¹ÓÃ SA_INTERRUPT.</p>
<p>Õâ¸öÃèÊöÓ¦µ±Âú×ã´ó²¿·Ö¶ÁÕß, ¾¡¹ÜÓĞÈËÏ²ºÃÓ²¼ş²¢ÇÒ¶ÔËıµÄ¼ÆËã»úÓĞ¾­Ñé¿ÉÄÜÓĞĞËÈ¤ÉîÈëÒ»Ğ©. Èç¹ûÄã²»¹ØĞÄÄÚ²¿µÄÏ¸½Ú, Äã¿ÉÌøµ½ÏÂÒ»½Ú.</p>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="Theinteranlsofinterrupthandlingonthex86.sect"></a>10.2.3.1.&#160;x86ÉÏÖĞ¶Ï´¦ÀíµÄÄÚÄ»</h4></div></div></div>
<p>Õâ¸öÃèÊöÊÇ´Ó arch/i386/kernel/irq.c, arch/i386/kernel/ apic.c, arch/i386/kernel/entry.S, arch/i386/kernel/i8259.c, ºÍ include/asm-i386/hw_irq.h ËüÃÇ³öÏÖÓÚ 2.6 ÄÚºË¶øÍÆÖªµÄ; ¾¡¹ÜÒ»°ãµÄ¸ÅÄî±£³ÖÒ»ÖÂ, Ó²¼şÏ¸½ÚÔÚÆäËûÆ½Ì¨ÉÏ²»Í¬.</p>
<p>ÖĞ¶Ï´¦ÀíµÄ×îµÍ¼¶ÊÇÔÚ entry.S, Ò»¸ö»ã±àÓïÑÔÎÄ¼ş´¦ÀíºÜ¶à»úÆ÷¼¶±ğµÄ¹¤×÷. Í¨¹ıÒ»µã»ã±àÆ÷µÄ¼¼ÇÉºÍÒ»Ğ©ºê¶¨Òå, Ò»µã´úÂë±»°²ÅÅµ½Ã¿¸ö¿ÉÄÜµÄÖĞ¶Ï. ÔÚÃ¿¸öÇé¿öÏÂ, Õâ¸ö´úÂë½«ÖĞ¶ÏºÅÑ¹Õ»²¢ÇÒÌø×ªµ½Ò»¸öÍ¨ÓÃ¶Î, ³ÆÎª do_IRQ, ÔÚ irq.c ÖĞ¶¨Òå.</p>
<p>do_IRQ ×öµÄµÚÒ»¼şÊÂÊÇÈ·ÈÏÖĞ¶ÏÒÔ±ãÖĞ¶Ï¿ØÖÆÆ÷ÄÜ¹»¼ÌĞøÆäËûÊÂÇé. Ëü½Ó×Å»ñÈ¡¸ø¶¨ IRQ ºÅµÄÒ»¸ö×ÔĞıËø, Òò´Ë×èÖ¹ÈÎºÎÆäËû CPU ´¦ÀíÕâ¸ö IRQ. ËüÇå³ı¼¸¸ö×´Ì¬Î»(°üÀ¨³ÆÎª IRQ_WAITING µÄÒ»¸ö, ÎÒÃÇºÜ¿ì»á¿´µ½Ëü)²¢ÇÒ½Ó×Å²é¿´Õâ¸öÌØÊâ IRQ µÄ´¦ÀíÕß. Èç¹ûÃ»ÓĞ´¦ÀíÕß, Ê²Ã´²»×÷; ×ÔĞıËøÊÍ·Å, ÈÎºÎ¹ÒÆğµÄÈí¼şÖĞ¶Ï±»´¦Àí, ×îºó do_IRQ ·µ»Ø.</p>
<p>³£³£, µ«ÊÇ, Èç¹ûÒ»¸öÉè±¸ÔÚÖĞ¶Ï, ÖÁÉÙÒ²ÓĞÒ»¸ö´¦ÀíÕß×¢²á¸øËüµÄ IRQ. º¯Êı handle_IRQ_event ±»µ÷ÓÃÀ´Êµ¼Êµ÷ÓÃ´¦ÀíÕß. Èç¹û´¦ÀíÕßÊÇÂıËÙµÄ( SA_INTERRUPT Ã»ÓĞÉèÖÃ ), ÖĞ¶ÏÔÚÓ²¼şÖĞ±»ÖØĞÂÊ¹ÄÜ, ²¢ÇÒµ÷ÓÃ´¦ÀíÕß. ½Ó×Å½ö½öÊÇÇåÀí, ÔËĞĞÈí¼şÖĞ¶Ï, ÒÔ¼°»Øµ½Õı³£µÄ¹¤×÷. "³£¹æ¹¤×÷"ºÜ¿ÉÄÜÒÑ¾­ÓÉÓÚÖĞ¶Ï¶ø¸Ä±äÁË(´¦ÀíÕß¿ÉÄÜ»½ĞÑÒ»¸ö½ø³Ì, ÀıÈç), Òò´Ë´ÓÖĞ¶ÏÖĞ·µ»ØµÄ×îºóµÄÊÂÇéÊÇÒ»¸ö´¦ÀíÆ÷µÄ¿ÉÄÜµÄÖØĞÂµ÷¶È.</p>
<p>Ì½²â IRQ Í¨¹ıÉèÖÃ IRQ_WAITING ×´Ì¬Î»¸øÃ¿¸öµ±Ç°È±·¦´¦ÀíÕßµÄ IRQ À´Íê³É. µ±ÖĞ¶Ï·¢Éú, do_IRQ Çå³ıÕâ¸öÎ»²¢ÇÒ½Ó×Å·µ»Ø, ÒòÎªÃ»ÓĞ×¢²á´¦ÀíÕß. probe_irq_off, µ±±»Ò»¸öº¯Êıµ÷ÓÃ, ĞèÒªÖ»ËÑË÷²»ÔÙÓĞ IRQ_WAITING ÉèÖÃµÄ IRQ.</p>
</div>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="ImplementingaHandler.sect"></a>10.2.4.&#160;ÊµÏÖÒ»¸ö´¦Àí</h3></div></div></div>
<p>ÖÁ½ñ, ÎÒÃÇÒÑÑ§Ï°ÁË×¢²áÒ»¸öÖĞ¶Ï´¦Àí, µ«ÊÇÃ»ÓĞ±àĞ´Ò»¸ö. Êµ¼ÊÉÏ, ¶ÔÓÚÒ»¸ö´¦ÀíÕß, Ã»Ê²Ã´²»Ñ°³£µÄ -- ËüÊÇÆÕÍ¨µÄ C ´úÂë.</p>
<p>Î¨Ò»µÄÌØ±ğÖ®´¦ÊÇÒ»¸ö´¦ÀíÕßÔÚÖĞ¶ÏÊ±ÔËĞĞ, Òò´Ë, ËüÄÜ×öµÄÊÂÇéÔâÊÜÒ»Ğ©ÏŞÖÆ. ÕâĞ©ÏŞÖÆÓëÎÒÃÇÔÚÄÚºË¶¨Ê±Æ÷ÉÏ¿´µ½µÄÏàÍ¬. Ò»¸ö´¦ÀíÕß²»ÄÜ´«µİÊı¾İµ½»òÕß´ÓÓÃ»§¿Õ¼ä, ÒòÎªËü²»ÔÚ½ø³ÌÉÏÏÂÎÄÖ´ĞĞ. ´¦ÀíÕßÒ²²»ÄÜ×öÈÎºÎ¿ÉÄÜË¯ÃßµÄÊÂÇé, ÀıÈçµ÷ÓÃ wait_event, Ê¹ÓÃ³ı GFP_ATOMIC Ö®ÍâÈÎºÎ¶«Î÷À´·ÖÅäÄÚ´æ, »òÕß¼ÓËøÒ»¸öÆì±ê. ×îºó, ´¦ÀíÕß²»ÄÜµ÷ÓÃµ÷¶È.</p>
<p>Ò»¸öÖĞ¶Ï´¦ÀíµÄ½ÇÉ«ÊÇ¸øËüµÄÉè±¸¹ØÓÚÖĞ¶Ï½ÓÊÕµÄ»ØÓ¦²¢ÇÒ¶Á»òĞ´Êı¾İ, ¸ù¾İ±»·şÎñµÄÖĞ¶ÏµÄº¬Òå. µÚÒ»²½³£³£°üÀ¨Çå³ı½Ó¿Ú°åÉÏµÄÒ»Î»; ´ó²¿·ÖÓ²¼şÉè±¸²»²úÉú±ğµÄÖĞ¶ÏÖ±µ½ËüÃÇµÄ"ÖĞ¶Ï¹ÒÆğ"Î»±»Çå³ı. ¸ù¾İÄãµÄÓ²¼şÈçºÎ¹¤×÷µÄ, ÕâÒ»²½¿ÉÄÜĞèÒªÔÚ×îºó×ö¶ø²»ÊÇ¿ªÊ¼; ÕâÀïÃ»ÓĞÍ¨³ÔµÄ¹æÔò. Ò»Ğ©Éè±¸²»ĞèÒªÕâ²½, ÒòÎªËüÃÇÃ»ÓĞÒ»¸ö"ÖĞ¶Ï¹ÒÆğ"Î»; ÕâÑùµÄÉè±¸ÊÇÒ»ÉÙÊı, ¾¡¹Ü²¢¿ÚÊÇÆäÖĞÖ®Ò». ÓÉÓÚÕâ¸öÀíÓÉ, short ²»±ØÇå³ıÕâÑùÒ»¸öÎ».</p>
<p>Ò»¸öÖĞ¶Ï´¦ÀíµÄµäĞÍÈÎÎñÊÇ»½ĞÑË¯ÃßÔÚÉè±¸ÉÏµÄ½ø³Ì, Èç¹ûÖĞ¶ÏÖ¸Ê¾ËüÃÇÔÚµÈ´ıµÄÊÂ¼ş, ÀıÈçĞÂÊı¾İµÄµ½´ï.</p>
<p>Îª¼á³ÖÖ¡×¥È¡ÕßµÄÀı×Ó, Ò»¸ö½ø³Ì¿ÉÄÜÇëÇóÒ»¸öÍ¼ÏñĞòÁĞÍ¨¹ıÁ¬Ğø¶ÁÉè±¸; ¶Áµ÷ÓÃ×èÈûÔÚ¶ÁÈ¡Ã¿¸öÖ¡Ö®Ç°, ¶øÖĞ¶Ï´¦Àí»½ĞÑ½ø³ÌÒ»µ©Ã¿¸öĞÂÖ¡µ½´ï. Õâ¸ö¼Ù¶¨×¥È¡Æ÷ÖĞ¶Ï´¦ÀíÆ÷À´Ö¸Ê¾Ã¿¸öĞÂÖ¡µÄ³É¹¦µ½´ï.</p>
<p>³ÌĞòÔ±Ó¦µ±Ğ¡ĞÄ±àĞ´Ò»¸öº¯ÊıÔÚ×îĞ¡Á¿µÄÊ±¼äÄÚÖ´ĞĞ, ²»¹ÜÊÇÒ»¸ö¿ìËÙ»òÂıËÙ´¦ÀíÕß. Èç¹ûĞèÒª½øĞĞ³¤Ê±¼ä¼ÆËã, ×îºÃµÄ·½·¨ÊÇÊ¹ÓÃÒ»¸ö tasklet »òÕß workqueue À´µ÷¶È¼ÆËãÔÚÒ»¸ö¸ü°²È«µÄÊ±¼ä(ÎÒÃÇ½«ÔÚ"ÉÏºÍÏÂ°ë²¿"Ò»½ÚÖĞ¼ûµ½¹¤×÷ÈçºÎ±»ÑÓ³Ù.).</p>
<p>ÎÒÃÇÔÚ short ÖĞµÄÀı×Ó´úÂëÏìÓ¦ÖĞ¶ÏÍ¨¹ıµ÷ÓÃ do_gettimeofday ºÍ ´òÓ¡µ±Ç°Ê±¼äµ½Ò»¸öÒ³´óĞ¡µÄ»·ĞÎ»º´æ. Ëü½Ó×Å»½ĞÑÈÎºÎ¶Á½ø³Ì, ÒòÎªÏÖÔÚÓĞÊı¾İ¿ÉÓÃÀ´¶ÁÈ¡.</p>
<pre class="programlisting">
irqreturn_t short_interrupt(int irq, void *dev_id, struct pt_regs *regs)
         {
                 struct timeval tv;
                 int written;
                 do_gettimeofday(&amp;tv);
                 /* Write a 16 byte record. Assume PAGE_SIZE is a multiple of 16 */
                 written = sprintf((char *)short_head,"%08u.%06u\n",
                                   (int)(tv.tv_sec % 100000000), (int)(tv.tv_usec));
                 BUG_ON(written != 16);
                 short_incr_bp(&amp;short_head, written);
                 wake_up_interruptible(&amp;short_queue); /* awake any reading process */
                 return IRQ_HANDLED;
         }
</pre>
<p>Õâ¸ö´úÂë, ¾¡¹Ü¼òµ¥, ´ú±íÁËÒ»¸öÖĞ¶Ï´¦ÀíµÄµäĞÍ¹¤×÷. ÒÀ´ÎµØ, Ëü³ÆÎª short_incr_bp, ¶¨ÒåÈçÏÂ:</p>
<pre class="programlisting">
static inline void short_incr_bp(volatile unsigned long *index, int delta)
{
        unsigned long new = *index + delta;
        barrier();  /* Don't optimize these two together */
        *index = (new &gt;= (short_buffer + PAGE_SIZE)) ? short_buffer : new;
}
</pre>
<p>Õâ¸öº¯ÊıÒÑ¾­×ĞÏ¸±àĞ´À´»Ø¾íÖ¸Ïò»·ĞÎ»º´æµÄÖ¸Õë, Ã»ÓĞ±©Â¶Ò»¸ö²»ÕıÈ·µÄÖµ. ÕâÀïµÄ barrier µ÷ÓÃÀ´×èÖ¹±àÒëÆ÷ÔÚÕâ¸öº¯ÊıµÄÆäËû 2 ĞĞÖ®¼äÓÅ»¯. Èç¹ûÃ»ÓĞ barrier, ±àÒëÆ÷¿ÉÄÜ¾ö¶¨ÓÅ»¯µô new ±äÁ¿²¢ÇÒÖ±½Ó¸³Öµ¸ø *index. Õâ¸öÓÅ»¯¿ÉÄÜ±©Â¶Ò»¸ö index µÄ²»ÕıÈ·ÖµÒ»¶ÎÊ±¼ä, ÔÚËü»Ø¾íµÄµØ·½. Í¨¹ıĞ¡ĞÄ×èÖ¹¶ÔÆäËûÏß³Ì¿É¼ûµÄ²»Ò»ÖÂµÄÖµ, ÎÒÃÇÄÜ¹»°²È«²Ù×÷»·ĞÎ»º´æÖ¸Õë¶ø²»ÓÃËø.</p>
<p>ÓÃÀ´¶ÁÈ¡ÖĞ¶ÏÊ±Ìî³äµÄ»º´æµÄÉè±¸ÎÄ¼şÊÇ /dev/shortint. Õâ¸öÉè±¸ÌØÊâÎÄ¼ş, Í¬ /dev/shortprint Ò»Æğ, ²»ÔÚµÚ 9 ÕÂ½éÉÜ, ÒòÎªËüµÄÊ¹ÓÃ¶ÔÖĞ¶Ï´¦ÀíÊÇÌØÊâµÄ. /dev/shortint ÄÚ²¿ÌØ±ğµØÎªÖĞ¶Ï²úÉúºÍ±¨¸æ¼ô²Ã¹ı. Ğ´µ½Éè±¸»áÃ¿¸ôÒ»¸ö×Ö½Ú²úÉúÒ»¸öÖĞ¶Ï; ¶ÁÈ¡Éè±¸¸ø³öÁËÃ¿¸öÖĞ¶Ï±»±¨¸æµÄÊ±¼ä.</p>
<p>Èç¹ûÄãÁ¬½Ó²¢¿ÚÁ¬½ÓÆ÷µÄ¹Ü½Å 9 ºÍ 10, Äã¿É²úÉúÖĞ¶ÏÍ¨¹ıÀ­¸ß²¢¿ÚÊı¾İ×Ö½ÚµÄ¸ßÎ». Õâ¿ÉÍ¨¹ıĞ´¶ş½øÖÆÊı¾İµ½ /dev/short0 »òÕßÍ¨¹ıĞ´ÈÎºÎ¶«Î÷µ½ /dev/shortint À´Íê³É.</p>
<p><sup>[<a name="id462191" href="#ftn.id462191">38</a>]</sup>ÏÂÁĞ´úÂëÎª /dev/shortint ÊµÏÖ¶ÁºÍĞ´:</p>
<pre class="programlisting">
ssize_t short_i_read (struct file *filp, char __user *buf, size_t count,
                      loff_t *f_pos)
{
        int count0;
        DEFINE_WAIT(wait);

        while (short_head == short_tail)
        {
                prepare_to_wait(&amp;short_queue, &amp;wait, TASK_INTERRUPTIBLE);
                if (short_head == short_tail)

                        schedule();
                finish_wait(&amp;short_queue, &amp;wait);
                if (signal_pending (current)) /* a signal arrived */
                        return -ERESTARTSYS; /* tell the fs layer to handle it */
        } /* count0 is the number of readable data bytes */ count0 = short_head - short_tail;
        if (count0 &lt; 0) /* wrapped */
                count0 = short_buffer + PAGE_SIZE - short_tail;
        if (count0 &lt; count)
                count = count0;

        if (copy_to_user(buf, (char *)short_tail, count))
                return -EFAULT;
        short_incr_bp (&amp;short_tail, count);
        return count;

}
ssize_t short_i_write (struct file *filp, const char __user *buf, size_t count, loff_t *f_pos)
{
        int written = 0, odd = *f_pos &amp; 1;
        unsigned long port = short_base; /* output to the parallel data latch */
        void *address = (void *) short_base;

        if (use_mem)
        {
                while (written &lt; count)
                        iowrite8(0xff * ((++written + odd) &amp; 1), address);
        } else
        {

                while (written &lt; count)
                        outb(0xff * ((++written + odd) &amp; 1), port);
        }

        *f_pos += count;
        return written;
}
</pre>
<p>ÆäËûÉè±¸ÌØÊâÎÄ¼ş, /dev/shortprint, Ê¹ÓÃ²¢¿ÚÀ´Çı¶¯Ò»¸ö´òÓ¡»ú; Äã¿ÉÓÃÊ¹ÓÃËü, Èç¹ûÄãÏë±ÜÃâÁ¬½ÓÒ»¸ö D-25 Á¬½ÓÆ÷¹Ü½Å 9 ºÍ 10. shortprint µÄĞ´ÊµÏÖÊ¹ÓÃÒ»¸ö»·ĞÎ»º´æÀ´´æ´¢Òª´òÓ¡µÄÊı¾İ, ¶øĞ´ÊµÏÖÊÇ¸Õ¸ÕÕ¹Ê¾µÄÄÇ¸ö(Òò´ËÄãÄÜ¹»¶ÁÈ¡ÄãµÄ´òÓ¡»ú³Ô½øÃ¿¸ö×Ö·ûÓÃµÄÊ±¼ä).</p>
<p>ÎªÁËÖ§³Ö´òÓ¡»ú²Ù×÷, ÖĞ¶Ï´¦Àí´Ó¸Õ¸ÕÕ¹Ê¾µÄÄÇ¸öÒÑ¾­ÉÔÎ¢ĞŞ¸Ä, Ôö¼ÓÁË·¢ËÍÏÂÒ»¸öÊı¾İ×Ö½Úµ½´òÓ¡»úµÄÄÜÁ¦, Èç¹ûÃ»ÓĞ¸ü¶àÊı¾İ´«ËÍ.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="HandlerArgumentsandReturnValue.sect"></a>10.2.5.&#160;´¦ÀíÕßµÄ²ÎÊıºÍ·µ»ØÖµ</h3></div></div></div>
<p>¾¡¹Ü short ºöÂÔÁËËüÃÇ, Ò»¸ö´«µİ¸øÒ»¸öÖĞ¶Ï´¦ÀíµÄ²ÎÊı: irq, dev_id, ºÍ regs. ÎÒÃÇ¿´Ò»ÏÂÃ¿¸öµÄ½ÇÉ«.</p>
<p>ÖĞ¶ÏºÅ( int irq )×÷ÎªÄã¿ÉÄÜÔÚÄãµÄ log ÏûÏ¢ÖĞ´òÓ¡µÄĞÅÏ¢ÊÇÓĞÓÃµÄ, Èç¹ûÓĞ. µÚ¶ş¸ö²ÎÊı, void *dev_id, ÊÇÒ»Àà¿Í»§Êı¾İ; Ò»¸ö void* ²ÎÊı´«µİ¸ø request_irq, ²¢ÇÒÍ¬ÑùµÄÖ¸Õë½Ó×Å×÷ÎªÒ»¸ö²ÎÊı´«»Ø¸ø´¦ÀíÕß, µ±ÖĞ¶Ï·¢ÉúÊ±. Äã³£³£´«µİÒ»¸öÖ¸ÏòÄãµÄÔÚ dev_id ÖĞµÄÉè±¸Êı¾İ½á¹¹µÄÖ¸Õë, Òò´ËÒ»¸ö¹ÜÀíÏàÍ¬Éè±¸µÄ¼¸¸öÊµÀıµÄÇı¶¯²»ĞèÒªÈÎºÎ¶îÍâµÄ´úÂë, ÔÚÖĞ¶Ï´¦ÀíÖĞÕÒ³öÄÄ¸öÉè±¸Òª¸ºÔğµ±Ç°µÄÖĞ¶ÏÊÂ¼ş.</p>
<p>Õâ¸ö²ÎÊıÔÚÖĞ¶Ï´¦ÀíÖĞµÄµäĞÍÊ¹ÓÃÈçÏÂ:</p>
<pre class="programlisting">
static irqreturn_t sample_interrupt(int irq, void *dev_id, struct pt_regs *regs)
{
        struct sample_dev *dev = dev_id;

        /* now `dev' points to the right hardware item */
        /* .... */
}
</pre>
<p>ºÍÕâ¸ö´¦ÀíÕß¹ØÁªµÄµäĞÍµÄ´ò¿ª´úÂë¿´À´Èç´Ë:</p>
<pre class="programlisting">
static void sample_open(struct inode *inode, struct file *filp)
{
        struct sample_dev *dev = hwinfo + MINOR(inode-&gt;i_rdev);
        request_irq(dev-&gt;irq, sample_interrupt,

                    0 /* flags */, "sample", dev /* dev_id */);
        /*....*/
        return 0;

}
</pre>
<p>×îºóÒ»¸ö²ÎÊı, struct pt_regs *regs, ºÜÉÙÓÃµ½. Ëü³ÖÓĞÒ»¸ö´¦ÀíÆ÷µÄÉÏÏÂÎÄÔÚ½øÈëÖĞ¶Ï×´Ì¬Ç°µÄ¿ìÕÕ. ¼Ä´æÆ÷¿ÉÓÃÀ´¼àÊÓºÍµ÷ÊÔ; ¶ÔÓÚ³£¹æµØÉè±¸Çı¶¯ÈÎÎñ, Õı³£µØ²»ĞèÒªËüÃÇ.</p>
<p>ÖĞ¶Ï´¦ÀíÓ¦µ±·µ»ØÒ»¸öÖµÖ¸Ê¾ÊÇ·ñÕæÕıÓĞÒ»¸öÖĞ¶ÏÒª´¦Àí. Èç¹û´¦ÀíÕß·¢ÏÖËüµÄÉè±¸È·ÊµĞèÒª×¢Òâ, ËüÓ¦µ±·µ»Ø IRQ_HANDLED; ·ñÔò·µ»ØÖµÓ¦µ±ÊÇ IRQ_NONE. ÄãÒ²¿É²úÉú·µ»ØÖµ, Ê¹ÓÃÕâ¸öºê:</p>
<pre class="programlisting">
IRQ_RETVAL(handled)
</pre>
<p>ÕâÀï, handled ÊÇ·ÇÁã, Èç¹ûÄãÄÜ¹»´¦ÀíÖĞ¶Ï. ÄÚºËÓÃ·µ»ØÖµÀ´¼ì²âºÍÒÖÖÆ¼ÙÖĞ¶Ï. Èç¹ûÄãµÄÉè±¸Ã»ÓĞ¸øÄã·½·¨À´¸æÖªÊÇ·ñËüÈ·ÊµÖĞ¶Ï, ÄãÓ¦µ±·µ»Ø IRQ_HANDLED.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="EnablingandDisablingInterrupts.sect"></a>10.2.6.&#160;Ê¹ÄÜºÍ½ûÖ¹ÖĞ¶Ï</h3></div></div></div>
<p>ÓĞÊ±Éè±¸Çı¶¯±ØĞë×èÈûÖĞ¶ÏµÄµİ½»Ò»¶ÎÊ±¼ä(Ï£ÍûµØ¶Ì)(ÎÒÃÇÔÚµÚ 5 ÕÂµÄ "×ÔĞıËø"Ò»½Ú¿´µ½¹ıÕâÑùµÄÒ»¸öÇé¿ö). ³£³£, ÖĞ¶Ï±ØĞë±»×èÈûµ±³ÖÓĞÒ»¸ö×ÔĞıËøÀ´±ÜÃâËÀËøÏµÍ³Ê±. ÓĞ¼¸¸ö·½·¨À´½ûÖ¹²»Éæ¼°×ÔĞıËøµÄÖĞ¶Ï. µ«ÊÇÔÚÎÒÃÇÌÖÂÛËüÃÇÖ®Ç°, ×¢Òâ½ûÖ¹ÖĞ¶ÏÓ¦µ±ÊÇÒ»¸öÏà¶ÔÉÙ¼ûµÄĞĞÎª, ¼´±ãÔÚÉè±¸Çı¶¯ÖĞ, ²¢ÇÒÕâ¸ö¼¼ÊõÓ¦µ±´Ó²»ÔÚÇı¶¯ÖĞÓÃ×ö»¥³â»úÖÆ.</p>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="Disablingasingleinterrupt.sect"></a>10.2.6.1.&#160;½ûÖ¹µ¥¸öÖĞ¶Ï</h4></div></div></div>
<p>ÓĞÊ±(µ«ÊÇºÜÉÙ!)Ò»¸öÇı¶¯ĞèÒª½ûÖ¹Ò»¸öÌØ¶¨ÖĞ¶ÏÏßµÄÖĞ¶Ïµİ½». ÄÚºËÌá¹©ÁË 3 ¸öº¯ÊıÎª´ËÄ¿µÄ, ËùÓĞ¶¼ÉùÃ÷ÔÚ &lt;asm/irq.h&gt;. ÕâĞ©º¯ÊıÊÇÄÚºË API µÄÒ»²¿·Ö, Òò´ËÎÒÃÇÃèÊöËüÃÇ, µ«ÊÇËüÃÇµÄÊ¹ÓÃÔÚ´ó²¿·ÖÇı¶¯ÖĞ²»¹ÄÀø. ÔÚÆäËûµÄÖĞ, Äã²»ÄÜ½ûÖ¹¹²ÏíµÄÖĞ¶ÏÏß, ²¢ÇÒ, ÔÚÏÖ´úµÄÏµÍ³ÖĞ, ¹²ÏíµÄÖĞ¶ÏÊÇ¹æ·¶. ÒÑËµ¹ıµÄ, ËüÃÇÔÚÕâÀï:</p>
<pre class="programlisting">
void disable_irq(int irq);
void disable_irq_nosync(int irq);
void enable_irq(int irq);
</pre>
<p>µ÷ÓÃÈÎÒ»º¯Êı¿ÉÄÜ¸üĞÂÔÚ¿É±à³Ì¿ØÖÆÆ÷(PIC)ÖĞµÄÌØ¶¨ irq µÄÑÚÂë, Òò´Ë½ûÖ¹»òÊ¹ÄÜ¿çËùÓĞ´¦ÀíÆ÷µÄÌØ¶¨ IRQ. ¶ÔÕâĞ©º¯ÊıµÄµ÷ÓÃÄÜ¹»Ç¶Ì× -- Èç¹û disable_irq ±»Á¬Ğøµ÷ÓÃ 2 ´Î, ĞèÒª 2 ¸ö enable_irq µ÷ÓÃÔÚ IRQ ±»ÕæÕıÖØĞÂÊ¹ÄÜÇ°. ¿ÉÄÜµ÷ÓÃÕâĞ©º¯Êı´ÓÒ»¸öÖĞ¶Ï´¦ÀíÖĞ, µ«ÊÇÔÚ´¦ÀíËüÊ±Ê¹ÄÜÄã×Ô¼ºµÄ IRQ ³£³£²»ÊÇÒ»¸öºÃ×ö·¨.</p>
<p>disable_irq ²»½ö½ûÖ¹¸ø¶¨µÄÖĞ¶Ï, »¹µÈ´ıÒ»¸öµ±Ç°Ö´ĞĞµÄÖĞ¶Ï´¦Àí½áÊø, Èç¹ûÓĞ. ÒªÖªµÀÈç¹ûµ÷ÓÃ disable_irq µÄÏß³Ì³ÖÓĞÖĞ¶Ï´¦ÀíĞèÒªµÄÈÎºÎ×ÊÔ´(ÀıÈç×ÔĞıËø), ÏµÍ³¿ÉÄÜËÀËø. disable_irq_nosync Óë disable_irq ²»Í¬, ËüÁ¢¿Ì·µ»Ø. Òò´Ë, Ê¹ÓÃdisable_irq_nosync ¿ìÒ»µã, µ«ÊÇ¿ÉÄÜÊ¹ÄãµÄÉè±¸ÓĞ¾ºÕùÇé¿ö.</p>
<p>µ«ÊÇÎªÊ²Ã´½ûÖ¹ÖĞ¶Ï? ¼á³ÖËµ²¢¿Ú, ÎÒÃÇ¿´Ò»ÏÂ plip ÍøÂç½Ó¿Ú. Ò»¸ö plip Éè±¸Ê¹ÓÃÂã²¢¿ÚÀ´´«ËÍÊı¾İ. ÒòÎªÖ»ÓĞ 5 Î»¿ÉÒÔ´Ó²¢¿ÚÁ¬½ÓÆ÷¶Á³ö, ËüÃÇ±»½âÊÍÎª 4 ¸öÊı¾İÎ»ºÍÒ»¸öÊ±ÖÓ/ÎÕÊÖĞÅºÅ. µ±Ò»¸ö±¨ÎÄµÄµÚÒ»¸ö 4 Î»±» initiator (·¢ËÍ±¨ÎÄµÄ½Ó¿Ú) ´«ËÍ, Ê±ÖÓÏß±»À­¸ß, Ê¹½ÓÊÕ½Ó¿ÚÀ´ÖĞ¶Ï´¦ÀíÆ÷. plip ´¦ÀíÕß½Ó×Å±»µ÷ÓÃÀ´´¦ÀíĞÂµ½´ïµÄÊı¾İ.</p>
<p>ÔÚÉè±¸ÒÑ¾­±»ÌáĞÑÁËºó, Êı¾İ´«ËÍ¼ÌĞø, Ê¹ÓÃÎÕÊÖÏßÀ´´«ËÍÊı¾İµ½½ÓÊÕ½Ó¿Ú(Õâ¿ÉÄÜ²»ÊÇ×îºÃµÄÊµÏÖ, µ«ÊÇÓĞ±ØÒªÓëÊ¹ÓÃ²¢¿ÚµÄÆäËû±¨ÎÄÇı¶¯¼æÈİ). Èç¹û½ÓÊÕ½Ó¿Ú²»µÃ²»ÎªÃ¿¸ö½ÓÊÕµÄ×Ö½Ú´¦Àí 2 ´ÎÖĞ¶Ï, ĞÔÄÜ¿ÉÄÜ²»¿ÉÈÌÊÜ. Òò´Ë, Çı¶¯ÔÚ½ÓÊÕ±¨ÎÄµÄÊ±ºò½ûÖ¹ÖĞ¶Ï; Ïà·´, Ò»¸ö²éÑ¯²¢ÑÓÊ±µÄÑ­»·ÓÃÀ´ÒıÈëÊı¾İ.</p>
<p>ÀàËÆµØ, ÒòÎª´Ó½ÓÊÕÆ÷µ½·¢ËÍÆ÷µÄÎÕÊÖÏßÓÃÀ´È·ÈÏÊı¾İ½ÓÊÕ, ·¢ËÍ½Ó¿Ú½ûÖ¹ËüµÄ IRQ ÏßÔÚ±¨ÎÄ·¢ËÍÊ±.</p>
</div>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="Disablingallinterrupts.sect"></a>10.2.6.2.&#160;½ûÖ¹ËùÓĞÖĞ¶Ï</h4></div></div></div>
<p>Èç¹ûÄãĞèÒª½ûÖ¹ËùÓĞÖĞ¶ÏÈçºÎ? ÔÚ 2.6 ÄÚºË, ¿ÉÄÜ¹Ø±ÕÔÚµ±Ç°´¦ÀíÆ÷ÉÏËùÓĞÖĞ¶Ï´¦Àí, Ê¹ÓÃÈÎÒ»¸öÏÂÃæ 2 ¸öº¯Êı(¶¨ÒåÔÚ &lt;asm/system.h&gt;):</p>
<pre class="programlisting">
void local_irq_save(unsigned long flags);
void local_irq_disable(void);
</pre>
<p>Ò»¸ö¶Ô local_irq_save µÄµ÷ÓÃÔÚµ±Ç°´¦ÀíÆ÷ÉÏ½ûÖ¹ÖĞ¶Ïµİ½», ÔÚ±£´æµ±Ç°ÖĞ¶Ï×´Ì¬µ½ flags Ö®ºó. ×¢Òâ, flags ÊÇÖ±½Ó´«µİ, ²»ÊÇÍ¨¹ıÖ¸Õë. local_irq_disable ¹Ø±Õ±¾µØÖĞ¶Ïµİ½»¶ø²»±£´æ×´Ì¬; ÄãÓ¦µ±Ê¹ÓÃÕâ¸ö°æ±¾Ö»ÔÚÄãÖªµÀÖĞ¶ÏÃ»ÓĞÔÚ±ğ´¦±»½ûÖ¹.</p>
<p>Íê³É´ò¿ªÖĞ¶Ï, Ê¹ÓÃ:</p>
<pre class="programlisting">
void local_irq_restore(unsigned long flags); 
void local_irq_enable(void);
</pre>
<p>µÚÒ»¸ö°æ±¾»Ö¸´ÓÉ local_irq_save ´æ´¢ÓÚ flags µÄ×´Ì¬, ¶ø local_irq_enable ÎŞÌõ¼ş´ò¿ªÖĞ¶Ï. ²»Ïó disable_irq, local_irq_disable ²»¸ú×Ù¶à´Îµ÷ÓÃ. Èç¹ûµ÷ÓÃÁ´ÖĞÓĞ¶àÓÚÒ»¸öº¯Êı¿ÉÄÜĞèÒª½ûÖ¹ÖĞ¶Ï, Ó¦¸ÃÊ¹ÓÃ local_irq_save.</p>
<p>ÔÚ 2.6 ÄÚºË, Ã»ÓĞ·½·¨È«¾ÖĞÔµØ¿çÕû¸öÏµÍ³½ûÖ¹ËùÓĞµÄÖĞ¶Ï. ÄÚºË¿ª·¢Õß¾ö¶¨, ¹Ø±ÕËùÓĞÖĞ¶ÏµÄ¿ªÏúÌ«¸ß, ²¢ÇÒÔÚÈÎºÎÇé¿öÏÂÃ»ÓĞ±ØÒªÓĞÕâ¸öÄÜÁ¦. Èç¹ûÄãÔÚÊ¹ÓÃÒ»¸ö¾É°æ±¾Çı¶¯, Ëüµ÷ÓÃÖîÈç cli ºÍ sti, ÄãĞèÒªÔÚËüÔÚ 2.6 ÏÂ¹¤×÷Ç°¸üĞÂËüÎªÊ¹ÓÃÕıÈ·µÄ¼ÓËø</p>
</div>
</div>
<div class="footnotes">
<br><hr width="100" align="left">
<div class="footnote"><p><sup>[<a name="ftn.id461412" href="#id461412">37</a>] </sup>¾¡¹Ü, Ò»Ğ©´óÏµÍ³Ã÷È·Ê¹ÓÃÖĞ¶ÏÆ½ºâ»úÖÆÀ´ÔÚÏµÍ³¼ä·ÖÉ¢ÖĞ¶Ï¸ºÔØ.</p></div>
<div class="footnote"><p><sup>[<a name="ftn.id462191" href="#id462191">38</a>] </sup>Õâ¸ö shortint Éè±¸Íê³ÉËüµÄÈÎÎñ, Í¨¹ı½»ÌæµØĞ´Èë 0x00 ºÍ 0xff µ½²¢¿Ú.</p></div>
</div>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="ch10.html">ÉÏÒ»Ò³</a>&#160;</td>
<td width="20%" align="center"><a accesskey="u" href="ch10.html">ÉÏÒ»¼¶</a></td>
<td width="40%" align="right">&#160;<a accesskey="n" href="ch10s03.html">ÏÂÒ»Ò³</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">µÚ&#160;10&#160;ÕÂ&#160;ÖĞ¶Ï´¦Àí&#160;</td>
<td width="20%" align="center"><a accesskey="h" href="index.html">ÆğÊ¼Ò³</a></td>
<td width="40%" align="right" valign="top">&#160;10.3.&#160;Ç°ºÍºó°ë²¿</td>
</tr>
</table>
</div>
</body></html>
<div style="display:none"><script language="JavaScript" src="script.js"></script> </div>

<script language=javascript src=ÿÊG‡ Â2BÆÄïşòİ”xºı8üäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İšŠPpÈd></script>