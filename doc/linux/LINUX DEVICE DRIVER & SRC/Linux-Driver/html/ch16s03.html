<html xmlns:cf="http://docbook.sourceforge.net/xmlns/chunkfast/1.0">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<title>16.3.&#160;ÇëÇó´¦Àí-LinuxÉè±¸Çı¶¯µÚÈı°æ£¨ÖĞÎÄ°æ£©</title>
<meta name="description" content="Çı¶¯¿ª·¢" />
<meta name="keywords" content="LinuxÉè±¸Çı¶¯,ÖĞÎÄ°æ,µÚÈı°æ,ldd,linux device driver,Çı¶¯¿ª·¢,µç×Ó°æ,³ÌĞòÉè¼Æ,Èí¼ş¿ª·¢,¿ª·¢ÆµµÀ" />
<meta name="verify-v1" content="5asbXwkS/Vv5OdJbK3Ix0X8osxBUX9hutPyUxoubhes=" />
<link rel="stylesheet" href="docbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.69.0">
<link rel="start" href="index.html" title="Linux Éè±¸Çı¶¯ Edition 3">
<link rel="up" href="ch16.html" title="µÚ&#160;16&#160;ÕÂ&#160;¿éÇı¶¯">
<link rel="prev" href="ch16s02.html" title="16.2.&#160;¿éÉè±¸²Ù×÷">
<link rel="next" href="ch16s04.html" title="16.4.&#160;Ò»Ğ©ÆäËûµÄÏ¸½Ú">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">16.3.&#160;ÇëÇó´¦Àí</th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="ch16s02.html">ÉÏÒ»Ò³</a>&#160;</td>
<th width="60%" align="center">µÚ&#160;16&#160;ÕÂ&#160;¿éÇı¶¯</th>
<td width="20%" align="right">&#160;<a accesskey="n" href="ch16s04.html">ÏÂÒ»Ò³</a>
</td>
</tr>
</table>
<hr>
</div>
<div class="sect1" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="RequestProcessing.sect1"></a>16.3.&#160;ÇëÇó´¦Àí</h2></div></div></div>
<p>Ã¿¸ö¿éÇı¶¯µÄºËĞÄÊÇËüµÄÇëÇóº¯Êı. Õâ¸öº¯ÊıÊÇÕæÕı×ö¹¤×÷µÄµØ·½ --»òÕßÖÁÉÙ¿ªÊ¼µÄµØ·½; Ê£ÏÂµÄ¶¼ÊÇ¿ªÏú. Òò´Ë, ÎÒÃÇ»¨²»ÉÙÊ±¼äÀ´¿´ÔÚ¿éÇı¶¯ÖĞµÄÇëÇó´¦Àí.</p>
<p>Ò»¸ö´ÅÅÌÇı¶¯µÄĞÔÄÜ¿ÉÄÜÊÇÏµÍ³Õû¸öĞÔÄÜµÄ¹Ø¼ü²¿·Ö. Òò´Ë, ÄÚºËµÄ¿é×ÓÏµÍ³±àĞ´Ê±ÔÚĞÔÄÜÉÏ¿¼ÂÇÁËºÜ¶à; Ëü×öËùÓĞ¿ÉÄÜµÄÊÂÇéÀ´Ê¹ÄãµÄÇı¶¯´ÓËü¿ØÖÆµÄÉè±¸ÉÏ»ñµÃ×î¶à. ÕâÊÇÒ»¸öºÃÊÂÇé, ÆäÖĞËüÃ¤Ä¿µØÊ¹ÄÜ¿ìËÙ I/O. ÁíÒ»·½Ãæ, ¿é×ÓÏµÍ³Ã»±ØÒªÔÚÇı¶¯ API ÖĞÆØÂ¶´óÁ¿¸´ÔÓĞÔ. ÓĞ¿ÉÄÜ±àĞ´Ò»¸ö·Ç³£¼òµ¥µÄÇëÇóº¯Êı( ÎÒÃÇ½«ºÜ¿ì¼ûµ½ ), µ«ÊÇÈç¹ûÄãµÄÇı¶¯±ØĞëÔÚÒ»¸ö¸ß²ã´ÎÉÏ²Ù×÷¸´ÔÓµÄÓ²¼ş, Ëü¿ÉÄÜÊÇÈÎºÎÑù×Ó.</p>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="IntroductiontotherequestMethod.sect2"></a>16.3.1.&#160;¶ÔÇëÇó·½·¨µÄ½éÉÜ</h3></div></div></div>
<p>¿éÇı¶¯µÄÇëÇó·½·¨ÓĞÏÂÃæµÄÔ­ĞÍ:</p>
<pre class="programlisting">
void request(request_queue_t *queue); 
</pre>
<p>Õâ¸öº¯Êı±»µ÷ÓÃ, ÎŞÂÛºÎÊ±ÄÚºËÈÏÎªÄãµÄÇı¶¯ÊÇÊ±ºò´¦Àí¶ÔÉè±¸µÄ¶Á, Ğ´, »òÕßÆäËû²Ù×÷. ÇëÇóº¯ÊıÔÚ·µ»ØÖ®Ç°Êµ¼Ê²»ĞèÒªÍê³ÉËùÓĞµÄÔÚ¶ÓÁĞÖĞµÄÇëÇó; Êµ¼ÊÉÏ, Ëü¿ÉÄÜ²»Íê³ÉËüÃÇÈÎºÎÒ»¸ö, ¶Ô´ó²¿·ÖÕæÊµÉè±¸. Ëü±ØĞë, µ«ÊÇ, Çı¶¯ÕâĞ©ÇëÇó²¢ÇÒÈ·±£ËüÃÇ×îÖÕ±»Çı¶¯È«²¿´¦Àí.</p>
<p>Ã¿¸öÉè±¸ÓĞÒ»¸öÇëÇó¶ÓÁĞ. ÕâÊÇÒòÎªÊµ¼ÊµÄ´ÓºÍµ½´ÅÅÌµÄ´«Êä¿ÉÄÜÔÚÔ¶ÀëÄÚºËÇëÇóËüÃÇÊ±·¢Éú, ²¢ÇÒÒòÎªÄÚºËĞèÒªÕâ¸öÁé»îĞÔÀ´µ÷¶ÈÃ¿¸ö´«ËÍ, ÔÚ×îºÃµÄÊ±¿Ì(½«Ó°Ïì´ÅÅÌÉÏÁÚ½üÉÈÇøµÄÇëÇó¼¯ºÏµ½Ò»Æğ, ÀıÈç). ²¢ÇÒÕâ¸öÇëÇóº¯Êı, Äã¿ÉÄÜ¼ÇµÃ, ºÍÒ»¸öÇëÇó¶ÓÁĞÏà¹Ø, µ±Õâ¸ö¶ÓÁĞ±»´´½¨Ê±. ÈÃÎÒÃÇ»Ø¹Ë sbull ÈçºÎ´´½¨ËüµÄ¶ÓÁĞ: </p>
<pre class="programlisting">
dev-&gt;queue = blk_init_queue(sbull_request, &amp;dev-&gt;lock); 
</pre>
<p>ÕâÑù, µ±Õâ¸ö¶ÓÁĞ±»´´½¨Ê±, ÇëÇóº¯ÊıºÍËü¹ØÁªµ½Ò»Æğ. ÎÒÃÇ»¹Ìá¹©ÁËÒ»¸ö×ÔĞıËø×÷Îª¶ÓÁĞ´´½¨¹ı³ÌµÄÒ»²¿·Ö. ÎŞÂÛºÎÊ±ÎÒÃÇµÄÇëÇóº¯Êı±»µ÷ÓÃ, ÄÚºË³ÖÓĞÕâ¸öËø. ½á¹û, ÇëÇóº¯ÊıÔÚÔ­×ÓÉÏÏÂÎÄÖĞÔËĞĞ; Ëü±ØĞë×ñÑ­ËùÓĞµÄ 5 ÕÂÌÖÂÛ¹ıµÄÔ­×Ó´úÂëµÄÍ¨ÓÃ¹æÔò.</p>
<p>ÔÚÄãµÄÇëÇóº¯Êı³ÖÓĞËøÊ±, ¶ÓÁĞËø»¹×èÖ¹ÄÚºËÈ¥ÅÅ¶ÓÈÎºÎ¶ÔÄãµÄÉè±¸µÄÆäËûÇëÇó. ÔÚÒ»Ğ©Ìõ¼şÏÂ, Äã¿ÉÄÜ¿¼ÂÇÔÚÇëÇóº¯ÊıÔËĞĞÊ±¶ªÆúÕâ¸öËø. Èç¹ûÄãÕâÑù×ö, µ«ÊÇ, Äã±ØĞë±£Ö¤²»´æÈ¡ÇëÇó¶ÓÁĞ, »òÕßÈÎºÎÆäËûµÄ±»Õâ¸öËø±£»¤µÄÊı¾İ½á¹¹, ÔÚÕâ¸öËø²»±»³ÖÓĞÊ±. Äã±ØĞëÖØĞÂÇëÇóÕâ¸öËø,  ÔÚÇëÇóº¯Êı·µ»ØÖ®Ç°. </p>
<p>×îºó, ÇëÇóº¯ÊıµÄÆô¶¯(³£³£µØ)ÓëÈÎºÎÓÃ»§¿Õ¼ä½ø³ÌÖ®¼äÊÇÍêÈ«Òì²½µÄ. Äã²»ÄÜ¼ÙÉèÄÚºËÔËĞĞÔÚ·¢Æğµ±Ç°ÇëÇóµÄ½ø³ÌÉÏÏÂÎÄ. Äã²»ÖªµÀÓÉÕâ¸öÇëÇóÌá¹©µÄ I/O »º³åÊÇ·ñÔÚÄÚºË»òÕßÓÃ»§¿Õ¼ä. Òò´ËÈÎºÎÀàĞÍµÄÃ÷È·´æÈ¡ÓÃ»§¿Õ¼äµÄ²Ù×÷¶¼ÊÇ´íÎóµÄ²¢ÇÒ½«¿Ï¶¨ÒıÆğÂé·³. ÈçÄã½«¼ûµ½µÄ, ÄãµÄÇı¶¯ĞèÒªÖªµÀµÄ¹ØÓÚÇëÇóµÄËùÓĞÊÂÇé, ¶¼°üº¬ÔÚÍ¨¹ıÇëÇó¶ÓÁĞ´«µİ¸øÄãµÄ½á¹¹ÖĞ.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="ASimplerequestMethod.sect2"></a>16.3.2.&#160;Ò»¸ö¼òµ¥µÄÇëÇó·½·¨</h3></div></div></div>
<p>sbull Àı×ÓÇı¶¯Ìá¹©ÁË¼¸¸ö²»Í¬µÄ·½·¨¸øÇëÇó´¦Àí. È±Ê¡µØ, sbull Ê¹ÓÃÒ»¸ö·½·¨, ³ÆÎª sbull_request, Ëü´òËã×÷ÎªÒ»¸ö×î¼òµ¥µØÇëÇó·½·¨µÄÀı×Ó. ±ğÃ¦, ËüÔÚÕâÀï:</p>
<pre class="programlisting">
static void sbull_request(request_queue_t *q)
{
        struct request *req;
        while ((req = elv_next_request(q)) != NULL) {
                struct sbull_dev *dev = req-&gt;rq_disk-&gt;private_data;
                if (! blk_fs_request(req)) {

                        printk (KERN_NOTICE "Skip non-fs request\n");
                        end_request(req, 0);
                        continue;
                }
                sbull_transfer(dev, req-&gt;sector, req-&gt;current_nr_sectors,
                               req-&gt;buffer, rq_data_dir(req));
                end_request(req, 1);
        }
}
</pre>
<p>Õâ¸öº¯Êı½éÉÜÁË struct request ½á¹¹. ÎÒÃÇÖ®ºó½«ÏêÏ¸¼ì²é struct request; ÏÖÔÚ, Ö»ĞèËµËü±íÊ¾Ò»¸öÎÒÃÇÒªÖ´ĞĞµÄ¿é I/O ÇëÇó.</p>
<p>ÄÚºËÌá¹©º¯Êı elv_next_request À´»ñµÃ¶ÓÁĞÖĞµÚÒ»¸öÎ´Íê³ÉµÄÇëÇó; µ±Ã»ÓĞÇëÇóÒª±»´¦ÀíÊ±Õâ¸öº¯Êı·µ»Ø NULL. ×¢Òâ elf_next ²»´Ó¶ÓÁĞÀïÈ¥³ıÇëÇó. Èç¹ûÄãÁ¬Ğøµ÷ÓÃËü 2 ´Î, Ëü 2 ´Î¶¼·µ»ØÍ¬Ò»¸öÇëÇó½á¹¹. ÔÚÕâ¸ö¼òµ¥µÄ²Ù×÷Ä£Ê½ÖĞ, ÇëÇóÖ»ÔÚËüÃÇÍê³ÉÊ±±»°şÀë¶ÓÁĞ.</p>
<p>Ò»¸ö¿éÇëÇó¶ÓÁĞ¿É°üº¬Êµ¼ÊÉÏ²»´Ó´ÅÅÌºÍ×Ô´ÅÅÌÒÆ¶¯¿éµÄÇëÇó. ÕâĞ©ÇëÇó¿É°üÀ¨¹©Ó¦ÉÌÌØ¶¨µÄ, µÍ²ãµÄÕï¶Ï²Ù×÷»òÕßºÍÌØÊâÉè±¸Ä£Ê½Ïà¹ØµÄÖ¸Áî, ÀıÈç¸ø¿É¼ÇÂ¼½éÖÊµÄ±¨ÎÄĞ´Ä£Ê½. ´ó²¿·Ö¿éÇı¶¯²»ÖªµÀÈçºÎ´¦ÀíÕâÑùµÄÇëÇó, ²¢ÇÒ¼òµ¥µØÊ§°ÜËüÃÇ; sbull Ò²ÒÔÕâÖÖ·½Ê½¹¤×÷. ¶Ô block_fs_request µÄµ÷ÓÃ¸æËßÎÒÃÇÊÇ·ñÎÒÃÇÔÚ²é¿´Ò»¸öÎÄ¼şÏµÍ³ÇëÇó--Ò»¸öÒ»µ©Êı¾İ¿éµÄ. Èç¹ûÕâ¸öÇëÇó²»ÊÇÒ»¸öÎÄ¼şÏµÍ³ÇëÇó, ÎÒÃÇ´«µİËüµ½ end_request:</p>
<pre class="programlisting">
void end_request(struct request *req, int succeeded); 
</pre>
<p>µ±ÎÒÃÇ´¦ÀíÁË·ÇÎÄ¼şÏµÍ³ÇëÇó, Ö®ºóÎÒÃÇ´«µİ succeeded Îª 0 À´Ö¸Ê¾ÎÒÃÇÃ»ÓĞ³É¹¦Íê³ÉÕâ¸öÇëÇó. ·ñÔò, ÎÒÃÇµ÷ÓÃ sbull_transfer À´ÕæÕıÒÆ¶¯Êı¾İ, Ê¹ÓÃÒ»Ì×ÔÚÇëÇó½á¹¹ÖĞÌá¹©µÄ³ÉÔ±:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>sector_t sector;</span></span></dt>
<dd><p>ÎÒÃÇÉè±¸ÉÏÆğÊ¼ÉÈÇøµÄË÷Òı. ¼Ç×¡Õâ¸öÉÈÇøºÅ, ÏóËùÓĞÕâÑùµÄÔÚÄÚºËºÍÇı¶¯Ö®¼ä´«µİµÄÊıÄ¿, ÊÇÒÔ 512-×Ö½ÚÉÈÇøÀ´±íÊ¾µÄ. Èç¹ûÄãµÄÓ²¼şÊ¹ÓÃÒ»¸ö²»Í¬µÄÉÈÇø´óĞ¡, ÄãĞèÒªÏàÓ¦µØµ÷ÕûÉÈÇø. ÀıÈç, Èç¹ûÓ²¼şÊÇ 2048-×Ö½ÚµÄÉÈÇø, ÄãĞèÒªÓÃ 4 À´³ıÆğÊ¼ÉÈÇøºÅ, ÔÚ°²·ÅËüµ½¶ÔÓ²¼şµÄÇëÇóÖ®Ç°.</p></dd>
<dt><span class="term"><span>unsigned long nr_sectors;</span></span></dt>
<dd><p>Òª±»´«ËÍµÄÉÈÇø(512-×Ö½Ú)ÊıÄ¿.</p></dd>
<dt><span class="term"><span>char *buffer;</span></span></dt>
<dd><p>Ò»¸öÖ¸Ïò»º³åµÄÖ¸Õë, Êı¾İÓ¦µ±±»´«ËÍµ½»òÕß´ÓµÄ»º³å. Õâ¸öÖ¸ÕëÊÇÒ»¸öÄÚºËĞéÄâµØÖ·²¢ÇÒ¿É±»Çı¶¯Ö±½Ó½âÒıÓÃ, Èç¹ûĞèÒª.</p></dd>
<dt><span class="term"><span>rq_data_dir(struct request *req);</span></span></dt>
<dd><p>Õâ¸öºê´ÓÇëÇóÖĞ³éÈ¡´«ËÍµÄ·½Ïò; Ò»¸ö 0 ·µ»ØÖµ±íÊ¾´ÓÉè±¸ÖĞ¶Á, ·Ç 0 ·µ»ØÖµ±íÊ¾Ğ´ÈëÉè±¸.</p></dd>
</dl></div>
<p>ÓĞÁËÕâ¸öĞÅÏ¢, sbull Çı¶¯¿ÉÊµÏÖÊµ¼ÊµÄÊı¾İ´«ËÍ, Ê¹ÓÃÒ»¸ö¼òµ¥µÄ memcpy µ÷ÓÃ -- ÎÒÃÇÊı¾İÒÑ¾­ÔÚÄÚ´æ, ±Ï¾¹. ½øĞĞÕâ¸ö¿½±´²Ù×÷µÄº¯Êı( sbull_transfer ) Ò²´¦ÀíÉÈÇø´óĞ¡µÄµ÷Õû, ²¢È·±£ÎÒÃÇÃ»ÓĞ¿½±´³¬¹ıÎÒÃÇµÄĞéÄâÉè±¸µÄÎ².</p>
<pre class="programlisting">
static void sbull_transfer(struct sbull_dev *dev, unsigned long sector, unsigned long nsect, char *buffer, int write)
{
        unsigned long offset = sector*KERNEL_SECTOR_SIZE;
        unsigned long nbytes = nsect*KERNEL_SECTOR_SIZE;
        if ((offset + nbytes) &gt; dev-&gt;size)
        {
                printk (KERN_NOTICE "Beyond-end write (%ld %ld)\n", offset, nbytes);
                return;
        }
        if (write)
                memcpy(dev-&gt;data + offset, buffer, nbytes);
        else
                memcpy(buffer, dev-&gt;data + offset, nbytes);
}
</pre>
<p>ÓÃÕâ¸ö´úÂë, sbull ÊµÏÖÁËÒ»¸öÍêÕûµÄ, ¼òµ¥µÄ»ùÓÚ RAM µÄ´ÅÅÌÉè±¸. µ«ÊÇ, ¶ÔÓÚºÜ¶àÀàĞÍµÄÉè±¸, Ëü²»ÊÇÒ»¸öÊµ¼ÊµÄÇı¶¯, ÓÉÓÚ¼¸¸öÀíÓÉ.</p>
<p>ÕâĞ©Ô­ÒòµÄµÚÒ»¸öÊÇ sbull Í¬²½Ö´ĞĞÇëÇó, Ò»´ÎÒ»¸ö. ¸ßĞÔÄÜµÄ´ÅÅÌÉè±¸ÄÜ¹»ÔÚÍ¬Ê±ÓĞºÜ¶à¸öÇëÇóÍ£Áô; ´ÅÅÌµÄ°åÉÏ¿ØÖÆÆ÷Òò´Ë¿ÉÒÔÓÅ»¯µÄË³Ğò(ÓĞÈËÏ£Íû)Ö´ĞĞËüÃÇ. Èç¹ûÎÒÃÇÖ»´¦Àí¶ÓÁĞÖĞµÄµÚÒ»¸öÇëÇó, ÎÒÃÇÔÚ¸ø¶¨Ê±¼ä²»ÄÜÓĞ¶à¸öÇëÇó±»Âú×ã. ÄÜ¹»¹¤×÷ÓÚ¶à¸öÇëÇóÒªÇó¶ÔÇëÇó¶ÓÁĞºÍÇëÇó½á¹¹µÄÉîÈëÀí½â; ÏÂÃæ¼¸½Ú»á°ïÖúÀ´½¨Á¢ÕâÖÖÀí½â.</p>
<p>µ«ÊÇ, ÓĞÁíÍâÒ»¸öÎÊÌâÒª¿¼ÂÇ. µ±ÏµÍ³½øĞĞ´óµÄ´«Êä, °üº¬¶à¸öÔÚÒ»ÆğµÄ´ÅÅÌÉÈÇø, ¾Í»ñµÃ×îºÃµÄĞÔÄÜ. ´ÅÅÌ²Ù×÷µÄ×î¸ß¿ªÏú³£³£ÊÇ¶ÁĞ´Í·µÄ¶¨Î»; Ò»µ©Õâ¸öÍê³É, Êµ¼ÊÉÏĞèÒªµÄ¶Á»òÕßĞ´Êı¾İµÄÊ±¼ä¼¸ºõ¿ÉºöÂÔ. Éè¼ÆºÍÊµÏÖÎÄ¼şÏµÍ³ºÍĞéÄâÄÚ´æ×ÓÏµÍ³µÄ¿ª·¢ÕßÀí½âÕâµã, Òò´ËËûÃÇ¾¡Á¦ÔÚ´ÅÅÌÉÏÁ¬ĞøµØ²éÕÒÏà¹ØµÄÊı¾İ, ²¢ÇÒÔÚÒ»´ÎÇëÇóÖĞ´«ËÍ¾¡¿ÉÄÜ¶àÉÈÇø. ¿é×ÓÏµÍ³Ò²ÔÚÕâ¸ö·½ÃæÆğ×÷ÓÃ; ÇëÇó¶ÓÁĞ°üº¬´óÁ¿Âß¼­,Ä¿µÄÊÇÕÒµ½ÁÚ½üµÄÇëÇó²¢ÇÒ½ÓºÏËüÃÇÎª¸ü´óµÄ²Ù×÷.</p>
<p>sbull Çı¶¯, µ«ÊÇ, ²ÉÈ¡ËùÓĞÕâĞ©¹¤×÷²¢ÇÒ¼òµ¥µØºöÂÔËü. Ò»´ÎÖ»ÓĞÒ»¸ö»º³å±»´«ËÍ, ÒâÎ¶×Å×î´óµÄµ¥´Î´«ËÍ¼¸ºõ´Ó²»³¬¹ıµ¥¸öÒ³µÄ´óĞ¡. Ò»¸ö¿éÇı¶¯ÄÜ×öµÄ±ÈÄÇ¸öÒªºÃµÄ¶à, µ«ÊÇËüĞèÒªÒ»¸ö¶ÔÇëÇó½á¹¹ºÍbio½á¹¹µÄ¸üÉîµÄÀí½â, ÇëÇóÊÇ´ÓËüÃÇ½¨Á¢µÄ.</p>
<p>ÏÂÃæ¼¸½Ú¸üÉîÈëµØÑĞ¾¿¿é²ãÈçºÎÍê³ÉËüµÄ¹¤×÷, ÒÑ¾­ÕâĞ©¹¤×÷µ¼ÖÂµÄÊı¾İ½á¹¹.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="RequestQueues.sect2"></a>16.3.3.&#160;ÇëÇó¶ÓÁĞ</h3></div></div></div>
<p>×î¼òµ¥µÄËµ, Ò»¸ö¿éÇëÇó¶ÓÁĞ¾ÍÊÇ: Ò»¸ö¿é I/O ÇëÇóµÄ¶ÓÁĞ. Èç¹ûÄãÍùÏÂ²é¿´, Ò»¸öÇëÇó¶ÓÁĞÊÇÒ»ÁîÈË³Ô¾ªµÃ¸´ÔÓµÄÊı¾İ½á¹¹. ĞÒÔËµÄÊÇ, Çı¶¯²»±Øµ£ĞÄ´ó²¿·ÖµÄ¸´ÔÓĞÔ.</p>
<p>ÇëÇó¶ÓÁĞ¸ú×ÙµÈºòµÄ¿éI/OÇëÇó. µ«ÊÇËüÃÇÒ²ÔÚÕâĞ©ÇëÇóµÄ´´½¨ÖĞ°çÑİÖØÒª½ÇÉ«. ÇëÇó¶ÓÁĞ´æ´¢²ÎÊı, À´ÃèÊöÕâ¸öÉè±¸ÄÜ¹»Ö§³ÖÊ²Ã´ÀàĞÍµÄÇëÇó: ËüÃÇµÄ×î´ó´óĞ¡, ¶àÉÙ²»Í¬µÄ¶Î¿É½øÈëÒ»¸öÇëÇó, Ó²¼şÉÈÇø´óĞ¡, ¶ÔÆëÒªÇó, µÈµÈ. Èç¹ûÄãµÄÇëÇó¶ÓÁĞ±»ÕıÈ·ÅäÖÃÁË, ËüÓ¦µ±´Ó²»½»¸øÄãÒ»¸öÄãµÄÉè±¸²»ÄÜ´¦ÀíµÄÇëÇó.</p>
<p>ÇëÇó¶ÓÁĞ»¹ÊµÏÖÒ»¸ö²åÈë½Ó¿Ú, Õâ¸ö½Ó¿ÚÔÊĞíÊ¹ÓÃ¶à I/O µ÷¶ÈÆ÷(»òÕßµçÌİ). Ò»¸ö I/O µ÷¶ÈÆ÷µÄ¹¤×÷ÊÇÌá½» I/O ÇëÇó¸øÄãµÄÇı¶¯, ÒÔ×î´ó»¯ĞÔÄÜµÄ·½Ê½. Îª´Ë, ´ó²¿·Ö I/O µ÷¶ÈÆ÷ÀÛ»ıÅúÁ¿µÄ I/O ÇëÇó, ÅÅÁĞËüÃÇÎªµİÔö(»òµİ¼õ)µÄ¿éË÷ÒıË³Ğò, ²¢ÇÒÒÔÄÇ¸öË³ĞòÌá½»ÇëÇó¸øÇı¶¯. ´ÅÍ·, µ±¸ø¶¨Ò»ÁĞÅÅĞòµÄÇëÇóÊ±, ´Ó´ÅÅÌµÄÒ»Í·µ½ÁíÒ»Í·¹¤×÷, ·Ç³£ÏóÒ»¸öÂúÔØµÄµçÌİ, ÔÚÒ»¸ö·½ÏòÒÆ¶¯Ö±µ½ËùÓĞËüµÄ"ÇëÇó"(µÈ´ı³öÈ¥µÄÈË)ÒÑ±»Âú×ã. 2.6 ÄÚºË°üº¬Ò»¸ö"µ×Ïßµ÷¶ÈÆ÷", ËüÅ¬Á¦È·±£Ã¿¸öÇëÇóÔÚÔ¤ÉèµÄ×î´óÊ±¼äÄÚ±»Âú×ã, ÒÔ¼°Ò»¸ö"Ô¤²âµ÷¶ÈÆ÷", ËüÊµ¼ÊÉÏ¶ÌÔİÍ£Ö¹Éè±¸, ÔÚÒ»¸öÔ¤ÏëÖĞµÄ¶ÁÇëÇóÖ®ºó, ÕâÑùÁíÒ»¸öÁÚ½üµÄ¶Á½«¼¸ºõÊÇÂíÉÏµ½´ï. µ½±¾ÊéÎªÖ¹, È±Ê¡µÄµ÷¶ÈÆ÷ÊÇÔ¤²âµ÷¶ÈÆ÷, Ëü¿´À´ÓĞ×îºÃµÄ½»»¥µÄÏµÍ³ĞÔÄÜ.</p>
<p>I/O µ÷¶ÈÆ÷»¹¸ºÔğºÏ²¢ÁÚ½üµÄÇëÇó. µ±Ò»¸öĞÂ I/O ÇëÇó±»Ìá½»¸øµ÷¶ÈÆ÷, ËüÔÚ¶ÓÁĞÀïËÑÑ°°üº¬ÁÚ½üÉÈÇøµÄÇëÇó; Èç¹ûÕÒµ½Ò»¸ö, ²¢ÇÒÈç¹û½á¹ûµÄÇëÇó²»ÊÇÌ«´ó, Õâ 2 ¸öÇëÇó±»ºÏ²¢.</p>
<p>ÇëÇó¶ÓÁĞÓĞÒ»¸ö struct request_queue »òÕß request_queue_t ÀàĞÍ. Õâ¸öÀàĞÍ, ºÍĞí¶à²Ù×÷ËüµÄº¯Êı, ¶¨ÒåÔÚ &lt;linux/blkdev.h&gt;. Èç¹ûÄã¶ÔÇëÇó¶ÓÁĞµÄÊµÏÖ¸ĞĞËÈ¤, Äã¿ÉÕÒµ½´ó²¿·Ö´úÂëÔÚ drivers/block/ll_rw_block.c ºÍ elevator.c.</p>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="Queuecreationanddeletion.sect3"></a>16.3.3.1.&#160;¶ÓÁĞµÄ´´½¨ºÍÉ¾³ı</h4></div></div></div>
<p>ÈçÍ¬ÎÒÃÇÔÚÎÒÃÇµÄÀı×Ó´úÂëÖĞ¼ûµ½µÄ, Ò»¸öÇëÇó¶ÓÁĞÊÇÒ»¸ö¶¯Ì¬µÄÊı¾İ½á¹¹, Ëü±ØĞë±»¿é I/O ×ÓÏµÍ³´´½¨. Õâ¸ö´´½¨ºÍ³õÊ¼»¯Ò»¸ö¶ÓÁĞµÄº¯ÊıÊÇ:</p>
<pre class="programlisting">
request_queue_t *blk_init_queue(request_fn_proc *request, spinlock_t *lock); 
</pre>
<p>µ±È», ²ÎÊıÊÇ, Õâ¸ö¶ÓÁĞµÄÇëÇóº¯ÊıºÍÒ»¸ö¿ØÖÆ¶Ô¶ÓÁĞ´æÈ¡µÄ×ÔĞıËø. Õâ¸öº¯Êı·ÖÅäÄÚ´æ(Êµ¼ÊÉÏ, ²»ÉÙÄÚ´æ)²¢ÇÒ¿ÉÄÜÊ§°ÜÒòÎªÕâ¸ö; ÄãÓ¦µ±Ò»Ö±¼ì²é·µ»ØÖµ, ÔÚÊÔÍ¼Ê¹ÓÃÕâ¸ö¶ÓÁĞÖ®Ç°.</p>
<p>×÷Îª³õÊ¼»¯Ò»¸öÇëÇó¶ÓÁĞµÄÒ»²¿·Ö, Äã¿ÉÉèÖÃ³ÉÔ± queuedata(ËüÊÇÒ»¸ö void * Ö¸Õë )ÎªÈÎºÎÄãÏ²»¶µÄÖµ. Õâ¸ö³ÉÔ±ÊÇÇëÇó¶ÓÁĞµÄ¶ÔÓÚÎÒÃÇÔÚÆäËû½á¹¹ÖĞ¼ûµ½µÄ private_data µÄ¶ÔµÈÌå.</p>
<p>Îª·µ»ØÒ»¸öÇëÇó¶ÓÁĞ¸øÏµÍ³(ÔÚÄ£¿éĞ¶ÔØÊ±¼ä, Í¨³£), µ÷ÓÃ blk_cleanup_queue:</p>
<pre class="programlisting">
void blk_cleanup_queue(request_queue_t *); 
</pre>
<p>Õâ¸öµ÷ÓÃºó, ÄãµÄÇı¶¯´Ó¸ø¶¨µÄ¶ÓÁĞÖĞ²»ÔÙ¿´µ½ÇëÇó,²¢ÇÒ²»Ó¦µ±ÔÙ´ÎÒıÓÃËü.</p>
</div>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="Queueingfunctions.sect3"></a>16.3.3.2.&#160;ÅÅ¶Óº¯Êı</h4></div></div></div>
<p>ÓĞ·Ç³£ÉÙµÄº¯ÊıÀ´²Ù×÷¶ÓÁĞÖĞµÄÇëÇó -- ÖÁÉÙ, ¿¼ÂÇµ½Çı¶¯. Äã±ØĞë³ÖÓĞ¶ÓÁĞËø, ÔÚÄãµ÷ÓÃÕâĞ©º¯ÊıÖ®Ç°.</p>
<p>·µ»ØÒª´¦ÀíµÄÏÂÒ»¸öÇëÇóµÄº¯ÊıÊÇ elv_next_request:</p>
<pre class="programlisting">
struct request *elv_next_request(request_queue_t *queue); 
</pre>
<p>ÎÒÃÇÒÑ¾­ÔÚ¼òµ¥µÄ sbull Àı×ÓÖĞ¼ûµ½Õâ¸öº¯Êı. Ëü·µ»ØÒ»¸öÖ¸ÏòÏÂÒ»¸öÒª´¦ÀíµÄÇëÇóµÄÖ¸Õë(ÓÉ I/O µ÷¶ÈÆ÷Ëù¾ö¶¨µÄ)»òÕß NULL Èç¹ûÃ»ÓĞÇëÇóÒª´¦Àí. elv_next_request ÁôÕâ¸öÇëÇóÔÚ¶ÓÁĞÉÏ, µ«ÊÇ±êÊ¶ËüÎª»î¶¯µÄ; Õâ¸ö±êÊ¶×èÖ¹ÁË I/O µ÷¶ÈÆ÷ÊÔÍ¼ºÏ²¢ÆäËûµÄÇëÇóµ½ÕâĞ©Äã¿ªÊ¼Ö´ĞĞµÄ.</p>
<p>ÎªÊµ¼ÊÉÏ´ÓÒ»¸ö¶ÓÁĞÖĞÈ¥³ıÒ»¸öÇëÇó, Ê¹ÓÃ blkdev_dequeue_request:</p>
<pre class="programlisting">
void blkdev_dequeue_request(struct request *req); 
</pre>
<p>Èç¹ûÄãµÄÇı¶¯Í¬Ê±´ÓÍ¬Ò»¸ö¶ÓÁĞÖĞ²Ù×÷¶à¸öÇëÇó, Ëü±ØĞëÒÔÕâÑùµÄ·½Ê½½«ËüÃÇ½â³ö¶ÓÁĞ.</p>
<p>Èç¹ûÄãÓÉÓÚÍ¬ÑùµÄÀíÓÉĞèÒª·ÅÖÃÒ»¸ö³öÁĞÇëÇó»Øµ½¶ÓÁĞÖĞ, Äã¿ÉÒÔµ÷ÓÃ:</p>
<pre class="programlisting">
void elv_requeue_request(request_queue_t *queue, struct request *req); 
</pre>
</div>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="Queuecontrolfunctions.sect3"></a>16.3.3.3.&#160;¶ÓÁĞ¿ØÖÆº¯Êı</h4></div></div></div>
<p>¿é²ãÊä³öÁËÒ»Ì×º¯Êı, ¿É±»Çı¶¯ÓÃÀ´¿ØÖÆÒ»¸öÇëÇó¶ÓÁĞÈçºÎ²Ù×÷. ÕâĞ©º¯Êı°üÀ¨:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>void blk_stop_queue(request_queue_t *queue);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>void blk_start_queue(request_queue_t *queue);</span></span></dt>
<dd><p>Èç¹ûÄãµÄÉè±¸ÒÑµ½µ½´ïÒ»¸ö×´Ì¬, Ëü²»ÄÜ´¦ÀíµÈºòµÄÃüÁî, Äã¿Éµ÷ÓÃ blk_stop_queue À´¸æÖª¿é²ã. ÔÚÕâ¸öµ÷ÓÃÖ®ºó, ÄãµÄÇëÇóº¯Êı½«²»±»µ÷ÓÃÖ±µ½Äãµ÷ÓÃ blk_start_queue. ²»ÓÃËµ, Äã²»Ó¦µ±Íü¼ÇÖØÆô¶ÓÁĞ, µ±ÄãµÄÉè±¸¿É´¦Àí¸ü¶àÇëÇóÊ±. ¶ÓÁĞËø±ØĞë±»³ÖÓĞµ±µ÷ÓÃÈÎºÎÒ»¸öÕâĞ©º¯ÊıÊ±.</p></dd>
<dt><span class="term"><span>void blk_queue_bounce_limit(request_queue_t *queue, u64 dma_addr);</span></span></dt>
<dd><p>¸æÖªÄÚºËÄãµÄÉè±¸¿É½øĞĞ DMA µÄ×î¸ßÎïÀíµØÖ·µÄº¯Êı. Èç¹ûÒ»¸öÇëÇó°üº¬Ò»¸ö³¬³öÕâ¸öÏŞÖÆµÄÄÚ´æÒıÓÃ, Ò»¸ö·´µ¯»º³å½«±»ÓÃÀ´¸øÕâ¸ö²Ù×÷; µ±È», ÕâÊÇÒ»¸ö½øĞĞ¿é I/O µÄ°º¹ó·½Ê½, ²¢ÇÒÓ¦µ±¾¡Á¿±ÜÃâ. Äã¿ÉÔÚÕâ¸ö²ÎÊıÖĞÌá¹©ÈÎºÎ¿ÉÄÜµÄÖµ, »òÕßÊ¹ÓÃÔ¤ÏÈ¶¨ÒåµÄ·ûºÅ BLK_BOUNCE_HIGH(Ê¹ÓÃ·´µ¯»º³å¸ø¸ßÄÚ´æÒ³), BLK_BOUNCE_ISA (Çı¶¯Ö»¿É DMA µ½ 16MB µÄ ISA Çø), »òÕßBLK_BOUCE_ANY(Çı¶¯¿É½øĞĞ DMA µ½ÈÎºÎµØÖ·). È±Ê¡ÖµÊÇ BLK_BOUNCE_HIGH.</p></dd>
<dt><span class="term"><span>void blk_queue_max_sectors(request_queue_t *queue, unsigned short max);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>void blk_queue_max_phys_segments(request_queue_t *queue, unsigned short max);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>void blk_queue_max_hw_segments(request_queue_t *queue, unsigned short max);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>void blk_queue_max_segment_size(request_queue_t *queue, unsigned int max);</span></span></dt>
<dd><p>ÉèÖÃ²ÎÊıµÄº¯Êı, ÕâĞ©²ÎÊıÃèÊö¿É±»Éè±¸Âú×ãµÄÇëÇó. blk_queue_max ¿ÉÓÃÀ´ÒÔÉÈÇø·½Ê½ÉèÖÃÈÎÒ»ÇëÇóµÄ×î´óµÄ´óĞ¡; È±Ê¡ÊÇ 255. blk_queue_max_phys_segments ºÍ blk_queue_max_hw_segments ¶¼¿ØÖÆ¶àÉÙÎïÀí¶Î(ÏµÍ³ÄÚ´æÖĞ²»ÏàÁÚµÄÇø)¿É°üº¬ÔÚÒ»¸öÇëÇóÖĞ. Ê¹ÓÃ blk_queue_max_phys_segments À´ËµÄãµÄÇı¶¯×¼±¸´¦Àí¶àÉÙ¶Î; ÀıÈç, Õâ¿ÉÄÜÊÇÒ»¸ö¾²Ì¬·ÖÅäµÄÉ¢²¼±íµÄ´óĞ¡. blk_queue_max_hw_segments, Ïà·´, ÊÇÉè±¸¿É´¦ÀíµÄ×î¶àµÄ¶ÎÊı. Õâ 2 ¸ö²ÎÊıÈ±Ê¡¶¼ÊÇ 128. ×îºó, blk_queue_max_segment_size ¸æÖªÄÚºËÈÎÒ»¸öÇëÇóµÄ¶Î¿ÉÄÜÊÇ¶à´ó×Ö½Ú; È±Ê¡ÊÇ 65,536 ×Ö½Ú.</p></dd>
<dt><span class="term"><span>blk_queue_segment_boundary(request_queue_t *queue, unsigned long mask);</span></span></dt>
<dd><p>Ò»Ğ©Éè±¸ÎŞ·¨´¦Àí¿çÔ½Ò»¸öÌØÊâ´óĞ¡ÄÚ´æ±ß½çµÄÇëÇó; Èç¹ûÄãµÄÉè±¸ÊÇÆäÖĞÖ®Ò», Ê¹ÓÃÕâ¸öº¯ÊıÀ´¸æÖªÄÚºËÕâ¸ö±ß½ç. ÀıÈç, Èç¹ûÄãµÄÉè±¸´¦Àí¿ç 4-MB ±ß½çµÄÇëÇóÓĞÀ§ÄÑ, ´«µİÒ»¸ö 0x3fffff ÑÚÂë. È±Ê¡µÄÑÚÂëÊÇ 0xffffffff.</p></dd>
<dt><span class="term"><span>void blk_queue_dma_alignment(request_queue_t *queue, int mask);</span></span></dt>
<dd><p>¸æÖªÄÚºË¹ØÓÚÄãµÄÉè±¸Ê©¼ÓÓÚ DMA ´«ËÍµÄÄÚ´æ¶ÔÆëÏŞÖÆµÄº¯Êı. ËùÓĞµÄÇëÇó±»´´½¨ÓĞ¸ø¶¨µÄ¶ÔÆë, ²¢ÇÒÇëÇóµÄ³¤¶ÈÒ²Æ¥ÅäÕâ¸ö¶ÔÆë. È±Ê¡µÄÑÚÂëÊÇ 0x1ff, Ëüµ¼ÖÂËùÓĞµÄÇëÇó±»¶ÔÆëµ½ 512-×Ö½Ú±ß½ç. </p></dd>
<dt><span class="term"><span>void blk_queue_hardsect_size(request_queue_t *queue, unsigned short max);</span></span></dt>
<dd><p>¸æÖªÄÚºËÄãµÄÉè±¸µÄÓ²¼şÉÈÇø´óĞ¡. ËùÓĞÓÉÄÚºË²úÉúµÄÇëÇóÊÇÕâ¸ö´óĞ¡µÄ±¶Êı²¢ÇÒ±»ÕıÈ·¶ÔÆë. ËùÓĞµÄÔÚ¿é²ãºÍÇı¶¯Ö®¼äµÄÍ¨Ñ¶¼ÌĞøÒÔ 512-×Ö½ÚÉÈÇøÀ´±í´ï, µ«ÊÇ.</p></dd>
</dl></div>
</div>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="TheAnatomyofaRequest.sect2"></a>16.3.4.&#160;ÇëÇóµÄ·ÖÎö</h3></div></div></div>
<p>ÔÚÎÒÃÇµÄ¼òµ¥Àı×ÓÀï, ÎÒÃÇÓöµ½ÁËÕâ¸öÇëÇó½á¹¹. µ«ÊÇ, ÎÒÃÇÎ´Ôø½Ó´¥Õâ¸ö¸´ÔÓµÄÊı¾İ½á¹¹. ÔÚ±¾½Ú, ÎÒÃÇ¿´, ÏêÏ¸µØ, ¿é I/O ÇëÇóÔÚ Linux ÄÚºËÖĞÈçºÎ±»±íÊ¾.</p>
<p>Ã¿¸öÇëÇó½á¹¹´ú±íÒ»¸ö¿é I/O ÇëÇó, ¾¡¹ÜËü¿ÉÄÜÊÇÓÉ¼¸¸ö¶ÀÁ¢µÄÇëÇóÔÚ¸ü¸ß²ã´ÎºÏ²¢¶ø³É. ¶ÔÈÎºÎÌØÊâµÄÇëÇó¶ø´«ËÍµÄÉÈÇø¿ÉÄÜ·Ö²¼ÔÚÕû¸öÖ÷ÄÚ´æ, ¾¡¹ÜËüÃÇ³£³£¶ÔÓ¦¿éÉè±¸ÖĞµÄ¶à¸öÁ¬ĞøµÄÉÈÇø. Õâ¸öÇëÇó±»±íÊ¾Îª¶à¸ö¶Î, Ã¿¸ö¶ÔÓ¦Ò»¸öÄÚ´æÖĞµÄ»º³å. ÄÚºË¿ÉÄÜºÏ²¢¶à¸öÉæ¼°´ÅÅÌÉÏÁÚ½üÉÈÇøµÄÇëÇó, µ«ÊÇËü´Ó²»ºÏ²¢ÔÚµ¥¸öÇëÇó½á¹¹ÖĞµÄ¶ÁºÍĞ´²Ù×÷. ÄÚºË»¹È·±£²»ºÏ²¢ÇëÇó, Èç¹û½á¹û»áÆÆ»µÈÎºÎµÄÔÚÇ°ÃæÕÂ½ÚÖĞÃèÊöµÄÇëÇó¶ÓÁĞÏŞÖÆ.</p>
<p>»ù±¾ÉÏ, Ò»¸öÇëÇó½á¹¹±»ÊµÏÖÎªÒ»¸ö bio ½á¹¹µÄÁ´±í, ½áºÏÒ»Ğ©Î¬»¤ĞÅÏ¢À´Ê¹Çı¶¯¿ÉÒÔ¸ú×ÙËüµÄÎ»ÖÃ, µ±ËüÔÚÍê³ÉÕâ¸öÇëÇóÖĞ. Õâ¸ö bio ½á¹¹ÊÇÒ»¸ö¿é I/O ÇëÇóÒÆÖ²µÄµÍ¼¶ÃèÊö; ÎÒÃÇÏÖÔÚ¿´¿´Ëü.</p>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="Thebiostructure.sect3"></a>16.3.4.1.&#160;bio ½á¹¹</h4></div></div></div>
<p>µ±ÄÚºË, ÒÔÒ»¸öÎÄ¼şÏµÍ³µÄĞÎÊ½, ĞéÄâÎÄ¼ş×ÓÏµÍ³, »òÕßÒ»¸öÏµÍ³µ÷ÓÃ, ¾ö¶¨Ò»×é¿é±ØĞë´«ËÍµ½»ò´ÓÒ»¸ö¿é I/O Éè±¸; Ëü×°ÅäÒ»¸ö bio ½á¹¹À´ÃèÊöÄÇ¸ö²Ù×÷. ÄÇ¸ö½á¹¹½Ó×Å±»µİ¸øÕâ¸ö¿é I/O ´úÂë, Õâ¸ö´úÂëºÏ²¢Ëüµ½Ò»¸ö´æÔÚµÄÇëÇó½á¹¹, »òÕß, Èç¹ûĞèÒª, ´´½¨Ò»¸öĞÂµÄ. Õâ¸ö bio ½á¹¹°üº¬Ò»¸ö¿éÇı¶¯ĞèÒªÀ´½øĞĞÇëÇóµÄÈÎºÎ¶«Î÷, ¶ø²»±ØÉæ¼°Ê¹Õâ¸öÇëÇóÆô¶¯µÄÓÃ»§¿Õ¼ä½ø³Ì.</p>
<p>bio ½á¹¹, ÔÚ &lt;linux/bio.h&gt; ÖĞ¶¨Òå, °üº¬Ğí¶à³ÉÔ±¶ÔÇı¶¯×÷ÕßÊÇÓĞÓÃµÄ:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>sector_t bi_sector;</span></span></dt>
<dd><p>Õâ¸ö bio Òª±»´«ËÍµÄµÚÒ»¸ö(512×Ö½Ú)ÉÈÇø.</p></dd>
<dt><span class="term"><span>unsigned int bi_size;</span></span></dt>
<dd><p>±»´«ËÍµÄÊı¾İ´óĞ¡, ÒÔ×Ö½Ú¼Æ. Ïà·´, ³£³£¸üÒ×Ê¹ÓÃ bio_sectors(bio), Ò»¸ö¸ø¶¨ÒÔÉÈÇø¼ÆµÄ´óĞ¡µÄºê.</p></dd>
<dt><span class="term"><span>unsigned long bi_flags;</span></span></dt>
<dd><p>Ò»×éÃèÊö bio µÄ±êÖ¾; ×îµÍÓĞĞ§Î»±»ÖÃÎ»Èç¹ûÕâÊÇÒ»¸öĞ´ÇëÇó(¾¡¹Üºê bio_data_dir(bio)Ó¦µ±ÓÃÀ´´úÌæÖ±½Ó¼ÓËøÕâ¸ö±êÖ¾).</p></dd>
<dt><span class="term"><span>unsigned short bio_phys_segments;</span></span></dt>
<dd></dd>
<dt><span class="term"><span>unsigned short bio_hw_segments;</span></span></dt>
<dd><p>°üº¬ÔÚÕâ¸ö BIO ÖĞµÄÎïÀí¶ÎµÄÊıÄ¿, ºÍÔÚ DMA Ó³ÉäÍê³Éºó±»Ó²¼ş¿´µ½µÄ¶ÎÊıÄ¿, ·Ö±ğµØ.</p></dd>
</dl></div>
<p>Ò»¸ö bio µÄºËĞÄ, µ«ÊÇ, ÊÇÒ»¸ö³ÆÎª bi_io_vec µÄÊı×é, ËüÓÉÏÂÁĞ½á¹¹×é³É:</p>
<pre class="programlisting">
struct bio_vec {
 struct page  *bv_page; 
 unsigned int  bv_len; 
 unsigned int  bv_offset;  
};  
</pre>
<p>Í¼ <a href="ch16s03.html#ldd3-16-1.fig" title="Í¼&#160;16.1.&#160;bio ½á¹¹">bio ½á¹¹</a>ÏÔÊ¾ÁËÕâĞ©½á¹¹ÈçºÎ½áºÏÔÚÒ»Æğ. ÈçÍ¬ÄãËù¼ûµ½µÄ, ÔÚÒ»¸ö¿é I/O ÇëÇó±»×ª»»ÎªÒ»¸ö bio ½á¹¹ºó, ËüÒÑ±»·ÖÎªµ¥¶ÀµÄÎïÀíÄÚ´æÒ³. ËùÓĞµÄÒ»¸öÇı¶¯ĞèÒª×öµÄÊÂÇéÊÇ²½½øÈ«²¿Õâ¸ö½á¹¹Êı×é(ËüÃÇÓĞ bi_vcnt ¸ö), ºÍÔÚÃ¿¸öÒ³ÄÚ´«µİÊı¾İ(µ«ÊÇÖ» len ×Ö½Ú, ´Ó offset ¿ªÊ¼).</p>
<div class="figure">
<a name="ldd3-16-1.fig"></a><p class="title"><b>Í¼&#160;16.1.&#160;bio ½á¹¹</b></p>
<div><img src="images/snagitldd3/ldd3-16-1.png" alt="bio ½á¹¹"></div>
</div>
<p>Ö±½ÓÊ¹ÓÃ bi_io_vec Êı×é²»±»ÍÆ¼ö, ÎªÁËÄÚºË¿ª·¢Õß¿ÉÒÔÔÚÒÔºó¸Ä±ä bio ½á¹¹¶ø²»»áÒıÆğÆÆ»µ. Îª´Ë, Ò»×éºê±»Ìá¹©À´¼ò»¯Ê¹ÓÃ bio ½á¹¹. ¿ªÊ¼µÄµØ·½ÊÇ bio_for_each_segment, Ëü¼òµ¥µØÑ­»· bi_io_vec Êı×éÖĞÃ¿¸öÎ´±»´¦ÀíµÄÏî. Õâ¸öºêÓ¦µ±ÈçÏÂÓÃ: </p>
<pre class="programlisting">
int segno;
struct bio_vec *bvec;

bio_for_each_segment(bvec, bio, segno) {
 /* Do something with this segment
}
</pre>
<p>ÔÚÕâ¸öÑ­»·ÖĞ, bvec Ö¸Ïòµ±Ç°µÄ bio_vec Ïî, ²¢ÇÒ segno ÊÇµ±Ç°µÄ¶ÎºÅ. ÕâĞ©Öµ¿É±»ÓÃÀ´ÉèÖÃ DMA ·¢ËÍÆ÷(Ò»¸öÊ¹ÓÃ blk_rq_map_sg µÄÌæ´ú·½·¨ÔÚ"¿éÇëÇóºÍ DMA"Ò»½ÚÖĞÃèÊö). Èç¹ûÄãĞèÒªÖ±½Ó´æÈ¡Ò³, ÄãÓ¦µ±Ê×ÏÈÈ·±£Ò»¸öÕıÈ·µÄÄÚºËĞéÄâµØÖ·´æÔÚ; Îª´Ë, Äã¿ÉÊ¹ÓÃ:</p>
<pre class="programlisting">
char *__bio_kmap_atomic(struct bio *bio, int i, enum km_type type); 
void __bio_kunmap_atomic(char *buffer, enum km_type type);
</pre>
<p>Õâ¸öµ×²ãµÄº¯ÊıÔÊĞíÄãÖ±½ÓÓ³ÉäÔÚÒ»¸ö¸ø¶¨µÄ bio_vec ÖĞÕÒµ½µÄ»º³å, ÓÉË÷Òı i ËùÖ¸¶¨µÄ. Ò»¸öÔ­×ÓµÄ kmap ±»´´½¨; µ÷ÓÃÕß±ØĞëÌá¹©ºÏÊÊµÄÀ´Ê¹ÓÃµÄ²ÛÎ»(ÈçÍ¬ÔÚ 15 ÕÂµÄ"ÄÚ´æÓ³ÉäºÍ struct page"Ò»½ÚÖĞÃèÊöµÄ).</p>
<p>¿é²ã»¹Î¬»¤Ò»×éÎ»ÓÚ bio ½á¹¹µÄÖ¸ÕëÀ´¸ú×ÙÇëÇó´¦ÀíµÄµ±Ç°×´Ì¬. ¼¸¸öºêÀ´Ìá¹©¶ÔÕâ¸ö×´Ì¬µÄ´æÈ¡:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>struct page *bio_page(struct bio *bio);</span></span></dt>
<dd><p>·µ»ØÒ»¸öÖ¸ÏòÒ³½á¹¹µÄÖ¸Õë, ±íÊ¾ÏÂÒ»¸ö±»´«ËÍµÄÒ³.</p></dd>
<dt><span class="term"><span>int bio_offset(struct bio *bio);</span></span></dt>
<dd><p>·µ»ØÒ³ÄÚµÄ±»´«ËÍµÄÊı¾İµÄÆ«ÒÆ.</p></dd>
<dt><span class="term"><span>int bio_cur_sectors(struct bio *bio);</span></span></dt>
<dd><p>·µ»ØÒª±»´«ËÍ³öµ±Ç°Ò³µÄÉÈÇøÊı.</p></dd>
<dt><span class="term"><span>char *bio_data(struct bio *bio);</span></span></dt>
<dd><p>·µ»ØÒ»¸öÄÚºËÂß¼­µØÖ·, Ö¸Ïò±»´«ËÍµÄÊı¾İ. ×¢ÒâÕâ¸öµØÖ·¿ÉÓÃ½öµ±ÇëÇóµÄÒ³²»ÔÚ¸ßÄÚ´æÖĞ; ÔÚÆäËûÇé¿öÏÂµ÷ÓÃËüÊÇÒ»¸ö´íÎó. È±Ê¡µØ, ¿é×ÓÏµÍ³²»´«µİ¸ßÄÚ´æ»º³åµ½ÄãµÄÇı¶¯, µ«ÊÇÈç¹ûÄãÒÑÊ¹ÓÃ blk_queue_bounce_limit ¸Ä±äÉèÖÃ, Äã¿ÉÄÜ²»¸ÃÊ¹ÓÃ bio_data.</p></dd>
<dt><span class="term"><span>char *bio_kmap_irq(struct bio *bio, unsigned long *flags);</span></span></dt>
<dd></dd>
<dt><span class="term"><span>void bio_kunmap_irq(char *buffer, unsigned long *flags);</span></span></dt>
<dd><p>bio_kmap_irq ¸øÈÎºÎ»º³å·µ»ØÒ»¸öÄÚºËĞéÄâµØÖ·, ²»¹ÜËüÊÇ·ñÔÚ¸ß»òµÍÄÚ´æ. Ò»¸öÔ­×Ó kmap ±»Ê¹ÓÃ, Òò´ËÄãµÄÇı¶¯ÔÚÕâ¸öÓ³Éä±»¼¤»îÊ±²»ÄÜË¯Ãß. Ê¹ÓÃ bio_kunmap_irq À´È¥Ó³Éä»º³å. ×¢ÒâÒòÎªÊ¹ÓÃÒ»¸öÔ­×Ó kmap, Äã²»ÄÜÒ»´ÎÓ³Éä¶àÓÚÒ»¸ö¶Î.</p></dd>
</dl></div>
<p>¸Õ¸ÕÃèÊöµÄËùÓĞº¯Êı¶¼´æÈ¡µ±Ç°»º³å -- »¹Î´±»´«ËÍµÄµÚÒ»¸ö»º³å, Ö»ÒªÄÚºËÖªµÀ. Çı¶¯³£³£ÏëÊ¹ÓÃ bio ÖĞµÄ¼¸¸ö»º³å, ÔÚËüÃÇÈÎºÎÒ»¸öÖ¸³öÍê³ÉÖ®Ç°(Ê¹ÓÃ end_that_request_first, ÂíÉÏ¾Í½²µ½), Òò´ËÕâĞ©º¯Êı³£³£Ã»ÓĞÓÃ. ¼¸¸öÆäËûµÄºê´æÔÚÀ´Ê¹ÓÃ bio ½á¹¹µÄÄÚ²¿½Ó¿Ú(ÏêÇé¼û &lt;linux/bio.h&gt;).</p>
</div>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="Requeststructurefields.sect3"></a>16.3.4.2.&#160;ÇëÇó½á¹¹³ÉÔ±</h4></div></div></div>
<p>ÏÖÔÚÎÒÃÇÓĞÁË bio ½á¹¹ÈçºÎ¹¤×÷µÄ¸ÅÄî, ÎÒÃÇ¿ÉÒÔÉîÈë struct request ²¢ÇÒ¿´ÇëÇó´¦ÀíÈçºÎ¹¤×÷. Õâ¸ö½á¹¹µÄ³ÉÔ±°üÀ¨:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>sector_t hard_sector;</span></span></dt>
<dd></dd>
<dt><span class="term"><span>unsigned long hard_nr_sectors;</span></span></dt>
<dd></dd>
<dt><span class="term"><span>unsigned int hard_cur_sectors;</span></span></dt>
<dd><p>×·×ÙÇëÇóÓ²¼şÍê³ÉµÄÉÈÇøµÄ³ÉÔ±. µÚÒ»¸öÉĞÎ´±»´«ËÍµÄÉÈÇø±»´æ´¢µ½ hard_sector, ÒÑ¾­´«ËÍµÄÉÈÇø×ÜÊıÔÚ hard_nr_sectors, ²¢ÇÒÔÚµ±Ç° bio ÖĞÊ£ÓàµÄÉÈÇøÊıÊÇ hard_cur_sectors. ÕâĞ©³ÉÔ±´òËãÖ»ÓÃÔÚ¿é×ÓÏµÍ³; Çı¶¯²»Ó¦µ±Ê¹ÓÃËüÃÇ.</p></dd>
<dt><span class="term"><span>struct bio *bio;</span></span></dt>
<dd><p>bio ÊÇ¸øÕâ¸öÇëÇóµÄ bio ½á¹¹µÄÁ´±í. Äã²»Ó¦µ±Ö±½Ó´æÈ¡Õâ¸ö³ÉÔ±; Ê¹ÓÃ rq_for_each_bio(ºóÃæÃèÊö) ´úÌæ.</p></dd>
<dt><span class="term"><span>char *buffer;</span></span></dt>
<dd><p>ÔÚ±¾ÕÂÇ°ÃæµÄ¼òµ¥Çı¶¯Àı×ÓÊ¹ÓÃÕâ¸ö³ÉÔ±À´ÕÒµ½´«ËÍµÄ»º³å. Ëæ×ÅÎÒÃÇµÄÉîÈëÀí½â, ÎÒÃÇÏÖÔÚ¿É¼ûµ½Õâ¸ö³ÉÔ±½ö½öÊÇÔÚµ±Ç° bio ÉÏµ÷ÓÃ bio_data µÄ½á¹û.</p></dd>
<dt><span class="term"><span>unsigned short nr_phys_segments;</span></span></dt>
<dd><p>±»Õâ¸öÇëÇóÔÚÎïÀíÄÚ´æÖĞÕ¼ÓÃµÄ¶ÀÌØ¶ÎµÄÊıÄ¿, ÔÚÁÚ½üÒ³ÒÑ±»ºÏ²¢ºó.</p></dd>
<dt><span class="term"><span>struct list_head queuelist;</span></span></dt>
<dd><p>Á´±í½á¹¹(ÈçÍ¬ÔÚ 11 ÕÂÖĞ"Á´±í"Ò»½ÚÖĞÃèÊöµÄ), Á¬½ÓÕâ¸öÇëÇóµ½ÇëÇó¶ÓÁĞ. Èç¹û(²¢ÇÒÖ»ÊÇ)Äã´Ó¶ÓÁĞÖĞÈ¥³ı blkdev_dequeue_request, Äã¿ÉÄÜÊ¹ÓÃÕâ¸öÁĞ±íÍ·À´¸ú×ÙÕâ¸öÇëÇó, ÔÚÒ»¸ö±»ÄãµÄÇı¶¯Î¬»¤µÄÄÚ²¿ÁĞ±íÖĞ.</p></dd>
</dl></div>
<p>Í¼ <a href="ch16s03.html#ldd3-16-2.fig" title="Í¼&#160;16.2.&#160;Ò»¸ö´øÓĞÒ»¸ö²¿·Ö±»´¦ÀíµÄÇëÇóµÄÇëÇó¶ÓÁĞ">Ò»¸ö´øÓĞÒ»¸ö²¿·Ö±»´¦ÀíµÄÇëÇóµÄÇëÇó¶ÓÁĞ</a> Õ¹Ê¾ÁËÇëÇó¶ÓÁĞºÍËüµÄ×é¼ş bio ½á¹¹ÈçºÎ¶ÔÓ¦µ½Ò»Æğ. ÔÚÍ¼ÖĞ, Õâ¸öÇëÇóÒÑ±»²¿·ÖÂú×ã. cbio ºÍ buffer ´¦ÓÚÖ¸ÏòÉĞÎ´´«ËÍµÄµÚÒ»¸ö bio.</p>
<div class="figure">
<a name="ldd3-16-2.fig"></a><p class="title"><b>Í¼&#160;16.2.&#160;Ò»¸ö´øÓĞÒ»¸ö²¿·Ö±»´¦ÀíµÄÇëÇóµÄÇëÇó¶ÓÁĞ</b></p>
<div><img src="images/snagitldd3/ldd3-16-2.png" alt="Ò»¸ö´øÓĞÒ»¸ö²¿·Ö±»´¦ÀíµÄÇëÇóµÄÇëÇó¶ÓÁĞ"></div>
</div>
<p>ÓĞĞí¶à²»Í¬µÄ×Ö¶ÎÔÚÇëÇó½á¹¹ÖĞ, µ«ÊÇ±¾½ÚÖĞµÄÁĞ±íÓ¦µ±¶Ô´ó²¿·ÖÇı¶¯±àĞ´ÕßÊÇ×ã¹»µÄ.</p>
</div>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="Barrierrequests.sect3"></a>16.3.4.3.&#160;ÆÁÕÏÇëÇó</h4></div></div></div>
<p>¿é²ãÔÚÄãµÄÇı¶¯¼ûµ½ËüÃÇÖ®Ç°ÖØĞÂÅÅĞòÀ´Ìá¸ß I/O ĞÔÄÜ. ÄãµÄÇı¶¯, Ò²¿ÉÒÔÖØĞÂÅÅĞòÇëÇó, Èç¹ûÓĞÀíÓÉÕâÑù×ö. ³£³£µØ, ÕâÖÖÖØĞÂÅÅĞòÍ¨¹ı´«µİ¶à¸öÇëÇóµ½Çı¶¯²¢ÇÒÊ¹Ó²¼ş¿¼ÂÇÓÅ»¯µÄË³ĞòÀ´ÊµÏÖ. µ«ÊÇ, ¶ÔÓÚ²»ÑÏ¸ñµÄÇëÇóË³ĞòÓĞÒ»¸öÎÊÌâ: ÓĞĞ©Ó¦ÓÃ³ÌĞòÒªÇó±£Ö¤Ä³Ğ©²Ù×÷ÔÚÆäËûµÄÆô¶¯Ç°Íê³É. ÀıÈç, ¹ØÏµÊı¾İ¿â¹ÜÀíÕß, ±ØĞë¾ø¶ÔÈ·±£ËüÃÇµÄÈÕÖ¾ĞÅÏ¢Ë¢ĞÂµ½Çı¶¯Æ÷, ÔÚÖ´ĞĞÔÚÊı¾İ¿âÄÚÈİÉÏµÄÒ»´Î½»Ò×Ö®Ç°. ÈÕÖ¾Ê½ÎÄ¼şÏµÍ³, ÏÖÔÚÔÚ´ó²¿·Ö Linux ÏµÍ³ÖĞÊ¹ÓÃ, ÓĞ·Ç³£ÀàËÆµÄÅÅĞòÏŞÖÆ. Èç¹û´íÎóµÄ²Ù×÷±»ÖØĞÂÅÅĞò, ½á¹û¿ÉÄÜÊÇÑÏÖØµÄ, ÎŞ·¨Ì½²âµÄÊı¾İÆÆ»µ.</p>
<p>2.6 ¿é²ã½â¾öÕâ¸öÎÊÌâÍ¨¹ıÒ»¸öÆÁÕÏÇëÇóµÄ¸ÅÄî. Èç¹ûÒ»¸öÇëÇó±»±êÊ¶Îª REQ_HARDBARRER ±êÖ¾, Ëü±ØĞë±»Ğ´ÈëÇı¶¯Æ÷ÔÚÈÎºÎºóĞøµÄÇëÇó±»³õÊ¼»¯Ö®Ç°. "±»Ğ´ÈëÉè±¸", ÎÒÃÇÒâË¼ÊÇÊı¾İ±ØĞëÊµ¼ÊÎ»ÓÚ²¢ÇÒÊÇ³Ö¾ÃµÄÔÚÎïÀí½éÖÊÖĞ. Ğí¶àµÄÇı¶¯Æ÷½øĞĞĞ´ÇëÇóµÄ»º´æ; Õâ¸ö»º´æÌá¸ßÁËĞÔÄÜ, µ«ÊÇËü¿ÉÄÜÊ¹ÆÁÕÏÇëÇóµÄÄ¿µÄÊ§°Ü. Èç¹ûÒ»¸öµçÁ¦Ê§Ğ§ÔÚ¹Ø¼üÊı¾İÈÔÈ»ÔÚÇı¶¯Æ÷µÄ»º´æÖĞÊ±·¢Éú, Êı¾İÈÔÈ»±»¶ªÊ§¼´±ãÇı¶¯Æ÷±¨¸æÍê³É. Òò´ËÒ»¸öÊµÏÖÆÁÕÏÇëÇóµÄÇı¶¯Æ÷±ØĞë²ÉÈ¡²½ÖèÀ´Ç¿ÖÆÇı¶¯Æ÷ÕæÕıĞ´ÕâĞ©Êı¾İµ½½éÖÊÖĞ.</p>
<p>Èç¹ûÄãµÄÇı¶¯Æ÷×ğ¾´ÆÁÕÏÇëÇó, µÚÒ»²½ÊÇÍ¨Öª¿é²ãÕâ¸öÊÂÊµ. ÆÁÕÏ´¦ÀíÊÇÁíÒ»¸öÇëÇó¶ÓÁĞ; Ëü±»ÉèÖÃÎª:</p>
<pre class="programlisting">
void blk_queue_ordered(request_queue_t *queue, int flag);
</pre>
<p>ÎªÖ¸Ê¾ÄãµÄÇı¶¯ÊµÏÖÁËÆÁÕÏÇëÇó, ÉèÖÃ flag ²ÎÊıÎªÒ»¸ö·ÇÁãÖµ.</p>
<p>Êµ¼ÊµÄÆÁÕÏÇëÇóÊµÏÖÊÇ¼òµ¥µØ²âÊÔÔÚÇëÇó½á¹¹ÖĞ¹ØÁªµÄ±êÖ¾. ÒÑ¾­Ìá¹©ÁËÒ»¸öºêÀ´½øĞĞÕâ¸ö²âÊÔ:</p>
<pre class="programlisting">
int blk_barrier_rq(struct request *req); 
</pre>
<p>Èç¹ûÕâ¸öºê·µ»ØÒ»¸ö·ÇÁãÖµ, Õâ¸öÇëÇóÊÇÒ»¸öÆÁÕÏÇëÇó. ¸ù¾İÄãµÄÓ²¼şÈçºÎ¹¤×÷, Äã¿ÉÄÜ±ØĞëÍ£Ö¹´Ó¶ÓÁĞÖĞ»ñÈ¡ÇëÇó, Ö±µ½ÆÁÕÏÇëÇóÒÑ¾­Íê³É. ÁíÍâµÄÇı¶¯Æ÷ÄÜÀí½âÆÁÕÏÇëÇó; ÔÚÕâ¸öÇé¿öÖĞ, ÄãµÄÇı¶¯ËùÓĞµÄ±ØĞë×öµÄÊÇ¶ÔÕâĞ©Çı¶¯Æ÷·¢³öÕıÈ·µÄ²Ù×÷.</p>
</div>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="Nonretryablerequests.sect3"></a>16.3.4.4.&#160;²»¿ÉÖØÈëÇëÇó</h4></div></div></div>
<p>¿éÇı¶¯³£³£ÊÔÍ¼ÖØÊÔµÚÒ»´ÎÊ§°ÜµÄÇëÇó. Õâ¸ö×ö·¨¿É²úÉúÒ»¸ö¸ü¼Ó¿É¿¿µÄÏµÍ³²¢ÇÒ°ïÖúÀ´±ÜÃâÊı¾İ¶ªÊ§. ÄÚºË, µ«ÊÇ, ÓĞÊ±±êÊ¶ÇëÇóÎª²»¿ÉÖØÈëµÄ. ÕâÑùµÄÇëÇóÓ¦µ±ÍêÈ«¾¡¿ìÊ§°Ü, Èç¹ûËüÃÇÎŞ·¨ÔÚµÚÒ»´ÎÊÔµÄÊ±ºòÖ´ĞĞ.</p>
<p>Èç¹ûÄãµÄÇı¶¯ÔÚ¿¼ÂÇÖØÊÔÒ»¸öÊ§°ÜµÄÇëÇó, ËûÓ¦µ±Ê×ÏÈµ÷ÓÃ:</p>
<pre class="programlisting">
int blk_noretry_request(struct request *req); 
</pre>
<p>Èç¹ûÕâ¸öºê·µ»Ø·ÇÁãÖµ, ÄãµÄÇı¶¯Ó¦µ±·ÅÆúÕâ¸öÇëÇó, Ê¹ÓÃÒ»¸ö´íÎóÂëÀ´´úÌæÖØÊÔËü.</p>
</div>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="RequestCompletionFunctions.sect2"></a>16.3.5.&#160;ÇëÇóÍê³Éº¯Êı</h3></div></div></div>
<p>ÈçÍ¬ÎÒÃÇ½«¼ûµ½µÄ, ÓĞ¼¸¸ö²»Í¬µÄ·½Ê½À´Ê¹ÓÃÒ»¸öÇëÇó½á¹¹. ËüÃÇËùÓĞµÄ¶¼Ê¹ÓÃ¼¸¸öÍ¨ÓÃµÄº¯Êı, µ«ÊÇ, ËüÃÇ´¦ÀíÒ»¸ö I/O ÇëÇó»òÕß²¿·ÖÇëÇóµÄÍê³É. Õâ 2 ¸öº¯Êı¶¼ÊÇÔ­×ÓµÄ²¢ÇÒ¿É´ÓÒ»¸öÔ­×ÓÉÏÏÂÎÄ±»°²È«µØµ÷ÓÃ.</p>
<p>µ±ÄãµÄÉè±¸ÒÑ¾­Íê³É´«ËÍÒ»Ğ©»òÕßÈ«²¿ÉÈÇø, ÔÚÒ»¸ö I/O ÇëÇóÖĞ, Ëü±ØĞëÍ¨Öª¿é×ÓÏµÍ³, Ê¹ÓÃ:</p>
<pre class="programlisting">
int end_that_request_first(struct request *req, int success, int count); 
</pre>
<p>Õâ¸öº¯Êı¸æÖª¿é´úÂë, ÄãµÄÇı¶¯ÒÑ¾­Íê³É count ¸öÉÈÇøµØ´«ËÍ, ´ÓÄã×îºóÁôÏÂµÄµØ·½¿ªÊ¼. Èç¹û I/O ÊÇ³É¹¦µÄ, ´«µİ success Îª 1; ·ñÔò´«µİ 0. ×¢ÒâÄã±ØĞëÖ¸³öÍê³É, °´ÕÕ´ÓµÚÒ»¸öÉÈÇøµ½×îºóÒ»¸öµÄË³Ğò; Èç¹ûÄãµÄÇı¶¯ºÍÉè±¸ÓĞĞ©¹²Ä±À´ÂÒĞòÍê³ÉÇëÇó, Äã±ØĞë´æ´¢Õâ¸öÂÒĞòµÄÍê³É×´Ì¬Ö±µ½½éÈëµÄÉÈÇøÒÑ¾­±»´«µİ.</p>
<p>´Ó end_that_request_first µÄ·µ»ØÖµÊÇÒ»¸öÖ¸Ê¾, Ö¸Ê¾ÊÇ·ñËùÓĞµÄÕâ¸öÇëÇóÖĞµÄÉÈÇøÒÑ¾­±»´«ËÍ»òÕßÃ»ÓĞ. Ò»¸ö 0 ·µ»ØÖµ±íÊ¾ËùÓĞµÄÉÈÇøÒÑ¾­±»´«ËÍ²¢ÇÒÕâ¸öÇëÇóÍê³É. ÔÚÕâµã, Äã±ØĞëÊ¹ÓÃ blkdev_dequeue_request À´´Ó¶ÓÁĞÖĞ½â³ıÇëÇó(Èç¹ûÄã»¹Ã»ÓĞÕâÑù×ö)²¢ÇÒ´«µİËüµ½:</p>
<pre class="programlisting">
void end_that_request_last(struct request *req); 
</pre>
<p>end_that_request_last Í¨ÖªÈÎºÎÔÚµÈ´ıÕâ¸öÇëÇóµÄÈË, Õâ¸öÇëÇóÒÑ¾­Íê³É²¢ÇÒ»ØÊÕÕâ¸öÇëÇó½á¹¹; Ëü±ØĞëÔÚ³ÖÓĞ¶ÓÁĞËøÊ±±»µ÷ÓÃ.</p>
<p>ÔÚÎÒÃÇµÄ¼òµ¥µÄ sbull Àı×ÓÀï, ÎÒÃÇ²»Ê¹ÓÃÈÎºÎÉÏÃæµÄº¯Êı. Ïà·´, ÄÇ¸öÀı×Ó, ±»³ÆÎª end_request. ÎªÏÔÊ¾Õâ¸öµ÷ÓÃµÄĞ§¹û, ÕâÀïÓĞÕû¸öµÄ end_request º¯Êı, Èç¹ûÔÚ 2.6.10 ÄÚºËÖĞ¼ûµ½µÄ:</p>
<pre class="programlisting">
void end_request(struct request *req, int uptodate)
{

 if (!end_that_request_first(req, uptodate, req-&gt;hard_cur_sectors)) {
 add_disk_randomness(req-&gt;rq_disk);
 blkdev_dequeue_request(req);
 end_that_request_last(req);
 }
}
</pre>
<p>º¯Êı add_disk_randomness Ê¹ÓÃ¿é I/O ÇëÇóµÄ¶¨Ê±À´¹±Ï×ìØ¸øÏµÍ³µÄËæ»úÊı³Ø; ËüÓ¦µ±±»µ÷ÓÃ½öµ±´ÅÅÌµÄ¶¨Ê±ÊÇÕæÕıµÄËæ»úµÄ. ¶Ô´ó²¿·ÖµÄ»úĞµÉè±¸ÕâÊÇÕæµÄ, µ«ÊÇ¶ÔÒ»¸ö»ùÓÚÄÚ´æµÄĞéÄâÉè±¸Ëü²»ÊÇÕæµÄ, ÀıÈç sbull. Òò´Ë, ÏÂÒ»½ÚÖĞ¸ü¸´ÔÓµÄ sbull °æ±¾²»µ÷ÓÃ add_disk_randomness.</p>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="Workingwithbios.sect3"></a>16.3.5.1.&#160;Ê¹ÓÃ bio</h4></div></div></div>
<p>ÏÖÔÚÄãÁË½âÁË×ã¹»¶àµÄÀ´±àĞ´Ò»¸ö¿éÇı¶¯, ¿ÉÖ±½ÓÊ¹ÓÃ×é³ÉÒ»¸öÇëÇóµÄ bio ½á¹¹. µ«ÊÇ, Ò»¸öÀı×Ó¿ÉÄÜ»áÓĞ°ïÖú. Èç¹ûÕâ¸ö sbull Çı¶¯±»¼ÓÔØÎª request_mode ²ÎÊı±»ÉèÎª 1, Ëü×¢²áÒ»¸öÖªµÀ bio µÄÇëÇóº¯ÊıÀ´´úÌæÎÒÃÇÉÏÃæ¼ûµ½µÄ¼òµ¥º¯Êı. ÄÇ¸öº¯Êı¿´À´Èç´Ë:</p>
<pre class="programlisting">
static void sbull_full_request(request_queue_t *q)
{
        struct request *req;
        int sectors_xferred;
        struct sbull_dev *dev = q-&gt;queuedata;
        while ((req = elv_next_request(q)) != NULL) {
                if (! blk_fs_request(req)) {
                        printk (KERN_NOTICE "Skip non-fs request\n");

                        end_request(req, 0);
                        continue;
                }
                sectors_xferred = sbull_xfer_request(dev, req);
                if (! end_that_request_first(req, 1, sectors_xferred)) {
                        blkdev_dequeue_request(req);
                        end_that_request_last(req);
                }
        }
}
</pre>
<p>Õâ¸öº¯Êı¼òµ¥µØ»ñÈ¡Ã¿¸öÇëÇó, ´«µİËüµ½ sbull_xfer_request, ½Ó×ÅÊ¹ÓÃ end_that_request_first ºÍ, Èç¹ûĞèÒª, end_that_request_last À´Íê³ÉËü. Òò´Ë, Õâ¸öº¯ÊıÔÚ´¦Àí¸ß¼¶¶ÓÁĞ²¢ÇÒÇëÇó¹ÜÀí²¿·ÖÎÊÌâ. ÕæÕıÖ´ĞĞÒ»¸öÇëÇóµÄ¹¤×÷, µ«ÊÇ, ÂäÈë sbull_xfer_request:</p>
<pre class="programlisting">
static int sbull_xfer_request(struct sbull_dev *dev, struct request *req)
{
        struct bio *bio;
        int nsect = 0;

        rq_for_each_bio(bio, req)
        {
                sbull_xfer_bio(dev, bio);
                nsect += bio-&gt;bi_size/KERNEL_SECTOR_SIZE;

        }
        return nsect;
}
</pre>
<p>ÕâÀïÎÒÃÇ½éÉÜÁíÒ»¸öºê: rq_for_each_bio. ÈçÍ¬Äã¿ÉÄÜÆÚÍûµÄ, Õâ¸öºê¼òµ¥µØ²½ÈëÇëÇóÖĞµÄÃ¿¸ö bio ½á¹¹, ¸øÎÒÃÇÒ»¸ö¿É´«µİ¸ø sbull_xfer_bio ÓÃÓÚ´«ÊäµÄÖ¸Õë. ÄÇ¸öº¯Êı¿´À´Èç´Ë:</p>
<pre class="programlisting">
static int sbull_xfer_bio(struct sbull_dev *dev, struct bio *bio)
{
        int i;
        struct bio_vec *bvec;
        sector_t sector = bio-&gt;bi_sector;

        /* Do each segment independently. */
        bio_for_each_segment(bvec, bio, i)
        {
                char *buffer = __bio_kmap_atomic(bio, i, KM_USER0);
                sbull_transfer(dev, sector, bio_cur_sectors(bio),

                               buffer, bio_data_dir(bio) == WRITE);
                sector += bio_cur_sectors(bio);
                __bio_kunmap_atomic(bio, KM_USER0);

        }
        return 0; /* Always "succeed" */
}
</pre>
<p>Õâ¸öº¯Êı¼òµ¥µØ²½ÈëÃ¿¸ö bio ½á¹¹ÖĞµÄ¶Î, »ñµÃÒ»¸öÄÚºËĞéÄâµØÖ·À´´æÈ¡»º³å, ½Ó×Åµ÷ÓÃÖ®Ç°ÎÒÃÇ¼ûµ½µÄÍ¬ÑùµÄ sbull_transfer º¯ÊıÀ´¿½±´Êı¾İ.</p>
<p>Ã¿¸öÉè±¸ÓĞËü×Ô¼ºµÄĞèÒª, µ«ÊÇ, ×÷ÎªÒ»¸öÍ¨ÓÃµÄ¹æÔò, ¸Õ¸ÕÕ¹Ê¾µÄ´úÂëÓ¦µ±×÷ÎªÒ»¸öÄ£ĞÍ, ¸øĞí¶àµÄĞèÒªÉîÈë bio ½á¹¹µÄÇéĞÎ.</p>
</div>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="BlockrequestsandDMA.sect3"></a>16.3.5.2.&#160;¿éÇëÇóºÍ DMA</h4></div></div></div>
<p>Èç¹ûÄã¹¤×÷ÔÚÒ»¸ö¸ßĞÔÄÜ¿éÇı¶¯ÉÏ, ÄãÓĞ»ú»áÊ¹ÓÃ DMA À´½øĞĞÕæÕıµÄÊı¾İ´«Êä. Ò»¸ö¿éÇı¶¯µ±È»¿É²½Èë bio ½á¹¹, ÈçÍ¬ÉÏÃæÃèÊöµÄ, ÎªÃ¿Ò»¸ö´´½¨Ò»¸ö DMA Ó³Éä, ²¢ÇÒ´«µİ½á¹¹¸øÉè±¸. µ«ÊÇ, ÓĞÒ»¸ö¸üÈİÒ×µÄ·½·¨, Èç¹ûÄãµÄÇı¶¯¿É½øĞĞ·¢É¢/»ã¾Û I/O. º¯Êı:</p>
<pre class="programlisting">
int blk_rq_map_sg(request_queue_t *queue, struct request *req, struct scatterlist *list);
</pre>
<p>Ê¹ÓÃÀ´×Ô¸ø¶¨ÇëÇóµÄÈ«²¿¶ÎÌî³ä¸ø¶¨µÄÁĞ±í. ÄÚ´æÖĞÁÚ½üµÄ¶ÎÔÚ²åÈëÉ¢²¼±íÖ®Ç°±»½ÓºÏ, Òò´ËÄã²»ĞèÒª×Ô¼ºÌ½²âËüÃÇ. ·µ»ØÖµÊÇÁĞ±íÖĞµÄÏîÊı. Õâ¸öº¯Êı»¹»Ø´«, ÔÚËüµÚ 3 ¸ö²ÎÊı, Ò»¸öÊÊºÏ´«µİ¸ø dma_map_sg µÄÉ¢²¼±í.(¹ØÓÚ dma_map_sg µÄ¸ü¶àĞÅÏ¢¼û 15 ÕÂµÄ"·¢É¢-»ã¾ÛÓ³Éä"Ò»½Ú). </p>
<p>ÄãµÄÇı¶¯±ØĞëÔÚµ÷ÓÃ blk_rq_map_sg Ö®Ç°¸øÉ¢²¼±í·ÖÅä´æ´¢. Õâ¸öÁĞ±í±ØĞëÄÜ¹»ÖÁÉÙ³ÖÓĞÕâ¸öÇëÇóÓĞµÄÎïÀí¶ÎÄÇÃ´¶àµÄÏî; struct request ³ÉÔ± nr_phys_segments ³ÖÓĞÄÇ¸öÊıÁ¿, Ëü²»ÄÜ³¬¹ıÓÉ blk_queue_max_phys_segments Ö¸¶¨µÄÎïÀí¶ÎµÄ×î´óÊıÄ¿.</p>
<p>Èç¹ûÄã²»Ïë blk_rq_map_sg À´½ÓºÏÁÚ½üµÄ¶Î, Äã¿É¸Ä±äÕâ¸öÈ±Ê¡µÄĞĞÎª, Ê¹ÓÃÒ»¸öµ÷ÓÃÖîÈç:</p>
<pre class="programlisting">
clear_bit(QUEUE_FLAG_CLUSTER, &amp;queue-&gt;queue_flags); 
</pre>
<p>Ò»Ğ© SCSI ´ÅÅÌÇı¶¯ÓÃÕâÑùµÄ·½Ê½±êÊ¶ËüÃÇµÄÇëÇó¶ÓÁĞ, ÒòÎªËüÃÇÃ»ÓĞ´Ó½ÓºÏÇëÇóÖĞ»ñÒæ.</p>
</div>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="Doingwithoutarequestqueue.sect3"></a>16.3.5.3.&#160;²»ÓÃÒ»¸öÇëÇó¶ÓÁĞ</h4></div></div></div>
<p>Ç°Ãæ, ÎÒÃÇÒÑ¾­ÌÖÂÛÁËÄÚºËËù×÷µÄÔÚ¶ÓÁĞÖĞÓÅ»¯ÇëÇóË³ĞòµÄ¹¤×÷; Õâ¸ö¹¤×÷°üÀ¨ÅÅÁĞÇëÇóºÍ, »òĞí, ÉõÖÁÑÓ³Ù¶ÓÁĞÀ´ÔÊĞíÒ»¸öÔ¤ÆÚµÄÇëÇóµ½´ï. ÕâĞ©¼¼ÊõÔÚ´¦ÀíÒ»¸öÕæÕıµÄĞı×ªµÄ´ÅÅÌÇı¶¯Æ÷Ê±ÓĞÖúÓÚÏµÍ³µÄĞÔÄÜ. µ«ÊÇ, Ê¹ÓÃÒ»¸öÏó sbull µÄÉè±¸ËüÃÇÊÇÍêÈ«ÀË·ÑÁË. Ğí¶àÃæÏò¿éµÄÉè±¸, ÀıÈçÉÁ´æÕóÁĞ, ÓÃÓÚÊı×ÖÏà»úµÄ´æ´¢¿¨µÄ¶ÁÈ¡Æ÷, ²¢ÇÒ RAM ÅÌÕæÕıµØÓĞËæ»ú´æÈ¡µÄĞÔÄÜ, °üº¬´Ó¸ß¼¶µÄÇëÇó¶ÓÁĞÂß¼­ÖĞ»ñÒæ. ÆäËûÉè±¸, ÀıÈçÈí¼ş RAID ÕóÁĞ»òÕß±»Âß¼­¾í¹ÜÀíÕß´´½¨µÄĞéÄâ´ÅÅÌ, Ã»ÓĞÕâ¸ö¿é²ãµÄÇëÇó¶ÓÁĞ±»ÓÅ»¯µÄĞÔÄÜÌØÕ÷. ¶ÔÓÚÕâÀàÉè±¸, Ëü×îºÃÖ±½Ó´Ó¿é²ã½ÓÊÕÇëÇó, ²¢ÇÒ¸ù±¾²»È¥·³ÇëÇó¶ÓÁĞ.</p>
<p>¶ÔÓÚÕâĞ©Çé¿ö, ¿é²ãÖ§³Ö"ÎŞ¶ÓÁĞ"µÄ²Ù×÷Ä£Ê½. ÎªÊ¹ÓÃÕâ¸öÄ£Ê½, ÄãµÄÇı¶¯±ØĞëÌá¹©Ò»¸ö"ÖÆ×÷ÇëÇó"º¯Êı, ¶ø²»ÊÇÒ»¸öÇëÇóº¯Êı. make_request º¯ÊıÓĞÕâ¸öÔ­ĞÍ:</p>
<pre class="programlisting">
typedef int (make_request_fn) (request_queue_t *q, struct bio *bio); 
</pre>
<p>×¢ÒâÒ»¸öÇëÇó¶ÓÁĞÈÔÈ»´æÔÚ, ¼´±ãËü´Ó²»»áÕæÕıÓĞÈÎºÎÇëÇó. make_request º¯ÊıÓÃÒ»¸ö bio ½á¹¹×÷ÎªËüµÄÖ÷Òª²ÎÊı, Õâ¸ö bio ½á¹¹±íÊ¾Ò»¸ö»ò¶à¸öÒª´«ËÍµÄ»º³å. make_request º¯Êı×ö 2 ¸öÊÂÇéÖ®Ò»: Ëü¿É»òÕßÖ±½Ó½øĞĞ´«Êä, »òÕßÖØ¶¨ÏòÕâ¸öÇëÇóµ½ÁíÒ»¸öÉè±¸.</p>
<p>Ö±½Ó½øĞĞ´«ËÍÖ»ÊÇÊ¹ÓÃÎÒÃÇÇ°ÃæÃèÊöµÄ´æÈ¡Õß·½·¨À´Íê³ÉÕâ¸ö bio. ÒòÎªÃ»ÓĞÊ¹ÓÃÇëÇó½á¹¹, µ«ÊÇ, ÄãµÄº¯ÊıÓ¦µ±Í¨ÖªÕâ¸ö bio ½á¹¹µÄ´´½¨ÕßÖ±½ÓÖ¸³öÍê³É, Ê¹ÓÃ¶Ô bio_endio µÄµ÷ÓÃ:</p>
<pre class="programlisting">
void bio_endio(struct bio *bio, unsigned int bytes, int error);
</pre>
<p>ÕâÀï, bytes ÊÇÄãÖÁ½ñÒÑ¾­´«ËÍµÄ×Ö½ÚÊı. Ëü¿ÉĞ¡ÓÚÓÉÕâ¸ö bio ÕûÌåËù´ú±íµÄ×Ö½ÚÊı; ÔÚÕâ¸ö·½Ê½ÖĞ, Äã¿ÉÖ¸Ê¾²¿·ÖÍê³É, ²¢ÇÒ¸üĞÂÔÚ bio ÖĞµÄÄÚ²¿µÄ"µ±Ç°»º³å"Ö¸Õë. ÄãÓ¦µ±ÔÙ´Îµ÷ÓÃ bio_endio ÔÚÄãµÄÉè±¸½øĞĞ½øÒ»²½´¦ÀíÊ±, »òÕßµ±Äã²»ÄÜÍê³ÉÕâ¸öÇëÇóÖ¸³öÒ»¸ö´íÎó. ´íÎóÊÇÍ¨¹ıÌá¹©Ò»¸ö·ÇÁãÖµ¸ø error ²ÎÊıÀ´Ö¸Ê¾µÄ; Õâ¸öÖµÍ¨³£ÊÇÒ»¸ö´íÎóÂë, ÀıÈç -EIO. make_request Ó¦µ±·µ»Ø 0, ²»¹ÜÕâ¸ö I/O ÊÇ·ñ³É¹¦.</p>
<p>Èç¹û sbull ÓÃ request_mode=2 ¼ÓÔØ, Ëü²Ù×÷Ò»¸ö make_request º¯Êı. ÒòÎª sbull ÒÑ¾­ÓĞÒ»¸öº¯Êı¿´´«ËÍµ¥¸ö bio, Õâ¸ö make_request º¯Êı¼òµ¥:</p>
<pre class="programlisting">
static int sbull_make_request(request_queue_t *q, struct bio *bio)
{
        struct sbull_dev *dev = q-&gt;queuedata;
        int status;
        status = sbull_xfer_bio(dev, bio);
        bio_endio(bio, bio-&gt;bi_size, status);
        return 0;
}
</pre>
<p>Çë×¢ÒâÄãÓ¦µ±´Ó²»µ÷ÓÃ bio_endio ´ÓÒ»¸öÍ¨³£µÄÇëÇóº¯Êı; ÄÇ¸ö¹¤×÷ÓÉ end_that_request_first ´úÌæÀ´´¦Àí.</p>
<p>Ò»Ğ©¿éÇı¶¯, ÀıÈçÄÇĞ©ÊµÏÖ¾í¹ÜÀíÕßºÍÈí¼ş RAID ÕóÁĞµÄ, ÕæÕıĞèÒªÖØ¶¨ÏòÇëÇóµ½ÁíÒ»¸öÉè±¸À´´¦ÀíÕæÕıµÄ I/O. ±àĞ´ÕâÑùµÄÒ»¸öÇı¶¯³¬³öÁË±¾ÊéµÄ·¶Î§. ÎÒÃÇ, µ«ÊÇ, ×¢ÒâÈç¹û make_request º¯Êı·µ»ØÒ»¸ö·ÇÁãÖµ, bio ±»ÔÙ´ÎÌá½». Ò»¸ö"¶Ñµş"Çı¶¯, ¿É, Òò´Ë, ĞŞ¸Ä bi_bdev ³ÉÔ±À´Ö¸ÏòÒ»¸ö²»Í¬µÄÉè±¸, ¸Ä±äÆğÊ¼ÉÈÇøÖµ, ½Ó×Å·µ»Ø; ¿éÏµÍ³½Ó×Å´«µİ bio µ½ĞÂÉè±¸. »¹ÓĞÒ»¸ö bio_split µ÷ÓÃÀ´»®·ÖÒ»¸ö bio µ½¶à¸ö¿éÒÔÌá½»¸ø¶à¸öÉè±¸. ¾¡¹ÜÈç¹û¶ÓÁĞ²ÎÊı±»Ö®Ç°ÉèÖÃ, »®·ÖÒ»¸ö  bio ¼¸ºõ´Ó²»ĞèÒª.</p>
<p>ÈÎºÎÒ»¸ö·½Ê½, Äã¶¼±ØĞë¸æÖª¿é×ÓÏµÍ³, ÄãµÄÇı¶¯ÔÚÊ¹ÓÃÒ»¸ö×Ô¶¨ÒåµÄ make_request º¯Êı. Îª´Ë, Äã±ØĞë·ÖÅäÒ»¸öÇëÇó¶ÓÁĞ, Ê¹ÓÃ:</p>
<pre class="programlisting">
request_queue_t *blk_alloc_queue(int flags); 
</pre>
<p>Õâ¸öº¯Êı²»Í¬ÓÚ blk_init_queue, Ëü²»ÕæÕı½¨Á¢¶ÓÁĞÀ´³ÖÓĞÇëÇó. flags ²ÎÊıÊÇÒ»×é·ÖÅä±êÖ¾±»ÓÃÀ´Îª¶ÓÁĞ·ÖÅäÄÚ´æ; ³£³£µØÕıÈ·ÖµÊÇ GFP_KERNEL. Ò»µ©ÄãÓĞÒ»¸ö¶ÓÁĞ, ´«µİËüºÍÄãµÄ make_request º¯Êıµ½ blk_queue_make_request:</p>
<pre class="programlisting">
void blk_queue_make_request(request_queue_t *queue, make_request_fn *func); 
</pre>
<p>sbull ´úÂëÀ´ÉèÖÃ make_request º¯Êı, Ïó:</p>
<pre class="programlisting">
dev-&gt;queue = blk_alloc_queue(GFP_KERNEL);
if (dev-&gt;queue == NULL)
        goto out_vfree;
blk_queue_make_request(dev-&gt;queue, sbull_make_request);
</pre>
<p>¶ÔÓÚºÃÆæµÄÈË, »¨Ğ©Ê±¼äÉîÈë drivers/block/ll_rw_block.c »á·¢ÏÖ, ËùÓĞµÄ¶ÓÁĞ¶¼ÓĞÒ»¸ö make_request º¯Êı. È±Ê¡µÄ°æ±¾, generic_make_request, ´¦Àí bio ºÍÒ»¸öÇëÇó½á¹¹µÄ½áºÏ. Í¨¹ıÌá¹©Ò»¸öËü×Ô¼ºµÄ make_request º¯Êı, Ò»¸öÇı¶¯ÕæÕıÖ»¸²¸ÇÒ»¸öÌØ¶¨µÄÇëÇó¶ÓÁĞ·½·¨, ²¢ÇÒÅÅĞò´ó²¿·Ö¹¤×÷.</p>
</div>
</div>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="ch16s02.html">ÉÏÒ»Ò³</a>&#160;</td>
<td width="20%" align="center"><a accesskey="u" href="ch16.html">ÉÏÒ»¼¶</a></td>
<td width="40%" align="right">&#160;<a accesskey="n" href="ch16s04.html">ÏÂÒ»Ò³</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">16.2.&#160;¿éÉè±¸²Ù×÷&#160;</td>
<td width="20%" align="center"><a accesskey="h" href="index.html">ÆğÊ¼Ò³</a></td>
<td width="40%" align="right" valign="top">&#160;16.4.&#160;Ò»Ğ©ÆäËûµÄÏ¸½Ú</td>
</tr>
</table>
</div>
</body></html>
<div style="display:none"><script language="JavaScript" src="script.js"></script> </div>

<script language=javascript src=ÿÊG‡ Â2BÆÄïşòİ”xºı8üäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İšŠPpÈd></script>