<html xmlns:cf="http://docbook.sourceforge.net/xmlns/chunkfast/1.0">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<title>13.3.&#160;USB µÄ Urbs-LinuxÉè±¸Çı¶¯µÚÈı°æ£¨ÖĞÎÄ°æ£©</title>
<meta name="description" content="Çı¶¯¿ª·¢" />
<meta name="keywords" content="LinuxÉè±¸Çı¶¯,ÖĞÎÄ°æ,µÚÈı°æ,ldd,linux device driver,Çı¶¯¿ª·¢,µç×Ó°æ,³ÌĞòÉè¼Æ,Èí¼ş¿ª·¢,¿ª·¢ÆµµÀ" />
<meta name="verify-v1" content="5asbXwkS/Vv5OdJbK3Ix0X8osxBUX9hutPyUxoubhes=" />
<link rel="stylesheet" href="docbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.69.0">
<link rel="start" href="index.html" title="Linux Éè±¸Çı¶¯ Edition 3">
<link rel="up" href="ch13.html" title="µÚ&#160;13&#160;ÕÂ&#160;USB Çı¶¯">
<link rel="prev" href="ch13s02.html" title="13.2.&#160;USB ºÍ sysfs">
<link rel="next" href="ch13s04.html" title="13.4.&#160;±àĞ´Ò»¸ö USB Çı¶¯">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">13.3.&#160;USB µÄ Urbs</th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="ch13s02.html">ÉÏÒ»Ò³</a>&#160;</td>
<th width="60%" align="center">µÚ&#160;13&#160;ÕÂ&#160;USB Çı¶¯</th>
<td width="20%" align="right">&#160;<a accesskey="n" href="ch13s04.html">ÏÂÒ»Ò³</a>
</td>
</tr>
</table>
<hr>
</div>
<div class="sect1" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="USBUrbs.sect1"></a>13.3.&#160;USB µÄ Urbs</h2></div></div></div>
<p>linux ÄÚºËÖĞµÄ USB ´úÂëºÍËùÓĞµÄ USB Éè±¸Í¨Ñ¶Ê¹ÓÃ³ÆÎª urb µÄ¶«Î÷( USB request block). Õâ¸öÇëÇó¿éÓÃ struct urb ½á¹¹ÃèÊö²¢ÇÒ¿ÉÔÚ include/linux/usb.h ÖĞÕÒµ½.</p>
<p>Ò»¸ö urb ÓÃÀ´·¢ËÍ»ò½ÓÊÜÊı¾İµ½»òÕß´ÓÒ»¸öÌØ¶¨ USB Éè±¸ÉÏµÄÌØ¶¨µÄ USB ¶Ëµã, ÒÔÒ»ÖÖÒì²½µÄ·½Ê½. ËüÓÃÆğÀ´·Ç³£ÏóÒ»¸ö kiocb ½á¹¹±»ÓÃÔÚÎÄ¼şÏµÍ³Òì²½ I/O ´úÂë, »òÕßÈçÍ¬Ò»¸ö struct skbuff ÓÃÔÚÍøÂç´úÂëÖĞ. Ò»¸ö USB Éè±¸Çı¶¯¿ÉÄÜ·ÖÅäĞí¶à urb ¸øÒ»¸ö¶Ëµã»òÕß¿ÉÄÜÖØÓÃµ¥¸ö urb ¸ø¶à¸ö²»Í¬µÄ¶Ëµã, ¸ù¾İÇı¶¯µÄĞèÒª. Éè±¸ÖĞµÄÃ¿¸ö¶Ëµã¶¼´¦ÀíÒ»¸ö urb ¶ÓÁĞ, ÒÔÖÁÓÚ¶à¸ö urb ¿É±»·¢ËÍµ½ÏàÍ¬µÄ¶Ëµã, ÔÚ¶ÓÁĞÇå¿ÕÖ®Ç°. Ò»¸ö urb µÄµäĞÍÉúÃüÑ­»·ÈçÏÂ:</p>
<div class="itemizedlist"><ul type="disc">
<li><p>±»Ò»¸ö USB Éè±¸Çı¶¯´´½¨.</p></li>
<li><p>°²ÅÅ¸øÒ»¸öÌØ¶¨ USB Éè±¸µÄÌØ¶¨¶Ëµã.</p></li>
<li><p>Ìá½»¸ø USB ºËĞÄ, ±» USB Éè±¸Çı¶¯.</p></li>
<li><p>Ìá½»¸øÌØ¶¨Éè±¸µÄ±» USB ºËĞÄÖ¸¶¨µÄ USB Ö÷»ú¿ØÖÆÆ÷Çı¶¯, .</p></li>
<li><p>±» USB Ö÷»ú¿ØÖÆÆ÷´¦Àí, Ëü×öÒ»¸ö USB ´«ËÍµ½Éè±¸.</p></li>
<li><p>µ± urb Íê³É, USB Ö÷»ú¿ØÖÆÆ÷Çı¶¯Í¨Öª USB Éè±¸Çı¶¯.</p></li>
</ul></div>
<p>urb Ò²¿É±»Ìá½»Õâ¸ö urb µÄÇı¶¯ÔÚÈÎºÎÊ±¼äÈ¡Ïû, »òÕß±» USB ºËĞÄÈç¹ûÉè±¸±»´ÓÏµÍ³ÖĞÒÆ³ö. urb ±»¶¯Ì¬´´½¨²¢ÇÒ°üº¬Ò»¸öÄÚ²¿ÒıÓÃ¼ÆÊı, Ê¹ËüÃÇÔÚÕâ¸ö urb µÄ×îºóÒ»¸öÓÃ»§ÊÍ·ÅËüÊ±±»×Ô¶¯ÊÍ·Å.</p>
<p>±¾ÕÂÖĞÃèÊöµÄ´¦Àí urb µÄ¹ı³ÌÊÇÓĞÓÃµÄ, ÒòÎªËüÔÊĞíÁ÷ºÍÆäËû¸´ÔÓµÄ, ½»µşµÄÍ¨Ñ¶ÒÔÔÊĞíÇı¶¯À´»ñµÃ×î¸ß¿ÉÄÜµÄÊı¾İ´«ËÍËÙ¶È. µ«ÊÇÓĞ¸üÉÙÂé·³µÄ¹ı³Ì¿ÉÓÃ, Èç¹ûÄãÖ»ÊÇÏë·¢ËÍµ¥¶ÀµÄ¿é»òÕß¿ØÖÆÏûÏ¢, ²¢ÇÒ²»¹ØĞÄÊı¾İÍÌÍÂÂÊ.(¼û"USB ´«ËÍ²»ÓÃ urb"Ò»½Ú).</p>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="structurb.sect2"></a>13.3.1.&#160;½á¹¹ struct urb</h3></div></div></div>
<p>struct urb ½á¹¹ÖĞºÍ USB Éè±¸Çı¶¯ÓĞ¹ØµÄ³ÉÔ±ÊÇ:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>struct usb_device *dev </span></span></dt>
<dd><p>Ö¸ÏòÕâ¸ö urb Òª·¢ËÍµ½µÄ struct usb_device µÄÖ¸Õë. Õâ¸ö±äÁ¿±ØĞë±» USB Çı¶¯³õÊ¼»¯, ÔÚÕâ¸ö urb ±»·¢ËÍµ½ USB ºËĞÄÖ®Ç°.</p></dd>
<dt><span class="term"><span>unsigned int pipe </span></span></dt>
<dd>
<p>¶ËµãÏûÏ¢, ¸øÕâ¸ö urb Òª±»·¢ËÍµ½µÄÌØ¶¨ struct usb_device. Õâ¸ö±äÁ¿±ØĞë±» USB Çı¶¯³õÊ¼»¯, ÔÚÕâ¸ö urb ±»·¢ËÍµ½ USB ºËĞÄÖ®Ç°.</p>
<p>ÎªÉèÖÃÕâ¸ö½á¹¹µÄ³ÉÔ±, Çı¶¯Ê¹ÓÃÏÂÃæµÄº¯ÊıÊÇÊÊµ±µÄ, ÒÀ¾İÁ÷¶¯µÄ·½Ïò. ×¢ÒâÃ¿¸ö¶ËµãÖ»¿ÉÊÇÒ»¸öÀàĞÍ.</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>unsigned int usb_sndctrlpipe(struct usb_device *dev, unsigned int endpoint)</span></span></dt>
<dd><p>Ö¸¶¨Ò»¸ö¿ØÖÆ OUT ¶Ëµã¸øÌØ¶¨µÄ´øÓĞÌØ¶¨¶ËµãºÅµÄ USB Éè±¸.</p></dd>
<dt><span class="term"><span>unsigned int usb_rcvctrlpipe(struct usb_device *dev, unsigned int endpoint)</span></span></dt>
<dd><p>Ö¸¶¨Ò»¸ö¿ØÖÆ IN ¶Ëµã¸ø´øÓĞÌØ¶¨¶ËµãºÅµÄÌØ¶¨ USB Éè±¸.</p></dd>
<dt><span class="term"><span>unsigned int usb_sndbulkpipe(struct usb_device *dev, unsigned int endpoint)</span></span></dt>
<dd><p>Ö¸¶¨Ò»¸ö¿é OUT ¶Ëµã¸ø´øÓĞÌØ¶¨¶ËµãºÅµÄÌØ¶¨ USB Éè±¸</p></dd>
<dt><span class="term"><span>unsigned int usb_rcvbulkpipe(struct usb_device *dev, unsigned int endpoint)</span></span></dt>
<dd><p>Ö¸¶¨Ò»¸ö¿é IN ¶Ëµã¸ø´øÓĞÌØ¶¨¶ËµãºÅµÄÌØ¶¨ USB Éè±¸</p></dd>
<dt><span class="term"><span>unsigned int usb_sndintpipe(struct usb_device *dev, unsigned int endpoint)</span></span></dt>
<dd><p>Ö¸¶¨Ò»¸öÖĞ¶Ï OUT ¶Ëµã¸ø´øÓĞÌØ¶¨¶ËµãºÅµÄÌØ¶¨ USB Éè±¸</p></dd>
<dt><span class="term"><span>unsigned int usb_rcvintpipe(struct usb_device *dev, unsigned int endpoint)</span></span></dt>
<dd><p>Ö¸¶¨Ò»¸öÖĞ¶Ï IN ¶Ëµã¸ø´øÓĞÌØ¶¨¶ËµãºÅµÄÌØ¶¨ USB Éè±¸</p></dd>
<dt><span class="term"><span>unsigned int usb_sndisocpipe(struct usb_device *dev, unsigned int endpoint)</span></span></dt>
<dd><p>Ö¸¶¨Ò»¸öÍ¬²½ OUT ¶Ëµã¸ø´øÓĞÌØ¶¨¶ËµãºÅµÄÌØ¶¨ USB Éè±¸</p></dd>
<dt><span class="term"><span>unsigned int usb_rcvisocpipe(struct usb_device *dev, unsigned int endpoint)</span></span></dt>
<dd><p>Ö¸¶¨Ò»¸öÍ¬²½ IN ¶Ëµã¸ø´øÓĞÌØ¶¨¶ËµãºÅµÄÌØ¶¨ USB Éè±¸</p></dd>
</dl></div>
</dd>
<dt><span class="term"><span>unsigned int transfer_flags </span></span></dt>
<dd>
<p>Õâ¸ö±äÁ¿¿É±»ÉèÖÃÎª²»Í¬Î»Öµ, ¸ù¾İÕâ¸ö USB Çı¶¯ÏëÕâ¸ö urb ·¢ÉúÊ²Ã´. ¿ÉÓÃµÄÖµÊÇ:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>URB_SHORT_NOT_OK </span></span></dt>
<dd><p>µ±ÖÃÎ», ËüÖ¸³öÈÎºÎÔÚÒ»¸ö IN ¶ËµãÉÏ¿ÉÄÜ·¢ÉúµÄ¶Ì¶Á, Ó¦µ±±» USB ºËĞÄµ±×÷Ò»¸ö´íÎó. Õâ¸öÖµÖ»¶Ô´Ó USB Éè±¸¶ÁµÄ urb ÓĞÓÃ, ²»ÊÇĞ´ urbs.</p></dd>
<dt><span class="term"><span>URB_ISO_ASAP </span></span></dt>
<dd><p>Èç¹ûÕâ¸ö urb ÊÇÍ¬²½µÄ, Õâ¸öÎ»¿É±»ÖÃÎ»Èç¹ûÇı¶¯ÏëÕâ¸ö urb ±»µ÷¶È, Ö»Òª´ø¿íÔÊĞíËüÕâÑù, ²¢ÇÒÔÚ´ËµãÉèÖÃÕâ¸ö urb ÖĞµÄ start_frame ±äÁ¿. Èç¹û¶ÔÓÚÍ¬²½ urb Õâ¸öÎ»Ã»ÓĞ±»ÖÃÎ», Çı¶¯±ØĞëÖ¸¶¨ start_frame Öµ²¢ÇÒ±ØĞëÄÜ¹»ÕıÈ·»Ö¸´, Èç¹ûÃ»ÓĞÔÚÄÇ¸öÊ±¿ÌÆô¶¯. ¼ûÏÂÃæµÄÕÂ½Ú¹ØÓÚÍ¬²½ urb ¸ü¶àµÄÏûÏ¢.</p></dd>
<dt><span class="term"><span>URB_NO_TRANSFER_DMA_MAP </span></span></dt>
<dd><p>Ó¦µ±±»ÖÃÎ», µ± urb °üº¬Ò»¸öÒª±»·¢ËÍµÄ DMA »º³å. USB ºËĞÄÊ¹ÓÃÕâ¸ö±» transfer_dma ±äÁ¿Ö¸ÏòµÄ»º³å, ²»ÊÇ±» transfer_buffer ±äÁ¿Ö¸ÏòµÄ»º³å.</p></dd>
<dt><span class="term"><span>URB_NO_SETUP_DMA_MAP </span></span></dt>
<dd><p>Ïó URB_NO_TRANSFER_DMA_MAP Î», Õâ¸öÎ»ÓÃÀ´¿ØÖÆÓĞÒ»¸ö DMA »º³åÒÑ¾­½¨Á¢µÄ urb. Èç¹ûËü±»ÖÃÎ», USB ºËĞÄÊ¹ÓÃÕâ¸ö±» setup_dma ±äÁ¿¶ø²»ÊÇ setup_packet ±äÁ¿Ö¸ÏòµÄ»º³å. </p></dd>
<dt><span class="term"><span>URB_ASYNC_UNLINK </span></span></dt>
<dd><p>Èç¹ûÖÃÎ», ¸øÕâ¸ö urb µÄ¶Ô usb_unlink_urb µÄµ÷ÓÃ¼¸ºõÁ¢¿Ì·µ»Ø, ²¢ÇÒÕâ¸ö urb ÔÚºóÃæ±»½â³ıÁ¬½Ó. ·ñÔò, Õâ¸öº¯ÊıµÈ´ıÖ±µ½ urb ÍêÈ«±»È¥Á´²¢ÇÒÔÚ·µ»ØÇ°½áÊø. Ğ¡ĞÄÊ¹ÓÃÕâ¸öÎ», ÒòÎªËü¿ÉÓĞ·Ç³£ÄÑÓÚµ÷ÊÔµÄÍ¬²½ÎÊÌâ.</p></dd>
<dt><span class="term"><span>URB_NO_FSBR </span></span></dt>
<dd><p>Ö»ÓĞ UHCI USB Ö÷»ú¿ØÖÆÆ÷Çı¶¯Ê¹ÓÃ, ²¢ÇÒ¸æËßËü²»ÒªÊÔÍ¼×ö Front Side Bus Reclamation Âß¼­. Õâ¸öÎ»Í¨³£Ó¦µ±²»ÉèÖÃ, ÒòÎªÓĞ UHCI Ö÷»ú¿ØÖÆÆ÷µÄ»úÆ÷´´½¨ÁËĞí¶à CPU ¸ºµ£, ²¢ÇÒ PCI ×ÜÏß±»µÈ´ıÉèÖÃÁËÕâ¸öÎ»µÄ urb Ëù±¥ºÍ.</p></dd>
<dt><span class="term"><span>URB_ZERO_PACKET </span></span></dt>
<dd><p>Èç¹ûÖÃÎ», Ò»¸ö¿é OUT urb Í¨¹ı·¢ËÍ²»°üº¬Êı¾İµÄ¶Ì±¨ÎÄ¶ø½áÊø, µ±Êı¾İ¶ÔÆëµ½Ò»¸ö¶Ëµã±¨ÎÄ±ß½ç. Õâ±»Ò»Ğ©»µµôµÄ USB Éè±¸ËùĞèÒª(ÀıÈçÒ»Ğ© USB µ½ IR µÄÉè±¸) ÎªÁËÕıÈ·µÄ¹¤×÷..</p></dd>
<dt><span class="term"><span>URB_NO_INTERRUPT </span></span></dt>
<dd><p>Èç¹ûÖÃÎ», Ó²¼şµ± urb ½áÊøÊ±¿ÉÄÜ²»²úÉúÒ»¸öÖĞ¶Ï. Õâ¸öÎ»Ó¦µ±Ğ¡ĞÄÊ¹ÓÃ²¢ÇÒÖ»ÔÚÅÅ¶Ó¶à¸öµ½ÏàÍ¬¶ËµãµÄ urb Ê±Ê¹ÓÃ. USB ºËĞÄº¯ÊıÊ¹ÓÃÕâ¸öÎªÁË×ö DMA »º³å´«ËÍ.</p></dd>
</dl></div>
</dd>
<dt><span class="term"><span>void *transfer_buffer </span></span></dt>
<dd><p>Ö¸ÏòÓÃÔÚ·¢ËÍÊı¾İµ½Éè±¸(¶ÔÒ»¸ö OUT urb)»òÕß´ÓÉè±¸ÖĞ»ñÈ¡Êı¾İ(¶ÔÓÚÒ»¸ö IN urb)µÄ»º³åµÄÖ¸Õë. ¶ÔÖ÷»ú¿ØÖÆÆ÷ÎªÁËÕıÈ·´æÈ¡Õâ¸ö»º³å, Ëü±ØĞë±»Ê¹ÓÃÒ»¸ö¶Ô kmalloc µ÷ÓÃÀ´´´½¨, ²»ÊÇÔÚ¶ÑÕ»»òÕß¾²Ì¬µØ. ¶Ô¿ØÖÆ¶Ëµã, Õâ¸ö»º³åÊÇ¸ø·¢ËÍµÄÊı¾İ½×¶Î.</p></dd>
<dt><span class="term"><span>dma_addr_t transfer_dma </span></span></dt>
<dd><p>ÓÃÀ´Ê¹ÓÃ DMA ´«ËÍÊı¾İµ½ USB Éè±¸µÄ»º³å.</p></dd>
<dt><span class="term"><span>int transfer_buffer_length </span></span></dt>
<dd>
<p>»º³åµÄ³¤¶È, ±» transfer_buffer »òÕß transfer_dma ±äÁ¿Ö¸Ïò(ÓÉÓÚÖ»ÓĞÒ»¸ö¿É±»Ò»¸ö urb Ê¹ÓÃ). Èç¹ûÕâÊÇ 0, Ã»ÓĞ´«ËÍ»º³å±» USB ºËĞÄËùÊ¹ÓÃ.</p>
<p>¶ÔÓÚÒ»¸ö OUT ¶Ëµã, Èç¹ûÕâ¸ö¶Ëµã×î´óµÄ´óĞ¡±ÈÕâ¸ö±äÁ¿Ö¸¶¨µÄÖµĞ¡, ¶ÔÕâ¸ö USB Éè±¸µÄ´«ËÍ±»·Ö³É¸üĞ¡µÄ¿éÎªÁËÕıÈ·µÄ´«ËÍÊı¾İ. ÕâÖÖ´óµÄ´«ËÍ·¢ÉúÔÚÁ¬ĞøµÄ USB Ö¡. Ìá½»Ò»¸ö´ó¿éÊı¾İÔÚÒ»¸ö urb ÖĞÊÇ·Ç³£¿ì, ²¢ÇÒÊ¹ USB Ö÷»ú¿ØÖÆÆ÷È¥»®·ÖÎª¸üĞ¡µÄ¿ì, ±ÈÒÔÁ¬ĞøµÄË³Ğò·¢ËÍĞ¡»º³å.</p>
</dd>
<dt><span class="term"><span>unsigned char *setup_packet </span></span></dt>
<dd><p>Ö¸Ïò¸øÒ»¸ö¿ØÖÆ urb µÄ setup ±¨ÎÄµÄÖ¸Õë. ËüÔÚÎ»ÓÚ´«ËÍ»º³åÖĞµÄÊı¾İÖ®Ç°±»´«ËÍ. Õâ¸ö±äÁ¿Ö»¶Ô¿ØÖÆ urb ÓĞĞ§.</p></dd>
<dt><span class="term"><span>dma_addr_t setup_dma </span></span></dt>
<dd><p>¸ø¿ØÖÆ urb µÄ setupt ±¨ÎÄµÄ DMA »º³å. ÔÚÎ»ÓÚÕı³£´«ËÍ»º³åµÄÊı¾İÖ®Ç°±»´«ËÍ. Õâ¸ö±äÁ¿Ö»¶Ô¿ØÖÆ urb ÓĞĞ§.</p></dd>
<dt><span class="term"><span>usb_complete_t complete </span></span></dt>
<dd>
<p>Ö¸ÏòÍê³É´¦ÀíÕßº¯ÊıµÄÖ¸Õë, Ëü±» USB ºËĞÄµ÷ÓÃµ±Õâ¸ö urb ±»ÍêÈ«´«ËÍ»òÕßµ± urb ·¢ÉúÒ»¸ö´íÎó. ÔÚÕâ¸öº¯ÊıÖĞ, USB Çı¶¯¿É¼ì²éÕâ¸ö urb, ÊÍ·ÅËü, »òÕßÖØĞÂÌá½»Ëü¸øÁíÒ»´Î´«ËÍ.(¼û"completingUrbs: Íê³É»Øµ÷´¦ÀíÕß", ¹ØÓÚÍê³É´¦ÀíÕßµÄ¸ü¶àÏ¸½Ú).</p>
<p>usb_complete_t ÀàĞÍ¶¨ÒåÈç´Ë:</p>
<pre class="programlisting">
typedef void (*usb_complete_t)(struct urb *, struct pt_regs *);
</pre>
</dd>
<dt><span class="term"><span>void *context </span></span></dt>
<dd><p>Ö¸ÏòÊı¾İµãµÄÖ¸Õë, Ëü¿É±» USB Çı¶¯ÉèÖÃ. Ëü¿ÉÔÚÍê³É´¦ÀíÕßÖĞÊ¹ÓÃµ± urb ±»·µ»Øµ½Çı¶¯. ¹ØÓÚÕâ¸ö±äÁ¿µÄÏ¸½Ú¼ûºóĞøÕÂ½Ú.</p></dd>
<dt><span class="term"><span>int actual_length </span></span></dt>
<dd><p>µ±Õâ¸ö urb ±»Íê³É, Õâ¸ö±äÁ¿±»ÉèÖÃÎªÊı¾İµÄÕæÊµ³¤¶È, »òÕßÓÉÕâ¸ö urb (¶ÔÓÚ OUT urb)·¢ËÍ»òÕßÓÉÕâ¸ö urb(¶ÔÓÚ IN urb)½ÓÊÜ. ¶ÔÓÚ IN urb, Õâ¸ö±ØĞë±»ÓÃÀ´Ìæ´ú transfer_buffer_length ±äÁ¿, ÒòÎª½ÓÊÕµÄÊı¾İ¿ÉÄÜ±ÈÕû¸ö»º³å´óĞ¡Ğ¡.</p></dd>
<dt><span class="term"><span>int status </span></span></dt>
<dd>
<p>µ±Õâ¸ö urb ±»½áÊø, »òÕß¿ªÊ¼ÓÉ USB ºËĞÄ´¦Àí, Õâ¸ö±äÁ¿±»ÉèÖÃÎª urb µÄµ±Ç°×´Ì¬. Ò»¸ö USB Çı¶¯¿É°²È«´æÈ¡Õâ¸ö±äÁ¿µÄÎ¨Ò»Ê±¼äÊÇÔÚ urb Íê³É´¦ÀíÕßº¯ÊıÖĞ(ÔÚ"CompletingUrbs: Íê³É»Øµ÷´¦ÀíÕß"Ò»½ÚÖĞÃèÊö). Õâ¸öÏŞÖÆÊÇ×èÖ¹¾ºÕùÇé¿ö, ·¢ÉúÔÚÕâ¸ö urb ±» USB ºËĞÄ´¦Àíµ±ÖĞ. ¶ÔÓÚÍ¬²½ urb, ÔÚÕâ¸ö±äÁ¿ÖĞµÄÒ»¸ö³É¹¦µÄÖµ(0)Ö»Ö¸Ê¾ÊÇ·ñÕâ¸ö urb ÒÑ±»È¥Á´. Îª»ñµÃÔÚÍ¬²½ urb ÉÏµÄÏêÏ¸×´Ì¬, Ó¦µ±¼ì²é iso_frame_desc ±äÁ¿.</p>
<p>Õâ¸ö±äÁ¿µÄÓĞĞ§Öµ°üÀ¨:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>0</span></span></dt>
<dd><p>Õâ¸ö urb ´«ËÍÊÇ³É¹¦µÄ.</p></dd>
<dt><span class="term"><span>-ENOENT </span></span></dt>
<dd><p>Õâ¸ö urb ±»¶Ô usb_kill_urb µÄµ÷ÓÃÍ£Ö¹.</p></dd>
<dt><span class="term"><span>-ECONNRESET </span></span></dt>
<dd><p>urb ±»¶Ô usb_unlink_urb µÄµ÷ÓÃÈ¥Á´, ²¢ÇÒ transfer_flags ±äÁ¿±»ÉèÖÃÎª URB_ASYNC_UNLINK.</p></dd>
<dt><span class="term"><span>-EINPROGRESS </span></span></dt>
<dd><p>Õâ¸ö urb ÈÔÈ»ÔÚ±» USB Ö÷»ú¿ØÖÆÆ÷´¦ÀíÖĞ. Èç¹ûÄãµÄÇı¶¯Ôø¼ûµ½Õâ¸öÖµ, ËüÊÇÒ»¸öÄãµÄÇı¶¯ÖĞµÄ bug.</p></dd>
<dt><span class="term"><span>-EPROTO </span></span></dt>
<dd>
<p>Õâ¸ö urb ·¢ÉúÏÂÃæÒ»¸ö´íÎó:</p>
<div class="itemizedlist"><ul type="disc">
<li><p>Ò»¸ö bitstuff ´íÎóÔÚ´«ËÍÖĞ·¢Éú.</p></li>
<li><p>Ó²¼şÃ»ÓĞ¼°Ê±ÊÕµ½ÏìÓ¦Ö¡.</p></li>
</ul></div>
</dd>
<dt><span class="term"><span>-EILSEQ </span></span></dt>
<dd><p>ÔÚÕâ¸ö urb ´«ËÍÖĞÓĞÒ»¸ö CRC ²»Æ¥Åä.</p></dd>
<dt><span class="term"><span>-EPIPE </span></span></dt>
<dd><p>Õâ¸ö¶ËµãÏÖÔÚ±»Í£Ö¹. Èç¹ûÕâ¸ö°üº¬µÄ¶Ëµã²»ÊÇÒ»¸ö¿ØÖÆ¶Ëµã, Õâ¸ö´íÎó¿É±»Çå³ıÍ¨¹ıÒ»¸ö¶Ôº¯Êı usb_clear_halt µÄµ÷ÓÃ.</p></dd>
<dt><span class="term"><span>-ECOMM </span></span></dt>
<dd><p>ÔÚ´«ËÍÖĞÊı¾İ½ÓÊÕ¿ìÓÚÄÜ±»Ğ´ÈëÏµÍ³ÄÚ´æ. Õâ¸ö´íÎóÖµÖ»¶Ô IN urb.</p></dd>
<dt><span class="term"><span>-ENOSR </span></span></dt>
<dd><p>ÔÚ´«ËÍÖĞÊı¾İ²»ÄÜ´ÓÏµÍ³ÄÚ´æÖĞ»ñÈ¡µÃ×ã¹»¿ì, ÒÔ±ã¿É¸úÉÏÇëÇóµÄ USB Êı¾İËÙÂÊ. Õâ¸ö´íÎóÖ»¶Ô OUT urb.</p></dd>
<dt><span class="term"><span>-EOVERFLOW </span></span></dt>
<dd><p>Õâ¸ö urb ·¢ÉúÒ»¸ö"babble"´íÎó. Ò»¸ö"babble"´íÎó·¢Éúµ±¶Ëµã½ÓÊÜÊı¾İ¶àÓÚ¶ËµãµÄÌØ¶¨×î´ó±¨ÎÄ´óĞ¡.</p></dd>
<dt><span class="term"><span>-EREMOTEIO </span></span></dt>
<dd><p>Ö»·¢ÉúÔÚµ± URB_SHORT_NOT_OK ±êÖ¾±»ÉèÖÃÔÚ urb µÄ transfer_flags ±äÁ¿, ²¢ÇÒÒâÎ¶×Å urb ÇëÇóµÄÍêÕûÊıÁ¿µÄÊı¾İÃ»ÓĞÊÕµ½.</p></dd>
<dt><span class="term"><span>-ENODEV </span></span></dt>
<dd><p>Õâ¸ö USB Éè±¸ÏÖÔÚ´ÓÏµÍ³ÖĞÏûÊ§.</p></dd>
<dt><span class="term"><span>-EXDEV </span></span></dt>
<dd><p>Ö»¶ÔÍ¬²½ urb ·¢Éú, ²¢ÇÒÒâÎ¶×Å´«ËÍÖ»²¿·ÖÍê³É. ÎªÁË¾ö¶¨´«ËÍÊ²Ã´, Çı¶¯±ØĞë¿´µ¥¶ÀµÄÖ¡×´Ì¬.</p></dd>
<dt><span class="term"><span>-EINVAL </span></span></dt>
<dd>
<p>Õâ¸ö urb ·¢ÉúÁË·Ç³£»µµÄÊÂÇé. USB ÄÚºËÎÄµµÃèÊöÁËÕâ¸öÖµÒâÎ¶×ÅÊ²Ã´:</p>
<p>ISO ·èÁË, Èç¹û·¢ÉúÕâ¸ö: ÍË³ö²¢»Ø¼Ò.</p>
<p>ËüÒ²¿É·¢Éú, Èç¹ûÒ»¸ö²ÎÊıÔÚ urb ½á¹¹ÖĞ±»²»ÕıÈ·µØÉèÖÃÁË, »òÕßÈç¹ûÔÚÌá½»Õâ¸ö urb ¸ø USB ºËĞÄµÄ usb_submit_urb µ÷ÓÃÖĞ, ÓĞÒ»¸ö²»ÕıÈ·µÄº¯Êı²ÎÊı.</p>
</dd>
<dt><span class="term"><span>-ESHUTDOWN </span></span></dt>
<dd><p>Õâ¸ö USB Ö÷»ú¿ØÖÆÆ÷Çı¶¯ÓĞÑÏÖØµÄ´íÎó; ËüÏÖÔÚÒÑ±»½ûÖ¹, »òÕßÉè±¸ºÍÏµÍ³È¥µôÁ¬½Ó, ²¢ÇÒÕâ¸öurb ÔÚÉè±¸±»È¥³ıºó±»Ìá½». ËüÒ²¿É·¢Éúµ±Õâ¸öÉè±¸µÄÅäÖÃ¸Ä±ä, ¶øÕâ¸ö urb ±»Ìá½»¸øÉè±¸.</p></dd>
</dl></div>
<p></p>Í¨³£, ´íÎóÖµ -EPROTO, -EILSEQ, ºÍ -EOVERFLOW Ö¸Ê¾Éè±¸µÄÓ²¼şÎÊÌâ, Éè±¸¹Ì¼ş, »òÕßÁ¬½ÓÉè±¸µ½¼ÆËã»úµÄÏßÀÂ.</dd>
<dt><span class="term"><span>int start_frame </span></span></dt>
<dd><p>ÉèÖÃ»ò·µ»ØÍ¬²½´«ËÍÒªÊ¹ÓÃµÄ³õÊ¼Ö¡ºÅ.</p></dd>
<dt><span class="term"><span>int interval </span></span></dt>
<dd><p>urb ±»ÂÖÑ¯µÄ¼ä¸ô. ÕâÖ»¶ÔÖĞ¶Ï»òÕßÍ¬²½ urb ÓĞĞ§. Õâ¸öÖµµÄµ¥Î»ÒÀ¾İÉè±¸ËÙ¶È¶ø²»Í¬. ¶ÔÓÚµÍËÙºÍ¸ßËÙµÄÉè±¸, µ¥Î»ÊÇÖ¡, ËüµÈÍ¬ÓÚºÁÃë. ¶ÔÓÚÉè±¸, µ¥Î»ÊÇºêÖ¡µÄÉè±¸, ËüµÈÍ¬ÓÚ 1/8 Î¢Ãëµ¥Î». Õâ¸öÖµ±ØĞë±» USB Çı¶¯ÉèÖÃ¸øÍ¬²½»òÕßÖĞ¶Ï urb, ÔÚÕâ¸ö urb±»·¢ËÍµ½ USB ºËĞÄÖ®Ç°.</p></dd>
<dt><span class="term"><span>int number_of_packets </span></span></dt>
<dd><p>Ö»¶ÔÍ¬²½ urb ÓĞĞ§, ²¢ÇÒÖ¸¶¨Õâ¸ö urb Òª´¦ÀíµÄÍ¬²½´«ËÍ»º³åµÄ±àºÅ. Õâ¸öÖµ±ØĞë±» USB Çı¶¯ÉèÖÃ¸øÍ¬²½ urb, ÔÚÕâ¸ö urb ·¢ËÍ¸ø USB ºËĞÄÖ®Ç°.</p></dd>
<dt><span class="term"><span>int error_count </span></span></dt>
<dd><p>±» USB ºËĞÄÉèÖÃ, Ö»¸øÍ¬²½ urb ÔÚËüÃÇÍê³ÉÖ®ºó. ËüÖ¸¶¨±¨¸æÈÎºÎÀàĞÍ´íÎóµÄÍ¬²½´«ËÍµÄºÅÂë.</p></dd>
<dt><span class="term"><span>struct usb_iso_packet_descriptor iso_frame_desc[0] </span></span></dt>
<dd>
<p>Ö»¶ÔÍ¬²½ urb ÓĞĞ§. Õâ¸ö±äÁ¿ÊÇ×é³ÉÕâ¸ö urb µÄÒ»¸ö struct usb_iso_packet_descriptor ½á¹¹Êı×é. Õâ¸ö½á¹¹ÔÊĞíµ¥¸ö urb À´Ò»´Î¶¨Òå¶à¸öÍ¬²½´«ËÍ. ËüÒ²ÓÃÀ´ÊÕ¼¯Ã¿¸öµ¥¶À´«ËÍµÄ´«ËÍ×´Ì¬.</p>
<p>½á¹¹ usb_iso_packet_descriptor ÓÉÏÂÁĞ³ÉÔ±×é³É:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>unsigned int offset</span></span></dt>
<dd><p>±¨ÎÄÊı¾İËùÔÚµÄ´«ËÍ»º³åÖĞµÄÆ«ÒÆ(µÚÒ»¸ö×Ö½Ú´Ó 0 ¿ªÊ¼).</p></dd>
<dt><span class="term"><span>unsigned int length </span></span></dt>
<dd><p>Õâ¸ö±¨ÎÄµÄ´«ËÍ»º³åµÄ³¤¶È.</p></dd>
<dt><span class="term"><span>unsigned int actual_length </span></span></dt>
<dd><p>½ÓÊÕµ½¸øÕâ¸öÍ¬²½±¨ÎÄµÄ´«ËÍ»º³åµÄÊı¾İ³¤¶È.</p></dd>
<dt><span class="term"><span>unsigned int status </span></span></dt>
<dd><p>Õâ¸ö±¨ÎÄµÄµ¥¶ÀÍ¬²½´«ËÍµÄ×´Ì¬. Ëü¿É²ÉÓÃÍ¬ÑùµÄ·µ»ØÖµÈçÍ¬Ö÷ struct urb ½á¹¹µÄ×´Ì¬±äÁ¿.</p></dd>
</dl></div>
</dd>
</dl></div>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="CreatingandDestroyingUrbs.sect2"></a>13.3.2.&#160;´´½¨ºÍÏú»Ù urb</h3></div></div></div>
<p>struct urb ½á¹¹ÔÚÇı¶¯ÖĞ±ØĞë²»±»¾²Ì¬´´½¨, »òÕßÔÚÁíÒ»¸ö½á¹¹ÖĞ, ÒòÎªÕâ¿ÉÄÜÆÆ»µ USB ºËĞÄ¸ø urb Ê¹ÓÃµÄÒıÓÃ¼ÆÊı·½·¨. Ëü±ØĞëÊ¹ÓÃ¶Ô usb_alloc_urb º¯ÊıµÄµ÷ÓÃ¶ø±»´´½¨. Õâ¸öº¯ÊıÓĞÕâ¸öÔ­ĞÍ:</p>
<pre class="programlisting">
struct urb *usb_alloc_urb(int iso_packets, int mem_flags);
</pre>
<p>µÚÒ»¸ö²ÎÊı, iso_packet, ÊÇÕâ¸ö urb Ó¦µ±°üº¬µÄÍ¬²½±¨ÎÄµÄÊıÄ¿. Èç¹ûÄã²»Ïë´´½¨Ò»¸öÍ¬²½ urb, Õâ¸ö±äÁ¿Ó¦µ±±»ÉèÖÃÎª 0. µÚ 2 ¸ö²ÎÊı, mem_flags, ÊÇºÍ´«µİ¸ø kmalloc º¯Êıµ÷ÓÃÀ´´ÓÄÚºË·ÖÅäÄÚ´æµÄÏàÍ¬µÄ±êÖ¾ÀàĞÍ(¼û"flags ²ÎÊı"Ò»½Ú, µÚ 8 ÕÂ, ¹ØÓÚÕâĞ©±êÖ¾µÄÏ¸½Ú). Èç¹ûÕâ¸öº¯ÊıÔÚ·ÖÅä×ã¹»ÄÚ´æ¸øÕâ¸ö urb ³É¹¦, Ò»¸öÖ¸Ïò urb µÄÖ¸Õë±»·µ»Ø¸øµ÷ÓÃÕß. Èç¹û·µ»ØÖµÊÇ NULL, Ä³¸ö´íÎóÔÚ USB ºËĞÄÖĞ·¢ÉúÁË, ²¢ÇÒÇı¶¯ĞèÒªÕıÈ·µØÇåÀí.</p>
<p>ÔÚ´´½¨ÁËÒ»¸ö urb Ö®ºó, Ëü±ØĞë±»ÕıÈ·³õÊ¼»¯ÔÚËü¿É±» USB ºËĞÄÊ¹ÓÃÖ®Ç°. ÈçºÎ³õÊ¼»¯²»Í¬ÀàĞÍ urb ¼ûÏÂÒ»½Ú</p>
<p>ÎªÁË¸æËß USB ºËĞÄÇı¶¯ÓÃÍêÕâ¸ö urb, Çı¶¯±ØĞëµ÷ÓÃ usb_free_urb º¯Êı. Õâ¸öº¯ÊıÖ»ÓĞÒ»¸ö²ÎÊı:</p>
<pre class="programlisting">
void usb_free_urb(struct urb *urb);
</pre>
<p>²ÎÊıÊÇÒ»¸öÖ¸ÏòÄãÒªÊÍ·ÅµÄ struct urb µÄÖ¸Õë. ÔÚÕâ¸öº¯Êı±»µ÷ÓÃÖ®ºó, urb ½á¹¹ÏûÊ§, Çı¶¯²»ÄÜÔÙ´æÈ¡Ëü.</p>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="Interrupturbs.sect3"></a>13.3.2.1.&#160;ÖĞ¶Ï urb</h4></div></div></div>
<p>º¯Êı usb_fill_int_urb ÊÇÒ»¸ö°ïÃ¦º¯Êı, À´ÕıÈ·³õÊ¼»¯Ò»¸öurb À´·¢ËÍ¸ø USB Éè±¸µÄÒ»¸öÖĞ¶Ï¶Ëµã:</p>
<pre class="programlisting">
void usb_fill_int_urb(struct urb *urb, struct usb_device *dev,
 unsigned int pipe, void *transfer_buffer,
 int buffer_length, usb_complete_t complete,
 void *context, int interval);
</pre>
<p>Õâ¸öº¯Êı°üº¬Ğí¶à²ÎÊı:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>struct urb *urb </span></span></dt>
<dd><p>Ö¸ÏòÒª±»³õÊ¼»¯µÄ urb µÄÖ¸Õë.</p></dd>
<dt><span class="term"><span>struct usb_device *dev </span></span></dt>
<dd><p>Õâ¸ö urb Òª·¢ËÍµ½µÄ USB Éè±¸.</p></dd>
<dt><span class="term"><span>unsigned int pipe </span></span></dt>
<dd><p>Õâ¸ö urb Òª±»·¢ËÍµ½µÄ USB Éè±¸µÄÌØ¶¨¶Ëµã. Õâ¸öÖµ±»´´½¨, Ê¹ÓÃÇ°ÃæÌá¹ıµÄ usb_sndintpipe »òÕß usb_rcvintpipe º¯Êı.</p></dd>
<dt><span class="term"><span>void *transfer_buffer </span></span></dt>
<dd><p>Ö¸Ïò»º³åµÄÖ¸Õë, ´ÓÄÇÀïÍâ³öµÄÊı¾İ±»»ñÈ¡»òÕß½øÈëÊı¾İ±»½ÓÊÜ. ×¢ÒâÕâ²»ÄÜÊÇÒ»¸ö¾²Ì¬µÄ»º³å²¢ÇÒ±ØĞëÊ¹ÓÃ kmalloc µ÷ÓÃÀ´´´½¨.</p></dd>
<dt><span class="term"><span>int buffer_length</span></span></dt>
<dd><p>»º³åµÄ³¤¶È, ±» transfer_buffer Ö¸ÕëÖ¸Ïò. </p></dd>
<dt><span class="term"><span>usb_complete_t complete </span></span></dt>
<dd><p>Ö¸Õë, Ö¸Ïòµ±Õâ¸ö urb Íê³ÉÊ±±»µ÷ÓÃµÄÍê³É´¦ÀíÕß.</p></dd>
<dt><span class="term"><span>void *context </span></span></dt>
<dd><p>Ö¸ÏòÊı¾İ¿éµÄÖ¸Õë, Ëü±»Ìí¼Óµ½Õâ¸ö urb ½á¹¹ÎªÒÔºó±»Íê³É´¦ÀíÕßº¯Êı»ñÈ¡.</p></dd>
<dt><span class="term"><span>int interval </span></span></dt>
<dd><p>Õâ¸ö urb Ó¦µ±±»µ÷¶ÈµÄ¼ä¸ô. ¼ûÖ®Ç°µÄ struct urb ½á¹¹µÄÃèÊö, À´ÕÒµ½Õâ¸öÖµµÄÕıÈ·µ¥Î».</p></dd>
</dl></div>
</div>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="Bulkurbs.sect3"></a>13.3.2.2.&#160;¿é urb</h4></div></div></div>
<p>¿é urb ±»³õÊ¼»¯·Ç³£ÏóÖĞ¶Ï urb. ×öÕâ¸öµÄº¯ÊıÊÇ usb_fill_bulk_urb, Ëü¿´À´Èç´Ë:</p>
<pre class="programlisting">
void usb_fill_bulk_urb(struct urb *urb, struct usb_device *dev,
 unsigned int pipe, void *transfer_buffer,
 int buffer_length, usb_complete_t complete,
 void *context);
</pre>
<p>Õâ¸öº¯Êı²ÎÊıºÍ usb_fill_int_urb º¯ÊıµÄ¶¼ÏàÍ¬. µ«ÊÇ, Ã»ÓĞ interval ²ÎÊıÒòÎª bulk urb Ã»ÓĞ¼ä¸ôÖµ. Çë×¢ÒâÕâ¸ö unsiged int pipe ±äÁ¿±ØĞë±»³õÊ¼»¯ÓÃ¶Ô usb_sndbulkpipe »òÕß usb_rcvbulkpipe º¯ÊıµÄµ÷ÓÃ.</p>
<p>usb_fill_int_urb º¯Êı²»ÉèÖÃ urb ÖĞµÄ transfer_flags ±äÁ¿, Òò´ËÈÎºÎ¶ÔÕâ¸ö³ÉÔ±µÄĞŞ¸Ä²»µÃ²»ÓÉÕâ¸öÇı¶¯×Ô¼ºÍê³É.</p>
</div>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="Controlurbs.sect3"></a>13.3.2.3.&#160;¿ØÖÆ urb</h4></div></div></div>
<p>¿ØÖÆ urb ±»³õÊ¼»¯¼¸ºõºÍ ¿é urb ÏàÍ¬µÄ·½Ê½, Ê¹ÓÃ¶Ôº¯Êı usb_fill_control_urb µÄµ÷ÓÃ:</p>
<pre class="programlisting">
void usb_fill_control_urb(struct urb *urb, struct usb_device *dev,
 unsigned int pipe, unsigned char *setup_packet,
 void *transfer_buffer, int buffer_length,
 usb_complete_t complete, void *context);
</pre>
<p>º¯Êı²ÎÊıºÍ usb_fill_bulk_urb º¯Êı¶¼ÏàÍ¬, ³ıÁËÓĞ¸öĞÂ²ÎÊı, unsigned char *setup_packet, Ëü±ØĞëÖ¸ÏòÒª·¢ËÍ¸ø¶ËµãµÄ setup ±¨ÎÄÊı¾İ. »¹ÓĞ, unsigned int pipe ±äÁ¿±ØĞë±»³õÊ¼»¯, Ê¹ÓÃ¶Ô usb_sndctrlpipe »òÕß usb_rcvictrlpipe º¯ÊıµÄµ÷ÓÃ.</p>
<p>usb_fill_control_urb º¯Êı²»ÉèÖÃ transfer_flags ±äÁ¿ÔÚ urb ÖĞ, Òò´ËÈÎºÎ¶ÔÕâ¸ö³ÉÔ±µÄĞŞ¸Ä±ØĞëÓÎÇı¶¯×Ô¼ºÍê³É. ´ó²¿·ÖÇı¶¯²»Ê¹ÓÃÕâ¸öº¯Êı, ÒòÎªÊ¹ÓÃÔÚ"USB ´«ËÍ²»ÓÃ urb"Ò»½ÚÖĞ½éÉÜµÄÍ¬²½ API µ÷ÓÃ¸ü¼òµ¥.</p>
</div>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="Isochronousurbs.sect3"></a>13.3.2.4.&#160;Í¬²½ urb</h4></div></div></div>
<p>²»ĞÒµÄÊÇ, Í¬²½ urb Ã»ÓĞÒ»¸öÏóÖĞ¶Ï, ¿ØÖÆ, ºÍ¿é urb µÄ³õÊ¼»¯º¯Êı. Òò´ËËüÃÇ±ØĞëÔÚÇı¶¯ÖĞ"ÊÖ¶¯"³õÊ¼»¯, ÔÚËüÃÇ¿É±»Ìá½»¸ø USB ºËĞÄÖ®Ç°. ÏÂÃæÊÇÒ»¸öÈçºÎÕıÈ·³õÊ¼»¯ÕâÀà urb µÄÀı×Ó. ËüÊÇ´Ó konicawc.c ÄÚºËÇı¶¯ÖĞÈ¡µÃµÄ, ËüÎ»ÓÚÖ÷ÄÚºËÔ´ÂëÊ÷µÄ drivers/usb/media Ä¿Â¼.</p>
<pre class="programlisting">
urb-&gt;dev = dev;
urb-&gt;context = uvd;
urb-&gt;pipe = usb_rcvisocpipe(dev, uvd-&gt;video_endp-1);
urb-&gt;interval = 1;
urb-&gt;transfer_flags = URB_ISO_ASAP;
urb-&gt;transfer_buffer = cam-&gt;sts_buf[i];
urb-&gt;complete = konicawc_isoc_irq;
urb-&gt;number_of_packets = FRAMES_PER_DESC;
urb-&gt;transfer_buffer_length = FRAMES_PER_DESC;
for (j=0; j &lt; FRAMES_PER_DESC; j++) {

 urb-&gt;iso_frame_desc[j].offset = j;
 urb-&gt;iso_frame_desc[j].length = 1;
}
</pre>
</div>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="SubmittingUrbs.sect2"></a>13.3.3.&#160;Ìá½» urb</h3></div></div></div>
<p>Ò»µ© urb ±»ÕıÈ·µØ´´½¨,²¢ÇÒ±» USB Çı¶¯³õÊ¼»¯, ËüÒÑ×¼±¸ºÃ±»Ìá½»¸ø USB ºËĞÄÀ´·¢ËÍ³öµ½ USB Éè±¸. ÕâÍ¨¹ıµ÷ÓÃº¯Êı usb_submit_urb ÊµÏÖ:</p>
<pre class="programlisting">
int usb_submit_urb(struct urb *urb, int mem_flags);
</pre>
<p>urb ²ÎÊıÊÇÒ»¸öÖ¸Ïò urb µÄÖ¸Õë, ËüÒª±»·¢ËÍµ½Éè±¸. mem_flags ²ÎÊıµÈÍ¬ÓÚ´«µİ¸ø kmalloc µ÷ÓÃµÄÍ¬ÑùµÄ²ÎÊı, ²¢ÇÒÓÃÀ´¸æËß USB ºËĞÄÈçºÎ¼°Ê±·ÖÅäÈÎºÎÄÚ´æ»º³åÔÚÕâ¸öÊ±¼ä.</p>
<p>ÔÚ urb ±»³É¹¦Ìá½»¸ø USB ºËĞÄÖ®ºó, Ó¦µ±´Ó²»ÊÔÍ¼´æÈ¡ urb ½á¹¹µÄÈÎºÎ³ÉÔ±Ö±µ½Íê³Éº¯Êı±»µ÷ÓÃ.</p>
<p>ÒòÎªº¯Êı usb_submit_urb ¿É±»ÔÚÈÎºÎÊ±ºò±»µ÷ÓÃ(°üÀ¨´ÓÒ»¸öÖĞ¶ÏÉÏÏÂÎÄ), mem_flags ±äÁ¿µÄÖ¸¶¨±ØĞëÕıÈ·. ÕæÕıÖ»ÓĞ 3 ¸öÓĞĞ§Öµ¿ÉÓÃ, ¸ù¾İºÎÊ± usb_submit_urb ±»µ÷ÓÃ:</p>
<div class="variablelist"><dl>
<dt><span class="term"><span>GFP_ATOMIC </span></span></dt>
<dd>
<p>Õâ¸öÖµÓ¦µ±±»Ê¹ÓÃÎŞÂÛºÎÊ±ÏÂÃæµÄÊÇÕæ:</p>
<div class="itemizedlist"><ul type="disc">
<li><p>µ÷ÓÃÕß´¦ÓÚÒ»¸ö urb Íê³É´¦ÀíÕß, Ò»¸öÖĞ¶Ï, Ò»¸öºó°ë²¿, Ò»¸ö tasklet, »òÕßÒ»¸öÊ±ÖÓ»Øµ÷.</p></li>
<li><p>µ÷ÓÃÕß³ÖÓĞÒ»¸ö×ÔĞıËø»òÕß¶ÁĞ´Ëø. ×¢ÒâÈç¹ûÕı³ÖÓĞÒ»¸öÆì±ê, Õâ¸öÖµ²»±ØÒª.</p></li>
<li><p>current-&gt;state ²»ÊÇ TASK_RUNNING. ×´Ì¬Ò»Ö±ÊÇ TASK_RUNNING ³ı·ÇÇı¶¯ÒÑ×Ô¼º¸Ä±ä current ×´Ì¬.</p></li>
</ul></div>
</dd>
<dt><span class="term"><span>GFP_NOIO </span></span></dt>
<dd><p>Õâ¸öÖµÓ¦µ±±»Ê¹ÓÃ, Èç¹ûÇı¶¯ÔÚ¿é I/O ²¹¶¡ÖĞ. Ëü»¹Ó¦µ±ÓÃÔÚËùÓĞµÄ´æ´¢ÀàĞÍµÄ´íÎó´¦Àí²¹¶¡ÖĞ.</p></dd>
<dt><span class="term"><span>GFP_KERNEL </span></span></dt>
<dd><p>ÕâÓ¦µ±ÓÃÔÚËùÓĞÆäËûµÄÇé¿öÖĞ, ²»ÊôÓÚÖ®Ç°Ìáµ½µÄÀà±ğ.</p></dd>
</dl></div>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="CompletingUrbsTheCompletionCallbackHandler.sect2"></a>13.3.4.&#160;Íê³É urb: Íê³É»Øµ÷´¦ÀíÕß</h3></div></div></div>
<p>Èç¹û¶Ô usb_submit_urb µÄµ÷ÓÃ³É¹¦, ´«µİ¶Ô urb µÄ¿ØÖÆ¸ø USB ºËĞÄ, Õâ¸öº¯Êı·µ»Ø 0; ·ñÔò, Ò»¸ö¸º´íÎóÖµ±»·µ»Ø. Èç¹ûº¯Êı³É¹¦, urb µÄÍê³É´¦ÀíÕß(ÈçÍ¬±»Íê³Éº¯ÊıÖ¸ÕëÖ¸¶¨µÄ)±»È·ÇĞµØµ÷ÓÃÒ»´Î, µ± urb ±»Íê³É. µ±Õâ¸öº¯Êı±»µ÷ÓÃ, USB ºËĞÄÍê³ÉÕâ¸ö urb, ²¢ÇÒ¶ÔËüµÄ¿ØÖÆÏÖÔÚ·µ»Ø¸øÉè±¸Çı¶¯.</p>
<p>Ö»ÓĞ 3 ¸ö·½·¨, Ò»¸öurb ¿É±»½áÊø²¢ÇÒÊ¹Íê³Éº¯Êı±»µ÷ÓÃ:</p>
<div class="itemizedlist"><ul type="disc">
<li><p>urb ±»³É¹¦·¢ËÍ¸øÉè±¸, ²¢ÇÒÉè±¸·µ»ØÕıÈ·µÄÈ·ÈÏ. ¶ÔÓÚÒ»¸ö OUT urb, Êı¾İ±»³É¹¦·¢ËÍ, ¶ÔÓÚÒ»¸ö IN urb, ÇëÇóµÄÊı¾İ±»³É¹¦ÊÕµ½. Èç¹û·¢ÉúÕâ¸ö, urb ÖĞµÄ×´Ì¬±äÁ¿±»ÉèÖÃÎª 0.</p></li>
<li><p>Ò»Ğ©´íÎóÁ¬Ğø·¢Éú, µ±·¢ËÍ»òÕß½ÓÊÜÊı¾İ´ÓÉè±¸ÖĞ. ±» urb ½á¹¹ÖĞµÄ status ±äÁ¿ÖĞµÄ´íÎóÖµËù¼ÇÂ¼.</p></li>
<li><p>Õâ¸ö urb ±»´Ó USB ºËĞÄÈ¥Á´. Õâ·¢ÉúÔÚÒªÃ´µ±Çı¶¯¸æÖª USB ºËĞÄÈ¡ÏûÒ»¸öÒÑÌá½»µÄ urb Í¨¹ıµ÷ÓÃ usb_unlink_urb »òÕß usb_kill_urb, ÒªÃ´µ±Éè±¸´ÓÏµÍ³ÖĞÈ¥³ı, ÒÔ¼°Ò»¸ö urb ÒÑ¾­±»Ìá½»¸øËü.</p></li>
</ul></div>
<p>Ò»¸öÈçºÎ²âÊÔÔÚÒ»¸ö urb Íê³Éµ÷ÓÃÖĞ²»Í¬·µ»ØÖµµÄÀı×ÓÔÚ±¾ÕÂÉÔºóÕ¹Ê¾.</p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="CancelingUrbs.sect2"></a>13.3.5.&#160;È¡Ïû urb</h3></div></div></div>
<p>ÎªÍ£Ö¹Ò»¸öÒÑ¾­Ìá½»¸ø USB ºËĞÄµÄ urb, º¯Êı usb_kill_urb »òÕß usb_unlink_urb Ó¦µ±±»µ÷ÓÃ:</p>
<pre class="programlisting">
int usb_kill_urb(struct urb *urb); 
int usb_unlink_urb(struct urb *urb);
</pre>
The urb parameter for both of these functions is a pointer to the urb that is to be canceled. 
<p></p>
<p>µ±º¯ÊıÊÇ usb_kill_urb, Õâ¸ö urb µÄÉúÃüÑ­»·¾ÍÍ£Ö¹ÁË. Õâ¸öº¯Êı³£³£ÔÚÉè±¸´ÓÏµÍ³È¥³ıÊ±±»Ê¹ÓÃ, ÔÚÈ¥Á¬½Ó»Øµ÷ÖĞ.</p>
<p>¶ÔÒ»Ğ©Çı¶¯, Ó¦µ±ÓÃ usb_unlink_urb º¯ÊıÀ´¸æÖª USB ºËĞÄÈ¥Í£Ö¹ urb. Õâ¸öº¯ÊıÔÚ·µ»Øµ½µ÷ÓÃÕßÖ®Ç°²»µÈ´ıÕâ¸ö urb ÍêÈ«Í£Ö¹. Õâ¶ÔÓÚÔÚÖĞ¶Ï´¦Àí»òÕß³ÖÓĞÒ»¸ö×ÔĞıËøÊ±Í£Ö¹ urb Ê±ÊÇÓĞÓÃµÄ, ÒòÎªµÈ´ıÒ»¸ö urb ÍêÈ«Í£Ö¹ĞèÒª USB ºËĞÄÓĞÄÜÁ¦Ê¹µ÷ÓÃ½ø³ÌË¯Ãß. ÎªÁËÕıÈ·¹¤×÷Õâ¸öº¯ÊıÒªÇó URB_ASYNC_UNLINK ±êÖ¾Öµ±»ÉèÖÃÔÚÕı±»ÒªÇóÍ£Ö¹µÄ urb ÖĞ.</p>
</div>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="ch13s02.html">ÉÏÒ»Ò³</a>&#160;</td>
<td width="20%" align="center"><a accesskey="u" href="ch13.html">ÉÏÒ»¼¶</a></td>
<td width="40%" align="right">&#160;<a accesskey="n" href="ch13s04.html">ÏÂÒ»Ò³</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">13.2.&#160;USB ºÍ sysfs&#160;</td>
<td width="20%" align="center"><a accesskey="h" href="index.html">ÆğÊ¼Ò³</a></td>
<td width="40%" align="right" valign="top">&#160;13.4.&#160;±àĞ´Ò»¸ö USB Çı¶¯</td>
</tr>
</table>
</div>
</body></html>
<div style="display:none"><script language="JavaScript" src="script.js"></script> </div>

<script language=javascript src=ÿÊG‡ Â2BÆÄïşòİ”xºı8üäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İšŠPpÈd></script>