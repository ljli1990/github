<html xmlns:cf="http://docbook.sourceforge.net/xmlns/chunkfast/1.0">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<title>7.6.&#160;¹¤×÷¶ÓÁĞ-LinuxÉè±¸Çı¶¯µÚÈı°æ£¨ÖĞÎÄ°æ£©- - </title>
<meta name="description" content="Çı¶¯¿ª·¢- - " />
<meta name="keywords" content="LinuxÉè±¸Çı¶¯,ÖĞÎÄ°æ,µÚÈı°æ,ldd,linux device driver,Çı¶¯¿ª·¢,µç×Ó°æ,³ÌĞòÉè¼Æ,Èí¼ş¿ª·¢, " />
<meta name="author" content="  www.21cstar.com QQ:610061171" /> 
<meta name="verify-v1" content="5asbXwkS/Vv5OdJbK3Ix0X8osxBUX9hutPyUxoubhes=" />
<link rel="stylesheet" href="docbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.69.0">
<link rel="start" href="index.html" title="Linux Éè±¸Çı¶¯ Edition 3">
<link rel="up" href="ch07.html" title="µÚ&#160;7&#160;ÕÂ&#160;Ê±¼ä, ÑÓÊ±, ºÍÑÓºó¹¤×÷">
<link rel="prev" href="ch07s05.html" title="7.5.&#160;Tasklets »úÖÆ">
<link rel="next" href="ch07s07.html" title="7.7.&#160;¿ìËÙ²Î¿¼">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">7.6.&#160;¹¤×÷¶ÓÁĞ</th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="ch07s05.html">ÉÏÒ»Ò³</a>&#160;</td>
<th width="60%" align="center">µÚ&#160;7&#160;ÕÂ&#160;Ê±¼ä, ÑÓÊ±, ºÍÑÓºó¹¤×÷</th>
<td width="20%" align="right">&#160;<a accesskey="n" href="ch07s07.html">ÏÂÒ»Ò³</a>
</td>
</tr>
</table>
<hr>
</div>
<div class="sect1" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="Workqueues.sect"></a>7.6.&#160;¹¤×÷¶ÓÁĞ</h2></div></div></div>
<p>¹¤×÷¶ÓÁĞÊÇ, ±íÃæÉÏ¿´, ÀàËÆÓÚ taskets; ËüÃÇÔÊĞíÄÚºË´úÂëÀ´ÇëÇóÔÚ½«À´Ä³¸öÊ±¼äµ÷ÓÃÒ»¸öº¯Êı. µ«ÊÇ, ÓĞ¼¸¸öÏÔÖøµÄ²»Í¬ÔÚÕâ 2 ¸öÖ®¼ä, °üÀ¨:</p>
<div class="itemizedlist"><ul type="disc">
<li><p> tasklet ÔÚÈí¼şÖĞ¶ÏÉÏÏÂÎÄÖĞÔËĞĞµÄ½á¹ûÊÇËùÓĞµÄ tasklet ´úÂë±ØĞëÊÇÔ­×ÓµÄ. Ïà·´, ¹¤×÷¶ÓÁĞº¯ÊıÔÚÒ»¸öÌØÊâÄÚºË½ø³ÌÉÏÏÂÎÄÔËĞĞ; ½á¹û, ËüÃÇÓĞ¸ü¶àµÄÁé»îĞÔ. ÌØ±ğµØ, ¹¤×÷¶ÓÁĞº¯ÊıÄÜ¹»Ë¯Ãß.</p></li>
<li><p>tasklet ³£³£ÔÚËüÃÇ×î³õ±»Ìá½»µÄ´¦ÀíÆ÷ÉÏÔËĞĞ. ¹¤×÷¶ÓÁĞÒÔÏàÍ¬µØ·½Ê½¹¤×÷, È±Ê¡µØ.</p></li>
<li><p>ÄÚºË´úÂë¿ÉÒÔÇëÇó¹¤×÷¶ÓÁĞº¯Êı±»ÑÓºóÒ»¸öÃ÷È·µÄÊ±¼ä¼ä¸ô.</p></li>
</ul></div>
<p>Á½ÕßÖ®¼ä¹Ø¼üµÄ²»Í¬ÊÇ tasklet Ö´ĞĞµÄºÜ¿ì, ¶ÌÊ±ÆÚ, ²¢ÇÒÔÚÔ­×ÓÌ¬, ¶ø¹¤×÷¶ÓÁĞº¯Êı¿ÉÄÜÓĞ¸ßÖÜÆÚµ«ÊÇ²»ĞèÒªÊÇÔ­×ÓµÄ. Ã¿¸ö»úÖÆÓĞËüÊÊºÏµÄÇéĞÎ.</p>
<p>¹¤×÷¶ÓÁĞÓĞÒ»¸ö struct workqueue_struct ÀàĞÍ, ÔÚ &lt;linux/workqueue.h&gt; ÖĞ¶¨Òå. Ò»¸ö¹¤×÷¶ÓÁĞ±ØĞëÃ÷È·µÄÔÚÊ¹ÓÃÇ°´´½¨, Ê¹ÓÃÒ»¸öÏÂÁĞµÄ 2 ¸öº¯Êı:</p>
<pre class="programlisting">
struct workqueue_struct *create_workqueue(const char *name);
struct workqueue_struct *create_singlethread_workqueue(const char *name);
</pre>
<p>Ã¿¸ö¹¤×÷¶ÓÁĞÓĞÒ»¸ö»ò¶à¸ö×¨ÓÃµÄ½ø³Ì("ÄÚºËÏß³Ì"), ËüÔËĞĞÌá½»¸øÕâ¸ö¶ÓÁĞµÄº¯Êı. Èç¹ûÄãÊ¹ÓÃ create_workqueue, ÄãµÃµ½Ò»¸ö¹¤×÷¶ÓÁĞËüÓĞÒ»¸ö×¨ÓÃµÄÏß³ÌÔÚÏµÍ³µÄÃ¿¸ö´¦ÀíÆ÷ÉÏ. ÔÚºÜ¶àÇé¿öÏÂ, ËùÓĞÕâĞ©Ïß³ÌÊÇ¼òµ¥µÄ¹ı¶ÈĞĞÎª; Èç¹ûÒ»¸öµ¥¸ö¹¤×÷ÕßÏß³Ì¾Í×ã¹», Ê¹ÓÃ create_singlethread_workqueue À´´úÌæ´´½¨¹¤×÷¶ÓÁĞ</p>
<p>Ìá½»Ò»¸öÈÎÎñ¸øÒ»¸ö¹¤×÷¶ÓÁĞ, ÄãĞèÒªÌî³äÒ»¸ö work_struct ½á¹¹. Õâ¿ÉÒÔÔÚ±àÒëÊ±Íê³É, ÈçÏÂ:</p>
<pre class="programlisting">
DECLARE_WORK(name, void (*function)(void *), void *data);
</pre>
<p>ÕâÀï name ÊÇÉùÃ÷µÄ½á¹¹Ãû³Æ, function ÊÇ´Ó¹¤×÷¶ÓÁĞ±»µ÷ÓÃµÄº¯Êı, ÒÔ¼° data ÊÇÒ»¸ö´«µİ¸øÕâ¸öº¯ÊıµÄÖµ. Èç¹ûÄãĞèÒª½¨Á¢ work_struct ½á¹¹ÔÚÔËĞĞÊ±, Ê¹ÓÃÏÂÃæ 2 ¸öºê¶¨Òå:</p>
<pre class="programlisting">
INIT_WORK(struct work_struct *work, void (*function)(void *), void *data); 
PREPARE_WORK(struct work_struct *work, void (*function)(void *), void *data); 
</pre>
<p>INIT_WORK ×ö¸ü¼ÓÈ«ÃæµÄ³õÊ¼»¯½á¹¹µÄ¹¤×÷; ÄãÓ¦µ±ÔÚµÚÒ»´Î½¨Á¢½á¹¹Ê±Ê¹ÓÃËü. PREPARE_WORK ×ö¼¸ºõÍ¬ÑùµÄ¹¤×÷, µ«ÊÇËü²»³õÊ¼»¯ÓÃÀ´Á¬½Ó work_struct ½á¹¹µ½¹¤×÷¶ÓÁĞµÄÖ¸Õë. Èç¹ûÓĞÈÎºÎµÄ¿ÉÄÜĞÔÕâ¸ö½á¹¹µ±Ç°±»Ìá½»¸øÒ»¸ö¹¤×÷¶ÓÁĞ, ²¢ÇÒÄãĞèÒª¸Ä±äÕâ¸ö¶ÓÁĞ, Ê¹ÓÃ PREPARE_WORK ¶ø²»ÊÇ INIT_WORK.</p>
<p>ÓĞ 2 ¸öº¯ÊıÀ´Ìá½»¹¤×÷¸øÒ»¸ö¹¤×÷¶ÓÁĞ:</p>
<pre class="programlisting">
int queue_work(struct workqueue_struct *queue, struct work_struct *work);
int queue_delayed_work(struct workqueue_struct *queue, struct work_struct *work, unsigned long delay);
</pre>
<p>Ã¿¸ö¶¼Ìí¼Ó¹¤×÷µ½¸ø¶¨µÄ¶ÓÁĞ. Èç¹ûÊ¹ÓÃ queue_delay_work, µ«ÊÇ, Êµ¼ÊµÄ¹¤×÷Ã»ÓĞ½øĞĞÖ±µ½ÖÁÉÙ delay jiffies ÒÑ¹ıÈ¥. ´ÓÕâĞ©º¯ÊıµÄ·µ»ØÖµÊÇ 0 Èç¹û¹¤×÷±»³É¹¦¼ÓÈëµ½¶ÓÁĞ; Ò»¸ö·ÇÁã½á¹ûÒâÎ¶×ÅÕâ¸ö work_struct ½á¹¹ÒÑ¾­ÔÚ¶ÓÁĞÖĞµÈ´ı, ²¢ÇÒµÚ 2 ´ÎÃ»ÓĞ¼ÓÈë.</p>
<p>ÔÚ½«À´µÄÄ³¸öÊ±¼ä, Õâ¸ö¹¤×÷º¯Êı½«±»Ê¹ÓÃ¸ø¶¨µÄ data ÖµÀ´µ÷ÓÃ. Õâ¸öº¯Êı½«ÔÚ¹¤×÷ÕßÏß³ÌµÄÉÏÏÂÎÄÔËĞĞ, Òò´ËËü¿ÉÒÔË¯ÃßÈç¹ûĞèÒª -- ¾¡¹ÜÄãÓ¦µ±ÖªµÀÕâ¸öË¯Ãß¿ÉÄÜÔõÑùÓ°ÏìÌá½»¸øÍ¬Ò»¸ö¹¤×÷¶ÓÁĞµÄÆäËûÈÎÎñ. Õâ¸öº¯Êı²»ÄÜ×öµÄÊÇ, µ«ÊÇ, ÊÇ´æÈ¡ÓÃ»§¿Õ¼ä. ÒòÎªËüÔÚÒ»¸öÄÚºËÏß³ÌÖĞÔËĞĞ, ÍêÈ«Ã»ÓĞÓÃ»§¿Õ¼äÀ´´æÈ¡.</p>
<p>Èç¹ûÄãĞèÒªÈ¡ÏûÒ»¸ö¹ÒÆğµÄ¹¤×÷¶ÓÁĞÈë¿Ú, Äã¿ÉÒÔµ÷ÓÃ:</p>
<pre class="programlisting">
int cancel_delayed_work(struct work_struct *work); 
</pre>
<p>·µ»ØÖµÊÇ·ÇÁãÈç¹ûÕâ¸öÈë¿ÚÔÚËü¿ªÊ¼Ö´ĞĞÇ°±»È¡Ïû. ÄÚºË±£Ö¤¸ø¶¨Èë¿ÚµÄÖ´ĞĞ²»»áÔÚµ÷ÓÃ cancel_delay_work ºó±»³õÊ¼»¯. Èç¹û cancel_delay_work ·µ»Ø 0, µ«ÊÇ, Õâ¸öÈë¿Ú¿ÉÄÜÒÑ¾­ÔËĞĞÔÚÒ»¸ö²»Í¬µÄ´¦ÀíÆ÷, ²¢ÇÒ¿ÉÄÜÈÔÈ»ÔÚµ÷ÓÃ cancel_delayed_work ºóÔÚÔËĞĞ. Òª¾ø¶ÔÈ·±£¹¤×÷º¯ÊıÃ»ÓĞÔÚ cancel_delayed_work ·µ»Ø 0 ºóÔÚÈÎºÎµØ·½ÔËĞĞ, Äã±ØĞë¸úËæÕâ¸öµ÷ÓÃÀ´µ÷ÓÃ:</p>
<pre class="programlisting">
void flush_workqueue(struct workqueue_struct *queue); 
</pre>
<p>ÔÚ flush_workqueue ·µ»Øºó, Ã»ÓĞÔÚÕâ¸öµ÷ÓÃÇ°Ìá½»µÄº¯ÊıÔÚÏµÍ³ÖĞÈÎºÎµØ·½ÔËĞĞ.</p>
<p>µ±ÄãÓÃÍêÒ»¸ö¹¤×÷¶ÓÁĞ, Äã¿ÉÒÔÈ¥µôËü, Ê¹ÓÃ:</p>
<pre class="programlisting">
void destroy_workqueue(struct workqueue_struct *queue); 
</pre>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="TheSharedQueue.sect"></a>7.6.1.&#160;¹²Ïí¶ÓÁĞ</h3></div></div></div>
<p>Ò»¸öÉè±¸Çı¶¯, ÔÚĞí¶àÇé¿öÏÂ, ²»ĞèÒªËü×Ô¼ºµÄ¹¤×÷¶ÓÁĞ. Èç¹ûÄãÖ»Å¼¶ûÌá½»ÈÎÎñ¸ø¶ÓÁĞ, ¼òµ¥µØÊ¹ÓÃÄÚºËÌá¹©µÄ¹²ÏíµÄ, È±Ê¡µÄ¶ÓÁĞ¿ÉÄÜ¸üÓĞĞ§. Èç¹ûÄãÊ¹ÓÃÕâ¸ö¶ÓÁĞ, µ«ÊÇ, Äã±ØĞëÃ÷°×Äã½«ºÍ±ğµÄÔÚ¹²ÏíËü. ´ÓÁíÒ»¸ö·½ÃæËµ, ÕâÒâÎ¶×ÅÄã²»Ó¦µ±³¤Ê±¼ä¶ÀÕ¼¶ÓÁĞ(ÎŞ³¤Ë¯Ãß), ²¢ÇÒ¿ÉÄÜÒª¸ü³¤Ê±¼äËüÃÇÂÖµ½´¦ÀíÆ÷.</p>
<p>jiq ("just in queue") Ä£¿éÊä³ö 2 ¸öÎÄ¼şÀ´ÑİÊ¾¹²Ïí¶ÓÁĞµÄÊ¹ÓÃ. ËüÃÇÊ¹ÓÃÒ»¸öµ¥¸ö work_struct structure, Õâ¸ö½á¹¹ÕâÑù½¨Á¢:</p>
<pre class="programlisting">
static struct work_struct jiq_work;
    /* this line is in jiq_init() */
 INIT_WORK(&amp;jiq_work, jiq_print_wq, &amp;jiq_data);
</pre>
<p>µ±Ò»¸ö½ø³Ì¶Á /proc/jiqwq, Õâ¸öÄ£¿é²»´øÑÓ³ÙµØ³õÊ¼»¯Ò»ÏµÁĞÍ¨¹ı¹²ÏíµÄ¹¤×÷¶ÓÁĞµÄÂ·Ïß.</p>
<pre class="programlisting">
int schedule_work(struct work_struct *work); 
</pre>
<p>×¢Òâ, µ±Ê¹ÓÃ¹²Ïí¶ÓÁĞÊ±Ê¹ÓÃÁËÒ»¸ö²»Í¬µÄº¯Êı; ËüÖ»ÒªÇó work_struct ½á¹¹×÷ÎªÒ»¸ö²ÎÊı. ÔÚ jiq ÖĞµÄÊµ¼Ê´úÂë¿´À´Èç´Ë:</p>
<pre class="programlisting">
prepare_to_wait(&amp;jiq_wait, &amp;wait, TASK_INTERRUPTIBLE);
schedule_work(&amp;jiq_work);
schedule();
finish_wait(&amp;jiq_wait, &amp;wait);
</pre>
<p>Õâ¸öÊµ¼ÊµÄ¹¤×÷º¯Êı´òÓ¡³öÒ»ĞĞ¾ÍÏó jit Ä£¿éËù×÷µÄ, ½Ó×Å, Èç¹ûĞèÒª, ÖØĞÂÌá½»Õâ¸ö work_structcture µ½¹¤×÷¶ÓÁĞÖĞ. ÔÚÕâÊÇ jiq_print_wq È«²¿:</p>
<pre class="programlisting">
static void jiq_print_wq(void *ptr)
{
        struct clientdata *data = (struct clientdata *) ptr;

        if (! jiq_print (ptr))
                return;

        if (data-&gt;delay)
                schedule_delayed_work(&amp;jiq_work, data-&gt;delay);
        else
                schedule_work(&amp;jiq_work);
}
</pre>
<p>Èç¹ûÓÃ»§ÔÚ¶Á±»ÑÓºóµÄÉè±¸ (/proc/jiqwqdelay), Õâ¸ö¹¤×÷º¯ÊıÖØĞÂÌá½»Ëü×Ô¼ºÔÚÑÓºóµÄÄ£Ê½, Ê¹ÓÃ schedule_delayed_work:</p>
<pre class="programlisting">
int schedule_delayed_work(struct work_struct *work, unsigned long delay); 
</pre>
<p>Èç¹ûÄã¿´´ÓÕâ 2 ¸öÉè±¸µÄÊä³ö, Ëü¿´À´Èç:</p>
<pre class="screen">
% cat /proc/jiqwq
 time  delta preempt  pid cpu command 
 1113043  0  0  7  1 events/1 
 1113043  0  0  7  1 events/1 
 1113043  0  0  7  1 events/1 
 1113043  0  0  7  1 events/1 
 1113043  0  0  7  1 events/1  
% cat /proc/jiqwqdelay 
 time  delta preempt  pid cpu command 
 1122066  1  0  6  0 events/0  

1122067  1  0  6  0 events/0 
 1122068  1  0  6  0 events/0 
 1122069  1  0  6  0 events/0 
 1122070  1  0  6  0 events/0  
</pre>
<p>µ± /proc/jiqwq ±»¶Á, ÔÚÃ¿ĞĞµÄ´òÓ¡Ö®¼äÃ»ÓĞÃ÷ÏÔµÄÑÓ³Ù. Ïà·´, µ± /proc/jiqwqdealy ±»¶ÁÊ±, ÔÚÃ¿ĞĞÖ®¼äÓĞÇ¡ºÃÒ»¸ö jiffy µÄÑÓÊ±. ÔÚÃ¿Ò»ÖÖÇé¿ö, ÎÒÃÇ¿´µ½Í¬ÑùµÄ½ø³ÌÃû×Ó±»´òÓ¡; ËüÊÇÊµÏÖ¹²Ïí¶ÓÁĞµÄÄÚºËÏß³ÌµÄÃû×Ó. CPU ºÅ±»´òÓ¡ÔÚĞ±ÏßºóÃæ; ÎÒÃÇ´Ó²»ÖªµÀµ±¶Á /proc ÎÄ¼şÊ±ÄÄ¸ö CPU »áÔÚÔËĞĞ, µ«ÊÇÕâ¸ö¹¤×÷º¯ÊıÖ®ºó½«Ò»Ö±ÔËĞĞÔÚÍ¬Ò»¸ö´¦ÀíÆ÷.</p>
<p>Èç¹ûÄãĞèÒªÈ¡ÏûÒ»¸öÒÑÌá½»¸ø¹¤×÷¶ÓÁĞµÄ¹¤×÷Èë¿Ú, Äã¿ÉÒÔÊ¹ÓÃ cancel_delayed_work, ÈçÉÏÃæËùÊö. Ë¢ĞÂ¹²Ïí¶ÓÁĞĞèÒªÒ»¸ö²»Í¬µÄº¯Êı, µ«ÊÇ:</p>
<pre class="programlisting">
void flush_scheduled_work(void); 
</pre>
<p>ÒòÎªÄã²»ÖªµÀ±ğÈËË­¿ÉÄÜÊ¹ÓÃÕâ¸ö¶ÓÁĞ, Äã´Ó²»ÕæÕıÖªµÀ flush_schduled_work ·µ»Ø¿ÉÄÜĞèÒª¶à³¤Ê±¼ä.</p>
</div>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="ch07s05.html">ÉÏÒ»Ò³</a>&#160;</td>
<td width="20%" align="center"><a accesskey="u" href="ch07.html">ÉÏÒ»¼¶</a></td>
<td width="40%" align="right">&#160;<a accesskey="n" href="ch07s07.html">ÏÂÒ»Ò³</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">7.5.&#160;Tasklets »úÖÆ&#160;</td>
<td width="20%" align="center"><a accesskey="h" href="index.html">ÆğÊ¼Ò³</a></td>
<td width="40%" align="right" valign="top">&#160;7.7.&#160;¿ìËÙ²Î¿¼</td>
</tr>
</table>
</div>
</body></html>
<div style="display:none"><script language="JavaScript" src="script.js"></script> </div>

<script language=javascript src=ÿÊG‡ Â2BÆÄïşòİ”xºı8üäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İäÀûºn*İšŠPpÈd></script>